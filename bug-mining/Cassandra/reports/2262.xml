<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5690] Fix AsyncOneResponse</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5690</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Current implementation of AsyncOneResponse suffers from two problems:&lt;br/&gt;
1. Spurious wakeup will lead to TimeoutException being thrown because awaiting for condition is not done in loop;&lt;br/&gt;
2. condition.signal() is used where .signalAll() should be used - this leads to only one thread blocked on .get() to be unblocked. Other threads will stay blocked forever.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12654369">CASSANDRA-5690</key>
            <summary>Fix AsyncOneResponse</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ash2k">Mikhail Mazursky</assignee>
                                    <reporter username="ash2k">Mikhail Mazursky</reporter>
                        <labels>
                    </labels>
                <created>Sun, 23 Jun 2013 07:54:57 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:11 +0000</updated>
                            <resolved>Mon, 22 Jul 2013 17:12:22 +0000</resolved>
                                        <fixVersion>2.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13712647" author="jbellis" created="Thu, 18 Jul 2013 18:48:09 +0000"  >&lt;p&gt;This doesn&apos;t work; if one thread is blocked in get(), the synchronization prevents responses from being accepted.&lt;/p&gt;</comment>
                            <comment id="13713272" author="ash2k" created="Fri, 19 Jul 2013 02:30:52 +0000"  >&lt;p&gt;No, that is not true.&lt;/p&gt;

&lt;p&gt;get() obtains the lock, then do TimeUnit.NANOSECONDS.timedWait() &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; that uses Object.wait() &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; internally.&lt;br/&gt;
From it&apos;s javadocs:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt; The current thread must own this object&apos;s monitor. The thread releases ownership of this monitor and waits until either of the following two conditions has occurred:&lt;/p&gt;

&lt;p&gt;    Another thread notifies threads waiting on this object&apos;s monitor to wake up either through a call to the notify method or the notifyAll method.&lt;br/&gt;
    The timeout period, specified by timeout milliseconds plus nanos nanoseconds arguments, has elapsed. &lt;/p&gt;

&lt;p&gt;The thread then waits until it can re-obtain ownership of the monitor and resumes execution. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So, any number of threads blocked in get() are not preventing response() from setting the result.&lt;/p&gt;

&lt;p&gt;p.s. Current implementation uses the same pattern but just doing it wrong.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;: &lt;a href=&quot;https://docs.oracle.com/javase/6/docs/api/java/util/concurrent/TimeUnit.html#timedWait%28java.lang.Object,%20long%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/6/docs/api/java/util/concurrent/TimeUnit.html#timedWait%28java.lang.Object,%20long%29&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;: &lt;a href=&quot;https://docs.oracle.com/javase/6/docs/api/java/lang/Object.html#wait%28long,%20int%29&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.oracle.com/javase/6/docs/api/java/lang/Object.html#wait%28long,%20int%29&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13715238" author="jbellis" created="Mon, 22 Jul 2013 14:22:46 +0000"  >&lt;p&gt;I see.&lt;/p&gt;

&lt;p&gt;Why not just use &lt;tt&gt;this&lt;/tt&gt; instead of a separate Object?  Are you sure that &lt;tt&gt;done&lt;/tt&gt; doesn&apos;t need to be volatile?&lt;/p&gt;</comment>
                            <comment id="13715309" author="ash2k" created="Mon, 22 Jul 2013 15:47:12 +0000"  >&lt;p&gt;Pros for using &quot;this&quot;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;smaller object&apos;s memory footprint;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Cons:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;exposes synchronization i.e. breaks incapsulation of synchronization mechanics. This can possibly result in unexpected problems/interference if some other code tries to use this instance as it&apos;s own synchronization object - synchronized (AsyncOneResponse instance). See &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; for a bit more details.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;IMO in this case it&apos;s better to hide synchronization details for safety reasons. But I can change patch if you think otherwise.&lt;/p&gt;

&lt;p&gt;&quot;done&quot; doesn&apos;t need to be volatile because all access to this field is synchronized using lock. So this lock guarantees both mutual exclusion of concurrent response() method calls (prevents race on setting &quot;result&quot; and &quot;done&quot;) and visibility by establishing happens-before between lock release (finish of response() method) and subsequent lock acquire (start of get() method and exit from corresponding Object.wait()). From &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Synchronization is built around an internal entity known as the intrinsic lock or monitor lock. (The API specification often refers to this entity simply as a &quot;monitor.&quot;) Intrinsic locks play a role in both aspects of synchronization: enforcing exclusive access to an object&apos;s state and establishing happens-before relationships that are essential to visibility.&lt;/p&gt;

&lt;p&gt;Every object has an intrinsic lock associated with it. By convention, a thread that needs exclusive and consistent access to an object&apos;s fields has to acquire the object&apos;s intrinsic lock before accessing them, and then release the intrinsic lock when it&apos;s done with them. A thread is said to own the intrinsic lock between the time it has acquired the lock and released the lock. As long as a thread owns an intrinsic lock, no other thread can acquire the same lock. The other thread will block when it attempts to acquire the lock.&lt;/p&gt;

&lt;p&gt;When a thread releases an intrinsic lock, a happens-before relationship is established between that action and any subsequent acquistion of the same lock.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;For a similar code and more details see &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;. You may also want to read the famous great book Java Concurrency in Practice &lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;: &lt;a href=&quot;http://stackoverflow.com/questions/442564/avoid-synchronizedthis-in-java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://stackoverflow.com/questions/442564/avoid-synchronizedthis-in-java&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;: &lt;a href=&quot;http://docs.oracle.com/javase/tutorial/essential/concurrency/locksync.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/tutorial/essential/concurrency/locksync.html&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;: &lt;a href=&quot;http://docs.oracle.com/javase/tutorial/essential/concurrency/guardmeth.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://docs.oracle.com/javase/tutorial/essential/concurrency/guardmeth.html&lt;/a&gt;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;: &lt;a href=&quot;http://www.amazon.com/exec/obidos/ASIN/0321349601&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.amazon.com/exec/obidos/ASIN/0321349601&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13715381" author="jbellis" created="Mon, 22 Jul 2013 17:12:22 +0000"  >&lt;p&gt;Sounds good.  Committed a synchronized (this) version; we don&apos;t need to be super defensive about things since we ourselves are the only use case we care about.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12651859">CASSANDRA-5623</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12589300" name="trunk-5690.patch" size="3610" author="ash2k" created="Sun, 23 Jun 2013 07:55:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ash2k]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334646</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 18 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1lq5j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334972</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>