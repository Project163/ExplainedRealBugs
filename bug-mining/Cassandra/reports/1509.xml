<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:29:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3957] Supercolumn serialization assertion failure</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3957</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;As reported at &lt;a href=&quot;http://mail-archives.apache.org/mod_mbox/cassandra-user/201202.mbox/%3CCADJL=w5kH5TEQXOwhTn5Jm3cmR4Rj=NfjcqLryXV7pLyASi95A@mail.gmail.com%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://mail-archives.apache.org/mod_mbox/cassandra-user/201202.mbox/%3CCADJL=w5kH5TEQXOwhTn5Jm3cmR4Rj=NfjcqLryXV7pLyASi95A@mail.gmail.com%3E&lt;/a&gt;,&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR 10:51:44,282 Fatal exception in thread
Thread[COMMIT-LOG-WRITER,5,main]
java.lang.AssertionError: Final buffer length 4690 to accomodate data size
of 2347 (predicted 2344) for RowMutation(keyspace=&apos;Player&apos;,
key=&apos;36336138643338652d366162302d343334392d383466302d356166643863353133356465&apos;,
modifications=[ColumnFamily(PlayerCity [SuperColumn(owneditem_1019
[]),SuperColumn(owneditem_1024 []),SuperColumn(owneditem_1026
[]),SuperColumn(owneditem_1074 []),SuperColumn(owneditem_1077
[]),SuperColumn(owneditem_1084 []),SuperColumn(owneditem_1094
[]),SuperColumn(owneditem_1130 []),SuperColumn(owneditem_1136
[]),SuperColumn(owneditem_1141 []),SuperColumn(owneditem_1142
[]),SuperColumn(owneditem_1145 []),SuperColumn(owneditem_1218
[636f6e6e6563746564:false:5@1329648704269002
,63757272656e744865616c7468:false:3@1329648704269006
,656e64436f6e737472756374696f6e54696d65:false:13@1329648704269007
,6964:false:4@1329648704269000,6974656d4964:false:15@1329648704269001
,6c61737444657374726f79656454696d65:false:1@1329648704269008
,6c61737454696d65436f6c6c6563746564:false:13@1329648704269005
,736b696e4964:false:7@1329648704269009,78:false:4@1329648704269003
,79:false:3@1329648704269004,]),SuperColumn(owneditem_133
[]),SuperColumn(owneditem_134 []),SuperColumn(owneditem_135
[]),SuperColumn(owneditem_141 []),SuperColumn(owneditem_147
[]),SuperColumn(owneditem_154 []),SuperColumn(owneditem_159
[]),SuperColumn(owneditem_171 []),SuperColumn(owneditem_253
[]),SuperColumn(owneditem_422 []),SuperColumn(owneditem_438
[]),SuperColumn(owneditem_515 []),SuperColumn(owneditem_521
[]),SuperColumn(owneditem_523 []),SuperColumn(owneditem_525
[]),SuperColumn(owneditem_562 []),SuperColumn(owneditem_61
[]),SuperColumn(owneditem_634 []),SuperColumn(owneditem_636
[]),SuperColumn(owneditem_71 []),SuperColumn(owneditem_712
[]),SuperColumn(owneditem_720 []),SuperColumn(owneditem_728
[]),SuperColumn(owneditem_787 []),SuperColumn(owneditem_797
[]),SuperColumn(owneditem_798 []),SuperColumn(owneditem_838
[]),SuperColumn(owneditem_842 []),SuperColumn(owneditem_847
[]),SuperColumn(owneditem_849 []),SuperColumn(owneditem_851
[]),SuperColumn(owneditem_852 []),SuperColumn(owneditem_853
[]),SuperColumn(owneditem_854 []),SuperColumn(owneditem_857
[]),SuperColumn(owneditem_858 []),SuperColumn(owneditem_874
[]),SuperColumn(owneditem_884 []),SuperColumn(owneditem_886
[]),SuperColumn(owneditem_908 []),SuperColumn(owneditem_91
[]),SuperColumn(owneditem_911 []),SuperColumn(owneditem_930
[]),SuperColumn(owneditem_934 []),SuperColumn(owneditem_937
[]),SuperColumn(owneditem_944 []),SuperColumn(owneditem_945
[]),SuperColumn(owneditem_962 []),SuperColumn(owneditem_963
[]),SuperColumn(owneditem_964 []),])])
        at org.apache.cassandra.utils.FBUtilities.serialize(FBUtilities.java:682)
        at org.apache.cassandra.db.RowMutation.getSerializedBuffer(RowMutation.java:279)
        at org.apache.cassandra.db.commitlog.CommitLogSegment.write(CommitLogSegment.java:122)
        at org.apache.cassandra.db.commitlog.CommitLog$LogRecordAdder.run(CommitLog.java:599)
        at org.apache.cassandra.db.commitlog.PeriodicCommitLogExecutorService$1.runMayThrow(PeriodicCommitLogExecutorService.java:49)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)
        at java.lang.Thread.run(Thread.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12544061">CASSANDRA-3957</key>
            <summary>Supercolumn serialization assertion failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                            <label>datastax_qa</label>
                    </labels>
                <created>Fri, 24 Feb 2012 21:51:28 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:38 +0000</updated>
                            <resolved>Wed, 7 Mar 2012 17:39:30 +0000</resolved>
                                        <fixVersion>1.0.9</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13215980" author="jbellis" created="Fri, 24 Feb 2012 22:04:59 +0000"  >&lt;p&gt;I note that this is the Periodic commitlog executor, which does NOT block for CommitLog.add.  So, if the CF is serialized (later) while another thread modifies it, we could hit this error.&lt;/p&gt;

&lt;p&gt;We don&apos;t modify the mutation CF directly in CFS.apply, since we clone into the arena allocator.&lt;/p&gt;

&lt;p&gt;The only place I see where we modify the mutation CF is in ignoreObsoleteMutations...  but that only happens for indexed columns, so that can&apos;t be the cause here since it involves SuperColumns.&lt;/p&gt;

&lt;p&gt;(Note that the mutation CF won&apos;t be changed by updateRowCache, since the mutation CF is never inserted into the cache; it&apos;s only used to add to an existing cache row, if one exists.)&lt;/p&gt;

&lt;p&gt;Am I missing something?&lt;/p&gt;

&lt;p&gt;Perhaps it would be best to start by creating a test to serialize the above RowMutation and see if it reproduces in the absence of concurrent activity, to rule out the possibility of serializedSize simply having a bug w/ SuperColumns.&lt;/p&gt;</comment>
                            <comment id="13221254" author="cywjackson" created="Fri, 2 Mar 2012 20:42:59 +0000"  >&lt;p&gt;below is another similar stacktrace where only standard column (no super, no composite) was used.&lt;/p&gt;

&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;ERROR 08:50:12,479 Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError: Final buffer length 2090383 to accomodate data size of 736236 (predicted 2090383) for RowMutation(keyspace=&apos;cfs&apos;, key=&apos;6337343566396330363438373131653130303030653562646562313236356262&apos;, modifications=[ColumnFamily(sblocks &lt;span class=&quot;error&quot;&gt;&amp;#91;6337343839316430363438373131653130303030653562646562313236356262:false:736121@1330707012466,&amp;#93;&lt;/span&gt;)])&lt;br/&gt;
at org.apache.cassandra.utils.FBUtilities.serialize(FBUtilities.java:682)&lt;br/&gt;
at org.apache.cassandra.db.RowMutation.getSerializedBuffer(RowMutation.java:279)&lt;br/&gt;
at org.apache.cassandra.db.commitlog.CommitLogSegment.write(CommitLogSegment.java:122)&lt;br/&gt;
at org.apache.cassandra.db.commitlog.CommitLog$LogRecordAdder.run(CommitLog.java:599)&lt;br/&gt;
at org.apache.cassandra.db.commitlog.PeriodicCommitLogExecutorService$1.runMayThrow(PeriodicCommitLogExecutorService.java:49)&lt;br/&gt;
at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:680)&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13223539" author="jbellis" created="Tue, 6 Mar 2012 18:57:40 +0000"  >&lt;p&gt;Jackson&apos;s stacktrace involving sblocks was caused by a bug in DSE&apos;s CFS code re-using a ByteBuffer it had handed off to Thrift.&lt;/p&gt;

&lt;p&gt;Could be that the original report had a similar problem.&lt;/p&gt;</comment>
                            <comment id="13223745" author="cywjackson" created="Tue, 6 Mar 2012 22:39:03 +0000"  >&lt;p&gt;this comes from a difference use case. the client code is in hector, maybe we need to look into how hector is handling the bytebuffer too?&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2012-02-20 06:16:56,621 org.apache.cassandra.service.AbstractCassandraDaemon Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError: Final buffer length 275 to accomodate data size of 271 (predicted 275) for RowMutation(keyspace=&apos;foo&apos;, key=&apos;984fb8106d3ff5043365736457c45085&apos;, modifications=[ColumnFa&lt;br/&gt;
mily(Dora_la [SuperColumn(1329718356206 [5f656e64:false:1@1329718616576004,5f6c6173744576656e7454696d65:false:8@1329718616576003,5f6c61737450617468:false:8@1329718616576005,5f76697369744576&lt;br/&gt;
656e74496e646578:false:4@1329718616576002,5f76697369744964:false:16@1329718616576000,5f7669736974496e646578:false:4@1329718616576001,]),])])&lt;br/&gt;
at org.apache.cassandra.utils.FBUtilities.serialize(FBUtilities.java:682)&lt;br/&gt;
at org.apache.cassandra.db.RowMutation.getSerializedBuffer(RowMutation.java:279)&lt;br/&gt;
at org.apache.cassandra.db.commitlog.CommitLogSegment.write(CommitLogSegment.java:122)&lt;br/&gt;
at org.apache.cassandra.db.commitlog.CommitLog$LogRecordAdder.run(CommitLog.java:599)&lt;br/&gt;
at org.apache.cassandra.db.commitlog.PeriodicCommitLogExecutorService$1.runMayThrow(PeriodicCommitLogExecutorService.java:49)&lt;br/&gt;
at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER&amp;#93;&lt;/span&gt; 2012-02-07 22:33:09,691 org.apache.cassandra.service.AbstractCassandraDaemon Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;COMMIT-LOG-WRITER,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError: Final buffer length 550 to accomodate data size of 275 (predicted 271) for RowMutation(keyspace=&apos;dyn&apos;, key=&apos;7836ab62d10ddb48d00668639ebdf6ce&apos;, modifications=[ColumnFa&lt;br/&gt;
mily(Dora_la [SuperColumn(1328653749409 [5f656e64:false:1@1328653989655004,5f6c6173744576656e7454696d65:false:8@1328653989655003,5f6c61737450617468:false:12@1328653989655005,5f7669736974457&lt;br/&gt;
6656e74496e646578:false:4@1328653989655002,5f76697369744964:false:16@1328653989655000,5f7669736974496e646578:false:4@1328653989655001,]),])])&lt;br/&gt;
at org.apache.cassandra.utils.FBUtilities.serialize(FBUtilities.java:682)&lt;br/&gt;
at org.apache.cassandra.db.RowMutation.getSerializedBuffer(RowMutation.java:279)&lt;br/&gt;
at org.apache.cassandra.db.commitlog.CommitLogSegment.write(CommitLogSegment.java:122)&lt;br/&gt;
at org.apache.cassandra.db.commitlog.CommitLog$LogRecordAdder.run(CommitLog.java:599)&lt;br/&gt;
at org.apache.cassandra.db.commitlog.PeriodicCommitLogExecutorService$1.runMayThrow(PeriodicCommitLogExecutorService.java:49)&lt;br/&gt;
at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;</comment>
                            <comment id="13224471" author="slebresne" created="Wed, 7 Mar 2012 16:19:35 +0000"  >&lt;p&gt;Here&apos;s my theory.&lt;/p&gt;

&lt;p&gt;The stacktrace concerning the sblocks is due to a bug in DSE&apos;s CFS. This happened because CFS sometimes communicate with C* in the same JVM without going trough the wire, so the re-use of ByteBuffer was problematic.&lt;/p&gt;

&lt;p&gt;The other stacktrace however can&apos;t be the same problem. Whatever Hector does, it goes over the wire and thus can&apos;t change the size of a ByteBuffer in C*.&lt;/p&gt;

&lt;p&gt;However, if we eliminate the sblocks trace, all the other trace uses SuperColumn. And as it turns out, I think we have a race with SC. As Jonathan pointed out, with the period commit log, if we happen to modify a mutation that was sent to the commit log at any time, that would be a bug. This means not modifying the CF object in the RowMutation, but for SuperColumn, this also mean we shouldn&apos;t modify those super columns. However, when we update the row cache (and if it&apos;s not a SerializingCache), we do potentially store references to the original SCs in the cached row, which could then lead to the stack trace on this issue. I&apos;m attaching a patch that fixes this.&lt;/p&gt;

&lt;p&gt;To make sure this could be the issue here, it would help to know if the stacktrace comes from column families where row cache was used and was not set to the serializing cache.&lt;/p&gt;

&lt;p&gt;I&apos;ll note however that the very small difference in the stacktraces between the predicted size and the actual serialized side support the theory of having say just one column of a super column updated, while in the sblocks case, the difference was much bigger, supporting the theory of the ByteBuffer content being changed to something completely different.&lt;/p&gt;</comment>
                            <comment id="13224522" author="jbellis" created="Wed, 7 Mar 2012 17:26:09 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13224535" author="slebresne" created="Wed, 7 Mar 2012 17:39:30 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="13224574" author="jbellis" created="Wed, 7 Mar 2012 18:22:52 +0000"  >&lt;p&gt;Thomas (the reporter of the original stack trace in the description) just confirmed on the mailing list that he was using row cache / CLHC.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12517414" name="3957.txt" size="2522" author="slebresne" created="Wed, 7 Mar 2012 16:19:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>229299</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 37 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gq9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95687</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>