<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:43:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6774] Cleanup fails with assertion error after stopping previous run</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6774</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I am stress testing a new 2.0.5 cluster and did the following:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;start decommission during heavy write, moderate read load&lt;/li&gt;
	&lt;li&gt;trigger cleanup on non-decommissioning node (nodetool cleanup)&lt;/li&gt;
	&lt;li&gt;Started to see higher GC load stop stopped cleanup via nodetool stop CLEANUP&lt;/li&gt;
	&lt;li&gt;attempt to launch cleanup now fails with the following message in console.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Cassandra log shows: &lt;a href=&quot;http://aep.appspot.com/display/cKmlMcDuKD72iYAcBykDuVZkRWY/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://aep.appspot.com/display/cKmlMcDuKD72iYAcBykDuVZkRWY/&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;2.0.5&lt;/p&gt;</environment>
        <key id="12697419">CASSANDRA-6774</key>
            <summary>Cleanup fails with assertion error after stopping previous run</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="keithwrightbos">Keith Wright</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Feb 2014 18:50:49 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:52 +0000</updated>
                            <resolved>Tue, 18 Mar 2014 08:48:53 +0000</resolved>
                                        <fixVersion>2.1 beta2</fixVersion>
                                        <due></due>
                            <votes>4</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13913311" author="keithwrightbos" created="Wed, 26 Feb 2014 18:54:21 +0000"  >&lt;p&gt;Additional info:&lt;/p&gt;

&lt;p&gt;cqlsh:system&amp;gt; select * from compactions_in_progress limit 10;&lt;/p&gt;

&lt;p&gt; id                                   | columnfamily_name      | inputs                                                                                                                                                                                                                           | keyspace_name&lt;br/&gt;
-------------------------------------&lt;del&gt;&lt;ins&gt;&lt;/del&gt;----------------------&lt;del&gt;&lt;/ins&gt;&lt;/del&gt;--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&lt;del&gt;+&lt;/del&gt;--------------&lt;br/&gt;
 9a20d760-9f15-11e3-bfe7-fb46089edbb0 |            global_user | &lt;/p&gt;
{16796, 17068, 17073, 17077, 17118, 17135, 17164, 17193, 17219, 17281, 17293, 17365, 17553, 17575, 17606, 17668, 17695, 17701, 17906, 17983, 18016, 18017, 18069, 18089, 18098, 18099, 18108, 18114, 18119, 18123, 18188, 18449}
&lt;p&gt; |         users&lt;br/&gt;
 93778f70-9f16-11e3-bfe7-fb46089edbb0 | client_end_user_lookup |                                                                                             &lt;/p&gt;
{3280, 3281, 3283, 3284, 3286, 3293, 3297, 3298, 3301, 3302, 3303, 3306, 3323, 3324, 3326, 3328, 3329, 3330, 3331, 3332, 3333, 3334}
&lt;p&gt; |         users&lt;br/&gt;
 96d23e10-9f14-11e3-bfe7-fb46089edbb0 |     cookie_user_lookup |                                                                                                                     &lt;/p&gt;
{9072, 9078, 9083, 9088, 9094, 9100, 9106, 9112, 9118, 9124, 9131, 9146, 9369, 9370, 9371, 9372, 9373, 9393}
&lt;p&gt; |         users&lt;/p&gt;

&lt;p&gt;(3 rows)&lt;/p&gt;</comment>
                            <comment id="13913352" author="keithwrightbos" created="Wed, 26 Feb 2014 19:14:04 +0000"  >&lt;p&gt;Looks like restarting the node corrected the issue thus far as cleanup is running.&lt;/p&gt;</comment>
                            <comment id="13931538" author="vjevdokimov" created="Wed, 12 Mar 2014 08:40:56 +0000"  >&lt;p&gt;Same issue on LCS, but restarting doesn&apos;t help. The only way to remove data after decreasing RF is Cleanup, but it fails with the same exception.&lt;br/&gt;
Is there a way to temporarily disable compactions on LCS?&lt;/p&gt;</comment>
                            <comment id="13931563" author="dimchansky" created="Wed, 12 Mar 2014 09:11:43 +0000"  >&lt;p&gt;Same issue here on LCS - after decreasing RF cleanup fails with the same stacktrace. Restart didn&apos;t help, after running &quot;nodetool disableautocompaction&quot; command and waiting for compaction get finished cleanup fails with the following stacktrace:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Error occurred during cleanup&lt;br/&gt;
java.util.concurrent.ExecutionException: java.lang.IndexOutOfBoundsException: Index: 1, Size: 1&lt;br/&gt;
        at java.util.concurrent.FutureTask.report(FutureTask.java:122)&lt;br/&gt;
        at java.util.concurrent.FutureTask.get(FutureTask.java:188)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager.performAllSSTableOperation(CompactionManager.java:227)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager.performCleanup(CompactionManager.java:265)&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore.forceCleanup(ColumnFamilyStore.java:1115)&lt;br/&gt;
        at org.apache.cassandra.service.StorageService.forceKeyspaceCleanup(StorageService.java:2152)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:606)&lt;br/&gt;
        at sun.reflect.misc.Trampoline.invoke(MethodUtil.java:75)&lt;br/&gt;
        at sun.reflect.GeneratedMethodAccessor12.invoke(Unknown Source)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:606)&lt;br/&gt;
        at sun.reflect.misc.MethodUtil.invoke(MethodUtil.java:279)&lt;br/&gt;
        at com.sun.jmx.mbeanserver.StandardMBeanIntrospector.invokeM2(StandardMBeanIntrospector.java:112)&lt;br/&gt;
        at com.sun.jmx.mbeanserver.StandardMBeanIntrospector.invokeM2(StandardMBeanIntrospector.java:46)&lt;br/&gt;
        at com.sun.jmx.mbeanserver.MBeanIntrospector.invokeM(MBeanIntrospector.java:237)&lt;br/&gt;
        at com.sun.jmx.mbeanserver.PerInterface.invoke(PerInterface.java:138)&lt;br/&gt;
        at com.sun.jmx.mbeanserver.MBeanSupport.invoke(MBeanSupport.java:252)&lt;br/&gt;
        at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.invoke(DefaultMBeanServerInterceptor.java:819)&lt;br/&gt;
        at com.sun.jmx.mbeanserver.JmxMBeanServer.invoke(JmxMBeanServer.java:801)&lt;br/&gt;
        at javax.management.remote.rmi.RMIConnectionImpl.doOperation(RMIConnectionImpl.java:1487)&lt;br/&gt;
        at javax.management.remote.rmi.RMIConnectionImpl.access$300(RMIConnectionImpl.java:97)&lt;br/&gt;
        at javax.management.remote.rmi.RMIConnectionImpl$PrivilegedOperation.run(RMIConnectionImpl.java:1328)&lt;br/&gt;
        at javax.management.remote.rmi.RMIConnectionImpl.doPrivilegedOperation(RMIConnectionImpl.java:1420)&lt;br/&gt;
        at javax.management.remote.rmi.RMIConnectionImpl.invoke(RMIConnectionImpl.java:848)&lt;br/&gt;
        at sun.reflect.GeneratedMethodAccessor20.invoke(Unknown Source)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:606)&lt;br/&gt;
        at sun.rmi.server.UnicastServerRef.dispatch(UnicastServerRef.java:322)&lt;br/&gt;
        at sun.rmi.transport.Transport$1.run(Transport.java:177)&lt;br/&gt;
        at sun.rmi.transport.Transport$1.run(Transport.java:174)&lt;br/&gt;
        at java.security.AccessController.doPrivileged(Native Method)&lt;br/&gt;
        at sun.rmi.transport.Transport.serviceCall(Transport.java:173)&lt;br/&gt;
        at sun.rmi.transport.tcp.TCPTransport.handleMessages(TCPTransport.java:556)&lt;br/&gt;
        at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run0(TCPTransport.java:811)&lt;br/&gt;
        at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run(TCPTransport.java:670)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:744)&lt;br/&gt;
Caused by: java.lang.IndexOutOfBoundsException: Index: 1, Size: 1&lt;br/&gt;
        at java.util.ArrayList.rangeCheck(ArrayList.java:635)&lt;br/&gt;
        at java.util.ArrayList.get(ArrayList.java:411)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager.needsCleanup(CompactionManager.java:502)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager.doCleanupCompaction(CompactionManager.java:540)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager.access$400(CompactionManager.java:62)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager$5.perform(CompactionManager.java:274)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager$2.call(CompactionManager.java:222)&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)&lt;br/&gt;
        ... 3 more&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;b&gt;Update:&lt;/b&gt;&lt;br/&gt;
IndexOutOfBoundsException exception issue has been fixed: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6845&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-6845&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13932992" author="krummas" created="Thu, 13 Mar 2014 08:25:44 +0000"  >&lt;p&gt;Looks like the cause here is that the node is so heavily overloaded that cassandra could not cancel in-progress compactions quickly enough, the exception is harmless, but perhaps not very nice. &lt;/p&gt;

&lt;p&gt;Attaching patch to not continue with the cleanup (or, all operations that need all sstables marked as compacting) after failing to cancel in-progress compactions.&lt;/p&gt;

&lt;p&gt;The IndexOutOfBoundsException error is unrelated and fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6845&quot; title=&quot;Cleanup fails with IndexOutOfBoundsException exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6845&quot;&gt;&lt;del&gt;CASSANDRA-6845&lt;/del&gt;&lt;/a&gt; as mentioned in a previous comment.&lt;/p&gt;</comment>
                            <comment id="13935351" author="jbellis" created="Fri, 14 Mar 2014 18:05:02 +0000"  >&lt;p&gt;I don&apos;t think we want to drop an exception into the log for what is to some degree an expected situation.  v2 refactors scrub/upgrade/cleanup to log an info message if they have to abort, instead.  (Also runs unmarkCompacting in a finally block, which was not the case before.)&lt;/p&gt;</comment>
                            <comment id="13937541" author="krummas" created="Mon, 17 Mar 2014 08:25:51 +0000"  >&lt;p&gt;hmm, i actually think we should throw an exception if we fail, so that the nodetool user gets some feedback without having to check logs, attached&lt;/p&gt;</comment>
                            <comment id="13937550" author="krummas" created="Mon, 17 Mar 2014 08:35:26 +0000"  >&lt;p&gt;or.. maybe we should return a status code from scrub/upgradesstables/cleanup instead... i&apos;ll fix&lt;/p&gt;</comment>
                            <comment id="13937729" author="krummas" created="Mon, 17 Mar 2014 12:12:51 +0000"  >&lt;p&gt;Attaching patch that;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Introduces an enum with the status for the operation (currently only aborted/successful)&lt;/li&gt;
	&lt;li&gt;Makes cfs.markAllCompacting() return empty list if there are no sstables to execute the operation on and null if we failed cancelling&lt;/li&gt;
	&lt;li&gt;Make nodetool output an error message and set exit code to 1 if we fail&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13937777" author="jbellis" created="Mon, 17 Mar 2014 13:16:53 +0000"  >&lt;p&gt;LGTM.&lt;/p&gt;

&lt;p&gt;Are you still comfortable with 2.0 for this or should we do it in 2.1?&lt;/p&gt;</comment>
                            <comment id="13938125" author="krummas" created="Mon, 17 Mar 2014 18:03:24 +0000"  >&lt;p&gt;hmm i guess we shouldn&apos;t change the signatures of the exposed mbean methods in a minor rev&lt;/p&gt;

&lt;p&gt;lets go 2.1 and leave 2.0 with the assertion, as it is mostly a cosmetic change&lt;/p&gt;
</comment>
                            <comment id="13938972" author="krummas" created="Tue, 18 Mar 2014 08:48:53 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12635066" name="0001-6774-wip.patch" size="23946" author="marcuse" created="Mon, 17 Mar 2014 12:12:51 +0000"/>
                            <attachment id="12634393" name="0001-Dont-continue-after-failing-to-cancel-in-progress-co.patch" size="1332" author="marcuse" created="Thu, 13 Mar 2014 08:26:13 +0000"/>
                            <attachment id="12634766" name="6774-v2.txt" size="7464" author="jbellis" created="Fri, 14 Mar 2014 18:05:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>375893</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 36 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1srvz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>376189</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>