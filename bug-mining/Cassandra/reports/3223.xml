<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8004] Run LCS for both repaired and unrepaired data</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8004</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If a user has leveled compaction configured, we should run that for both the unrepaired and the repaired data. I think this would make things a lot easier for end users&lt;/p&gt;

&lt;p&gt;It would simplify migration to incremental repairs as well, if a user runs incremental repair on its nice leveled unrepaired data, we wont need to drop it all to L0, instead we can just start moving sstables from the unrepaired leveling straight into the repaired leveling&lt;/p&gt;

&lt;p&gt;Idea could be to have two instances of LeveledCompactionStrategy and move sstables between the instances after an incremental repair run (and let LCS be totally oblivious to whether it handles repaired or unrepaired data). Same should probably apply to any compaction strategy, run two instances and remove all repaired/unrepaired logic from the strategy itself.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12744024">CASSANDRA-8004</key>
            <summary>Run LCS for both repaired and unrepaired data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>lcs</label>
                    </labels>
                <created>Thu, 25 Sep 2014 13:24:42 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:57 +0000</updated>
                            <resolved>Wed, 5 Nov 2014 08:51:05 +0000</resolved>
                                        <fixVersion>2.1.2</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="14147728" author="tjake" created="Thu, 25 Sep 2014 13:29:07 +0000"  >&lt;p&gt;+1 this idea&lt;/p&gt;</comment>
                            <comment id="14161250" author="kohlisankalp" created="Tue, 7 Oct 2014 00:12:16 +0000"  >&lt;p&gt;Good idea. So if Level 2 stable is repaired, you will find all overlapping stables in L2 repaired and compact them to satisfy the non overlapping constrain? &lt;/p&gt;</comment>
                            <comment id="14161494" author="krummas" created="Tue, 7 Oct 2014 05:24:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kohlisankalp&quot; class=&quot;user-hover&quot; rel=&quot;kohlisankalp&quot;&gt;kohlisankalp&lt;/a&gt; not initially, what I want to avoid here is the really painful migration to using incremental backups. For the first incremental run, the repaired leveling will be totally empty and we can move sstables over directly. The future incremental repairs will do a &quot;can I move this sstable from unrepaired level X to repaired level X?&quot;, and the answer will most often be &quot;nope&quot;, then we drop it to level 0.&lt;/p&gt;

&lt;p&gt;It might be a good idea to consider doing in the future (3.0) though. I&apos;m targeting 2.1 here and want to keep it as simple as possible.&lt;/p&gt;</comment>
                            <comment id="14161824" author="krummas" created="Tue, 7 Oct 2014 12:18:42 +0000"  >&lt;p&gt;pushed a branch here for this: &lt;a href=&quot;https://github.com/krummas/cassandra/commit/476b27dc503c3541ee31dacdd70191fee8a819a5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commit/476b27dc503c3541ee31dacdd70191fee8a819a5&lt;/a&gt;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Introduces a &quot;WrappingCompactionStrategy&quot; that contains the logic for handling repaired/unrepaired sstables.
	&lt;ul&gt;
		&lt;li&gt;Could be a bit confusing and should probably be refactored for 3.0 - it would be nicer with a &quot;CompactionStrategyManager&quot; or similar that does not extend AbstractCompactionStrategy, but we currently call cfs.getCompactionStrategy() in many places so having the WCS makes it transparent to any users.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;As mentioned in the description this makes it possible, for the first run, to move sstables from the leveling in unrepaired straight over to the repaired-leveling. After the first run, we try to move sstables over, if it fails, they are sent to L0.&lt;/li&gt;
	&lt;li&gt;keeps 2 instances of the same compaction strategy, changing the compaction strategy is now handled by WrappingCompactionStrategy.&lt;/li&gt;
	&lt;li&gt;The compaction strategies now track which sstables they can run compaction on (LCS always did this, now STCS does it as well). So the compaction strategy will only ever see either repaired or unrepaired sstables.&lt;/li&gt;
	&lt;li&gt;As mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5351&quot; title=&quot;Avoid repairing already-repaired data by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5351&quot;&gt;&lt;del&gt;CASSANDRA-5351&lt;/del&gt;&lt;/a&gt; (and the original reason we did STCS on the unrepaired data) the write amplification gets a lot higher when having 2 parallel levelings, so maybe we should have an option to configure the different compaction strategies separately - you could configure STCS for the unrepaired and LCS for the repaired if the write amplification gets too high for the use case.&lt;/li&gt;
	&lt;li&gt;An added benefit of running LCS for the unrepaired data is that it makes each sstable contain a smaller range - making it more likely that the sstable is fully contained within the repaired range and the anticompaction step can simply update the repairedAt timestamp and not have to rewrite the entire sstable to split out the repaired ranges.&lt;/li&gt;
	&lt;li&gt;Also handles the case where someone runs incremental repair once, and then forgets about it, then all the data would be size tiered in the current implementation, with this there will be a small/old repaired leveling and a big unrepaired leveling.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thoughts, comments?&lt;/p&gt;</comment>
                            <comment id="14161947" author="iamaleksey" created="Tue, 7 Oct 2014 14:39:25 +0000"  >&lt;p&gt;Haven&apos;t looked at the patch yet, but the idea sound very good/reasonable to me.&lt;/p&gt;</comment>
                            <comment id="14163935" author="kohlisankalp" created="Wed, 8 Oct 2014 18:34:52 +0000"  >&lt;p&gt;WrappingCompactionStrategy.startup() again adds stables when they are already done in maybeReloadCompactionStrategy. Also we call startup on both strategies twice.  &lt;/p&gt;</comment>
                            <comment id="14172154" author="krummas" created="Wed, 15 Oct 2014 08:48:43 +0000"  >&lt;p&gt;pushed updated patch here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/8004&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/8004&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;pretty big/scary change to go into a minor release, but it would make migrating to incremental repairs so much easier and safer so imo it is worth it.&lt;/p&gt;</comment>
                            <comment id="14173057" author="kohlisankalp" created="Wed, 15 Oct 2014 22:17:28 +0000"  >&lt;p&gt;&quot;it would make migrating to incremental repairs so much easier&quot;&lt;br/&gt;
+1. Incremental repair is what I like the most in 2.1 and this is very important for it. &lt;br/&gt;
Let me review the new patch. &lt;/p&gt;</comment>
                            <comment id="14177642" author="kohlisankalp" created="Mon, 20 Oct 2014 23:24:25 +0000"  >&lt;p&gt;LGTM +1&lt;/p&gt;</comment>
                            <comment id="14187639" author="jbellis" created="Tue, 28 Oct 2014 22:46:27 +0000"  >&lt;p&gt;(I believe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; wanted to have a look as well before commit.)&lt;/p&gt;</comment>
                            <comment id="14190937" author="iamaleksey" created="Thu, 30 Oct 2014 22:11:55 +0000"  >&lt;p&gt;Still looking at it. Other than a failing CrcCheckChanceTest, things mostly look good - or rather as good as we can make them in 2.1, without major internal changes (hopefully we&apos;ll be able to redesign the APIs surrounding compaction in 3.x).&lt;/p&gt;

&lt;p&gt;Need a bit more time to make sure it doesn&apos;t break anything else though (incl. 3rd party compaction strategies, in unexpected ways).&lt;/p&gt;</comment>
                            <comment id="14191081" author="JIRAUSER308715" created="Fri, 31 Oct 2014 00:14:12 +0000"  >&lt;p&gt;One issue I see is that this adds new required functions to abstract compactions strategy. Which will break 3rd party compaction strategies.&lt;/p&gt;

&lt;p&gt;If we are going to be changing the interface, would it be better to have the wrapping strategy track the sstables and pass the list in?  Not sure how workable that is. &lt;/p&gt;</comment>
                            <comment id="14191462" author="krummas" created="Fri, 31 Oct 2014 06:26:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;One issue I see is that this adds new required functions to abstract compactions strategy. Which will break 3rd party compaction strategies.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;those new methods all have default implementations, and old compaction strategies should still work, even if they don&apos;t track their own sstables - they get the sstables to compact from cfs and split them in repaired/unrepaired. We might do it twice per call to &apos;getNextBackgroundTasks&apos; though, but that should be fine since we mark the sstables as compacting&lt;/p&gt;</comment>
                            <comment id="14191636" author="krummas" created="Fri, 31 Oct 2014 09:33:37 +0000"  >&lt;p&gt;CrcCheckChanceTest failed because we deadlocked ourselves due to synchronizing getMaximalTask in WCS - moved the synchronization inside the Callable instead, to avoid that (cfs.runWithCompactionsDisabled calls a few methods in the compaction strategy so moving the synchronization to later avoids the deadlock)&lt;/p&gt;

&lt;p&gt;Also made DTCS track its sstables&lt;/p&gt;

&lt;p&gt;rebased and (force) pushed 2 new commits here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/8004&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/8004&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14191826" author="JIRAUSER308715" created="Fri, 31 Oct 2014 14:13:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;those new methods all have default implementations, and old compaction strategies should still work, even if they don&apos;t track their own sstables - they get the sstables to compact from cfs and split them in repaired/unrepaired. We might do it twice per call to &apos;getNextBackgroundTasks&apos; though, but that should be fine since we mark the sstables as compacting&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm, yeah, I guess it should be fine as long as you are using the same strategy for repaired and un-repaired it should probably be OK.  The issue I see is if you start doing something like the LCS for repaired STCS for un-repaired.  If STCS wasn&apos;t tracking its own sstables, then it would trash everything.  But if you call 3rd party repair twice, then the 2nd call should just decide &quot;nothing to do&quot; and move on.&lt;/p&gt;</comment>
                            <comment id="14191833" author="krummas" created="Fri, 31 Oct 2014 14:18:21 +0000"  >&lt;p&gt;yeah, for now we always use the same strategy for repaired and unrepaired&lt;/p&gt;</comment>
                            <comment id="14196935" author="iamaleksey" created="Tue, 4 Nov 2014 22:08:34 +0000"  >&lt;p&gt;I can&apos;t shake the feeling that we can do better with a major-er refactor, but I guess not so much in 2.1 - will have to wait for the 3.0 changes.&lt;/p&gt;

&lt;p&gt;WRT new ACS methods - claiming that all of them have a default implementation, and thus aren&apos;t breaking compatibility, is dishonest. All our stock implementations do track their own sstables and thus &lt;b&gt;have to&lt;/b&gt; override them, and so would any 3rd party compaction strategy implementation. However, given the importance of this change (making incremental repair usable at all), I&apos;m okay with breaking it, so long as the commit makes it to 2.1.2. But please mark ACS#addSSTable() and ACS#removeSSTable() abstract, so that at least nobody gets burned silently.&lt;/p&gt;

&lt;p&gt;Minor nits:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;this reference is redundant in DTCS addSSTable() and removeSSTable() (and while at it, make DTCS.options private and final, and DTCS.sstables final)&lt;/li&gt;
	&lt;li&gt;same &apos;this&apos; nit in LCS and STCS&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Other than that, LGTM/+1 - and if you agree with the comments, just make the modifications on commit.&lt;/p&gt;</comment>
                            <comment id="14197225" author="iamaleksey" created="Wed, 5 Nov 2014 00:36:34 +0000"  >&lt;p&gt;Once last thing. How safe is it for the sstables set to be a simple HashSet, wrt visibility and concurrent updates?&lt;/p&gt;</comment>
                            <comment id="14197903" author="krummas" created="Wed, 5 Nov 2014 08:51:05 +0000"  >&lt;p&gt;Committed&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;How safe is it for the sstables set to be a simple HashSet&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;everything is synchronized in WrappingCompactionStrategy so it should be ok&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20h8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>kohlisankalp</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[kohlisankalp]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>