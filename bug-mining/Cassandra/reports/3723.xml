<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:55:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8515] Commit log stop policy not enforced correctly during startup</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8515</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If the commit log directory has no free space, Cassandra hangs on startup.&lt;/p&gt;

&lt;p&gt;The main thread is waiting:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; prio=9 tid=0x00007fefe400f800 nid=0x1303 waiting on condition [0x000000010b9c1000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;  &amp;lt;0x00000007dc8c5fc8&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)
	at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2043)
	at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)
	at org.apache.cassandra.db.commitlog.CommitLogAllocator.fetchSegment(CommitLogAllocator.java:137)
	at org.apache.cassandra.db.commitlog.CommitLog.activateNextSegment(CommitLog.java:299)
	at org.apache.cassandra.db.commitlog.CommitLog.&amp;lt;init&amp;gt;(CommitLog.java:73)
	at org.apache.cassandra.db.commitlog.CommitLog.&amp;lt;clinit&amp;gt;(CommitLog.java:53)
	at org.apache.cassandra.db.Keyspace.apply(Keyspace.java:360)
	at org.apache.cassandra.db.Keyspace.apply(Keyspace.java:339)
	at org.apache.cassandra.db.RowMutation.apply(RowMutation.java:211)
	at org.apache.cassandra.cql3.statements.ModificationStatement.executeInternal(ModificationStatement.java:699)
	at org.apache.cassandra.cql3.QueryProcessor.processInternal(QueryProcessor.java:208)
	at org.apache.cassandra.db.SystemKeyspace.updateSchemaVersion(SystemKeyspace.java:390)
	- locked &amp;lt;0x00000007de2f2ce0&amp;gt; (a java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; org.apache.cassandra.db.SystemKeyspace)
	at org.apache.cassandra.config.Schema.updateVersion(Schema.java:384)
	at org.apache.cassandra.config.DatabaseDescriptor.loadSchemas(DatabaseDescriptor.java:532)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:270)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:496)
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:585)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but COMMIT-LOG-ALLOCATOR is RUNNABLE:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;COMMIT-LOG-ALLOCATOR&quot;&lt;/span&gt; prio=9 tid=0x00007fefe5402800 nid=0x7513 in &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;.wait() [0x0000000118252000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
	at org.apache.cassandra.db.commitlog.CommitLogAllocator$1.runMayThrow(CommitLogAllocator.java:116)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but making no progress.&lt;/p&gt;

&lt;p&gt;This behaviour has changed since 1.2 (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5737&quot; title=&quot;CassandraDaemon - recent unsafe memory access operation in compiled Java code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5737&quot;&gt;&lt;del&gt;CASSANDRA-5737&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12762700">CASSANDRA-8515</key>
            <summary>Commit log stop policy not enforced correctly during startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pauloricardomg">Paulo Motta</assignee>
                                    <reporter username="rlow">Richard Low</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Dec 2014 22:21:25 +0000</created>
                <updated>Wed, 15 Oct 2025 09:48:55 +0000</updated>
                            <resolved>Fri, 14 Aug 2015 20:00:19 +0000</resolved>
                                        <fixVersion>2.1.9</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>3.0 beta 1</fixVersion>
                                    <component>Legacy/Coordination</component>
                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="14271657" author="mshuler" created="Fri, 9 Jan 2015 18:30:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rlow&quot; class=&quot;user-hover&quot; rel=&quot;rlow&quot;&gt;rlow&lt;/a&gt; the bug you linked, 5737, is was marked as Invalid. What would be the desired behavior? I would think and error logged and the service stopped, as opposed hanging. If you have a full disk, you may have additional problems - maybe the system logs are on the same spindle.&lt;/p&gt;</comment>
                            <comment id="14271668" author="rlow" created="Fri, 9 Jan 2015 18:38:39 +0000"  >&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5737&quot; title=&quot;CassandraDaemon - recent unsafe memory access operation in compiled Java code&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5737&quot;&gt;&lt;del&gt;CASSANDRA-5737&lt;/del&gt;&lt;/a&gt; was marked as invalid because it was thought to be a bug outside of Cassandra. But understanding the cause means we can do something about it, and I think logging and stopping would be the right approach, as you say.&lt;/p&gt;</comment>
                            <comment id="14625520" author="pauloricardomg" created="Mon, 13 Jul 2015 22:49:23 +0000"  >&lt;p&gt;Initial version of 2.1 patch attached (github link)&lt;/p&gt;

&lt;p&gt;Main idea is to stop JVM on commit log failure before initialization is finished, regardless of commit log failure policy in order to prevent hanging node on initialization. After I implemented I was wondering, if we should attain to the failure policy anyway, and leave the node hanging if the user chooses &quot;ignore&quot; policy, for example.&lt;/p&gt;

&lt;p&gt;Tests verifies if JVM is being killed when a failure ocurs before initialization is finished. I&apos;m not 100% confortable with busy wait tests, but was the easiest to make. Could work on a more elegant solution if necessary, but since the wait is maximum 50ms I thought it could be acceptable.&lt;/p&gt;

&lt;p&gt;Could you please review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;? I&apos;ll make 2.2 and 3.0 patches if this looks good.&lt;/p&gt;</comment>
                            <comment id="14663308" author="benedict" created="Sun, 9 Aug 2015 07:43:12 +0000"  >&lt;p&gt;LGTM. Committed as 3b7934f1aa20d2210866afd9b88472e9cb1aed8d.&lt;/p&gt;</comment>
                            <comment id="14680280" author="jmckenzie" created="Mon, 10 Aug 2015 15:46:14 +0000"  >&lt;p&gt;This commit breaks CommitLogFailurePolicyTest on Windows:&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/cassandra-2.2/job/cassandra-2.2_utest_win32/79/testReport/org.apache.cassandra.db/CommitLogFailurePolicyTest/testCommitFailurePolicy_stop/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failure&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Re-opening ticket so that can be addressed here.&lt;/p&gt;</comment>
                            <comment id="14680551" author="iamaleksey" created="Mon, 10 Aug 2015 18:54:23 +0000"  >&lt;p&gt;Breaks it on OS X as well.&lt;/p&gt;

&lt;p&gt;Don&apos;t know if we had checked with cassci before committing, but I don&apos;t see a link here.&lt;/p&gt;

&lt;p&gt;Also, there is now overlap between &lt;tt&gt;CommitLogFailurePolicyTest&lt;/tt&gt; and &lt;tt&gt;CommitLogTest&lt;/tt&gt;. It seems to me that the former can be removed entirely.&lt;/p&gt;</comment>
                            <comment id="14680582" author="benedict" created="Mon, 10 Aug 2015 19:07:51 +0000"  >&lt;p&gt;Yep, although it&apos;s possible I merge upstream badly. Or perhaps that these tests were not present in 2.1, since it was all pretty clean.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-8515-2.1-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;for reference&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Still, definitely my bad for not confirming each of the upstream merges passed.&lt;/p&gt;</comment>
                            <comment id="14680662" author="pauloricardomg" created="Mon, 10 Aug 2015 19:53:40 +0000"  >&lt;p&gt;Sorry for not including test links to all branches before. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8992&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-8992&lt;/a&gt; extracted commit log failure policy tests from class &lt;tt&gt;CommitLogTest&lt;/tt&gt; to &lt;tt&gt;CommitLogFailurePolicyTests&lt;/tt&gt; on 2.2+. Since this patch (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8115&quot; title=&quot;Windows install scripts fail to set logdir and datadir&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8115&quot;&gt;&lt;del&gt;CASSANDRA-8115&lt;/del&gt;&lt;/a&gt;) was originally made on 2.1, it fixed existing tests on &lt;tt&gt;CommitLogTests&lt;/tt&gt;, but when that was merged up, the class &lt;tt&gt;CommitLogFailurePolicyTest&lt;/tt&gt; remained unchanged with broken tests.&lt;/p&gt;

&lt;p&gt;One option would be to place all &lt;tt&gt;CommitLogFailurePolicyTest&lt;/tt&gt; back on &lt;tt&gt;CommitLogTests&lt;/tt&gt;, but I opted for leaving them in a separate class (as is right now), since they are specific tests only for the failure policies, and not for overall commit log functioning.&lt;/p&gt;

&lt;p&gt;Fix patch is available on the following links for review:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:8515-2.2-fix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 patch&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:8515-3.0-fix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 patch&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:8515-trunk-fix&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk patch&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Tests will be available soon on the following links:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-8515-2.2-fix-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 dtest&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-8515-2.2-fix-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 testall&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-8515-3.0-fix-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 dtest&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-8515-3.0-fix-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 testall&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-8515-trunk-fix-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk dtest&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-8515-trunk-fix-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk testall&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14681465" author="benedict" created="Tue, 11 Aug 2015 08:53:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;: something funny seems to have happened during all of those runs. I&apos;m not sure what, but none of them completed successfully.&lt;/p&gt;

&lt;p&gt;it&apos;s possible it&apos;s a CI issue, but if you could investigate that would be appreciated.&lt;/p&gt;</comment>
                            <comment id="14694492" author="pauloricardomg" created="Thu, 13 Aug 2015 01:01:04 +0000"  >&lt;p&gt;Unit tests are now available. 2.2 dtests worked fine. 3.0 and trunk dtests are being ABORTED, but the same is happening with upstream branches. Unit tests worked fine on Windows locally.&lt;/p&gt;

&lt;p&gt;Since the changes are only related to unit tests, I think we can safely commit.&lt;/p&gt;</comment>
                            <comment id="14697652" author="benedict" created="Fri, 14 Aug 2015 20:00:19 +0000"  >&lt;p&gt;Thanks. Merged as c645b1193444fdfae7ded2ce01bddc0de2813429&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12826439">CASSANDRA-9279</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12834319">CASSANDRA-9525</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12839687">CASSANDRA-9635</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 14 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23lhj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>