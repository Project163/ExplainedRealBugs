<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:10:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14292] Fix batch commitlog sync regression</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14292</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Prior to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13987&quot; title=&quot;Multithreaded commitlog subtly changed durability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13987&quot;&gt;&lt;del&gt;CASSANDRA-13987&lt;/del&gt;&lt;/a&gt;, in batch commitlog mode, commitlog will be synced to disk right after mutation comes.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;haveWork semaphore is released in BatchCommitLogService.maybeWaitForSync&lt;/li&gt;
	&lt;li&gt;AbstractCommitlogService will continue and sync to disk&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After C-13987, it makes a branch for chain maker flush more frequently in periodic mode. To make sure in batch mode CL still flushes immediately, it added &lt;tt&gt;syncRequested&lt;/tt&gt;&#160;flag.&lt;br/&gt;
 Unfortunately, in 3.0 branch, this flag is not being set to true when mutation is waiting.&lt;/p&gt;

&lt;p&gt;So in AbstractCommitlogService, it will not execute the CL sync branch until it reaches sync window(2ms)..&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;AbstractCommitLogService.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastSyncedAt + syncIntervalMillis &amp;lt;= pollStarted || shutdown || syncRequested)
{
    &lt;span class=&quot;code-comment&quot;&gt;// in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; branch, we want to flush the commit log to disk
&lt;/span&gt;    syncRequested = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
    commitLog.sync(shutdown, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    lastSyncedAt = pollStarted;
    syncComplete.signalAll();
}
&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
{
    &lt;span class=&quot;code-comment&quot;&gt;// in &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; branch, just update the commit log sync headers
&lt;/span&gt;    commitLog.sync(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13142731">CASSANDRA-14292</key>
            <summary>Fix batch commitlog sync regression</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jasonstack">Zhao Yang</assignee>
                                    <reporter username="jasonstack">Zhao Yang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Mar 2018 01:55:59 +0000</created>
                <updated>Fri, 15 May 2020 08:04:36 +0000</updated>
                            <resolved>Wed, 7 Mar 2018 12:12:57 +0000</resolved>
                                        <fixVersion>3.0.17</fixVersion>
                    <fixVersion>3.11.3</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16387146" author="jasonstack" created="Tue, 6 Mar 2018 02:02:20 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasonstack/cassandra/commits/CASSANDRA-14292-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&#160;unit running&#160;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;dtest running&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Changes:&lt;/p&gt;

&lt;p&gt;1. Set &lt;tt&gt;syncRequested&lt;/tt&gt;&#160;to true in &lt;tt&gt;BatchCommitLogService.maybeWaitForSync, so batch CL will sync immediately when mutation comes&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;2. Added unit test to verify batch CL sync and shutdown immediately&lt;/p&gt;</comment>
                            <comment id="16387232" author="jasobrown" created="Tue, 6 Mar 2018 03:48:05 +0000"  >&lt;p&gt;Please take a look to see if &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14194&quot; title=&quot;Chain commit log marker potential performance regression in batch commit mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14194&quot;&gt;&lt;del&gt;CASSANDRA-14194&lt;/del&gt;&lt;/a&gt; (committed today) helps. I&apos;ll read this more thoroughly, as well.&lt;/p&gt;</comment>
                            <comment id="16387292" author="jasonstack" created="Tue, 6 Mar 2018 05:05:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14194&quot; title=&quot;Chain commit log marker potential performance regression in batch commit mode&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14194&quot;&gt;&lt;del&gt;CASSANDRA-14194&lt;/del&gt;&lt;/a&gt; was solving race condition&#160;with multiple mutations. This ticket is to solve performance for single mutation.&lt;/p&gt;

&lt;p&gt;In 3.0 branch with 13987, each mutation will have to wait for full batch-sync-window(2ms) for commitlog to sync.&lt;/p&gt;</comment>
                            <comment id="16388033" author="aweisberg" created="Tue, 6 Mar 2018 16:21:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; looks like it wasn&apos;t registering to receive notification of the sync before requesting the sync. It&apos;s another way for &lt;tt&gt;syncRequested&lt;/tt&gt; to get clobbered.&lt;/p&gt;

&lt;p&gt;I&apos;m +1 on this change. Is it a 3.11 bug as well?&lt;/p&gt;</comment>
                            <comment id="16388039" author="jasonstack" created="Tue, 6 Mar 2018 16:24:43 +0000"  >&lt;p&gt;It&#8217;s 3.0.16 only..&lt;/p&gt;</comment>
                            <comment id="16388763" author="jasobrown" created="Wed, 7 Mar 2018 00:19:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; Yeah, you are correct; I missed this case. This is the problem when working on the same patch across four branches; I&apos;m sure I had something like this at one point in a 3.0 branch .... &amp;lt;sigh&amp;gt;&lt;/p&gt;

&lt;p&gt;I&apos;m +1 on the patch, as well. Thanks for the unit test - I like it enough that I&apos;ll forward port it to 3.11 and trunk when I commit.&lt;/p&gt;</comment>
                            <comment id="16389470" author="jasobrown" created="Wed, 7 Mar 2018 12:12:57 +0000"  >&lt;p&gt;committed as sha &lt;tt&gt;00c90c16e99fdfb153cb418f0e3486b62183986e&lt;/tt&gt;. Thanks!&lt;/p&gt;</comment>
                            <comment id="16391034" author="jasonstack" created="Thu, 8 Mar 2018 10:25:53 +0000"  >&lt;p&gt;Thanks for the review.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13124410">CASSANDRA-14108</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13115620">CASSANDRA-13987</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12913305" name="14292-3.0-dtest.png" size="788661" author="jasonstack" created="Wed, 7 Mar 2018 01:27:46 +0000"/>
                            <attachment id="12913306" name="14292-3.0-unittest.png" size="119424" author="jasonstack" created="Wed, 7 Mar 2018 01:27:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasonstack]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 36 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qwk7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>