<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:47:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7809] UDF cleanups (#7395 follow-up)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7809</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The current code for UDF is largely not reusing the pre-existing mechanics/code for native/hardcoded functions. I don&apos;t see a good reason for that but I do see downsides: it&apos;s more code to maintain and makes it much easier to have inconsitent behavior between hard-coded and user-defined function. More concretely, &lt;tt&gt;UDFRegistery/UDFFunctionOverloads&lt;/tt&gt; fundamentally do the same thing than &lt;tt&gt;Functions&lt;/tt&gt;, we should just merge both. I&apos;m also not sure there is a need for both &lt;tt&gt;UFMetadata&lt;/tt&gt; and &lt;tt&gt;UDFunction&lt;/tt&gt; since &lt;tt&gt;UFMetadata&lt;/tt&gt; really only store infos on a given function (contrarly to what the javadoc pretends).  I suggest we consolidate all this to cleanup the code, but also as a way to fix 2 problems that the UDF code has but that the existing code for &quot;native&quot; functions don&apos;t:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;if there is multiple overloads of a function, the UDF code picks the first version whose argument types are compatible with the concrete arguments provided. This is broken for bind markers: we don&apos;t know the type of markers and so the first function match may not at all be what the user want. The only sensible choice is to detect that type of ambiguity and reject the query, asking the user to explicitly type-cast their bind marker (which is what the code for hard-coded function does).&lt;/li&gt;
	&lt;li&gt;the UDF code builds a function signature using the CQL type names of the arguments and use that to distinguish multiple overrides in the schema. This means in particular that &lt;tt&gt;f(v text)&lt;/tt&gt; and &lt;tt&gt;f(v varchar)&lt;/tt&gt; are considered distinct, which is wrong since CQL considers &lt;tt&gt;varchar&lt;/tt&gt; as a simple alias of &lt;tt&gt;text&lt;/tt&gt;. And in fact, the function resolution does consider them aliases leading to seemingly broken behavior.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There is a few other small problems that I&apos;m proposing to fix while doing this cleanup:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Function creation only use the function name when checking if the function exists, which is not enough since we allow multiple over-loadings. You can bypass the check by using &quot;OR REPLACE&quot; but that&apos;s obviously broken.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;IF NOT EXISTS&lt;/tt&gt; for function creation is broken.&lt;/li&gt;
	&lt;li&gt;The code allows to replace a function (with &lt;tt&gt;OR REPLACE&lt;/tt&gt;) by a new function with an incompatible return type. Imo that&apos;s dodgy and we should refuse it (users can still drop and re-create the method if they really want).&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12735784">CASSANDRA-7809</key>
            <summary>UDF cleanups (#7395 follow-up)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                            <label>cql</label>
                    </labels>
                <created>Thu, 21 Aug 2014 13:52:15 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:36 +0000</updated>
                            <resolved>Wed, 27 Aug 2014 08:40:52 +0000</resolved>
                                        <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14105377" author="slebresne" created="Thu, 21 Aug 2014 13:55:18 +0000"  >&lt;p&gt;Pushed &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/7809&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; with the change suggested above. The branch has a bunch of commits described below:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&apos;Introduce FunctionName class&apos;: the code passes the namespace and name of a function all the time, which is a bit annoying and forces concatening them for every error message. Not a huge deal but using a FunctionName class is slightly cleaner imo (it&apos;s also consitent with the UTName we use for UDT).&lt;/li&gt;
	&lt;li&gt;&apos;Make Functions handle overload of a function with different return types&apos;: slightly generalize the code in &lt;tt&gt;Functions&lt;/tt&gt; so that the different overloads of a function don&apos;t have to have the same return type.&lt;/li&gt;
	&lt;li&gt;&apos;Special case Token function and remove Function.Factory&apos;: the &lt;tt&gt;token&lt;/tt&gt; function is somewhat special in that it&apos;s argument types actually depend on the table it&apos;s applied to since they depend on the partition key definition. The code was using &lt;tt&gt;Function.Factory&lt;/tt&gt; to handle this, but it&apos;s overkill and was complicating the following commits so this commit change it to instead special case the &lt;tt&gt;token&lt;/tt&gt; method, which is much simpler overall.&lt;/li&gt;
	&lt;li&gt;&apos;Merge UDF code with existing function code&apos;: this is the main commit. It refactors the code so that both native and UDF functions share as much code as possible, and it fixes most of the issues described above.&lt;/li&gt;
	&lt;li&gt;&apos;Prefer exact type match when resolving functions&apos;: the code in Functions was detecting if multiple overloads were applicable for a given call-site (because of a bind marker for instance), but it wasn&apos;t properly breaking the ambiguity if there was an exact type match. The commit fixes that.&lt;/li&gt;
	&lt;li&gt;&apos;Update test&apos;: mainly adds new tests to exercise the bugs describe above.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14106099" author="thobbs" created="Thu, 21 Aug 2014 22:50:43 +0000"  >&lt;p&gt;I still have a few things to review and test, but I have a few preliminary comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;There&apos;s no way to drop a UDF if there&apos;s a problem loading it (because the class disappeared or whatever).  Maybe put a placeholder in the map of declared functions?&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;Functions.matchArgument()&lt;/tt&gt;, the switch at the end is a bit weird.  Just return argRes if it&apos;s not EXACT_MATCH.&lt;/li&gt;
	&lt;li&gt;Why does Maps/Sets/Lists.testAssignment() return WEAKLY_ASSIGNABLE for exact matches?  It seems like we might want EXACT_MATCH when possible for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7563&quot; title=&quot;UserType, TupleType and collections in UDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7563&quot;&gt;&lt;del&gt;CASSANDRA-7563&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14106640" author="slebresne" created="Fri, 22 Aug 2014 08:45:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;Maybe put a placeholder in the map of declared functions?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good idea as that also allows to provide a more meaningful error message when the badly-loaded function is executed. I&apos;ve pushed an additional commit to the branch.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Just return argRes if it&apos;s not EXACT_MATCH&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s not exactly what we want because even if we get a &lt;tt&gt;WEAKLY_ASSIGNABLE&lt;/tt&gt;, we still need to finish the loop to check if some argument might be not assignable at all. But arguably the switch was not super elegant so I changed it and added a comment.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Why does Maps/Sets/Lists.testAssignment() return WEAKLY_ASSIGNABLE for exact matches?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That was part-laziness and part because it&apos;s not really all that useful in practice (it&apos;ll make a difference for something like &apos;{(int)?, (int)?, (int)?}&apos; but that&apos;s about it, and why would you ever write that when you can write &apos;(set&amp;lt;int&amp;gt;){?, ?, ?}&apos; or really just &apos;(set&amp;lt;int&amp;gt;)?&apos; ?). But anyway, neither are extremely good reasons so I&apos;ve fixed it.&lt;/p&gt;</comment>
                            <comment id="14107424" author="thobbs" created="Fri, 22 Aug 2014 20:20:25 +0000"  >&lt;p&gt;This is pretty close to being good to go.&lt;/p&gt;

&lt;p&gt;Some nitpicks:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;FunctionCall.java: &quot;Cannot assign result of function...&quot; should use receiver.name() in message&lt;/li&gt;
	&lt;li&gt;Functions.java: &quot;none of its type signature matches&quot; should be &quot;none of its type signatures match&quot;&lt;/li&gt;
	&lt;li&gt;NativeFunction.java: unused import of java.util.List&lt;/li&gt;
	&lt;li&gt;AbstractFunction.java: unused import of java.util.Arrays&lt;/li&gt;
	&lt;li&gt;CreateFunctionStatement.java: unused imports&lt;/li&gt;
	&lt;li&gt;DropFunctionStatement.java: unused import of Schema&lt;/li&gt;
	&lt;li&gt;UFTest.java: unused import, should put &quot;stopForcingPreparedValues()&quot; in a finally block&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It also looks like we don&apos;t have any unit or dtest coverage for type casts (besides the few you added in UFTest).  Can you add unit tests here or open a ticket for that?  We also don&apos;t document typecasting in the CQL3 docs.&lt;/p&gt;</comment>
                            <comment id="14109006" author="slebresne" created="Mon, 25 Aug 2014 10:49:20 +0000"  >&lt;p&gt;I&apos;ve pushed a commit to the branch to fix the nits above for info.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;should put &quot;stopForcingPreparedValues()&quot; in a finally block&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think that&apos;s necessary since CQLTester will reset that after each test anyway, and so I&apos;d rather keep it the way it is (it&apos;s really just test code and try/finally makes thing a bit more verbose imo).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It also looks like we don&apos;t have any unit or dtest coverage for type casts (besides the few you added in UFTest)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s true. Though type casting is really only useful for functions to disambiguate when multiple override apply and that what is tested in &lt;tt&gt;UFTest&lt;/tt&gt;. I&apos;ve added an additional TypeCastingTest nonetheless though I&apos;m not sure what else to test here (but feel free to open a separate ticket if you have other things in mind).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We also don&apos;t document typecasting in the CQL3 &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Also true. Since as said above typecasting is really only useful in the context of UDFs, I&apos;d added a note to not forget them in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7737&quot; title=&quot;Update CQL doc for UDF&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7737&quot;&gt;&lt;del&gt;CASSANDRA-7737&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14111093" author="thobbs" created="Tue, 26 Aug 2014 18:24:03 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure what else to test here (but feel free to open a separate ticket if you have other things in mind).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That should be fine for now, thanks!&lt;/p&gt;</comment>
                            <comment id="14112041" author="slebresne" created="Wed, 27 Aug 2014 08:40:52 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1z6n3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>