<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:08:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13754] BTree.Builder memory leak</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13754</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After a chronic bout of &lt;tt&gt;OutOfMemoryError&lt;/tt&gt; in our development environment, a heap analysis is showing that more than 10G of our 12G heaps are consumed by the &lt;tt&gt;threadLocals&lt;/tt&gt; members (instances of &lt;tt&gt;java.lang.ThreadLocalMap&lt;/tt&gt;) of various &lt;tt&gt;io.netty.util.concurrent.FastThreadLocalThread&lt;/tt&gt; instances.  Reverting &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commit;h=cecbe17e3eafc052acc13950494f7dddf026aa54&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cecbe17&lt;/a&gt; fixes the issue.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Cassandra 3.11.0, Netty 4.0.44.Final, OpenJDK 8u141-b15&lt;/p&gt;</environment>
        <key id="13093846">CASSANDRA-13754</key>
            <summary>BTree.Builder memory leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="snazy">Robert Stupp</assignee>
                                    <reporter username="urandom">Eric Evans</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Aug 2017 16:15:08 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:54 +0000</updated>
                            <resolved>Wed, 13 Sep 2017 17:05:05 +0000</resolved>
                                        <fixVersion>3.11.1</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="16122012" author="jjirsa" created="Thu, 10 Aug 2017 18:08:49 +0000"  >&lt;p&gt;What version are you on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=urandom&quot; class=&quot;user-hover&quot; rel=&quot;urandom&quot;&gt;urandom&lt;/a&gt; (or really, which version of netty is in the classpath) ? &lt;/p&gt;</comment>
                            <comment id="16122390" author="urandom" created="Thu, 10 Aug 2017 21:43:04 +0000"  >&lt;p&gt;Cassandra 3.11.0, Netty 4.0.44.Final&lt;/p&gt;</comment>
                            <comment id="16148580" author="markusdlugi" created="Thu, 31 Aug 2017 07:38:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt;, we are experiencing the same issue on Cassandra 3.11.0 and Netty 4.0.44. We have some custom triggers which create additional rows when &lt;tt&gt;INSERT&lt;/tt&gt; s on specific CFs are executed. When inserting a lot of data, the Cassandra would constantly crash with &lt;tt&gt;OutOfMemoryError&lt;/tt&gt; s. We analyzed a heap dump and came to the same conclusion, which is that the instances of &lt;tt&gt;FastThreadLocalThread&lt;/tt&gt; were responsible for this behaviour. As a quick workaround, we added a call to &lt;tt&gt;FastThreadLocal.removeAll()&lt;/tt&gt; to our triggers, which alleviates the problem for us.&lt;/p&gt;

&lt;p&gt;It seems that there already was an issue once with &lt;tt&gt;FastThreadLocal&lt;/tt&gt; s, as described in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13033&quot; title=&quot;Thread local pools never cleaned up&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13033&quot;&gt;&lt;del&gt;CASSANDRA-13033&lt;/del&gt;&lt;/a&gt;, but apparently the change by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt; in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13034&quot; title=&quot;Move to FastThreadLocalThread and FastThreadLocal&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13034&quot;&gt;&lt;del&gt;CASSANDRA-13034&lt;/del&gt;&lt;/a&gt; resurfaced the issue. For a proper fix, I think all &lt;tt&gt;FastThreadLocalThread&lt;/tt&gt; instances should call &lt;tt&gt;FastThreadLocal.removeAll()&lt;/tt&gt; when they are done with their work. A quick glance at the code indicates that this affects the classes &lt;tt&gt;CompressedInputStream&lt;/tt&gt; , &lt;tt&gt;StreamingInboundHandler&lt;/tt&gt; , &lt;tt&gt;NamedThreadFactory&lt;/tt&gt; and &lt;tt&gt;SEPWorker&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16148769" author="snazy" created="Thu, 31 Aug 2017 10:03:34 +0000"  >&lt;p&gt;Thanks for the investigation, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markusdlugi&quot; class=&quot;user-hover&quot; rel=&quot;markusdlugi&quot;&gt;markusdlugi&lt;/a&gt;, I&apos;m going to check what&apos;s happening. All &lt;tt&gt;Runnables&lt;/tt&gt; should have been decorated with a &lt;tt&gt;try-finally&lt;/tt&gt; to call &lt;tt&gt;FastThreadLocal.removeAll()&lt;/tt&gt; to prevent exactly that.&lt;/p&gt;</comment>
                            <comment id="16148823" author="markusdlugi" created="Thu, 31 Aug 2017 10:55:22 +0000"  >&lt;p&gt;I see, you are talking about &lt;tt&gt;NamedTheadFactory.threadLocalDeallocator()&lt;/tt&gt;, right? That should help for any threads created there, but as stated above, &lt;tt&gt;FastThreadLocalThread&lt;/tt&gt; is also used in some other classes. Heap-wise, the most problematic one for us was the usage in &lt;tt&gt;SEPWorker&lt;/tt&gt; I think, and this seems to have only been introduced with commit &lt;a href=&quot;https://github.com/apache/cassandra/commit/1e92ce43a5a730f81d3f6cfd72e7f4b126db788a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1e92ce43a5a730f81d3f6cfd72e7f4b126db788a&lt;/a&gt; by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;. Maybe something similar can be done there and in all other classes making use of &lt;tt&gt;FastThreadLocalThread&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16148858" author="snazy" created="Thu, 31 Aug 2017 11:33:09 +0000"  >&lt;p&gt;Yea, that &lt;tt&gt;SEPWorker&lt;/tt&gt; plus a couple more places (see &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...snazy:13754-ftl-leak-3.11?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...snazy:13754-ftl-leak-trunk?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;). It&apos;s actually difficult to tell whether there was really something broken in all these places in the patch, but those changes don&apos;t (should not) harm. But if someone introduces a &lt;tt&gt;FastThreadLocal&lt;/tt&gt; there in the future, it should have no negative impact.&lt;br/&gt;
Our CI&apos;s currently checking the patches.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markusdlugi&quot; class=&quot;user-hover&quot; rel=&quot;markusdlugi&quot;&gt;markusdlugi&lt;/a&gt;, do you have any chance to verify the patches?&lt;/p&gt;</comment>
                            <comment id="16149002" author="markusdlugi" created="Thu, 31 Aug 2017 13:53:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt;, I checked out the 13754-ftl-leak-3.11 branch and ran our load test with your patches. Unfortunately, the memory leak is still there, Cassandra first starts GCing like crazy and then throws an &lt;tt&gt;OutOfMemoryError&lt;/tt&gt; after a while. So it seems like the call to &lt;tt&gt;FastThreadLocal.removeAll()&lt;/tt&gt; is not properly executed.&lt;/p&gt;

&lt;p&gt;Actually, while writing this it just struck me why that is the case. The thread created in &lt;tt&gt;SEPWorker&lt;/tt&gt; does not stop after it finishes, but is instead returned to the pool and picks up new tasks. So it will never leave the &lt;tt&gt;run()&lt;/tt&gt; method, and therefore also never execute &lt;tt&gt;FastThreadLocal.removeAll()&lt;/tt&gt;. So I think we will have to include that call in the &lt;tt&gt;SEPWorker&lt;/tt&gt; itself.&lt;/p&gt;</comment>
                            <comment id="16149023" author="snazy" created="Thu, 31 Aug 2017 14:05:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markusdlugi&quot; class=&quot;user-hover&quot; rel=&quot;markusdlugi&quot;&gt;markusdlugi&lt;/a&gt; do you have a heap dump for me or references to what&apos;s actually in these &lt;tt&gt;FastThreadLocal&lt;/tt&gt; s or which FTLs actually cause this? I suspect these are FTLs created in non-static fields, which probably need a different handling.&lt;/p&gt;

&lt;p&gt;Calling &lt;tt&gt;FastThreadLocal.removeAll()&lt;/tt&gt; after every iteration in &lt;tt&gt;SEPWorker&lt;/tt&gt; is not a good solution, because that would effectively kill the benefit of all static FTLs.&lt;/p&gt;</comment>
                            <comment id="16149207" author="snazy" created="Thu, 31 Aug 2017 16:24:22 +0000"  >&lt;p&gt;Well, yea. Looking at the heap dump, that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markusdlugi&quot; class=&quot;user-hover&quot; rel=&quot;markusdlugi&quot;&gt;markusdlugi&lt;/a&gt; provided, is looks like the node is &quot;just&quot; overloaded with too many and maybe too big writes in combination with a small heap. There are lots of &lt;tt&gt;BTree$Builder&lt;/tt&gt; instances with live references in their &lt;tt&gt;Object[] values&lt;/tt&gt; array to &lt;tt&gt;HeapByteBuffer&lt;/tt&gt; instances, each holding a 1MB &lt;tt&gt;byte[]&lt;/tt&gt;.&lt;br/&gt;
&lt;tt&gt;BTree$Builder&lt;/tt&gt; instances reset the &lt;tt&gt;Object[] values&lt;/tt&gt; when finished - i.e. those builders are actively doing something (writes are happening at that time).&lt;br/&gt;
TL;DR I don&apos;t think this is actually related to the issue that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=urandom&quot; class=&quot;user-hover&quot; rel=&quot;urandom&quot;&gt;urandom&lt;/a&gt; describes.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=urandom&quot; class=&quot;user-hover&quot; rel=&quot;urandom&quot;&gt;urandom&lt;/a&gt;, can you explain what actually what these &lt;tt&gt;ThreadLocal&lt;/tt&gt; instances referenced?&lt;/p&gt;</comment>
                            <comment id="16150172" author="markusdlugi" created="Fri, 1 Sep 2017 07:41:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt;, I don&apos;t think the node is overloaded. I originally thought so as well, so I made a little experiment where I included a cap in our load test limiting the &lt;tt&gt;INSERT&lt;/tt&gt; s per minute from ~25,000 to ~10,000. As a consequence, the node survived a little longer, but in the end it still died with an &lt;tt&gt;OutOfMemoryError&lt;/tt&gt; after more data had been inserted. So it&apos;s not that there are too many active writes, it&apos;s just that the node fails after a certain amount of total writes, which indicates to me that a memory leak is indeed happening.&lt;/p&gt;

&lt;p&gt;I also had another look into the heap dump I sent you, and you are correct that the heap is mostly filled with &lt;tt&gt;BTree$Builder&lt;/tt&gt; instances that still have stuff in their &lt;tt&gt;values&lt;/tt&gt; array. However, if you look closer, you will notice that for each of these instances, the &lt;tt&gt;values&lt;/tt&gt; array always contains &lt;tt&gt;null&lt;/tt&gt; for the first couple of entries, and only after those there is still actual content. For some reason, the actual content always starts at index 28, whereas indices 0 - 27 are &lt;tt&gt;null&lt;/tt&gt; - not sure if this is a coincidence? But you can also see that for all the &lt;tt&gt;BTree$Builder&lt;/tt&gt; objects, the &lt;tt&gt;count&lt;/tt&gt; attribute is 0, which also indicates to me that &lt;tt&gt;BTree$Builder.cleanup()&lt;/tt&gt; has already run and those are not active writes. This theory is supported by the fact that my little workaround of manually calling &lt;tt&gt;FastThreadLocal.removeAll()&lt;/tt&gt; actually works, because this means that no other objects except the &lt;tt&gt;FastThreadLocal&lt;/tt&gt; s still have references to the builders.&lt;/p&gt;

&lt;p&gt;Therefore, I think we have two issues here:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;SEPWorker&lt;/tt&gt; is never cleaning the &lt;tt&gt;FastThreadLocal&lt;/tt&gt; s, therefore accumulating references to otherwise dead objects - maybe we can include something to at least remove non-static entries regularly?&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;BTree$Builder&lt;/tt&gt; seems to have an issue properly cleaning up after building, so the objects referenced by the &lt;tt&gt;FastThreadLocal&lt;/tt&gt; s of the &lt;tt&gt;SEPWorker&lt;/tt&gt; threads are very large and thus ultimately lead to the &lt;tt&gt;OutOfMemoryError&lt;/tt&gt; s&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16150338" author="snazy" created="Fri, 1 Sep 2017 10:21:21 +0000"  >&lt;p&gt;Your observation regarding &lt;tt&gt;BTree.Builder.values[]&lt;/tt&gt; seems correct.&lt;br/&gt;
However, &lt;tt&gt;SEPWorker&lt;/tt&gt; must &lt;b&gt;not&lt;/b&gt; remove the thread locals - it&apos;s the intention of these thread-locals to be kept for reuse.&lt;/p&gt;</comment>
                            <comment id="16150416" author="markusdlugi" created="Fri, 1 Sep 2017 12:08:56 +0000"  >&lt;p&gt;Your latest patch which resets the entire &lt;tt&gt;BTree$Builder.values&lt;/tt&gt; array seemed to do the trick, entire load test is now running smoothly. No more crazy GCing and most importantly no &lt;tt&gt;OutOfMemoryError&lt;/tt&gt; s. Thanks a lot for the fast support and help!&lt;/p&gt;</comment>
                            <comment id="16150602" author="snazy" created="Fri, 1 Sep 2017 14:19:33 +0000"  >&lt;p&gt;Given that the FTL changes apparently do not have any influence to the OOM issuse, but look serious enough to fix, I&apos;ve split them out into &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13838&quot; title=&quot;Ensure all threads are FastThreadLocal.removeAll() is called for all threads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13838&quot;&gt;CASSANDRA-13838&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Patch for this ticket is reduced to the BTree change.&lt;br/&gt;
CI looks good.&lt;/p&gt;</comment>
                            <comment id="16150609" author="JIRAUSER308715" created="Fri, 1 Sep 2017 14:21:32 +0000"  >&lt;p&gt;+1 for just &lt;a href=&quot;https://github.com/apache/cassandra/commit/2cafd0b6b4bbc5a6ec5726d47d0093bdac3af19c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/2cafd0b6b4bbc5a6ec5726d47d0093bdac3af19c&lt;/a&gt; to fix this and splitting out the other changes to a new ticket.&lt;/p&gt;</comment>
                            <comment id="16150611" author="JIRAUSER308715" created="Fri, 1 Sep 2017 14:22:06 +0000"  >&lt;p&gt;and +1 for the patch.&lt;/p&gt;</comment>
                            <comment id="16150920" author="snazy" created="Fri, 1 Sep 2017 17:49:54 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/bed7fa5ef8492d1ff3852cf299622a5ad4e0b621&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;bed7fa5ef8492d1ff3852cf299622a5ad4e0b621&lt;/a&gt; to &lt;a href=&quot;https://github.com/apache/cassandra/tree/cassandra-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cassandra-3.11&lt;/a&gt; and merged to trunk.&lt;/p&gt;</comment>
                            <comment id="16162124" author="urandom" created="Mon, 11 Sep 2017 22:13:58 +0000"  >&lt;p&gt;I apologize for chiming in here so late, but I&apos;m not sure this addresses what I was seeing.  In my dumps, all of the heap is tied up in the &lt;tt&gt;ThreadLocalMap&lt;/tt&gt; s of instances of &lt;tt&gt;FastThreadLocalThread&lt;/tt&gt; for &lt;em&gt;Native-Transport-Requests&lt;/em&gt;, &lt;em&gt;RequestResponseStage&lt;/em&gt;, &lt;em&gt;ReadStage&lt;/em&gt;, etc; I think what I was seeing is different than &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markusdlugi&quot; class=&quot;user-hover&quot; rel=&quot;markusdlugi&quot;&gt;markusdlugi&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;See the attached screenshot of the dominator tree view in MemoryAnalyzer.&lt;/p&gt;

&lt;p&gt;I can make a dump available, but be warned, it is 12G in size.&lt;/p&gt;</comment>
                            <comment id="16162565" author="markusdlugi" created="Tue, 12 Sep 2017 06:29:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=urandom&quot; class=&quot;user-hover&quot; rel=&quot;urandom&quot;&gt;urandom&lt;/a&gt;, I think it might still be the same issue. The threads you mentioned are all created by the &lt;tt&gt;SEPWorker&lt;/tt&gt; as well, as you can also see in your screenshot where your &lt;tt&gt;FastThreadLocalThread&lt;/tt&gt; has a reference to an instance of that class. Now I&apos;m not sure whether the actual content of your &lt;tt&gt;ThreadLocalMap&lt;/tt&gt; s is the same as in my heap dump - in my case, the maps mostly held instances of &lt;tt&gt;BTree$Builder&lt;/tt&gt; , which then had references to many &lt;tt&gt;byte[]&lt;/tt&gt; arrays. Maybe you can check if this is the case for you as well?&lt;/p&gt;

&lt;p&gt;Other than that, you could also try and see if the patches created by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt; alleviate your issue.&lt;/p&gt;</comment>
                            <comment id="16164860" author="urandom" created="Wed, 13 Sep 2017 15:47:19 +0000"  >
&lt;blockquote&gt;
&lt;p&gt;I think it might still be the same issue. The threads you mentioned are all created by the SEPWorker as well, as you can also see in your screenshot where your FastThreadLocalThread has a reference to an instance of that class. Now I&apos;m not sure whether the actual content of your ThreadLocalMap s is the same as in my heap dump - in my case, the maps mostly held instances of BTree$Builder , which then had references to many byte[] arrays. Maybe you can check if this is the case for you as well?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There are no instances of &lt;tt&gt;BTree&lt;/tt&gt; here, (see new screenshot attached).&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Other than that, you could also try and see if the patches created by Robert Stupp alleviate your issue.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do you mean &lt;a href=&quot;https://github.com/apache/cassandra/commit/bed7fa5ef8492d1ff3852cf299622a5ad4e0b621&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;bed7fa5&lt;/a&gt;?  I haven&apos;t applied that, no, but it doesn&apos;t look like I&apos;m leaking anything &lt;tt&gt;BTree&lt;/tt&gt; so I don&apos;t think that would help.&lt;/p&gt;</comment>
                            <comment id="16164958" author="snazy" created="Wed, 13 Sep 2017 17:05:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=urandom&quot; class=&quot;user-hover&quot; rel=&quot;urandom&quot;&gt;urandom&lt;/a&gt;, it&apos;s not about the &lt;tt&gt;BTree.Builder&lt;/tt&gt; instances, it&apos;s about what&apos;s kept referenced by those - and that is the bunch of &lt;tt&gt;HeapByteBuffer&lt;/tt&gt; instances, as reported by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=markusdlugi&quot; class=&quot;user-hover&quot; rel=&quot;markusdlugi&quot;&gt;markusdlugi&lt;/a&gt; and fixed by the patch for this ticket. The screenshot you attached, matches the fixed issue. Therefore, I recommend to try the patch or a build from the recent 3.11/trunk branches and test again. Going go resolve this issue. If it&apos;s really something else that&apos;s causing the issue, I&apos;d prefer to open another ticket, because there is already something committed for this ticket that addresses a very particular issue.&lt;/p&gt;</comment>
                            <comment id="16187346" author="tsteinmaurer" created="Sun, 1 Oct 2017 11:48:56 +0000"  >&lt;p&gt;We have deployed Cassandra 3.11.1 (snapshot build from September 25, 2017) into our 9-node loadtest cluster. We still see increasing heap utilization over time with ~ 140 Recycler$Stack instances consuming ~1,8 GB heap. See attached screen (Eclipse memory analyzer screen): cassandra_3.11.1_Recycler_memleak.png&lt;/p&gt;</comment>
                            <comment id="16188758" author="tsteinmaurer" created="Mon, 2 Oct 2017 20:27:59 +0000"  >&lt;p&gt;72hrs heap utilization increase with 3.11.1 snapshot build from Sept. 25, 2017 + cluster rolling restart marker =&amp;gt; cassandra_3.11.1_snapshot_heaputilization.png&lt;/p&gt;</comment>
                            <comment id="16188904" author="snazy" created="Mon, 2 Oct 2017 21:44:23 +0000"  >&lt;p&gt;I&apos;ll note that the fixed issue and what you&apos;re describing are probably two different things.&lt;br/&gt;
It might also be that the combination of recycling the btree-builders &lt;em&gt;and&lt;/em&gt; many cells in a partition. This is technically different from what&apos;s been fixed.&lt;br/&gt;
It would help a lot, if someone can come up with steps (ideally some code) to reproduce the issue as mat screenshots show that something happened but not why.&lt;/p&gt;</comment>
                            <comment id="16189382" author="tsteinmaurer" created="Tue, 3 Oct 2017 08:09:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt;: Created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13929&quot; title=&quot;BTree$Builder / io.netty.util.Recycler$Stack leaking memory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13929&quot;&gt;&lt;del&gt;CASSANDRA-13929&lt;/del&gt;&lt;/a&gt; and discussed a potential fix.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12886512" name="Screenshot from 2017-09-11 16-54-43.png" size="227564" author="urandom" created="Mon, 11 Sep 2017 22:14:32 +0000"/>
                            <attachment id="12886890" name="Screenshot from 2017-09-13 10-39-58.png" size="245309" author="urandom" created="Wed, 13 Sep 2017 15:47:52 +0000"/>
                            <attachment id="12889883" name="cassandra_3.11.1_Recycler_memleak.png" size="130982" author="tsteinmaurer" created="Sun, 1 Oct 2017 11:47:59 +0000"/>
                            <attachment id="12890028" name="cassandra_3.11.1_snapshot_heaputilization.png" size="90649" author="tsteinmaurer" created="Mon, 2 Oct 2017 20:26:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ingv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jjordan</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jjordan]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>