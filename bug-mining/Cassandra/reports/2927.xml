<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:46:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7437] Ensure writes have completed after dropping a table, before recycling commit log segments (CASSANDRA-7437)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7437</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;ve noticed on unit test output that there are still assertions being raised here, so I&apos;ve taken a torch to the code path to make damned certain it cannot happen in future &lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;We now wait for all running reads on a column family or writes on the keyspace during a dropCf call&lt;/li&gt;
	&lt;li&gt;We wait for all appends to the prior commit log segments before recycling them&lt;/li&gt;
	&lt;li&gt;We pass the list of dropped Cfs into the CL.forceRecycle call so that they can be markedClean definitely after they have been marked finished&lt;/li&gt;
	&lt;li&gt;Finally, to prevent any possibility of this still happening causing any negative consequences, I&apos;ve suppressed the assertion in favour of an error log message, as the assertion would break correct program flow for the drop and potentially result in undefined behaviour&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;del&gt;(in actuality there is the slightest possibility still of a race condition on read of a secondary index that causes a repair driven write, but this is a really tiny race window, as I force wait for all reads after unlinking the CF, so it would have to be a read that grabbed the CFS reference before it was dropped, but hadn&apos;t quite started its read op yet).&lt;/del&gt; In fact this is also safe, as these modifications all grab a write op from the Keyspace, which has to happen before they get the CFS, and also because we drop the data before waiting for reads to finish on the CFS.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12723205">CASSANDRA-7437</key>
            <summary>Ensure writes have completed after dropping a table, before recycling commit log segments (CASSANDRA-7437)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                            <label>qa-resolved</label>
                    </labels>
                <created>Mon, 23 Jun 2014 20:13:25 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:42 +0000</updated>
                            <resolved>Wed, 27 Aug 2014 15:08:52 +0000</resolved>
                                        <fixVersion>2.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14041235" author="benedict" created="Mon, 23 Jun 2014 20:14:30 +0000"  >&lt;p&gt;Patch &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/7437&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14050579" author="tjake" created="Wed, 2 Jul 2014 19:12:19 +0000"  >&lt;p&gt;The only part I&apos;m not clear on is what happens if this is being actively written to / read from it seems from you patch the drop would stall, when it would be better to prioritize the drop.&lt;/p&gt;</comment>
                            <comment id="14050582" author="benedict" created="Wed, 2 Jul 2014 19:14:20 +0000"  >&lt;p&gt;Except I have no way to prevent those actions from writing data that would hit the CL afterwards, and we need to be certain this does not happen (so that we can recycle all of the segments). The only thing we can safely do is wait for them to finish (unless you have a suggestion &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/p&gt;</comment>
                            <comment id="14050587" author="benedict" created="Wed, 2 Jul 2014 19:19:09 +0000"  >&lt;p&gt;It&apos;s worth noting the drop has basically happened by then; it&apos;s just tidying up&lt;/p&gt;</comment>
                            <comment id="14050590" author="tjake" created="Wed, 2 Jul 2014 19:20:29 +0000"  >&lt;p&gt;We could force Table.open() to fail right?&lt;/p&gt;</comment>
                            <comment id="14050592" author="benedict" created="Wed, 2 Jul 2014 19:23:23 +0000"  >&lt;p&gt;But they shouldn&apos;t find it, as it&apos;s been removed from the set of known CFs - it&apos;s only those &lt;em&gt;already with a reference&lt;/em&gt; we&apos;re waiting for&lt;/p&gt;</comment>
                            <comment id="14050594" author="tjake" created="Wed, 2 Jul 2014 19:25:17 +0000"  >&lt;p&gt;Ah ok then it would eventually complete.  I was thinking if you didn&apos;t stop writing to it it would never drop.  It&apos;s only the things prior to the new barrier.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14050821" author="benedict" created="Wed, 2 Jul 2014 22:43:29 +0000"  >&lt;p&gt;Committed to 2.1.0&lt;/p&gt;</comment>
                            <comment id="14102353" author="philipthompson" created="Tue, 19 Aug 2014 15:58:50 +0000"  >&lt;p&gt;I&apos;m running into the error added by this patch:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[&lt;span class=&quot;code-quote&quot;&gt;&apos;ERROR [MigrationStage:1] 2014-08-19 10:44:41,657 CommitLogSegmentManager.java:317 - Failed to force-recycle all segments; at least one segment is still in use with dirty CFs.\n&apos;&lt;/span&gt;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ve attached a very simple test that mimics how I reproduced the issue as well as the log from the node in question.&lt;/p&gt;</comment>
                            <comment id="14102407" author="benedict" created="Tue, 19 Aug 2014 16:22:19 +0000"  >&lt;p&gt;This is disappointing. I&apos;ll replicate the logic of your test in a long test in the C* codebase, and see if I can pin down what we missed&lt;/p&gt;</comment>
                            <comment id="14105081" author="benedict" created="Thu, 21 Aug 2014 05:55:44 +0000"  >&lt;p&gt;In hindsight, this was pretty obvious.&lt;/p&gt;

&lt;p&gt;We wait for modifications to complete to the commit log segment before force recycling, but we don&apos;t ensure those modifications have hit memtables before flushing them to mark the segment clean.&lt;/p&gt;

&lt;p&gt;Patch attached that gets the keyspaces with records in the segment and waits for any current writes to complete before flushing, and includes a new long test to check this works as advertised&lt;/p&gt;

&lt;p&gt;It may be worth mentioning that we did in fact wait for these modifications already to the dropped table, so the error would not have caused commit logs to keep collecting; the problem is with sstables from &lt;em&gt;other keyspaces&lt;/em&gt; in the commit log (in this case the system keyspace), which would be cleared on the next flush.&lt;/p&gt;</comment>
                            <comment id="14110842" author="tjake" created="Tue, 26 Aug 2014 15:38:28 +0000"  >&lt;p&gt;Overall looks good.&lt;/p&gt;

&lt;p&gt;Nit. Your testcase should create multiple keyspaces/tables since the bug is when commitlog contains more than one.  I understand the test happens be including the system keyspace now but the test should be more explicit.&lt;/p&gt;</comment>
                            <comment id="14112320" author="tjake" created="Wed, 27 Aug 2014 15:08:52 +0000"  >&lt;p&gt;Committed with test change&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12662770" name="7437.log" size="385719" author="philipthompson" created="Tue, 19 Aug 2014 15:58:50 +0000"/>
                            <attachment id="12663347" name="7437.round2.txt" size="4582" author="benedict" created="Thu, 21 Aug 2014 05:59:39 +0000"/>
                            <attachment id="12662769" name="7437_test.py" size="1201" author="philipthompson" created="Tue, 19 Aug 2014 15:58:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>401392</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1x3an:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>401467</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>philipthompson</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>