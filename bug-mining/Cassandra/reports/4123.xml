<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:01:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10721] Altering a UDT might break UDA deserialisation</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10721</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10650&quot; title=&quot;Store UDA initcond as CQL literal in the schema table, instead of a blob&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10650&quot;&gt;&lt;del&gt;CASSANDRA-10650&lt;/del&gt;&lt;/a&gt; switched UDA&apos;s &lt;tt&gt;initcond&lt;/tt&gt; serialisation in schema to its CQL literal. This means that if any particular field is renamed in the UDT, or of its type gets changes, we will not be able to parse initcond back.&lt;/p&gt;

&lt;p&gt;We should either:&lt;br/&gt;
1) Forbid renames and type switches in UDTs that are being used in UDAs, or&lt;br/&gt;
2) Make sure we alter the UDAs in schema alongside the new UDT at all times&lt;/p&gt;</description>
                <environment></environment>
        <key id="12913729">CASSANDRA-10721</key>
            <summary>Altering a UDT might break UDA deserialisation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="snazy">Robert Stupp</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Nov 2015 15:08:06 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:50 +0000</updated>
                            <resolved>Wed, 17 Feb 2016 11:01:26 +0000</resolved>
                                        <fixVersion>3.0.4</fixVersion>
                    <fixVersion>3.4</fixVersion>
                                    <component>Legacy/CQL</component>
                    <component>Legacy/Distributed Metadata</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15008844" author="snazy" created="Tue, 17 Nov 2015 15:31:53 +0000"  >&lt;p&gt;I think preventing such a change is the better option. Otherwise we&apos;d also have check permissions on the aggregates. Additionally changing nested tuple/collection/type structures might become a nightmare.&lt;/p&gt;

&lt;p&gt;Will also see whether we need a check for &quot;garbaged&quot; initcond values into LegacySchemaMigrator.&lt;/p&gt;</comment>
                            <comment id="15008851" author="iamaleksey" created="Tue, 17 Nov 2015 15:38:15 +0000"  >&lt;p&gt;I&apos;m fine with simply preventing it for 3.0.1/3.1, to fix the bug itself, but I&apos;d prefer that we at least eventually address this properly.&lt;/p&gt;</comment>
                            <comment id="15009156" author="snazy" created="Tue, 17 Nov 2015 18:10:43 +0000"  >&lt;p&gt;Linked branch prevents ALTER TYPE RENAME and ALTER TYPE ALTER on UDTs which are used in INITCOND values.&lt;/p&gt;

&lt;p&gt;It&apos;s not an issue for 2.2, so a change to LSM is not required.&lt;/p&gt;

&lt;p&gt;(&lt;a href=&quot;http://cassci.datastax.com/search/?q=snazy-10721-&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Cassci&apos;s working&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Follow-up to rewrite INITCOND values is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10723&quot; title=&quot;Rewrite INITCOND after renames and alters of UDT fields&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10723&quot;&gt;&lt;del&gt;CASSANDRA-10723&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15035850" author="blerer" created="Wed, 2 Dec 2015 14:15:18 +0000"  >&lt;p&gt;It seems that the branch contains a left over from some additional work (the second commit).&lt;/p&gt;

&lt;p&gt;For the first commit:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I think that we should probably refactor the &lt;tt&gt;userTypeUsedBy&lt;/tt&gt; method. All those &lt;tt&gt;instanceof&lt;/tt&gt; are a clear sign that we should be using polymorphism (e.g. adding a &lt;tt&gt;useUserType(keyspaceName, typeName)&lt;/tt&gt; to &lt;tt&gt;AbstractType&lt;/tt&gt;).&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;checkTypeNotUsedByAggregate&lt;/tt&gt; could be simplified by using &lt;tt&gt;ksm.functions.udas.anyMatch(&amp;lt;the predicate&amp;gt;)&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;In the unit test, I think that the name &lt;tt&gt;alterDropSequence&lt;/tt&gt; is a bit confusing. It should probably be changed to something that express better the fact that the method is checking that we cannot alter or drop the user type.&lt;/li&gt;
&lt;/ul&gt;



</comment>
                            <comment id="15036184" author="snazy" created="Wed, 2 Dec 2015 17:23:12 +0000"  >&lt;p&gt;userTypeUsedBy: right - it&apos;s now completely superfluous (and therefore removed). I&apos;ve copied the functionality of &lt;tt&gt;referencesUserType&lt;/tt&gt; from &lt;tt&gt;CQL3Type.Raw&lt;/tt&gt; to &lt;tt&gt;CQL3Type&lt;/tt&gt; and also removed the &lt;tt&gt;AbstractType.references()&lt;/tt&gt; method.&lt;/p&gt;

&lt;p&gt;Rebased and pushed a commit for the review changes to the branch and triggered CI for 3.0+trunk versions.&lt;/p&gt;</comment>
                            <comment id="15038525" author="blerer" created="Thu, 3 Dec 2015 20:16:14 +0000"  >&lt;ul&gt;
	&lt;li&gt;The &lt;tt&gt;referencesUserType(String name)&lt;/tt&gt; does not check the keyspace for the UDT. I think it could lead to some problems if we had a UDT with the same name in a different keyspace. It might be good to add a unit test for it.&lt;/li&gt;
	&lt;li&gt;It seems to me that if the &lt;tt&gt;referencesUserType&lt;/tt&gt; method was in &lt;tt&gt;AbstractType&lt;/tt&gt;  (something like: &lt;tt&gt;referencesUserType(String keyspace, ByteBuffer name)&lt;/tt&gt;), it would removes all these &lt;tt&gt;asCQL3Type()&lt;/tt&gt; calls and make the code more readable. What do you think?&lt;/li&gt;
	&lt;li&gt;The &lt;tt&gt;isBroken&lt;/tt&gt; and the follow-up notes should be removed. They are not needed by the patch.&lt;/li&gt;
	&lt;li&gt;It might be good to add some extra unit tests to check UDT nested in (Sets, Maps or Tulpes) for extra security.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="15046397" author="snazy" created="Tue, 8 Dec 2015 05:39:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;referencesUserType(String name) does not check the keyspace for the UDT.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;AFAIK we don&apos;t allow cross-keyspace references at all - so it felt ok to basically copy what&apos;s in &lt;tt&gt;CQL3Type.Raw.referencesUserType&lt;/tt&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;referencesUserType ... was in AbstractType&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s correct. Moved that to CQL3Type as I thought it&apos;s better to not add new stuff to old API classes. And since the code&apos;s not used in a critical path, that change looked maybe not optimal but reasonable. But I won&apos;t fight against moving it back to AbstractType. However we could thing of keeping a reference to the CQL3Type in AbstractType to optimize that if it is used in a critical code path.&lt;/p&gt;

&lt;p&gt;Will fix the other issues (two points for more utests + removal of isBroken) you mentioned.&lt;/p&gt;</comment>
                            <comment id="15070830" author="snazy" created="Thu, 24 Dec 2015 09:53:32 +0000"  >&lt;p&gt;Removed the &lt;tt&gt;isBroken&lt;/tt&gt; and added more tests.&lt;/p&gt;

&lt;p&gt;Left the &lt;tt&gt;referencesUserType&lt;/tt&gt; in &lt;tt&gt;CQL3Type&lt;/tt&gt; - but leave this for discussion. It feels to fit better in CQL3Type - but has perf benefits in AbstractType.&lt;/p&gt;</comment>
                            <comment id="15110892" author="blerer" created="Thu, 21 Jan 2016 16:51:07 +0000"  >&lt;p&gt;The changes look good.&lt;/p&gt;

&lt;p&gt;For the &lt;tt&gt;referencesUserType&lt;/tt&gt;, I am even more convinced than before that it should go into into &lt;tt&gt;AbstractType&lt;/tt&gt;. Those &lt;tt&gt;asCQL3Type()&lt;/tt&gt; calls everywere are a clear sign to me that it will be a better place. At the same time, I do not want to discuss it for too long. I let you choose.&lt;/p&gt;</comment>
                            <comment id="15130397" author="snazy" created="Wed, 3 Feb 2016 13:41:14 +0000"  >&lt;p&gt;Moved the &lt;tt&gt;referencesUserType&lt;/tt&gt; function to &lt;tt&gt;AbstractType&lt;/tt&gt;. This is now effectively a refactoring of the (replaced) &lt;tt&gt;references&lt;/tt&gt;&#160;function to specifically check the user-type&apos;s name. Kicked off the CI tests for 3.0 and trunk (nothing special in 3.3 and trunk however - just a merge w/o conflicts).&lt;br/&gt;
Can you take a look at the latest changes (&lt;a href=&quot;https://github.com/apache/cassandra/compare/20813858297b375e1e3f7f4b09dcba2756f9c58f...snazy:10721-udt-alter-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;complete 3.0 diff is here&lt;/a&gt;)?&lt;/p&gt;</comment>
                            <comment id="15138917" author="blerer" created="Tue, 9 Feb 2016 13:13:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;Moved the referencesUserType function to AbstractType. This is now effectively a refactoring of the (replaced) references function to specifically check the user-type&apos;s name.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I do not see the changes that you mentioned. In your &lt;tt&gt;10721-udt-alter-3.0&lt;/tt&gt; branch. Did I miss something?&lt;/p&gt;</comment>
                            <comment id="15148979" author="snazy" created="Tue, 16 Feb 2016 17:46:24 +0000"  >&lt;p&gt;Oh - heh - seems, that I coded the stuff on one machine but pushed to github from another. No, you didn&apos;t miss something.&lt;/p&gt;</comment>
                            <comment id="15150294" author="blerer" created="Wed, 17 Feb 2016 10:58:38 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15150295" author="blerer" created="Wed, 17 Feb 2016 10:59:30 +0000"  >&lt;p&gt;Latest version of the patch for reference.&lt;/p&gt;</comment>
                            <comment id="15150300" author="blerer" created="Wed, 17 Feb 2016 11:01:26 +0000"  >&lt;p&gt;Committed in 3.0 at 7a3c3abe1d1a191f06f99f989c940a5f8ce52f5f and merged into trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12913807">CASSANDRA-10723</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12910343">CASSANDRA-10650</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12788226" name="10721-3.0.txt" size="25040" author="blerer" created="Wed, 17 Feb 2016 10:59:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2oihr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>