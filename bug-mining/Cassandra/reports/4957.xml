<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:10:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14139] Acquire read lock before accessing CompactionStrategyManager fields</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14139</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There are a few methods in &lt;tt&gt;CompactionStrategyManager&lt;/tt&gt; accessing the repaired/unrepaired compaction strategy lists without using the read lock, what could cause issues like the one below:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [CompactionExecutor:1] 2017-12-22 12:17:12,320 CassandraDaemon.java:141 - Exception in thread Thread[CompactionExecutor:1,5,main]
java.lang.IndexOutOfBoundsException: Index: 0, Size: 1
    at java.util.ArrayList.rangeCheck(ArrayList.java:657)
    at java.util.ArrayList.get(ArrayList.java:433)
    at org.apache.cassandra.db.compaction.CompactionStrategyManager.supportsEarlyOpen(CompactionStrategyManager.java:1262)
    at org.apache.cassandra.db.ColumnFamilyStore.supportsEarlyOpen(ColumnFamilyStore.java:558)
    at org.apache.cassandra.io.sstable.SSTableRewriter.construct(SSTableRewriter.java:119)
    at org.apache.cassandra.db.compaction.writers.CompactionAwareWriter.&amp;lt;init&amp;gt;(CompactionAwareWriter.java:91)
    at org.apache.cassandra.db.compaction.writers.DefaultCompactionWriter.&amp;lt;init&amp;gt;(DefaultCompactionWriter.java:57)
    at org.apache.cassandra.db.compaction.CompactionTask.getCompactionAwareWriter(CompactionTask.java:293)
    at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:200)
    at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
    at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:90)
    at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:101)
    at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionCandidate.run(CompactionManager.java:310)
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
    at java.util.concurrent.FutureTask.run(FutureTask.java:266)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
    at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:81)
    at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13127391">CASSANDRA-14139</key>
            <summary>Acquire read lock before accessing CompactionStrategyManager fields</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pauloricardomg">Paulo Motta</assignee>
                                    <reporter username="pauloricardomg">Paulo Motta</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Dec 2017 17:46:36 +0000</created>
                <updated>Fri, 15 May 2020 08:03:04 +0000</updated>
                            <resolved>Wed, 10 Jan 2018 20:44:08 +0000</resolved>
                                        <fixVersion>3.11.2</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16306442" author="pauloricardomg" created="Fri, 29 Dec 2017 18:26:09 +0000"  >&lt;p&gt;It seems we missed grabbing the read lock for some operations on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13948&quot; title=&quot;Reload compaction strategies when JBOD disk boundary changes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13948&quot;&gt;&lt;del&gt;CASSANDRA-13948&lt;/del&gt;&lt;/a&gt;, what can cause IndexOutOfBounds/NullPointers such the ones above during compaction strategy reload, so this patch basically gets the lock on the few methods were not doing it.&lt;/p&gt;

&lt;p&gt;CI looks good. Trunk patch is slightly different because there are some additional methods due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9143&quot; title=&quot;Fix consistency of incrementally repaired data across replicas&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9143&quot;&gt;&lt;del&gt;CASSANDRA-9143&lt;/del&gt;&lt;/a&gt;. Can you take a look &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;? Thanks!&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...pauloricardomg:3.11-14139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-14139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12904036/3.11-14139-testall.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12904038/trunk-14139-testall.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12904035/3.11-14139-dtest.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12904037/trunk-14139-dtest.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16314785" author="krummas" created="Sat, 6 Jan 2018 17:58:46 +0000"  >&lt;ul&gt;
	&lt;li&gt;for the &lt;tt&gt;supportsEarlyOpen&lt;/tt&gt; method we can instead store the boolean in &lt;tt&gt;startup&lt;/tt&gt; like we do with &lt;tt&gt;fanout&lt;/tt&gt; and &lt;tt&gt;shouldDefragment&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;in trunk, for &lt;tt&gt;getRepaired&lt;/tt&gt;, &lt;tt&gt;getUnrepaired&lt;/tt&gt; and &lt;tt&gt;getPendingRepairManagers&lt;/tt&gt; we don&apos;t need the readlock - we return the list directly (and when refreshing we clear the same list) - to make this safe we would need to copy the list and return the copy, but those methods are only used in tests so I doubt we need it (maybe add a comment though)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16320204" author="pauloricardomg" created="Wed, 10 Jan 2018 13:16:34 +0000"  >&lt;p&gt;Thanks for the review! See follow-up below:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;for the supportsEarlyOpen method we can instead store the boolean in startup like we do with fanout and shouldDefragment&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;good catch, fixed!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;in trunk, for getRepaired, getUnrepaired and getPendingRepairManagers we don&apos;t need the readlock - we return the list directly (and when refreshing we clear the same list) - to make this safe we would need to copy the list and return the copy, but those methods are only used in tests so I doubt we need it (maybe add a comment though)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;even though this is only used in test, for consistency I opted for copying the list and returning a copying, so it is safe in case anybody uses it outside testing.&lt;/p&gt;

&lt;p&gt;Updated patch with fixes above, CI looks good. Please let me know what do you think.&lt;/p&gt;</comment>
                            <comment id="16320246" author="krummas" created="Wed, 10 Jan 2018 13:38:23 +0000"  >&lt;p&gt;lgtm, +1&lt;/p&gt;</comment>
                            <comment id="16321069" author="pauloricardomg" created="Wed, 10 Jan 2018 20:44:08 +0000"  >&lt;p&gt;Committed as &lt;tt&gt;fe0ee85c71faada0acb48a65f249575c65bf0972&lt;/tt&gt; to cassandra-3.11 and merged up to master. Thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13128963">CASSANDRA-14150</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12904035" name="3.11-14139-dtest.png" size="59553" author="pauloricardomg" created="Fri, 29 Dec 2017 18:20:26 +0000"/>
                            <attachment id="12904036" name="3.11-14139-testall.png" size="9624" author="pauloricardomg" created="Fri, 29 Dec 2017 18:20:25 +0000"/>
                            <attachment id="12904037" name="trunk-14139-dtest.png" size="70072" author="pauloricardomg" created="Fri, 29 Dec 2017 18:20:26 +0000"/>
                            <attachment id="12904038" name="trunk-14139-testall.png" size="22973" author="pauloricardomg" created="Fri, 29 Dec 2017 18:20:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 44 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3objr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>