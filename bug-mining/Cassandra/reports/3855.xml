<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:58:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10413] Replaying materialized view updates from commitlog after node decommission crashes Cassandra</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10413</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This issue is reproducible through a Jepsen test, runnable as&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;lein with-profile +trunk test :only cassandra.mv-test/mv-crash-subset-decommission
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This test crashes/restarts nodes while decommissioning nodes. These actions are not coordinated.&lt;/p&gt;

&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10164&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;10164&lt;/a&gt;, we introduced a change to re-apply materialized view updates on commitlog replay.&lt;/p&gt;

&lt;p&gt;Some nodes, upon restart, will crash in commitlog replay. They throw the &quot;Trying to get the view natural endpoint on a non-data replica&quot; runtime exception in getViewNaturalEndpoint. I added logging to getViewNaturalEndpoint to show the results of replicationStrategy.getNaturalEndpoints for the baseToken and viewToken.&lt;/p&gt;

&lt;p&gt;It can be seen that these problems occur when the baseEndpoints and viewEndpoints are identical but do not contain the broadcast address of the local node.&lt;/p&gt;

&lt;p&gt;For example, a node at 10.0.0.5 crashes on replay of a write whose base token and view token replicas are both &lt;span class=&quot;error&quot;&gt;&amp;#91;10.0.0.2, 10.0.0.4, 10.0.0.6&amp;#93;&lt;/span&gt;. It seems we try to guard against this by considering pendingEndpoints for the viewToken, but this does not appear to be sufficient.&lt;/p&gt;

&lt;p&gt;I&apos;ve attached the system.logs for a test run with added logging. In the attached logs, n1 is at 10.0.0.2, n2 is at 10.0.0.3, and so on. 10.0.0.6/n5 is the decommissioned node.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12901382">CASSANDRA-10413</key>
            <summary>Replaying materialized view updates from commitlog after node decommission crashes Cassandra</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jkni">Joel Knighton</assignee>
                                    <reporter username="jkni">Joel Knighton</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Sep 2015 18:08:22 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:55 +0000</updated>
                            <resolved>Wed, 7 Oct 2015 19:48:43 +0000</resolved>
                                        <fixVersion>3.0.0 rc2</fixVersion>
                                    <component>Feature/Materialized Views</component>
                    <component>Legacy/Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14935568" author="tjake" created="Tue, 29 Sep 2015 18:17:48 +0000"  >&lt;p&gt;This looks similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10262&quot; title=&quot;Bootstrapping nodes failing to apply view updates correctly.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10262&quot;&gt;&lt;del&gt;CASSANDRA-10262&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14935687" author="jkni" created="Tue, 29 Sep 2015 19:22:16 +0000"  >&lt;p&gt;Rerunning these tests while logging pending endpoints for the base and view tokens, it appears that there are no pending endpoints for these tokens at the time of the crash.&lt;/p&gt;

&lt;p&gt;It&apos;s worth noting that some nodes sometimes hit errors like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [SharedPool-Worker-3] 2015-09-29 19:05:10,263 FailureDetector.java:216 - unknown endpoint /10.0.0.3 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;on commitlog replay, when 10.0.0.3 should be a healthy member of the cluster. It is likely a separate issue but indicates the gossip state of the cluster might not be well.&lt;/p&gt;</comment>
                            <comment id="14935766" author="tjake" created="Tue, 29 Sep 2015 20:04:25 +0000"  >&lt;p&gt;It might be simpler to check the gossip state in mutateMV call and when not JOINED we always just post to the batchlog.&lt;/p&gt;</comment>
                            <comment id="14936372" author="jkni" created="Wed, 30 Sep 2015 05:00:33 +0000"  >&lt;p&gt;It looks like two possible situations were causing this.&lt;/p&gt;

&lt;p&gt;1. A node receives the decommission and excises the other node from its table. On restart after hard crash, it loads the tokens from the system keyspace, which still contains the excised node. Since there are MV updates replayed in the commitlog before the records excising the node, the error occurs.&lt;/p&gt;

&lt;p&gt;2. A node crashes during the decommission of the other node. When it comes back up, it will not have excised the decommissioned node.&lt;/p&gt;

&lt;p&gt;To address situation 1, the simplest fix is to force a blocking flush in removeEndpoint.&lt;/p&gt;

&lt;p&gt;2 is less clear. I took Jake&apos;s suggestion to check the gossip state in mutateMV and when not JOINED always post to the batchlog. I&apos;m not yet sure that selecting the local address as the view replica is always appropriate in this situation.&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed a branch with these changes at &lt;a href=&quot;https://github.com/jkni/cassandra/tree/10413&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;10413&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;With these changes, there are no longer crashes on commitlog replay. I&apos;m still running tests.&lt;/p&gt;</comment>
                            <comment id="14936847" author="tjake" created="Wed, 30 Sep 2015 13:47:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not yet sure that selecting the local address as the view replica is always appropriate in this situation&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree, it seems like if the node is not joined we have no clue if the gossip state is stale or not. In which case we should always apply the batchlog.&lt;/p&gt;

&lt;p&gt;So rather than do this check in getViewNaturalEndpoint() add the gossip state check directly in mutateMV and force it through the batchlog only.  We don&apos;t even need to do the async updates since they will fail also.&lt;/p&gt;</comment>
                            <comment id="14947250" author="jkni" created="Wed, 7 Oct 2015 17:35:59 +0000"  >&lt;p&gt;cqlsh_tests.cqlsh_tests.TestCqlsh.test_pep8_compliance&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/22099addaf6029656f8927ffb894c86c73bfaceb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/22099addaf6029656f8927ffb894c86c73bfaceb&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed a branch at &lt;a href=&quot;https://github.com/jkni/cassandra/tree/t10413&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;t10413&lt;/a&gt; that follows Jake suggestions. Until a node has scheduled gossip, it will force a write through the batchlog directly in MV.&lt;/p&gt;

&lt;p&gt;A dtest run is available &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-t10413-dtest/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. I&apos;ve checked against cassandra-3.0 dtest runs and there are no new failures; the PEP8 compliance is fixed since the last rebase.&lt;/p&gt;

&lt;p&gt;A testall run is available &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/jkni/job/jkni-t10413-testall/3/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.  There are two unit test failures that I can&apos;t find on cassandra-3.0 jobs: org.apache.cassandra.cql3.validation.entitites.TypeTest.testNowToUUIDCompatibility and org.apache.cassandra.cql3.validation.operations.SelectTest.testSingleClustering. They both fail with a fairly cryptic &quot;Forked Java VM exited abnormally&quot; that suggests something environmental. Both tests looped locally do not show failures.&lt;/p&gt;

&lt;p&gt;Ready for a look whenever &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14947305" author="tjake" created="Wed, 7 Oct 2015 18:16:05 +0000"  >&lt;p&gt;Code looks good.  I&apos;m assuming this fixes your jepsen test failure as well?&lt;/p&gt;
</comment>
                            <comment id="14947331" author="jkni" created="Wed, 7 Oct 2015 18:30:01 +0000"  >&lt;p&gt;Yes, this fixes the original Jepsen test failure as well.&lt;/p&gt;</comment>
                            <comment id="14947465" author="tjake" created="Wed, 7 Oct 2015 19:48:43 +0000"  >&lt;p&gt;Committed thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12764285" name="n1.log" size="1206870" author="jkni" created="Tue, 29 Sep 2015 18:11:22 +0000"/>
                            <attachment id="12764286" name="n2.log" size="679445" author="jkni" created="Tue, 29 Sep 2015 18:11:22 +0000"/>
                            <attachment id="12764287" name="n3.log" size="685591" author="jkni" created="Tue, 29 Sep 2015 18:11:22 +0000"/>
                            <attachment id="12764288" name="n4.log" size="818096" author="jkni" created="Tue, 29 Sep 2015 18:11:22 +0000"/>
                            <attachment id="12764289" name="n5.log" size="274898" author="jkni" created="Tue, 29 Sep 2015 18:11:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jkni]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mf2n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332955">3.0.0 rc1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>