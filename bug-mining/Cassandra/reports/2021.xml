<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:37:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5151] Implement better way of eliminating compaction left overs.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5151</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This is from discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5137&quot; title=&quot;Make sure SSTables left over from compaction get deleted and logged&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5137&quot;&gt;&lt;del&gt;CASSANDRA-5137&lt;/del&gt;&lt;/a&gt;. Currently we skip loading SSTables that are left over from incomplete compaction to not over-count counter, but the way we track compaction completion is not secure.&lt;/p&gt;

&lt;p&gt;One possible solution is to create system CF like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;create table compaction_log (
  id uuid primary key,
  inputs set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;,
  outputs set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;
);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;to track incomplete compaction.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12627235">CASSANDRA-5151</key>
            <summary>Implement better way of eliminating compaction left overs.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="yukim">Yuki Morishita</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Jan 2013 19:17:14 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:19 +0000</updated>
                            <resolved>Mon, 1 Jul 2013 20:29:22 +0000</resolved>
                                        <fixVersion>2.0 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13556392" author="yukim" created="Thu, 17 Jan 2013 17:31:21 +0000"  >&lt;p&gt;We want to remove left-overs before opening CFs by reading compaction log system CF. The problem is, commit log has to be recovered before reading from any CF, but CF initialization should be completed before commit log recovery. So there is no chance to scrub off left-overs before CF init. Obviously we don&apos;t want to flush every time we update compaction log.&lt;/p&gt;

&lt;p&gt;Alternative way is to write compaction log file with inputs each time we start compaction, and remove it when complete.&lt;br/&gt;
If CF sees that compaction log files in its data directory, that means there are unfinished compactions and those sstable files with ancestors that are in compaction log files should be deleted. Does this sound likely to work?&lt;/p&gt;</comment>
                            <comment id="13556603" author="yukim" created="Thu, 17 Jan 2013 21:16:48 +0000"  >&lt;p&gt;Initial patch attached to get feedback. It writes compaction log file to track incomplete compactions described in my previous comment.&lt;/p&gt;

&lt;p&gt;SSTable left-overs are deleted during node start up with CFS.scrubDataDirectories. In order to get ancestors of SSTable files, it has to deserialize each Stats.db file so slows down node startup, but this only happens when incomplete compaction left compaction log file.&lt;/p&gt;

&lt;p&gt;The patch does not rely on CQL3 collection at all, so it is possible to port into 1.1.x.&lt;/p&gt;</comment>
                            <comment id="13556808" author="jbellis" created="Fri, 18 Jan 2013 00:38:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;commit log has to be recovered before reading from any CF&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That can&apos;t be true, can it?  At the least we have to special case schema.&lt;/p&gt;</comment>
                            <comment id="13556879" author="yukim" created="Fri, 18 Jan 2013 01:52:15 +0000"  >&lt;p&gt;It is. Except schema_* are flushed at the end of migration, other system cf used before commit log recovery like local also flushes every time after its data updated. If we go using system cf for this, we need to do the same, and doing so requires 2 flushes during one compaction, one for inserting log and one for removing at the end.&lt;/p&gt;

&lt;p&gt;I think plain file under cf data dir is easy to implement both for writing log and recovery.&lt;/p&gt;</comment>
                            <comment id="13556908" author="jbellis" created="Fri, 18 Jan 2013 02:27:25 +0000"  >&lt;p&gt;Flushing is roughly the same cost as the fsync you need to make sure the plain file is safely written, so I don&apos;t see a performance penalty.  And I&apos;m nervous about more one-off files (manifest was bad enough).  Storing in the system table does seem cleaner to me.  Am I missing something still?&lt;/p&gt;</comment>
                            <comment id="13557385" author="yukim" created="Fri, 18 Jan 2013 17:43:24 +0000"  >&lt;p&gt;If we use CQL, we cannot clean up left-overs in system keyspace before opening it since columnfamilies under system keyspace is open at the time we issue CQL.&lt;/p&gt;</comment>
                            <comment id="13557395" author="jbellis" created="Fri, 18 Jan 2013 17:48:33 +0000"  >&lt;p&gt;You&apos;re saying there&apos;s a problem with storing data about compacting system tables, in a system table?&lt;/p&gt;

&lt;p&gt;I think you&apos;re right, but can you spell it out with an example?&lt;/p&gt;</comment>
                            <comment id="13557415" author="yukim" created="Fri, 18 Jan 2013 18:09:45 +0000"  >&lt;p&gt;Yes.&lt;/p&gt;

&lt;p&gt;Storing compaction log in system keyspace can be done without problem.&lt;br/&gt;
But when the node starts up and tries to eliminate left overs based on query result from compaction log, there is a problem.&lt;/p&gt;

&lt;p&gt;For example, the node goes down leaving system.schema_keyspaces&apos; compaction unfinished and both original sstable(A) and produced sstable(A&apos;) remained in data dir. What we want when node restarts is that schema_keyspaces only references A and discards A&apos;.&lt;br/&gt;
So we query compaction log from system ks to determine which sstables are left overs. But when we query system ks, cassandra opens whole columnfamilies under system ks, and schema_keyspaces already references both A and A&apos; at this time. So even though we get the query result, we cannot do anything further.&lt;/p&gt;</comment>
                            <comment id="13557429" author="slebresne" created="Fri, 18 Jan 2013 18:20:22 +0000"  >&lt;p&gt;That&apos;s true, but we don&apos;t store counters in the system tables (and I take on myself to veto whomever suggests to change that fact), so it&apos;s safe to always pick all sstables without consulting the compaction log. In other words I suggest special casing the system keyspace on startup so it don&apos;t bother with the compaction log. As far as I&apos;m prefer, I prefer that many times to relying on an external file.&lt;/p&gt;</comment>
                            <comment id="13557605" author="yukim" created="Fri, 18 Jan 2013 21:10:17 +0000"  >&lt;p&gt;Alright, CQL3 based v2 patch attached.&lt;/p&gt;

&lt;p&gt;Below is newly introduced compaction_log schema:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE compaction_log (
  id uuid PRIMARY KEY,
  keyspace_name text,
  columnfamily_name text,
  inputs set&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;
) WITH COMMENT=&lt;span class=&quot;code-quote&quot;&gt;&apos;unfinished compactions&apos;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;data in compaction_log gets created at the beginning of compaction and removed when finished. It only tracks compaction inputs and the node uses them combined with each sstable&apos;s ancestors to remove leftovers.&lt;/p&gt;

&lt;p&gt;compaction_log does not store logs from system columnfamilies(should we skip auth and trace also?).&lt;/p&gt;</comment>
                            <comment id="13568073" author="jbellis" created="Thu, 31 Jan 2013 20:30:29 +0000"  >&lt;p&gt;Posted a patch to &lt;a href=&quot;https://github.com/jbellis/cassandra/branches/5151&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jbellis/cassandra/branches/5151&lt;/a&gt; that adds removal of obsolete sstables for completed compactions, as well as some cosmetic changes.&lt;/p&gt;</comment>
                            <comment id="13568139" author="yukim" created="Thu, 31 Jan 2013 21:41:29 +0000"  >&lt;p&gt;patch lgtm, +1.&lt;/p&gt;</comment>
                            <comment id="13568478" author="jbellis" created="Fri, 1 Feb 2013 04:51:51 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13572020" author="iamaleksey" created="Wed, 6 Feb 2013 01:15:30 +0000"  >&lt;p&gt;After this commit (aa90c88be14b337714739cd857c12cad2a9fedeb) two tests started failing from time to time (not 100% consistently, bit noticeably often):&lt;/p&gt;

&lt;p&gt;1. ColumnFamilyStoreTest&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] Testsuite: org.apache.cassandra.db.ColumnFamilyStoreTest
    [junit] Tests run: 28, Failures: 0, Errors: 0, Time elapsed: 5.919 sec
    [junit] 
    [junit] ------------- Standard Error -----------------
    [junit]  WARN 04:11:00,492 setting live ratio to maximum of 64.0 instead of 102.56071964017991
    [junit]  WARN 04:11:00,610 setting live ratio to maximum of 64.0 instead of 303.2307692307692
    [junit] ERROR 04:11:01,182 Fatal exception in thread Thread[CompactionExecutor:2,1,main]
    [junit] java.lang.AssertionError: Incoherent new size -3 replacing [SSTableReader(path=&apos;build/test/cassandra/data/Keyspace1/Standard1/Keyspace1-Standard1-ib-4-Data.db&apos;), SSTableReader(path=&apos;build/test/cassandra/data/Keyspace1/Standard1/Keyspace1-Standard1-ib-3-Data.db&apos;), SSTableReader(path=&apos;build/test/cassandra/data/Keyspace1/Standard1/Keyspace1-Standard1-ib-6-Data.db&apos;), SSTableReader(path=&apos;build/test/cassandra/data/Keyspace1/Standard1/Keyspace1-Standard1-ib-5-Data.db&apos;)] by [SSTableReader(path=&apos;build/test/cassandra/data/Keyspace1/Standard1/Keyspace1-Standard1-ib-7-Data.db&apos;)] in View(pending_count=1, sstables=[], compacting=[])
    [junit] 	at org.apache.cassandra.db.DataTracker$View.newSSTables(DataTracker.java:545)
    [junit] 	at org.apache.cassandra.db.DataTracker$View.replace(DataTracker.java:517)
    [junit] 	at org.apache.cassandra.db.DataTracker.replace(DataTracker.java:320)
    [junit] 	at org.apache.cassandra.db.DataTracker.replaceCompactedSSTables(DataTracker.java:227)
    [junit] 	at org.apache.cassandra.db.ColumnFamilyStore.replaceCompactedSSTables(ColumnFamilyStore.java:1030)
    [junit] 	at org.apache.cassandra.db.compaction.CompactionTask.runWith(CompactionTask.java:251)
    [junit] 	at org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48)
    [junit] 	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
    [junit] 	at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:72)
    [junit] 	at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:193)
    [junit] 	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:439)
    [junit] 	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
    [junit] 	at java.util.concurrent.FutureTask.run(FutureTask.java:138)
    [junit] 	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
    [junit] 	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
    [junit] 	at java.lang.Thread.run(Thread.java:680)
    [junit] ------------- ---------------- ---------------
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2. CompactionsTest&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   [junit] Testsuite: org.apache.cassandra.db.compaction.CompactionsTest
    [junit] Tests run: 9, Failures: 1, Errors: 0, Time elapsed: 20.298 sec
    [junit] 
    [junit] ------------- Standard Error -----------------
    [junit]  WARN 04:14:16,985 setting live ratio to maximum of 64.0 instead of 360.7111111111111
    [junit]  WARN 04:14:17,121 setting live ratio to maximum of 64.0 instead of 365.15555555555557
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: testCompactionLog(org.apache.cassandra.db.compaction.CompactionsTest):	FAILED
    [junit] null
    [junit] junit.framework.AssertionFailedError
    [junit] 	at org.apache.cassandra.db.compaction.CompactionsTest.testCompactionLog(CompactionsTest.java:311)
    [junit] 
    [junit] 
    [junit] Test org.apache.cassandra.db.compaction.CompactionsTest FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13572144" author="yukim" created="Wed, 6 Feb 2013 04:33:29 +0000"  >&lt;p&gt;I need more time for #1, but for #2, I committed fix in f3091835e67ebdc0171991b2ca283e6cd357cda3.&lt;/p&gt;</comment>
                            <comment id="13575041" author="mkjellman" created="Sat, 9 Feb 2013 02:06:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; looks like there might still be an unexpected condition here&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.IllegalStateException: Unfinished compactions reference missing sstables. This should never happen since compactions are marked finished before we start removing the old sstables.
        at org.apache.cassandra.db.ColumnFamilyStore.removeUnfinishedCompactionLeftovers(ColumnFamilyStore.java:444)
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:213)
        at org.apache.cassandra.service.CassandraDaemon.init(CassandraDaemon.java:324)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:601)
        at org.apache.commons.daemon.support.DaemonLoader.load(DaemonLoader.java:188)
Cannot load daemon
Service exit with a &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; value of 3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13575055" author="mkjellman" created="Sat, 9 Feb 2013 02:47:13 +0000"  >&lt;p&gt;wondering if this is related...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; INFO 18:43:25,360 Completed flushing /data/cassandra/system/compactions_in_progress/system-compactions_in_progress-ib-60-Data.db (192 bytes) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commitlog position ReplayPosition(segmentId=1360374628064, position=29215408)
 INFO 18:43:25,364 Compacting [SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/evidence/fingerprints/evidence-fingerprints-ib-2182-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/evidence/fingerprints/evidence-fingerprints-ib-2180-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/evidence/fingerprints/evidence-fingerprints-ib-2185-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/data/cassandra/evidence/fingerprints/evidence-fingerprints-ib-2181-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/data/cassandra/evidence/fingerprints/evidence-fingerprints-ib-2184-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/evidence/fingerprints/evidence-fingerprints-ib-2183-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/evidence/fingerprints/evidence-fingerprints-ib-2179-Data.db&apos;&lt;/span&gt;)]
ERROR 18:43:25,367 Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:85,1,main]
java.lang.RuntimeException: java.io.FileNotFoundException: /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/evidence/fingerprints/evidence-fingerprints-ib-2183-Data.db (No such file or directory)
        at org.apache.cassandra.io.compress.CompressedRandomAccessReader.open(CompressedRandomAccessReader.java:61)
        at org.apache.cassandra.io.sstable.SSTableReader.openDataReader(SSTableReader.java:1121)
        at org.apache.cassandra.io.sstable.SSTableScanner.&amp;lt;init&amp;gt;(SSTableScanner.java:51)
        at org.apache.cassandra.io.sstable.SSTableReader.getDirectScanner(SSTableReader.java:954)
        at org.apache.cassandra.io.sstable.SSTableReader.getDirectScanner(SSTableReader.java:966)
        at org.apache.cassandra.db.compaction.AbstractCompactionStrategy.getScanners(AbstractCompactionStrategy.java:147)
        at org.apache.cassandra.db.compaction.AbstractCompactionStrategy.getScanners(AbstractCompactionStrategy.java:153)
        at org.apache.cassandra.db.compaction.CompactionTask.runWith(CompactionTask.java:124)
        at org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:63)
        at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:193)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
        at java.util.concurrent.FutureTask.run(FutureTask.java:166)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:722)
Caused by: java.io.FileNotFoundException: /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/evidence/fingerprints/evidence-fingerprints-ib-2183-Data.db (No such file or directory)
        at java.io.RandomAccessFile.open(Native Method)
        at java.io.RandomAccessFile.&amp;lt;init&amp;gt;(RandomAccessFile.java:233)
        at org.apache.cassandra.io.util.RandomAccessReader.&amp;lt;init&amp;gt;(RandomAccessReader.java:67)
        at org.apache.cassandra.io.compress.CompressedRandomAccessReader.&amp;lt;init&amp;gt;(CompressedRandomAccessReader.java:78)
        at org.apache.cassandra.io.compress.CompressedRandomAccessReader.open(CompressedRandomAccessReader.java:57)
        ... 17 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13575922" author="yukim" created="Mon, 11 Feb 2013 17:33:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkjellman&quot; class=&quot;user-hover&quot; rel=&quot;mkjellman&quot;&gt;mkjellman&lt;/a&gt; What else do you see about the file &quot;evidence-fingerprints-ib-2183-Data.db&quot; in your log file? Can you see the file is compacted elsewhere?&lt;/p&gt;</comment>
                            <comment id="13576093" author="yukim" created="Mon, 11 Feb 2013 20:33:37 +0000"  >&lt;p&gt;I think there is concurrency problem between opening ColumnFamilyStore and deleting/scrubbing SSTables.&lt;/p&gt;

&lt;p&gt;This static block(&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-1.2.1/src/java/org/apache/cassandra/db/ColumnFamilyStore.java#L88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-1.2.1/src/java/org/apache/cassandra/db/ColumnFamilyStore.java#L88&lt;/a&gt;) schedules MeteredFlusher which accesses all ColumnFamilyStore when it runs every 1 sec. Scheduling is done when JVM first load ColumnFamilyStore class, so after that, there is always a chance to open SSTables before doing scrub directory/remove compaction left overs.&lt;br/&gt;
We should move the content of static block at the end of CassandraDaemon setup.&lt;/p&gt;</comment>
                            <comment id="13576122" author="yukim" created="Mon, 11 Feb 2013 21:02:27 +0000"  >&lt;p&gt;Patch for v1.2 attached to schedule MeteredFlusher in CassandraDaemon.&lt;br/&gt;
Probably it&apos;s better to patch 1.1 as well.&lt;/p&gt;</comment>
                            <comment id="13577680" author="mkjellman" created="Wed, 13 Feb 2013 16:22:23 +0000"  >&lt;p&gt;It appears the patch seems to have resolved the FileNotFoundException but I&apos;m still able to reproduce the IllegalStateException.&lt;/p&gt;

&lt;p&gt;Also, it seems that once a node throws this exception, even after deleting the sstables in system/compactions_in_process that node will now throw the Exception on startup every time.&lt;/p&gt;</comment>
                            <comment id="13577712" author="brandon.williams" created="Wed, 13 Feb 2013 17:01:05 +0000"  >&lt;p&gt;I move to revert the non-bugfix portion of this patch from 1.2 and push it to trunk, given the fallout we&apos;ve seen thus far.&lt;/p&gt;</comment>
                            <comment id="13577718" author="mkjellman" created="Wed, 13 Feb 2013 17:06:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; is the fallout due to bugs in the patch/new implementation or is it exposing unrelated bugs that were just being skipped before?&lt;/p&gt;</comment>
                            <comment id="13577732" author="brandon.williams" created="Wed, 13 Feb 2013 17:11:54 +0000"  >&lt;p&gt;I&apos;ll let Yuki decide, but the fact that we failed a dtest, a utest, and most importantly the &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkjellman&quot; class=&quot;user-hover&quot; rel=&quot;mkjellman&quot;&gt;mkjellman&lt;/a&gt; test is worrisome. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13577747" author="yukim" created="Wed, 13 Feb 2013 17:22:13 +0000"  >&lt;p&gt;I&apos;m thinking of the cause of this can be &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5241&quot; title=&quot;Fix forceBlockingFlush&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5241&quot;&gt;&lt;del&gt;CASSANDRA-5241&lt;/del&gt;&lt;/a&gt;, since this function relies on a lot of concurrent forceBlockingFlush. So there is a chance that compaction_in_progress flush is not complete at the end of the compaction.&lt;/p&gt;

&lt;p&gt;If that is the case, we should wait until we fix &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5241&quot; title=&quot;Fix forceBlockingFlush&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5241&quot;&gt;&lt;del&gt;CASSANDRA-5241&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13577757" author="brandon.williams" created="Wed, 13 Feb 2013 17:34:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;If that is the case, we should wait until we fix &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5241&quot; title=&quot;Fix forceBlockingFlush&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5241&quot;&gt;&lt;del&gt;CASSANDRA-5241&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1, that is a troublesome bug in many ways.&lt;/p&gt;</comment>
                            <comment id="13578469" author="yukim" created="Thu, 14 Feb 2013 16:30:19 +0000"  >&lt;p&gt;OK, I will revert this from 1.2 branch but leave it in trunk.&lt;/p&gt;</comment>
                            <comment id="13578512" author="yukim" created="Thu, 14 Feb 2013 17:33:29 +0000"  >&lt;p&gt;I reverted change in 1.2 and changed fixver to 2.0.&lt;br/&gt;
However, we still need to fix conflict in opening CFS with the patch attached before.&lt;br/&gt;
Should I create and move to the new ticket for that?&lt;/p&gt;</comment>
                            <comment id="13601547" author="yukim" created="Wed, 13 Mar 2013 19:50:34 +0000"  >&lt;p&gt;We should also remove ancestors from sstable metadata because those could consume heap when you are using LCS(&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5342&quot; title=&quot;ancestors are not cleared in SSTableMetadata after compactions are done and old SSTables are removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5342&quot;&gt;&lt;del&gt;CASSANDRA-5342&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="13666370" author="jbellis" created="Fri, 24 May 2013 14:41:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;However, we still need to fix conflict in opening CFS with the patch attached before.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;(This was done in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5350&quot; title=&quot;Fix ColumnFamily opening race&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5350&quot;&gt;&lt;del&gt;CASSANDRA-5350&lt;/del&gt;&lt;/a&gt;.)&lt;/p&gt;</comment>
                            <comment id="13694059" author="slebresne" created="Wed, 26 Jun 2013 16:29:46 +0000"  >&lt;p&gt;What&apos;s the status of this? Is there something more to do?&lt;/p&gt;</comment>
                            <comment id="13694856" author="slebresne" created="Thu, 27 Jun 2013 16:47:36 +0000"  >&lt;p&gt;So let me see if I can sum what&apos;s going on here.&lt;/p&gt;

&lt;p&gt;As far as trunk is concerned, the initial patch is still there but we suspect it may cause problems, namely:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The AssertionError &quot;Incoherent new size -3 replacing ...&quot; error in ColumnFamilyStoreTest.&lt;/li&gt;
	&lt;li&gt;The IllegalStateException &quot;Unfinished compactions reference missing sstables&quot; that Michael experienced.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;As far as I can tell from reading the history, the other problems have been fixed, right?&lt;/p&gt;

&lt;p&gt;Now, concerning 1) (the AssertionError), I &quot;think&quot; the problem is just with CFS.clearUnsafe(). Namely, it butcher the DataTracker for test purposes, but if a compaction runs concurrently, at the end of said compaction it will try to replace sstables that are not there anymore, hence the exception. I&apos;ve committed a simple workaround in commit 3935587 that make clearUnsafe() stop compactions first. As far as I can tell, this did fixed the error (I&apos;ve been able to run ColumnFamilyStoreTest a number of time without getting the stack while I had it consistently before).&lt;/p&gt;

&lt;p&gt;Remains 2), the IllegalStateException. Yuki suggests that it may have been caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5241&quot; title=&quot;Fix forceBlockingFlush&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5241&quot;&gt;&lt;del&gt;CASSANDRA-5241&lt;/del&gt;&lt;/a&gt; that is resolved now. So should we close this until further notice?  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mkjellman&quot; class=&quot;user-hover&quot; rel=&quot;mkjellman&quot;&gt;mkjellman&lt;/a&gt; Do you remember if you were able to easily reproduce that error back when you tested this patch?&lt;/p&gt;</comment>
                            <comment id="13695794" author="mkjellman" created="Fri, 28 Jun 2013 21:02:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; man this was a while back but if I remember it was fairly easy to reproduce.&lt;/p&gt;</comment>
                            <comment id="13696624" author="slebresne" created="Mon, 1 Jul 2013 07:26:47 +0000"  >&lt;p&gt;Ok, so any opposition to closing this now and re-opening if it turns Michael&apos;s bug hasn&apos;t been fix by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5241&quot; title=&quot;Fix forceBlockingFlush&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5241&quot;&gt;&lt;del&gt;CASSANDRA-5241&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13696844" author="jbellis" created="Mon, 1 Jul 2013 14:30:09 +0000"  >&lt;p&gt;SGTM.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12568889" name="0001-move-scheduling-MeteredFlusher-to-CassandraDaemon.patch" size="2605" author="yukim" created="Mon, 11 Feb 2013 21:02:27 +0000"/>
                            <attachment id="12565372" name="5151-1.2.txt" size="18732" author="yukim" created="Thu, 17 Jan 2013 21:16:48 +0000"/>
                            <attachment id="12565555" name="5151-v2.txt" size="25939" author="yukim" created="Fri, 18 Jan 2013 21:10:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>304005</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i17hfb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>251792</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>