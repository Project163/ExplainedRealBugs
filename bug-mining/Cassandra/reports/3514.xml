<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:52:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8049] Explicitly examine current C* state on startup to detect incompatibilities before upgrade</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8049</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Unfortunately, we cannot rely on users reading, and following, NEWS.txt before upgrading. People don&apos;t read, or ignore it, and sometimes have issues as the result (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8047&quot; title=&quot;Node refuses to start when 1.2 sstables are present in 2.1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8047&quot;&gt;&lt;del&gt;CASSANDRA-8047&lt;/del&gt;&lt;/a&gt;, for example, and I know of several cases like that one).&lt;/p&gt;

&lt;p&gt;We should add an explicit compatibility check on startup, before we modify anything, or write out sstables with the new format. We should fail and complain loudly if we detect a skipped upgrade step.&lt;/p&gt;

&lt;p&gt;We should also snapshot the schema tables before attempting any conversions (since it&apos;s not uncommon to make schema modifications as part of the upgrade).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12745754">CASSANDRA-8049</key>
            <summary>Explicitly examine current C* state on startup to detect incompatibilities before upgrade</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Oct 2014 15:53:25 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:32 +0000</updated>
                            <resolved>Wed, 6 May 2015 10:07:47 +0000</resolved>
                                        <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>5</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14169821" author="jeromatron" created="Mon, 13 Oct 2014 19:37:20 +0000"  >&lt;p&gt;Would be great to see this as there was &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6598&quot; title=&quot;upgradesstables does not upgrade indexes causing startup error.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6598&quot;&gt;&lt;del&gt;CASSANDRA-6598&lt;/del&gt;&lt;/a&gt; which made upgrading sstables in 1.2 not include index sstables.  That made it so if a user didn&apos;t upgrade sstables with a 1.2.14+ version of C* before going to 2.0, 2.0 would migrate some system data and then fail to startup.  It was seen in a few different cases and painful to go back.  It is documented, but something to fail fast would be very welcome.&lt;/p&gt;</comment>
                            <comment id="14303531" author="beobal" created="Tue, 3 Feb 2015 16:28:22 +0000"  >&lt;p&gt;I&apos;ve pulled all of the preflight checks that happen in CassandraDaemon#setup() into a new SystemTests class. This is mainly for testability but it also makes things a bit easier/clearer when adding new checks.&lt;/p&gt;

&lt;p&gt;I also added some further checks before we start modifying stuff:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Check that there are no unreadable sstable files in any data directories (excluding backups and snapshots)&lt;/li&gt;
	&lt;li&gt;If we detect that we&apos;re upgrading from a previous version, snapshot the system keyspace before anything modifies it&lt;/li&gt;
	&lt;li&gt;If the delta between the new and previous versions is too great, refuse to startup. Determining the threshold here is not straightforward, so I&apos;ve punted on it and added a constant &lt;tt&gt;OLDEST_PERMITTED_PREVIOUS_VERSION&lt;/tt&gt;. Suggestions as to a better way to determine that are welcome.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14356802" author="beobal" created="Wed, 11 Mar 2015 12:21:22 +0000"  >&lt;p&gt;Attached a rebased v2 patch with some simplifications to reporting failures. It replaces a bunch of code for producing a report of all test failures with a new StartupException thrown by any failing test. Startup will now fail fast on the first error it encounters rather than running all checks before reporting.&lt;/p&gt;</comment>
                            <comment id="14506840" author="beobal" created="Wed, 22 Apr 2015 11:16:50 +0000"  >&lt;p&gt;I&apos;ve pushed a rebased version &lt;a href=&quot;https://github.com/beobal/cassandra/tree/8049&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. I&apos;ve also relaxed the check on previous and current installed versions. If a previous install is detected we still snapshot the tables in the system keyspace, but I&apos;ve removed the check that aborts startup if the previous version was &quot;too old&quot; as hardcoding the oldest permitted version was just too brittle &amp;amp; burdensome.&lt;/p&gt;</comment>
                            <comment id="14508166" author="iamaleksey" created="Wed, 22 Apr 2015 23:40:27 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;initializing JMX arguably shouldn&apos;t be part of a startup check. Errors and warnings should be, if we don&apos;t mind some logic duplication of the port checking for nulls (I don&apos;t)&lt;/li&gt;
	&lt;li&gt;the &lt;tt&gt;info&lt;/tt&gt; logging in &lt;tt&gt;inspectJvmOptions&lt;/tt&gt; for heap size and &quot;JVM vendor/version&quot; should probably also remain in &lt;tt&gt;CassandraDaemon&lt;/tt&gt;, and the 32bit VM logger.info should really be a &lt;tt&gt;warn&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;checkJnaInitialization&lt;/tt&gt; shouldn&apos;t be calling &lt;tt&gt;CLibrary.tryMlockall()&lt;/tt&gt;. Catching &lt;tt&gt;LastErrorException&lt;/tt&gt; there is also kinda pointless - &lt;tt&gt;CLibrary.tryMlockall()&lt;/tt&gt; never ever rethrows it (and provides more than sufficient logging itself)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;initSigarLibrary&lt;/tt&gt; if/else logic is redundant (and I know it&apos;s a pre-existing condition). A single-line &lt;tt&gt;new SigarLibrary().warnIfRunningInDegradedMode()&lt;/tt&gt; should be sufficient, b/c the method itself has an else branch on &lt;tt&gt;initialized&lt;/tt&gt; that logs &apos;failed to initialize&apos; if so.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;checkCacheServiceInitialization&lt;/tt&gt; can go away entirely. I don&apos;t see a way it could happen, it&apos;s basically dead code (and has been so forevah)&lt;/li&gt;
	&lt;li&gt;snapshotting system keyspace on upgrades should be done, but probably not as part of &lt;tt&gt;checkSystemKeyspaceState&lt;/tt&gt; or the startup check framework. Can we make it a separate method in &lt;tt&gt;CassandraDaemon&lt;/tt&gt; or, better, &lt;tt&gt;SystemKeyspace&lt;/tt&gt;, instead?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Nits:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;StartupCheck&lt;/tt&gt; javadocs are incorrect, not reflecting the fact that we only throw the exception now and not return any values&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;StartupException&lt;/tt&gt; should probably be a checked one here, given that it can only be caught in one place and &lt;b&gt;is&lt;/b&gt; being caught there&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Most of the issues here are ones in the pre-existing code, but this ticket is an opportunity to fix them anyway, since they are related. Everything else LGTM.&lt;/p&gt;</comment>
                            <comment id="14513859" author="beobal" created="Mon, 27 Apr 2015 10:17:51 +0000"  >&lt;p&gt;Fair enough, this is a good opportunity to clean up some of that existing stuff. I&apos;ve pushed another commit to the branch addressing all of the above comments.&lt;/p&gt;</comment>
                            <comment id="14516938" author="iamaleksey" created="Tue, 28 Apr 2015 12:19:32 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                            <comment id="14528905" author="thobbs" created="Tue, 5 May 2015 17:51:36 +0000"  >&lt;p&gt;Snapshot manifest files (&lt;tt&gt;manifest.json&lt;/tt&gt;) are triggering the &quot;unreadable sstables&quot; check, which is causing a lot of dtest failures (e.g. &lt;a href=&quot;http://cassci.datastax.com/job/trunk_dtest/62/testReport/junit/snapshot_test/TestArchiveCommitlog/dont_test_archive_commitlog_4/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;snapshot tests&lt;/a&gt;).  It seems like that check should ignore files without a &lt;tt&gt;.db&lt;/tt&gt; extension, correct?&lt;/p&gt;</comment>
                            <comment id="14529008" author="beobal" created="Tue, 5 May 2015 18:34:09 +0000"  >&lt;p&gt;Bah! you&apos;re right, sorry. I&apos;ve pushed a branch with a fix + new utest, so cassci will run the dtests against that presently. I did check the test you mentioned &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; and confirmed that it failed without the fix &amp;amp; passed with it.&lt;/p&gt;</comment>
                            <comment id="14529013" author="beobal" created="Tue, 5 May 2015 18:34:43 +0000"  >&lt;p&gt;Patch with the follow up fix&lt;/p&gt;</comment>
                            <comment id="14529251" author="beobal" created="Tue, 5 May 2015 20:56:10 +0000"  >&lt;p&gt;New version of the follow up patch, as I missed a new test data file from the first one.&lt;/p&gt;</comment>
                            <comment id="14529481" author="thobbs" created="Tue, 5 May 2015 22:53:57 +0000"  >&lt;p&gt;The test results look much better: &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-8049-follow-up-dtest/3/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-8049-follow-up-dtest/3/testReport/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14530288" author="iamaleksey" created="Wed, 6 May 2015 10:07:47 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12745735">CASSANDRA-8047</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12730604" name="8049-follow-up.txt" size="6030" author="samt" created="Tue, 5 May 2015 20:56:10 +0000"/>
                            <attachment id="12703891" name="8049-v2.txt" size="54831" author="samt" created="Wed, 11 Mar 2015 12:21:22 +0000"/>
                            <attachment id="12696202" name="8049.txt" size="54608" author="samt" created="Tue, 3 Feb 2015 16:28:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20rwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>