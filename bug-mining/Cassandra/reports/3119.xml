<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:48:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7360] CQLSSTableWriter consumes all memory for table with compound primary key</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7360</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When using CQLSSTableWriter to write a table with compound primary key, if the partition key is identical for a huge amount of records, the sync() method is never called, and the memory usage keeps growing until the memory is exhausted. &lt;/p&gt;

&lt;p&gt;Could the code be improved to do sync() even when there is no new row  created? The relevant code is in SSTableSimpleUnsortedWriter.java and AbstractSSTableSimpleWriter.java. I am new to the code and cannot produce a reasonable patch for now.&lt;/p&gt;

&lt;p&gt;The problem can be reproduced by the following test case:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.io.sstable.CQLSSTableWriter;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.exceptions.InvalidRequestException;

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.io.IOException;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.UUID;

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;SS {
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; schema = &lt;span class=&quot;code-quote&quot;&gt;&quot;create table test.t (x uuid, y uuid, primary key (x, y))&quot;&lt;/span&gt;;


        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; insert = &lt;span class=&quot;code-quote&quot;&gt;&quot;insert into test.t (x, y) values (?, ?)&quot;&lt;/span&gt;;
        CQLSSTableWriter writer = CQLSSTableWriter.builder()
            .inDirectory(&lt;span class=&quot;code-quote&quot;&gt;&quot;/tmp/test/t&quot;&lt;/span&gt;)
            .forTable(schema).withBufferSizeInMB(32)
            .using(insert).build();

        UUID id = UUID.randomUUID();
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 50000000; i++) {
                UUID id2 = UUID.randomUUID();
                writer.addRow(id, id2);
            }

            writer.close();
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;hell&quot;&lt;/span&gt;);
        }
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12718794">CASSANDRA-7360</key>
            <summary>CQLSSTableWriter consumes all memory for table with compound primary key</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="xuzhongxing">Xu Zhongxing</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Jun 2014 08:34:05 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:43 +0000</updated>
                            <resolved>Wed, 10 Sep 2014 01:41:19 +0000</resolved>
                                        <fixVersion>2.0.11</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14108848" author="slebresne" created="Mon, 25 Aug 2014 07:25:53 +0000"  >&lt;p&gt;Attaching patch for this. I first modified &lt;tt&gt;SSTableSimpleUnsortedWriter&lt;/tt&gt; so it checks if it needs to &quot;sync&quot; after each column, to realize that &lt;tt&gt;CQLSSTableWriter&lt;/tt&gt; was bypassing this and adding cells directly to th CF that &lt;tt&gt;SSTableSimpleUnsortedWriter&lt;/tt&gt; expose. So &lt;tt&gt;CQLSSTableWriter&lt;/tt&gt; uses a modified CF object that calls back the proper method after adding each cells: not the cleanest thing ever but simple enough to fix this.&lt;/p&gt;</comment>
                            <comment id="14121104" author="blerer" created="Thu, 4 Sep 2014 08:27:44 +0000"  >&lt;p&gt;I noticed 2 things:&lt;br/&gt;
1) I think that in BufferedWriter.close() the code should probably try to call super.close before trying to rethrow the exception. Just to make sure that we terminate as properly as possible.&lt;/p&gt;

&lt;p&gt;2) I have the following error message in my log when I run the Unit tests:&lt;br/&gt;
Exception in thread &quot;StorageServiceShutdownHook&quot; java.lang.IllegalStateException: No configured daemon&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.stopRPCServer(StorageService.java:309)&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.shutdownClientServers(StorageService.java:381)&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.access$3(StorageService.java:379)&lt;br/&gt;
	at org.apache.cassandra.service.StorageService$1.runMayThrow(StorageService.java:568)&lt;br/&gt;
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:745)&lt;br/&gt;
I am not sure that it is a real problem but idealy it would be nice if we could get rid of it.&lt;/p&gt;

&lt;p&gt;Personnaly, I think that I instead of storing the error I would have wrapped it into a UncheckedException (e.g. SyncException) that I would have caught in rawAddRow and rethrow as IOException as it is more direct. Nevertheless it is just a matter of taste in term of &quot;non clean stuff&quot; and I am fine with your solution.  &lt;/p&gt;</comment>
                            <comment id="14123072" author="slebresne" created="Fri, 5 Sep 2014 15:59:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;I would have wrapped it into a UncheckedException (e.g. SyncException) that I would have caught in rawAddRow and rethrow as IOException as it is more direct&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right, that&apos;s probably cleaner overall, made that change in the v2 attached.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think that in BufferedWriter.close() the code should probably try to call super.close before trying to rethrow the exception&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s fixed by the virtue of BufferedWriter not overriding close() anymore.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I have the following error message in my log when I run the Unit tests&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That is something we need to fix but that&apos;s completely unrelated to this ticket so not gonna fix it here. But created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7889&quot; title=&quot;Fix &amp;quot;java.lang.IllegalStateException: No configured daemon&amp;quot; in tests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7889&quot;&gt;&lt;del&gt;CASSANDRA-7889&lt;/del&gt;&lt;/a&gt; so we don&apos;t forget to scratch this itch.&lt;/p&gt;</comment>
                            <comment id="14125416" author="blerer" created="Mon, 8 Sep 2014 11:19:14 +0000"  >&lt;p&gt;Just one nitpick: you do not need to create an ioe field as Throwable allow exception nesting. You can just call the RuntimeException(Throwable cause) constructor via super(ioe) and retrieve the Exception via getCause() in rawAddRow. &lt;/p&gt;</comment>
                            <comment id="14127906" author="slebresne" created="Wed, 10 Sep 2014 01:41:19 +0000"  >&lt;p&gt;Committed (with nit fixed), thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12666809" name="7360-v2.txt" size="15337" author="slebresne" created="Fri, 5 Sep 2014 15:59:05 +0000"/>
                            <attachment id="12664113" name="7360.txt" size="14186" author="slebresne" created="Mon, 25 Aug 2014 07:25:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396993</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wcif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>397111</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325761">2.0.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>