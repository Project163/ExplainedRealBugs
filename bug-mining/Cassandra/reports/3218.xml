<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8147] Secondary indexing of map keys does not work properly when mixing contains and contains_key</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8147</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If you have a table with a map column and an index on the map key selecting data using a contains key and a contains will not return the expected data.&lt;/p&gt;

&lt;p&gt;The problem can be reproduced using the following unit test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testMapKeyContainsAndValueContains() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
    {
        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (account text, id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, categories map&amp;lt;text,text&amp;gt;, PRIMARY KEY (account, id))&quot;&lt;/span&gt;);
        createIndex(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE INDEX ON %s(keys(categories))&quot;&lt;/span&gt;);

        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (account, id , categories) VALUES (?, ?, ?)&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;, 5, map(&lt;span class=&quot;code-quote&quot;&gt;&quot;lmn&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;));

        assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE account = ? AND id = ? AND categories CONTAINS KEY ? AND categories CONTAINS ? ALLOW FILTERING&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;, 5, &lt;span class=&quot;code-quote&quot;&gt;&quot;lmn&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;), row(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;, 5, map(&lt;span class=&quot;code-quote&quot;&gt;&quot;lmn&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;)));  
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12749247">CASSANDRA-8147</key>
            <summary>Secondary indexing of map keys does not work properly when mixing contains and contains_key</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="blerer">Benjamin Lerer</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Oct 2014 13:47:29 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:31 +0000</updated>
                            <resolved>Tue, 4 Nov 2014 16:40:23 +0000</resolved>
                                        <fixVersion>2.1.2</fixVersion>
                                    <component>Feature/2i Index</component>
                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14177488" author="rhatch" created="Mon, 20 Oct 2014 21:22:09 +0000"  >&lt;p&gt;I think there is not currently support for indexing both values and keys (ref: &lt;a href=&quot;http://www.datastax.com/dev/blog/cql-in-2-1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.datastax.com/dev/blog/cql-in-2-1&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;In the example above the index is on keys only, but the select is attempting to query a values index too. So the empty result is sort of correct, but there should probably be a warning message to prevent confusion about this (&quot;index does not exist&quot; or something like that).&lt;/p&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14178080" author="blerer" created="Tue, 21 Oct 2014 07:27:52 +0000"  >&lt;p&gt;The empty result is not correct, no matter how you look at it. There are only two things that can happen in response to the query:&lt;br/&gt;
you either get the good result back or you get an error with a message telling you what you did wrong.&lt;br/&gt;
I agree that querying a key and a value and on map does not make a lot of sense, so an error message will be perfectly acceptable.  &lt;/p&gt;</comment>
                            <comment id="14178171" author="slebresne" created="Tue, 21 Oct 2014 09:19:55 +0000"  >&lt;p&gt;I don&apos;t totally agree with all this. It is correct that we currently only allow one index per CQL column, and so one cannot index both the keys and values of a given map, but that&apos;s not what the test does. The test only has an index on the keys.&lt;/p&gt;

&lt;p&gt;Regarding the &lt;tt&gt;SELECT&lt;/tt&gt;, provided you do have an indexed clause (which that example has), it&apos;s allowed to have other non-indexed clause (it will require &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; but it&apos;s used in the example too).  So I&apos;m not sure why this doesn&apos;t work, but it should (it&apos;s worth testing on current 2.1 branch though, maybe this has been fixed since 2.1.0).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I agree that querying a key and a value and on map does not make a lot of sense&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Out of curiosity, why wouldn&apos;t that make sense?&lt;/p&gt;</comment>
                            <comment id="14178201" author="blerer" created="Tue, 21 Oct 2014 09:43:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;(it&apos;s worth testing on current 2.1 branch though, maybe this has been fixed since 2.1.0).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I tested it on the latest 2.1&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Out of curiosity, why wouldn&apos;t that make sense?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;As a map can only have one value associated to a given key, using such a query means that you want to check that the key exists and that the value is the one you think it should be. If you select using a contains key only you will be able to have the same information but you will also know if it is the key which is missing or the value which is not what you expect.&lt;br/&gt;
That is why I think that it does not make a lot of sense and that an error message will be fine for me if I was a user.&lt;br/&gt;
Now as a user it is also true that it will also give me a better sense of robustness if the query was handled properly &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;   &lt;/p&gt;</comment>
                            <comment id="14178212" author="slebresne" created="Tue, 21 Oct 2014 09:54:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;As a map can only have one value associated to a given key, using such a query means that you want to check that the key exists and that the value is the one you think it should be.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s not what the query means, no. Asking for maps that contains a given key and a given value does not imply that said given value must be associated to said given key.&lt;br/&gt;
Besides, even if that was what the query means, the query still make sense. It might not be terribly useful, but it make sense, so I&apos;d still not think throwing an error would not be very user friendly.&lt;/p&gt;</comment>
                            <comment id="14179750" author="blerer" created="Wed, 22 Oct 2014 09:20:50 +0000"  >&lt;p&gt;The problem was cause by the fact that the IndexSearcher was trying to use the key index to search for the contains value.&lt;br/&gt;
This patch fix this problem and also fix the SelectStatement check for the indexed column (if we do a select contains on a map were only the key is indexed we should reject the query).&lt;br/&gt;
The patch also replace the index option Strings with constants to avoid typos issues.&lt;/p&gt;</comment>
                            <comment id="14180223" author="thobbs" created="Wed, 22 Oct 2014 17:40:50 +0000"  >&lt;p&gt;Hmm, so this makes some of the same fixes as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8155&quot; title=&quot;confusing error when erroneously querying map secondary index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8155&quot;&gt;&lt;del&gt;CASSANDRA-8155&lt;/del&gt;&lt;/a&gt;, but in a different way.  Personally, I prefer putting the logic for &quot;does this index support this operator&quot; in the index code instead of the operator code (as the 8155 patch does).  However, it would be good to include your test cases and the constants instead of String options.&lt;/p&gt;

&lt;p&gt;Do you want to take a look at that patch and see if you agree?&lt;/p&gt;</comment>
                            <comment id="14181135" author="blerer" created="Thu, 23 Oct 2014 08:43:44 +0000"  >&lt;p&gt;I like the &lt;tt&gt;supportsOperator&lt;/tt&gt; approach of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8155&quot; title=&quot;confusing error when erroneously querying map secondary index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8155&quot;&gt;&lt;del&gt;CASSANDRA-8155&lt;/del&gt;&lt;/a&gt; but I think that we should do the validation during the preparation phase of the select statement and not at execution time. It seems more user friendly to me.&lt;/p&gt;

&lt;p&gt;So personally I would kind of merge the two patches as follow:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Use the constants instead of String options and tests from this patch&lt;/li&gt;
	&lt;li&gt;Use the  &lt;tt&gt;supportsOperator&lt;/tt&gt; approach of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8155&quot; title=&quot;confusing error when erroneously querying map secondary index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8155&quot;&gt;&lt;del&gt;CASSANDRA-8155&lt;/del&gt;&lt;/a&gt; instead of &lt;tt&gt;isValidIndexFor&lt;/tt&gt; in the &lt;tt&gt;SecondaryIndex&lt;/tt&gt; as I found it much nicer&lt;/li&gt;
	&lt;li&gt;Keep some validation in the SelectStatement during the preparation phase (if you do not like the approach of this patch we can use an other one).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14181488" author="thobbs" created="Thu, 23 Oct 2014 15:52:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;So personally I would kind of merge the two patches as follow&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That sounds good to me.  Can you take care of making that patch and I&apos;ll resolve 8155 as a duplicate?&lt;/p&gt;</comment>
                            <comment id="14181533" author="blerer" created="Thu, 23 Oct 2014 16:25:51 +0000"  >&lt;p&gt;No problem, I will do it.&lt;/p&gt;</comment>
                            <comment id="14183376" author="blerer" created="Fri, 24 Oct 2014 19:58:36 +0000"  >&lt;p&gt;Patch resulting from the merge of the V1 patch and of the one of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8155&quot; title=&quot;confusing error when erroneously querying map secondary index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8155&quot;&gt;&lt;del&gt;CASSANDRA-8155&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14187032" author="thobbs" created="Tue, 28 Oct 2014 16:25:07 +0000"  >&lt;p&gt;Overall this looks good.&lt;/p&gt;

&lt;p&gt;The only remaining use of &lt;tt&gt;Relation.allowsIndexQueryOn()&lt;/tt&gt; is in &lt;tt&gt;SelectStatement.processRelationEntity()&lt;/tt&gt;.  We could remove &lt;tt&gt;allowsIndexQueryOn()&lt;/tt&gt; (and &lt;tt&gt;CollectionType.isMap()&lt;/tt&gt;) by doing something like this in &lt;tt&gt;processRelationEntity()&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SecondaryIndex index = indexManager.getIndexForColumn(def.name.bytes);
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (index != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &amp;amp;&amp;amp; index.supportsOperator(relation.&lt;span class=&quot;code-keyword&quot;&gt;operator&lt;/span&gt;()))
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;[]{&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, def.kind == ColumnDefinition.Kind.CLUSTERING_COLUMN};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;(It looks like we need to be able to convert &lt;tt&gt;Relation.Type&lt;/tt&gt; enum values to &lt;tt&gt;IndexExpression.Operator&lt;/tt&gt; enum values, though.)&lt;/p&gt;</comment>
                            <comment id="14192455" author="blerer" created="Fri, 31 Oct 2014 20:40:52 +0000"  >&lt;p&gt;&lt;tt&gt;Relation.Type&lt;/tt&gt; and &lt;tt&gt;IndexExpression.Operator&lt;/tt&gt; are really similar. Should we merge them? If yes, in which package do you think that we should put the resulting class? &lt;/p&gt;</comment>
                            <comment id="14192560" author="thobbs" created="Fri, 31 Oct 2014 21:48:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;Relation.Type and IndexExpression.Operator are really similar. Should we merge them?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think that&apos;s a good idea, if you&apos;re willing to do it (perhaps as a second patch, for clarity).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;in which package do you think that we should put the resulting class?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m tempted to just use Relation.Type, but if you think that&apos;s a bad idea for some reason, I would make an o.a.c.cql3.Operator class.&lt;/p&gt;</comment>
                            <comment id="14194566" author="blerer" created="Mon, 3 Nov 2014 14:23:21 +0000"  >&lt;p&gt;Additional patch that replaces &lt;tt&gt;Relation.Type&lt;/tt&gt; and &lt;tt&gt;IndexExpression.Operator&lt;/tt&gt; by &lt;tt&gt;Operator&lt;/tt&gt; and fix the last remaining issue.&lt;/p&gt;</comment>
                            <comment id="14196327" author="thobbs" created="Tue, 4 Nov 2014 16:40:23 +0000"  >&lt;p&gt;Thanks! Committed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12749364">CASSANDRA-8155</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12697821">CASSANDRA-6782</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12678932" name="CASSANDRA-8147-V2-PART2.txt" size="108191" author="blerer" created="Mon, 3 Nov 2014 14:23:21 +0000"/>
                            <attachment id="12676989" name="CASSANDRA-8147-V2.txt" size="24492" author="blerer" created="Fri, 24 Oct 2014 19:58:36 +0000"/>
                            <attachment id="12676291" name="CASSANDRA-8147.txt" size="21223" author="blerer" created="Wed, 22 Oct 2014 09:20:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21cuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>rhatch</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>