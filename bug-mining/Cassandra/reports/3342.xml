<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8267] Only stream from unrepaired sstables during incremental repair</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8267</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Seems we stream from all sstables even if we do incremental repair, we should limit this to only stream from the unrepaired sstables if we do incremental repair&lt;/p&gt;</description>
                <environment></environment>
        <key id="12753311">CASSANDRA-8267</key>
            <summary>Only stream from unrepaired sstables during incremental repair</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Nov 2014 06:35:19 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:29 +0000</updated>
                            <resolved>Mon, 11 May 2015 07:29:42 +0000</resolved>
                                        <fixVersion>2.1.3</fixVersion>
                    <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="14223034" author="krummas" created="Mon, 24 Nov 2014 15:04:18 +0000"  >&lt;p&gt;To solve this we need to tell a node whether or not this is an incremental repair when requesting ranges from it. This breaks streaming message versioning, meaning we would not be able to stream between two nodes unless they were both upgraded, which would suck in a minor release.&lt;/p&gt;

&lt;p&gt;One &quot;solution&quot; could be to only break streaming for incremental repairs (when they are initiated on an upgraded node) by adding a new IncrementalStreamRequest message and failing early if we notice that not all endpoints included in the incremental repair are upgraded. This would make old-style repairs still work since they don&apos;t use the new message (and full repairs are the default in 2.1).&lt;/p&gt;

&lt;p&gt;WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt;? Would this be acceptable or do you have a better solution? We kind of have to fix this in 2.1 since it makes incremental repairs quite bad.&lt;/p&gt;</comment>
                            <comment id="14225816" author="jbellis" created="Wed, 26 Nov 2014 06:15:42 +0000"  >&lt;p&gt;I like the new message approach.  If the repair leader is an old node, you&apos;re no worse off and everything streams the old way.  If the repair leader is a new node, then you either get correct streaming or an error message telling you to upgrade everyone. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14226035" author="iamaleksey" created="Wed, 26 Nov 2014 11:09:33 +0000"  >&lt;p&gt;How about we just implement &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8110&quot; title=&quot;Make streaming forward &amp;amp; backwards compatible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8110&quot;&gt;CASSANDRA-8110&lt;/a&gt; one release earlier?&lt;/p&gt;

&lt;p&gt;Then we can negotiate the version like we do w/ messaging version for outbound connections.&lt;/p&gt;</comment>
                            <comment id="14226337" author="krummas" created="Wed, 26 Nov 2014 15:40:28 +0000"  >&lt;p&gt;hmm, I&apos;ll see how hard that would be (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8110&quot; title=&quot;Make streaming forward &amp;amp; backwards compatible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8110&quot;&gt;CASSANDRA-8110&lt;/a&gt; that is)&lt;/p&gt;

&lt;p&gt;In the mean time, pushed a branch with a new IncrementalPrepareMessage which solves this issue: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/8267&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/8267&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Note that it does not yet fail gracefully if you issue an incremental repair on an upgraded node (we might have to bump MessagingVersion to be able to do that, really don&apos;t want to parse RELEASE_VERSION from gossip info). Might not have to fix it if #8110 works out here&lt;/p&gt;</comment>
                            <comment id="14227303" author="jbellis" created="Thu, 27 Nov 2014 06:21:46 +0000"  >&lt;p&gt;Unless 8110 a lot simpler than I think, I don&apos;t think we should be trying to cram it into 2.1.x.&lt;/p&gt;</comment>
                            <comment id="14229884" author="krummas" created="Mon, 1 Dec 2014 15:03:01 +0000"  >&lt;p&gt;Did part of 8110 (just the version negotiation), pretty simple, but we have to bump messaging version which affects quite a few things, for example, we can&apos;t migrate schemas between different messaging versions (this could be special cased and fixed for this issue of course)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/8110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/8110&lt;/a&gt; - simply splits out the &quot;header&quot; part of StreamInitMessage into its own message and replies with a &apos;maxVersion&apos; to that message when setting up the connection to agree on a version to use.&lt;/p&gt;

&lt;p&gt;I think we should go with the new message solution above though, less risky for a minor release&lt;/p&gt;</comment>
                            <comment id="14229885" author="iamaleksey" created="Mon, 1 Dec 2014 15:07:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;but we have to bump messaging version which affects quite a few things, for example, we can&apos;t migrate schemas between different messaging versions (this could be special cased and fixed for this issue of course)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s unfortunate :\ I agree, then, with a new message - so long as we do it properly for 3.0 in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8110&quot; title=&quot;Make streaming forward &amp;amp; backwards compatible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8110&quot;&gt;CASSANDRA-8110&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14231240" author="krummas" created="Tue, 2 Dec 2014 09:59:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; could you review? &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/8267&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/8267&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14236321" author="yukim" created="Fri, 5 Dec 2014 23:52:02 +0000"  >&lt;p&gt;Since we already send/receive &lt;tt&gt;repairedAt&lt;/tt&gt; timestamp when doing incremental, can&apos;t we just use that to filter out repaired SSTables?&lt;br/&gt;
That way we don&apos;t break anything in mid-2.1 release.&lt;/p&gt;</comment>
                            <comment id="14237771" author="krummas" created="Mon, 8 Dec 2014 11:11:29 +0000"  >&lt;p&gt;ah good point, stand by for new patch&lt;/p&gt;

&lt;p&gt;will need another approach in 3.0 though since we send repairedAt for all repairs there&lt;/p&gt;</comment>
                            <comment id="14237901" author="krummas" created="Mon, 8 Dec 2014 14:23:28 +0000"  >&lt;p&gt;attaching updated patch that checks repairedAt instead&lt;/p&gt;</comment>
                            <comment id="14238180" author="yukim" created="Mon, 8 Dec 2014 18:08:43 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14246598" author="krummas" created="Mon, 15 Dec 2014 12:09:19 +0000"  >&lt;p&gt;attaching patch for trunk as well, adds a flag to the StreamInitMessage that states whether we should only stream from unrepaired sstables or not&lt;/p&gt;</comment>
                            <comment id="14285551" author="krummas" created="Wed, 21 Jan 2015 11:58:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; i committed the 2.1 patch, but merged it to trunk with &quot;-s ours&quot; as we are about to release 2.1.3, removing that Fix version until we have committed the trunk patch (the trunk patch has very little in common with the 2.1 patch)&lt;/p&gt;</comment>
                            <comment id="14291694" author="flaviencharlon" created="Mon, 26 Jan 2015 11:02:59 +0000"  >&lt;p&gt;Won&apos;t this be part of 2.1.3? I hope it will.&lt;/p&gt;</comment>
                            <comment id="14291696" author="krummas" created="Mon, 26 Jan 2015 11:06:22 +0000"  >&lt;p&gt;the 2.1 patch is committed, so it will be in 2.1.3, the trunk-patch needs a new review, so i removed the 2.1.3 fix version so that this issue does not show up as a blocker for a 2.1.3 release - will re-add the version later&lt;/p&gt;</comment>
                            <comment id="14291699" author="FlavienCharlon" created="Mon, 26 Jan 2015 11:07:36 +0000"  >&lt;p&gt;Great, thanks.&lt;/p&gt;</comment>
                            <comment id="14502786" author="krummas" created="Mon, 20 Apr 2015 13:31:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; I pushed a trunk-rebased version here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/8267-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/8267-trunk&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14535385" author="yukim" created="Fri, 8 May 2015 19:53:42 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14537682" author="krummas" created="Mon, 11 May 2015 07:29:42 +0000"  >&lt;p&gt;committed, thanks&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12768177">CASSANDRA-8641</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12685752" name="0001-Only-stream-from-unrepaired-sstables-during-incremen.patch" size="4132" author="marcuse" created="Mon, 8 Dec 2014 14:23:28 +0000"/>
                            <attachment id="12687223" name="8267-trunk.patch" size="21062" author="marcuse" created="Mon, 15 Dec 2014 12:09:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 28 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i221kf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>