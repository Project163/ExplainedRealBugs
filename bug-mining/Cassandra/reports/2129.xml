<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:38:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5455] Remove PBSPredictor</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5455</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;It was a fun experiment, but it&apos;s unmaintained and the bar to understanding what is going on is high.  Case in point: PBSTest has been failing intermittently for some time now, possibly even since it was created.  Or possibly not and it was a regression from a refactoring we did.  Who knows?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12642058">CASSANDRA-5455</key>
            <summary>Remove PBSPredictor</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Apr 2013 16:06:29 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:14 +0000</updated>
                            <resolved>Thu, 11 Apr 2013 16:30:32 +0000</resolved>
                                        <fixVersion>2.0 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13629073" author="krummas" created="Thu, 11 Apr 2013 16:25:44 +0000"  >&lt;p&gt;there is an ant target &quot;pbs-test&quot; that should go away as well&lt;/p&gt;

&lt;p&gt;lgtm other than that&lt;/p&gt;</comment>
                            <comment id="13629081" author="jbellis" created="Thu, 11 Apr 2013 16:30:32 +0000"  >&lt;p&gt;fixed + committed&lt;/p&gt;</comment>
                            <comment id="13654669" author="pbailis" created="Fri, 10 May 2013 17:58:09 +0000"  >&lt;p&gt;I am one of the original authors of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4261&quot; title=&quot;[patch] Support consistency-latency prediction in nodetool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4261&quot;&gt;&lt;del&gt;CASSANDRA-4261&lt;/del&gt;&lt;/a&gt; and was previously unaware of this change. I&apos;m happy to make any changes to the tests, perform necessary code refactoring, or write additional documentation (but was unable to do so given the window between ticket creation and commit). That is, I will maintain this functionality given the opportunity to do so.&lt;/p&gt;

&lt;p&gt;Could you please elaborate on what you&apos;d like to see fixed? I suspect it&apos;ll be fairly straightforward, and, if anyone &quot;knows&quot; how to make the changes, I (and Shivaram) probably do.&lt;/p&gt;

&lt;p&gt;If the answer is that &quot;we don&apos;t want this functionality,&quot; then that&apos;s a different case. But that&apos;s not what I&apos;m getting from this ticket or &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4261&quot; title=&quot;[patch] Support consistency-latency prediction in nodetool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4261&quot;&gt;&lt;del&gt;CASSANDRA-4261&lt;/del&gt;&lt;/a&gt; or am hearing from users.&lt;/p&gt;</comment>
                            <comment id="13654676" author="jbellis" created="Fri, 10 May 2013 18:11:55 +0000"  >&lt;p&gt;Honestly, it was probably a mistake (mine) to commit it in the first place.  In my defense, it&apos;s hard to say No when someone shows up with working code...  but I should have; it doesn&apos;t solve an actual pain point for our users, so none of the maintainers was motivated to get familiar enough with it to fix the kind of regressions we ran into.  I don&apos;t see that changing if we were to resurrect it.  My sincere apologies for the time you put into it.&lt;/p&gt;</comment>
                            <comment id="13654714" author="rbranson" created="Fri, 10 May 2013 18:46:02 +0000"  >&lt;p&gt;Correct me if I&apos;m wrong, but it seems like only a small amount of the code in the original patch is actually necessary to have in core to satisfy the data requirements of doing the PBS prediction. I would love to be able to feed these metrics into our monitoring systems as well. Would it be acceptable to refactor the code to support the latency metric collection &amp;amp; expose them through a JMX call, and allow implementing the actual PBS logic in a third party tool?&lt;/p&gt;</comment>
                            <comment id="13654759" author="jbellis" created="Fri, 10 May 2013 19:24:28 +0000"  >&lt;p&gt;I don&apos;t see why not.  Aren&apos;t these the same latency numbers that we track in StorageProxy?&lt;/p&gt;</comment>
                            <comment id="13654761" author="pbailis" created="Fri, 10 May 2013 19:32:42 +0000"  >&lt;p&gt;I don&apos;t believe that the StorageProxy tracks the latencies according to the same granularity. For example, the PBS latency tracking will record both how long it took for the request to reach a remote replica and be processed as well as how long the return trip takes.&lt;/p&gt;

&lt;p&gt;That said, it shouldn&apos;t be too difficult to either 1.) simply expose the recorded latencies via an optional module providing a &quot;finer granularity tracing&quot; interface via JMX &lt;span class=&quot;error&quot;&gt;&amp;#91;thereby removing all actual prediction code but keeping the logging in place for folks who might want this&amp;#93;&lt;/span&gt; or 2.) modifying StorageProxy to log these latencies in addition to the coarser granularity measurements it already takes.&lt;/p&gt;

&lt;p&gt;I can provide assistance with either.&lt;/p&gt;</comment>
                            <comment id="13654771" author="jbellis" created="Fri, 10 May 2013 19:51:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;the PBS latency tracking will record both how long it took for the request to reach a remote replica and be processed as well as how long the return trip takes.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm, I don&apos;t see that happening on the 1.2 branch.  It looks to me like like PBS was trying to measure raw message RTT (slightly incorrectly since it was clicking Start when we enqueued the message rather than when we sent).  Which, granted, &lt;b&gt;is&lt;/b&gt; different from the SP &quot;time to complete request&quot; metrics.&lt;/p&gt;

&lt;p&gt;Would the latter be &quot;close enough?&quot;  I&apos;d rather only track one set of mostly similar metrics, given the choice.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;modifying StorageProxy to log these latencies in addition to the coarser granularity measurements it already takes&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m fine with either &quot;provide it as SPMBean methods&quot; or &quot;create a separate MBean that we only kick off if individual data point collection is enabled.&quot;&lt;/p&gt;

&lt;p&gt;Should we make collection be a fraction (0..1) rather than on/off?  ISTM that 10% or 1% of requests could provide enough information on a busy system, and those CLQ objects could become a contention point w/ enough cores busy.&lt;/p&gt;</comment>
                            <comment id="13657705" author="pbailis" created="Tue, 14 May 2013 23:48:31 +0000"  >&lt;p&gt;I&apos;ve thought some more about different options for enabling metrics that are useful to both PBS (in an external module, if committers prefer) and anyone else who would be interested in finer-grained tracing.&lt;/p&gt;

&lt;p&gt;To start, I &lt;b&gt;do&lt;/b&gt; think that there is interest in a PBS module: if an eventually consistent store is returning stale data, how stale &lt;b&gt;is&lt;/b&gt; it? Especially given that many (most?) Cassandra client libraries (including the Datastax java-driver) choose CL=ONE by default, I&apos;d expect most users would prefer to understand how their choice of N,R, and W affects their latency and consistency.&lt;/p&gt;

&lt;p&gt;I&apos;ve been contacted by several Cassandra users who are interested in and/or using this functionality and understand that several developers are interested in PBS for Riak (notably, Andy Gross highlighted PBS in his 2013 RICON East keynote as a useful feature Basho would like). We originally chose Cassandra based on our familiarity with the code base and on early discussions with Jonathan but we plan to integrate PBS functionality into Riak with the help of their committers in the near-term future. So I do think there is interest, and, if you&apos;re curious about &lt;b&gt;use cases&lt;/b&gt; for this functionality, Shivaram and I will be demoing PBS in Cassandra 1.2 at the upcoming SIGMOD 2013 conference. Our demo proposal sketches three application vignettes, including the obvious integration with monitoring tools but also automatically tuning N,R, and W and and providing consistency and latency SLAs:&lt;br/&gt;
&lt;a href=&quot;http://www.bailis.org/papers/pbs-demo-sigmod2013.pdf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.bailis.org/papers/pbs-demo-sigmod2013.pdf&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;So, on the more technical side, there are two statistics that aren&apos;t currently measured (in trunk) that are required for accurate PBS predictions. First, PBS requires per-server statistics. Currently, the ColumnFamily RTT read/write latency metrics are aggregated across all servers. Second, PBS requires a measure how how long a read/write request takes before it is processed (i.e., how long it took from a client sending  each read/write request to when it was performed). This requires knowledge of one-way request latencies as well as read/write request-specific logic.&lt;/p&gt;

&lt;p&gt;The 1.2 PBS patch provided both of these, aggregating by server and measuring the delay until processing. As Jonathan notes above, the latter measurement was conservative; the remote replica recorded the time that it enqueued its response rather than the exact moment a read or write was performed, namely for simplicity of code. The coordinating server could then closely approximate the return time as RTT-(remote timestamp).&lt;/p&gt;

&lt;p&gt;Given these requirements and the current state of trunk, there are a few ways forward to support an external PBS prediction module:&lt;/p&gt;

&lt;p&gt;1a.) Modify Cassandra to store latency statistics on a per-server and per-ColumnFamily granularity. As Rick Branson has pointed out, this is actually useful for monitoring other than PBS and can be used to detect slower replicas.&lt;/p&gt;

&lt;p&gt;1b.) Modify Cassandra to store local processing times for requests (i.e., expand StorageMetrics, which currently does not track the time required to, say, fulfill a local read stage). This also has the benefit of understanding whether a Cassandra node is slow due to network or disk.&lt;/p&gt;

&lt;p&gt;2.) Use the newly developed tracing functionality to reconstruct latencies for selected requests. Performing any sort of profiling will require tracing to be enabled (this appears to be somewhat heavyweight given the amount of data that is logged for each request , and reconstructing latencies from the trace table may be expensive (i.e., amount to a many-way self-join).&lt;/p&gt;

&lt;p&gt;3.) Use RTT/2 based on ColumnFamily LatencyMetrics as an inaccurate but already supported external predictor.&lt;/p&gt;

&lt;p&gt;4.) Leave the PBS latency sampling as in 1.2 but remove the PBS predictor code. Expose the latency samples via an Mbean for users like Rick who would benefit from it.&lt;/p&gt;

&lt;p&gt;Proposal #1 has benefits for many users and seems a natural extension to the existing metrics but requires changes to the existing code. Proposal #2 puts substantial burden on an end-user and, without a fixed schema for the trace table, may amount to a fair bit of code munging. Proposal #3 is inaccurate but works on trunk. Proposal #4 is essentially 1.2.0 without the requirement to maintain any PBS-specific code and is a reasonable stop-gap before proposal #1. All of these proposals are amenable to sampling.&lt;/p&gt;

&lt;p&gt;I&apos;d welcome your feedback on these proposals and next steps.&lt;/p&gt;</comment>
                            <comment id="13659231" author="jbellis" created="Thu, 16 May 2013 05:15:39 +0000"  >&lt;p&gt;I&apos;d prefer option 1 but I&apos;m also fine with option 3.&lt;/p&gt;

&lt;p&gt;For option 1 we do need to distinguish between &quot;track latency stuff on a per-CF basis&quot; (which is universally useful as, say, an EstimatedHistogram) and &quot;keep a window of individual latency times&quot; which is pretty much only a PBS requirement.  As I said above, we&apos;d want to keep the latter disabled unless specified otherwise.&lt;/p&gt;</comment>
                            <comment id="13666888" author="pbailis" created="Sat, 25 May 2013 01:06:39 +0000"  >&lt;p&gt;Okay. #1 will likely require more extensive code changes: basically, it&apos;ll require EstimatedHistograms for each of the servers acting as replicas for a given ColumnFamily and will require EstimatedHistogram tracing in the StorageProxy (to separate network-based latency from disk-based latency). Are these changes feasible?&lt;/p&gt;

&lt;p&gt;re: &quot;a window of individual latency times,&quot; looking at the Metrics implementation of EstimatedHistogram, EstimatedHistogram.values() should provide a reasonable enough sample (especially since, as you mention, since it has other uses as well).&lt;/p&gt;

&lt;p&gt;Perhaps the simplest strategy is to go with #3 for now but implement #1 in the future if there&apos;s interest. #3 is easy; I&apos;ve already written an example external module to do RTT/2 predictions: &lt;a href=&quot;https://github.com/pbailis/pbs-predictor/blob/9d31acd1667b08affa609278689b540d8e0380f5/pbspredictor/src/main/java/edu/berkeley/pbs/cassandra/CassandraLatencyTrace.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pbailis/pbs-predictor/blob/9d31acd1667b08affa609278689b540d8e0380f5/pbspredictor/src/main/java/edu/berkeley/pbs/cassandra/CassandraLatencyTrace.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13667804" author="jbellis" created="Mon, 27 May 2013 15:32:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;ve already written an example external module to do RTT/2 predictions&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do we need any core changes at all, then?  (Under the &quot;#3 for now&quot; plan.)&lt;/p&gt;</comment>
                            <comment id="13668054" author="pbailis" created="Tue, 28 May 2013 03:51:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;Do we need any core changes at all, then? (Under the &quot;#3 for now&quot; plan.)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nope; the predictor I linked uses the per-CF latency metrics. The downside is accuracy.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12578235" name="5455.txt" size="42035" author="jbellis" created="Thu, 11 Apr 2013 16:12:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>322472</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 26 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1jmz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>322817</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>