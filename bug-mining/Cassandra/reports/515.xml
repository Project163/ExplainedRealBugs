<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:17:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-1631] dropping column families and keyspaces races with compaction and flushing</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-1631</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description></description>
                <environment></environment>
        <key id="12477746">CASSANDRA-1631</key>
            <summary>dropping column families and keyspaces races with compaction and flushing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gdusbabek">Gary Dusbabek</assignee>
                                    <reporter username="gdusbabek">Gary Dusbabek</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 Oct 2010 14:10:16 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:15 +0000</updated>
                            <resolved>Fri, 5 Nov 2010 21:12:52 +0000</resolved>
                                        <fixVersion>0.7 beta 3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12922728" author="jbellis" created="Tue, 19 Oct 2010 21:29:24 +0000"  >&lt;p&gt;i don&apos;t think 02 actually prevents an update that is making its way through the system pre-drop from causing a flush after the lock is released.  probably setting the memtable to frozen while we hold the lock would fix this.&lt;/p&gt;</comment>
                            <comment id="12922734" author="gdusbabek" created="Tue, 19 Oct 2010 21:37:32 +0000"  >&lt;p&gt;The null check in CFS.maybeSwitchMemtable was intended to handle that, i.e., if the flush goes through after the drop, it ends up doing nothing because the CF def can&apos;t be found.&lt;/p&gt;</comment>
                            <comment id="12922816" author="jbellis" created="Wed, 20 Oct 2010 01:45:15 +0000"  >&lt;p&gt;ah, right.  +1&lt;/p&gt;</comment>
                            <comment id="12923000" author="hudson" created="Wed, 20 Oct 2010 15:14:27 +0000"  >&lt;p&gt;Integrated in Cassandra #571 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra/571/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra/571/&lt;/a&gt;)&lt;br/&gt;
    fix drop race with flush. patch by gdusbabek, reviewed by jbellis. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1631&quot; title=&quot;dropping column families and keyspaces races with compaction and flushing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1631&quot;&gt;&lt;del&gt;CASSANDRA-1631&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
fix drop race with compaction. patch by gdusbabek, reviewed by jbellis. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1631&quot; title=&quot;dropping column families and keyspaces races with compaction and flushing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1631&quot;&gt;&lt;del&gt;CASSANDRA-1631&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12928251" author="jbellis" created="Thu, 4 Nov 2010 15:56:21 +0000"  >&lt;p&gt;This is still a bug with schema updates to an existing CF, since reloadCf is doing a unload/init cycle.  So flushing + compaction is an issue there as well.  Here is a stacktrace from during an index creation where it stubbed its toe on an incomplete sstable from an in-progress compaction (path names anonymized):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; INFO [CompactionExecutor:1] 2010-11-02 16:31:00,553 CompactionManager.java (line 224) Compacting [org.apache.cassandra.io.sstable.SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;Standard1-e-6-Data.db&apos;&lt;/span&gt;),org.apache.cassandra.io.sstable.SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;Standard1-e-7-Data.db&apos;&lt;/span&gt;),org.apache.cassandra.io.sstable.SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;Standard1-e-8-Data.db&apos;&lt;/span&gt;),org.apache.cassandra.io.sstable.SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;Standard1-e-9-Data.db&apos;&lt;/span&gt;)]
...
ERROR [MigrationStage:1] 2010-11-02 16:31:10,939 ColumnFamilyStore.java (line 244) Corrupt sstable Standard1-tmp-e-10-&amp;lt;&amp;gt;=[Data.db, Index.db]; skipped
java.io.EOFException
        at org.apache.cassandra.utils.FBUtilities.skipShortByteArray(FBUtilities.java:308)
        at org.apache.cassandra.io.sstable.SSTable.estimateRowsFromIndex(SSTable.java:231)
        at org.apache.cassandra.io.sstable.SSTableReader.load(SSTableReader.java:286)
        at org.apache.cassandra.io.sstable.SSTableReader.open(SSTableReader.java:202)
        at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:235)
        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:443)
        at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:431)
        at org.apache.cassandra.db.Table.initCf(Table.java:335)
        at org.apache.cassandra.db.Table.reloadCf(Table.java:343)
        at org.apache.cassandra.db.migration.UpdateColumnFamily.applyModels(UpdateColumnFamily.java:89)
        at org.apache.cassandra.db.migration.Migration.apply(Migration.java:158)
        at org.apache.cassandra.thrift.CassandraServer$2.call(CassandraServer.java:672)
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:619)
...
 INFO [CompactionExecutor:1] 2010-11-02 16:31:31,970 CompactionManager.java (line 303) Compacted to Standard1-tmp-e-10-Data.db.  213,657,983 to 213,657,983 (~100% of original) bytes &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 626,563 keys.  Time: 31,416ms.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="12928325" author="gdusbabek" created="Thu, 4 Nov 2010 19:57:08 +0000"  >&lt;p&gt;This isn&apos;t going to be as simple as it was last time (shifting work on to the CompactionManager and blocking).  Part of the unload/init code, you guessed it, shifts work of the CompactionManager and blocks (index creation to be precise).  &lt;/p&gt;

&lt;p&gt;I&apos;m looking into ways of doing this that don&apos;t involve deadlock or refactoring large pieces of code.  Part of the problem is that we&apos;ve started treating the CompactionManager as a way to synchronize access to sstables.  The problem with that is that it is very course and the jobs submitted to it do a lot more things that pure FS work.&lt;/p&gt;</comment>
                            <comment id="12928613" author="gdusbabek" created="Fri, 5 Nov 2010 15:03:24 +0000"  >&lt;p&gt;Realized streaming can be affected by drop/renames as well.&lt;/p&gt;</comment>
                            <comment id="12928822" author="jbellis" created="Fri, 5 Nov 2010 21:12:51 +0000"  >&lt;p&gt;created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1715&quot; title=&quot;More schema migration race conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1715&quot;&gt;&lt;del&gt;CASSANDRA-1715&lt;/del&gt;&lt;/a&gt; for these new bugs&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12476709">CASSANDRA-1585</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12457596" name="ASF.LICENSE.NOT.GRANTED--v1-0001-fix-drop-race-with-compaction.txt" size="7328" author="gdusbabek" created="Tue, 19 Oct 2010 21:14:31 +0000"/>
                            <attachment id="12457597" name="ASF.LICENSE.NOT.GRANTED--v1-0002-fix-drop-race-with-flush.txt" size="2730" author="gdusbabek" created="Tue, 19 Oct 2010 21:14:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[gdusbabek]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20226</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 3 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g6f3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92470</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>