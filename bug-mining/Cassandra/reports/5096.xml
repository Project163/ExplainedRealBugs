<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:12:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14742] Race Condition in batchlog replica collection</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14742</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When we collect nodes for it in &lt;tt&gt;StorageProxy#getBatchlogReplicas&lt;/tt&gt;, we already filter out down replicas; subsequently they get picked up and taken for liveAndDown.&lt;/p&gt;

&lt;p&gt;There&apos;s a possible race condition due to picking tokens from token metadata twice (once in &lt;tt&gt;StorageProxy#getBatchlogReplicas&lt;/tt&gt; and second one in &lt;tt&gt;ReplicaPlan#forBatchlogWrite&lt;/tt&gt;)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13184662">CASSANDRA-14742</key>
            <summary>Race Condition in batchlog replica collection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="ifesdjeen">Alex Petrov</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Wed, 12 Sep 2018 16:18:19 +0000</created>
                <updated>Fri, 15 May 2020 08:02:07 +0000</updated>
                            <resolved>Thu, 27 Sep 2018 16:05:32 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="16617589" author="ifesdjeen" created="Mon, 17 Sep 2018 14:17:42 +0000"  >&lt;p&gt;We&apos;re picking batchlog CL of &lt;tt&gt;ONE&lt;/tt&gt; or &lt;tt&gt;TWO&lt;/tt&gt; since the logic in &lt;tt&gt;BatchlogManager#EndpointFilter&lt;/tt&gt; allows either one node (local, in case of single-node data centers), or two replicas from different racks.&lt;/p&gt;</comment>
                            <comment id="16628602" author="benedict" created="Wed, 26 Sep 2018 11:19:15 +0000"  >&lt;p&gt;Patch looks good overall, just a few nits:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Right now, &lt;tt&gt;ReplicaPlans&lt;/tt&gt; is organised into counter writes, regular writes, regular write utilities, reads, reads utilities; I think it would be cleanest to keep the batch write utilities similarly proximal to the batch writes themselves, for consistency&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;syncWriteBatchedMutations&lt;/tt&gt; and &lt;tt&gt;forBatchlogWrite&lt;/tt&gt; each accept a &lt;tt&gt;localDc&lt;/tt&gt; parameter - this seems a bit weird, since it&apos;s a global variable, and only ever invoked with this (but also, we obtain it inconsistently, by asking the snitch instead of the cached &lt;tt&gt;localDc&lt;/tt&gt;.  Perhaps they should each just use the latter, without requiring it as a parameter?  (I realise this is pre-existing)&lt;/li&gt;
	&lt;li&gt;Unused imports in &lt;tt&gt;ReplicaPlans&lt;/tt&gt;&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16629957" author="ifesdjeen" created="Thu, 27 Sep 2018 08:47:35 +0000"  >&lt;p&gt;Thank you, have addressed all three comments and took a  liberty to introduce &lt;tt&gt;localDatacenter&lt;/tt&gt; and &lt;tt&gt;localRack&lt;/tt&gt; shortcuts, waiting for one more CI run.&lt;/p&gt;</comment>
                            <comment id="16629970" author="benedict" created="Thu, 27 Sep 2018 08:59:08 +0000"  >&lt;p&gt;Thanks.&lt;/p&gt;

&lt;p&gt;I&apos;m a little concerned about the inconsistency of our &lt;tt&gt;DatabaseDescriptor.getLocalDataCenter&lt;/tt&gt; and this &lt;tt&gt;IEndpointSnitch.getLocalDataCenter&lt;/tt&gt;.  I had intended to simply refer to the former (although, debatably, only the latter should exist - since the former is not consistently updated, although it should for correctness never change).&lt;/p&gt;

&lt;p&gt;I&apos;m honestly not clear what the best clean up of this mess is, particularly with the distinction between the per-replication strategy snitch and the global snitch (the former of which seem to simply cache the latter), and perhaps it can be deferred to a later dedicated cleanup ticket anyway.&lt;/p&gt;

&lt;p&gt;Otherwise, +1&lt;/p&gt;</comment>
                            <comment id="16630666" author="ifesdjeen" created="Thu, 27 Sep 2018 16:05:24 +0000"  >&lt;p&gt;Thank you,&lt;/p&gt;

&lt;p&gt;Committed to trunk as &lt;a href=&quot;https://github.com/apache/cassandra/commit/29f83b88821c4792087df19d829ac87b5c06e9e6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;29f83b88821c4792087df19d829ac87b5c06e9e6&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="13183397">CASSANDRA-14697</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 7 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3y0mv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>