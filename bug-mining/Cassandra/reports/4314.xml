<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11886] Streaming will miss sections for early opened sstables during compaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11886</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Once validation compaction has been finished, all mismatching sstable sections for a token range will be used for streaming as return by &lt;tt&gt;StreamSession.getSSTableSectionsForRanges&lt;/tt&gt;. Currently 2.1 will try to restrict the sstable candidates by checking if they can be found in &lt;tt&gt;CANONICAL_SSTABLES&lt;/tt&gt; and will ignore them otherwise. At the same time &lt;tt&gt;IntervalTree&lt;/tt&gt; in the &lt;tt&gt;DataTracker&lt;/tt&gt; will be build based on replaced non-canonical sstables as well. In case of early opened sstables this becomes a problem, as the tree will be update with &lt;tt&gt;OpenReason.EARLY&lt;/tt&gt; replacements that cannot be found in canonical. But whenever &lt;tt&gt;getSSTableSectionsForRanges&lt;/tt&gt; will get a early instance from the view, it will fail to retrieve the corresponding canonical version from the map, as the different generation will cause a hashcode mismatch. Please find a test attached.&lt;/p&gt;

&lt;p&gt;As a consequence not all sections for a range are streamed. In our case this has caused deleted data to reappear, as sections holding tombstones were left out due to this behavior.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12972422">CASSANDRA-11886</key>
            <summary>Streaming will miss sections for early opened sstables during compaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="spod">Stefan Podkowinski</reporter>
                        <labels>
                            <label>correctness</label>
                            <label>repair</label>
                            <label>streaming</label>
                    </labels>
                <created>Tue, 24 May 2016 15:48:03 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:31 +0000</updated>
                            <resolved>Mon, 13 Jun 2016 13:33:44 +0000</resolved>
                                        <fixVersion>2.1.15</fixVersion>
                    <fixVersion>2.2.7</fixVersion>
                    <fixVersion>3.0.8</fixVersion>
                    <fixVersion>3.8</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15298677" author="krummas" created="Tue, 24 May 2016 18:26:30 +0000"  >&lt;p&gt;great find &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=spodxx%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;spodxx@gmail.com&quot;&gt;spodxx@gmail.com&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15300122" author="krummas" created="Wed, 25 May 2016 14:20:25 +0000"  >&lt;p&gt;first stab at this &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/11886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; - I think we can simply skip using the interval tree and just iterate over the raw &lt;tt&gt;CANONICAL_SSTABLES&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15300141" author="krummas" created="Wed, 25 May 2016 14:32:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; do you have time for review of this?&lt;/p&gt;</comment>
                            <comment id="15300244" author="benedict" created="Wed, 25 May 2016 15:41:48 +0000"  >&lt;p&gt;Sure, but probably not for a few days so I can give it some proper attention.&lt;/p&gt;</comment>
                            <comment id="15310116" author="benedict" created="Wed, 1 Jun 2016 10:47:27 +0000"  >&lt;p&gt;So, just to clarify for readers, as far as I can tell the problem is &lt;em&gt;not&lt;/em&gt; the early open files themselves, but the shifted starts of the sstables we&apos;re replacing - which aren&apos;t a problem if we intersect &lt;em&gt;at all&lt;/em&gt; with their shifted instances, but if we move the starts so we no longer notice them, we don&apos;t swap in the canonical instances.&lt;/p&gt;

&lt;p&gt;This patch looks like it will fix the issue to me, but if we&apos;re at all worried about the algorithmic complexity, we &lt;em&gt;should&lt;/em&gt; be able to use the OverlapIterator (that was introduced in 3.0 I think) to improve it (possibly with some minor modification).&lt;/p&gt;</comment>
                            <comment id="15310396" author="krummas" created="Wed, 1 Jun 2016 14:34:48 +0000"  >&lt;p&gt;pushed to all branches below&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/11886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/11886&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-11886-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-11886-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/11886-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/11886-2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-11886-2.2-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-11886-2.2-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/11886-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/11886-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-11886-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-11886-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/11886-3.7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/11886-3.7&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-11886-3.7-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-11886-3.7-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/11886-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/11886-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-11886-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-11886-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I&apos;ll run some benchmarks to see how bad iterating over all sstables gets if we have several thousand sstables to see if we need to do the overlap iterator now or leave that as an improvement in another ticket&lt;/p&gt;</comment>
                            <comment id="15310435" author="benedict" created="Wed, 1 Jun 2016 14:58:10 +0000"  >&lt;p&gt;If running that test, don&apos;t forget to crank up the cluster size and use vnodes, as that will have a large impact.  A cluster with 100 nodes, old skool vnodes and 10k sstables would have 256M iterations (assuming we don&apos;t prune ones that cannot overlap with us, which I hope we do, but wouldn&apos;t assume)&lt;/p&gt;</comment>
                            <comment id="15311908" author="krummas" created="Thu, 2 Jun 2016 08:00:12 +0000"  >&lt;p&gt;Pushed a new commit to the branches above which builds an IntervalTree over the CANONICAL_SSTABLES - this might not be as efficient as using the OverlapIterator, but it should be good enough and is a simpler solution than trying to use the OverlapIterator (imo).&lt;/p&gt;

&lt;p&gt;We should note that the ranges we iterate over are the ranges we are about to stream, not all local ranges (though, I have to say I&apos;m not sure if that makes things better or worse in real life)&lt;/p&gt;</comment>
                            <comment id="15316488" author="benedict" created="Mon, 6 Jun 2016 13:26:33 +0000"  >&lt;p&gt;That makes the cardinality of the set arbitrarily large, so this probably is a good change to make now.&lt;/p&gt;

&lt;p&gt;LGTM, +1&lt;/p&gt;</comment>
                            <comment id="15327371" author="krummas" created="Mon, 13 Jun 2016 13:33:44 +0000"  >&lt;p&gt;committed, thanks&lt;/p&gt;

&lt;p&gt;found &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11996&quot; title=&quot;SSTableSet.CANONICAL can miss sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11996&quot;&gt;&lt;del&gt;CASSANDRA-11996&lt;/del&gt;&lt;/a&gt; while running the tests though, so this is not really fixed for 3.0+ yet&lt;/p&gt;</comment>
                            <comment id="15327384" author="spodxx@gmail.com" created="Mon, 13 Jun 2016 13:39:43 +0000"  >&lt;p&gt;Thanks both of you for responding so quickly and fixing the issue!&lt;/p&gt;</comment>
                            <comment id="15329872" author="pauloricardomg" created="Tue, 14 Jun 2016 16:51:01 +0000"  >&lt;p&gt;It seems testSSTableSectionsForRanges is &lt;a href=&quot;http://cassci.datastax.com/view/cassandra-3.0/job/cassandra-3.0_testall/lastCompletedBuild/testReport/org.apache.cassandra.io.sstable/SSTableRewriterTest/testSSTableSectionsForRanges/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;broken&lt;/a&gt; on 3.0+. I suppose this is the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11996&quot; title=&quot;SSTableSet.CANONICAL can miss sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11996&quot;&gt;&lt;del&gt;CASSANDRA-11996&lt;/del&gt;&lt;/a&gt; broken test you referred to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;? If so, please disregard.&lt;/p&gt;</comment>
                            <comment id="15329897" author="krummas" created="Tue, 14 Jun 2016 17:00:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt; correct, both this test and the test in the ticket are broken because of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11996&quot; title=&quot;SSTableSet.CANONICAL can miss sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11996&quot;&gt;&lt;del&gt;CASSANDRA-11996&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12832268">CASSANDRA-9462</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12842045">CASSANDRA-9700</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12703231">CASSANDRA-6916</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12805911" name="9700-test-2_1.patch" size="5371" author="spod" created="Tue, 24 May 2016 15:48:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 23 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yfi7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333770">2.1.11</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>