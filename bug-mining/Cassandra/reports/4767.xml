<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:07:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13533] ColumnIdentifier object size wrong when tables are not flushed</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13533</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;It turns out that the object size of &lt;tt&gt;ColumnIdentifier&lt;/tt&gt; is wrong when &lt;b&gt;cassandra.test.flush_local_schema_changes: false&lt;/b&gt;. This looks like stuff is being wrongly reused when no flush is happening.&lt;/p&gt;

&lt;p&gt;We only noticed this because we were using the prepared stmt cache and noticed that prepared statements would account for &lt;b&gt;1-6mb&lt;/b&gt; when &lt;b&gt;cassandra.test.flush_local_schema_changes: false&lt;/b&gt;. With &lt;b&gt;cassandra.test.flush_local_schema_changes: true&lt;/b&gt; (which is the default) those would be around &lt;b&gt;5000 bytes&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;Attached is a test that reproduces the problem and also a fix.&lt;/p&gt;

&lt;p&gt;Also after talking to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkni&quot; class=&quot;user-hover&quot; rel=&quot;jkni&quot;&gt;jkni&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; we shouldn&apos;t probably take &lt;tt&gt;ColumnDefinition&lt;/tt&gt; into account when measuring object sizes with &lt;tt&gt;MemoryMeter&lt;/tt&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13072508">CASSANDRA-13533</key>
            <summary>ColumnIdentifier object size wrong when tables are not flushed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="eduard.tudenhoefner">Eduard Tudenhoefner</assignee>
                                    <reporter username="eduard.tudenhoefner">Eduard Tudenhoefner</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 May 2017 16:07:46 +0000</created>
                <updated>Fri, 15 May 2020 08:05:39 +0000</updated>
                            <resolved>Fri, 26 May 2017 19:24:54 +0000</resolved>
                                        <fixVersion>3.0.14</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16012660" author="eduard.tudenhoefner" created="Tue, 16 May 2017 16:19:01 +0000"  >&lt;p&gt;Branch: &lt;a href=&quot;https://github.com/nastra/cassandra/tree/CASSANDRA-13533-30&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/nastra/cassandra/tree/CASSANDRA-13533-30&lt;/a&gt;&lt;br/&gt;
Tests: &lt;a href=&quot;https://circleci.com/gh/nastra/cassandra/tree/CASSANDRA-13533-30&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/nastra/cassandra/tree/CASSANDRA-13533-30&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16013227" author="jjirsa" created="Tue, 16 May 2017 22:48:38 +0000"  >&lt;blockquote&gt;
&lt;p&gt;This looks like stuff is being wrongly reused when no flush is happening&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Obviously that flag is only for unit tests, but can you describe the symptom that led you to finding/fixing this?  &lt;/p&gt;


</comment>
                            <comment id="16013284" author="eduard.tudenhoefner" created="Tue, 16 May 2017 23:59:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; we were using that flag in some of our integration tests where we found out that, &lt;em&gt;very rarely&lt;/em&gt;, simple things (usually taking &amp;lt; 1 second) would take a long amount of time (&amp;gt; 30 seconds). &lt;/p&gt;

&lt;p&gt;We boiled it then down to the point where we saw that this time was 99% spent in the prepared stmt cache for adding/evicting elements. And in our case, eviction was happening because a single prepared stmt would account &lt;b&gt;1mb - 6mb&lt;/b&gt; (prep stmt cache size was &lt;b&gt;8mb&lt;/b&gt; for us). After looking closer why prep stmts would be so large, we eventually saw that the binary representation of &lt;tt&gt;ColumnIdentifier#text&lt;/tt&gt; was be wrong and not what we would have expected (see attached screenshot).&lt;/p&gt;

&lt;p&gt;We also only detected all of this because on &lt;b&gt;cassandra-3.0&lt;/b&gt; we don&apos;t use &lt;b&gt;.omitSharedBufferOverhead()&lt;/b&gt; with &lt;tt&gt;MemoryMeter&lt;/tt&gt; object measurements ( &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/cql3/QueryProcessor.java#L67&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;QueryProcessor.java#L67&lt;/a&gt;). &lt;br/&gt;
On &lt;b&gt;cassandra-3.11&lt;/b&gt; things got refactored over time and the prep stmt cache was using &lt;tt&gt;MemoryMeter&lt;/tt&gt; stuff from &lt;tt&gt;ObjectSizes&lt;/tt&gt;, where &lt;b&gt;.omitSharedBufferOverhead()&lt;/b&gt; is being applied and the issue wouldn&apos;t happen (&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11/src/java/org/apache/cassandra/utils/ObjectSizes.java#L35&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ObjectSizes.java#L35&lt;/a&gt;).&lt;/p&gt;
</comment>
                            <comment id="16023663" author="jkni" created="Wed, 24 May 2017 20:49:51 +0000"  >&lt;p&gt;The patch looks good. I merged this forward through 3.11 and trunk - testall and dtests look good for all branches relative to upstream.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure about including the test as written; it passes on 3.11 and trunk even before the fix because of the default of offheap memtables introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9472&quot; title=&quot;Reintroduce off heap memtables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9472&quot;&gt;&lt;del&gt;CASSANDRA-9472&lt;/del&gt;&lt;/a&gt;. It seems to me that we might as well reduce this test to just checking that interning a ColumnIdentifier uses a minimal bytebuffer and add it to &lt;tt&gt;ColumnIdentifierTest&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16023753" author="jkni" created="Wed, 24 May 2017 21:52:09 +0000"  >&lt;p&gt;As a concrete example, something like the following would suffice to show the interning issue on all active branches.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testInterningUsesMinimalByteBuffer()
    {
        &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[2];
        bytes[0] = 0x63;
        ByteBuffer byteBuffer = ByteBuffer.wrap(bytes);
        byteBuffer.limit(1);

        ColumnIdentifier c1 = ColumnIdentifier.getInterned(byteBuffer, UTF8Type.instance);

        Assert.assertEquals(2, byteBuffer.capacity());
        Assert.assertEquals(1, c1.bytes.capacity());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What do you think, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eduard.tudenhoefner&quot; class=&quot;user-hover&quot; rel=&quot;eduard.tudenhoefner&quot;&gt;eduard.tudenhoefner&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16023856" author="eduard.tudenhoefner" created="Wed, 24 May 2017 23:02:32 +0000"  >&lt;p&gt;that works for me &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jkni&quot; class=&quot;user-hover&quot; rel=&quot;jkni&quot;&gt;jkni&lt;/a&gt;. The test was only there to show that stuff was broken and anything we can do to shorten the circumstances for reproduction is a +1 from my side.&lt;/p&gt;</comment>
                            <comment id="16026719" author="jkni" created="Fri, 26 May 2017 19:24:34 +0000"  >&lt;p&gt;+1 - thanks for the patch. I ran tests for all relevant branches; no unit tests failed on 3.0/3.11/trunk, and dtests looked the same as the present state of those branches.&lt;/p&gt;

&lt;p&gt;Committed to 3.0 as &lt;tt&gt;8ffdd26cbee33c5dc1205c0f7292628e1a2c69e3&lt;/tt&gt; and merged forward.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12868425" name="columnidentifier.png" size="47548" author="eduard.tudenhoefner" created="Tue, 16 May 2017 23:46:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[eduard.tudenhoefner]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3f2d3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12339942">3.0.13</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jkni</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jkni]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>