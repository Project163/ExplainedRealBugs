<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:31:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-20100] Query construction is broken for SAI indexes on reversed types with fixed-length encodings</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-20100</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;SAI indexes values in byte-comparable form, both in the in-memory trie that sits alongside the Memtable, and in the on-disk SSTable-adjacent indexes. In most cases, this means literally using &lt;tt&gt;asComparableBytes()&lt;/tt&gt; from the type of the indexed column. There are, however, a few types that use a custom byte-comparable form, namely &lt;tt&gt;inet&lt;/tt&gt;, &lt;tt&gt;bigint&lt;/tt&gt;, &lt;tt&gt;varint&lt;/tt&gt;, and &lt;tt&gt;decimal&lt;/tt&gt;, to make sure we&apos;re dealing with a fixed-length piece of data for the numeric (balanced tree) index.&lt;/p&gt;

&lt;p&gt;If we index one of these types as a reversed clustering key, however, we don&apos;t write terms as reversed comparable bytes, and this breaks some assumptions during query construction and post-filtering, where we generally assume that &lt;tt&gt;asComparableBytes()&lt;/tt&gt; will reverse terms before they are indexed. We can make a short-term fix here without changing anything about the on-disk format by making sure we interpret these special types as being non-reversed (i.e. through the lens of their base types).&lt;/p&gt;

&lt;p&gt;In the longer term, it might make sense to standardize on indexing everything in a non-reversed fashion in the index itself, although this might push some complexity into post-filtering, where we are going to have to filter data coming out of the normal read path anyway.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13599450">CASSANDRA-20100</key>
            <summary>Query construction is broken for SAI indexes on reversed types with fixed-length encodings</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maedhroz">Caleb Rackliffe</assignee>
                                    <reporter username="maedhroz">Caleb Rackliffe</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Nov 2024 22:55:39 +0000</created>
                <updated>Tue, 7 Jan 2025 21:16:21 +0000</updated>
                            <resolved>Mon, 9 Dec 2024 21:13:07 +0000</resolved>
                                        <fixVersion>5.0.3</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Feature/2i Index</component>
                    <component>Feature/SAI</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="17899899" author="maedhroz" created="Wed, 20 Nov 2024 22:57:10 +0000"  >&lt;p&gt;Kudos to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; and his latest Harry testing efforts in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20080&quot; title=&quot;Harry 2.0, Make it easier to reuse generators, make Harry more extensible and accord-proof, refactor Harry&amp;#39;s major subsystems&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20080&quot;&gt;&lt;del&gt;CASSANDRA-20080&lt;/del&gt;&lt;/a&gt; for finding this and beginning the process of shrinking!&lt;/p&gt;</comment>
                            <comment id="17899915" author="maedhroz" created="Thu, 21 Nov 2024 02:12:21 +0000"  >&lt;p&gt;Note that I&apos;ve pushed the &lt;a href=&quot;https://github.com/apache/cassandra/pull/3702&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk patch&lt;/a&gt; first. It has Harry tests embedded, so it&apos;s good to know if those have issues before creating the 5.0 patch...&lt;/p&gt;

&lt;p&gt;UPDATE: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13073006/13073006_ci_summary.html&quot; title=&quot;ci_summary.html attached to CASSANDRA-20100&quot;&gt;trunk CI&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;  looks pretty clean, with the exception of env-related problems in the Python upgrade tests.&lt;/p&gt;</comment>
                            <comment id="17902755" author="mmarshall" created="Tue, 3 Dec 2024 19:35:31 +0000"  >&lt;p&gt;Is the fundamental problem the truncated types here?&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&amp;gt; inet&lt;/tt&gt;, &lt;tt&gt;bigint&lt;/tt&gt;, &lt;tt&gt;varint&lt;/tt&gt;, and &lt;tt&gt;decimal&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;If so, I have a clarifying question: which bigint are we talking about here? I am not surprised that inet, varint, and decimal had issues because those types are truncated, but I am pretty sure the `bigint` cql type maps to Java&apos;s `Long` type, which does not get truncated.&lt;/p&gt;</comment>
                            <comment id="17902815" author="maedhroz" created="Wed, 4 Dec 2024 02:40:53 +0000"  >&lt;p&gt;&lt;tt&gt;LongType#asComparableBytes()&lt;/tt&gt; uses &lt;tt&gt;ByteSource.variableLengthInteger()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&amp;gt; Is the fundamental problem the truncated types here?&lt;/p&gt;

&lt;p&gt;The nominal problem is that we index a reversed byte-ordered representation when &lt;tt&gt;ReversedType&lt;/tt&gt; is in play for the types we don&apos;t explicitly have to truncate. In any case, I don&apos;t think we ever needed to do this (the reversing, rather than just using the base type comparable bytes). My plan is to file a follow-up Jira that does away with that extra work, while this Jira simply corrects the problems in query construction without changing the on-disk format.&lt;/p&gt;</comment>
                            <comment id="17903189" author="mmarshall" created="Thu, 5 Dec 2024 06:02:14 +0000"  >&lt;p&gt;Thanks for the explanation. I didn&apos;t know about the LongType usage of &lt;tt&gt;variableLengthInteger.&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17903727" author="maedhroz" created="Fri, 6 Dec 2024 18:43:47 +0000"  >&lt;p&gt;5.0 patch is up. CI results &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13073353/13073353_ci_summary-1.html&quot; title=&quot;ci_summary-1.html attached to CASSANDRA-20100&quot;&gt;ci_summary-1.html&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The only failure I&apos;m seeing so far in 5.0 is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18440&quot; title=&quot;Test failure: org.apache.cassandra.distributed.test.RepairTest.testForcedNormalRepairWithOneNodeDown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18440&quot;&gt;&lt;del&gt;CASSANDRA-18440&lt;/del&gt;&lt;/a&gt;. (The upgrade failures are env-specific and have nothing to do with indexing.)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13604135">CASSANDRA-20192</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13073353" name="ci_summary-1.html" size="108832" author="maedhroz" created="Mon, 9 Dec 2024 20:40:17 +0000"/>
                            <attachment id="13073006" name="ci_summary.html" size="113776" author="maedhroz" created="Fri, 22 Nov 2024 04:18:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="13161" cascade-level="1"><![CDATA[Unrecoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12972"><![CDATA[Fuzz Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>CASSANDRA-19224</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1so8w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12355063">5.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/2651623af6bb3da5f820d9e09abfbdd0683a1322&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/2651623af6bb3da5f820d9e09abfbdd0683a1322&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;new tests covering indexes on reversed clustering keys&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>