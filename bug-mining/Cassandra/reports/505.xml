<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:17:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-1609] Cluster restart re-adds removed tokens</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-1609</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After a cluster restart one of our nodes began reporting tokens that had been removed a good while ago (week or more) in it&apos;s nodetool ring output.  This probably has something to do with our change to persist the ring in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1518&quot; title=&quot;remember ring state between restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1518&quot;&gt;&lt;del&gt;CASSANDRA-1518&lt;/del&gt;&lt;/a&gt; and removetoken changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1216&quot; title=&quot;removetoken drops node from ring before re-replicating its data is finished&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1216&quot;&gt;&lt;del&gt;CASSANDRA-1216&lt;/del&gt;&lt;/a&gt;. The node didn&apos;t actually gossip the removed tokens so they showed up in TMD but not gossip.&lt;/p&gt;

&lt;p&gt;Additionally all nodes began reporting a node that had been removed maybe an hour ago.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="12477154">CASSANDRA-1609</key>
            <summary>Cluster restart re-adds removed tokens</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="nickmbailey">Nick Bailey</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Oct 2010 16:49:59 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:15 +0000</updated>
                            <resolved>Wed, 13 Oct 2010 15:57:38 +0000</resolved>
                                        <fixVersion>0.7 beta 3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12920264" author="nickmbailey" created="Tue, 12 Oct 2010 17:24:54 +0000"  >&lt;p&gt;So the first 4 tokens were removed using decomission and the last one using removetoken. It doesn&apos;t look like either of those processes remove nodes from the saved state. The nodes then show up in nodetool ring but not gossip since they don&apos;t actually have an application state to begin with.&lt;/p&gt;</comment>
                            <comment id="12920310" author="nickmbailey" created="Tue, 12 Oct 2010 19:09:01 +0000"  >&lt;p&gt;So it looks like we don&apos;t remove tokens from the system table when we decomission which leads to the following scenario:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Node A has token 1&lt;/li&gt;
	&lt;li&gt;Node A loadbalance to token 2&lt;/li&gt;
	&lt;li&gt;Node A dies&lt;/li&gt;
	&lt;li&gt;Node A removed&lt;/li&gt;
	&lt;li&gt;Cluster restart&lt;/li&gt;
	&lt;li&gt;Node A reappears with token 1 since that was never removed/overwritten in the system table.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;At least i think thats how its happening. Not sure about one of our nodes seeing the four decomissioned tokens and the others not.&lt;/p&gt;</comment>
                            <comment id="12920368" author="jbellis" created="Tue, 12 Oct 2010 21:54:12 +0000"  >&lt;p&gt;ring state management is a mess.  token removal happens in 3 places:&lt;/p&gt;

&lt;p&gt; 1) node receives decommission notice (STATE_LEFT)&lt;br/&gt;
 2) node receives removetoken notice, piggy-backed on STATE_NORMAL&lt;br/&gt;
 3) node coordinates removetoken (gossiper will not trigger notifications for state changes that initiated locally, so this needs to be handled separately from 2)&lt;/p&gt;

&lt;p&gt;2) was updating the SystemTable w/ the removal but the others were not.&lt;/p&gt;

&lt;p&gt;patch attached to move this logic into excise() method and call from all 3 places.&lt;/p&gt;</comment>
                            <comment id="12920426" author="nickmbailey" created="Wed, 13 Oct 2010 03:38:10 +0000"  >&lt;ul&gt;
	&lt;li&gt;handleStateLeft wasn&apos;t actually removing the endpoint from gossip before. Was that an oversight or intended?&lt;/li&gt;
	&lt;li&gt;you removed a check from handleStateLeft to make sure the token was a member before removing it.  Intentional?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12920599" author="jbellis" created="Wed, 13 Oct 2010 15:14:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;handleStateLeft wasn&apos;t actually removing the endpoint from gossip before&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;right, that was a bug.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;you removed a check from handleStateLeft to make sure the token was a member&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;yes, we skip the check everywhere else because either way the result is the same.  there&apos;s no meaningful action we can take if the check fails so it&apos;s redundant.&lt;/p&gt;</comment>
                            <comment id="12920616" author="nickmbailey" created="Wed, 13 Oct 2010 15:53:02 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12920621" author="jbellis" created="Wed, 13 Oct 2010 15:57:38 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="12920947" author="hudson" created="Thu, 14 Oct 2010 12:49:47 +0000"  >&lt;p&gt;Integrated in Cassandra #565 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra/565/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra/565/&lt;/a&gt;)&lt;br/&gt;
    fix removing tokens from SystemTable on decommission and removetoken.&lt;br/&gt;
patch by jbellis; reviewed by Nick Bailey for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1609&quot; title=&quot;Cluster restart re-adds removed tokens&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1609&quot;&gt;&lt;del&gt;CASSANDRA-1609&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12457019" name="1609.txt" size="3739" author="jbellis" created="Tue, 12 Oct 2010 21:54:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20215</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g6a7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92448</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>nickmbailey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[nickmbailey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>