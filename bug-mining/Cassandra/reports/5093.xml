<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:12:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14766] DESC order reads can fail to return the last Unfiltered in the partition in a legacy sstable</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14766</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;tt&gt;OldFormatDeserializer&lt;/tt&gt;&#8217;s &lt;tt&gt;hasNext()&lt;/tt&gt; method can and will consume two &lt;tt&gt;Unfiltered&lt;/tt&gt; from the underlying iterator in some scenarios - intentionally.&lt;/p&gt;

&lt;p&gt;But in doing that it&#8217;s losing intermediate state of &lt;tt&gt;lastConsumedPosition&lt;/tt&gt;. If that last block, when iterating backwards, only has two &lt;tt&gt;Unfiltered&lt;/tt&gt;, the first one will be returned, and the last one won&#8217;t as the reverse iterator would incorrectly things that the deserisalizer is past the index block, despite still having one &lt;tt&gt;Unfiltered&lt;/tt&gt; unreturned.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13186036">CASSANDRA-14766</key>
            <summary>DESC order reads can fail to return the last Unfiltered in the partition in a legacy sstable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Sep 2018 11:26:07 +0000</created>
                <updated>Fri, 2 Aug 2019 02:53:11 +0000</updated>
                            <resolved>Tue, 25 Sep 2018 16:08:30 +0000</resolved>
                                        <fixVersion>3.0.18</fixVersion>
                    <fixVersion>3.11.4</fixVersion>
                                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16627426" author="iamaleksey" created="Tue, 25 Sep 2018 14:12:11 +0000"  >&lt;p&gt;3.0: &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/14766-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/workflow-run/b86af556-5675-4a83-8de8-21941175608f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;br/&gt;
3.11: &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/14766-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/workflow-run/d23b37c9-225a-4e13-85fd-484bda81c37b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;br/&gt;
A small dtest for illustration (in addition to a regression unit test in C* repo) can be found &lt;a href=&quot;https://github.com/iamaleksey/cassandra-dtest/commits/14766&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16627448" author="benedict" created="Tue, 25 Sep 2018 14:30:18 +0000"  >&lt;p&gt;one tiny nit: should probably set &lt;tt&gt;couldBeStartOfPartition = false&lt;/tt&gt; outside of the &lt;tt&gt;if&lt;/tt&gt; branch, so we don&apos;t unnecessarily perform the RT tests.  &lt;/p&gt;

&lt;p&gt;It shouldn&apos;t have any impact besides possibly some probably immeasurable performance cost, but probably better that way.&lt;/p&gt;</comment>
                            <comment id="16627453" author="beobal" created="Tue, 25 Sep 2018 14:38:53 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;The fact that we&apos;re now resetting &lt;tt&gt;couldBeStartOfPartition&lt;/tt&gt; in &lt;tt&gt;clearState&lt;/tt&gt;, which wasn&apos;t done before probably fixes an overlooked edge case in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13236&quot; title=&quot;corrupt flag error after upgrade from 2.2 to 3.0.10&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13236&quot;&gt;&lt;del&gt;CASSANDRA-13236&lt;/del&gt;&lt;/a&gt;.&#160;We greedily read the static row in &lt;tt&gt;AbstractSSTableIterator&lt;/tt&gt;&apos;s constructor, where &lt;tt&gt;isFirst&lt;/tt&gt; (&lt;tt&gt;couldBeStartOfPartition&lt;/tt&gt; as was) would trigger the swapping in the presence of the required tombstone. &lt;tt&gt;IndexState::setToBlock&lt;/tt&gt; attempts to skip past the static row if we end up iterating backward to block 0 so we don&apos;t re-read the static row, but without resetting this flag it would only skip past the RT, leaving the statics to be read next which would then hit the the error from 13236.&lt;/p&gt;</comment>
                            <comment id="16627454" author="iamaleksey" created="Tue, 25 Sep 2018 14:39:33 +0000"  >&lt;p&gt;Argh. You are right. Not sure how I missed it. Pushed the updates.&lt;/p&gt;</comment>
                            <comment id="16627512" author="benedict" created="Tue, 25 Sep 2018 15:22:28 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16627573" author="iamaleksey" created="Tue, 25 Sep 2018 16:08:13 +0000"  >&lt;p&gt;Thanks. Committed to 3.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/45937def313bbb32024ae890f830e23bcc6ccae5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;45937def313bbb32024ae890f830e23bcc6ccae5&lt;/a&gt; and merged to 3.11, and with &lt;tt&gt;-s ours&lt;/tt&gt; into trunk.&lt;/p&gt;

&lt;p&gt;Dtest committed as &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/02c1cd77439b220a09df1d53891441bb80dcf944&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;02c1cd77439b220a09df1d53891441bb80dcf944&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;NOTE: I did fold &lt;tt&gt;iterator.hasNext()&lt;/tt&gt; check into the if-branch above on commit, to remove one extra level of nesting from the code.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12987" cascade-level="1"><![CDATA[Transient Incorrect Response]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12972"><![CDATA[Fuzz Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 8 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3y92v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
        <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>