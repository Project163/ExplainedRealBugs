<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13115] Read repair is not blocking repair to finish in foreground repair</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13115</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The code trying to wait(block) for repair result to come back in 3.X is below:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;DataResolver.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void close()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
            {
                FBUtilities.waitOnFutures(repairResults, DatabaseDescriptor.getWriteRpcTimeout());
            }
            &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (TimeoutException ex)
            {
                &lt;span class=&quot;code-comment&quot;&gt;// We got all responses, but timed out &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; repairing
&lt;/span&gt;                &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; blockFor = consistency.blockFor(keyspace);
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (Tracing.isTracing())
                    Tracing.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Timed out &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; read-repairing after receiving all {} data and digest responses&quot;&lt;/span&gt;, blockFor);
                &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                    logger.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Timeout &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; read-repairing after receiving all {} data and digest responses&quot;&lt;/span&gt;, blockFor);

                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ReadTimeoutException(consistency, blockFor-1, blockFor, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in DataResolver class, but this close method is never called and it&apos;s also not auto close(RepairMergeListener is not extending from AutoCloseable/CloseableIterator) which means we never wait for repair to finish before returning final result. &lt;/p&gt;

&lt;p&gt;The steps to reproduce:&lt;br/&gt;
1. create some keyspace/table with RF = 2&lt;br/&gt;
2. start 2 nodes using ccm&lt;br/&gt;
3. stop node2&lt;br/&gt;
4. disable node1 hinted hand off&lt;br/&gt;
5. write some data to node1 with consistency level one&lt;br/&gt;
6. start node2&lt;br/&gt;
7. query some data from node1 &lt;br/&gt;
This should trigger read repair. I put some log in above close method, and can not see log print put.&lt;/p&gt;

&lt;p&gt;So this bug will basically violate &quot;monotonic quorum reads &quot; guarantee. &lt;/p&gt;</description>
                <environment>&lt;p&gt;ccm on OSX &lt;/p&gt;</environment>
        <key id="13033546">CASSANDRA-13115</key>
            <summary>Read repair is not blocking repair to finish in foreground repair</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="xiaolong302@gmail.com">Xiaolong Jiang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 Jan 2017 23:00:16 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:11 +0000</updated>
                            <resolved>Thu, 19 Jan 2017 15:55:59 +0000</resolved>
                                        <fixVersion>3.0.11</fixVersion>
                    <fixVersion>3.10</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15817856" author="rha" created="Wed, 11 Jan 2017 10:00:03 +0000"  >&lt;p&gt;I don&apos;t understand why you say it violates quorum reads, with RF=2 &lt;tt&gt;QUORUM == 2&lt;/tt&gt; i.e. like &lt;tt&gt;ALL&lt;/tt&gt;. &lt;br/&gt;
But you read with &lt;tt&gt;ONE / LOCAL_ONE&lt;/tt&gt; when doing &lt;tt&gt;7. query some data from node1&lt;/tt&gt;, don&apos;t you? &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This should trigger read repair. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Background read repair because of CL &lt;tt&gt;ONE&lt;/tt&gt;, right? &lt;br/&gt;
Did you set &lt;tt&gt;dclocal_read_repair_chance/read_repair_chance = 1.0&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="15819814" author="xiaolong302@gmail.com" created="Thu, 12 Jan 2017 01:32:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rha&quot; class=&quot;user-hover&quot; rel=&quot;rha&quot;&gt;rha&lt;/a&gt;Please check this &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10726&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-10726&lt;/a&gt; for more context and also see Jonathan&apos;s comments.&lt;/p&gt;</comment>
                            <comment id="15820580" author="slebresne" created="Thu, 12 Jan 2017 09:34:34 +0000"  >&lt;p&gt;You&apos;re absolutely right, this is clearly wrong, thanks for noticing.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching the pretty trivial fix. Now, while looking at this, I realized we were also not handling &quot;asynchronous read repairs&quot; properly as we were not consuming the result of &lt;tt&gt;resolve()&lt;/tt&gt; in that case. So a 2nd commit fixes that part (also fairly trivial).&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/13115-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13115-3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-13115-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-13115-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/13115-3.X&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13115-3.X&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-13115-3.X-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-13115-3.X-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15826926" author="xiaolong302@gmail.com" created="Tue, 17 Jan 2017 22:12:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;Thanks for fixing this. I went through both changes and it looks good to me. Can you please merge both patches? Thanks!!&lt;/p&gt;</comment>
                            <comment id="15829888" author="jasobrown" created="Thu, 19 Jan 2017 13:12:18 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15830140" author="slebresne" created="Thu, 19 Jan 2017 15:55:59 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12994431">CASSANDRA-12368</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38ixj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>