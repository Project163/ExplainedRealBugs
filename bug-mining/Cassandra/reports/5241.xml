<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:14:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15332] When repair is running with tracing, if a CorruptSSTableException is thrown while building Merkle Trees the DiskFailurePolicy does not get applied</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15332</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When a repair is in the validation phase and is building MerkleTrees, if a corrupt SSTable exception is thrown the disk failure policy does not get applied&lt;/p&gt;</description>
                <environment></environment>
        <key id="13258071">CASSANDRA-15332</key>
            <summary>When repair is running with tracing, if a CorruptSSTableException is thrown while building Merkle Trees the DiskFailurePolicy does not get applied</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dcapwell">David Capwell</assignee>
                                    <reporter username="dcapwell">David Capwell</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Sat, 21 Sep 2019 01:31:14 +0000</created>
                <updated>Fri, 15 May 2020 08:39:02 +0000</updated>
                            <resolved>Fri, 15 Nov 2019 17:18:37 +0000</resolved>
                                        <fixVersion>4.0-alpha3</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Repair</component>
                    <component>Observability/Tracing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="16934870" author="dcapwell" created="Sat, 21 Sep 2019 01:32:15 +0000"  >&lt;p&gt;Found with the following in-JVM dtest:&#160;&lt;a href=&quot;https://github.com/dcapwell/cassandra/blob/repairDtest/test/distributed/org/apache/cassandra/distributed/test/FailingRepairTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dcapwell/cassandra/blob/repairDtest/test/distributed/org/apache/cassandra/distributed/test/FailingRepairTest.java&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16951444" author="dcapwell" created="Tue, 15 Oct 2019 00:50:44 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;diff&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;tests&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/repairCorruption&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...dcapwell:repairCorruption&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;diff&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/760a2f16-1084-4cf4-b789-008c7e325602&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;




&lt;p&gt;Changes:&lt;/p&gt;

&lt;p&gt;1)&#160;JVMStabilityInspector checks for corruption or FSError and delegates to FileUtils for handling&lt;/p&gt;

&lt;p&gt;2) FileUtils now implements the die behavior&lt;/p&gt;

&lt;p&gt;3)&#160;JVMStabilityInspector now walks suppressed exceptions as well as the caused exception (edge case not in streaming where the second exception is fserror or corruption, so just added since saw suppression was common)&lt;/p&gt;

&lt;p&gt;4) dtest updated to keep track of the number of kill attempts (though does not kill, mostly so tests can reuse the cluster)&lt;/p&gt;</comment>
                            <comment id="16953317" author="jrwest" created="Thu, 17 Oct 2019 01:57:48 +0000"  >&lt;p&gt;Mostly minor its and optional suggestions but the first comment I think is important to address:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;In the uncaught exception handler setup by &lt;tt&gt;CassandraDaemon&lt;/tt&gt;, it looks like we no longer log the &lt;tt&gt;FSError&lt;/tt&gt;/&lt;tt&gt;CorruptSSTableException&lt;/tt&gt; exactly once if its a cause instead of the original. In particular, the &lt;tt&gt;FSError&lt;/tt&gt;/&lt;tt&gt;CorruptSStableException&lt;/tt&gt; are not logged at all now if they are a cause and the disk failure policy is not &lt;tt&gt;die&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;It would be beneficial for tests to not have to be aware of/call &lt;tt&gt;InstanceKiller#clear()&lt;/tt&gt;. Maybe call it immediately after its set in &lt;tt&gt;Instance#startup&lt;/tt&gt;?&lt;/li&gt;
	&lt;li&gt;It could be useful to future test authors if you document the returns values from `IInstance#killAttempts()` given the comment in the &lt;tt&gt;AbstractCluster.Wrapper&lt;/tt&gt; implementation.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;Instance#killAttempts()&lt;/tt&gt;: use &lt;tt&gt;callOnInstance(&#8230;)&lt;/tt&gt; instead of &lt;tt&gt;callsOnInstance(&#8230;).call()&lt;/tt&gt;.&lt;br/&gt;
* &lt;tt&gt;ForwardingSSTableReader&lt;/tt&gt; constructor: is there a reason you explicitly call &lt;tt&gt;addComponents&lt;/tt&gt; vs. passing the result of &lt;tt&gt;SSTable.componentsFor(descriptor.delegate)&lt;/tt&gt; to &lt;tt&gt;super&lt;/tt&gt;? Testing locally: all the new tests pass with the latter change made. &#8232;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;FailingRepairTest#L114-115&lt;/tt&gt;: so its not accidentally missed, consider making these changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15356&quot; title=&quot;CassandraEntireSSTableStreamWriter throws IOException rather than FSError for disk issues so doesn&amp;#39;t get handled by disk failing policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15356&quot;&gt;CASSANDRA-15356&lt;/a&gt; instead of leaving them commented out here&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;JVMStabilityInspector#L91-92&lt;/tt&gt;: the comment is somewhat contextual to the original code being changed here, perhaps &#8220;its expected the fs handler will kill the jvm if unstable&#8221; is sufficient?&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;FailingRepairTest#L220&lt;/tt&gt;: minor typo, &#8220;expected&#8221;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;FailingRepairTest#L221&lt;/tt&gt;: You can use &lt;tt&gt;callOnInstance&lt;/tt&gt; instead of &lt;tt&gt;callsOnInstance(...).call()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;FailingRepairTest#L238&lt;/tt&gt;: this failure message could be a bit more descriptive, e.g. &#8220;repair return status was 0, expected non-zero return status, 0 indicates repair not submitted&#8221;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;FailingRepairTest#testFailingMessage&lt;/tt&gt;: consider using the &lt;tt&gt;replica&lt;/tt&gt; and &lt;tt&gt;coordinator&lt;/tt&gt; variables throughout the function &#8212; some initial node lookups explicitly use &lt;tt&gt;1&lt;/tt&gt; &amp;amp; &lt;tt&gt;2&lt;/tt&gt; to identify nodes.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;FailingRepairTest#L240-244/253-254&lt;/tt&gt;: +1 on the &#8220;wait until&#8221; approach. It could be useful to pull these out into utility methods for others to use and to add a timeout &#8212; I see the test itself has a timeout but adding the control to the &#8220;wait until&#8221; methods could be indicative for future test authors.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;FailingRepairTest#L248&lt;/tt&gt;: consider making the failure message more descriptive, e.g. &#8220;Expected FAILED repair status, but status was: &lt;span class=&quot;error&quot;&gt;&amp;#91;status&amp;#93;&lt;/span&gt;&#8221;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;FailingRepairTest#L257&lt;/tt&gt;: typo, &#8220;coordinator&#8221;&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;Also, while we are updating &lt;tt&gt;OutOfSpaceTest&lt;/tt&gt;, some minor improvements you might consider:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;testFlushUnwritableStop should also check the native transports have been disabled and that the killer was not invoked&lt;/li&gt;
	&lt;li&gt;testFlushUnwritableIgnore: consider checking that things that would happen on die or stop don&#8217;t happen (e.g. native transport/gossip are still running and killer was not invoked).&lt;/li&gt;
	&lt;li&gt;can the makeTable() calls in each test be moved to a @Before or @BeforeClass?&lt;/li&gt;
	&lt;li&gt;L125: use ColumnFamilyStore#forceBlockingFlush instead of ColumnFamilyStore.forceFlush().get()&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16953849" author="dcapwell" created="Thu, 17 Oct 2019 15:27:40 +0000"  >&lt;blockquote&gt;
&lt;p&gt;In the uncaught exception handler setup by CassandraDaemon, it looks like we no longer log the FSError/CorruptSSTableException exactly once if its a cause instead of the original. In particular, the FSError/CorruptSStableException are not logged at all now if they are a cause and the disk failure policy is not die.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The following will log it, though I do admit the logging is changed&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
logger.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;Exception in thread &quot;&lt;/span&gt; + t, e);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are 3 cases (all will be logged)&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;FSError/CorruptSStableException are the root exception, then behavior is basically not changed&lt;/li&gt;
	&lt;li&gt;FSError/CorruptSStableException is the cause of the exception, behavior is changed but the cause by section will show this&lt;/li&gt;
	&lt;li&gt;FSError/CorruptSStableException is suppressed, the behavior is unchanged in this scenario&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16953873" author="dcapwell" created="Thu, 17 Oct 2019 16:01:57 +0000"  >&lt;blockquote&gt;
&lt;p&gt;It would be beneficial for tests to not have to be aware of/call InstanceKiller#clear(). Maybe call it immediately after its set in Instance#startup?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sorry, I don&apos;t follow.  Do you mean these tests or in general?  InstanceKiller is local to the instance (class loader isolation in dtest) so if tests create new clusters for each test case (the norm so far) then the state is reset in each test.&lt;/p&gt;

&lt;p&gt;Now, in these tests, I rely on a shared cluster, so I don&apos;t teardown between test cases.  This causes the killed count to be incremented multiple times for each test case, so each test case needs to clear it (since the cluster is shared state).&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;It could be useful to future test authors if you document the returns values from `IInstance#killAttempts()` given the comment in the AbstractCluster.Wrapper implementation.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Done.&lt;/p&gt;


&lt;blockquote&gt;
&lt;p&gt;Instance#killAttempts(): use callOnInstance(&#8230;) instead of callsOnInstance(&#8230;).call().&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Done&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;* ForwardingSSTableReader constructor: is there a reason you explicitly call addComponents vs. passing the result of SSTable.componentsFor(descriptor.delegate) to super? Testing locally: all the new tests pass with the latter change made. &#8232;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Changed.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;FailingRepairTest#L114-115: so its not accidentally missed, consider making these changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15356&quot; title=&quot;CassandraEntireSSTableStreamWriter throws IOException rather than FSError for disk issues so doesn&amp;#39;t get handled by disk failing policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15356&quot;&gt;CASSANDRA-15356&lt;/a&gt; instead of leaving them commented out here&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Fair.  I tried working on this and streaming requires the die policy in order to have the coordinator detect the issue, so need to actually shutdown the instance (even though the test is &quot;die&quot;, dtest treats it as &quot;ignore&quot;; was complicated to shutdown on InstanceKiller and share the state that it was killed for tests).&lt;/p&gt;

&lt;p&gt;I really should refactor this test to go through all policies, but ill try doing that in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15356&quot; title=&quot;CassandraEntireSSTableStreamWriter throws IOException rather than FSError for disk issues so doesn&amp;#39;t get handled by disk failing policy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15356&quot;&gt;CASSANDRA-15356&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fixed. Removed all code for streaming.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;JVMStabilityInspector#L91-92: the comment is somewhat contextual to the original code being changed here, perhaps &#8220;its expected the fs handler will kill the jvm if unstable&#8221; is sufficient?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Switched to &quot;disk failure policy is handled by FileUtils, so delegate&quot;&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;FailingRepairTest#L220: minor typo, &#8220;expected&#8221;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;fixed&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;FailingRepairTest#L221: You can use callOnInstance instead of callsOnInstance(...).call()&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;done&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;FailingRepairTest#L238: this failure message could be a bit more descriptive, e.g. &#8220;repair return status was 0, expected non-zero return status, 0 indicates repair not submitted&#8221;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;fixed&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;FailingRepairTest#testFailingMessage: consider using the replica and coordinator variables throughout the function &#8212; some initial node lookups explicitly use 1 &amp;amp; 2 to identify nodes.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;fixed&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;FailingRepairTest#L240-244/253-254: +1 on the &#8220;wait until&#8221; approach. It could be useful to pull these out into utility methods for others to use and to add a timeout &#8212; I see the test itself has a timeout but adding the control to the &#8220;wait until&#8221; methods could be indicative for future test authors.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My personal style is to not create generic utilities until there is the second case, so would prefer not.  &lt;/p&gt;

&lt;p&gt;This is more of a case of &quot;retry until&quot; which I see as its own generic utility, though don&apos;t know if C* has that for me to reuse?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;FailingRepairTest#L248: consider making the failure message more descriptive, e.g. &#8220;Expected FAILED repair status, but status was: &lt;span class=&quot;error&quot;&gt;&amp;#91;status&amp;#93;&lt;/span&gt;&#8221;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Don&apos;t I get that for free since I am using assertEquals?  The message block is mostly because the status is hidden in the array, so in some cases the array has more details.&lt;/p&gt;


&lt;blockquote&gt;
&lt;p&gt;FailingRepairTest#L257: typo, &#8220;coordinator&#8221;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;With all the code moving around... I think I fixed it =D&lt;/p&gt;</comment>
                            <comment id="16953874" author="dcapwell" created="Thu, 17 Oct 2019 16:02:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16953965" author="jrwest" created="Thu, 17 Oct 2019 17:44:10 +0000"  >&lt;p&gt;Thanks for making the changes. They LGTM. +1&lt;/p&gt;</comment>
                            <comment id="16956104" author="krummas" created="Mon, 21 Oct 2019 13:43:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;if a corrupt SSTable exception is thrown the disk failure policy does not get applied&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Looks like the reason for this is that we don&apos;t set the uncaught exception handler in the in-jvm dtests - adding the same one as in &lt;tt&gt;CassandraDaemon&lt;/tt&gt; in &lt;tt&gt;Instance#startup&lt;/tt&gt; makes us invoke the policy when there is a corrupt sstable during validation.&lt;/p&gt;</comment>
                            <comment id="16956123" author="dcapwell" created="Mon, 21 Oct 2019 14:00:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; I see that for streaming but repair is getting caught and put into the futures failure case; so never makes it to the default handler (nothing uses the future later)&lt;/p&gt;</comment>
                            <comment id="16956129" author="krummas" created="Mon, 21 Oct 2019 14:04:54 +0000"  >&lt;p&gt;it gets called via &lt;tt&gt;CompactionExecutor#afterExecute&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/compaction/CompactionManager.java#L1807&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/compaction/CompactionManager.java#L1807&lt;/a&gt; -&amp;gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/concurrent/DebuggableThreadPoolExecutor.java#L248&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/concurrent/DebuggableThreadPoolExecutor.java#L248&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16956151" author="dcapwell" created="Mon, 21 Oct 2019 14:23:37 +0000"  >&lt;p&gt;Thanks, I&apos;ll try to replicate later.&lt;/p&gt;</comment>
                            <comment id="16956480" author="dcapwell" created="Mon, 21 Oct 2019 22:01:03 +0000"  >&lt;p&gt;Synced with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt;&#160;and turns out we are both correct.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The tests added to this Jira run with tracing enabled where as&#160;Marcus&apos; test ran without tracing; turns out the issue in the description happens when tracing is enabled.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Ill repurpose this Jira to fix tracing, and update the tests to run with and without tracing.&lt;/p&gt;</comment>
                            <comment id="16956514" author="dcapwell" created="Mon, 21 Oct 2019 23:05:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt;&#160;I pushed a change to my branch based off the finding that tracing is the root cause; I reverted all changed to src/java and replaced with a fix to&#160;DebuggableThreadPoolExecutor. &#160;I also updated the test to run with and without tracing.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I prefer the changes I made to JVMStabilityInspector but they are no longer relevant to this Jira, so will open a different Jira and apply those changes there.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Please review again, thanks!&lt;/p&gt;</comment>
                            <comment id="16956517" author="dcapwell" created="Mon, 21 Oct 2019 23:06:46 +0000"  >&lt;p&gt;I updated the Jira title to better reflect the issue.&lt;/p&gt;</comment>
                            <comment id="16959982" author="dcapwell" created="Fri, 25 Oct 2019 18:45:44 +0000"  >&lt;p&gt;Found out that my change only got execute to work, and that submit had the same behavior with and without tracing (that the exception is lost).&lt;/p&gt;

&lt;p&gt;I rewrote my patch to make sure execute and submit methods matches the behavior of normal ExecutorService calls, but did not loose the underline exception. &lt;/p&gt;

&lt;p&gt;I also added documentation to help explain how this works, though its rather ugly so the documentation may not be enough.&lt;/p&gt;

&lt;p&gt;Let me know what you think.&lt;/p&gt;</comment>
                            <comment id="16962837" author="krummas" created="Wed, 30 Oct 2019 09:17:17 +0000"  >&lt;p&gt;this lgtm, left a few minor comments on the PR&lt;/p&gt;</comment>
                            <comment id="16963240" author="dcapwell" created="Wed, 30 Oct 2019 17:12:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; I pushed all changes based off your feedback.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt; can you re-review?  The changes to src/java are completely different since your last review, so good to look at that again (tests are mostly the same, small changes)&lt;/p&gt;</comment>
                            <comment id="16972932" author="jrwest" created="Wed, 13 Nov 2019 01:17:59 +0000"  >&lt;p&gt;LGTM. Sorry for the delay.&#160;&lt;/p&gt;</comment>
                            <comment id="16973766" author="dcapwell" created="Wed, 13 Nov 2019 22:39:08 +0000"  >&lt;p&gt;thanks!  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; everything good then?&lt;/p&gt;

&lt;p&gt;Thanks everyone for the reviews!&lt;/p&gt;</comment>
                            <comment id="16975262" author="krummas" created="Fri, 15 Nov 2019 17:18:37 +0000"  >&lt;p&gt;committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12998" cascade-level="1"><![CDATA[Other Exception]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z06vq0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jwest]]></customfieldvalue>
        <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326275">2.1 beta1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/c98a31bef0d3071bc8ebfd358584aadf9e787fb8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/c98a31bef0d3071bc8ebfd358584aadf9e787fb8&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;diff&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;tests&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;pr&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/repairCorruption&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...dcapwell:repairCorruption&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;diff&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/dcapwell/workflows/cassandra/tree/repairCorruption&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/368&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pr&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;




&lt;p&gt;Changes:&lt;/p&gt;

&lt;p&gt;1)&#160;JVMStabilityInspector checks for corruption or FSError and delegates to FileUtils for handling&lt;/p&gt;

&lt;p&gt;2) FileUtils now implements the die behavior&lt;/p&gt;

&lt;p&gt;3)&#160;JVMStabilityInspector now walks suppressed exceptions as well as the caused exception (edge case not in streaming where the second exception is fserror or corruption, so just added since saw suppression was common)&lt;/p&gt;

&lt;p&gt;4) dtest updated to keep track of the number of kill attempts (though does not kill, mostly so tests can reuse the cluster)&lt;/p&gt;

&lt;p&gt;Test case added which causes a corruption exception to be thrown from a SSTable during validation and shows that the handling makes its way to JVMStabilities kill instance method.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>