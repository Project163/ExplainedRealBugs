<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:54:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9486] LazilyCompactedRow accumulates all expired RangeTombstones</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9486</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;LazilyCompactedRow initializes a ColumnIndex.Builder to use its RangeTombstone.Tracker, but it only calls update() with a RT argument, never an atom. The Tracker only ever &lt;em&gt;adds&lt;/em&gt; if it receives a RT, never removes. So all the RT ever seen for the partition (that have expired) remain in memory until the compaction completes. To make matters worse, this then forces a linear scan of all of these RT for each live cell we add, so this extra load hangs around for a long time, and compactions stall.&lt;/p&gt;

&lt;p&gt;This issue is biting one of our users badly (at least, it seems likely to be this issue), and there may be others. This user is not even making use of RT extensively themselves, only collections (presumably with a complete overwrite of the contents of the collection, resulting in a RT being generated).&lt;/p&gt;

&lt;p&gt;Probably the best solution is to make the RT addition itself remove any already present that are no longer helpful.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12832837">CASSANDRA-9486</key>
            <summary>LazilyCompactedRow accumulates all expired RangeTombstones</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 May 2015 19:38:24 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:09 +0000</updated>
                            <resolved>Wed, 3 Jun 2015 13:24:57 +0000</resolved>
                                        <fixVersion>2.0.16</fixVersion>
                    <fixVersion>2.1.6</fixVersion>
                    <fixVersion>2.2.0 rc1</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14564674" author="krummas" created="Fri, 29 May 2015 12:05:03 +0000"  >&lt;p&gt;patch to not keep the expired RT&apos;s around forever&lt;/p&gt;</comment>
                            <comment id="14564675" author="krummas" created="Fri, 29 May 2015 12:05:46 +0000"  >&lt;p&gt;against 2.0&lt;/p&gt;</comment>
                            <comment id="14564699" author="benedict" created="Fri, 29 May 2015 12:22:00 +0000"  >&lt;p&gt;I think the problem will still be present, because the update() method only removes from the &lt;tt&gt;ranges&lt;/tt&gt; collection when it receives a regular atom. However the removal logic could be run on RT addition as well (if we add a RT that begins after the prior one ends, it should be okay to remove it..?)&lt;/p&gt;</comment>
                            <comment id="14564801" author="krummas" created="Fri, 29 May 2015 13:26:27 +0000"  >&lt;p&gt;Unless I misunderstand your description, we do update(...) the normal cells as well, in ColumnIndex.Builder.add(...);&lt;/p&gt;

&lt;p&gt;But, I guess, if you have a very wide partition with &quot;only&quot; range tombstones, you can hit this, will add some remove logic when adding a RT as well&lt;/p&gt;</comment>
                            <comment id="14564833" author="benedict" created="Fri, 29 May 2015 13:44:55 +0000"  >&lt;p&gt;If you have only RTs, or a run of nothing but RTs you&apos;ll have a problem, sure.&lt;/p&gt;

&lt;p&gt;However more pressing is that during repair we never call &lt;tt&gt;indexBuilder.add&lt;/tt&gt; with the atoms, only with RTs. At least, AFAICT. We only call &lt;tt&gt;indexBuilder.buildForCompaction&lt;/tt&gt; inside of &lt;tt&gt;LCR.write()&lt;/tt&gt;; in &lt;tt&gt;LCR.update(MessageDigest)&lt;/tt&gt; we ultimately call &lt;tt&gt;getReduced()&lt;/tt&gt; directly, which only invokes &lt;tt&gt;indexBuilder.add&lt;/tt&gt; with RTs.&lt;/p&gt;</comment>
                            <comment id="14565056" author="benedict" created="Fri, 29 May 2015 16:53:21 +0000"  >&lt;p&gt;FTR, looking at the thread dump I have from the user encountering this, it looks like the &quot;nothing but RTs&quot; is exactly the problem. &lt;/p&gt;

&lt;p&gt;It appears that we only call &lt;tt&gt;add()&lt;/tt&gt; with an atom in the &lt;em&gt;outer&lt;/em&gt; loop (in ColumnIndex), never in getReduced. If the tombstones always shadow the live data, we never end up calling it, so we accumulate every tombstone. i.e., an infinite length sequence of (tombstone, data) is flattened into an infinite accumulation of tombstone. The problem here is that this is exactly the workload characteristic of collection overwrites, which is what this user is doing (as are presumably many others).&lt;/p&gt;
</comment>
                            <comment id="14565059" author="benedict" created="Fri, 29 May 2015 16:56:45 +0000"  >&lt;p&gt;Raising priority, since it seems like this problem can affect a lot of users and significantly harm cluster stability.&lt;/p&gt;</comment>
                            <comment id="14565179" author="krummas" created="Fri, 29 May 2015 18:25:56 +0000"  >&lt;p&gt;patch here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/krummas/cassandra/commit/ca642b829a4b104a8b2f99601d60ab30e17c5907&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commit/ca642b829a4b104a8b2f99601d60ab30e17c5907&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;dtests etc should be up soon&lt;/p&gt;</comment>
                            <comment id="14566955" author="krummas" created="Mon, 1 Jun 2015 05:44:37 +0000"  >&lt;p&gt;patch updated to only clear expired rts: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/9486&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/9486&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;tests: &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-9486-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-9486-dtest/&lt;/a&gt; &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-9486-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-9486-testall/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;edit: nope, this is also broken, too early, stand by for new patch&lt;/p&gt;</comment>
                            <comment id="14566992" author="krummas" created="Mon, 1 Jun 2015 06:54:17 +0000"  >&lt;p&gt;ok, new patch here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/9486&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/9486&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Keeps the expired set to avoid having to iterate over all range tombstones, but makes sure we clear out any expired RTs that cannot cover data anymore&lt;/p&gt;</comment>
                            <comment id="14567277" author="slebresne" created="Mon, 1 Jun 2015 13:07:20 +0000"  >&lt;p&gt;As Benedict mentions above, expired tombstone are only part of the problem, and we have 2 other problems: 1) only cells &quot;trim&quot; the tracker and 2) we don&apos;t pass shadowed cells to the tracker. As a result, if we have many RT and the only cells we have are deleted by those RT, all RT ends up accumulated, even if we wouldn&apos;t need to. Let&apos;s maybe fix it all here.&lt;/p&gt;

&lt;p&gt;On top of that, the tracker class is admittedly a bit ugly already and adding more special casing for expired tombstones doesn&apos;t particularly help. So I&apos;ve pushed &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/9486&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; a suggested alternative that solves the problems described above and, I think, simplify the code in the process (partly thanks to commenting it).&lt;/p&gt;</comment>
                            <comment id="14567491" author="benedict" created="Mon, 1 Jun 2015 16:06:03 +0000"  >&lt;p&gt;LGTM, but I&apos;d prefer it if we switched maxOrderingSet to a LinkedList, and used its ListIterator to iterate and modify the list in one pass, since these changes eliminate the benefits of maintaining the TreeSet, and make that a trivial further change.&lt;/p&gt;</comment>
                            <comment id="14568806" author="slebresne" created="Tue, 2 Jun 2015 09:00:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;we switched maxOrderingSet to a LinkedList&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Make sense, I&apos;ve pushed the update. I&apos;ll wait for the CI to run on it and commit, unless you have remarks on that last versions.&lt;/p&gt;</comment>
                            <comment id="14568827" author="benedict" created="Tue, 2 Jun 2015 09:24:55 +0000"  >&lt;p&gt;LGTM. There&apos;s a double &quot;in&quot; (i.e. &quot;in in&quot;) in one of your comment modifications. Also, &lt;tt&gt;insertBefore&lt;/tt&gt; doesn&apos;t need to call &lt;tt&gt;next()&lt;/tt&gt; for the behaviour here, but not at all fussed since the semantics of an arbitrary method labelled &lt;tt&gt;insertBefore&lt;/tt&gt; might well want to do so.&lt;/p&gt;</comment>
                            <comment id="14569175" author="slebresne" created="Tue, 2 Jun 2015 14:40:06 +0000"  >&lt;p&gt;I had actually forgot one &quot;add&quot; in &lt;tt&gt;update&lt;/tt&gt; which was breaking tests. I&apos;ve pushed the fix and I&apos;ll wait once the tests have ran.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;the semantics of an arbitrary method labelled insertBefore might well want to do so&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, felt more logical so makes hypothetical future misuse of the method less likely.&lt;/p&gt;</comment>
                            <comment id="14569721" author="thebrenthaines" created="Tue, 2 Jun 2015 20:45:16 +0000"  >&lt;p&gt;FWIW &amp;#8211; I created a patch from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;&apos;s proposed fix, tested it locally and tried it on one of our impacted nodes in our data cluster. We are running 2.1.5, but the variance was easy to sift through. &lt;/p&gt;

&lt;p&gt;Compactions that used to take a day finished in 30 seconds. We haven&apos;t seen any spikes in heap space either, but that will take more time to evaluate. I do not know if there are any residual or unexpected behaviors resulting from the patch yet. We&apos;ll leave it in place for a few days to see. In the mean time, I thought it might help to confirm that this does indeed seem to fix our issue.&lt;/p&gt;

&lt;p&gt;Now, if we can stop creating so many RT&apos;s in the first place... &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="14570800" author="slebresne" created="Wed, 3 Jun 2015 13:24:57 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12764113">CASSANDRA-8547</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12735788">CASSANDRA-7810</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12736124" name="0001-9486.patch" size="2421" author="marcuse" created="Fri, 29 May 2015 12:05:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 24 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2f7wf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327240">1.2.19</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>