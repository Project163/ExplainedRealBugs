<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:31 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13226] StreamPlan for incremental repairs flushing memtables unnecessarily</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13226</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Since incremental repairs are run against a fixed dataset, there&apos;s no need to flush memtables when streaming for them.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13043394">CASSANDRA-13226</key>
            <summary>StreamPlan for incremental repairs flushing memtables unnecessarily</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bdeggleston">Blake Eggleston</assignee>
                                    <reporter username="bdeggleston">Blake Eggleston</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Feb 2017 21:50:45 +0000</created>
                <updated>Fri, 15 May 2020 08:00:43 +0000</updated>
                            <resolved>Fri, 17 Feb 2017 22:00:55 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15868642" author="bdeggleston" created="Wed, 15 Feb 2017 21:59:25 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/13226&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/bdeggleston/job/bdeggleston-13226-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/bdeggleston/job/bdeggleston-13226-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The only functional change is in &lt;tt&gt;src/java/org/apache/cassandra/repair/StreamingRepairTask.java&lt;/tt&gt;, everything else is just rearranging some of the base repair test classes to make testing unit testing the change possible / easier.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt;: could one of you review?&lt;/p&gt;</comment>
                            <comment id="15871301" author="krummas" created="Fri, 17 Feb 2017 06:58:24 +0000"  >&lt;p&gt;+1 - maybe just add a comment why we don&apos;t need to flush on incremental repairs?&lt;/p&gt;</comment>
                            <comment id="15872606" author="bdeggleston" created="Fri, 17 Feb 2017 22:00:56 +0000"  >&lt;p&gt;committed as c878b6968be88fa89fb1d1d0212411bcbc4fae7c&lt;/p&gt;</comment>
                            <comment id="15887654" author="brstgt" created="Tue, 28 Feb 2017 09:29:11 +0000"  >&lt;p&gt;Isn&apos;t this also true for non-incremental repairs?&lt;br/&gt;
Merkle tree calculation also triggers a flush and any repair begins with a merkle tree. So there is no need to flush as the inconsistent dataset to be streamed for repair is always contained in SSTables flushed by MT calculation before.&lt;/p&gt;</comment>
                            <comment id="15887945" author="brstgt" created="Tue, 28 Feb 2017 13:01:08 +0000"  >&lt;p&gt;I am referring to this &quot;stacktrace&quot;:&lt;/p&gt;

&lt;p&gt;RepairMessageVerbHandler.doVerb (case VALIDATION_REQUEST)&lt;br/&gt;
CompactionManager.instance.submitValidation(store, validator) &lt;br/&gt;
CompactionManager.doValidationCompaction&lt;br/&gt;
=&amp;gt; StorageService.instance.forceKeyspaceFlush&lt;/p&gt;

&lt;p&gt;After that merkle trees are calculated and based on that streams are triggered. Thats why all data that is electable for transfer has already been flushed.&lt;/p&gt;

&lt;p&gt;Also avoiding a flush locally is only the half way. Streams REQUESTED by a stream plan also cause a flush on the sender side. But that sender also has already validated (and so flushed) the requested data.&lt;/p&gt;

&lt;p&gt;Maybe I missed sth but from what I can see, a REPAIR stream never requires a flush.&lt;/p&gt;</comment>
                            <comment id="15887961" author="brstgt" created="Tue, 28 Feb 2017 13:07:36 +0000"  >&lt;p&gt;Sorry for that many comments, just another thought:&lt;/p&gt;

&lt;p&gt;Flushes can be optimized very easily in that way that a flush is only executed if the memtable contains mutations for the requested range OR if the memtable exceeds a certain size, so that the check is still cheap. I implemented this just for fun some months ago but did never create a ticket for it.&lt;/p&gt;

&lt;p&gt;See patch here &lt;a href=&quot;https://github.com/Jaumo/cassandra/commit/983514b0d3e15cea042533273ead5ea33c00bacf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Jaumo/cassandra/commit/983514b0d3e15cea042533273ead5ea33c00bacf&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Just saw it also disabled pre-repair flush as proposed before.&lt;/p&gt;</comment>
                            <comment id="15938562" author="bdeggleston" created="Thu, 23 Mar 2017 15:23:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brstgt&quot; class=&quot;user-hover&quot; rel=&quot;brstgt&quot;&gt;brstgt&lt;/a&gt; I think the idea behind flushing on stream for full is that you&apos;ll be streaming even more recent data than when the merkle tree was generated, which there&apos;s really no harm in doing.&lt;/p&gt;</comment>
                            <comment id="15938577" author="brstgt" created="Thu, 23 Mar 2017 15:32:52 +0000"  >&lt;p&gt;That does not make sense to me. Why should be streamed more than requested? Sounds like waste of resources to me. Streaming more than a repair requires assumes that the system is still creating inconsistent data during the repair.&lt;/p&gt;</comment>
                            <comment id="15938617" author="pauloricardomg" created="Thu, 23 Mar 2017 15:54:13 +0000"  >&lt;p&gt;I think the idea behind flushing on stream was to send the most up-to-date data during bootstrap/rebuild/decommission/replace, but this doesn&apos;t apply to repair since you will end up overstreaming non-validated data as pointed out by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brstgt&quot; class=&quot;user-hover&quot; rel=&quot;brstgt&quot;&gt;brstgt&lt;/a&gt;. In any case this minor improvement is subject to another ticket since this ticket is already closed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 34 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3a4xj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>