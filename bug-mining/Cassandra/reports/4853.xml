<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:08:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13776] Adding a field to an UDT can corrupte the tables using it</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13776</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Adding a field to an UDT which is used as a &lt;tt&gt;Set&lt;/tt&gt; element or as a &lt;tt&gt;Map&lt;/tt&gt; element can corrupt the table.&lt;br/&gt;
The problem can be reproduced using the following test case:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testReadAfterAlteringUserTypeNestedWithinSet() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
    {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; ut1 = createType(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TYPE %s (a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; columnType = KEYSPACE + &lt;span class=&quot;code-quote&quot;&gt;&quot;.&quot;&lt;/span&gt; + ut1;

        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
        {
            createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (x &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PRIMARY KEY, y set&amp;lt;frozen&amp;lt;&quot;&lt;/span&gt; + columnType + &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;gt;&amp;gt;)&quot;&lt;/span&gt;);
            disableCompaction();

            execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (x, y) VALUES(1, ?)&quot;&lt;/span&gt;, set(userType(1), userType(2)));
            assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s&quot;&lt;/span&gt;), row(1, set(userType(1), userType(2))));
            flush();

            assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE x = 1&quot;&lt;/span&gt;),
                       row(1, set(userType(1), userType(2))));

            execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;ALTER TYPE &quot;&lt;/span&gt; + KEYSPACE + &lt;span class=&quot;code-quote&quot;&gt;&quot;.&quot;&lt;/span&gt; + ut1 + &lt;span class=&quot;code-quote&quot;&gt;&quot; ADD b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&quot;&lt;/span&gt;);
            execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE %s SET y = y + ? WHERE x = 1&quot;&lt;/span&gt;,
                    set(userType(1, 1), userType(1, 2), userType(2, 1)));

            flush();
            assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE x = 1&quot;&lt;/span&gt;),
                           row(1, set(userType(1),
                                      userType(1, 1),
                                      userType(1, 2),
                                      userType(2),
                                      userType(2, 1))));

            compact();

            assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE x = 1&quot;&lt;/span&gt;),
                       row(1, set(userType(1),
                                  userType(1, 1),
                                  userType(1, 2),
                                  userType(2),
                                  userType(2, 1))));
        }
        &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt;
        {
            enableCompaction();
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;There are in fact 2 problems:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;When the &lt;tt&gt;sets&lt;/tt&gt; from the 2 versions are merged the &lt;tt&gt;ColumnDefinition&lt;/tt&gt; being picked up can be the older one. In which case when the tuples are sorted it my lead to an &lt;tt&gt;IndexOutOfBoundsException&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;During compaction, the old column definition can be the one being kept for the SSTable metadata. If it is the case the SSTable will not be readable any more and will be marked as &lt;tt&gt;corrupted&lt;/tt&gt;.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;If one of the tables using the type has a Materialized View attached to it, the MV updates can also fail with &lt;tt&gt;IndexOutOfBoundsException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This problem can be reproduced using the following test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testAlteringUserTypeNestedWithinSetWithView() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
    {
        &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; columnType = typeWithKs(createType(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TYPE %s (a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)&quot;&lt;/span&gt;));

        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (pk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, v &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, s set&amp;lt;frozen&amp;lt;&quot;&lt;/span&gt; + columnType + &lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;gt;&amp;gt;, PRIMARY KEY (pk, c))&quot;&lt;/span&gt;);
        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE MATERIALIZED VIEW &quot;&lt;/span&gt; + keyspace() + &lt;span class=&quot;code-quote&quot;&gt;&quot;.view1 AS SELECT c, pk, v FROM %s WHERE pk IS NOT NULL AND c IS NOT NULL AND v IS NOT NULL PRIMARY KEY (c, pk)&quot;&lt;/span&gt;);

        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (pk, c, v, s) VALUES(?, ?, ?, ?)&quot;&lt;/span&gt;, 1, 1, 1, set(userType(1), userType(2)));
        flush();

        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;ALTER TYPE &quot;&lt;/span&gt; + columnType + &lt;span class=&quot;code-quote&quot;&gt;&quot; ADD b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&quot;&lt;/span&gt;);
        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE %s SET s = s + ?, v = ? WHERE pk = ? AND c = ?&quot;&lt;/span&gt;,
                set(userType(1, 1), userType(1, 2), userType(2, 1)), 2, 1, 1);


        assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE pk = ? AND c = ?&quot;&lt;/span&gt;, 1, 1),
                       row(1, 1, 2, set(userType(1),
                                        userType(1, 1),
                                        userType(1, 2),
                                        userType(2),
                                        userType(2, 1))));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;      </description>
                <environment></environment>
        <key id="13095594">CASSANDRA-13776</key>
            <summary>Adding a field to an UDT can corrupte the tables using it</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="blerer">Benjamin Lerer</reporter>
                        <labels>
                    </labels>
                <created>Fri, 18 Aug 2017 09:34:05 +0000</created>
                <updated>Fri, 15 May 2020 08:04:54 +0000</updated>
                            <resolved>Thu, 24 Aug 2017 16:33:30 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16136801" author="blerer" created="Tue, 22 Aug 2017 13:32:12 +0000"  >&lt;p&gt;I pushed the patches for &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...blerer:13776-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...blerer:13776-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:13776-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;br/&gt;
I ran the tests on our internal CI and the failing tests look unrelated to the patches.&lt;/p&gt;</comment>
                            <comment id="16138392" author="snazy" created="Wed, 23 Aug 2017 14:01:45 +0000"  >&lt;p&gt;Nice work, Benjamin!&lt;br/&gt;
The new unit tests cover the issue.&lt;/p&gt;

&lt;p&gt;Just a few things:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We should order on an array (or ArrayList) in {{SerializationHeader.orderByDescendingGeneration()} and use &quot;static&quot; comparator instances&lt;/li&gt;
	&lt;li&gt;Checks on component count are mussing for tuples and composites in &lt;tt&gt;AbstractTypeVersionComparator&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Test should cover all type &quot;types&quot; in &lt;tt&gt;AbstractTypeVersionComparatorTest&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Pushed some commits &lt;a href=&quot;https://github.com/snazy/cassandra/commits/13776-3.0-review&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;+1 with the above changes. CI (internal one) looks good.&lt;/p&gt;</comment>
                            <comment id="16140269" author="blerer" created="Thu, 24 Aug 2017 16:33:30 +0000"  >&lt;p&gt;Committed into 3.0 at cf0b6d107bade419dada49a5da40d2579c80ade8 and merged into 3.11 and trunk&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="13117962">CASSANDRA-14010</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="13161" cascade-level="1"><![CDATA[Unrecoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 12 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3iy6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>snazy</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>