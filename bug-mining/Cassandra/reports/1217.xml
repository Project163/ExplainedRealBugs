<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:24:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3344] Compaction throttling can be too slow</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3344</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Compaction throttling needs to know how many active compactions are running (to divide bandwith for each active compaction).&lt;/p&gt;

&lt;p&gt;The way active compaction is counted can be broken because it counts the number of active threads in the executor BUT the thread starts by acquiring a lock.&lt;br/&gt;
If the lock can&apos;t be acquired immediately : the thread is seen as &quot;active&quot; but does not participate in IO operations.&lt;br/&gt;
The case can happen when major compaction are triggered (major compaction acquire a write lock, while minor compactions acquire a read lock).&lt;/p&gt;

&lt;p&gt;Having compaction througput to 16Mb/s, we observed is the following  (two times) :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;only 1 active compaction (a long one for a few hours) starting at 16Mb/s, then after some time running at 2Mb/s, thus taking a very long time to complete&lt;/li&gt;
	&lt;li&gt;many pending compactions&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Using JMX and monitoring the stack trace of the compaction threads showed that :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1 thread was effectively compacting&lt;/li&gt;
	&lt;li&gt;1 thread was waiting to acquire the write lock (due to a major compaction)&lt;/li&gt;
	&lt;li&gt;6 threads were waiting to acquire the read lock (probably due to the thread above trying to acquire the write lock)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Attached is a proposed patch (very simple, not yet tested) which counts only active compactions.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12526640">CASSANDRA-3344</key>
            <summary>Compaction throttling can be too slow</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="frousseau">Fabien Rousseau</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Oct 2011 10:29:52 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:48 +0000</updated>
                            <resolved>Fri, 14 Oct 2011 08:55:18 +0000</resolved>
                                        <fixVersion>0.8.8</fixVersion>
                    <fixVersion>1.0.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13124948" author="slebresne" created="Tue, 11 Oct 2011 11:50:29 +0000"  >&lt;p&gt;Good diagnostic, I think you are right that this can happen. However the patch seems to replace the body of getActiveCompactions() by a recursive call to itself.&lt;/p&gt;</comment>
                            <comment id="13124961" author="slebresne" created="Tue, 11 Oct 2011 12:09:48 +0000"  >&lt;p&gt;Attaching a simple patch to add a counter that we only increment once we really do compaction.&lt;/p&gt;</comment>
                            <comment id="13124970" author="frousseau" created="Tue, 11 Oct 2011 12:19:50 +0000"  >&lt;p&gt;Thanks for catching that.&lt;br/&gt;
The intent was to return the size of the CompactionExecutor.compactions list&lt;/p&gt;</comment>
                            <comment id="13124973" author="slebresne" created="Tue, 11 Oct 2011 12:27:29 +0000"  >&lt;p&gt;Right, that&apos;s indeed even simpler. Attaching v2 to do that instead.&lt;/p&gt;</comment>
                            <comment id="13127247" author="jbellis" created="Fri, 14 Oct 2011 02:18:45 +0000"  >&lt;p&gt;+1 v2&lt;/p&gt;</comment>
                            <comment id="13127370" author="slebresne" created="Fri, 14 Oct 2011 08:55:18 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="13127388" author="hudson" created="Fri, 14 Oct 2011 09:21:48 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #372 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/372/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/372/&lt;/a&gt;)&lt;br/&gt;
    Only count compaction as active (for throttling) once the compaction lock has been acquired.&lt;br/&gt;
patch by Fabien Rousseau and slebresne; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3344&quot; title=&quot;Compaction throttling can be too slow&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3344&quot;&gt;&lt;del&gt;CASSANDRA-3344&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;slebresne : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1183241&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1183241&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/compaction/CompactionManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12498568" name="001-CASSANDRA-3344.patch" size="1053" author="frousseau" created="Tue, 11 Oct 2011 10:31:11 +0000"/>
                            <attachment id="12498586" name="3344.patch" size="2208" author="slebresne" created="Tue, 11 Oct 2011 12:09:48 +0000"/>
                            <attachment id="12498587" name="3344_v2.patch" size="998" author="slebresne" created="Tue, 11 Oct 2011 12:27:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>59005</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 6 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0girb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94469</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>