<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:22:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-17085] commit log was switched from non-daemon to daemon threads, which causes the JVM to exit in some case as no non-daemon threads are active</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-17085</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Right now bootstrap tests are failing every time we run, this work is to debug and fix the underling issue.&lt;/p&gt;

&lt;p&gt;Examples:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1062/workflows/ba3e6395-ef22-4724-8424-0549e65d8cff/jobs/7089&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1062/workflows/ba3e6395-ef22-4724-8424-0549e65d8cff/jobs/7089&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt;       node3.nodetool(&lt;span class=&quot;code-quote&quot;&gt;&apos;bootstrap resume&apos;&lt;/span&gt;)

bootstrap_test.py:1014: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../env3.6/lib/python3.6/site-packages/ccmlib/node.py:1005: in nodetool
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; handle_external_tool_process(p, [&lt;span class=&quot;code-quote&quot;&gt;&apos;nodetool&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;-h&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;localhost&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;-p&apos;&lt;/span&gt;, str(self.jmx_port)] + shlex.split(cmd))
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

process = &amp;lt;subprocess.Popen object at 0x7fb071a03940&amp;gt;
cmd_args = [&lt;span class=&quot;code-quote&quot;&gt;&apos;nodetool&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;-h&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;localhost&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;-p&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;7300&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;bootstrap&apos;&lt;/span&gt;, ...]

    def handle_external_tool_process(process, cmd_args):
        out, err = process.communicate()
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (out is not None) and isinstance(out, bytes):
            out = out.decode()
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (err is not None) and isinstance(err, bytes):
            err = err.decode()
        rc = process.returncode
    
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; rc != 0:
&amp;gt;           raise ToolError(cmd_args, rc, out, err)
E           ccmlib.node.ToolError: Subprocess [&lt;span class=&quot;code-quote&quot;&gt;&apos;nodetool&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;-h&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;localhost&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;-p&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;7300&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;bootstrap&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;resume&apos;&lt;/span&gt;] exited with non-zero status; exit status: 1; 
E           stderr: nodetool: Failed to connect to &lt;span class=&quot;code-quote&quot;&gt;&apos;localhost:7300&apos;&lt;/span&gt; - EOFException: &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&apos;&lt;/span&gt;.

../env3.6/lib/python3.6/site-packages/ccmlib/node.py:2305: ToolError
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1062/workflows/ba3e6395-ef22-4724-8424-0549e65d8cff/jobs/7087&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1062/workflows/ba3e6395-ef22-4724-8424-0549e65d8cff/jobs/7087&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&amp;gt;       node1.start()

bootstrap_test.py:483: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
../env3.6/lib/python3.6/site-packages/ccmlib/node.py:895: in start
    node.watch_log_for_alive(self, from_mark=mark)
../env3.6/lib/python3.6/site-packages/ccmlib/node.py:664: in watch_log_for_alive
    self.watch_log_for(tofind, from_mark=from_mark, timeout=timeout, filename=filename)
../env3.6/lib/python3.6/site-packages/ccmlib/node.py:592: in watch_log_for
    head=reads[:50], tail=&lt;span class=&quot;code-quote&quot;&gt;&quot;...&quot;&lt;/span&gt;+reads[len(reads)-150:]))
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

start = 1635453190.3118386, timeout = 120
msg = &lt;span class=&quot;code-quote&quot;&gt;&quot;Missing: [&lt;span class=&quot;code-quote&quot;&gt;&apos;127.0.0.1:7000.* is now UP&apos;&lt;/span&gt;] not found in system.log:\n Head: \n Tail: ...&quot;&lt;/span&gt;
node = &lt;span class=&quot;code-quote&quot;&gt;&apos;node3&apos;&lt;/span&gt;

    @staticmethod
    def raise_if_passed(start, timeout, msg, node=None):
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; start + timeout &amp;lt; time.time():
&amp;gt;           raise TimeoutError.create(start, timeout, msg, node)
E           ccmlib.node.TimeoutError: 28 Oct 2021 20:35:10 [node3] after 120.12/120 seconds Missing: [&lt;span class=&quot;code-quote&quot;&gt;&apos;127.0.0.1:7000.* is now UP&apos;&lt;/span&gt;] not found in system.log:
E            Head: 
E            Tail: ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13409179">CASSANDRA-17085</key>
            <summary>commit log was switched from non-daemon to daemon threads, which causes the JVM to exit in some case as no non-daemon threads are active</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dcapwell">David Capwell</assignee>
                                    <reporter username="dcapwell">David Capwell</reporter>
                        <labels>
                    </labels>
                <created>Fri, 29 Oct 2021 19:08:48 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:48 +0000</updated>
                            <resolved>Wed, 3 Nov 2021 20:08:07 +0000</resolved>
                                        <fixVersion>4.1-alpha1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                                    <component>Test/dtest/python</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="17436995" author="dcapwell" created="Mon, 1 Nov 2021 19:31:46 +0000"  >&lt;p&gt;Here is what I am seeing in bootstrap_test.py::TestBootstrap::test_bootstrap_with_reset_bootstrap_state&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
      node3 = new_node(cluster)
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;:
            node3.start()
        except NodeError:
            pass  # node doesn&apos;t start as expected
        t.join()
        node1.start()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;node1.start checks all the alive nodes (according to ccm) to see if node1 is seen as up in the logs.  node3 is dead (or dying), so it should not be included in the watch set&lt;/p&gt;

&lt;p&gt;I was able to repro the issue when I limit the environment to 2 cores; trying a patch where we force shutdown node3 before starting node1 to avoid ccm checking node3&apos;s logs&lt;/p&gt;</comment>
                            <comment id="17437032" author="dcapwell" created="Mon, 1 Nov 2021 21:36:36 +0000"  >&lt;p&gt;bootstrap_test.py::TestBootstrap::test_bootstrap_binary_disabled also fails with the following&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;:
            node3.nodetool(&lt;span class=&quot;code-quote&quot;&gt;&apos;join&apos;&lt;/span&gt;)
            pytest.fail(&lt;span class=&quot;code-quote&quot;&gt;&apos;nodetool should have errored and failed to join ring&apos;&lt;/span&gt;)
        except ToolError as t:
&amp;gt;           &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot join the ring until bootstrap completes&quot;&lt;/span&gt; in t.stdout
E           &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;Cannot join the ring until bootstrap completes&apos;&lt;/span&gt; in &apos;&apos;
E            +  where &lt;span class=&quot;code-quote&quot;&gt;&apos;&apos; = ToolError(&lt;span class=&quot;code-quote&quot;&gt;&quot;Subprocess [&apos;&lt;/span&gt;nodetool&lt;span class=&quot;code-quote&quot;&gt;&apos;, &apos;&lt;/span&gt;-h&lt;span class=&quot;code-quote&quot;&gt;&apos;, &apos;&lt;/span&gt;localhost&lt;span class=&quot;code-quote&quot;&gt;&apos;, &apos;&lt;/span&gt;-p&lt;span class=&quot;code-quote&quot;&gt;&apos;, &apos;&lt;/span&gt;7300&lt;span class=&quot;code-quote&quot;&gt;&apos;, &apos;&lt;/span&gt;join&lt;span class=&quot;code-quote&quot;&gt;&apos;] exited with non-zero status; exit status: 1; \nstderr: nodetool: Failed to connect to &apos;&lt;/span&gt;localhost:7300&lt;span class=&quot;code-quote&quot;&gt;&apos; - SocketException: &apos;&lt;/span&gt;Connection reset&apos;.\n&quot;&lt;/span&gt;,).stdout
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In both cases it looks like issue connecting to JMX.  Logs for node3 don&apos;t show the process going down during the test so not sure what&apos;s up yet.  This is localhost networking so shouldn&apos;t have random connection close events, so not sure what leads to this flaky behavior yet.&lt;/p&gt;</comment>
                            <comment id="17437062" author="dcapwell" created="Mon, 1 Nov 2021 23:19:42 +0000"  >&lt;p&gt;bootstrap_test.py::TestBootstrap::test_bootstrap_binary_disabled  is more complex it seems, something is causing the JVM to do a graceful shutdown; is see the following in the node3 logs&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN  [main] 2021-11-01 22:43:33,212 CassandraDaemon.java:663 - Not starting client transports in write_survey mode as it&apos;s bootstrapping or auth is enabled
INFO  [main] 2021-11-01 22:43:33,212 CassandraDaemon.java:764 - Startup complete
INFO  [StorageServiceShutdownHook] 2021-11-01 22:43:33,219 HintsService.java:233 - Paused hints dispatch
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I enhanced the test to log where it is out, so I can correlate test and server logs&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
22:43:35,415 bootstrap_test INFO Attempting to resume bootstrap on node3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;So, I see that we start a graceful shutdown at 22:43:33,219, and the test tries to resume bootstrap at 22:43:35,415; 2 seconds AFTER we started shutdown.  I don&apos;t see us doing a shutdown in the test; and this fails 100% of the time for me, so we always seem to do a graceful shutdown for some reason...&lt;/p&gt;</comment>
                            <comment id="17437072" author="dcapwell" created="Mon, 1 Nov 2021 23:41:04 +0000"  >&lt;p&gt;Added the following to CassandraDaemon to detect if System.exit is getting called; it doesn&apos;t look to be&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.setSecurityManager(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;SecurityManager&lt;/span&gt;()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void checkExit(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; status)
            {
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.err.println(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(&quot;&lt;/span&gt;+status+&lt;span class=&quot;code-quote&quot;&gt;&quot;)) callled&quot;&lt;/span&gt;);
                &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Throwable(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.exit(&quot;&lt;/span&gt;+status+&lt;span class=&quot;code-quote&quot;&gt;&quot;)) callled&quot;&lt;/span&gt;).printStackTrace();
            }
        });
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So something else looks to be causing the JVM to halt.&lt;/p&gt;</comment>
                            <comment id="17437077" author="dcapwell" created="Mon, 1 Nov 2021 23:56:36 +0000"  >&lt;p&gt;Ok I think I figured out the issue; we have no daemon threads running..&lt;/p&gt;

&lt;p&gt;updated drain to log threads&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void drain(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isFinalShutdown) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException, InterruptedException, ExecutionException
    {
        logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;drain({})&quot;&lt;/span&gt;, isFinalShutdown);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isFinalShutdown)
        {
            Map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;, StackTraceElement[]&amp;gt; traces = &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.getAllStackTraces();
            List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; nonDaemonThreads = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Entry&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;, StackTraceElement[]&amp;gt; e : traces.entrySet())
            {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (e.getKey().isDaemon())
                    &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
                nonDaemonThreads.add(e.getKey().getName());
            }
            logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Non-daemon threads: {}&quot;&lt;/span&gt;, nonDaemonThreads);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This produces&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  [StorageServiceShutdownHook] 2021-11-01 23:54:50,181 StorageService.java:5003 - Non-daemon threads: [DestroyJavaVM, StorageServiceShutdownHook]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17437450" author="dcapwell" created="Tue, 2 Nov 2021 16:10:20 +0000"  >&lt;p&gt;Here is what I see different than 4.0&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ diff 40.txt trunk.txt
4,5c4
&amp;lt; COMMIT-LOG-ALLOCATOR    &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&amp;lt; CacheCleanupExecutor:1    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
---
&amp;gt; COMMIT-LOG-ALLOCATOR    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
10d8
&amp;lt; GossipStage:1    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
12,14d9
&amp;lt; HintsDispatcher:1    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&amp;lt; HintsDispatcher:2    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&amp;lt; HintsWriteExecutor:1    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
23d17
&amp;lt; MigrationStage:1    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
27c21
&amp;lt; PERIODIC-COMMIT-LOG-SYNCER    &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
---
&amp;gt; PERIODIC-COMMIT-LOG-SYNCER    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
37d30
&amp;lt; SecondaryIndexManagement:1    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
40,42c33
&amp;lt; ValidationExecutor:1    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&amp;lt; ValidationExecutor:2    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&amp;lt; ViewBuildExecutor:1    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
---
&amp;gt; SnapshotCleanup:1    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
45a37
&amp;gt; read-hotness-tracker:1    &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This was collected as the last step in main, so just scans every thread and checks if daemon or not&lt;/p&gt;

&lt;p&gt;the non-daemon threads in 40 are: nioEventLoopGroup-5-1, PERIODIC-COMMIT-LOG-SYNCER, and COMMIT-LOG-ALLOCATOR&lt;/p&gt;

&lt;p&gt;but in trunk it is only: nioEventLoopGroup-5-1&lt;/p&gt;

&lt;p&gt;seems PERIODIC-COMMIT-LOG-SYNCER and COMMIT-LOG-ALLOCATOR went daemon; will try to track down where.&lt;/p&gt;

&lt;p&gt;PeriodicCommitLogService:&lt;br/&gt;
40: NamedThreadFactory.createThread(new SyncRunnable(MonotonicClock.preciseTime), name) // daemon=false&lt;br/&gt;
trunk: executorFactory().infiniteLoop(name, new SyncRunnable(MonotonicClock.preciseTime), true); // daemon=true in org.apache.cassandra.concurrent.ExecutorFactory.Default#startThread&lt;/p&gt;

&lt;p&gt;AbstractCommitLogSegmentManager&lt;br/&gt;
40: NamedThreadFactory.createThread(runnable, &quot;COMMIT-LOG-ALLOCATOR&quot;); // daemon=false&lt;br/&gt;
trunk: executorFactory().infiniteLoop(&quot;COMMIT-LOG-ALLOCATOR&quot;, runnable, true, interruptHandler); // daemon=true&lt;/p&gt;

&lt;p&gt;These two were changed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16925&quot; title=&quot;Task Execution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16925&quot;&gt;&lt;del&gt;CASSANDRA-16925&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17437472" author="edimitrova" created="Tue, 2 Nov 2021 17:02:12 +0000"  >&lt;p&gt;Is it only me or there is no CI run accompanying &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16925&quot; title=&quot;Task Execution&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16925&quot;&gt;&lt;del&gt;CASSANDRA-16925&lt;/del&gt;&lt;/a&gt;, maybe they just forgot to publish the link...? I don&apos;t know.&#160;&lt;/p&gt;</comment>
                            <comment id="17437534" author="dcapwell" created="Tue, 2 Nov 2021 18:34:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt; was working on another issue with commit log which is another race condition bug; will ninja that patch into this one as it touches the same code and rewriting the same interface twice is annoying...&lt;/p&gt;

&lt;p&gt;Error is&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [COMMIT-LOG-WRITER] 2021-10-25 14:51:13,985 Exiting due to error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing commit log during initialization.
org.apache.cassandra.io.FSWriteError: java.nio.channels.ClosedByInterruptException
	at org.apache.cassandra.db.commitlog.CompressedSegment.write(CompressedSegment.java:86)
	at org.apache.cassandra.db.commitlog.CommitLogSegment.sync(CommitLogSegment.java:360)
	at org.apache.cassandra.db.commitlog.AbstractCommitLogSegmentManager.sync(AbstractCommitLogSegmentManager.java:555)
	at org.apache.cassandra.db.commitlog.CommitLog.sync(CommitLog.java:253)
	at org.apache.cassandra.db.commitlog.AbstractCommitLogService$SyncRunnable.run(AbstractCommitLogService.java:178)
	at org.apache.cassandra.concurrent.InfiniteLoopExecutor.loop(InfiniteLoopExecutor.java:86)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.nio.channels.ClosedByInterruptException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at java.nio.channels.spi.AbstractInterruptibleChannel.end(AbstractInterruptibleChannel.java:202)
	at sun.nio.ch.FileChannelImpl.position(FileChannelImpl.java:269)
	at org.apache.cassandra.db.commitlog.CompressedSegment.write(CompressedSegment.java:78)
	... 7 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17437625" author="dcapwell" created="Tue, 2 Nov 2021 22:08:53 +0000"  >&lt;p&gt;I was hopeful that &lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1069/workflows/26b7b83a-686f-4516-a56a-0709d428d4f2/jobs/7256/tests#failed-test-1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1069/workflows/26b7b83a-686f-4516-a56a-0709d428d4f2/jobs/7256/tests#failed-test-1&lt;/a&gt; would pass as it looks like the same pattern; but it didn&apos;t... &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
node3 = new_node(cluster)
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;:
            node3.start()
        except NodeError:
            pass  # node doesn&apos;t start as expected
        t.join()
&amp;gt;       node1.start()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ccmlib.node.TimeoutError: 02 Nov 2021 21:41:45 [node3] after 120.11/120 seconds Missing: [&lt;span class=&quot;code-quote&quot;&gt;&apos;127.0.0.1:7000.* is now UP&apos;&lt;/span&gt;] not found in system.log:
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Looking at node3&apos;s logs&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://circle-production-customer-artifacts.s3.amazonaws.com/picard/5d8cf450ac092b7198121061/6181a8080bc8444c0cfb3495-7-build/artifacts/dtest_j8_upgradetests_without_vnodes_logs/1635889075100_test_bootstrap_with_reset_bootstrap_state/node3.log?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;amp;X-Amz-Date=20211102T220735Z&amp;amp;X-Amz-SignedHeaders=host&amp;amp;X-Amz-Expires=60&amp;amp;X-Amz-Credential=AKIAJR3Q6CR467H7Z55A%2F20211102%2Fus-east-1%2Fs3%2Faws4_request&amp;amp;X-Amz-Signature=8a0b070e2db9d3e2bed74754d6f34d13171ab5ce1cc7236ec7792003ea14808f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circle-production-customer-artifacts.s3.amazonaws.com/picard/5d8cf450ac092b7198121061/6181a8080bc8444c0cfb3495-7-build/artifacts/dtest_j8_upgradetests_without_vnodes_logs/1635889075100_test_bootstrap_with_reset_bootstrap_state/node3.log?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;amp;X-Amz-Date=20211102T220735Z&amp;amp;X-Amz-SignedHeaders=host&amp;amp;X-Amz-Expires=60&amp;amp;X-Amz-Credential=AKIAJR3Q6CR467H7Z55A%2F20211102%2Fus-east-1%2Fs3%2Faws4_request&amp;amp;X-Amz-Signature=8a0b070e2db9d3e2bed74754d6f34d13171ab5ce1cc7236ec7792003ea14808f&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [Stream-Deserializer-/127.0.0.1:7000-f2eb1a15] 2021-11-02 21:35:40,983 DefaultFSErrorHandler.java:104 - Exiting forcefully due to file system exception on startup, disk failure policy &lt;span class=&quot;code-quote&quot;&gt;&quot;stop&quot;&lt;/span&gt;
org.apache.cassandra.io.FSWriteError: java.nio.channels.ClosedChannelException
	at org.apache.cassandra.io.sstable.format.big.BigTableZeroCopyWriter.write(BigTableZeroCopyWriter.java:227)
	at org.apache.cassandra.io.sstable.format.big.BigTableZeroCopyWriter.writeComponent(BigTableZeroCopyWriter.java:206)
	at org.apache.cassandra.db.streaming.CassandraEntireSSTableStreamReader.read(CassandraEntireSSTableStreamReader.java:125)
	at org.apache.cassandra.db.streaming.CassandraIncomingFile.read(CassandraIncomingFile.java:84)
	at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:51)
	at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:37)
	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:50)
	at org.apache.cassandra.streaming.StreamDeserializingTask.run(StreamDeserializingTask.java:62)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.nio.channels.ClosedChannelException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.net.AsyncStreamingInputPlus.reBuffer(AsyncStreamingInputPlus.java:136)
	at org.apache.cassandra.net.AsyncStreamingInputPlus.consume(AsyncStreamingInputPlus.java:155)
	at org.apache.cassandra.io.sstable.format.big.BigTableZeroCopyWriter.write(BigTableZeroCopyWriter.java:217)
	... 9 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17437653" author="dcapwell" created="Tue, 2 Nov 2021 23:00:04 +0000"  >&lt;p&gt;tested on 3.0 and see we do not stop node3&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN  [main] 2021-11-02T22:57:12,390 : - Node is not yet bootstrapped completely. Use nodetool to check bootstrap state and resume. For more, see `nodetool help bootstrap`
INFO  [main] 2021-11-02T22:57:12,390 : - Startup complete
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I am in the container and see the JVM is still up;  and tailing the logs shows the following every few seconds&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  [OptionalTasks:1] 2021-11-02T22:59:32,211 : - Setup task failed with error, rescheduling
WARN  [OptionalTasks:1] 2021-11-02T22:59:42,178 : - CassandraRoleManager skipped &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; role setup: some nodes were not ready
INFO  [OptionalTasks:1] 2021-11-02T22:59:42,178 : - Setup task failed with error, rescheduling
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so looks like this 1 test hit 2 bugs... nice&lt;/p&gt;</comment>
                            <comment id="17437655" author="dcapwell" created="Tue, 2 Nov 2021 23:14:45 +0000"  >&lt;p&gt;I will file a new JIRA for zero-copy-streaming channel close causes node to shutdown.&lt;/p&gt;</comment>
                            <comment id="17438190" author="beobal" created="Wed, 3 Nov 2021 16:54:12 +0000"  >&lt;p&gt;+1 LGTM&lt;/p&gt;</comment>
                            <comment id="17438252" author="dcapwell" created="Wed, 3 Nov 2021 18:59:52 +0000"  >&lt;p&gt;Starting commit&lt;/p&gt;

&lt;p&gt;CI Results (pending):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-17085-trunk-E65F2954-175A-46A4-B954-FC6A91109F61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-17085-trunk-E65F2954-175A-46A4-B954-FC6A91109F61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/1262/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13408974">CASSANDRA-17081</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13409763">CASSANDRA-17116</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
        <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 1 week, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0walk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348835">NA</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/a540afd12ae4c29f15c54330242efdf1cf61354c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/a540afd12ae4c29f15c54330242efdf1cf61354c&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;local and ci dtest&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>