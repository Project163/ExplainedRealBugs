<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:45:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7371] DELETEs get lost</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7371</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The mentioned commit introduced a bug which is not easy to reproduce:&lt;/p&gt;

&lt;p&gt;Workload description:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;One INSERT into a table&lt;/li&gt;
	&lt;li&gt;multiple concurrent SELECTs against different tables (one select returns a result)&lt;/li&gt;
	&lt;li&gt;One UPDATE against the same table as the INSERT&lt;/li&gt;
	&lt;li&gt;(same) multiple concurrent SELECTs against different tables (one select returns a result)&lt;/li&gt;
	&lt;li&gt;One DELETE against the same table as the INSERT&lt;/li&gt;
	&lt;li&gt;(same) multiple concurrent SELECTs against different tables&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Expected is that the last bunch of SELECTs returns no result. But since commit SHA  the DELETE gets not processed.&lt;br/&gt;
To clarify - the DELETE is not delayed - it is not executed at all.&lt;/p&gt;

&lt;p&gt;Checked against a single node C* &quot;cluster&quot;.&lt;/p&gt;

&lt;p&gt;Does only affect unreleased 2.1 - not 2.0 nor 1.2.&lt;/p&gt;</description>
                <environment>&lt;p&gt;2.1 git branch since merge commit 4722fe70aa9ae1b62772cfa1a1de58ef289445d5 (&quot;RefCount native frames from netty to avoid corruption bugs&quot;)&lt;/p&gt;</environment>
        <key id="12720131">CASSANDRA-7371</key>
            <summary>DELETEs get lost</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="tjake">T Jake Luciani</assignee>
                                    <reporter username="snazy">Robert Stupp</reporter>
                        <labels>
                            <label>qa-resolved</label>
                    </labels>
                <created>Mon, 9 Jun 2014 15:43:59 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:43 +0000</updated>
                            <resolved>Mon, 16 Jun 2014 20:13:54 +0000</resolved>
                                        <fixVersion>2.1 rc3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14025380" author="snazy" created="Mon, 9 Jun 2014 17:20:35 +0000"  >&lt;p&gt;Unit test attached.&lt;/p&gt;

&lt;p&gt;Instructions:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;start local cluster (&lt;tt&gt;ccm create -v 2.1.0-rc1-snapshot -n 1 -s --vnodes test&lt;/tt&gt; - or manually)&lt;/li&gt;
	&lt;li&gt;start the attached unit test (dependency to java driver (2.0 should work - tested with latest 2.1 from github))&lt;/li&gt;
&lt;/ol&gt;


&lt;ul&gt;
	&lt;li&gt;Works with C* build against SHA 78e91c4cacb7128a994a7a8ca16f5a9e20b576ce&lt;/li&gt;
	&lt;li&gt;Some iterations fail with C* build against SHA 4722fe70aa9ae1b62772cfa1a1de58ef289445d5&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14025403" author="snazy" created="Mon, 9 Jun 2014 17:32:12 +0000"  >&lt;p&gt;oops... lots of these:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN  [SharedPool-Worker-6] 2014-06-09 19:30:18,893 AbstractTracingAwareExecutorService.java:166 - Uncaught exception on thread Thread[SharedPool-Worker-6,10,main]: {}
java.lang.AssertionError: null
	at org.apache.cassandra.db.RangeTombstoneList.insertFrom(RangeTombstoneList.java:504) ~[main/:na]
	at org.apache.cassandra.db.RangeTombstoneList.add(RangeTombstoneList.java:147) ~[main/:na]
	at org.apache.cassandra.db.RangeTombstoneList.add(RangeTombstoneList.java:119) ~[main/:na]
	at org.apache.cassandra.db.DeletionInfo.add(DeletionInfo.java:231) ~[main/:na]
	at org.apache.cassandra.db.filter.QueryFilter.delete(QueryFilter.java:258) ~[main/:na]
	at org.apache.cassandra.db.CollationController.collectAllData(CollationController.java:206) ~[main/:na]
	at org.apache.cassandra.db.CollationController.getTopLevelColumns(CollationController.java:59) ~[main/:na]
	at org.apache.cassandra.db.ColumnFamilyStore.getTopLevelColumns(ColumnFamilyStore.java:1873) ~[main/:na]
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1681) ~[main/:na]
	at org.apache.cassandra.db.Keyspace.getRow(Keyspace.java:335) ~[main/:na]
	at org.apache.cassandra.db.SliceFromReadCommand.getRow(SliceFromReadCommand.java:59) ~[main/:na]
	at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1387) ~[main/:na]
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2054) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_55]
	at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:162) ~[main/:na]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:103) [main/:na]
	at java.lang.Thread.run(Thread.java:745) [na:1.7.0_55]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14025429" author="snazy" created="Mon, 9 Jun 2014 17:46:03 +0000"  >&lt;p&gt;It&apos;s not only the mentioned commit. I tried with the latest commit (acb4cf62db7e45f9b325fd88a9df4f67efac17b8) and reversed the changes from commit 029cd403172f8cc1b96f0828c8e1f8f6d57c0bcc. The issue persists... strange.&lt;/p&gt;</comment>
                            <comment id="14025519" author="snazy" created="Mon, 9 Jun 2014 18:44:09 +0000"  >&lt;p&gt;I&apos;m really really sorry to blame the wrong commit (shame on me - forgot to remove C*&apos;s build directory).&lt;/p&gt;

&lt;p&gt;The bug was caused by commit 4722fe70aa9ae1b62772cfa1a1de58ef289445d5 (&quot;RefCount native frames from netty to avoid corruption bugs&quot;) and &lt;b&gt;not&lt;/b&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&apos;s trivial change.&lt;br/&gt;
I&apos;ve verified it with a clean build of b29d882df82c1b0aa2c1878c0ba704ac814c69d3 (works), a clean build of 4722fe70aa9ae1b62772cfa1a1de58ef289445d5 (fails) and a clean build (recent with 4722fe70aa9ae1b62772cfa1a1de58ef289445d5 removed (works).&lt;/p&gt;</comment>
                            <comment id="14026064" author="tjake" created="Tue, 10 Jun 2014 02:49:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt; I do think there is a bug here but for some reason I&apos;m not able to reproduce with your test on my laptop.  I&apos;ll submit a patch and ask you to test it.&lt;/p&gt;</comment>
                            <comment id="14026203" author="snazy" created="Tue, 10 Jun 2014 07:25:15 +0000"  >&lt;p&gt;Regarding the failed tests:&lt;br/&gt;
The CQL DELETE gets through - but it is never executed - not just delayed (verified in cqlsh some seconds later)&lt;/p&gt;

&lt;p&gt;I&apos;ll check that patch later this evening (CEST - 6/7 hours before EST).&lt;/p&gt;

&lt;p&gt;What I did right now is this.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ uname -a
Darwin macbook-retina.local 13.2.0 Darwin Kernel Version 13.2.0: Thu Apr 17 23:03:13 PDT 2014; root:xnu-2422.100.13~1/RELEASE_X86_64 x86_64
(System is a MacBook Pro/Retina - 16G RAM - Core i7)

$ cd (directory for cassandra source)

$ rm -rf (everything inside the directory)

$ git clone https://github.com/apache/cassandra.git .

$ git checkout -b cassandra-2.1 --track origin/cassandra-2.1 

$ cat .git/config
...
[branch &quot;cassandra-2.1&quot;]
	remote = origin
	merge = refs/heads/cassandra-2.1

$ pwd
/Users/snazy/devel/cassandra/cassandra/

$ ant publish

$ java -version
java version &quot;1.7.0_55&quot;

$ l ~/.ccm/repository
lrwxr-xr-x   1 snazy  staff     39  9 Jun 20:21 2.1.0-rc1-snapshot@ -&amp;gt; /Users/snazy/devel/cassandra/cassandra/

$ ccm create -v 2.1.0-rc1-snapshot -n 1 -s --vnodes test
Current cluster is now: test

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Run test... (with 1.7.0_55)&lt;/p&gt;

&lt;p&gt;	31/500 failed&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ ccm remove test

$ git reset -q --hard b29d882df82c1b0aa2c1878c0ba704ac814c69d3

$ rm -rf build

$ ant publish

$ ccm create -v 2.1.0-rc1-snapshot -n 1 -s --vnodes test
Current cluster is now: test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;	Run test... (with 1.7.0_55)&lt;/p&gt;

&lt;p&gt;	0/500 failed&lt;/p&gt;</comment>
                            <comment id="14027077" author="snazy" created="Tue, 10 Jun 2014 21:42:08 +0000"  >&lt;p&gt;It is not reproducible when connecting from Mac to Linux box.&lt;br/&gt;
It is not reproducible when connecting from Linux box to Mac.&lt;br/&gt;
It is not reproducible when connecting from Linux box to Linux box.&lt;br/&gt;
It is not reproducible when connecting from Mac to Linux VM on Mac.&lt;br/&gt;
It is not reproducible when connecting from Linux VM on Mac to Mac.&lt;br/&gt;
It is not reproducible when connecting from Linux VM on Mac to Linux VM on Mac.&lt;/p&gt;

&lt;p&gt;It is only reproducible when both client and server run on OSX.&lt;br/&gt;
It does not depend on the Java version (checked with 1.7.0_55, 1.7.0_60, 1.8.0_05, 1.9.0-ea-b16).&lt;br/&gt;
Running test from IDE or command line makes no difference.&lt;/p&gt;

&lt;p&gt;Can anyone cross check it? I&apos;m a bit frustrated. I see that there is an issue - but cannot isolate the cause.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Darwin macbook-retina.local 13.2.0 Darwin Kernel Version 13.2.0: Thu Apr 17 23:03:13 PDT 2014; root:xnu-2422.100.13~1/RELEASE_X86_64 x86_64
2.6 GHz Intel Core i7
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14027100" author="jbellis" created="Tue, 10 Jun 2014 22:00:26 +0000"  >&lt;p&gt;Crazy!  Do you have an OS X box to test on, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mshuler&quot; class=&quot;user-hover&quot; rel=&quot;mshuler&quot;&gt;mshuler&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14027106" author="tjake" created="Tue, 10 Jun 2014 22:03:05 +0000"  >&lt;p&gt;Yes I&apos;m not able to repro on my linux box I can try osx.  I do think I can fix the bug but I really really want to find a way to reproduce it consistently as a unit test&lt;/p&gt;</comment>
                            <comment id="14027577" author="snazy" created="Wed, 11 Jun 2014 09:36:13 +0000"  >&lt;p&gt;And it does not depend on the particular netty version (tried with previous version 4.0.17 in C*, and newer 3.9.1 in java driver).&lt;br/&gt;
Just two ideas (although I have no clue why that does only happen on OSX) : some strange behaviour in retain/release in io.netty.ByteBuf ... or some strange behaviour in JDK NIO stuff (&lt;a href=&quot;http://bugs.java.com/bugdatabase/view_bug.do?bug_id=7159361&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;7159361&lt;/a&gt; + &lt;a href=&quot;http://bugs.java.com/bugdatabase/view_bug.do?bug_id=7143744&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;7143744&lt;/a&gt; ; both resolved/duplicate)&lt;/p&gt;</comment>
                            <comment id="14027719" author="tjake" created="Wed, 11 Jun 2014 13:13:36 +0000"  >&lt;p&gt;I can reproduce on OSX so that&apos;s good, now I can fix.&lt;/p&gt;</comment>
                            <comment id="14027827" author="tjake" created="Wed, 11 Jun 2014 14:41:28 +0000"  >&lt;p&gt;Fix attached. Issue was range tombstones didn&apos;t bring the start and end composites on heap.  &lt;/p&gt;

&lt;p&gt;I also fixed a issue where the BatchStatements weren&apos;t tracking the source frame&lt;/p&gt;</comment>
                            <comment id="14028127" author="snazy" created="Wed, 11 Jun 2014 17:58:29 +0000"  >&lt;p&gt;patch works&lt;br/&gt;
from my side: +1&lt;/p&gt;

&lt;p&gt;thanks for the quick fix &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;off topic: i still do not understand why this only happened on OSX - but it&apos;s an argument to stay on Mac for development&lt;br/&gt;
(flame off)&lt;/p&gt;</comment>
                            <comment id="14028830" author="mshuler" created="Thu, 12 Jun 2014 05:13:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=philipthompson&quot; class=&quot;user-hover&quot; rel=&quot;philipthompson&quot;&gt;philipthompson&lt;/a&gt; could you test out this patch out to verify? (I don&apos;t have an OS-X box)&lt;/p&gt;</comment>
                            <comment id="14031755" author="philipthompson" created="Sun, 15 Jun 2014 02:02:22 +0000"  >&lt;p&gt;+1 from me. Patch is working on os-x. Tested it out on windows and linux too, the attached unit test passes on each. I found no issues when running dtests with this patch as well.&lt;/p&gt;</comment>
                            <comment id="14032680" author="benedict" created="Mon, 16 Jun 2014 17:57:06 +0000"  >&lt;p&gt;Two minor comments:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;In addAllWithSizeDelta, I would only copy the deletionInfo on the first iteration (if there&apos;s a race we&apos;ll copy multiple times)&lt;/li&gt;
	&lt;li&gt;In RangeTombstoneList.copy we should just allocate an empty array for starts/ends, as we overwrite the data we copy anyway (this is slightly cheaper, as the arrays are zeroed before allocation)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Otherwise LGTM&lt;/p&gt;</comment>
                            <comment id="14032872" author="tjake" created="Mon, 16 Jun 2014 20:13:54 +0000"  >&lt;p&gt;Committed with your minor comments addressed&lt;/p&gt;</comment>
                            <comment id="14048697" author="slebresne" created="Tue, 1 Jul 2014 09:42:14 +0000"  >&lt;p&gt;The test added with this ticket broke the &lt;tt&gt;ant cql-test&lt;/tt&gt; target, most likely because it extends SchemaLoader. In 2.1 we&apos;ve added a CQLTester class for CQL tests that is better than SchemaLoader for a number of reasons. Can we try to stick to that for CQL tests rather than depending on the java driver?&lt;/p&gt;</comment>
                            <comment id="14048838" author="tjake" created="Tue, 1 Jul 2014 13:01:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;  This test is specifically testing the netty protocol so makes no sense to remove the netty path.&lt;/p&gt;

&lt;p&gt;I think all cql tests should be using the netty protocol. Otherwise we aren&apos;t really testing the common transport for cql.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12649806" name="7371.txt" size="15901" author="tjake" created="Wed, 11 Jun 2014 14:41:28 +0000"/>
                            <attachment id="12649396" name="Cassandra7371.java" size="5560" author="snazy" created="Mon, 9 Jun 2014 17:20:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398330</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wktb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>398457</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>philipthompson</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>