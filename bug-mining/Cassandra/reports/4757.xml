<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:07:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13229] dtest failure in topology_test.TestTopology.size_estimates_multidc_test</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13229</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;example failure:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/trunk_novnode_dtest/508/testReport/topology_test/TestTopology/size_estimates_multidc_test&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/trunk_novnode_dtest/508/testReport/topology_test/TestTopology/size_estimates_multidc_test&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Standard Output

Unexpected error in node1 log, error: 
ERROR [MemtablePostFlush:1] 2017-02-15 16:07:33,837 CassandraDaemon.java:211 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MemtablePostFlush:1,5,main]
java.lang.IndexOutOfBoundsException: Index: 3, Size: 3
	at java.util.ArrayList.rangeCheck(ArrayList.java:653) ~[na:1.8.0_45]
	at java.util.ArrayList.get(ArrayList.java:429) ~[na:1.8.0_45]
	at org.apache.cassandra.dht.Splitter.splitOwnedRangesNoPartialRanges(Splitter.java:92) ~[main/:na]
	at org.apache.cassandra.dht.Splitter.splitOwnedRanges(Splitter.java:59) ~[main/:na]
	at org.apache.cassandra.service.StorageService.getDiskBoundaries(StorageService.java:5180) ~[main/:na]
	at org.apache.cassandra.db.Memtable.createFlushRunnables(Memtable.java:312) ~[main/:na]
	at org.apache.cassandra.db.Memtable.flushRunnables(Memtable.java:304) ~[main/:na]
	at org.apache.cassandra.db.ColumnFamilyStore$Flush.flushMemtable(ColumnFamilyStore.java:1150) ~[main/:na]
	at org.apache.cassandra.db.ColumnFamilyStore$Flush.run(ColumnFamilyStore.java:1115) ~[main/:na]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_45]
	at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$290(NamedThreadFactory.java:81) [main/:na]
	at org.apache.cassandra.concurrent.NamedThreadFactory$$Lambda$5/1321203216.run(Unknown Source) [main/:na]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_45]
Unexpected error in node1 log, error: 
ERROR [MigrationStage:1] 2017-02-15 16:07:33,853 CassandraDaemon.java:211 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MigrationStage:1,5,main]
java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.IndexOutOfBoundsException: Index: 3, Size: 3
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:401) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.lambda$flush$496(SchemaKeyspace.java:284) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace$$Lambda$222/1949434065.accept(Unknown Source) ~[na:na]
	at java.lang.Iterable.forEach(Iterable.java:75) ~[na:1.8.0_45]
	at org.apache.cassandra.schema.SchemaKeyspace.flush(SchemaKeyspace.java:284) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.applyChanges(SchemaKeyspace.java:1265) ~[main/:na]
	at org.apache.cassandra.schema.Schema.merge(Schema.java:577) ~[main/:na]
	at org.apache.cassandra.schema.Schema.mergeAndAnnounceVersion(Schema.java:564) ~[main/:na]
	at org.apache.cassandra.schema.MigrationManager$1.runMayThrow(MigrationManager.java:402) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_45]
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_45]
	at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$290(NamedThreadFactory.java:81) [main/:na]
	at org.apache.cassandra.concurrent.NamedThreadFactory$$Lambda$5/1321203216.run(Unknown Source) [main/:na]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_45]
Caused by: java.util.concurrent.ExecutionException: java.lang.IndexOutOfBoundsException: Index: 3, Size: 3
	at java.util.concurrent.FutureTask.report(FutureTask.java:122) ~[na:1.8.0_45]
	at java.util.concurrent.FutureTask.get(FutureTask.java:192) ~[na:1.8.0_45]
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:397) ~[main/:na]
	... 16 common frames omitted
Caused by: java.lang.IndexOutOfBoundsException: Index: 3, Size: 3
	at java.util.ArrayList.rangeCheck(ArrayList.java:653) ~[na:1.8.0_45]
	at java.util.ArrayList.get(ArrayList.java:429) ~[na:1.8.0_45]
	at org.apache.cassandra.dht.Splitter.splitOwnedRangesNoPartialRanges(Splitter.java:92) ~[main/:na]
	at org.apache.cassandra.dht.Splitter.splitOwnedRanges(Splitter.java:59) ~[main/:na]
	at org.apache.cassandra.service.StorageService.getDiskBoundaries(StorageService.java:5180) ~[main/:na]
	at org.apache.cassandra.db.Memtable.createFlushRunnables(Memtable.java:312) ~[main/:na]
	at org.apache.cassandra.db.Memtable.flushRunnables(Memtable.java:304) ~[main/:na]
	at org.apache.cassandra.db.ColumnFamilyStore$Flush.flushMemtable(ColumnFamilyStore.java:1150) ~[main/:na]
	at org.apache.cassandra.db.ColumnFamilyStore$Flush.run(ColumnFamilyStore.java:1115) ~[main/:na]
	... 5 common frames omitted
Unexpected error in node1 log, error: 
ERROR [main] 2017-02-15 16:07:33,857 CassandraDaemon.java:663 - Exception encountered during startup
java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.IndexOutOfBoundsException: Index: 3, Size: 3
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:401) ~[main/:na]
	at org.apache.cassandra.schema.MigrationManager.announce(MigrationManager.java:384) ~[main/:na]
	at org.apache.cassandra.schema.MigrationManager.announceNewKeyspace(MigrationManager.java:176) ~[main/:na]
	at org.apache.cassandra.service.StorageService.maybeAddKeyspace(StorageService.java:1066) ~[main/:na]
	at org.apache.cassandra.service.StorageService.maybeAddOrUpdateKeyspace(StorageService.java:1091) ~[main/:na]
	at org.apache.cassandra.service.StorageService.doAuthSetup(StorageService.java:1048) ~[main/:na]
	at org.apache.cassandra.service.StorageService.finishJoiningRing(StorageService.java:1043) ~[main/:na]
	at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:966) ~[main/:na]
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:649) ~[main/:na]
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:581) ~[main/:na]
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:364) [main/:na]
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:557) [main/:na]
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:646) [main/:na]
Caused by: java.util.concurrent.ExecutionException: java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.IndexOutOfBoundsException: Index: 3, Size: 3
	at java.util.concurrent.FutureTask.report(FutureTask.java:122) ~[na:1.8.0_45]
	at java.util.concurrent.FutureTask.get(FutureTask.java:192) ~[na:1.8.0_45]
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:397) ~[main/:na]
	... 12 common frames omitted
Caused by: java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.IndexOutOfBoundsException: Index: 3, Size: 3
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:401) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.lambda$flush$496(SchemaKeyspace.java:284) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace$$Lambda$222/1949434065.accept(Unknown Source) ~[na:na]
	at java.lang.Iterable.forEach(Iterable.java:75) ~[na:1.8.0_45]
	at org.apache.cassandra.schema.SchemaKeyspace.flush(SchemaKeyspace.java:284) ~[main/:na]
	at org.apache.cassandra.schema.SchemaKeyspace.applyChanges(SchemaKeyspace.java:1265) ~[main/:na]
	at org.apache.cassandra.schema.Schema.merge(Schema.java:577) ~[main/:na]
	at org.apache.cassandra.schema.Schema.mergeAndAnnounceVersion(Schema.java:564) ~[main/:na]
	at org.apache.cassandra.schema.MigrationManager$1.runMayThrow(MigrationManager.java:402) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_45]
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_45]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[na:1.8.0_45]
	at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$290(NamedThreadFactory.java:81) ~[main/:na]
	at org.apache.cassandra.concurrent.NamedThreadFactory$$Lambda$5/1321203216.run(Unknown Source) ~[na:na]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) ~[na:1.8.0_45]
Caused by: java.util.concurrent.ExecutionException: java.lang.IndexOutOfBoundsException: Index: 3, Size: 3
	at java.util.concurrent.FutureTask.report(FutureTask.java:122) ~[na:1.8.0_45]
	at java.util.concurrent.FutureTask.get(FutureTask.java:192) ~[na:1.8.0_45]
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:397) ~[main/:na]
	... 16 common frames omitted
Caused by: java.lang.IndexOutOfBoundsException: Index: 3, Size: 3
	at java.util.ArrayList.rangeCheck(ArrayList.java:653) ~[na:1.8.0_45]
	at java.util.ArrayList.get(ArrayList.java:429) ~[na:1.8.0_45]
	at org.apache.cassandra.dht.Splitter.splitOwnedRangesNoPartialRanges(Splitter.java:92) ~[main/:na]
	at org.apache.cassandra.dht.Splitter.splitOwnedRanges(Splitter.java:59) ~[main/:na]
	at org.apache.cassandra.service.StorageService.getDiskBoundaries(StorageService.java:5180) ~[main/:na]
	at org.apache.cassandra.db.Memtable.createFlushRunnables(Memtable.java:312) ~[main/:na]
	at org.apache.cassandra.db.Memtable.flushRunnables(Memtable.java:304) ~[main/:na]
	at org.apache.cassandra.db.ColumnFamilyStore$Flush.flushMemtable(ColumnFamilyStore.java:1150) ~[main/:na]
	at org.apache.cassandra.db.ColumnFamilyStore$Flush.run(ColumnFamilyStore.java:1115) ~[main/:na]
	... 5 common frames omitted
Unexpected error in node1 log, error: 
ERROR [StorageServiceShutdownHook] 2017-02-15 16:07:35,972 AbstractCommitLogSegmentManager.java:311 - Failed to force-recycle all segments; at least one segment is still in use with dirty CFs.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13043673">CASSANDRA-13229</key>
            <summary>dtest failure in topology_test.TestTopology.size_estimates_multidc_test</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="sean.mccarthy">Sean McCarthy</reporter>
                        <labels>
                            <label>dtest</label>
                            <label>test-failure</label>
                    </labels>
                <created>Thu, 16 Feb 2017 15:43:40 +0000</created>
                <updated>Sun, 1 Aug 2021 11:17:57 +0000</updated>
                            <resolved>Fri, 12 May 2017 06:54:42 +0000</resolved>
                                        <fixVersion>3.11.7</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Test/dtest/python</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15942887" author="ifesdjeen" created="Mon, 27 Mar 2017 09:03:53 +0000"  >&lt;p&gt;The test in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9639&quot; title=&quot;size_estimates is inacurate in multi-dc clusters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9639&quot;&gt;&lt;del&gt;CASSANDRA-9639&lt;/del&gt;&lt;/a&gt; has surfaced a problem with the size estimates (which is although not very realistic given we have more startup tokens). When the tokens are given manually in the test, we have to split 3 ranges into 3 parts (in dtest we use 3 data directories to ensure we check multi-disk setups). Since the given tokens aren&apos;t distributed evenly, we end up having just 1 range instead of three.&lt;/p&gt;

&lt;p&gt;In reality (however improbable the scenario of this happening is), this fix would make sure that all the given disks are utilised. &lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:9639-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9639-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9639-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9639-trunk-novnode_dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;novnode&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15949608" author="pauloricardomg" created="Thu, 30 Mar 2017 18:58:26 +0000"  >&lt;p&gt;Nice catch! I&apos;m afraid we can&apos;t fallback to split the token ranges evenly given it&apos;s expected that a single vnode range should not span more than 1 disk (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6696&quot; title=&quot;Partition sstables by token range&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6696&quot;&gt;&lt;del&gt;CASSANDRA-6696&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Actually in this specific case, given it&apos;s the system keyspace which spans the whole token range we could probably split the token ranges evenly (and probably should for better distribution), but when &lt;tt&gt;dontSplitRanges&lt;/tt&gt; flag is passed we should always assign at least 1 vnode range per disk even if one of the disks becomes unbalanced (cases like this will become very rare after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7032&quot; title=&quot;Improve vnode allocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7032&quot;&gt;&lt;del&gt;CASSANDRA-7032&lt;/del&gt;&lt;/a&gt;, but we should still protect against it).  &lt;/p&gt;

&lt;p&gt;Although this will probably happen in rare cases when the token ranges are unbalanced and the vnode-to-disk ratio is low, we can probably tweak the &lt;tt&gt;splitOwnedRangesNoPartialRanges&lt;/tt&gt; algorithm to only add more ranges to the current disk if the # of remaining tokens &amp;gt; # remaining parts. Does this sound reasonable or can you think of a simpler/better approach &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15950698" author="krummas" created="Fri, 31 Mar 2017 11:12:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;it&apos;s expected that a single vnode range should not span more than 1 disk &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If there are more disks than vnode ranges, I think we should fall back to splitting vnodes over the available disks, otherwise we would leave some disks unused. This should be very rare in real production scenarios. I would assume that this is less surprising to a user than the fact that a vnode was split over several disks? Maybe even do something like avoiding to split vnode ranges onto multiple ranges if there are less than 16 tokens on the node (reason being that it is very hard to get a good balance). So, instead of checking if we run vnodes or single-token, we check if there are less than 16 tokens?&lt;/p&gt;

&lt;p&gt;The optimisation we wanted to do in the future was to be able to take a bunch of vnode ranges offline if the disk backing the ranges fails, but not sure that is planned anymore.&lt;/p&gt;</comment>
                            <comment id="15950774" author="ifesdjeen" created="Fri, 31 Mar 2017 12:19:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;If there are more disks than vnode ranges, I think we should fall back to splitting vnodes over the available disks, otherwise we would leave some disks unused&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But wouldn&apos;t this lead to the problems with disk blacklisting and resurrecting data like Paulo said in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6696&quot; title=&quot;Partition sstables by token range&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6696&quot;&gt;&lt;del&gt;CASSANDRA-6696&lt;/del&gt;&lt;/a&gt;?.. If not, we could go with &quot;try dividing with &lt;tt&gt;splitOwnedRangesNoPartialRanges&lt;/tt&gt; first, if some disks are still unutilized, fall back to splitting vnode ranges. &lt;/p&gt;</comment>
                            <comment id="15951175" author="pauloricardomg" created="Fri, 31 Mar 2017 15:52:44 +0000"  >&lt;p&gt;Thanks for the feedback Marcus!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But wouldn&apos;t this lead to the problems with disk blacklisting and resurrecting data like Paulo said in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6696&quot; title=&quot;Partition sstables by token range&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6696&quot;&gt;&lt;del&gt;CASSANDRA-6696&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There&apos;s no actual problem from what Marcus said, we just wanted to keep vnodes tied to a single disk to be able to take vnodes offline if a specific disk fails but this hasn&apos;t been implemented yet. Furthermore &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10540&quot; title=&quot;RangeAwareCompaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10540&quot;&gt;CASSANDRA-10540&lt;/a&gt; will probably benefit if vnodes are kept in a single disk.&lt;/p&gt;

&lt;p&gt;With this said, we should probably keep your approach of falling back to split evenly if not all disks are used and also raise the minimum number of tokens to split by vnode from 2 to 8 to ensure a better balance (Marcus suggested 16 but 8 should be good already since there are 24 local ranges with RF=3 and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7032&quot; title=&quot;Improve vnode allocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7032&quot;&gt;&lt;del&gt;CASSANDRA-7032&lt;/del&gt;&lt;/a&gt; should also improve load balancing). We can probably reconsider this if we ever implement the optimization of blacklisting specific vnodes when disks fail.&lt;/p&gt;

&lt;p&gt;In your initial approach, I&apos;d just move the fallback out of &lt;tt&gt;splitOwnedRanges&lt;/tt&gt; because it&apos;s a bit wrong to pass &lt;tt&gt;dontSplitRanges=true&lt;/tt&gt; and have your ranges splitted. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15960383" author="ifesdjeen" created="Fri, 7 Apr 2017 07:05:44 +0000"  >&lt;p&gt;Thank you for clarifications. &lt;/p&gt;

&lt;p&gt;I&apos;ve updated the branch according to your suggestions and re-triggered tests. Since fallback is now pulled one level up, I didn&apos;t write unit test for it, but it&apos;s still covered by the test that has failed. We can add an auxiliary method that handles fallback and cover it with a unit test if you think it&apos;s necessary.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:9639-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9639-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9639-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-9639-trunk-novnode_dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;novnode&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The patch is applicable to 3.11 and up only.&lt;/p&gt;</comment>
                            <comment id="16002810" author="pauloricardomg" created="Tue, 9 May 2017 14:47:07 +0000"  >&lt;p&gt;this fell through the cracks, sorry. LGTM, +1.&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="16007713" author="ifesdjeen" created="Fri, 12 May 2017 06:54:32 +0000"  >&lt;p&gt;Committed to 3.11 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/5af7c5ff5b287b10a5b49b2bf2890469cb627f2a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5af7c5ff5b287b10a5b49b2bf2890469cb627f2a&lt;/a&gt; and merged up to &lt;a href=&quot;https://github.com/apache/cassandra/commit/c66044f7818a964d60d3f265bb4cdc922b0ff39a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12839908">CASSANDRA-9639</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12853079" name="node1.log" size="33407" author="sean.mccarthy" created="Thu, 16 Feb 2017 15:43:40 +0000"/>
                            <attachment id="12853077" name="node1_debug.log" size="81635" author="sean.mccarthy" created="Thu, 16 Feb 2017 15:43:40 +0000"/>
                            <attachment id="12853078" name="node1_gc.log" size="16948" author="sean.mccarthy" created="Thu, 16 Feb 2017 15:43:40 +0000"/>
                            <attachment id="12853082" name="node2.log" size="32440" author="sean.mccarthy" created="Thu, 16 Feb 2017 15:43:40 +0000"/>
                            <attachment id="12853080" name="node2_debug.log" size="59082" author="sean.mccarthy" created="Thu, 16 Feb 2017 15:43:40 +0000"/>
                            <attachment id="12853081" name="node2_gc.log" size="16338" author="sean.mccarthy" created="Thu, 16 Feb 2017 15:43:40 +0000"/>
                            <attachment id="12853085" name="node3.log" size="27522" author="sean.mccarthy" created="Thu, 16 Feb 2017 15:43:40 +0000"/>
                            <attachment id="12853083" name="node3_debug.log" size="1890243" author="sean.mccarthy" created="Thu, 16 Feb 2017 15:43:40 +0000"/>
                            <attachment id="12853084" name="node3_gc.log" size="23576" author="sean.mccarthy" created="Thu, 16 Feb 2017 15:43:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3a6nj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>pauloricardomg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>