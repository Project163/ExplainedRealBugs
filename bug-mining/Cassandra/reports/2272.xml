<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5797] DC-local CAS</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5797</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;For two-datacenter deployments where the second DC is strictly for disaster failover, it would be useful to restrict CAS to a single DC to avoid cross-DC round trips.&lt;/p&gt;

&lt;p&gt;(This would require manually truncating &lt;tt&gt;system.paxos&lt;/tt&gt; when failing over.)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12659484">CASSANDRA-5797</key>
            <summary>DC-local CAS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                            <label>LWT</label>
                    </labels>
                <created>Wed, 24 Jul 2013 03:02:53 +0000</created>
                <updated>Fri, 25 Oct 2019 13:11:22 +0000</updated>
                            <resolved>Fri, 26 Jul 2013 15:31:27 +0000</resolved>
                                        <fixVersion>2.0 rc1</fixVersion>
                                    <component>Feature/Lightweight Transactions</component>
                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="13717917" author="jbellis" created="Wed, 24 Jul 2013 03:03:25 +0000"  >&lt;p&gt;Not sure what CQL syntax for this is.  Is it protocol level the way CL is?&lt;/p&gt;</comment>
                            <comment id="13718268" author="slebresne" created="Wed, 24 Jul 2013 11:49:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;Not sure what CQL syntax for this is. Is it protocol level the way CL is?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s a good question and I&apos;m not really sure what&apos;s the right answer.&lt;/p&gt;

&lt;p&gt;I think it may make the most sense to make it protocol level because of reads.  For CAS writes, we do have a CQL syntax for it, so we could extends it with say:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;UPDATE foo SET v1 = 2, v2 = 3 WHERE k = 1 IF v1 = 1 AND v2 = 1 IN LOCAL DC
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But for reads, we don&apos;t have any syntax, the consistency level (SERIAL) is the only thing that makes a read go through paxos, so I&apos;m afraid adding some CQL syntax in that case would be confusing.&lt;/p&gt;

&lt;p&gt;But even making it protocol level is not that easy. For thrift, on the read side, the only way I can see us supporting this DC-local CAS would be add a LOCAL_SERIAL consistency level (short of duplicating all read methods for CAS reads that is). But that doesn&apos;t really work for writes since the consistency level for writes is really the consistency of the paxos learn/commit phase.&lt;/p&gt;

&lt;p&gt;One option (the best I can come up with so far) would be to add the LOCAL_SERIAL consistency level, and then to change CAS write to take 2 CL: the first one would be for the commit (learn) phase (as we have now, but we would refuse CL.SERIAL and CL.LOCAL_SERIAL in that case) and a 2nd CL that would control the &quot;Paxos consistency&quot; (and for that one, only CL.SERIAL or CL.LOCAL_SERIAL would be valid). It&apos;s not perfect however because the one thing you can&apos;t properly express is the ability to do CL.SERIAL for paxos but don&apos;t wait on any node for the learn phase. Unless we make CL.ANY for the &quot;commit consistency&quot; mean that, but that&apos;s a slight stretch.&lt;/p&gt;

&lt;p&gt;In any case, we should probably make it sure to shove that in 2.0.0 because I don&apos;t want to change the thrift API nor break the native protocol in 2.0.1.&lt;/p&gt;

&lt;p&gt;Any better idea?&lt;/p&gt;</comment>
                            <comment id="13718464" author="jbellis" created="Wed, 24 Jul 2013 15:14:56 +0000"  >&lt;p&gt;Sounds reasonable, although I think it would be better to come up w/ a different enum for the Paxos phases than re-use CL, most of whose options are not appropriate.&lt;/p&gt;

&lt;p&gt;I actually think CL.ANY on commit is fine.&lt;/p&gt;</comment>
                            <comment id="13718473" author="slebresne" created="Wed, 24 Jul 2013 15:23:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;although I think it would be better to come up w/ a different enum for the Paxos phases than re-use CL&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The thing is that for reads, we must have SERIAL and LOCAL_SERIAL in CL if we want thrift to support it. So once we have them in CL, is it really worth adding a separate enum for the write case? (honest question, I&apos;m fine doing it, just wonder if it&apos;s worth bothering since things will be mixed up for reads anyway).&lt;/p&gt;</comment>
                            <comment id="13718476" author="pmcfadin" created="Wed, 24 Jul 2013 15:27:54 +0000"  >&lt;p&gt;I like LOCAL_SERIAL over ANY. It makes a closer match to LOCAL_QUORUM in that it&apos;s not meant to cross datacenter boundaries. There is enough confusion about ANY as it is and I think this would simplify things.&lt;/p&gt;</comment>
                            <comment id="13718549" author="slebresne" created="Wed, 24 Jul 2013 16:33:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;I like LOCAL_SERIAL over ANY&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think there is some confusion. The suggestion of CL.ANY was for the commit part of Paxos. That part is basically a standard write (that happens after the paxos algorithm has unfolded but does impact the visibility of the CAS write by non-serial reads). For that, LOCAL_SERIAL don&apos;t really make sense imo (it&apos;s &quot;wrong&quot; even). ANY does is what match the most what happens, because you are guaranteed the write is replicated somewhere (paxos ensures that) but you may not be able to see your write right away with normal reads, even at CL.ALL (which is also something that CL.ANY).  &lt;/p&gt;</comment>
                            <comment id="13719041" author="jbellis" created="Wed, 24 Jul 2013 23:51:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;The thing is that for reads, we must have SERIAL and LOCAL_SERIAL in CL if we want thrift to support it. So once we have them in CL, is it really worth adding a separate enum for the write case?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The problem is that none of &lt;/p&gt;
{ANY, ONE, TWO, THREE, LOCAL_QUORUM, EACH_QUORUM}
&lt;p&gt; are valid on writes, which isn&apos;t very clear if we reuse CL for everything.&lt;/p&gt;

&lt;p&gt;Then again we ANY is not a valid CL for read, and EACH_QUORUM is not valid for writes.  I dunno.&lt;/p&gt;</comment>
                            <comment id="13719587" author="slebresne" created="Thu, 25 Jul 2013 12:51:25 +0000"  >&lt;p&gt;Attaching patch for this. I&apos;ve currently stayed with the idea of 2 CL for writes. One small reason for which it is somewhat convenient is that when we throw a write timeout exception, we need to ship the consistency level. And when that timeout happens during the paxos prepare/propose phases, returning CL.SERIAL or CL.LOCAL_SERIAL make the most sense, so using CL as argument of the method in the first place is somewhat consistent. Anyway, it&apos;s certainly possible to add a new enum for that instead, but I don&apos;t think that&apos; too horrible as is.&lt;/p&gt;

&lt;p&gt;There&apos;s 3 patches: the first one is just the update to the thrift generated files and can be largely ignored. The 2nd one does the main change but does not change CQL. The 3rd patch is the CQL and native protocol change. That latter patch is a tad big because while adding the new &quot;serial consistency level&quot;, I realized this was a pain with the current code and that in the protocol v2, QUERY and EXECUTE had basically the same parameters but they were set out in different order (in the protocol) which was killing all possibility of code reuse for no good reason. So I decided to go ahead and refactor that more cleanly since there&apos;s no point in making the life of client implementors harder for no good reason.&lt;/p&gt;

&lt;p&gt;Anyway, moving this issue to 2.0.0 because it changes the native protocol and thrift, so we really should have it in 2.0.&lt;/p&gt;</comment>
                            <comment id="13720820" author="jbellis" created="Fri, 26 Jul 2013 14:14:24 +0000"  >&lt;p&gt;+1 (mostly looked at patch 2)&lt;/p&gt;

&lt;p&gt;Nit: rename isSameDCThan to isSameDCAs, or maybe better sameDCPredicateFor (since &quot;is&quot; implies it&apos;s doing a boolean evaluation)&lt;/p&gt;</comment>
                            <comment id="13720883" author="iamaleksey" created="Fri, 26 Jul 2013 15:30:25 +0000"  >&lt;p&gt;QueryOptions.Codec.encode() writes flags before writing the CL - should be reversed. Otherwise LGTM.&lt;/p&gt;</comment>
                            <comment id="13720885" author="slebresne" created="Fri, 26 Jul 2013 15:31:27 +0000"  >&lt;p&gt;Alright, committed (with nit fixed). Thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12594174" name="0001-Thrift-generated-files.txt" size="46190" author="slebresne" created="Thu, 25 Jul 2013 12:51:25 +0000"/>
                            <attachment id="12594175" name="0002-Add-LOCAL_SERIAL-CL.txt" size="17632" author="slebresne" created="Thu, 25 Jul 2013 12:51:25 +0000"/>
                            <attachment id="12594176" name="0003-CQL-and-native-protocol-changes.txt" size="63038" author="slebresne" created="Thu, 25 Jul 2013 12:51:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>339677</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 17 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ml4n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>339997</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>