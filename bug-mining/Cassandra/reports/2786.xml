<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:44:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6831] Updates to COMPACT STORAGE tables via cli drop CQL information</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6831</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If a COMPACT STORAGE table is altered using the CLI all information about the column names reverts to the initial &quot;key, column1, column2&quot; namings.  Additionally, the changes in the columns name will not take effect until the Cassandra service is restarted.  This means that the clients using CQL will continue to work properly until the service is restarted, at which time they will start getting errors about non-existant columns in the table.&lt;/p&gt;

&lt;p&gt;When attempting to rename the columns back using ALTER TABLE an error stating the column already exists will be raised.  The only way to get it back is to ALTER TABLE and change the comment or something, which will bring back all the original column names.&lt;/p&gt;

&lt;p&gt;This seems to be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6676&quot; title=&quot;Add ability to see layout of storage for CQL tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6676&quot;&gt;&lt;del&gt;CASSANDRA-6676&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6370&quot; title=&quot;Updating cql created table through cassandra-cli transform it into a compact storage table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6370&quot;&gt;&lt;del&gt;CASSANDRA-6370&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In cqlsh&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Connected to cluster1 at 127.0.0.3:9160.
[cqlsh 3.1.8 | Cassandra 1.2.15-SNAPSHOT | CQL spec 3.0.0 | Thrift protocol 19.36.2]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt; CREATE KEYSPACE test WITH REPLICATION = { &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt; : 3 };
cqlsh&amp;gt; USE test;
cqlsh:test&amp;gt; CREATE TABLE foo (bar text, baz text, qux text, PRIMARY KEY(bar, baz) ) WITH COMPACT STORAGE;
cqlsh:test&amp;gt; describe table foo;

CREATE TABLE foo (
  bar text,
  baz text,
  qux text,
  PRIMARY KEY (bar, baz)
) WITH COMPACT STORAGE AND
  bloom_filter_fp_chance=0.010000 AND
  caching=&lt;span class=&quot;code-quote&quot;&gt;&apos;KEYS_ONLY&apos;&lt;/span&gt; AND
  comment=&apos;&apos; AND
  dclocal_read_repair_chance=0.000000 AND
  gc_grace_seconds=864000 AND
  read_repair_chance=0.100000 AND
  replicate_on_write=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;&lt;/span&gt; AND
  populate_io_cache_on_flush=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&apos;&lt;/span&gt; AND
  compaction={&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SizeTieredCompactionStrategy&apos;&lt;/span&gt;} AND
  compression={&lt;span class=&quot;code-quote&quot;&gt;&apos;sstable_compression&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SnappyCompressor&apos;&lt;/span&gt;};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now in cli:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  Connected to: &lt;span class=&quot;code-quote&quot;&gt;&quot;cluster1&quot;&lt;/span&gt; on 127.0.0.3/9160
Welcome to Cassandra CLI version 1.2.15-SNAPSHOT

Type &lt;span class=&quot;code-quote&quot;&gt;&apos;help;&apos;&lt;/span&gt; or &lt;span class=&quot;code-quote&quot;&gt;&apos;?&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
Type &lt;span class=&quot;code-quote&quot;&gt;&apos;quit;&apos;&lt;/span&gt; or &lt;span class=&quot;code-quote&quot;&gt;&apos;exit;&apos;&lt;/span&gt; to quit.

[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@unknown] use test;
Authenticated to keyspace: test
[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@test] UPDATE COLUMN FAMILY foo WITH comment=&lt;span class=&quot;code-quote&quot;&gt;&apos;hey &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is a comment&apos;&lt;/span&gt;;
3bf5fa49-5d03-34f0-b46c-6745f7740925
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now back in cqlsh:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:test&amp;gt; describe table foo;

CREATE TABLE foo (
  bar text,
  column1 text,
  value text,
  PRIMARY KEY (bar, column1)
) WITH COMPACT STORAGE AND
  bloom_filter_fp_chance=0.010000 AND
  caching=&lt;span class=&quot;code-quote&quot;&gt;&apos;KEYS_ONLY&apos;&lt;/span&gt; AND
  comment=&lt;span class=&quot;code-quote&quot;&gt;&apos;hey &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is a comment&apos;&lt;/span&gt; AND
  dclocal_read_repair_chance=0.000000 AND
  gc_grace_seconds=864000 AND
  read_repair_chance=0.100000 AND
  replicate_on_write=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;&lt;/span&gt; AND
  populate_io_cache_on_flush=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&apos;&lt;/span&gt; AND
  compaction={&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SizeTieredCompactionStrategy&apos;&lt;/span&gt;} AND
  compression={&lt;span class=&quot;code-quote&quot;&gt;&apos;sstable_compression&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SnappyCompressor&apos;&lt;/span&gt;};

cqlsh:test&amp;gt; ALTER TABLE foo WITH comment=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; comment&apos;&lt;/span&gt;;
cqlsh:test&amp;gt; describe table foo;

CREATE TABLE foo (
  bar text,
  baz text,
  qux text,
  PRIMARY KEY (bar, baz)
) WITH COMPACT STORAGE AND
  bloom_filter_fp_chance=0.010000 AND
  caching=&lt;span class=&quot;code-quote&quot;&gt;&apos;KEYS_ONLY&apos;&lt;/span&gt; AND
  comment=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; comment&apos;&lt;/span&gt; AND
  dclocal_read_repair_chance=0.000000 AND
  gc_grace_seconds=864000 AND
  read_repair_chance=0.100000 AND
  replicate_on_write=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&apos;&lt;/span&gt; AND
  populate_io_cache_on_flush=&lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&apos;&lt;/span&gt; AND
  compaction={&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SizeTieredCompactionStrategy&apos;&lt;/span&gt;} AND
  compression={&lt;span class=&quot;code-quote&quot;&gt;&apos;sstable_compression&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SnappyCompressor&apos;&lt;/span&gt;};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12699814">CASSANDRA-6831</key>
            <summary>Updates to COMPACT STORAGE tables via cli drop CQL information</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="devdazed">Russell Bradberry</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Mar 2014 17:47:46 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:52 +0000</updated>
                            <resolved>Mon, 5 May 2014 07:31:30 +0000</resolved>
                                        <fixVersion>1.2.17</fixVersion>
                    <fixVersion>2.0.8</fixVersion>
                    <fixVersion>2.1 beta2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13960368" author="mishail" created="Fri, 4 Apr 2014 20:27:58 +0000"  >&lt;p&gt;Here&apos;s what I&apos;ve seen on the 2.1 branch.&lt;br/&gt;
The table was created in ``cqlsh``&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;cqlsh&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[cqlsh 5.0.0 | Cassandra 2.1.0-beta1-SNAPSHOT | CQL spec 3.1.5 | Native protocol v2]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt;
cqlsh&amp;gt;  CREATE KEYSPACE test WITH REPLICATION = { &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt; : 1 };
cqlsh&amp;gt; use test;
cqlsh:test&amp;gt; CREATE TABLE foo (bar text, baz text, qux text, PRIMARY KEY(bar, baz) ) WITH COMPACT STORAGE;
cqlsh:test&amp;gt; DESCRIBE TABLE foo;

CREATE TABLE test.foo (
    bar text,
    baz text,
    qux text,
    PRIMARY KEY (bar, baz)
) WITH COMPACT STORAGE
    AND CLUSTERING ORDER BY (baz ASC)
    AND bloom_filter_fp_chance = 0.01
    AND caching = &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;keys&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;ALL&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;rows_per_partition&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;NONE&quot;&lt;/span&gt;}&apos;&lt;/span&gt;
    AND comment = &apos;&apos;
    AND compaction = {&lt;span class=&quot;code-quote&quot;&gt;&apos;min_threshold&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;4&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;max_threshold&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;32&apos;&lt;/span&gt;}
    AND compression = {&lt;span class=&quot;code-quote&quot;&gt;&apos;sstable_compression&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.io.compress.LZ4Compressor&apos;&lt;/span&gt;}
    AND default_time_to_live = 0
    AND gc_grace_seconds = 864000
    AND max_index_interval = 2048
    AND memtable_flush_period_in_ms = 0
    AND min_index_interval = 128
    AND populate_io_cache_on_flush = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
    AND read_repair_chance = 0.1
    AND speculative_retry = &lt;span class=&quot;code-quote&quot;&gt;&apos;99.0PERCENTILE&apos;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I did the stuff in ``cassandra-cli``&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;cassandra-cli&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mstepura-mac:cassandra mikhail$ bin/cassandra-cli
Connected to: &lt;span class=&quot;code-quote&quot;&gt;&quot;Test Cluster&quot;&lt;/span&gt; on 127.0.0.1/9160
Welcome to Cassandra CLI version 2.1.0-beta1-SNAPSHOT

The CLI is deprecated and will be removed in Cassandra 3.0.  Consider migrating to cqlsh.
CQL is fully backwards compatible with Thrift data; see http:&lt;span class=&quot;code-comment&quot;&gt;//www.datastax.com/dev/blog/thrift-to-cql3
&lt;/span&gt;
Type &lt;span class=&quot;code-quote&quot;&gt;&apos;help;&apos;&lt;/span&gt; or &lt;span class=&quot;code-quote&quot;&gt;&apos;?&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
Type &lt;span class=&quot;code-quote&quot;&gt;&apos;quit;&apos;&lt;/span&gt; or &lt;span class=&quot;code-quote&quot;&gt;&apos;exit;&apos;&lt;/span&gt; to quit.

[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@unknown] use test;
Authenticated to keyspace: test
[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@test] UPDATE COLUMN FAMILY foo WITH comment=&lt;span class=&quot;code-quote&quot;&gt;&apos;hey &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is a comment&apos;&lt;/span&gt;;
org.apache.thrift.transport.TTransportException
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Meanwhile in the logs&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR 20:14:17 Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MigrationStage:1,5,main]
java.lang.AssertionError: There shouldn&apos;t be more than one compact value defined: got ColumnDefinition{name=qux, type=org.apache.cassandra.db.marshal.UTF8Type, kind=COMPACT_VALUE, componentIndex=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexName=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexType=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;} and ColumnDefinition{name=value, type=org.apache.cassandra.db.marshal.UTF8Type, kind=COMPACT_VALUE, componentIndex=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexName=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexType=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}
	at org.apache.cassandra.config.CFMetaData.rebuild(CFMetaData.java:1981) ~[main/:na]
	at org.apache.cassandra.config.CFMetaData.fromSchemaNoTriggers(CFMetaData.java:1751) ~[main/:na]
	at org.apache.cassandra.config.CFMetaData.fromSchema(CFMetaData.java:1791) ~[main/:na]
	at org.apache.cassandra.config.KSMetaData.deserializeColumnFamilies(KSMetaData.java:320) ~[main/:na]
	at org.apache.cassandra.db.DefsTables.mergeColumnFamilies(DefsTables.java:306) ~[main/:na]
	at org.apache.cassandra.db.DefsTables.mergeSchema(DefsTables.java:181) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager$2.runMayThrow(MigrationManager.java:306) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_51]
	at java.util.concurrent.FutureTask.run(FutureTask.java:262) ~[na:1.7.0_51]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_51]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_51]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744) [na:1.7.0_51]
ERROR 20:14:17 Error occurred during processing of message.
java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.AssertionError: There shouldn&apos;t be more than one compact value defined: got ColumnDefinition{name=qux, type=org.apache.cassandra.db.marshal.UTF8Type, kind=COMPACT_VALUE, componentIndex=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexName=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexType=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;} and ColumnDefinition{name=value, type=org.apache.cassandra.db.marshal.UTF8Type, kind=COMPACT_VALUE, componentIndex=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexName=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexType=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:411) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager.announce(MigrationManager.java:288) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager.announceColumnFamilyUpdate(MigrationManager.java:242) ~[main/:na]
	at org.apache.cassandra.thrift.CassandraServer.system_update_column_family(CassandraServer.java:1676) ~[main/:na]
	at org.apache.cassandra.thrift.Cassandra$Processor$system_update_column_family.getResult(Cassandra.java:4430) ~[thrift/:na]
	at org.apache.cassandra.thrift.Cassandra$Processor$system_update_column_family.getResult(Cassandra.java:4414) ~[thrift/:na]
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39) ~[libthrift-0.9.1.jar:0.9.1]
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:39) ~[libthrift-0.9.1.jar:0.9.1]
	at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:201) ~[main/:na]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_51]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_51]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744) [na:1.7.0_51]
Caused by: java.util.concurrent.ExecutionException: java.lang.AssertionError: There shouldn&apos;t be more than one compact value defined: got ColumnDefinition{name=qux, type=org.apache.cassandra.db.marshal.UTF8Type, kind=COMPACT_VALUE, componentIndex=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexName=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexType=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;} and ColumnDefinition{name=value, type=org.apache.cassandra.db.marshal.UTF8Type, kind=COMPACT_VALUE, componentIndex=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexName=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexType=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}
	at java.util.concurrent.FutureTask.report(FutureTask.java:122) ~[na:1.7.0_51]
	at java.util.concurrent.FutureTask.get(FutureTask.java:188) ~[na:1.7.0_51]
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:407) ~[main/:na]
	... 11 common frames omitted
Caused by: java.lang.AssertionError: There shouldn&apos;t be more than one compact value defined: got ColumnDefinition{name=qux, type=org.apache.cassandra.db.marshal.UTF8Type, kind=COMPACT_VALUE, componentIndex=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexName=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexType=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;} and ColumnDefinition{name=value, type=org.apache.cassandra.db.marshal.UTF8Type, kind=COMPACT_VALUE, componentIndex=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexName=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, indexType=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;}
	at org.apache.cassandra.config.CFMetaData.rebuild(CFMetaData.java:1981) ~[main/:na]
	at org.apache.cassandra.config.CFMetaData.fromSchemaNoTriggers(CFMetaData.java:1751) ~[main/:na]
	at org.apache.cassandra.config.CFMetaData.fromSchema(CFMetaData.java:1791) ~[main/:na]
	at org.apache.cassandra.config.KSMetaData.deserializeColumnFamilies(KSMetaData.java:320) ~[main/:na]
	at org.apache.cassandra.db.DefsTables.mergeColumnFamilies(DefsTables.java:306) ~[main/:na]
	at org.apache.cassandra.db.DefsTables.mergeSchema(DefsTables.java:181) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager$2.runMayThrow(MigrationManager.java:306) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_51]
	at java.util.concurrent.FutureTask.run(FutureTask.java:262) ~[na:1.7.0_51]
	... 3 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then I quit ``cqlsh`` and start in again, and now I have&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;cqlsh after cli&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Connected to Test Cluster at 127.0.0.1:9042.
[cqlsh 5.0.0 | Cassandra 2.1.0-beta1-SNAPSHOT | CQL spec 3.1.5 | Native protocol v2]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt; use test;
cqlsh:test&amp;gt; DESCRIBE TABLE foo;

CREATE TABLE test.foo (
    bar text,
    column1 text,
    value text,
    baz text,
    qux text,
    PRIMARY KEY (bar, column1)
) WITH COMPACT STORAGE
    AND CLUSTERING ORDER BY (column1 ASC)
    AND bloom_filter_fp_chance = 0.01
    AND caching = &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;keys&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;ALL&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;rows_per_partition&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;NONE&quot;&lt;/span&gt;}&apos;&lt;/span&gt;
    AND comment = &lt;span class=&quot;code-quote&quot;&gt;&apos;hey &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; is a comment&apos;&lt;/span&gt;
    AND compaction = {&lt;span class=&quot;code-quote&quot;&gt;&apos;min_threshold&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;4&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;max_threshold&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;32&apos;&lt;/span&gt;}
    AND compression = {&lt;span class=&quot;code-quote&quot;&gt;&apos;sstable_compression&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.io.compress.LZ4Compressor&apos;&lt;/span&gt;}
    AND default_time_to_live = 0
    AND gc_grace_seconds = 864000
    AND max_index_interval = 2048
    AND memtable_flush_period_in_ms = 0
    AND min_index_interval = 128
    AND populate_io_cache_on_flush = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
    AND read_repair_chance = 0.1
    AND speculative_retry = &lt;span class=&quot;code-quote&quot;&gt;&apos;99.0PERCENTILE&apos;&lt;/span&gt;;
cqlsh:test&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13963784" author="mishail" created="Wed, 9 Apr 2014 04:18:07 +0000"  >&lt;p&gt;So, &lt;tt&gt;CFMetaData&lt;/tt&gt; created &lt;em&gt;fromThrift&lt;/em&gt; has no information about column/value aliases. I guess we can just copy those aliases from the &lt;em&gt;old&lt;/em&gt; meta data.&lt;/p&gt;

&lt;p&gt;Attaching the patch for that.&lt;/p&gt;
</comment>
                            <comment id="13963786" author="mishail" created="Wed, 9 Apr 2014 04:19:43 +0000"  >&lt;p&gt;I still need to figure out how to fix those AssertionError&apos;s on 2.0/2.1. &lt;/p&gt;</comment>
                            <comment id="13965749" author="iamaleksey" created="Thu, 10 Apr 2014 19:31:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mishail&quot; class=&quot;user-hover&quot; rel=&quot;mishail&quot;&gt;mishail&lt;/a&gt; So, do you want to delay review until then or not? (if yes, cancel the patch, please).&lt;/p&gt;</comment>
                            <comment id="13965760" author="mishail" created="Thu, 10 Apr 2014 19:36:58 +0000"  >&lt;p&gt;The patch is for 1.2 only, and it does fix the described problem. The patch is not applicable for 2.0/2.1. &lt;/p&gt;

&lt;p&gt;So, yes, the patch can be reviewed for 1.2, and we can track changes for 2.0/2.1 under different JIRA issue. &lt;/p&gt;</comment>
                            <comment id="13965772" author="iamaleksey" created="Thu, 10 Apr 2014 19:52:47 +0000"  >&lt;p&gt;TBH I think the right way to fix this is to reject any attempts from CLI/Thrift in general if a table has non-default aliases.&lt;/p&gt;

&lt;p&gt;You should not be mixing schema changes from CLI and cqlsh, should stick to one.&lt;/p&gt;</comment>
                            <comment id="13965774" author="iamaleksey" created="Thu, 10 Apr 2014 19:54:57 +0000"  >&lt;p&gt;That is, treat these tables (that have CQL metadata with them) as CQL3 tables, even if they have WITH COMPACT STORAGE, and extend &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6370&quot; title=&quot;Updating cql created table through cassandra-cli transform it into a compact storage table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6370&quot;&gt;&lt;del&gt;CASSANDRA-6370&lt;/del&gt;&lt;/a&gt; to them.&lt;/p&gt;</comment>
                            <comment id="13965775" author="mishail" created="Thu, 10 Apr 2014 19:55:59 +0000"  >&lt;p&gt;That&apos;s the easiest way to fix the problem&lt;/p&gt;</comment>
                            <comment id="13967052" author="mishail" created="Fri, 11 Apr 2014 20:25:19 +0000"  >&lt;p&gt;I&apos;m trying to understand changes made by this commit (for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5702&quot; title=&quot;ALTER RENAME is broken in trunk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5702&quot;&gt;&lt;del&gt;CASSANDRA-5702&lt;/del&gt;&lt;/a&gt;): &lt;a href=&quot;https://github.com/apache/cassandra/commit/67435b528dd474bd25fc90eaace6e6786f75ce04#diff-75146ba408a51071a0b19ffdfbb2bb3cL1965&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/67435b528dd474bd25fc90eaace6e6786f75ce04#diff-75146ba408a51071a0b19ffdfbb2bb3cL1965&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Before that, only tables with REGULAR columns with &lt;tt&gt;componentIndex == null&lt;/tt&gt;  were Thrift-&lt;b&gt;compatible&lt;/b&gt;, i.e. tables WITH COMPACT STORAGE weren&apos;t compatible.&lt;br/&gt;
After those changes, only tables which have a REGULAR column with &lt;tt&gt;componentIndex != null&lt;/tt&gt; became Thrift &lt;b&gt;incompatible&lt;/b&gt;, i.e. tables WITH COMPACT STORAGE became compatible&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; could you guys shed more light on that? Can we switch back to the previous behavior?&lt;/p&gt;</comment>
                            <comment id="13968866" author="iamaleksey" created="Mon, 14 Apr 2014 21:28:40 +0000"  >&lt;p&gt;Hmm. There are two compatibility levels:&lt;/p&gt;

&lt;p&gt;1. Using Thrift API, can I safely perform write requests against a column family if I only have access to its Thrift metadata? (true for all column families except those with compound sparse comparators, aka &apos;CQL3 tables&apos;)&lt;br/&gt;
2. Using Thrift API, can I update the column family without potentially losing extra metadata added via CQL? Now this depends strictly on whether or not such metadata (aliases) have been added via CQL3.&lt;/p&gt;

&lt;p&gt;WITH COMPACT STORAGE tables are always 1-compatible (including tools that auto-generate code and ORM-style libraries), but not always 2-compatible (depends on whether or not the the table has been created via CQL3 or altered via CQL3 to rename default aliases).&lt;/p&gt;

&lt;p&gt;Now that I&apos;ve thought about this more, I think we should go with your original approach (copy the aliases from the original CFMetaData), but handle that assertion in this very ticket.&lt;/p&gt;</comment>
                            <comment id="13978916" author="mishail" created="Wed, 23 Apr 2014 21:15:54 +0000"  >&lt;p&gt;I&apos;m attaching patches for 1.2 and 2.0, to copy aliases from &quot;old&quot; column family&lt;/p&gt;</comment>
                            <comment id="13979374" author="slebresne" created="Thu, 24 Apr 2014 07:09:03 +0000"  >&lt;p&gt;I definitively get why 2.0 is broken and I&apos;m good with copying aliases there, but for 1.2, this problem is supposed to be handled by &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-1.2/src/java/org/apache/cassandra/config/CFMetaData.java#L805-L814&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-1.2/src/java/org/apache/cassandra/config/CFMetaData.java#L805-L814&lt;/a&gt;. Can we check why this isn&apos;t working anymore first (and I&apos;m fine removing this code in favor of the attached patch, but we need to make sure we understand what&apos;s wrong with it first).&lt;/p&gt;</comment>
                            <comment id="13979947" author="mishail" created="Thu, 24 Apr 2014 16:45:54 +0000"  >&lt;p&gt;I&apos;ll take a look&lt;/p&gt;</comment>
                            <comment id="13980098" author="mishail" created="Thu, 24 Apr 2014 18:59:13 +0000"  >&lt;p&gt;So, here is how I see what&apos;s happening on 1.2:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;We create CFMetaData from Thrift (i.e. no aliases)&lt;/li&gt;
	&lt;li&gt;We create a mutation from that Thrift-based metadata ( &lt;tt&gt;newState.toSchemaNoColumns(rm, modificationTimestamp);&lt;/tt&gt; ). This mutation will delete all column/value aliases from &lt;tt&gt;schema_columnfamilies&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;We apply the mutation (&lt;tt&gt;DefsTable.mergeSchema&lt;/tt&gt;). &lt;b&gt;Damage done&lt;/b&gt;.&lt;/li&gt;
	&lt;li&gt;We reload in-memory presentation. Now the &lt;tt&gt;apply(CFMetaData cfm)&lt;/tt&gt; merges the both definitions, correctly keeping column/value aliases, but they are now in-memory only (in &lt;tt&gt;Schema.instance&lt;/tt&gt;), there are no aliases in the &lt;tt&gt;schema_columnfamilies&lt;/tt&gt; and this information will be lost on a next restart.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;And the patch populates the columns/value aliases for that Thrift-based metadata, hence the mutation doesn&apos;t erase them.&lt;/p&gt;</comment>
                            <comment id="13980856" author="slebresne" created="Fri, 25 Apr 2014 10:09:45 +0000"  >&lt;p&gt;Makes sense, thanks for having looked at it. Then I guess for 1.2 we should remove the lines mentioned above in favor of the alias copy of your patch.&lt;/p&gt;

&lt;p&gt;Regarding the 2.0 patch (the 1.2 patch if fine imo, modulo the lines deletion I just mentioned), I&apos;d prefer dealing with this somewhat earlier, in the &lt;tt&gt;fromThrift&lt;/tt&gt; method: no need to build the CQL metadata with default values to replace them afterwards. So attaching an alternative that feels a little bit better encapsulated.&lt;/p&gt;</comment>
                            <comment id="13983319" author="iamaleksey" created="Mon, 28 Apr 2014 18:00:11 +0000"  >&lt;p&gt;1.2 patch - LGTM (w/ those lines removed, and I&apos;d rather inline copyAliasesFrom(), since it&apos;s not reused and is tiny).&lt;br/&gt;
2.0 patch (v2) LGTM&lt;/p&gt;</comment>
                            <comment id="13985109" author="mishail" created="Wed, 30 Apr 2014 03:21:05 +0000"  >&lt;p&gt;Attaching the new patch for 1.2 (adjusted as per comments), and patch for 2.1 based on Sylvain&apos;s patch.&lt;br/&gt;
I give up trying to commit those changes, I have no enough git powers to do that.&lt;/p&gt;

&lt;p&gt;I&apos;m able to apply them and merge the branches locally, but &lt;tt&gt;git pull&lt;/tt&gt; becomes a nightmare after that. I have no guts to push them in the wild.&lt;/p&gt;</comment>
                            <comment id="13985321" author="slebresne" created="Wed, 30 Apr 2014 09:36:41 +0000"  >&lt;p&gt;Ok, committed the patches then, thanks.&lt;/p&gt;</comment>
                            <comment id="13986123" author="thobbs" created="Wed, 30 Apr 2014 21:41:40 +0000"  >&lt;p&gt;It looks like the 2.1 patch broke CF secondary index creation through Thrift.  The following error shows up when when adding a column definition with an index on it:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [MigrationStage:1] 2014-04-30 16:34:11,766 DefsTables.java:388 - Loading org.apache.cassandra.config.CFMetaData@1547508d[cfId=2b5c99b0-d0af-11e3-a938-6b09a6cc3d5a,ksName=PycassaTestKeyspace,cfName=Indexed1,cfType=Standard,comparator=org.apache.cassandra.db.marshal.BytesType,comment=,readRepairChance=0.1,dclocalReadRepairChance=0.0,gcGraceSeconds=864000,defaultValidator=org.apache.cassandra.db.marshal.BytesType,keyValidator=org.apache.cassandra.db.marshal.BytesType,minCompactionThreshold=4,maxCompactionThreshold=32,columnMetadata={java.nio.HeapByteBuffer[pos=0 lim=3 cap=3]=ColumnDefinition{name=key, type=org.apache.cassandra.db.marshal.BytesType, kind=PARTITION_KEY, componentIndex=null, indexName=null, indexType=null}, java.nio.HeapByteBuffer[pos=0 lim=5 cap=5]=ColumnDefinition{name=value, type=org.apache.cassandra.db.marshal.BytesType, kind=COMPACT_VALUE, componentIndex=null, indexName=null, indexType=null}, java.nio.HeapByteBuffer[pos=0 lim=7 cap=7]=ColumnDefinition{name=column1, type=org.apache.cassandra.db.marshal.BytesType, kind=CLUSTERING_COLUMN, componentIndex=null, indexName=null, indexType=null}},compactionStrategyClass=class org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy,compactionStrategyOptions={},compressionParameters={sstable_compression=org.apache.cassandra.io.compress.LZ4Compressor},bloomFilterFpChance=&amp;lt;null&amp;gt;,memtableFlushPeriod=0,caching={&quot;keys&quot;:&quot;ALL&quot;, &quot;rows_per_partition&quot;:&quot;NONE&quot;},defaultTimeToLive=0,minIndexInterval=128,maxIndexInterval=2048,speculativeRetry=NONE,droppedColumns={},triggers={}]
INFO  [MigrationStage:1] 2014-04-30 16:34:11,771 ColumnFamilyStore.java:285 - Initializing PycassaTestKeyspace.Indexed1
ERROR [Thrift:1] 2014-04-30 16:34:11,810 CustomTThreadPoolServer.java:219 - Error occurred during processing of message.
java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
    at java.util.ArrayList.rangeCheck(ArrayList.java:635) ~[na:1.7.0_40]
    at java.util.ArrayList.set(ArrayList.java:426) ~[na:1.7.0_40]
    at org.apache.cassandra.config.CFMetaData.rebuild(CFMetaData.java:2037) ~[main/:na]
    at org.apache.cassandra.config.CFMetaData.fromThriftForUpdate(CFMetaData.java:1036) ~[main/:na]
    at org.apache.cassandra.thrift.CassandraServer.system_update_column_family(CassandraServer.java:1668) ~[main/:na]
    at org.apache.cassandra.thrift.Cassandra$Processor$system_update_column_family.getResult(Cassandra.java:4430) ~[thrift/:na]
    at org.apache.cassandra.thrift.Cassandra$Processor$system_update_column_family.getResult(Cassandra.java:4414) ~[thrift/:na]
    at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39) ~[libthrift-0.9.1.jar:0.9.1]
    at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:39) ~[libthrift-0.9.1.jar:0.9.1]
    at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:201) ~[main/:na]
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_40]
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_40]
    at java.lang.Thread.run(Thread.java:724) [na:1.7.0_40]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;.&lt;/p&gt;</comment>
                            <comment id="13986670" author="slebresne" created="Thu, 1 May 2014 15:28:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mishail&quot; class=&quot;user-hover&quot; rel=&quot;mishail&quot;&gt;mishail&lt;/a&gt; You might not be testing the right commit (or use the right test) because I do get the test failure Tyler mentions.&lt;/p&gt;

&lt;p&gt;The problem is a tad subtle, and not directly related to the patch (which mainly uncovered something that was wrong before).  What happens is that when we build the comparator in fromThrit, we don&apos;t take the copied CQL metadata to decide if the table is dense or not. This result in the addition of the index, which adds column_metadata where there was none, to switch the comparator from an initially dense one to a sparse one. But that&apos;s what confuse the rebuild() since we end up with a non-composite sparse comparator and a CLUSTERING_KEY definition, which incompatible.&lt;/p&gt;

&lt;p&gt;Now the reason I said this is not directly related to the patch is that before this patch, fromThrift was already returning a sparse comparator when it shouldn&apos;t have (since the table was dense initially), but because we were not copying the CQL metadata, no exception was triggered and the mistake was &quot;repaired&quot; as soon as the update was written on disk since then previous CQL metadata were picked up so that the table was left dense as should be. In other words, the code was fishy and not doing what we meant it to do, but that had no visible consequence out of sheer luck.&lt;/p&gt;

&lt;p&gt;Anyway I&apos;m attaching a patch that slightly refactor the fromThrift so that we do take all metadata into account when computing isDense(). The patch is 2.1 only, 2.0 is not affected because we don&apos;t compute isDense at the same places.&lt;/p&gt;

&lt;p&gt;Now I&apos;ll note that while that make the pycassa tests run, there is 3 failures.  One of them is actually due to the fact that the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6738&quot; title=&quot;java.lang.ClassCastException: org.apache.cassandra.db.composites.CompoundComposite cannot be cast to org.apache.cassandra.db.composites.CellName&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6738&quot;&gt;&lt;del&gt;CASSANDRA-6738&lt;/del&gt;&lt;/a&gt; patch was incomplete so attaching a simple 2nd patch to fix that (I can create a separate issue for that if people prefer but well, that&apos;s a simple fix). The other two failure are super-columns related but I haven&apos;t yet looked into them (but it&apos;s likely they are not related to this ticket).&lt;/p&gt;</comment>
                            <comment id="13986758" author="thobbs" created="Thu, 1 May 2014 16:50:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;One of them is actually due to the fact that the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6738&quot; title=&quot;java.lang.ClassCastException: org.apache.cassandra.db.composites.CompoundComposite cannot be cast to org.apache.cassandra.db.composites.CellName&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6738&quot;&gt;&lt;del&gt;CASSANDRA-6738&lt;/del&gt;&lt;/a&gt; patch was incomplete so attaching a simple 2nd patch to fix that (I can create a separate issue for that if people prefer but well, that&apos;s a simple fix).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7112&quot; title=&quot;ava.lang.ClassCastException: org.apache.cassandra.db.composites.CompoundComposite cannot be cast to org.apache.cassandra.db.composites.CellName&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7112&quot;&gt;&lt;del&gt;CASSANDRA-7112&lt;/del&gt;&lt;/a&gt; a couple of days ago for that.  Want to move the patch and review there?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The other two failure are super-columns related but I haven&apos;t yet looked into them (but it&apos;s likely they are not related to this ticket).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;On 7112 I mentioned that the failing super column tests may be related, but if they&apos;re not, we can create a new ticket for those.&lt;/p&gt;</comment>
                            <comment id="13987534" author="slebresne" created="Fri, 2 May 2014 09:25:13 +0000"  >&lt;p&gt;Oh, I had missed &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7112&quot; title=&quot;ava.lang.ClassCastException: org.apache.cassandra.db.composites.CompoundComposite cannot be cast to org.apache.cassandra.db.composites.CellName&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7112&quot;&gt;&lt;del&gt;CASSANDRA-7112&lt;/del&gt;&lt;/a&gt;, my bad. That&apos;s definitively where we should handle this so moved the patch there. Let&apos;s decide what we do for the super columns problem there too.&lt;/p&gt;

&lt;p&gt;So to summarize, as far as this ticket goes, the fix is just the 0001-Properly-recompute-denseness-of-the-table-on-thrift-up patch which is ready for review.&lt;/p&gt;</comment>
                            <comment id="13988238" author="iamaleksey" created="Fri, 2 May 2014 21:01:51 +0000"  >&lt;p&gt;LGTM&lt;/p&gt;

&lt;p&gt;Attaching 6831-nits.txt that fixes the ColumnDefinitionTest and cleans up unused imports in CFMetaData.&lt;/p&gt;

&lt;p&gt;(Also some unrelated stuff that probably might belong to a separate commit - normalizes if-formatting in CFMetaData#internalFromThrift() and removes the left-over empty populate_io_cache_on_flush setting branch).&lt;/p&gt;</comment>
                            <comment id="13989330" author="slebresne" created="Mon, 5 May 2014 07:31:30 +0000"  >&lt;p&gt;Committed with nits, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12642861" name="0001-Properly-recompute-denseness-of-the-table-on-thrift-up.txt" size="11541" author="slebresne" created="Thu, 1 May 2014 15:28:23 +0000"/>
                            <attachment id="12642588" name="6831-1.2.patch" size="2738" author="mishail" created="Wed, 30 Apr 2014 03:21:05 +0000"/>
                            <attachment id="12641903" name="6831-2.0-v2.txt" size="10732" author="slebresne" created="Fri, 25 Apr 2014 10:09:45 +0000"/>
                            <attachment id="12642587" name="6831-2.1.patch" size="8556" author="mishail" created="Wed, 30 Apr 2014 03:21:05 +0000"/>
                            <attachment id="12643132" name="6831-nits.txt" size="9151" author="aleksey" created="Fri, 2 May 2014 21:47:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>378160</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 29 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1t5tb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>378452</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326174">1.2.16</customfieldvalue>
    <customfieldvalue id="12326170">2.0.6</customfieldvalue>
    <customfieldvalue id="12326275">2.1 beta1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>