<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:26:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18200] Cassandra messaging to self changed behavior</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18200</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;During testing of Cassandra on AWS, we noticed some behavior changes between Cassandra 3.11 and Cassandra 4.0 when it comes to messaging.&lt;br/&gt;
When performing a range query with consistency local_quorum, Cassandra sents a request to itself and some peers.&lt;br/&gt;
In case of Cassandra 4.0, it&apos;s trying to connect to itself using the broadcast_address while in Cassandra 3.11 it&apos;s connecting using the local address (see &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11/src/java/org/apache/cassandra/net/OutboundTcpConnectionPool.java#L152&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.11/src/java/org/apache/cassandra/net/OutboundTcpConnectionPool.java#L152&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This translation seems to be missing in Cassandra 4.X. I think the best place to fix it would be here (see attached file): &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0/src/java/org/apache/cassandra/net/OutboundConnectionSettings.java#L451&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.0/src/java/org/apache/cassandra/net/OutboundConnectionSettings.java#L451&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13521587">CASSANDRA-18200</key>
            <summary>Cassandra messaging to self changed behavior</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="masokol">Maciej Sokol</assignee>
                                    <reporter username="masokol">Maciej Sokol</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Jan 2023 06:59:49 +0000</created>
                <updated>Tue, 12 Sep 2023 13:03:08 +0000</updated>
                            <resolved>Mon, 30 Jan 2023 13:08:16 +0000</resolved>
                                        <fixVersion>4.0.8</fixVersion>
                    <fixVersion>4.1.1</fixVersion>
                    <fixVersion>5.0-alpha1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                    <component>Messaging/Internode</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17680981" author="brandon.williams" created="Thu, 26 Jan 2023 12:49:19 +0000"  >&lt;p&gt;I think this may actually be a bug in 3.11, since it is not checking the preferred IP, which is what is stored when the snitch is configured with prefer_local set to true.  I need to think about this a bit more, but I am interested in the context of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16718&quot; title=&quot;Changing listen_address with prefer_local may lead to issues&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16718&quot;&gt;&lt;del&gt;CASSANDRA-16718&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17680990" author="JIRAUSER285315" created="Thu, 26 Jan 2023 13:14:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; From my understanding, prefer_local is only used for the peers, in this case the node is trying to message itself.&lt;/p&gt;</comment>
                            <comment id="17680992" author="brandon.williams" created="Thu, 26 Jan 2023 13:24:33 +0000"  >&lt;p&gt;Yes but these methods in OTC and OCS are used by everything.&lt;/p&gt;</comment>
                            <comment id="17681203" author="JIRAUSER285315" created="Fri, 27 Jan 2023 07:09:41 +0000"  >&lt;p&gt;If I understand you correctly, you want prefer_local to affect the local node as well and not always use local IP?&lt;/p&gt;

&lt;p&gt;I have also tried to use prefer_local, it only affects the peers not the messaging to node itself.&lt;/p&gt;

&lt;p&gt;I&apos;ve tested Cassandra 4 with my patch and now it works correctly, previously ranged queries and other communication within node through messaging did not work (because the pod behind LB cannot connect to itself through LB).&lt;/p&gt;</comment>
                            <comment id="17681348" author="brandon.williams" created="Fri, 27 Jan 2023 14:01:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;If I understand you correctly, you want prefer_local to affect the local node as well and not always use local IP?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not necessarily, I need to think about how listen_on_broadcast_address factors into this too.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I have also tried to use prefer_local, it only affects the peers not the messaging to node itself.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;All hosts uses these methods though, there is no distinction between self and peers when this is called.  We can see that getPreferredIP is being consulted already, and that returns the IP it was passed if no preferred IP was stored which is probably why it was a no-op for you.&lt;/p&gt;

&lt;p&gt;That said, it does seem to me like the correct behavior to always route our own broadcast address back to the listen address, but then listen_on_broadcast_address would have no purpose, or at least I&apos;m not sure how it would factor into this.&lt;/p&gt;</comment>
                            <comment id="17681393" author="brandon.williams" created="Fri, 27 Jan 2023 16:08:05 +0000"  >&lt;p&gt;I think for this ticket, making 4.0&apos;s behavior compatible with what 3.11 does, makes sense.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-18200-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/826/workflows/efad0d63-ae57-4d4a-be69-657ca60ee8ca&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/826/workflows/cfaf30be-c9fe-41fc-8643-17553fe76708&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-18200-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/824/workflows/43e1fa3a-0173-4a11-9a16-4aeff9b544b4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/824/workflows/91a408fe-dbf1-43c3-bfc7-89465c2cf8ea&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-18200-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/825/workflows/cf9b1159-6a57-4793-97b8-879fc3693a99&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/825/workflows/7c0967c4-7428-483f-9a23-d926659d95a0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17681414" author="brandon.williams" created="Fri, 27 Jan 2023 17:23:45 +0000"  >&lt;p&gt;Everything looks good, one env dtest problem and schemaReset which is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18151&quot; title=&quot;Test failure: org.apache.cassandra.distributed.test.SchemaTest timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18151&quot;&gt;&lt;del&gt;CASSANDRA-18151&lt;/del&gt;&lt;/a&gt;. +1 from me.&lt;/p&gt;</comment>
                            <comment id="17681811" author="smiklosovic" created="Sun, 29 Jan 2023 23:20:59 +0000"  >&lt;p&gt;+1. Thank you. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; would you mind to merge it, please?&lt;/p&gt;</comment>
                            <comment id="17682077" author="brandon.williams" created="Mon, 30 Jan 2023 13:08:16 +0000"  >&lt;p&gt;Sure.  Committed, thanks for the review.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13054815" name="patch.txt" size="700" author="masokol" created="Thu, 26 Jan 2023 07:13:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[masokol]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12994" cascade-level="1"><![CDATA[Unavailable]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 41 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1fef4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/0b7e3a8ee7f9359eaf63208e12f32b19e6874e74&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/0b7e3a8ee7f9359eaf63208e12f32b19e6874e74&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;run CI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>