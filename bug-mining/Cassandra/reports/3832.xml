<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:57:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10238] Consolidating racks violates the RF contract</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10238</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I have only tested this on 2.0 so far, but I suspect it will affect multiple versions.&lt;/p&gt;

&lt;p&gt;Repro:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;create a datacenter with rf&amp;gt;1&lt;/li&gt;
	&lt;li&gt;create more than one rack in this datacenter&lt;/li&gt;
	&lt;li&gt;consolidate these racks into 1&lt;/li&gt;
	&lt;li&gt;getendpoints will reveal the RF in practice is 1, even though other tools will report the original RF that was set&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Restarting Cassandra will resolve this.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12861048">CASSANDRA-10238</key>
            <summary>Consolidating racks violates the RF contract</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Sep 2015 15:42:42 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:57 +0000</updated>
                            <resolved>Fri, 18 Sep 2015 11:46:01 +0000</resolved>
                                        <fixVersion>2.0.17</fixVersion>
                    <fixVersion>2.1.10</fixVersion>
                    <fixVersion>2.2.2</fixVersion>
                    <fixVersion>3.0.0 rc1</fixVersion>
                                    <component>Legacy/Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>19</watches>
                                                                                                                <comments>
                            <comment id="14725594" author="jbellis" created="Tue, 1 Sep 2015 15:45:46 +0000"  >&lt;p&gt;Ryan, can your team verify that this occurs on 2.1 as well?&lt;/p&gt;</comment>
                            <comment id="14725597" author="enigmacurry" created="Tue, 1 Sep 2015 15:47:30 +0000"  >&lt;p&gt;Yep, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhatch&quot; class=&quot;user-hover&quot; rel=&quot;rhatch&quot;&gt;rhatch&lt;/a&gt; will write a dtest.&lt;/p&gt;</comment>
                            <comment id="14725600" author="jbellis" created="Tue, 1 Sep 2015 15:48:09 +0000"  >&lt;p&gt;... sounds like Rocco is already working on it actually.&lt;/p&gt;</comment>
                            <comment id="14725640" author="htran@datastax.com" created="Tue, 1 Sep 2015 16:18:17 +0000"  >&lt;p&gt;Rocco&apos;s just focusing on testing if it happens on C* 2.1 &lt;/p&gt;</comment>
                            <comment id="14725864" author="rocco.varela" created="Tue, 1 Sep 2015 18:37:41 +0000"  >&lt;p&gt;I reproduced the RF inconsistency in Cassandra 2.1.8.689.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Cluster Setup:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;3 nodes&lt;/li&gt;
	&lt;li&gt;GossipingPropertyFileSnitch&lt;/li&gt;
	&lt;li&gt;1 DC, 3 racks (rack0, rack1, rack2), rack numbers initially match node numbers&lt;/li&gt;
	&lt;li&gt;Cassandra 2.1.8.689&lt;/li&gt;
	&lt;li&gt;Used cassandra-stress for data load, with modification for specifying DTCS (probably not needed)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;b&gt;Steps:&lt;/b&gt;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;create 1 datacenter, and KS with RF=3 (using DTCS)&lt;/li&gt;
	&lt;li&gt;created 3 racks during setup&lt;/li&gt;
	&lt;li&gt;consolidate these racks into 1, did this in phases, first collapsing rack on node0 (rack0-&amp;gt;rack1), then rack on node2 (rack2-&amp;gt;rack1)&lt;/li&gt;
	&lt;li&gt;getendpoints reveals different RF on each node, see output below&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;b&gt;Output:&lt;/b&gt;&lt;br/&gt;
Before collapsing racks:&lt;br/&gt;
node0&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;automaton@i-a0cf954d9:~$ nodetool getendpoints &lt;span class=&quot;code-quote&quot;&gt;&quot;keyspace1&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;standard1&quot;&lt;/span&gt; 36F41194
10.240.22.34
10.240.132.129
10.240.232.159
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;After collapsing racks:&lt;/b&gt;&lt;br/&gt;
node0&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;automaton@i-a0cf954d9:~$ nodetool getendpoints &lt;span class=&quot;code-quote&quot;&gt;&quot;keyspace1&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;standard1&quot;&lt;/span&gt; 36F41194
10.240.22.34
10.240.132.129
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;node1&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;automaton@i-8c39d23e6:~$ nodetool getendpoints &lt;span class=&quot;code-quote&quot;&gt;&quot;keyspace1&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;standard1&quot;&lt;/span&gt; 36F41194
10.240.22.34
10.240.132.129
10.240.232.159
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;node2&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;automaton@i-9d29327c8:~$ nodetool getendpoints &lt;span class=&quot;code-quote&quot;&gt;&quot;keyspace1&quot;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;standard1&quot;&lt;/span&gt; 36F41194
10.240.22.34
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Description of keyspace before and after collapsing racks:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh&amp;gt; desc keyspace keyspace1;

CREATE KEYSPACE keyspace1 WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;NetworkTopologyStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;DC1&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;3&apos;&lt;/span&gt;}  AND durable_writes = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;

CREATE TABLE keyspace1.standard1 (
    key blob PRIMARY KEY,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;C0&quot;&lt;/span&gt; blob,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;C1&quot;&lt;/span&gt; blob,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;C2&quot;&lt;/span&gt; blob,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;C3&quot;&lt;/span&gt; blob,
    &lt;span class=&quot;code-quote&quot;&gt;&quot;C4&quot;&lt;/span&gt; blob
)...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14739846" author="rhatch" created="Thu, 10 Sep 2015 23:27:27 +0000"  >&lt;p&gt;Was able to repro with a &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/545/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;simple dtest&lt;/a&gt;. Happening on 2.1 head, 3.0 head, 3.0.0-beta2, and trunk.&lt;/p&gt;

&lt;p&gt;Happens without DTCS, no large data write necessary.&lt;/p&gt;</comment>
                            <comment id="14740423" author="stefania" created="Fri, 11 Sep 2015 08:50:50 +0000"  >&lt;p&gt;I was able to fix the dtest on 2.1 with the &lt;a href=&quot;https://github.com/stef1927/cassandra/commits/10238-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch attached&lt;/a&gt;. The problem is that when the snitch reloads its configuration it does not update the topology in the token metadata. Nor do we do this when we receive an updated rack or dc over Gossip.&lt;/p&gt;

&lt;p&gt;I still need to add some unit tests for &lt;tt&gt;TokenMetadata.Topology&lt;/tt&gt;, since I modified it somewhat.  &lt;/p&gt;

&lt;p&gt;Do we also need more dtests? Things like:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Any other snitches that can update their configuration&lt;/li&gt;
	&lt;li&gt;Any other snitch configuration parameters can be updated other than the rack&lt;/li&gt;
	&lt;li&gt;Multiple dcs&lt;/li&gt;
	&lt;li&gt;Adding racks&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Once the review of the 2.1 patch is completed I will up-merge to the 2.2+ branches. Do we want this for 2.0 as well?&lt;/p&gt;

&lt;p&gt;CI for 2.1:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/stef1927-10238-2.1-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/stef1927-10238-2.1-testall&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/stef1927-10238-2.1-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/stef1927-10238-2.1-dtest&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14740990" author="brandon.williams" created="Fri, 11 Sep 2015 15:41:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;Do we also need more dtests? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Given that we gave snitches the ability to change racks/DCs since their inception but never thought about actually providing the infrastructure to support doing so, having more tests around it seems prudent at this point.&lt;/p&gt;</comment>
                            <comment id="14741298" author="jbellis" created="Fri, 11 Sep 2015 18:29:38 +0000"  >&lt;p&gt;Tagging aweisberg for review.&lt;/p&gt;

&lt;p&gt;Yes, it would be good to have a fix in 2.0 as well.&lt;/p&gt;</comment>
                            <comment id="14741712" author="jbellis" created="Fri, 11 Sep 2015 23:15:45 +0000"  >&lt;p&gt;(Actually, giving review to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; so Ariel can concentrate on OHC next week.)&lt;/p&gt;</comment>
                            <comment id="14743173" author="stefania" created="Mon, 14 Sep 2015 08:46:35 +0000"  >&lt;p&gt;utests added, patch is ready for review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;dtests pull request is &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/548&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14744428" author="bdeggleston" created="Mon, 14 Sep 2015 22:49:09 +0000"  >&lt;p&gt;I think there&apos;s still a window of time where the RF contract violation is possible. In &lt;tt&gt;YamlFileNetworkTopologySnitch&lt;/tt&gt; and &lt;tt&gt;PropertyFileSnitch&lt;/tt&gt;, &lt;tt&gt;StorageService.instance.updateTopology&lt;/tt&gt; is only called for the local node, although any of the nodes could have been updated. Assuming topology file changes are deployed to all nodes simultaneously, this would mean that the snitch and TokenMetadata will be out of sync until the node which has moved picks up the changes in it&apos;s topology file and it&apos;s new application state propagates to the out of sync node. Calling &lt;tt&gt;StorageService.instance.updateTopology&lt;/tt&gt; on any endpoint that changed should fix that&lt;/p&gt;</comment>
                            <comment id="14744695" author="stefania" created="Tue, 15 Sep 2015 02:14:38 +0000"  >&lt;p&gt;Thanks for the review. I was relying on Gossip to eventually propagate the changes of other hosts. I now closed this window for &lt;tt&gt;YamlFileNetworkTopologySnitch&lt;/tt&gt; and &lt;tt&gt;PropertyFileSnitch&lt;/tt&gt; by updating all endpoints whose dc or rack have changed in the configuration file.&lt;/p&gt;

&lt;p&gt;I&apos;ve also prepared the 2.0, 2.2 and 3.0 patches, see attached. They are identical except:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;GossipingPropertyFileSnitch&lt;/tt&gt; does not seem capable of updating its configuration in 2.0&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;YamlFileNetworkTopologySnitch&lt;/tt&gt; was deleted in 2.2.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; what was the snitch in use when the original problem in 2.0 was reported?&lt;/p&gt;</comment>
                            <comment id="14744697" author="stefania" created="Tue, 15 Sep 2015 02:16:12 +0000"  >&lt;p&gt;CI results will eventually appear here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.0-testall/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.0-dtest/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.1-testall/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.1-dtest/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.2-testall/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.2-dtest/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-3.0-testall/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-3.0-dtest/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14744700" author="brandon.williams" created="Tue, 15 Sep 2015 02:21:04 +0000"  >&lt;p&gt;PFS was used for the initial report.&lt;/p&gt;</comment>
                            <comment id="14744706" author="stefania" created="Tue, 15 Sep 2015 02:25:34 +0000"  >&lt;p&gt;Thanks, PFS is covered by our tests in 2.0, GPFS will only be tested in 2.1+.&lt;/p&gt;</comment>
                            <comment id="14744732" author="bdeggleston" created="Tue, 15 Sep 2015 02:50:05 +0000"  >&lt;p&gt;Great, everything else LGTM.&lt;/p&gt;</comment>
                            <comment id="14746569" author="stefania" created="Wed, 16 Sep 2015 00:25:19 +0000"  >&lt;p&gt;dtests results for 3.0 are really bad, rebased and restarted CI for 3.0.&lt;/p&gt;</comment>
                            <comment id="14746680" author="stefania" created="Wed, 16 Sep 2015 02:18:14 +0000"  >&lt;p&gt;CI is better now. Still some dtests failing but they seem inline with unpatched branches.&lt;/p&gt;</comment>
                            <comment id="14747306" author="iamaleksey" created="Wed, 16 Sep 2015 11:06:40 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/257cdaa08dc12f747a25c03b9b0ad3ffc76ace9b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;257cdaa08dc12f747a25c03b9b0ad3ffc76ace9b&lt;/a&gt; to cassandra-2.0 and merged upwards. Thank you.&lt;/p&gt;</comment>
                            <comment id="14791798" author="blambov" created="Thu, 17 Sep 2015 08:46:33 +0000"  >&lt;p&gt;Is this a sufficient solution? Switching racks can easily cause data to need to move from one replica to another (e.g. second replica changes from being on a different rack from first to being on the same in a multi-rack DC). How do we trigger streaming of such data?&lt;/p&gt;

&lt;p&gt;Also, &lt;tt&gt;TokenMetadata.updateTopology&lt;/tt&gt; (both versions) should include a call to &lt;tt&gt;invalidateCachedRings()&lt;/tt&gt; to make sure replication strategies do not use stale data; this is already done by &lt;tt&gt;(Gossiping)PropertyFileSnitch&lt;/tt&gt; for any local change, but invalidation should also be done on gossiped changes. The &lt;tt&gt;updateTopology&lt;/tt&gt; call in the snitches belongs within &lt;tt&gt;reloadConfiguration&lt;/tt&gt; at the existing cache invalidation site.&lt;/p&gt;

&lt;p&gt;While we are in this, we should fix the same issue in &lt;tt&gt;StorageService.updateSnitch&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14802673" author="stefania" created="Thu, 17 Sep 2015 09:40:59 +0000"  >&lt;p&gt;I think we have &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10243&quot; title=&quot;Warn or fail when changing cluster topology live&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10243&quot;&gt;&lt;del&gt;CASSANDRA-10243&lt;/del&gt;&lt;/a&gt; for a discussion on switching racks. The idea so far is not to allow it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;but invalidation should also be done on gossiped changes.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes we should call &lt;tt&gt;invalidateCachedRings()&lt;/tt&gt; when the gossipped properties change.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The updateTopology call in the snitches belongs within reloadConfiguration at the existing cache invalidation site.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No because this is called in the snitch constructor as well, where we cannot update topology since the snitch does not exist yet.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;While we are in this, we should fix the same issue in StorageService.updateSnitch.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes this is a valid point too.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if we should re-open this ticket or implement as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10243&quot; title=&quot;Warn or fail when changing cluster topology live&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10243&quot;&gt;&lt;del&gt;CASSANDRA-10243&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14802992" author="jbellis" created="Thu, 17 Sep 2015 14:35:14 +0000"  >&lt;p&gt;This ticket is to fix the bug of part of the cluster having a different view of the ring than other parts.  If that is incomplete then let&apos;s reopen.  (And say so on the 2.0.17 vote thread.)&lt;/p&gt;

&lt;p&gt;Moving nodes between racks causes other problems (data is not where it&apos;s expected to be) but that&apos;s &quot;working as designed&quot; so changing the design is in the other tickets (which won&apos;t go into 2.0.x).&lt;/p&gt;</comment>
                            <comment id="14803022" author="blambov" created="Thu, 17 Sep 2015 14:49:58 +0000"  >&lt;p&gt;It &lt;em&gt;is&lt;/em&gt; incomplete as affected nodes will use an obsolete cached view of the ring for an indefinite amount of time. However, if changing racks is treated as a forbidden operation this will not have any real effect so this should be fixed as part of other tickets and not delay the release.&lt;/p&gt;</comment>
                            <comment id="14803029" author="jbellis" created="Thu, 17 Sep 2015 14:53:21 +0000"  >&lt;p&gt;2.0.17 is intended to be the last 2.0 release, though.  I think we need to reopen.&lt;/p&gt;</comment>
                            <comment id="14804819" author="stefania" created="Fri, 18 Sep 2015 01:31:54 +0000"  >&lt;p&gt;New patches:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/10238-2.0-b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/stef1927/cassandra/commits/10238-2.0-b&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/10238-2.1-b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/stef1927/cassandra/commits/10238-2.1-b&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/10238-2.2-b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/stef1927/cassandra/commits/10238-2.2-b&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/10238-3.0-b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/stef1927/cassandra/commits/10238-3.0-b&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;CI:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.0-b-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.0-b-testall/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.0-b-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.0-b-dtest/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.1-b-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.1-b-testall/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.1-b-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.1-b-dtest/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.2-b-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.2-b-testall/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.2-b-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-2.2-b-dtest/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-3.0-b-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-3.0-b-testall/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-3.0-b-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-10238-3.0-b-dtest/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14804823" author="stefania" created="Fri, 18 Sep 2015 01:33:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt;: second part of patch is ready for review.&lt;/p&gt;</comment>
                            <comment id="14804991" author="blambov" created="Fri, 18 Sep 2015 05:19:32 +0000"  >&lt;p&gt;+1 from me. Thank you.&lt;/p&gt;</comment>
                            <comment id="14847295" author="iamaleksey" created="Fri, 18 Sep 2015 11:45:46 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/c4de752758c3cf7f5de5a92e4ede30e430a36255&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;c4de752758c3cf7f5de5a92e4ede30e430a36255&lt;/a&gt; to 2.1 and merged upwards.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 9 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jnp3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332167">2.1.x</customfieldvalue>
    <customfieldvalue id="12332360">2.2.x</customfieldvalue>
    <customfieldvalue id="12332369">2.0.16</customfieldvalue>
    <customfieldvalue id="12332829">2.1.8</customfieldvalue>
    <customfieldvalue id="12332984">2.1.9</customfieldvalue>
    <customfieldvalue id="12333059">2.2.1</customfieldvalue>
    <customfieldvalue id="12333287">3.0 beta 2</customfieldvalue>
    <customfieldvalue id="12332541">3.0.x</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>bdeggleston</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>