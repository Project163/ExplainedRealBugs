<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:26:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-17507] IllegalArgumentException in query code path during 3.11.12 =&gt; 4.0.3 rolling upgrade</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-17507</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In a 6 node 3.11.12 test cluster - freshly set up, thus no legacy SSTables etc. - with ~ 1TB SSTables on disk per node, I have been running a rolling upgrade to 4.0.3. On upgraded 4.0.3 nodes I then have seen the following exception regularly, which disappeared once all 6 nodes have been on 4.0.3. Is this known? Can this be ignored? As said, just a test drive, but not sure if we want to have that in production, especially with a larger number of nodes, where it could take some time, until all are upgraded. Thanks!&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [Native-Transport-Requests-8] 2022-03-30 11:30:24,057 ErrorMessage.java:457 - Unexpected exception during request
java.lang.IllegalArgumentException: newLimit &amp;gt; capacity: (290 &amp;gt; 15)
        at java.base/java.nio.Buffer.createLimitException(Buffer.java:372)
        at java.base/java.nio.Buffer.limit(Buffer.java:346)
        at java.base/java.nio.ByteBuffer.limit(ByteBuffer.java:1107)
        at java.base/java.nio.ByteBuffer.limit(ByteBuffer.java:262)
        at org.apache.cassandra.db.marshal.ByteBufferAccessor.slice(ByteBufferAccessor.java:107)
        at org.apache.cassandra.db.marshal.ByteBufferAccessor.slice(ByteBufferAccessor.java:39)
        at org.apache.cassandra.db.marshal.ValueAccessor.sliceWithShortLength(ValueAccessor.java:225)
        at org.apache.cassandra.db.marshal.CompositeType.splitName(CompositeType.java:222)
        at org.apache.cassandra.service.pager.PagingState$RowMark.decodeClustering(PagingState.java:434)
        at org.apache.cassandra.service.pager.PagingState$RowMark.clustering(PagingState.java:388)
        at org.apache.cassandra.service.pager.SinglePartitionPager.nextPageReadQuery(SinglePartitionPager.java:88)
        at org.apache.cassandra.service.pager.SinglePartitionPager.nextPageReadQuery(SinglePartitionPager.java:32)
        at org.apache.cassandra.service.pager.AbstractQueryPager.fetchPage(AbstractQueryPager.java:69)
        at org.apache.cassandra.service.pager.SinglePartitionPager.fetchPage(SinglePartitionPager.java:32)
        at org.apache.cassandra.cql3.statements.SelectStatement$Pager$NormalPager.fetchPage(SelectStatement.java:352)
        at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:400)
        at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:250)
        at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:88)
        at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:244)
        at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:723)
        at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:701)
        at org.apache.cassandra.transport.messages.ExecuteMessage.execute(ExecuteMessage.java:159)
        at org.apache.cassandra.transport.Message$Request.execute(Message.java:242)
        at org.apache.cassandra.transport.Dispatcher.processRequest(Dispatcher.java:86)
        at org.apache.cassandra.transport.Dispatcher.processRequest(Dispatcher.java:106)
        at org.apache.cassandra.transport.Dispatcher.lambda$dispatch$0(Dispatcher.java:70)
        at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:165)
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:119)
        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
        at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13436886">CASSANDRA-17507</key>
            <summary>IllegalArgumentException in query code path during 3.11.12 =&gt; 4.0.3 rolling upgrade</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="adelapena">Andres de la Pe&#241;a</assignee>
                                    <reporter username="tsteinmaurer">Thomas Steinmaurer</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Mar 2022 12:27:21 +0000</created>
                <updated>Tue, 12 Sep 2023 13:02:52 +0000</updated>
                            <resolved>Mon, 23 Jan 2023 11:50:58 +0000</resolved>
                                        <fixVersion>4.0.8</fixVersion>
                    <fixVersion>4.1.1</fixVersion>
                    <fixVersion>5.0-alpha1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                    <component>Consistency/Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17516623" author="tsteinmaurer" created="Mon, 4 Apr 2022 05:46:44 +0000"  >&lt;p&gt;According to &lt;a href=&quot;https://the-asf.slack.com/archives/CJZLTM05A/p1648727883515419,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://the-asf.slack.com/archives/CJZLTM05A/p1648727883515419,&lt;/a&gt; not known, possibly a bug causing queries to fail during the rolling upgrade, thus I have opened this ticket.&lt;/p&gt;</comment>
                            <comment id="17625241" author="JIRAUSER287321" created="Thu, 27 Oct 2022 18:09:35 +0000"  >&lt;p&gt;This exists during an upgrade from 3.11 to Cassandra 4.0.6 as well.&lt;br/&gt;
Was hoping that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17840&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-17840&lt;/a&gt; had fixed it in 4.0.6, but that doesn&apos;t appear to be the case.&lt;br/&gt;
Selecting the columns individually does work-around the issue when Select * fails until all nodes are upgraded.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [Native-Transport-Requests-4] 2022-10-03 10:51:50,178 ErrorMessage.java:457 - Unexpected exception during request
java.lang.IllegalArgumentException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at java.nio.Buffer.limit(Buffer.java:275)
        at org.apache.cassandra.db.marshal.ByteBufferAccessor.slice(ByteBufferAccessor.java:107)
        at org.apache.cassandra.db.marshal.ByteBufferAccessor.slice(ByteBufferAccessor.java:39)
        at org.apache.cassandra.db.marshal.ValueAccessor.sliceWithShortLength(ValueAccessor.java:225)
        at org.apache.cassandra.db.marshal.CompositeType.splitName(CompositeType.java:222)
        at org.apache.cassandra.service.pager.PagingState$RowMark.decodeClustering(PagingState.java:434)
        at org.apache.cassandra.service.pager.PagingState$RowMark.clustering(PagingState.java:388)
        at org.apache.cassandra.service.pager.SinglePartitionPager.nextPageReadQuery(SinglePartitionPager.java:88)
        at org.apache.cassandra.service.pager.SinglePartitionPager.nextPageReadQuery(SinglePartitionPager.java:32)
        at org.apache.cassandra.service.pager.AbstractQueryPager.fetchPage(AbstractQueryPager.java:69)
        at org.apache.cassandra.service.pager.SinglePartitionPager.fetchPage(SinglePartitionPager.java:32)
        at org.apache.cassandra.cql3.statements.SelectStatement$Pager$NormalPager.fetchPage(SelectStatement.java:352)
        at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:400)
        at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:250)
        at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:88)
        at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:244)
        at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:723)
        at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:701)
        at org.apache.cassandra.transport.messages.ExecuteMessage.execute(ExecuteMessage.java:159)
        at org.apache.cassandra.transport.Message$Request.execute(Message.java:242)
        at org.apache.cassandra.transport.Dispatcher.processRequest(Dispatcher.java:86)
        at org.apache.cassandra.transport.Dispatcher.processRequest(Dispatcher.java:106)
        at org.apache.cassandra.transport.Dispatcher.lambda$dispatch$0(Dispatcher.java:70)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:165)
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:137)
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:119)
        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</comment>
                            <comment id="17656119" author="adelapena" created="Mon, 9 Jan 2023 14:12:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-4.0...adelapena:cassandra:17507-4.0-repro&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This JVM dtest&lt;/a&gt; reproduces the bug. It testes a 3.x -&amp;gt; 4.0 rolling upgrade scenario with a table with &lt;tt&gt;COMPACT STORAGE&lt;/tt&gt; and a query over that uses paging. The bug only seems to manifest itself when the driver uses native protocol v3, instead on the default (v5 for 4.0 and v4 for 3.11).&lt;/p&gt;

&lt;p&gt;The tests results can be found &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2536/workflows/5791569d-8ea1-42b5-bacd-bd8716afaee8/jobs/25163&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. The artifacts stored for each test contain an identical stack trace, for example &lt;a href=&quot;https://output.circle-artifacts.com/output/job/f4cbecbc-92dd-49c8-a75d-a5a7b53bcd21/artifacts/0/stdout/fails/1/org.apache.cassandra.distributed.upgrade.CompactStoragePagingTest%23testPagingWithCompactStorageAndProtocolVersion.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this one&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If this is actually caused by the combination of &lt;tt&gt;COMPACT STORAGE&lt;/tt&gt;, paging and an old protocol version, probably the easiest workaround until we get a fix is setting the driver to use a more recent version of the native transport protocol.&lt;/p&gt;</comment>
                            <comment id="17675575" author="adelapena" created="Wed, 11 Jan 2023 13:38:34 +0000"  >&lt;p&gt;I think I have found the cause of the bug when using protocol v3.&lt;/p&gt;

&lt;p&gt;Cassandra 3.0 and 3.x with protocol v3 and compact storage don&apos;t serialize single-column clusterings as single-element composites. Instead, single-column clusterings values are written as they are, as it can be seen &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11/src/java/org/apache/cassandra/db/LegacyLayout.java#L477-L486&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;However, Cassandra 4.0 always reads and writes single-column clusterings as composites. This can be seen &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0.3/src/java/org/apache/cassandra/service/pager/PagingState.java#L434&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, exactly where the reported exception is thrown.&lt;/p&gt;

&lt;p&gt;I think the solution is modifying the code to read legacy formats in Cassandra 4.0 so it special cases single-column clusterings for compact storage:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;PR&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2082&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2540/workflows/22cfa989-31df-4fcc-a896-f46c8d77d364&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;If the approach looks good I&apos;ll prepare patches for 4.1 and trunk, that probably are also affected.&lt;/p&gt;</comment>
                            <comment id="17675629" author="adelapena" created="Wed, 11 Jan 2023 15:45:26 +0000"  >&lt;p&gt;I can confirm that 4.1 and trunk are also affected. Here are the patches for all the branches:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;PR&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2082&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2543/workflows/cb16ec9d-8ec6-4914-a08a-92715bd15ff0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2083&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2544/workflows/924c41ce-accb-44eb-be07-1fc678b1f4b2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2084&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2542/workflows/16be8e22-b8d1-440f-93bd-a599b56e3093&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I think that CI will fail for the new tests on the &lt;span class=&quot;error&quot;&gt;&amp;#91;4.0, 4.1&amp;#93;&lt;/span&gt; -&amp;gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;4.1, trunk&amp;#93;&lt;/span&gt; upgrade paths. That&apos;s because our CI script &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/.circleci/config-2_1.yml#L2684-L2693&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;generates the dtest artifacts from the main repo&lt;/a&gt;, and the branches there don&apos;t contain the serialization fix that we are proposing here.&lt;/p&gt;

&lt;p&gt;Reviewers can test it locally by generating the dtests artifacts of each patched branch with &lt;tt&gt;ant dtest-jar&lt;/tt&gt;, and copying all the generated &lt;tt&gt;dtest-*.jar&lt;/tt&gt; files into the &lt;tt&gt;build&lt;/tt&gt; directory of the tested branch.&lt;/p&gt;</comment>
                            <comment id="17678567" author="bereng" created="Thu, 19 Jan 2023 08:58:10 +0000"  >&lt;p&gt;Code lgtm. But why not change that url in the final circle config file just this one time and get a green run? Do iiuc correctly assuming changing that 1 loc in the yaml should render a green CI and we&apos;d tested in the official CI instead of the reviewer&apos;s box i.e.? Double checking I am not missing anything...&lt;/p&gt;</comment>
                            <comment id="17678649" author="adelapena" created="Thu, 19 Jan 2023 11:38:09 +0000"  >&lt;p&gt;Agree, we can manually change a couple of things on the CircleCI yaml to point to the proper repo and branches:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;PR&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2082&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2558/workflows/6ae34afc-fdac-40dc-89bd-002e54df4431&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2083&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2559/workflows/aa602a9a-ca69-4ea8-aa80-49faab4f990e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2084&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/2557/workflows/4f6dfcab-6ce9-4b50-ab5e-af22d53f1e23&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;We should probably make the repo and branches env vars, so we can do this with &lt;tt&gt;generate.sh&lt;/tt&gt; and without manually editing the yaml. I&apos;ll create a ticket for that.&lt;/p&gt;</comment>
                            <comment id="17678691" author="bereng" created="Thu, 19 Jan 2023 13:21:38 +0000"  >&lt;p&gt;Ah good I see that&apos;s rendered green &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17679122" author="adelapena" created="Fri, 20 Jan 2023 11:59:29 +0000"  >&lt;p&gt;Note that the mistake in the serialisation of protocol v3 that was introduced with 4.0.0 has effectively meant that we have two versions of protocol v3: the one used by 3.0/3.x, and the one used by 4.0/4.1/4.x.&lt;/p&gt;

&lt;p&gt;The proposed fix will make all new 4.0/4.1 minors use the same version of protocol v3 that 3.0/3.x have always used.&lt;/p&gt;

&lt;p&gt;However, we will hit the same problem in a cluster with a node using an unpatched 4.0/4.1/4.x node and a patched 4.0/4.1/4.x node. In other words, we are trading upgrade issues on 3.0.x -&amp;gt; 4.0.7 by upgrade issues on 4.0.8 -&amp;gt; 4.0.9, etc.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure how we could know which version of v3 (broken or unbroken) we should use, if we can.&lt;/p&gt;

&lt;p&gt;That said, the problem occurs only when using v3, and I&apos;d say that the old v3 protocol is much more likely to be used on a major 3.0/3.x- &amp;gt; 4.0/4.1 upgrade than in a 4.0/4.1 - &amp;gt; 4.0/4.1&#160;upgrade. If that assumption is true, we are improving things with this fix, and stopping the spread of the broken version of the v3 protocol.&lt;/p&gt;

&lt;p&gt;What do you think? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; any thoughts on this?&lt;/p&gt;</comment>
                            <comment id="17679123" author="brandon.williams" created="Fri, 20 Jan 2023 12:14:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;That said, the problem occurs only when using v3, and I&apos;d say that the old v3 protocol is much more likely to be used on a major 3.0/3.x- &amp;gt; 4.0/4.1 upgrade than in a 4.0/4.1 - &amp;gt; 4.0/4.1 upgrade&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree with you on this.  I think we should add a NEWS entry to this effect and go ahead and commit this.  Most likely users will neither read the news entry nor ever hit the issue this way, and this ticket is evidence that it will be encountered on upgrade if left in the current state, so I think this is easily a net positive.&lt;/p&gt;</comment>
                            <comment id="17679135" author="adelapena" created="Fri, 20 Jan 2023 12:49:44 +0000"  >&lt;p&gt;Makes sense, thanks for the feedback. I have added that entry on &lt;tt&gt;NEWS.txt&lt;/tt&gt;, it says:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;All previous versions of 4.x contained a mistake on the implementation of the old CQL native protocol v3. That mistake produced issues when paging over tables with compact storage and a single clustering column during rolling upgrades involving 3.x and 4.x nodes. The fix for that issue makes that it can now appear during rolling upgrades from 4.1.0 or 4.0.0-4.0.3. If that your case, please use protocol v4 or higher in your driver. See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17507&quot; title=&quot;IllegalArgumentException in query code path during 3.11.12 =&amp;gt; 4.0.3 rolling upgrade&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17507&quot;&gt;&lt;del&gt;CASSANDRA-17507&lt;/del&gt;&lt;/a&gt; for further details.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="17679136" author="brandon.williams" created="Fri, 20 Jan 2023 12:53:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;or 4.0.0-4.0.3&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is 4.0.3 correct?  I don&apos;t understand the significance if we are putting the fix in 4.0.8.&lt;/p&gt;</comment>
                            <comment id="17679139" author="adelapena" created="Fri, 20 Jan 2023 13:06:07 +0000"  >&lt;p&gt;Oh, right, it&apos;s a typo, the last 4.0 affected version is 4.0.7. Just fixed it, thanks!&lt;/p&gt;</comment>
                            <comment id="17679680" author="bereng" created="Mon, 23 Jan 2023 05:40:20 +0000"  >&lt;p&gt;Dropped a couple nits. Feel free to ignore an commit at your discretion&lt;/p&gt;</comment>
                            <comment id="17679768" author="adelapena" created="Mon, 23 Jan 2023 11:50:10 +0000"  >&lt;p&gt;Thanks, addressed those on commit.&lt;/p&gt;

&lt;p&gt;Committed to 4.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/9a0af4112e87f5b97056aa39e63c5ab461b60237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;9a0af4112e87f5b97056aa39e63c5ab461b60237&lt;/a&gt; and merged to &lt;a href=&quot;https://github.com/apache/cassandra/commit/6c96e2fd41368323844a080d806cbbb7b7fc9790&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/commit/cab864a6316d4091185559c7b21a8073bfcf42b2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13336338">CASSANDRA-16217</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12987" cascade-level="1"><![CDATA[Transient Incorrect Response]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z110dk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
        <customfieldvalue><![CDATA[pkolaczk]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12350367">4.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/9a0af4112e87f5b97056aa39e63c5ab461b60237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/9a0af4112e87f5b97056aa39e63c5ab461b60237&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;New JVM upgrade dtests are included.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>