<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:01:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11043] Secondary indexes doesn&apos;t properly validate custom expressions</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11043</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;It seems that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7575&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-7575&lt;/a&gt; is broken in Cassandra 3.x. As stated in the secondary indexes&apos; API documentation, custom index implementations should perform any validation of query expressions at &lt;tt&gt;Index#searcherFor(ReadCommand)&lt;/tt&gt;, throwing an &lt;tt&gt;InvalidRequestException&lt;/tt&gt; if the expressions are not valid. I assume these validation errors should produce an &lt;tt&gt;InvalidRequest&lt;/tt&gt; error on cqlsh, or raise an &lt;tt&gt;InvalidQueryException&lt;/tt&gt; on Java driver. However, when &lt;tt&gt;Index#searcherFor(ReadCommand)&lt;/tt&gt; throws its &lt;tt&gt;InvalidRequestException&lt;/tt&gt;, I get this cqlsh output:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Traceback (most recent call last):
  File &quot;bin/cqlsh.py&quot;, line 1246, in perform_simple_statement
    result = future.result()
  File &quot;/Users/adelapena/stratio/platform/src/cassandra-3.2.1/bin/../lib/cassandra-driver-internal-only-3.0.0-6af642d.zip/cassandra-driver-3.0.0-6af642d/cassandra/cluster.py&quot;, line 3122, in result
    raise self._final_exception
ReadFailure: code=1300 [Replica(s) failed to execute read] message=&quot;Operation failed - received 0 responses and 1 failures&quot; info={&apos;failures&apos;: 1, &apos;received_responses&apos;: 0, &apos;required_responses&apos;: 1, &apos;consistency&apos;: &apos;ONE&apos;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I attach a dummy index implementation to reproduce the error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE KEYSPACE test with replication = {&apos;class&apos; : &apos;SimpleStrategy&apos;, &apos;replication_factor&apos; : &apos;1&apos; }; 
CREATE TABLE test.test (id int PRIMARY KEY, value varchar); 
CREATE CUSTOM INDEX test_index ON test.test() USING &apos;com.stratio.TestIndex&apos;; 
SELECT * FROM test.test WHERE expr(test_index,&apos;ok&apos;);
SELECT * FROM test.test WHERE expr(test_index,&apos;error&apos;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is specially problematic when using Cassandra Java Driver, because one of these server exceptions can produce subsequent queries fail (even if they are valid) with a no host available exception.&lt;/p&gt;

&lt;p&gt;Maybe the validation method added with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7575&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-7575&lt;/a&gt; should be restored, unless there is a way to properly manage the exception.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12932691">CASSANDRA-11043</key>
            <summary>Secondary indexes doesn&apos;t properly validate custom expressions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="adelapena">Andres de la Pe&#241;a</reporter>
                        <labels>
                            <label>2i</label>
                            <label>index</label>
                            <label>validation</label>
                    </labels>
                <created>Wed, 20 Jan 2016 12:24:23 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:44 +0000</updated>
                            <resolved>Wed, 20 Apr 2016 12:12:39 +0000</resolved>
                                        <fixVersion>3.0.4</fixVersion>
                    <fixVersion>3.4</fixVersion>
                                    <component>Feature/2i Index</component>
                    <component>Legacy/CQL</component>
                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>9</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15121154" author="adelapena" created="Thu, 28 Jan 2016 10:16:39 +0000"  >&lt;p&gt;Any idea about this, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;? Where do you think is the best place to call to an hypothetical &lt;tt&gt;validate(Expression)&lt;/tt&gt; method?&lt;/p&gt;</comment>
                            <comment id="15128755" author="beobal" created="Tue, 2 Feb 2016 18:38:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;, sorry about the slow response - you&apos;re right though, the intention is to validate those expressions earlier and reject before getting to the point of execution. Unfortunately, the unit test covering that is not properly representative of running on a real server so it didn&apos;t catch the problem you described. I think we also need to add back the early validation of non-custom expressions, as although the custom expression syntax is a better fit for indexes which don&apos;t map to a specific column, for backwards compatibility it&apos;s still possible to do things in the old style, by creating a fake column &amp;amp; adding an index on it. The fix should be reasonably straightforward, but I&apos;d like to have a think about how to test this better (using custom indexes etc in dtests is not so straightforward). I&apos;ll aim to have a patch ready sometime this week.&lt;/p&gt;</comment>
                            <comment id="15132093" author="adelapena" created="Thu, 4 Feb 2016 10:19:47 +0000"  >&lt;p&gt;Yes, it would be good to preserve the query validation also for the old fake column approach. Maybe a &lt;tt&gt;validate(ReadCommand)&lt;/tt&gt; method, called from CQL layer before executing the command itself, could work for both kinds of indexes. It&apos;s not our use case, but I think that other implementations could be interested in validating the extra information contained in the &lt;tt&gt;ReadCommand&lt;/tt&gt;, such as the query limits or the allow filtering clauses. It&apos;s just an idea.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure about how to test this feature. I guess that using dtests would involve to add stub index implementations to the tested server&apos;s class path, which sounds complicated...&lt;/p&gt;

&lt;p&gt;Please let me know if I can help you in some way.&lt;/p&gt;</comment>
                            <comment id="15138660" author="beobal" created="Tue, 9 Feb 2016 09:51:58 +0000"  >&lt;p&gt;Turns out modifying the testing was more straightforward than I&apos;d thought. I&apos;ve modified all of the tests in &lt;tt&gt;CustomIndexTest&lt;/tt&gt; which are verifying query time checks to execute queries at the protocol level using the java driver, rather than by calling &lt;tt&gt;QueryProcessor.execute&lt;/tt&gt; directly. To fix the reported issue I&apos;ve added a &lt;tt&gt;validate(ReadCommand command)&lt;/tt&gt; method to &lt;tt&gt;Index&lt;/tt&gt;, which is called when the read command is first constructed (in &lt;tt&gt;SelectStatement&lt;/tt&gt; and &lt;tt&gt;CassandraServer&lt;/tt&gt;). There&apos;s a default no-op implementation provided, so it&apos;s fully backwards compatible with existing implementations. &lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/11043-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;11043-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-11043-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-11043-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/11043-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;11043-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-11043-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-11043-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15140679" author="adelapena" created="Wed, 10 Feb 2016 11:52:47 +0000"  >&lt;p&gt;It looks awesome! The new &lt;tt&gt;validate(ReadCommand command)&lt;/tt&gt; method is perfect, and not requiring dtests to test validation is also great.&lt;/p&gt;</comment>
                            <comment id="15144641" author="adelapena" created="Fri, 12 Feb 2016 14:42:19 +0000"  >&lt;p&gt;It works like a charm, thanks!&lt;/p&gt;</comment>
                            <comment id="15147341" author="beobal" created="Mon, 15 Feb 2016 13:18:15 +0000"  >&lt;p&gt;thanks, committed to 3.0 in &lt;tt&gt;9cfbc31bc29685bd60355a823e0cf261a89858f0&lt;/tt&gt; and merged to trunk.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; just for future reference, the &quot;Resolved&quot; status is for when the fix has actually been committed. Where the reviewer isn&apos;t a committer, the &quot;Ready to Commit&quot; status is what you want. &lt;/p&gt;</comment>
                            <comment id="15147359" author="adelapena" created="Mon, 15 Feb 2016 13:39:03 +0000"  >&lt;p&gt;Ok, I&apos;m sorry, I didn&apos;t realize. I&#180;ll keep it in mind in the future. Thanks for your help.&lt;/p&gt;</comment>
                            <comment id="15248058" author="adelapena" created="Tue, 19 Apr 2016 16:09:19 +0000"  >&lt;p&gt;The validation method works great with CQL queries producing a &lt;tt&gt;PartitionRangeReadCommand&lt;/tt&gt;, but it is not called with CQL queries producing one or more &lt;tt&gt;SinglePartitionReadCommand&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;For example, the following query properly validates the expression:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM test WHERE expr(test_idx, &lt;span class=&quot;code-quote&quot;&gt;&apos;error&apos;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;However the following queries skip validation:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM test WHERE expr(test_idx, &lt;span class=&quot;code-quote&quot;&gt;&apos;error&apos;&lt;/span&gt;) AND id=1;
SELECT * FROM test WHERE expr(test_idx, &lt;span class=&quot;code-quote&quot;&gt;&apos;error&apos;&lt;/span&gt;) AND id IN (1,2);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15249734" author="beobal" created="Wed, 20 Apr 2016 12:12:39 +0000"  >&lt;p&gt;The problem here is that queries involving indexes should always be executed as a &lt;tt&gt;PartitionRangeReadCommand&lt;/tt&gt;. When the statement restrictions are processed, we don&apos;t set the &lt;tt&gt;usesSecondaryIndexing&lt;/tt&gt; flag if custom expressions are present, which we should do. If the flag were set, then we&apos;d never get into the situation described here. We encountered a similar problem on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11310&quot; title=&quot;Allow filtering on clustering columns for queries without secondary indexes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11310&quot;&gt;&lt;del&gt;CASSANDRA-11310&lt;/del&gt;&lt;/a&gt; recently, and as I mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11310?focusedCommentId=15245922&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15245922&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;the comment there&lt;/a&gt;, although we could (and most likely will) move to enable 2i usage on single partition reads, we need to do that in controlled way to ensure we don&apos;t violate an assumptions being made about the read command. In the meantime, I&apos;ve opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11617&quot; title=&quot;The presence of custom index expressions doesn&amp;#39;t set the indexing flag in StatementRestrictions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11617&quot;&gt;CASSANDRA-11617&lt;/a&gt; to fix the bug with custom expressions.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12783332" name="test-index.zip" size="3796" author="adelapena" created="Wed, 20 Jan 2016 12:24:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 30 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2rqen:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>adelapena</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332361">3.0 alpha 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>