<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:01:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10342] Read defragmentation can cause unnecessary repairs</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10342</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After applying the fix from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10299&quot; title=&quot;Issue with sstable selection when anti-compacting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10299&quot;&gt;&lt;del&gt;CASSANDRA-10299&lt;/del&gt;&lt;/a&gt; to the cluster we started having a problem of ~20k small sstables appearing for the table with static data when running incremental repair.&lt;/p&gt;

&lt;p&gt;In the logs there were several messages about flushes for that table, one for each repaired range. The flushed sstables were 0.000kb in size with &amp;lt; 100 ops in each. When checking cfstats there were several writes to that table, even though we were only reading from it and read repair did not repair anything.&lt;/p&gt;

&lt;p&gt;After digging around in the codebase I noticed that defragmentation of data can occur while reading, depending on the query and some other conditions. This causes the read data to be inserted again to have it in a more recent sstable, which can be a problem if that data was repaired using incremental repair. The defragmentation is done in &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.1/src/java/org/apache/cassandra/db/CollationController.java#L151&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CollationController.java&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I guess this wasn&apos;t a problem with full repairs since I assume that the digest should be the same even if you have two copies of the same data. But with incremental repair this will most probably cause a mismatch between nodes if that data already was repaired, since the other nodes probably won&apos;t have that data in their unrepaired set.&lt;/p&gt;

&lt;p&gt;------&lt;/p&gt;

&lt;p&gt;I can add that the problems on our cluster was probably due to the fact that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10299&quot; title=&quot;Issue with sstable selection when anti-compacting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10299&quot;&gt;&lt;del&gt;CASSANDRA-10299&lt;/del&gt;&lt;/a&gt; caused the same data to be streamed multiple times and ending up in several sstables. One of the conditions for the defragmentation is that the number of sstables read during a read request have to be more than the minimum number of sstables needed for a compaction(&amp;gt; 4 in our case). So normally I don&apos;t think this would cause ~20k sstables to appear, we probably hit an extreme.&lt;/p&gt;

&lt;p&gt;One workaround for this is to use another compaction strategy than STCS(it seems to be the only affected strategy, atleast in 2.1), but the solution might be to either make defragmentation configurable per table or avoid reinserting the data if any of the sstables involved in the read are repaired.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12864264">CASSANDRA-10342</key>
            <summary>Read defragmentation can cause unnecessary repairs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="molsson">Marcus Olsson</reporter>
                        <labels>
                    </labels>
                <created>Tue, 15 Sep 2015 13:51:34 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:56 +0000</updated>
                            <resolved>Wed, 16 Mar 2016 09:52:31 +0000</resolved>
                                        <fixVersion>2.1.14</fixVersion>
                    <fixVersion>2.2.6</fixVersion>
                    <fixVersion>3.0.5</fixVersion>
                    <fixVersion>3.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14746981" author="krummas" created="Wed, 16 Sep 2015 06:35:06 +0000"  >&lt;p&gt;Patch &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/10342&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; which only defragments if we only read from unrepaired sstables.&lt;/p&gt;

&lt;p&gt;But I wonder if we should keep doing defragmentation at all in 2.2+ where incremental repair is default - we should probably do a few benchmarks if the over-repair is worth it. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mambocab&quot; class=&quot;user-hover&quot; rel=&quot;mambocab&quot;&gt;mambocab&lt;/a&gt; do you have cycles to run the benchmarks? I pushed a branch without the defragmentation &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/10342-no_defrag&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; - we would need to run a mixed workload with a few incremental repairs thrown in and compare read latency and amount of data streamed with standard 2.1&lt;/p&gt;</comment>
                            <comment id="14768987" author="mambocab" created="Wed, 16 Sep 2015 14:09:51 +0000"  >&lt;p&gt;I&apos;m unlikely to make it to these benchmarks this week, but yes, I can run these.&lt;/p&gt;</comment>
                            <comment id="14790659" author="jbellis" created="Wed, 16 Sep 2015 16:24:07 +0000"  >&lt;p&gt;Part of me wants to just remove the defragmentation code entirely.  More than one user has been confused by &quot;why is Cassandra still doing writes when I&apos;m only doing reads?&quot;&lt;/p&gt;

&lt;p&gt;However now that we can leverage the time-ordered path for a lot more queries in 3.x, than we could pre-8099, maybe it is worth keeping after all.  Lazy-compaction of &quot;hot&quot; rows seems like it &lt;b&gt;should&lt;/b&gt; be a win on paper.&lt;/p&gt;</comment>
                            <comment id="14900982" author="iamaleksey" created="Mon, 21 Sep 2015 16:59:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;we can leverage the time-ordered path for a lot more queries in 3.x&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is not actually true at the moment.&lt;/p&gt;</comment>
                            <comment id="14900984" author="iamaleksey" created="Mon, 21 Sep 2015 17:00:39 +0000"  >&lt;p&gt;See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7085?focusedCommentId=14593427&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14593427&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;this Sylvain&apos;s comment&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14903022" author="slebresne" created="Tue, 22 Sep 2015 17:17:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;This is not actually true at the moment.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Let&apos;s  be precise. We do use the time-ordered path in 3.0 much more often than we were before 3.0 (basically, pre-3.0, we never used that path for CQL tables, we do now). However, we do query all columns every time, which potentially limit the efficiency of that path. Still, if a row is queried a lot, &quot;defragmenting&quot; it (entirely) is going to help.&lt;/p&gt;</comment>
                            <comment id="14989067" author="krummas" created="Wed, 4 Nov 2015 07:41:42 +0000"  >&lt;p&gt;ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mambocab&quot; class=&quot;user-hover&quot; rel=&quot;mambocab&quot;&gt;mambocab&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14992158" author="mambocab" created="Thu, 5 Nov 2015 18:16:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; Thanks for the ping, and sorry for letting this fall on the floor. I&apos;ve put it on my list of things to look at post-3.0 release.&lt;/p&gt;</comment>
                            <comment id="15013685" author="mambocab" created="Thu, 19 Nov 2015 15:19:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; I&apos;ve started working on a cstar_perf job:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cstar.datastax.com/tests/id/b4b075e8-8e44-11e5-8050-0256e416528f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cstar.datastax.com/tests/id/b4b075e8-8e44-11e5-8050-0256e416528f&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;How can I observe how much data was streamed during a job? Is there a particular JMX endpoint or nodetool command?&lt;/p&gt;</comment>
                            <comment id="15015579" author="krummas" created="Fri, 20 Nov 2015 10:45:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mambocab&quot; class=&quot;user-hover&quot; rel=&quot;mambocab&quot;&gt;mambocab&lt;/a&gt; I think we can simplify this test a bit - we probably just need to check how much worse latency gets if we don&apos;t do the read defragmentation at all. I pushed a new rebased branch &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/10342_nodefrag&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; which never does defragmentation&lt;/p&gt;

&lt;p&gt;so, we could probably test the degenerate case on a single node with something like&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;disable autocompaction (with compaction = 
{&apos;class&apos;:&apos;SizeTieredCompactionStrategy&apos;, &apos;enabled&apos;:false}
&lt;p&gt;) to get many sstables&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;write wide partitions - we need partitions to span many sstables&lt;/li&gt;
	&lt;li&gt;verify that we actually do read defragmentation with the standard 2.1 build (iirc every defragmentation registers in local write count in cfstats, so if we only do reads but the write counts increase, we are defragmenting. We could see this if memtable gets data but we are only reading if it is not registered as writes)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Then we should probably compare with regular compaction running as well, to get a more &apos;real&apos; situation&lt;/p&gt;</comment>
                            <comment id="15142951" author="slebresne" created="Thu, 11 Feb 2016 16:14:12 +0000"  >&lt;p&gt;Ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mambocab&quot; class=&quot;user-hover&quot; rel=&quot;mambocab&quot;&gt;mambocab&lt;/a&gt;: where are we here? It seems we were close to a resolution but that this was dropped on the floor.&lt;/p&gt;

&lt;p&gt;If what we&apos;re blocking on is benchmarking removing the defragmentation, then I would suggest committing the fix on this issue first and opening a followup for validating if removing it is a better choice. But no sense in letting a bug for which we have a resolution in the meantime.&lt;/p&gt;</comment>
                            <comment id="15142973" author="mambocab" created="Thu, 11 Feb 2016 16:24:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Sorry, I pinged someone privately and should have mentioned it here. We&apos;re focused on dtest work and won&apos;t have time to do a good benchmark here for a while, so I think the thing to do is either what you proposed, or find a dev to benchmark it.&lt;/p&gt;</comment>
                            <comment id="15152366" author="krummas" created="Thu, 18 Feb 2016 14:10:58 +0000"  >&lt;p&gt;test runs and patches (same patch for 2.1 and 2.2 but slightly changed for 3.0 and trunk)&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/10342&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/10342&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10342-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10342-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/10342-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/10342-2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10342-2.2-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10342-2.2-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/10342-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/10342-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10342-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10342-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/tree/marcuse/10342-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;marcuse/10342-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10342-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10342-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15197087" author="slebresne" created="Wed, 16 Mar 2016 09:32:22 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15197117" author="krummas" created="Wed, 16 Mar 2016 09:52:31 +0000"  >&lt;p&gt;committed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2k7b3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332984">2.1.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>mambocab</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>