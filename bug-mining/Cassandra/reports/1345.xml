<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:27:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3626] Nodes can get stuck in UP state forever, despite being DOWN</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3626</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This is a proposed phrasing for an upstream ticket named &quot;Newly discovered nodes that are down get stuck in UP state forever&quot; (will edit w/ feedback until done):&lt;/p&gt;

&lt;p&gt;We have a observed a problem with gossip which, when you are bootstrapping a new node (or replacing using the replace_token support), any node in the cluster which is Down at the time the node is started, will be assumed to be Up and then &lt;b&gt;never ever&lt;/b&gt; flapped back to Down until you restart the node.&lt;/p&gt;

&lt;p&gt;This has at least two implications to replacing or bootstrapping new nodes when there are nodes down in the ring:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;If the new node happens to select a node listed as (UP but in reality is DOWN) as a stream source, streaming will sit there hanging forever.&lt;/li&gt;
	&lt;li&gt;If that doesn&apos;t happen (by picking another host), it will instead finish bootstrapping correctly, and begin servicing requests all the while thinking DOWN nodes are UP, and thus routing requests to them, generating timeouts.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The way to get out of this is to restart the node(s) that you bootstrapped.&lt;/p&gt;

&lt;p&gt;I have tested and confirmed the symptom (that the bootstrapped node things other nodes are Up) using a fairly recent 1.0. The main debugging effort happened on 0.8 however, so all details below refer to 0.8 but are probably similar in 1.0.&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Bring up a cluster of &amp;gt;= 3 nodes. &lt;b&gt;Ensure RF is &amp;lt; N&lt;/b&gt;, so that the cluster is operative with one node removed.&lt;/li&gt;
	&lt;li&gt;Pick two random nodes A, and B. Shut them &lt;b&gt;both&lt;/b&gt; off.&lt;/li&gt;
	&lt;li&gt;Wait for everyone to realize they are both off (for good measure).&lt;/li&gt;
	&lt;li&gt;Now, take node A and nuke it&apos;s data directories and re-start it, such that it comes up w/ normal bootstrap (or use replace_token; didn&apos;t test that but should not affect it).&lt;/li&gt;
	&lt;li&gt;Watch how node A starts up, all the while believing node B is down, even though all other nodes in the cluster agree that B is down and B is in fact still turned off.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The mechanism by which it initially goes into Up state is that the node receives a gossip response from any other node in the cluster, and GossipDigestAck2VerbHandler.doVerb() calls Gossiper.applyStateLocally().&lt;/p&gt;

&lt;p&gt;Gossiper.applyStateLocally() doesn&apos;t have any local endpoint state for the cluster, so the else statement at the end (&quot;it&apos;s a new node&quot;) gets triggered and handleMajorStateChange() is called. handleMajorStateChange() always calls markAlive(), unless the state is a dead state (but &quot;dead&quot; here does not mean &quot;not up&quot;, but refers to joining/hibernate etc).&lt;/p&gt;

&lt;p&gt;So at this point the node is up in the mind of the node you just bootstrapped.&lt;/p&gt;

&lt;p&gt;Now, in each gossip round doStatusCheck() is called, which iterates over all nodes (including the one falsly Up) and among other things, calls FailureDetector.interpret() on each node.&lt;/p&gt;

&lt;p&gt;FailureDetector.interpret() is meant to update its sense of Phi for the node, and potentially convict it. However there is a short-circuit at the top, whereby if we do not yet have any arrival window for the node, we simply return immediately.&lt;/p&gt;

&lt;p&gt;Arrival intervals are only added as a result of a FailureDetector.report() call, which never happens in this case because the initial endpoint state we added, which came from a remote node that was up, had the latest version of the gossip state (so Gossiper.reportFailureDetector() will never call report()).&lt;/p&gt;

&lt;p&gt;The result is that the node can never ever be convicted.&lt;/p&gt;

&lt;p&gt;Now, let&apos;s ignore for a moment the problem that a node that is actually Down will be thought to be Up temporarily for a little while. That is sub-optimal, but let&apos;s aim for a fix to the more serious problem in this ticket - which is that is stays up forever.&lt;/p&gt;

&lt;p&gt;Considered solutions:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;When interpret() gets called and there is no arrival window, we could add a faked arrival window far back in time to cause the node to have history and be marked down. This &quot;works&quot; in the particular test case. The problem is that since we are not ourselves actively trying to gossip to these nodes with any particular speed, it might take a significant time before we get any kind of confirmation from someone else that it&apos;s actually Up in cases where the node actually &lt;b&gt;is&lt;/b&gt; Up, so it&apos;s not clear that this is a good idea.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;When interpret() gets called and there is no arrival window, we can simply convict it immediately. This has roughly similar behavior as the previous suggestion.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;When interpret() gets called and there is no arrival window, we can add a faked arrival window at the current time, which will allow it to be treated as Up until the usual time has passed before we exceed the Phi conviction threshold.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;When interpret() gets called and there is no arrival window, we can immediately convict it, &lt;b&gt;and&lt;/b&gt; schedule it for immediate gossip on the next round in order to try to ensure they go Up quickly if they are indeed up. This has an effect of O&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_down.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; gossip traffic, as a special case once during node start-up. While theoretically a problem, I personally thing we can ignore it for now since it won&apos;t be a significant problem any time soon. However, this is more complicated since the way we queue up messages is asynchronously to background connection attempts. We&apos;d have to make sure the initial gossip message actually gets sent on an open TCP connection (I haven&apos;t confirmed whether this will be the case or not).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The first three are simple to implement, possibly the fourth. But in all cases, I am worried about potential negative consequences that I am not seeing.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12535056">CASSANDRA-3626</key>
            <summary>Nodes can get stuck in UP state forever, despite being DOWN</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="scode">Peter Schuller</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Dec 2011 23:18:23 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:44 +0000</updated>
                            <resolved>Thu, 15 Dec 2011 19:15:05 +0000</resolved>
                                        <fixVersion>0.8.10</fixVersion>
                    <fixVersion>1.0.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13169614" author="brandon.williams" created="Wed, 14 Dec 2011 19:37:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;Now, let&apos;s ignore for a moment the problem that a node that is actually Down will be thought to be Up temporarily for a little while.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is perfectly fine since this is what the SS.RING_DELAY stabilization period is designed to suss out - the correct ring state.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Steps to reproduce:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This can be simplified to &quot;start two nodes, shut one down, add a third.&quot;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Considered solutions:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;ISTM the simplest and most correct thing to do in this case is report() new nodes.  Patch to do so.&lt;/p&gt;</comment>
                            <comment id="13169615" author="brandon.williams" created="Wed, 14 Dec 2011 19:38:31 +0000"  >&lt;p&gt;FWIW I went back to 0.7 to repro this and the bug is there - so we&apos;ve had this for quite some time.&lt;/p&gt;</comment>
                            <comment id="13169977" author="scode" created="Thu, 15 Dec 2011 05:37:04 +0000"  >&lt;p&gt;I agree off the top of my head, but I&apos;m kinda suspicious as to why I didn&apos;t already arrive at that conclusion... I&apos;ll have another look at the code tomorrow and see if I can figure out some reason why this is not a good idea, but right now it seems like a +1 to me.&lt;/p&gt;</comment>
                            <comment id="13170409" author="scode" created="Thu, 15 Dec 2011 18:56:58 +0000"  >&lt;p&gt;+1. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13170425" author="brandon.williams" created="Thu, 15 Dec 2011 19:15:05 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="13170535" author="hudson" created="Thu, 15 Dec 2011 22:28:47 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #419 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/419/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/419/&lt;/a&gt;)&lt;br/&gt;
    Prevent new nodes from thinking down nodes are up forever.&lt;br/&gt;
Patch by brandonwilliams, reviewed by Peter Schuller for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3626&quot; title=&quot;Nodes can get stuck in UP state forever, despite being DOWN&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3626&quot;&gt;&lt;del&gt;CASSANDRA-3626&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;brandonwilliams : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1214916&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1214916&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/gms/Gossiper.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12507408" name="3626.txt" size="695" author="brandon.williams" created="Wed, 14 Dec 2011 19:37:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>220740</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 49 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gm7j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95028</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>scode</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[scode]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>