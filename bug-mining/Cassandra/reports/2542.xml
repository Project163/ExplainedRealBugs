<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6053] system.peers table not updated after decommissioning nodes in C* 2.0</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6053</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After decommissioning my cluster from 20 to 9 nodes using opscenter, I found all but one of the nodes had incorrect system.peers tables.&lt;/p&gt;

&lt;p&gt;This became a problem (afaik) when using the python-driver, since this queries the peers table to set up its connection pool. Resulting in very slow startup times, because of timeouts.&lt;/p&gt;

&lt;p&gt;The output of nodetool didn&apos;t seem to be affected. After removing the incorrect entries from the peers tables, the connection issues seem to have disappeared for us. &lt;/p&gt;

&lt;p&gt;Would like some feedback on if this was the right way to handle the issue or if I&apos;m still left with a broken cluster.&lt;/p&gt;

&lt;p&gt;Attached is the output of nodetool status, which shows the correct 9 nodes. Below that the output of the system.peers tables on the individual nodes.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Datastax AMI running EC2 m1.xlarge instances&lt;/p&gt;</environment>
        <key id="12669215">CASSANDRA-6053</key>
            <summary>system.peers table not updated after decommissioning nodes in C* 2.0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="gumuz">Guyon Moree</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Sep 2013 09:06:16 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:05 +0000</updated>
                            <resolved>Fri, 10 Jan 2014 18:52:04 +0000</resolved>
                                        <fixVersion>1.2.14</fixVersion>
                    <fixVersion>2.0.5</fixVersion>
                                        <due></due>
                            <votes>9</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="13770590" author="gumuz" created="Wed, 18 Sep 2013 09:07:16 +0000"  >&lt;p&gt;Output of nodetool status and the contents of the system.peers tables.&lt;/p&gt;</comment>
                            <comment id="13770820" author="gumuz" created="Wed, 18 Sep 2013 14:35:37 +0000"  >&lt;p&gt;Just a heads up: I&apos;ve just removed a broken node using &apos;nodetool removenode&apos; and encountered the same problem again. The node wasn&apos;t removed from the other nodes&apos; system.peers.&lt;/p&gt;</comment>
                            <comment id="13779272" author="cjbottaro" created="Thu, 26 Sep 2013 21:28:41 +0000"  >&lt;p&gt;We&apos;re seeing this on a 1.2.9 cluster as well.&lt;/p&gt;</comment>
                            <comment id="13780245" author="cjbottaro" created="Fri, 27 Sep 2013 18:56:30 +0000"  >&lt;p&gt;Is there a way to manually fix the system.peers table once it&apos;s in the messed up state?  Like a nodetool command or simply using CQL to delete the bad rows?&lt;/p&gt;</comment>
                            <comment id="13780277" author="brandon.williams" created="Fri, 27 Sep 2013 19:11:58 +0000"  >&lt;p&gt;You can simply delete them all from system.peers if you want, they&apos;ll re-populate correctly.&lt;/p&gt;</comment>
                            <comment id="13780281" author="brandon.williams" created="Fri, 27 Sep 2013 19:15:05 +0000"  >&lt;p&gt;Not sure how this can happen, given this code:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    private void removeEndpoint(InetAddress endpoint)
    {
        Gossiper.instance.removeEndpoint(endpoint);
        if (!isClientMode)
            SystemTable.removeEndpoint(endpoint);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which is what decom and removetoken end up calling.&lt;/p&gt;</comment>
                            <comment id="13780421" author="cjbottaro" created="Fri, 27 Sep 2013 21:16:32 +0000"  >&lt;p&gt;I did a &quot;truncate peers&quot; and it hasn&apos;t repopulated (I waited about 10 mins).  Do I need to restart one or more nodes to trigger repopulating of the table?&lt;/p&gt;</comment>
                            <comment id="13780571" author="brandon.williams" created="Fri, 27 Sep 2013 23:32:27 +0000"  >&lt;p&gt;Yes.&lt;/p&gt;</comment>
                            <comment id="13785003" author="jeromatron" created="Thu, 3 Oct 2013 11:12:44 +0000"  >&lt;p&gt;The load_ring_state=false directive should probably also clear out the peers table because otherwise, the state that you&apos;re trying to get rid of is still persisted there.&lt;/p&gt;</comment>
                            <comment id="13788300" author="brandon.williams" created="Mon, 7 Oct 2013 16:56:19 +0000"  >&lt;p&gt;If a user knows enough to disable loading the state and that fixes the problem, they can clear the peers table manually.&lt;/p&gt;</comment>
                            <comment id="13851914" author="jbellis" created="Wed, 18 Dec 2013 17:02:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enigmacurry&quot; class=&quot;user-hover&quot; rel=&quot;enigmacurry&quot;&gt;enigmacurry&lt;/a&gt; can you reproduce?&lt;/p&gt;</comment>
                            <comment id="13851971" author="enigmacurry" created="Wed, 18 Dec 2013 18:03:07 +0000"  >&lt;p&gt;First attempt appears to work correctly on cassandra-2.0 HEAD and 1.2.9 : &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;12:53 PM:~$ ccm create -v git:cassandra-1.2.9 t
Fetching Cassandra updates...
Current cluster is now: t
12:53 PM:~$ ccm populate -n 5
12:54 PM:~$ ccm start
12:54 PM:~$ ccm node1 stress
Created keyspaces. Sleeping 1s &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; propagation.
total,interval_op_rate,interval_key_rate,latency/95th/99th,elapsed_time
24994,2499,2499,9.5,55.2,179.0,10
103123,7812,7812,2.8,27.2,134.7,20
236358,13323,13323,1.7,15.4,134.7,30
329477,9311,9311,1.7,9.8,109.8,40
405667,7619,7619,1.8,9.2,6591.9,50
558989,15332,15332,1.5,6.6,6591.1,60
^C12:55 PM:~$ ccm node1 cqlsh
Connected to t at 127.0.0.1:9160.
[cqlsh 3.1.7 | Cassandra 1.2.9-SNAPSHOT | CQL spec 3.0.0 | Thrift protocol 19.36.0]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt; select peer from system.peers;

 peer
-----------
 127.0.0.3
 127.0.0.2
 127.0.0.5
 127.0.0.4

cqlsh&amp;gt;
12:55 PM:~$ ccm node2 decommission
12:57 PM:~$ ccm node1 cqlsh
Connected to t at 127.0.0.1:9160.
[cqlsh 3.1.7 | Cassandra 1.2.9-SNAPSHOT | CQL spec 3.0.0 | Thrift protocol 19.36.0]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt; select peer from system.peers;

 peer
-----------
 127.0.0.3
 127.0.0.5
 127.0.0.4

cqlsh&amp;gt;
12:58 PM:~$
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;All nodes show equivalent peers table.&lt;/p&gt;</comment>
                            <comment id="13851994" author="enigmacurry" created="Wed, 18 Dec 2013 18:29:21 +0000"  >&lt;p&gt;OK, reproduced this by killing -9 one of the nodes and then doing a &apos;nodetool removenode&apos;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;01:20 PM:~$ kill -9 18961    (PID of node1)
01:21 PM:~$ ccm node1 status
Failed to connect to &lt;span class=&quot;code-quote&quot;&gt;&apos;127.0.0.1:7100&apos;&lt;/span&gt;: Connection refused
01:21 PM:~$ ccm node2 status
Datacenter: datacenter1
=======================
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address    Load       Owns   Host ID                               Token                                    Rack
DN  127.0.0.1  62.93 KB   20.0%  896644af-8640-4be6-a3ff-e8ed559d851c  -9223372036854775808                     rack1
UN  127.0.0.2  51.17 KB   20.0%  d3801466-d36d-428c-b4e5-05ff69fe36c0  -5534023222112865485                     rack1
UN  127.0.0.3  62.78 KB   20.0%  cb36c3ad-df45-4f77-bff5-ca93c504ec08  -1844674407370955162                     rack1
UN  127.0.0.4  51.17 KB   20.0%  89031a05-a3f6-4ac7-9d29-6caa0c609dbc  1844674407370955161                      rack1
UN  127.0.0.5  51.27 KB   20.0%  4909d856-a86e-493a-a7d0-7570d71eb9d8  5534023222112865484                      rack1

# Issue removenode on node3 :
01:21 PM:~$ ~/.ccm/t/node1/bin/nodetool -p 7300 removenode 896644af-8640-4be6-a3ff-e8ed559d851c

01:22 PM:~$ ccm node3 cqlsh
Connected to t at 127.0.0.3:9160.
[cqlsh 4.1.0 | Cassandra 2.0.3-SNAPSHOT | CQL spec 3.1.1 | Thrift protocol 19.39.0]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt; select * from system.peers;

 peer      | data_center | host_id                              | preferred_ip | rack  | release_version | rpc_address | schema_version                       | tokens
-----------+-------------+--------------------------------------+--------------+-------+-----------------+-------------+--------------------------------------+--------------------------
 127.0.0.2 | datacenter1 | d3801466-d36d-428c-b4e5-05ff69fe36c0 |         &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; | rack1 |  2.0.3-SNAPSHOT |   127.0.0.2 | d133398f-f287-3674-83af-a1b04ee29f1f | {&lt;span class=&quot;code-quote&quot;&gt;&apos;-5534023222112865485&apos;&lt;/span&gt;}
 127.0.0.5 | datacenter1 | 4909d856-a86e-493a-a7d0-7570d71eb9d8 |         &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; | rack1 |  2.0.3-SNAPSHOT |   127.0.0.5 | d133398f-f287-3674-83af-a1b04ee29f1f |  {&lt;span class=&quot;code-quote&quot;&gt;&apos;5534023222112865484&apos;&lt;/span&gt;}
 127.0.0.4 | datacenter1 | 89031a05-a3f6-4ac7-9d29-6caa0c609dbc |         &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; | rack1 |  2.0.3-SNAPSHOT |   127.0.0.4 | d133398f-f287-3674-83af-a1b04ee29f1f |  {&lt;span class=&quot;code-quote&quot;&gt;&apos;1844674407370955161&apos;&lt;/span&gt;}

(3 rows)

# Check node2 peers table:

01:23 PM:~$ ccm node2 cqlsh
Connected to t at 127.0.0.2:9160.
[cqlsh 4.1.0 | Cassandra 2.0.3-SNAPSHOT | CQL spec 3.1.1 | Thrift protocol 19.39.0]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt; select * from system.peers;

 peer      | data_center | host_id                              | preferred_ip | rack  | release_version | rpc_address | schema_version                       | tokens
-----------+-------------+--------------------------------------+--------------+-------+-----------------+-------------+--------------------------------------+--------------------------
 127.0.0.3 | datacenter1 | cb36c3ad-df45-4f77-bff5-ca93c504ec08 |         &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; | rack1 |  2.0.3-SNAPSHOT |   127.0.0.3 | d133398f-f287-3674-83af-a1b04ee29f1f | {&lt;span class=&quot;code-quote&quot;&gt;&apos;-1844674407370955162&apos;&lt;/span&gt;}
 127.0.0.1 |        &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; | 896644af-8640-4be6-a3ff-e8ed559d851c |         &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |  &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |            &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |   127.0.0.1 |                                 &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |                     &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
 127.0.0.5 | datacenter1 | 4909d856-a86e-493a-a7d0-7570d71eb9d8 |         &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; | rack1 |  2.0.3-SNAPSHOT |   127.0.0.5 | d133398f-f287-3674-83af-a1b04ee29f1f |  {&lt;span class=&quot;code-quote&quot;&gt;&apos;5534023222112865484&apos;&lt;/span&gt;}
 127.0.0.4 | datacenter1 | 89031a05-a3f6-4ac7-9d29-6caa0c609dbc |         &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; | rack1 |  2.0.3-SNAPSHOT |   127.0.0.4 | d133398f-f287-3674-83af-a1b04ee29f1f |  {&lt;span class=&quot;code-quote&quot;&gt;&apos;1844674407370955161&apos;&lt;/span&gt;}

(4 rows)

# oh noes!... node2 still has an entry &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; node1 in peers table.

01:23 PM:~$ ccm node2 status
Datacenter: datacenter1
=======================
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address    Load       Owns   Host ID                               Token                                    Rack
UN  127.0.0.2  51.17 KB   40.0%  d3801466-d36d-428c-b4e5-05ff69fe36c0  -5534023222112865485                     rack1
UN  127.0.0.3  62.78 KB   20.0%  cb36c3ad-df45-4f77-bff5-ca93c504ec08  -1844674407370955162                     rack1
UN  127.0.0.4  51.17 KB   20.0%  89031a05-a3f6-4ac7-9d29-6caa0c609dbc  1844674407370955161                      rack1
UN  127.0.0.5  51.27 KB   20.0%  4909d856-a86e-493a-a7d0-7570d71eb9d8  5534023222112865484                      rack1

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;By issuing the removenode on node3, node3 seems to know about the node being removed and it&apos;s peers table is correct. node2, although it&apos;s status output shows node1 going away, it&apos;s peers table has not been updated.&lt;/p&gt;</comment>
                            <comment id="13852207" author="jbellis" created="Wed, 18 Dec 2013 21:57:27 +0000"  >&lt;p&gt;Thanks, Ryan.&lt;/p&gt;</comment>
                            <comment id="13858811" author="brandon.williams" created="Mon, 30 Dec 2013 13:54:39 +0000"  >&lt;p&gt;Can you provide debug logs from node2?&lt;/p&gt;</comment>
                            <comment id="13859609" author="thobbs" created="Tue, 31 Dec 2013 18:39:28 +0000"  >&lt;p&gt;I was able to repro with Ryan&apos;s steps, so I can upload the logs if you&apos;d like, but I should be able to figure this one out.&lt;/p&gt;</comment>
                            <comment id="13859758" author="thobbs" created="Tue, 31 Dec 2013 22:49:05 +0000"  >&lt;p&gt;The problem was that state changes for the removed node were being handled after the system.peers row was deleted.  These state changes would result in update to the system.peers row, partially reviving it.&lt;/p&gt;

&lt;p&gt;6053-v1.patch (and &lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-6053&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;) avoids updating the system.peers table if the node is unknown or is in one of the &quot;dead&quot; states and adds some basic unit test coverage.&lt;/p&gt;</comment>
                            <comment id="13868121" author="brandon.williams" created="Fri, 10 Jan 2014 18:52:04 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="14987349" author="kenfailbus" created="Tue, 3 Nov 2015 14:30:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; FYI - Even though, this was fixed it surfaced in 2.0.14 release that we have in production. We are going to follow the work-around as mentioned above.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12620992" name="6053-v1.patch" size="8155" author="thobbs" created="Tue, 31 Dec 2013 22:49:05 +0000"/>
                            <attachment id="12603794" name="peers" size="8193" author="gumuz" created="Wed, 18 Sep 2013 09:07:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>349147</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 3 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1o7bj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>349445</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324803">1.2.9</customfieldvalue>
    <customfieldvalue id="12325322">2.0.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324629">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>