<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:10:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12763] Compaction performance issues when a table has a lot of sstables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12763</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;An issue with a script flooded my cluster with sstables. There is now a table with 100k sstables, all on the order of KBytes, and it&apos;s taking a long time (ETA 20 days) to compact, even though the table is only ~30GB.&lt;/p&gt;

&lt;p&gt;Stack trace :&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;CompactionExecutor:269&quot; #7536 daemon prio=1 os_prio=4 tid=0x00007f4acd40fc00 nid=0x14f8 runnable [0x00007f4798436000]
   java.lang.Thread.State: RUNNABLE
	at java.io.UnixFileSystem.list(Native Method)
	at java.io.File.list(File.java:1122)
	at java.io.File.listFiles(File.java:1248)
	at org.apache.cassandra.db.lifecycle.LogRecord.getExistingFiles(LogRecord.java:268)
	at org.apache.cassandra.db.lifecycle.LogRecord.make(LogRecord.java:150)
	at org.apache.cassandra.db.lifecycle.LogFile.makeRecord(LogFile.java:293)
	at org.apache.cassandra.db.lifecycle.LogFile.add(LogFile.java:283)
	at org.apache.cassandra.db.lifecycle.LogTransaction.obsoleted(LogTransaction.java:158)
	at org.apache.cassandra.db.lifecycle.Helpers.prepareForObsoletion(Helpers.java:134)
	at org.apache.cassandra.db.lifecycle.LifecycleTransaction.doPrepare(LifecycleTransaction.java:193)
	at org.apache.cassandra.utils.concurrent.Transactional$AbstractTransactional.prepareToCommit(Transactional.java:173)
	at org.apache.cassandra.io.sstable.SSTableRewriter.doPrepare(SSTableRewriter.java:376)
	at org.apache.cassandra.utils.concurrent.Transactional$AbstractTransactional.prepareToCommit(Transactional.java:173)
	at org.apache.cassandra.db.compaction.writers.CompactionAwareWriter.doPrepare(CompactionAwareWriter.java:84)
	at org.apache.cassandra.utils.concurrent.Transactional$AbstractTransactional.prepareToCommit(Transactional.java:173)
	at org.apache.cassandra.utils.concurrent.Transactional$AbstractTransactional.finish(Transactional.java:184)
	at org.apache.cassandra.db.compaction.writers.CompactionAwareWriter.finish(CompactionAwareWriter.java:94)
	at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:194)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:78)
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:61)
	at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionCandidate.run(CompactionManager.java:263)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;listFiles is being called over and over, apparently scaling with the number of files in the compaction.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13010881">CASSANDRA-12763</key>
            <summary>Compaction performance issues when a table has a lot of sstables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="tvdw">Tom van der Woerdt</reporter>
                        <labels>
                    </labels>
                <created>Sun, 9 Oct 2016 22:59:30 +0000</created>
                <updated>Fri, 15 May 2020 08:03:17 +0000</updated>
                            <resolved>Mon, 19 Feb 2018 15:57:14 +0000</resolved>
                                        <fixVersion>3.0.17</fixVersion>
                    <fixVersion>3.11.3</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="15560784" author="tvdw" created="Sun, 9 Oct 2016 23:03:50 +0000"  >&lt;p&gt;note: I&apos;ve filed &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12763&quot; title=&quot;Compaction performance issues when a table has a lot of sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12763&quot;&gt;&lt;del&gt;CASSANDRA-12763&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12764&quot; title=&quot;Compaction performance issues with many sstables, during transaction commit phase&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12764&quot;&gt;CASSANDRA-12764&lt;/a&gt; as separate issues, as they look unrelated to me, but they were taken from the same incident.&lt;/p&gt;</comment>
                            <comment id="15560791" author="jjirsa" created="Sun, 9 Oct 2016 23:06:38 +0000"  >&lt;p&gt;As mentioned in IRC, I &lt;b&gt;THINK&lt;/b&gt; that ultimately the problem is that this loop: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/jeffjirsa/cassandra/blob/trunk/src/java/org/apache/cassandra/db/lifecycle/Helpers.java#L130&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jeffjirsa/cassandra/blob/trunk/src/java/org/apache/cassandra/db/lifecycle/Helpers.java#L130&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Calls &lt;tt&gt;listFiles()&lt;/tt&gt; for each sstablereader in the transaction. Since &lt;tt&gt;listFiles&lt;/tt&gt; is notoriously slow when there are a ton of files in the directory, and you call it N times, you end up waiting at the end of the compaction preparing to commit/marking files for deletion. It may be worth someone investigating whether or not we can avoid the full directory scan N times - due to nature of that code, it may not be safe to cache the directory listing, but it&apos;s worth looking into. &lt;/p&gt;</comment>
                            <comment id="15562717" author="jeromatron" created="Mon, 10 Oct 2016 16:19:31 +0000"  >&lt;p&gt;As an aside, you may want to determine why you have a lot of small sstables in the first place.  One common cause is when people change the number of flush writers but don&apos;t change the memtable cleanup threshold.  So it flushes much more frequently, resulting in lots of small sstables.  Granted we want to improve the handling of a lot of small sstables, but flushing larger sstables will help avoid the problem.&lt;/p&gt;</comment>
                            <comment id="15563219" author="jeromatron" created="Mon, 10 Oct 2016 19:25:03 +0000"  >&lt;p&gt;With some other context, it sounds like the smaller sstables may be created as a product of using LCS with 256 vnodes and then the repair creates the tiny sstables.  In that case it&apos;s probably better to use a smaller number of vnodes (perhaps 32) in Cassandra 3+ with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7032&quot; title=&quot;Improve vnode allocation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7032&quot;&gt;&lt;del&gt;CASSANDRA-7032&lt;/del&gt;&lt;/a&gt; so you don&apos;t have as much skew and aren&apos;t as vulnerable to small sstables with repair.&lt;/p&gt;

&lt;p&gt;Keep in mind that if you add a new datacenter, that 7032 relies on getting the replication factor to reduce the skew at smaller vnode numbers.  So you&apos;d need to create a node in each rack in the new datacenter with &lt;tt&gt;auto_bootstrap=false&lt;/tt&gt;, then you can create an empty keyspace and table with replication in that datacenter and add the rest of the nodes with the 7032 algorithm.&lt;/p&gt;</comment>
                            <comment id="15563250" author="jeromatron" created="Mon, 10 Oct 2016 19:34:38 +0000"  >&lt;p&gt;In terms of the problem being with directory listings, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; mentioned that we could probably even skip the directory listing when doing user-defined compactions and just trust the operator.  From there (for general compactions), I was curious as to whether a directory cache would cause any other issues if the information was ever stale.  Do you have any thoughts on that optimization or current problem with the directory listing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16268844" author="slapukhov" created="Tue, 28 Nov 2017 14:47:31 +0000"  >&lt;p&gt;What if just maintain a file containing the directory listing and update it every time when SSTable is added/removed? So instead of calling costly java.io.File.listFiles call instead the special method that will just read and parse this file. This could give a performance benefit since this read/parse operation cost will be independent of number of files in the data directory.&lt;/p&gt;

&lt;p&gt;Besides, I believe it could be easier in terms of implementation.&lt;/p&gt;

&lt;p&gt;What do you guys think?&lt;/p&gt;</comment>
                            <comment id="16268859" author="krummas" created="Tue, 28 Nov 2017 15:00:11 +0000"  >&lt;p&gt;Seems I missed this issue - it looks similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13909&quot; title=&quot;Improve TRUNCATE performance with many sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13909&quot;&gt;&lt;del&gt;CASSANDRA-13909&lt;/del&gt;&lt;/a&gt;, I&apos;ll take it for now&lt;/p&gt;</comment>
                            <comment id="16316513" author="krummas" created="Mon, 8 Jan 2018 15:50:08 +0000"  >&lt;p&gt;patch that pre-creates the deletion log records and does not recreate the records when checking if the log transaction contains operations for the same sstables:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/12763&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/12763&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/tree/marcuse%2F12763&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/krummas/cassandra/tree/marcuse%2F12763&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/468/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/468/console&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16358560" author="krummas" created="Fri, 9 Feb 2018 15:33:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; you would probably be the best person to review this, do you have time?&lt;/p&gt;</comment>
                            <comment id="16360205" author="stefania" created="Mon, 12 Feb 2018 01:18:51 +0000"  >&lt;p&gt;Sure, I&apos;ll try to review it in the next few days.&lt;/p&gt;</comment>
                            <comment id="16361803" author="stefania" created="Tue, 13 Feb 2018 04:23:34 +0000"  >&lt;p&gt;LGTM - great job &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Nits: there are some unused imports and redundant blank lines in &lt;tt&gt;HelpersTest&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Note: the CI failures look unrelated, but there are just too many failing dtests to check them all in detail.&lt;/p&gt;</comment>
                            <comment id="16369234" author="krummas" created="Mon, 19 Feb 2018 15:29:41 +0000"  >&lt;p&gt;got a clean run on trunk: &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/268&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/krummas/cassandra/268&lt;/a&gt; - will get this committed&lt;/p&gt;
</comment>
                            <comment id="16369255" author="krummas" created="Mon, 19 Feb 2018 15:57:14 +0000"  >&lt;p&gt;and committed as &lt;tt&gt;d73f45bad4cd6d8cf1cea7d9b35b76075dc277e1&lt;/tt&gt;, thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13120527">CASSANDRA-14069</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34n8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12337349">3.0.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stefania</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>