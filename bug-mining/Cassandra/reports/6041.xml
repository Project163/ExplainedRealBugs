<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:24:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-17244] Fix org.apache.cassandra.distributed.test.trackwarnings.TombstoneCountWarningTest.failThresholdSinglePartition</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-17244</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;org.apache.cassandra.distributed.test.trackwarnings.TombstoneCountWarningTest.failThresholdSinglePartition failed &lt;a href=&quot;https://jenkins-cm4.apache.org/job/Cassandra-devbranch/1354/testReport/junit/org.apache.cassandra.distributed.test.trackwarnings/TombstoneCountWarningTest/failThresholdSinglePartition/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I didn&apos;t find any other occurrences but seems to me legit failure.&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt;&#160;as I think you were working on those and probably you will make better assessment than me. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13421500">CASSANDRA-17244</key>
            <summary>Fix org.apache.cassandra.distributed.test.trackwarnings.TombstoneCountWarningTest.failThresholdSinglePartition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dcapwell">David Capwell</assignee>
                                    <reporter username="edimitrova">Ekaterina Dimitrova</reporter>
                        <labels>
                    </labels>
                <created>Sat, 8 Jan 2022 23:15:30 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:51 +0000</updated>
                            <resolved>Mon, 6 Jun 2022 20:34:20 +0000</resolved>
                                        <fixVersion>NA</fixVersion>
                                    <component>CI</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="5400">1.5h</timespent>
                                <comments>
                            <comment id="17489243" author="azotcsit" created="Wed, 9 Feb 2022 05:04:38 +0000"  >&lt;p&gt;It failed in &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/928/testReport/org.apache.cassandra.distributed.test.trackwarnings/TombstoneCountWarningTest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;928&lt;/a&gt; and &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/935/testReport/org.apache.cassandra.distributed.test.trackwarnings/TombstoneCountWarningTest/failThresholdSinglePartition/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;935&lt;/a&gt; builds.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NullPointerException
	at com.google.common.collect.Iterables.getOnlyElement(Iterables.java:254)
	at org.apache.cassandra.distributed.test.trackwarnings.TombstoneCountWarningTest.failThreshold(TombstoneCountWarningTest.java:273)
	at org.apache.cassandra.distributed.test.trackwarnings.TombstoneCountWarningTest.failThresholdSinglePartition(TombstoneCountWarningTest.java:186)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Looks like sometimes warnings can be unexpectedly empty. I&apos;m not really familiar with all these classes and test utilities, however, I have a guess that it somehow maybe related to the fact which node really acts as a coordinator for&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
QueryProcessor.execute(cql, org.apache.cassandra.db.ConsistencyLevel.ALL, QueryState.forInternalCalls()); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;command. With that idea in mind, I feel we may need to introduce CoordinatorWarning init/done/reset logic as it was done in &lt;a href=&quot;https://github.com/apache/cassandra/pull/1180/files#diff-e14e42b9f28baf531cfe0fd4d79794617959d63e26e03bed54e0e1636e55d890R200.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/1180/files#diff-e14e42b9f28baf531cfe0fd4d79794617959d63e26e03bed54e0e1636e55d890R200.&lt;/a&gt; But this is a pure speculation because I do not really understand the whole logic &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I hope &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; can comment on this.&lt;/p&gt;

&lt;p&gt;If it does not seem to be the right direction I&apos;d postpone working on this ticket because I have a bunch of other test failures on Jenkins to take a look to.&lt;/p&gt;</comment>
                            <comment id="17489375" author="azotcsit" created="Wed, 9 Feb 2022 08:59:02 +0000"  >&lt;p&gt;I linked the failed tests in Butler with this ticket. Here is the detailed log from 935 build:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk-jvm-dtest/1072/jdk=jdk_11_latest,label=cassandra,split=1/consoleFull&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk-jvm-dtest/1072/jdk=jdk_11_latest,label=cassandra,split=1/consoleFull&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17500336" author="adelapena" created="Wed, 2 Mar 2022 18:35:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1327/workflows/05d20d1b-aa29-49e8-bfe6-47cf6ec3fbe9/jobs/13068&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This run&lt;/a&gt; with 200 iterations of&#160;&lt;tt&gt;failThresholdSinglePartition&lt;/tt&gt; passes. However, &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1328/workflows/23d7dc1e-4230-473b-bd0c-19d0e180b673/jobs/13070&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this other run&lt;/a&gt; of the entire suite hits the NPE four times.&lt;/p&gt;</comment>
                            <comment id="17525239" author="edimitrova" created="Wed, 20 Apr 2022 19:37:39 +0000"  >&lt;p&gt;I saw it again today &lt;a href=&quot;https://jenkins-cm4.apache.org/job/Cassandra-trunk/1088/testReport/junit/org.apache.cassandra.distributed.test.trackwarnings/TombstoneCountWarningTest/failThresholdSinglePartition/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins-cm4.apache.org/job/Cassandra-trunk/1088/testReport/junit/org.apache.cassandra.distributed.test.trackwarnings/TombstoneCountWarningTest/failThresholdSinglePartition/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17544961" author="edimitrova" created="Wed, 1 Jun 2022 15:03:59 +0000"  >&lt;p&gt;Hey, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt;&#160;(sorry, I am super annoying today &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;), but did you have the chance to look at what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=azotcsit&quot; class=&quot;user-hover&quot; rel=&quot;azotcsit&quot;&gt;azotcsit&lt;/a&gt;&#160;mentioned?&lt;/p&gt;</comment>
                            <comment id="17545607" author="dcapwell" created="Thu, 2 Jun 2022 18:56:15 +0000"  >&lt;p&gt;sorry, didn&apos;t see this till you poked me... looking into it&lt;/p&gt;</comment>
                            <comment id="17545610" author="dcapwell" created="Thu, 2 Jun 2022 19:02:07 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; List&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; getWarnings()
    {
        State state = get();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; || state.warnings.isEmpty())
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; state.warnings;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so state is null or no warnings we get a null, which is unexpected in this case... we do know we hit TombstoneAbortException (else we would has AssertionError), so we know &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
tombstones.aborts.instances.isEmpty() == &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so org.apache.cassandra.service.reads.thresholds.CoordinatorWarnings#recordAborts should add this warning&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg = toString.apply(counter.aborts.instances.size(), counter.aborts.maxValue, cql);
ClientWarn.instance.warn(msg + &lt;span class=&quot;code-quote&quot;&gt;&quot; with &quot;&lt;/span&gt; + loggableTokens);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which we should be able to see in logs... will try to see if any builds exist still with logs to confirm&lt;/p&gt;</comment>
                            <comment id="17545613" author="dcapwell" created="Thu, 2 Jun 2022 19:09:29 +0000"  >&lt;p&gt;all logs lost at this point, rerunning &lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=ci%2Ftrunk&amp;amp;filter=all&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=ci%2Ftrunk&amp;amp;filter=all&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17545620" author="dcapwell" created="Thu, 2 Jun 2022 19:37:58 +0000"  >&lt;p&gt;repo: &lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1508/workflows/fee86131-b84b-4863-8808-9d8c7beb7d92/jobs/12619&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1508/workflows/fee86131-b84b-4863-8808-9d8c7beb7d92/jobs/12619&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;issue is there are too many tests and no good log showing where the test starts... added logging and trying again&lt;/p&gt;</comment>
                            <comment id="17545624" author="dcapwell" created="Thu, 2 Jun 2022 19:58:55 +0000"  >&lt;p&gt;Ok here is what I am seeing&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.NullPointerException
	at com.google.common.collect.Iterables.getOnlyElement(Iterables.java:254)
	at org.apache.cassandra.distributed.test.thresholds.TombstoneCountWarningTest.failThreshold(TombstoneCountWarningTest.java:287)
	at org.apache.cassandra.distributed.test.thresholds.TombstoneCountWarningTest.failThresholdSinglePartition(TombstoneCountWarningTest.java:199)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;which maps to this code&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
enable(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
        warnings = CLUSTER.get(1).callsOnInstance(() -&amp;gt; {
            ClientWarn.instance.captureWarnings();
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
            {
                QueryProcessor.execute(cql, org.apache.cassandra.db.ConsistencyLevel.ALL, QueryState.forInternalCalls());
                Assert.fail(&lt;span class=&quot;code-quote&quot;&gt;&quot;Expected query failure&quot;&lt;/span&gt;);
            }
            &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (ReadFailureException e)
            {
                Assertions.assertThat(e).isNotInstanceOf(TombstoneAbortException.class);
            }
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ClientWarn.instance.getWarnings();
        }).call();
        &lt;span class=&quot;code-comment&quot;&gt;// client warnings are currently coordinator only, so &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; present only 1 is expected
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isScan)
        {
            &lt;span class=&quot;code-comment&quot;&gt;// Scans perform multiple ReadCommands, which will not propgate the warnings to the top-level coordinator; so no warnings are expected
&lt;/span&gt;            Assertions.assertThat(warnings).isNull();
        }
        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
        {
            Assertions.assertThat(Iterables.getOnlyElement(warnings))
                      .startsWith(&lt;span class=&quot;code-quote&quot;&gt;&quot;Read &quot;&lt;/span&gt; + TOMBSTONE_FAIL + &lt;span class=&quot;code-quote&quot;&gt;&quot; live rows and &quot;&lt;/span&gt; + (TOMBSTONE_FAIL + 1) + &lt;span class=&quot;code-quote&quot;&gt;&quot; tombstone cells &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query &quot;&lt;/span&gt; + cql);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So track warnings is no longer active, and we are validating that old tombstone warning was present... which is done here org/apache/cassandra/db/ReadCommand.java:493.onClose&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; warnTombstones = tombstones &amp;gt; warningThreshold &amp;amp;&amp;amp; respectTombstoneThresholds;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (warnTombstones)
                {
                    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; msg = &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(
                            &lt;span class=&quot;code-quote&quot;&gt;&quot;Read %d live rows and %d tombstone cells &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query %1.512s; token %s (see tombstone_warn_threshold)&quot;&lt;/span&gt;,
                            liveRows, tombstones, ReadCommand.&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.toCQLString(), currentKey.getToken());
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (trackWarnings)
                        MessageParams.add(ParamType.TOMBSTONE_WARNING, tombstones);
                    &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                        ClientWarn.instance.warn(msg);
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tombstones &amp;lt; failureThreshold)
                    {
                        metric.tombstoneWarnings.inc();
                    }

                    logger.warn(msg);
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;based off logs I see the following&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN  [ReadStage-1] node2 2022-06-02 19:41:29,697 ReadCommand.java:592 - Read 100 live rows and 101 tombstone cells &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING; token -4069959284402364209 (see tombstone_warn_threshold)
WARN  [ReadStage-1] node3 2022-06-02 19:41:29,701 ReadCommand.java:592 - Read 100 live rows and 101 tombstone cells &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING; token -4069959284402364209 (see tombstone_warn_threshold)
WARN  [ReadStage-1] node1 2022-06-02 19:41:29,701 ReadCommand.java:592 - Read 100 live rows and 101 tombstone cells &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING; token -4069959284402364209 (see tombstone_warn_threshold)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so every node saw tombstone warnings, so coordinator should which should bubble up to the user... but didn&apos;t?&lt;/p&gt;

&lt;p&gt;Full logs for this section of code&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  [node1_isolatedExecutor:2] node1 2022-06-02 19:41:29,690 DatabaseDescriptor.java:3992 - updated read_thresholds_enabled to &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
INFO  [node2_isolatedExecutor:2] node2 2022-06-02 19:41:29,691 DatabaseDescriptor.java:3992 - updated read_thresholds_enabled to &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
INFO  [node3_isolatedExecutor:1] node3 2022-06-02 19:41:29,691 DatabaseDescriptor.java:3992 - updated read_thresholds_enabled to &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
WARN  19:41:29 Read 100 live rows and 101 tombstone cells &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING; token -4069959284402364209 (see tombstone_warn_threshold)
WARN  [ReadStage-1] node2 2022-06-02 19:41:29,697 ReadCommand.java:592 - Read 100 live rows and 101 tombstone cells &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING; token -4069959284402364209 (see tombstone_warn_threshold)
ERROR 19:41:29 Scanned over 101 tombstones during query &lt;span class=&quot;code-quote&quot;&gt;&apos;SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING&apos;&lt;/span&gt; (last scanned row token was -4069959284402364209 and partion key was ((1), 100)); query aborted
ERROR [ReadStage-1] node2 2022-06-02 19:41:29,697 NoSpamLogger.java:111 - Scanned over 101 tombstones during query &lt;span class=&quot;code-quote&quot;&gt;&apos;SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING&apos;&lt;/span&gt; (last scanned row token was -4069959284402364209 and partion key was ((1), 100)); query aborted
DEBUG [node1_isolatedExecutor:2] node1 2022-06-02 19:41:29,700 ReadCallback.java:146 - Failed; received 0 of 3 responses
WARN  19:41:29 Read 100 live rows and 101 tombstone cells &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING; token -4069959284402364209 (see tombstone_warn_threshold)
WARN  [ReadStage-1] node3 2022-06-02 19:41:29,701 ReadCommand.java:592 - Read 100 live rows and 101 tombstone cells &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING; token -4069959284402364209 (see tombstone_warn_threshold)
ERROR 19:41:29 Scanned over 101 tombstones during query &lt;span class=&quot;code-quote&quot;&gt;&apos;SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING&apos;&lt;/span&gt; (last scanned row token was -4069959284402364209 and partion key was ((1), 100)); query aborted
ERROR [ReadStage-1] node3 2022-06-02 19:41:29,701 NoSpamLogger.java:111 - Scanned over 101 tombstones during query &lt;span class=&quot;code-quote&quot;&gt;&apos;SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING&apos;&lt;/span&gt; (last scanned row token was -4069959284402364209 and partion key was ((1), 100)); query aborted
WARN  19:41:29 Read 100 live rows and 101 tombstone cells &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING; token -4069959284402364209 (see tombstone_warn_threshold)
WARN  [ReadStage-1] node1 2022-06-02 19:41:29,701 ReadCommand.java:592 - Read 100 live rows and 101 tombstone cells &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING; token -4069959284402364209 (see tombstone_warn_threshold)
ERROR 19:41:29 Scanned over 101 tombstones during query &lt;span class=&quot;code-quote&quot;&gt;&apos;SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING&apos;&lt;/span&gt; (last scanned row token was -4069959284402364209 and partion key was ((1), 100)); query aborted
ERROR [ReadStage-1] node1 2022-06-02 19:41:29,701 StorageProxy.java:2148 - Scanned over 101 tombstones during query &lt;span class=&quot;code-quote&quot;&gt;&apos;SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING&apos;&lt;/span&gt; (last scanned row token was -4069959284402364209 and partion key was ((1), 100)); query aborted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17545627" author="dcapwell" created="Thu, 2 Jun 2022 20:01:08 +0000"  >&lt;p&gt;based off logs we can confirm we did call org.apache.cassandra.service.ClientWarn#warn yet the coordinator thread sees that it is empty!  This feels like a concurrency bug with ClientWarn?  is trackWarnings=true for some reason?&lt;/p&gt;</comment>
                            <comment id="17545633" author="dcapwell" created="Thu, 2 Jun 2022 20:19:21 +0000"  >&lt;p&gt;updated logging shows trackWarning=false so we called ClientWarn.warn&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN  [ReadStage-3] node1 2022-06-02 20:13:56,267 ReadCommand.java:592 - Read 100 live rows and 101 tombstone cells &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING; token -4069959284402364209 (see tombstone_warn_threshold); trackWarnings=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
ERROR [ReadStage-3] node1 2022-06-02 20:13:56,267 StorageProxy.java:2148 - Scanned over 101 tombstones during query &lt;span class=&quot;code-quote&quot;&gt;&apos;SELECT * FROM distributed_test_keyspace.tbl WHERE pk = 1 ALLOW FILTERING&apos;&lt;/span&gt; (last scanned row token was -4069959284402364209 and partion key was ((1), 100)); query aborted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So this feels like a ClientWarn bug...&lt;/p&gt;</comment>
                            <comment id="17545698" author="dcapwell" created="Fri, 3 Jun 2022 00:14:43 +0000"  >&lt;p&gt;with enough hacks was able to verify that its a timing bug...  node1 (coordinator) works when the Read executor has task permits to allow running in the current thread (isolated executor... coordinator blocks on local read), but when it doesn&apos;t and needs to schedule it, it may see the error after the coordinator already replied back to the user that the query failed... I have a patch to do class rewriting so we block on node1 response...&lt;/p&gt;</comment>
                            <comment id="17546739" author="dcapwell" created="Fri, 3 Jun 2022 19:21:28 +0000"  >&lt;p&gt;To repo the original issue, apply the following patch&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/test/distributed/org/apache/cassandra/distributed/test/thresholds/TombstoneCountWarningTest.java b/test/distributed/org/apache/cassandra/distributed/test/thresholds/TombstoneCountWarningTest.java
index a5ebee9cb9..e5c20ea789 100644
--- a/test/distributed/org/apache/cassandra/distributed/test/thresholds/TombstoneCountWarningTest.java
+++ b/test/distributed/org/apache/cassandra/distributed/test/thresholds/TombstoneCountWarningTest.java
@@ -26,6 +26,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Arrays;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.Collections;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.List;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.CompletableFuture;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.TimeUnit;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.function.Consumer;
 
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.google.common.collect.ImmutableSet;
@@ -373,8 +374,8 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TombstoneCountWarningTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TestBaseImpl
         &lt;span class=&quot;code-comment&quot;&gt;// called on main thread
&lt;/span&gt;         &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void blockFor(InetSocketAddress address)
         {
-            blockFor = address;
-            promise = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompletableFuture&amp;lt;&amp;gt;();
+&lt;span class=&quot;code-comment&quot;&gt;//            blockFor = address;
&lt;/span&gt;+&lt;span class=&quot;code-comment&quot;&gt;//            promise = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompletableFuture&amp;lt;&amp;gt;();
&lt;/span&gt;         }
 
         &lt;span class=&quot;code-comment&quot;&gt;// called in C* threads; non-test threads
&lt;/span&gt;@@ -423,7 +424,9 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TombstoneCountWarningTest &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TestBaseImpl
 
         &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void onFailure(InetAddressAndPort from, RequestFailureReason failureReason, @SuperCall &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt; zuper) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
         {
-            State.onFailure(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InetSocketAddress(from.getAddress(), from.getPort()));
+            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (from.getAddress().getHostAddress().equals(&lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;))
+                TimeUnit.MINUTES.sleep(10);
+&lt;span class=&quot;code-comment&quot;&gt;//            State.onFailure(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InetSocketAddress(from.getAddress(), from.getPort()));
&lt;/span&gt;             zuper.run();
         }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17546760" author="maedhroz" created="Fri, 3 Jun 2022 19:26:08 +0000"  >&lt;p&gt;+1 (just left a couple nits)&lt;/p&gt;</comment>
                            <comment id="17547053" author="dcapwell" created="Fri, 3 Jun 2022 21:05:23 +0000"  >&lt;p&gt;fixed all nits and made sure driver also blocks on node1 to be stable&lt;/p&gt;</comment>
                            <comment id="17547056" author="dcapwell" created="Fri, 3 Jun 2022 21:05:45 +0000"  >&lt;p&gt;working on 4.1 patch now&lt;/p&gt;</comment>
                            <comment id="17547204" author="dcapwell" created="Fri, 3 Jun 2022 21:51:14 +0000"  >&lt;p&gt;Starting commit&lt;/p&gt;

&lt;p&gt;CI Results (pending):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-4.1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-17244-cassandra-4.1-B6879A2D-E808-4ECA-9A66-7C798F87CD2B&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-17244-cassandra-4.1-B6879A2D-E808-4ECA-9A66-7C798F87CD2B&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/1758/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-17244-trunk-B6879A2D-E808-4ECA-9A66-7C798F87CD2B&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-17244-trunk-B6879A2D-E808-4ECA-9A66-7C798F87CD2B&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/1759/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 23 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ydww:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348835">NA</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/d3ce825bf2b376fd2516e4b594ddb69037c13159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/d3ce825bf2b376fd2516e4b594ddb69037c13159&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;ran multiple times&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>