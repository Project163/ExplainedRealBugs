<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:20:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16581] Failure to execute queries should emit a KPI other than read timeout/unavailable so it can be alerted/tracked</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16581</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When we are unable to parse a message we do not have a way to detect this from a monitoring point of view so can get into situations where we believe the database is fine but the clients are on-fire.  This case popped up in the 2.1 to 3.0 upgrade as paging state wasn&#8217;t mixed-mode safe.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13370493">CASSANDRA-16581</key>
            <summary>Failure to execute queries should emit a KPI other than read timeout/unavailable so it can be alerted/tracked</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dcapwell">David Capwell</assignee>
                                    <reporter username="dcapwell">David Capwell</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Apr 2021 22:15:20 +0000</created>
                <updated>Fri, 4 Jun 2021 11:01:07 +0000</updated>
                            <resolved>Wed, 2 Jun 2021 03:56:01 +0000</resolved>
                                        <fixVersion>3.0.25</fixVersion>
                    <fixVersion>3.11.11</fixVersion>
                    <fixVersion>4.0-rc2</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Messaging/Client</component>
                    <component>Observability/Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="17317530" author="dcapwell" created="Thu, 8 Apr 2021 22:38:16 +0000"  >&lt;p&gt;Removed comment about upgrading to 4.0 as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15193&quot; title=&quot;Add ability to cap max negotiable protocol version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15193&quot;&gt;&lt;del&gt;CASSANDRA-15193&lt;/del&gt;&lt;/a&gt; fixed it in 3.0.19 (tested in version without that patch)&lt;/p&gt;</comment>
                            <comment id="17318159" author="dcapwell" created="Fri, 9 Apr 2021 17:24:14 +0000"  >&lt;p&gt;Spoke with Sam and we need to review a few things first:&lt;/p&gt;

&lt;p&gt;1) ProtocolException doesn&apos;t distinguish between a simple user error (bad CL), and corrupt message (the test added has frame version v84... which doesn&apos;t exist).  Reconnects are not free, so this lack of clarity on the exception can be problematic when closing the socket; this problem exists cross 3.x and 4.x lines&lt;br/&gt;
2) v5 protocol can have multiple streams on the same frame, and client might not be able to map stream to frame, so a frame level issue (such as checkpointing) can become a problem; this problem is localized to 4.x&lt;/p&gt;</comment>
                            <comment id="17333301" author="beobal" created="Tue, 27 Apr 2021 14:37:31 +0000"  >&lt;p&gt;Currently, catching a &lt;tt&gt;ProtocolException&lt;/tt&gt; in by the pipeline&apos;s exception handler is supposed to close the channel, forcing the client to reconnect. For v5, this is &lt;tt&gt;o.a.c.t.ExceptionHandlers.ExceptionHandler&lt;/tt&gt; and for v4 and lower, &lt;tt&gt;o.a.c.t.PreV5Handlers.ExceptionHandler&lt;/tt&gt; in trunk and &lt;tt&gt;o.a.c.t.Message.ExceptionHandler&lt;/tt&gt; in prior versions. ) &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// On protocol exception, close the channel as soon as the message have been sent
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cause &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ProtocolException)
    &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt;.addListener((ChannelFutureListener) f -&amp;gt; ctx.close());

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, many if not most instances of &lt;tt&gt;ProtocolException&lt;/tt&gt; are actually contained in a &lt;tt&gt;WrappedException&lt;/tt&gt; at this point, so not many actually trigger this condition. This is changed by David&apos;s patches, but we spoke offline and agreed that this should be reverted for v4- in 3.0, 3.11 and trunk as reconnections can be expensive, especially on the server side when auth is enabled. &lt;/p&gt;

&lt;p&gt;As David mentioned, this is also a slightly more tricky in v5 as a frame can contain envelopes for multiple streams. In the case of a fatal error (one which renders the entire frame unusable), the server is not able to notify the client of the stream ids present in the frame. To avoid causing a wave of client side timeouts, we decided to fail fast and close the client connection if any protocol error is detected.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;From a client point of view, a dropped frame will result in request timeouts. We have no way of providing a better error, since the stream ids of the failed requests are in the corrupt payload. I&apos;m wondering if it might not be better to drop the connection all the time: at least the client gets immediate feedback (we could try to propagate a cause), instead of a bunch of requests timing out for no apparent reason.&lt;br/&gt;
 &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15299?focusedCommentId=17099447&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17099447&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;1&lt;/a&gt;. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;However, many protocol errors are not fatal; examples include invalid consistency levels, illegal statements in a BATCH, incorrect opcode. In these cases, the server &lt;em&gt;may&lt;/em&gt; be able to respond appropriately to the invalid envelope and continue processing the remainder of the frame.  &lt;/p&gt;

&lt;p&gt;I&apos;ve pushed a couple of v5 specific commits &lt;a href=&quot;https://github.com/beobal/cassandra/tree/16581-trunk-v5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. The general idea is to attempt to differentiate between so-called protocol errors from which the server can recover and those from which it can&apos;t. With this in mind, the message processor will return an error response the first time it encountered a protocol exception, but only terminate the connection if it immediately encounters a second error on the very next envelope in the frame. The reason for failing only on consecutive errors is that any individual error may be recoverable. For instance, a client could send a Frame with 100 envelopes and every other one might have some recoverable corruption. A run of consecutive errors in the same frame is a heuristic for identifying non-recoverable corruption, and while not perfect, it seems fairly reasonable to me. &lt;/p&gt;

&lt;p&gt;An exception to this rule is if the body length advertised in the envelope header is invalid (i.e. &amp;lt; 0). In this case, the message processor is unable to even attempt to skip over the message, so it throws and closes the connection immediately.&lt;/p&gt;</comment>
                            <comment id="17338688" author="dcapwell" created="Mon, 3 May 2021 23:57:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt; merged in your patch and made the &amp;lt;= v4 logic to do the same as before (error instanceOf ProtocolException) as we don&apos;t know if its a recoverable error or not in &amp;lt;= v4&lt;/p&gt;

&lt;p&gt;Tests are passing (sending patch, the trunk fork broke a test)&lt;/p&gt;</comment>
                            <comment id="17344794" author="dcapwell" created="Fri, 14 May 2021 17:58:55 +0000"  >&lt;p&gt;the python details are failing now that we no longer fall back to highest supported protocol version when an unknown protocol version is seen...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Unexpected error found in node logs (see stdout &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; full details). Errors: [WARN  [epollEventLoopGroup-5-5] 2021-05-14 16:59:18,418 NoSpamLogger.java:95 - Protocol exception with client networking: org.apache.cassandra.transport.ProtocolException: Invalid or unsupported protocol version (66); supported versions are (3/v3, 4/v4, 5/v5, 6/v6-beta), WARN  [epollEventLoopGroup-5-6] 2021-05-14 16:59:18,418 NoSpamLogger.java:95 - Protocol exception with client networking: org.apache.cassandra.transport.ProtocolException: Invalid or unsupported protocol version (65); supported versions are (3/v3, 4/v4, 5/v5, 6/v6-beta), WARN  [epollEventLoopGroup-5-5] 2021-05-14 16:59:18,418 NoSpamLogger.java:95 - Protocol exception with client networking: org.apache.cassandra.transport.ProtocolException: Invalid or unsupported protocol version (66); supported versions are (3/v3, 4/v4, 5/v5, 6/v6-beta)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can replicate this when the following is done&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ ./bin/cqlsh
Connected to Test Cluster at 127.0.0.1:9042
[cqlsh 6.0.0 | Cassandra 4.1-SNAPSHOT | CQL spec 3.4.5 | Native protocol v5]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN  [nioEventLoopGroup-5-10] 2021-05-14 10:56:18,366 NoSpamLogger.java:95 - Protocol exception with client networking: org.apache.cassandra.transport.ProtocolException: Invalid or unsupported protocol version (65); supported versions are (3/v3, 4/v4, 5/v5, 6/v6-beta)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but this doesn&apos;t happen when I specify a specific version&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
$ ./bin/cqlsh --protocol-version 1
Connection error: (&lt;span class=&quot;code-quote&quot;&gt;&apos;Unable to connect to any servers&apos;&lt;/span&gt;, {&lt;span class=&quot;code-quote&quot;&gt;&apos;127.0.0.1:9042&apos;&lt;/span&gt;: DriverException(&lt;span class=&quot;code-quote&quot;&gt;&apos;ProtocolError returned from server &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; using explicitly set client protocol_version 1&apos;&lt;/span&gt;)})
$ ./bin/cqlsh --protocol-version 2
Connection error: (&lt;span class=&quot;code-quote&quot;&gt;&apos;Unable to connect to any servers&apos;&lt;/span&gt;, {&lt;span class=&quot;code-quote&quot;&gt;&apos;127.0.0.1:9042&apos;&lt;/span&gt;: DriverException(&lt;span class=&quot;code-quote&quot;&gt;&apos;ProtocolError returned from server &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; using explicitly set client protocol_version 2&apos;&lt;/span&gt;)})
$ ./bin/cqlsh --protocol-version 3
Connected to Test Cluster at 127.0.0.1:9042
[cqlsh 6.0.0 | Cassandra 4.1-SNAPSHOT | CQL spec 3.4.5 | Native protocol v3]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt;
$ ./bin/cqlsh --protocol-version 4
Connected to Test Cluster at 127.0.0.1:9042
[cqlsh 6.0.0 | Cassandra 4.1-SNAPSHOT | CQL spec 3.4.5 | Native protocol v4]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt;
$ ./bin/cqlsh --protocol-version 5
Connected to Test Cluster at 127.0.0.1:9042
[cqlsh 6.0.0 | Cassandra 4.1-SNAPSHOT | CQL spec 3.4.5 | Native protocol v5]
Use HELP &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; help.
cqlsh&amp;gt;
$ ./bin/cqlsh --protocol-version 6
Connection error: (&lt;span class=&quot;code-quote&quot;&gt;&apos;Unable to connect to any servers&apos;&lt;/span&gt;, {&lt;span class=&quot;code-quote&quot;&gt;&apos;127.0.0.1:9042&apos;&lt;/span&gt;: &amp;lt;Error from server: code=000a [Protocol error] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;Beta version of the protocol used (6/v6-beta), but USE_BETA flag is unset&quot;&lt;/span&gt;&amp;gt;})
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN  [nioEventLoopGroup-5-13] 2021-05-14 10:57:27,019 NoSpamLogger.java:95 - Protocol exception with client networking: org.apache.cassandra.transport.ProtocolException: Invalid or unsupported protocol version (1); supported versions are (3/v3, 4/v4, 5/v5, 6/v6-beta)
WARN  [nioEventLoopGroup-5-14] 2021-05-14 10:57:30,967 NoSpamLogger.java:95 - Protocol exception with client networking: org.apache.cassandra.transport.ProtocolException: Invalid or unsupported protocol version (2); supported versions are (3/v3, 4/v4, 5/v5, 6/v6-beta)
WARN  [nioEventLoopGroup-5-21] 2021-05-14 10:57:42,520 NoSpamLogger.java:95 - Protocol exception with client networking: org.apache.cassandra.transport.ProtocolException: Beta version of the protocol used (6/v6-beta), but USE_BETA flag is unset
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17344800" author="dcapwell" created="Fri, 14 May 2021 18:08:32 +0000"  >&lt;p&gt;What I see is org.apache.cassandra.transport.InitialConnectionHandler#decode gets &quot;firstByte&quot; to be 66, and applying the PROTOCOL_VERSION_MASK doesn&apos;t change the value.&lt;/p&gt;

&lt;p&gt;When I run &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./bin/cqlsh --protocol-version 4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;the first byte is 4 and versionNum is also 4 (the same is true with --protocol-version 3, but first byte is 3)&lt;/p&gt;

&lt;p&gt;This looks like cqlsh is missing this?&lt;/p&gt;</comment>
                            <comment id="17344804" author="dcapwell" created="Fri, 14 May 2021 18:14:32 +0000"  >&lt;p&gt;testing java&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (Cluster cluster = Cluster.builder().addContactPoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;).withoutJMXReporting().build();
             Session session = cluster.newSession())
        {
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Row row : session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;select * from system.local&quot;&lt;/span&gt;))
            {
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(row);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I see that the first byte is 5 and works as expected without any logs&lt;/p&gt;</comment>
                            <comment id="17344806" author="dcapwell" created="Fri, 14 May 2021 18:17:59 +0000"  >&lt;p&gt;What I see is the first message is 65 or 66 (changes some times) and that after our error is sent back the client resends with v5 and the connection moves forward just fine.&lt;/p&gt;</comment>
                            <comment id="17344811" author="dcapwell" created="Fri, 14 May 2021 18:22:43 +0000"  >&lt;p&gt;Found the root cause &lt;a href=&quot;https://github.com/datastax/python-driver/blob/15d715f4e686032b02ce785eca1d176d2b25e32b/cassandra/cluster.py#L614&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/datastax/python-driver/blob/15d715f4e686032b02ce785eca1d176d2b25e32b/cassandra/cluster.py#L614&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The default version tried is ProtocolVersion.DSE_V2, then falls back to V1&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    DSE_V1 = 0x41
    &quot;&quot;&quot;
    DSE &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; protocol v1, supported in DSE 5.1+
    &quot;&quot;&quot;

    DSE_V2 = 0x42
    &quot;&quot;&quot;
    DSE &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; protocol v2, supported in DSE 6.0+
    &quot;&quot;&quot;

    SUPPORTED_VERSIONS = (DSE_V2, DSE_V1, V6, V5, V4, V3, V2, V1)
    &quot;&quot;&quot;
    A tuple of all supported protocol versions
    &quot;&quot;&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;0x42 = 66, 0x41 = 65&lt;/p&gt;</comment>
                            <comment id="17344865" author="dcapwell" created="Fri, 14 May 2021 20:30:49 +0000"  >&lt;p&gt;Looking into this and talking to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aholmber&quot; class=&quot;user-hover&quot; rel=&quot;aholmber&quot;&gt;aholmber&lt;/a&gt; it turns out Server can not reply back with a preferred version(s), instead client keeps trying but &quot;downgrades&quot; the version to the next in a list... for this reason there isn&apos;t something I can really do to avoid this other than avoid logging when the version is DSE. &lt;/p&gt;

&lt;p&gt;Given that adding a &quot;handshake&quot; is out of scope (and too late at this point of a release) the only solution I can think of is to avoid logging in these cases.&lt;/p&gt;</comment>
                            <comment id="17344902" author="dcapwell" created="Fri, 14 May 2021 22:06:32 +0000"  >&lt;p&gt;tests are passing, but seems our SSL tests are failing as the &quot;unknown&quot; log added is showing the following&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: javax.net.ssl.SSLHandshakeException: error:100000f7:SSL routines:OPENSSL_internal:WRONG_VERSION_NUMBER
	at io.netty.handler.ssl.ReferenceCountedOpenSslEngine.sslReadErrorResult(ReferenceCountedOpenSslEngine.java:1309)
	at io.netty.handler.ssl.ReferenceCountedOpenSslEngine.unwrap(ReferenceCountedOpenSslEngine.java:1270)
	at io.netty.handler.ssl.ReferenceCountedOpenSslEngine.unwrap(ReferenceCountedOpenSslEngine.java:1346)
	at io.netty.handler.ssl.ReferenceCountedOpenSslEngine.unwrap(ReferenceCountedOpenSslEngine.java:1389)
	at io.netty.handler.ssl.SslHandler$SslEngineType$1.unwrap(SslHandler.java:206)
	at io.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1387)
	at io.netty.handler.ssl.SslHandler.decodeNonJdkCompatible(SslHandler.java:1294)
	at io.netty.handler.ssl.SslHandler.decode(SslHandler.java:1331)
	at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:508)
	at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:447)
	... 15 common frames omitted]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17344909" author="dcapwell" created="Fri, 14 May 2021 22:55:03 +0000"  >&lt;p&gt;added patch for python dtest to ignore those errors&lt;/p&gt;</comment>
                            <comment id="17344927" author="dcapwell" created="Sat, 15 May 2021 00:12:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt; tests are stable now with the latest commit and python dtest changes; will work on back porting the changes&lt;/p&gt;</comment>
                            <comment id="17347638" author="beobal" created="Wed, 19 May 2021 12:35:46 +0000"  >&lt;p&gt;Thanks, looks good to me except for a couple of minor things.&lt;/p&gt;


&lt;h3&gt;&lt;a name=&quot;ProtocolVersion&quot;&gt;&lt;/a&gt;ProtocolVersion&lt;/h3&gt;

&lt;p&gt;I&apos;d suggest renaming &lt;tt&gt;DSE_VERSIONS&lt;/tt&gt; to something like &lt;tt&gt;KNOWN_INVALID_VERSIONS&lt;/tt&gt;&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;FrameEncoder&quot;&gt;&lt;/a&gt;FrameEncoder&lt;/h3&gt;

&lt;p&gt;This change seems wrong, if we receive anything other than a &lt;tt&gt;Payload&lt;/tt&gt; here, it&apos;s an error. Is this some leftover debugging perhaps? &lt;/p&gt;</comment>
                            <comment id="17347867" author="dcapwell" created="Wed, 19 May 2021 20:57:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;FrameEncoder change is&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void write(ChannelHandlerContext ctx, &lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; msg, ChannelPromise promise) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception
     {
         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(msg &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; Payload))
-            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalStateException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected type: &quot;&lt;/span&gt; + msg);
+        {
+            ctx.write(msg, promise);
+            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
+        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This isn&apos;t a leftover from debugging, its from the fact that we no longer support it as the v5 logic uses the more lower level APIs (such as ChannelInboundHandlerAdapter); the higher level APIs pass through objects which do not match the type.  Here is an example from v4 &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;ProtocolEncoder &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; MessageToMessageEncoder&amp;lt;Message&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;MessageToMessageEncoder has the following &lt;a href=&quot;https://github.com/netty/netty/blob/4.1/codec/src/main/java/io/netty/handler/codec/MessageToMessageEncoder.java#L84-L100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/blob/4.1/codec/src/main/java/io/netty/handler/codec/MessageToMessageEncoder.java#L84-L100&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (acceptOutboundMessage(msg)) {
                ...
            } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; {
                ctx.write(msg, promise);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I use this in the simple client to send arbitrary payloads to validate server behavior.&lt;/p&gt;

&lt;p&gt;ProtocolVersion - made the change&lt;/p&gt;</comment>
                            <comment id="17348687" author="beobal" created="Thu, 20 May 2021 18:47:30 +0000"  >&lt;p&gt;Oh, I totally missed that in &lt;tt&gt;SimpleClient&lt;/tt&gt;, sorry. In that case, I definitely think we need to revisit how the test is&lt;br/&gt;
 implemented. That assertion in &lt;tt&gt;FrameEncoder&lt;/tt&gt; is important, not only for the client protocol, but for internode which&lt;br/&gt;
 shares the class.&lt;/p&gt;

&lt;p&gt;There&apos;s quite a lot of machinery in &lt;tt&gt;CQLConnectionTest&lt;/tt&gt; to give control over the exact bytes that the v5 pipeline&lt;br/&gt;
 classes have to deal with. Unfortunately, retro fitting that to support v4 and earlier is not a trivial task. I&apos;ve&lt;br/&gt;
 pushed an alternative reworking of the test &lt;a href=&quot;https://github.com/beobal/cassandra/tree/CASSANDRA-16581-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Instead of changing the encoders/decoders this adds a test implementation of &lt;tt&gt;Message.Request&lt;/tt&gt; which we can prime with some garbage bytes, so that when it&apos;s decoded, a &lt;tt&gt;ProtocolError&lt;/tt&gt; is guaranteed. This required a tiny bit of refactoring in &lt;tt&gt;Envelope&lt;/tt&gt; to make the v4 encoding&#160;ask-dont-tell like v5, but it gives the test code control over the actual bytes that get decoded on the server rather&#160;than having to bypass the checks in the outbound pipeline.&lt;/p&gt;

&lt;p&gt;A nice side effect of this is that the v5 test is now exercising the CQL protocol decoding, rather than hitting the CRC&lt;br/&gt;
 errors in the framing layer. There are quite a few tests in &lt;tt&gt;CQLConnectionTest&lt;/tt&gt; which do verify that, so we should be&lt;br/&gt;
 good there. This also means that the channel-closing behaviour is the same between the v4 &amp;amp; v5 tests.&lt;/p&gt;

&lt;p&gt;Now the message pipelines and failure behaviours are aligned across versions, we don&apos;t need &lt;tt&gt;WrappedSimpleClient&lt;/tt&gt; any&lt;br/&gt;
 more and because the test cases are identical, I&apos;ve made the test &lt;tt&gt;@Parameterized&lt;/tt&gt; so it will automatically cover all&lt;br/&gt;
 supported versions.&lt;/p&gt;</comment>
                            <comment id="17348842" author="dcapwell" created="Fri, 21 May 2021 00:08:29 +0000"  >&lt;p&gt;thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt;, I changed to use your patch on trunk (after review is done will backport to 4.0); for the 3.x line I left things alone.&lt;/p&gt;

&lt;p&gt;Given this new framework, I now updated to add a second test; one which corrupts the body.&lt;/p&gt;</comment>
                            <comment id="17355045" author="beobal" created="Tue, 1 Jun 2021 11:45:11 +0000"  >&lt;p&gt;sorry for the holdup, the trunk fix LGTM now except that the change to &lt;tt&gt;FrameEncoder::write&lt;/tt&gt; hasn&apos;t been reverted yet. Aside from that, I think this good to go once the 4.0 branch is updated. Thanks!&lt;/p&gt;</comment>
                            <comment id="17355355" author="dcapwell" created="Tue, 1 Jun 2021 22:27:05 +0000"  >&lt;p&gt;Starting commit&lt;/p&gt;

&lt;p&gt;CI Results (pending):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-3.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-16581-cassandra-3.0-BF76A26D-BA05-43FF-A67E-0330068556C3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-16581-cassandra-3.0-BF76A26D-BA05-43FF-A67E-0330068556C3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/833/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-3.11&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-16581-cassandra-3.11-BF76A26D-BA05-43FF-A67E-0330068556C3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-16581-cassandra-3.11-BF76A26D-BA05-43FF-A67E-0330068556C3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/834/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-4.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-16581-cassandra-4.0-BF76A26D-BA05-43FF-A67E-0330068556C3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-16581-cassandra-4.0-BF76A26D-BA05-43FF-A67E-0330068556C3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/835/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-16581-trunk-BF76A26D-BA05-43FF-A67E-0330068556C3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-16581-trunk-BF76A26D-BA05-43FF-A67E-0330068556C3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/836/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17355407" author="dcapwell" created="Tue, 1 Jun 2021 23:38:38 +0000"  >&lt;p&gt;4.x is stable, but 3.x python dtests are failing; looking into them.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12994" cascade-level="1"><![CDATA[Unavailable]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 23 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0pots:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348835">NA</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/9c50b1f9a12a95b55851cc52d4b66440f9fafaea&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/9c50b1f9a12a95b55851cc52d4b66440f9fafaea&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;added tests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>