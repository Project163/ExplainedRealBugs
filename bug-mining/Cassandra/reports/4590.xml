<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:05:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12909] cqlsh copy cannot parse strings when counters are present</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12909</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We get parse error &lt;tt&gt;Failed to import 1 rows: ParseError - argument for &apos;s&apos; must be a string&lt;/tt&gt; when using the following table and data:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE ks.test (
    object_id ascii,
    user_id timeuuid,
    counter_id ascii,
    count counter,
    PRIMARY KEY ((object_id, user_id), counter_id)
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;EVT:be3bd2d0-a68d-11e6-90d4-1b2a65b8a28a,f7ce3ac0-a66e-11e6-b58e-4e29450fd577,SA,2
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is this line &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/pylib/cqlshlib/copyutil.py#L2114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, strings are serialized as unicode rather than ordinary strings but only for non-prepared statements (unsure why).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13020392">CASSANDRA-12909</key>
            <summary>cqlsh copy cannot parse strings when counters are present</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="stefania">Stefania Alborghetti</reporter>
                        <labels>
                    </labels>
                <created>Mon, 14 Nov 2016 01:18:52 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:15 +0000</updated>
                            <resolved>Thu, 22 Dec 2016 03:35:27 +0000</resolved>
                                        <fixVersion>2.2.9</fixVersion>
                    <fixVersion>3.0.11</fixVersion>
                    <fixVersion>3.10</fixVersion>
                                    <component>Legacy/Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15662472" author="stefania" created="Mon, 14 Nov 2016 01:26:19 +0000"  >&lt;p&gt;This fixes it but I still don&apos;t understand why we don&apos;t already have a UTF-8 encoded string, and why this only happens with non-prepared statements, given that the converters are identical:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...stef1927:12909-cqlsh-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12909-cqlsh-3.0-cqlsh-tests/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15672957" author="stefania" created="Thu, 17 Nov 2016 06:47:46 +0000"  >&lt;p&gt;What&apos;s happening is that when we &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/pylib/cqlshlib/copyutil.py#L1822&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;protect values&lt;/a&gt; for non-prepared statements, we convert strings to Unicode and neither our &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/pylib/cqlshlib/copyutil.py#L1867&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;converter&lt;/a&gt;, nor the &lt;a href=&quot;https://github.com/datastax/python-driver/blob/master/cassandra/cqltypes.py#L425&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;python driver when using python version 2&lt;/a&gt;, convert them back to ascii.&lt;/p&gt;

&lt;p&gt;Then as we know, &lt;a href=&quot;https://bugs.python.org/issue10783&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;python 2 won&apos;t pack unicode strings&lt;/a&gt;, so they must be encoded first.&lt;/p&gt;

&lt;p&gt;I&apos;ve fixed it by introducing an ascii specific converter.  &lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.X&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/tree/12909-cqlsh-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/tree/12909-cqlsh-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/tree/12909-cqlsh-3.X&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/tree/12909-cqlsh&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12909-cqlsh-2.2-cqlsh-tests/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12909-cqlsh-3.0-cqlsh-tests/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12909-cqlsh-3.X-cqlsh-tests/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12909-cqlsh-cqlsh-tests/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The new test is &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1393&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15744364" author="stefania" created="Tue, 13 Dec 2016 06:44:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;, gentle ping.&lt;/p&gt;</comment>
                            <comment id="15760896" author="blerer" created="Mon, 19 Dec 2016 11:16:25 +0000"  >&lt;p&gt;It is not clear to me why we call &lt;tt&gt;unicode&lt;/tt&gt; in &lt;tt&gt;_get_protector&lt;/tt&gt;. It seems to me that it should have been called in the converters instead.&lt;br/&gt;
What do you think?  &lt;/p&gt;</comment>
                            <comment id="15763053" author="stefania" created="Tue, 20 Dec 2016 03:02:29 +0000"  >&lt;p&gt;Protectors are used more widely than converters for non-prepared statements, converters are only applied to partition keys to determine the routing, protectors to all values.&lt;/p&gt;

&lt;p&gt;The call to &lt;tt&gt;unicode&lt;/tt&gt; in &lt;tt&gt;_get_protector&lt;/tt&gt; was added by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11850&quot; title=&quot;cannot use cql since upgrading python to 2.7.11+&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11850&quot;&gt;&lt;del&gt;CASSANDRA-11850&lt;/del&gt;&lt;/a&gt; when we upgraded the driver to 3.5. Five tests were failing with Unicode conversion problems without it, but I cannot recall which ones and the original test results for 11850 have been deleted. So I don&apos;t know if the call to &lt;tt&gt;unicode&lt;/tt&gt; can be moved to the converters. I am repeating the tests for the 2.2 patch above without a &lt;tt&gt;unicode&lt;/tt&gt; call in the protectors.  &lt;/p&gt;
</comment>
                            <comment id="15763382" author="stefania" created="Tue, 20 Dec 2016 06:16:00 +0000"  >&lt;p&gt;This is a sample &lt;a href=&quot;http://cassci.datastax.com/job/stef1927-12909-cqlsh-2.2-cqlsh-tests/cython=no,label=ctool-lab/2/testReport/junit/junit/cqlsh_tests.cqlsh_copy_tests/CqlshCopyTest/test_all_datatypes_round_trip/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failure&lt;/a&gt; that we get without calling &lt;tt&gt;unicode&lt;/tt&gt; in the protectors. The problem is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Traceback (most recent call last):
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/home/automaton/cassandra/bin/../pylib/cqlshlib/copyutil.py&quot;&lt;/span&gt;, line 2262, in make_statement
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; inner_make_statement(query, conv, batch, replicas)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/home/automaton/cassandra/bin/../pylib/cqlshlib/copyutil.py&quot;&lt;/span&gt;, line 2321, in make_non_prepared_batch_statement
    statement = SimpleStatement(query % (&lt;span class=&quot;code-quote&quot;&gt;&apos;,&apos;&lt;/span&gt;.join(batch[&lt;span class=&quot;code-quote&quot;&gt;&apos;rows&apos;&lt;/span&gt;][0]),), consistency_level=self.consistency_level)
UnicodeDecodeError: &lt;span class=&quot;code-quote&quot;&gt;&apos;ascii&apos;&lt;/span&gt; codec can&apos;t decode &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt; 0xe3 in position 114: ordinal not in range(128)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It fails to append arguments to the query string if they are not of type unicode. The query is of type unicode because it is created by concatenating the query text to the the column names, which are unicode types. Column names are wrapped by a call to protect_name, older versions of the driver were converting unicode column names to utf-8, whilst now protect_name no longer encodes strings to utf-8. Therefore, in order to avoid converting values to unicode, we can equivalently encode the query text into utf-8. This shouldn&apos;t be too risky since it was the behavior prior to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11850&quot; title=&quot;cannot use cql since upgrading python to 2.7.11+&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11850&quot;&gt;&lt;del&gt;CASSANDRA-11850&lt;/del&gt;&lt;/a&gt;. It is also probably a little bit more efficient, in addition to avoiding the special casing for ascii types. I only modified the 2.2 &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...stef1927:12909-cqlsh-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;, let me know if you agree with this new approach &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;CI for 2.2 is pending.&lt;/p&gt;</comment>
                            <comment id="15766296" author="stefania" created="Wed, 21 Dec 2016 06:48:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;Therefore, in order to avoid converting values to unicode, we can equivalently encode the query text into utf-8.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ve changed it again so that we encode the column names rather than the query, this covers one more failure that I found today with a new &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1393/files#diff-2d1d32d5724e8f118d09beb660163899R3124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test case&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Only the 2.2 patch is up-tp-date and CI for 2.2 is pending. I&apos;m waiting for another review before updating the remaining branches.&lt;/p&gt;</comment>
                            <comment id="15766442" author="blerer" created="Wed, 21 Dec 2016 08:16:57 +0000"  >&lt;p&gt;The new patch looks good to me. Thanks.&lt;/p&gt;</comment>
                            <comment id="15768709" author="stefania" created="Thu, 22 Dec 2016 01:37:01 +0000"  >&lt;p&gt;Thanks for the review. I&apos;ve updated the remaining branches and I am currently running CI on them. &lt;/p&gt;</comment>
                            <comment id="15768907" author="stefania" created="Thu, 22 Dec 2016 03:35:05 +0000"  >&lt;p&gt;CI looks good. The &lt;a href=&quot;http://cassci.datastax.com/job/stef1927-12909-cqlsh-cqlsh-tests/lastCompletedBuild/cython=yes,label=ctool-lab/testReport/cqlsh_tests.cqlsh_copy_tests/CqlshCopyTest/test_copy_from_with_wrong_order_or_missing_UDT_fields/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failed test&lt;/a&gt; on trunk is the new test added for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12959&quot; title=&quot;copy from csv import wrong values with udt having set when fields are not specified in correct order in csv&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12959&quot;&gt;&lt;del&gt;CASSANDRA-12959&lt;/del&gt;&lt;/a&gt;, which is expected to fail since I did not rebase the patch branch. I verified that it passes locally.&lt;/p&gt;

&lt;p&gt;Committed to 2.2 as f4fd0928e6bc56600b7fd4d2469353c8f9d9da7d and merged upwards.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 47 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i369rz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>