<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8429] Some keys unreadable during compaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8429</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Starts as part of merge commit 25be46497a8df46f05ffa102bc645bfd684ea48a&lt;/p&gt;

&lt;p&gt;Stress will say that a key wasn&apos;t validated because it isn&apos;t returned even though it&apos;s loaded. The key will eventually appear and can be queried using cqlsh.&lt;/p&gt;

&lt;p&gt;Reproduce with&lt;br/&gt;
#!/bin/sh&lt;br/&gt;
ROWCOUNT=10000000&lt;br/&gt;
SCHEMA=&apos;-col n=fixed(1) -schema compaction(strategy=LeveledCompactionStrategy) compression=LZ4Compressor&apos;&lt;br/&gt;
./cassandra-stress write n=$ROWCOUNT -node xh61 -pop seq=1..$ROWCOUNT no-wrap -rate threads=25 $SCHEMA&lt;br/&gt;
./cassandra-stress mixed &quot;ratio(read=2)&quot; n=100000000 -node xh61 -pop &quot;dist=extreme(1..$ROWCOUNT,0.6)&quot; -rate threads=25 $SCHEMA&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Ubuntu 14.04&lt;/p&gt;</environment>
        <key id="12759720">CASSANDRA-8429</key>
            <summary>Some keys unreadable during compaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="aweisberg">Ariel Weisberg</reporter>
                        <labels>
                    </labels>
                <created>Fri, 5 Dec 2014 16:47:16 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:26 +0000</updated>
                            <resolved>Fri, 19 Dec 2014 14:48:49 +0000</resolved>
                                        <fixVersion>2.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14236997" author="aweisberg" created="Sat, 6 Dec 2014 23:10:05 +0000"  >&lt;p&gt;Ok... bisecting off of trunk points to 9c316e7858f6dbf9df892aff78431044aa104ed9&lt;/p&gt;

&lt;p&gt;I am ran the commit before e60a06cc866e5e85d3e58f25b98f8c048d07ad24 to make sure it doesn&apos;t fail. It usually fails in two tries. I have done four and it seems to work.&lt;/p&gt;

&lt;p&gt;Two others have tried to reproduce the issue and not had any luck. I seem to be doing something different to cause it. I am using CCM to start the one node cluster with the attached cluster.conf. Server is on Ubuntu 14.04 on a dedicated quad-core desktop with SSD, client is on a quad-core laptop, network is gig-E.&lt;/p&gt;</comment>
                            <comment id="14237899" author="aweisberg" created="Mon, 8 Dec 2014 14:23:13 +0000"  >&lt;p&gt;Looking at the problem commit it seems like LeveledCompaction might be part of the problem so here are the stress settings I used to get leveled compaction on the test table.&lt;/p&gt;</comment>
                            <comment id="14238355" author="krummas" created="Mon, 8 Dec 2014 19:45:32 +0000"  >&lt;p&gt;bad commit is indeed 9c316e7858f6dbf9df892aff78431044aa104ed9 - there is probably a race somewhere when we replace compacted sstables, will dig more&lt;/p&gt;</comment>
                            <comment id="14238459" author="krummas" created="Mon, 8 Dec 2014 21:01:27 +0000"  >&lt;p&gt;so, SSTW.openEarly() does not actually make all keys written to the writer available for reading, instead it finds the last key that is actually readable and sets that as SSTablereader.last, which was fine until &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8124&quot; title=&quot;Stopping a node during compaction can make already written files stay around&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8124&quot;&gt;&lt;del&gt;CASSANDRA-8124&lt;/del&gt;&lt;/a&gt; because we made actual files of the results before the compaction was done. We still only move starts to reader.last, but since we do that several times we create gaps in the range, making some keys unreadable until the compaction is done.&lt;/p&gt;

&lt;p&gt;We need to properly close the early opened file, but still keep it as a -tmp file&lt;/p&gt;</comment>
                            <comment id="14241076" author="krummas" created="Wed, 10 Dec 2014 13:23:39 +0000"  >&lt;p&gt;Branch for this here: &lt;a href=&quot;https://github.com/krummas/cassandra/commit/b23b7b3c2e5a800fefd86b0427dcffe3d1c7efb1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commit/b23b7b3c2e5a800fefd86b0427dcffe3d1c7efb1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Approach is to close the finished files (but keep them as .tmp), make tmplinks from those closed files and open sstablereaders over the tmplink files. Then, when we actually finish, we rename the tmp files to final files and open readers over those.&lt;/p&gt;</comment>
                            <comment id="14241079" author="krummas" created="Wed, 10 Dec 2014 13:26:04 +0000"  >&lt;p&gt;could you review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14249768" author="krummas" created="Wed, 17 Dec 2014 12:01:02 +0000"  >&lt;p&gt;oops, forgot to mark patch available&lt;/p&gt;</comment>
                            <comment id="14251911" author="benedict" created="Thu, 18 Dec 2014 17:14:39 +0000"  >&lt;p&gt;Apologies for the delay on this one. I&apos;ve had a bit of fun digging through it and, in the end, cleaning up some of the inadequate decisions I made first time around so that this code is hopefully easier for everyone to read and more obviously correct (I was having trouble convincing myself prior).&lt;/p&gt;

&lt;p&gt;Mostly I&apos;ve been trying to figure out what on earth was changed for this patch to introduce an infrequent but persistent problem with reference counts. However after reslicing the code I have tracked it down to an unrelated already present bug that I will file and fix separately, that was clearly just being made more likely with the change, timing-wise. The positive upshot, though, is that I have made the code this patch is based on quite a bit easier to read, and I hope more clearly correct as a result. I&apos;ve uploaded &lt;a href=&quot;https://github.com/belliottsmith/cassandra/commits/8429&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The patch is split into 5 commits:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Improves legibility by removing Pair and replacing with a bespoke class&lt;/li&gt;
	&lt;li&gt;Merges all of the new methods introduced in this (and related) patches to an enum flag provided to a single method (in each necessary class). Also fixes a minor memory leak introduced here for compression metadata.&lt;/li&gt;
	&lt;li&gt;Fixes an unrelated bug that was somehow being exercised here and preventing a clean run of unit tests&lt;/li&gt;
	&lt;li&gt;Refactors the abort() and finish() methods in SSTableRewriter to make them more legible and also make the cleanup more obviously correct. This is the only complex review to do, though it&apos;s not too bad:
	&lt;ul&gt;
		&lt;li&gt;The finishedEarly and finishedWriters collections are merged, and a special discard collection is introduced to take the place of the former &lt;em&gt;only&lt;/em&gt; when the sstable has a replacement. On closing a writer we immediately remove it from finishedEarly and move its most recent reader to discard.&lt;/li&gt;
		&lt;li&gt;The cleanup of discardable readers has been split out into a shared method used by both abort() and finish()&lt;/li&gt;
		&lt;li&gt;finish() and finishAndThrow() have been merged so that they&apos;re obviously the same&lt;/li&gt;
		&lt;li&gt;Instead of managing the Iterator ourselves, I&apos;ve wrapped it in an Iterator that removes as we progress, so the complex methods have less boilerplate&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Removes the use of sharesBfWith() as setReplacedBy() is both more correct and easier to reason about (sharesBfWith could result in a leak or a memory bug if sstables are released out of order), also fixes the deletion logic on cleanup that may explain why this wasn&apos;t used previously&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;We can probably split some of these commits into another ticket if you prefer, but I&apos;d feel most comfortable committing all of them together. I&apos;ve filed separate tickets for all of the other issues I came across while reviewing that are easily delayed or done separately.&lt;/p&gt;</comment>
                            <comment id="14253343" author="krummas" created="Fri, 19 Dec 2014 12:34:21 +0000"  >&lt;p&gt;LGTM, few nits;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Could you explain what is going on in CompressionMetadata#resetAndTruncate? (I guess it is to handle the refcounting, making sure we are the only one holding a ref to the memory, a comment explaining it would be nice)&lt;/li&gt;
	&lt;li&gt;Using a queue or a stack for popping stuff out of finishedEarly instead of the destroy(..)-thing would make it more obvious what is going on, without having to read the code in destroy(...)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14253347" author="krummas" created="Fri, 19 Dec 2014 12:34:45 +0000"  >&lt;p&gt;And ok with me to commit it all here, it is all related&lt;/p&gt;</comment>
                            <comment id="14253477" author="benedict" created="Fri, 19 Dec 2014 14:43:43 +0000"  >&lt;p&gt;Thanks. I&apos;ve committed with your second nit, and stripped out the code for the first as I shouldn&apos;t have included it in the first place. I was going to split it into a separate ticket, when I realised it&apos;s actually not a problem. We just need better commenting. What I was &lt;em&gt;worried&lt;/em&gt; about (whilst fixing the other issue in CMD) was a resetAndTruncate() call moving the needle back before a position we have early reopened. But this is ensured never to happen by the SSTableRewriter.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12685568" name="cluster.conf" size="459" author="aweisberg" created="Sat, 6 Dec 2014 23:11:00 +0000"/>
                            <attachment id="12685751" name="run_stress.sh" size="364" author="aweisberg" created="Mon, 8 Dec 2014 14:23:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i233tr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328841">2.1.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>