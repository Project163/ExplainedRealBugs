<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:34:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19564] MemtablePostFlush deadlock leads to stuck nodes and crashes</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19564</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;ve run into an issue on a 4.1.4 cluster where an entire node has locked up due to what I believe is a deadlock in memtable flushing. Here&apos;s what I know so far.&#160; I&apos;ve stitched together what happened based on conversations, logs, and some flame graphs.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Log reports memtable flushing&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;The last successful flush happens at 12:19.&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [NativePoolCleaner] 2024-04-16 12:19:53,634 AbstractAllocatorMemtable.java:286 - Flushing largest CFS(Keyspace=&apos;ks&apos;, ColumnFamily=&apos;version&apos;) to free up room. Used total: 0.24/0.33, live: 0.16/0.20, flushing: 0.09/0.13, this: 0.13/0.15
INFO  [NativePoolCleaner] 2024-04-16 12:19:53,634 ColumnFamilyStore.java:1012 - Enqueuing flush of ks.version, Reason: MEMTABLE_LIMIT, Usage: 660.521MiB (13%) on-heap, 790.606MiB (15%) off-heap
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;b&gt;MemtablePostFlush appears to be blocked&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;At this point, MemtablePostFlush completed tasks stops incrementing, active stays at 1 and pending starts to rise.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;MemtablePostFlush &#160;&#160;1 &#160;  1 &#160; 3446   0 &#160; 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
The flame graph reveals that PostFlush.call is stuck.&#160; I don&apos;t have the line number, but I know we&apos;re stuck in &lt;tt&gt;org.apache.cassandra.db.ColumnFamilyStore.PostFlush#call&lt;/tt&gt; given the visual below:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13068242/13068242_image-2024-04-16-13-43-11-064.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/b&gt;&lt;/p&gt;


&lt;p&gt;&lt;b&gt;Memtable flushing is now blocked.&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;All MemtableFlushWriter threads are Parked waiting on &lt;tt&gt;OpOrder.Barrier.await&lt;/tt&gt;. A wall clock profile of 30s reveals all time is spent here.&#160; Presumably we&apos;re waiting on the single threaded Post Flush.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13068243/13068243_image-2024-04-16-12-29-15-386.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Memtable allocations start to block&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Eventually it looks like the NativeAllocator stops successfully allocating memory. I assume it&apos;s waiting on memory to be freed, but since memtable flushes are blocked, we wait indefinitely.&lt;/p&gt;

&lt;p&gt;Looking at a wall clock flame graph, all writer threads have reached the allocation failure path of &lt;tt&gt;MemtableAllocator.allocate()&lt;/tt&gt;.&#160; I believe we&apos;re waiting on &lt;tt&gt;signal.awaitThrowUncheckedOnInterrupt()&lt;/tt&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; MutationStage&#160; &#160;&#160;48 &#160; &#160;828425 &#160; &#160; &#160;980253369 &#160; &#160;&#160; 0&#160; &#160; 0&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13068244/13068244_image-2024-04-16-11-55-54-750.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Compaction Stops&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Since we write to the compaction history table, and that requires memtables, compactions are now blocked as well.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13068241/13068241_image-2024-04-16-13-53-24-455.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The node is now doing basically nothing and must be restarted.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13576111">CASSANDRA-19564</key>
            <summary>MemtablePostFlush deadlock leads to stuck nodes and crashes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="curlylrt">Runtian Liu</assignee>
                                    <reporter username="rustyrazorblade">Jon Haddad</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Apr 2024 20:59:05 +0000</created>
                <updated>Wed, 29 Oct 2025 09:45:18 +0000</updated>
                            <resolved>Mon, 27 Oct 2025 09:06:50 +0000</resolved>
                                        <fixVersion>4.1.11</fixVersion>
                    <fixVersion>5.0.7</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Local/Compaction</component>
                    <component>Local/Memtable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>16</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7800">2h 10m</timespent>
                                <comments>
                            <comment id="17837889" author="brandon.williams" created="Tue, 16 Apr 2024 21:20:12 +0000"  >&lt;p&gt;Can you note which memtable_allocation_type was used and how many memtable_flush_writers?&lt;/p&gt;</comment>
                            <comment id="17837894" author="rustyrazorblade" created="Tue, 16 Apr 2024 21:35:10 +0000"  >
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;memtable_heap_space: 5120MiB
memtable_offheap_space: 5120MiB
memtable_allocation_type: offheap_objects
memtable_flush_writers: 4
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17838249" author="benedict" created="Wed, 17 Apr 2024 15:19:11 +0000"  >&lt;p&gt;Is the Flush that is blocked the one that the postFlush is waiting on? You can check this from a heap dump.&lt;/p&gt;

&lt;p&gt;If it is, the question is why the writeBarrier it has issued doesn&apos;t complete - any write that is behind such an issued barrier should be clear to complete without blocking. In which case we have perhaps introduced some new blocking mechanism that sits behind the completion of the barrier that depends on the barrier itself finishing. This should also be apparent from a heap dump, from which you can find the OpOrder that haven&apos;t completed, and which threads are holding a reference to it and what they are blocking on.&lt;/p&gt;
</comment>
                            <comment id="17838252" author="rustyrazorblade" created="Wed, 17 Apr 2024 15:24:01 +0000"  >&lt;p&gt;Sadly I don&apos;t have one from the previous test, but this issue has come up several times previously so replicating it shouldn&apos;t be a problem.  I&apos;ll take a look when I get more data.  Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17838376" author="benedict" created="Wed, 17 Apr 2024 20:34:28 +0000"  >&lt;p&gt;Honestly a jstack output during the issue would probably be enough to spot a candidate issue. If you have one feel free to back channel it to me for a quick peek, in case I can easily spot something to dig into.&lt;/p&gt;</comment>
                            <comment id="17838434" author="rustyrazorblade" created="Thu, 18 Apr 2024 02:40:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is the Flush that is blocked the one that the postFlush is waiting on? You can check this from a heap dump.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Looking at the incoming references in the heap dump I can see the reference to the MemtableFlushWriter on thread 1231, which is one of the memtable threads that&apos;s in WAITING.&#160;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13068267/13068267_image-2024-04-17-18-46-29-474.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Should any of the write barrier be marked isBlocking=true after this runs?&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;writeBarrier.markBlocking();&lt;/tt&gt;&lt;br/&gt;
&lt;tt&gt;writeBarrier.await();&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13068269/13068269_image-2024-04-17-19-14-34-344.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Does getting past the write barrier await require other mutations to complete?&#160; If we&apos;re unable to get memory from the memtable pool, would that block the write barrier?&lt;/p&gt;

&lt;p&gt;Fwiw, I am not 100% confident of my timeline as it&apos;s based on output from the status logger and it&apos;s entirely possible that&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17838525" author="benedict" created="Thu, 18 Apr 2024 08:06:17 +0000"  >&lt;p&gt;The &lt;tt&gt;isBlocking&lt;/tt&gt; flag is what indicates that you can skip the memtable allocator limit checks. The earliest possible &lt;tt&gt;OpOrder.Group&lt;/tt&gt; (so walking the &lt;tt&gt;prev&lt;/tt&gt; links until there are no more) is the one that will be stopping progress.&lt;/p&gt;

&lt;p&gt;If you can upload / send a jstack dump while the node is locked up I can &lt;em&gt;probably&lt;/em&gt; diagnose it.&lt;/p&gt;</comment>
                            <comment id="17840197" author="rustyrazorblade" created="Tue, 23 Apr 2024 18:53:20 +0000"  >&lt;p&gt;I&apos;ve rolled out a small patch (&lt;a href=&quot;https://github.com/rustyrazorblade/cassandra/tree/jhaddad/4.1.4-extra-logging&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/rustyrazorblade/cassandra/tree/jhaddad/4.1.4-extra-logging&lt;/a&gt;) that adds a monitoring thread to each flush and have found that in every case I see stacktraces related to the filesystem, which is ZFS:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;MemtablePostFlush:1&quot; daemon prio=5 Id=429 RUNNABLE
        at java.base@11.0.22/sun.nio.fs.UnixNativeDispatcher.unlink0(Native Method)
        at java.base@11.0.22/sun.nio.fs.UnixNativeDispatcher.unlink(UnixNativeDispatcher.java:156)
        at java.base@11.0.22/sun.nio.fs.UnixFileSystemProvider.implDelete(UnixFileSystemProvider.java:236)
        at java.base@11.0.22/sun.nio.fs.AbstractFileSystemProvider.delete(AbstractFileSystemProvider.java:105)
        at java.base@11.0.22/java.nio.file.Files.delete(Files.java:1142)
        at app//org.apache.cassandra.io.util.PathUtils.delete(PathUtils.java:252)
        at app//org.apache.cassandra.io.util.PathUtils.delete(PathUtils.java:299)
        at app//org.apache.cassandra.io.util.PathUtils.delete(PathUtils.java:306)
        ...

        Number of locked synchronizers = 1
        - java.util.concurrent.ThreadPoolExecutor$Worker@1fc5251a
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;MemtablePostFlush:1&quot; daemon prio=5 Id=429 RUNNABLE
        at java.base@11.0.22/sun.nio.fs.UnixNativeDispatcher.lstat0(Native Method)
        at java.base@11.0.22/sun.nio.fs.UnixNativeDispatcher.lstat(UnixNativeDispatcher.java:332)
        at java.base@11.0.22/sun.nio.fs.UnixFileAttributes.get(UnixFileAttributes.java:72)
        at java.base@11.0.22/sun.nio.fs.UnixFileSystemProvider.implDelete(UnixFileSystemProvider.java:232)
        at java.base@11.0.22/sun.nio.fs.AbstractFileSystemProvider.delete(AbstractFileSystemProvider.java:105)
        at java.base@11.0.22/java.nio.file.Files.delete(Files.java:1142)
        at app//org.apache.cassandra.io.util.PathUtils.delete(PathUtils.java:252)
        at app//org.apache.cassandra.io.util.PathUtils.delete(PathUtils.java:299)
        ...

        Number of locked synchronizers = 1
        - java.util.concurrent.ThreadPoolExecutor$Worker@1fc5251a
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have several dozen of these and am finding in every case we&apos;re either at &lt;tt&gt;java.base@11.0.22/sun.nio.fs.UnixNativeDispatcher.unlink0&lt;/tt&gt; or &lt;tt&gt;java.base@11.0.22/sun.nio.fs.UnixNativeDispatcher.lstat0&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m moving this cluster off ZFS and onto XFS, if I find the issue goes away I&apos;ll close this out.  I don&apos;t think there&apos;s anything we can do about unreliable filesystems other than improving our error reporting around it.&lt;/p&gt;</comment>
                            <comment id="17840986" author="rustyrazorblade" created="Thu, 25 Apr 2024 21:39:51 +0000"  >&lt;p&gt;I&apos;m closing this out as I&apos;m no longer seeing the issue after moving from ZFS to XFS, with some reservations. I&apos;m a little concerned that I haven&apos;t noticed compaction affected by this unlink issue, only the commit log unlinking during the PostFlush. It&apos;s possible this also affected unlinking during compaction and we just didn&apos;t notice it, because the blocking PostFlush causes cascading failure whereas blocking compaction from unlinking would only cause compaction to take longer. I am not sure how long the filesystem call was waiting, only that it was at least 10 seconds.&lt;/p&gt;</comment>
                            <comment id="17893965" author="JIRAUSER306480" created="Tue, 29 Oct 2024 19:12:12 +0000"  >&lt;p&gt;Hi folks, we are facing the same issue on 4.1.3 quite frequently on a given cassandra cluster.&lt;/p&gt;

&lt;p&gt;When a new node tries to join the ring during node replacement, &lt;b&gt;all&lt;/b&gt; its mutationstage threads are stuck indefinitely on memtable allocator pool. There is no write spike on coordinator node but replica writes are piling up on the new node. Any ideas why this might be happening?&lt;/p&gt;

&lt;p&gt;Below is the threaddump:&lt;/p&gt;



&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;&lt;span class=&quot;code-quote&quot;&gt;&quot;MutationStage-1&quot;&lt;/span&gt; - &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; t@92
&#160; &#160;java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING
&#160;at java.base@11.0.20.1/jdk.internal.misc.Unsafe.park(Native Method)
&#160;at java.base@11.0.20.1/java.util.concurrent.locks.LockSupport.park(LockSupport.java:323)
&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.WaitQueue$Standard$AbstractSignal.await(WaitQueue.java:289)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.WaitQueue$Standard$AbstractSignal.await(WaitQueue.java:282)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.Awaitable$Defaults.awaitThrowUncheckedOnInterrupt(Awaitable.java:131)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.Awaitable$AbstractAwaitable.awaitThrowUncheckedOnInterrupt(Awaitable.java:235)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.memory.MemtableAllocator$SubAllocator.allocate(MemtableAllocator.java:195)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.memory.MemtableAllocator$SubAllocator.adjust(MemtableAllocator.java:165)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.partitions.AtomicBTreePartition$RowUpdater.finish(AtomicBTreePartition.java:448)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.partitions.AtomicBTreePartition.addAllWithSizeDeltaInternal(AtomicBTreePartition.java:152)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.partitions.AtomicBTreePartition.addAllWithSizeDelta(AtomicBTreePartition.java:190)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.memtable.SkipListMemtable.put(SkipListMemtable.java:134)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.ColumnFamilyStore.apply(ColumnFamilyStore.java:1431)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.CassandraTableWriteHandler.write(CassandraTableWriteHandler.java:40)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Keyspace.applyInternal(Keyspace.java:783)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Keyspace.applyFuture(Keyspace.java:580)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Mutation.applyFuture(Mutation.java:251)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.MutationVerbHandler.doVerb(MutationVerbHandler.java:73)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.net.InboundSink.lambda$&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;$0(InboundSink.java:79)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.net.InboundSink$$Lambda$597/0x00007f00af4dc040.accept(Unknown Source)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.net.InboundSink.accept(InboundSink.java:98)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.net.InboundSink.accept(InboundSink.java:46)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.net.InboundMessageHandler$ProcessMessage.run(InboundMessageHandler.java:430)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.concurrent.ExecutionFailure$1.run(ExecutionFailure.java:133)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:142)
&lt;/span&gt;&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
&lt;/span&gt;&#160;at java.base@11.0.20.1/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)

&#160; &#160;Locked ownable synchronizers:
&#160;- None
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17893972" author="rustyrazorblade" created="Tue, 29 Oct 2024 19:26:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gauravapiscean&quot; class=&quot;user-hover&quot; rel=&quot;gauravapiscean&quot;&gt;gauravapiscean&lt;/a&gt;&#160; please provide more information.&#160; The issue isn&apos;t in the mutation thread, it&apos;s somewhere else.&#160; In my case it was caused by ZFS refusing to unlink a commit log segment.&#160; Do you have the full thread dump?&#160; Look for something like this:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;MemtablePostFlush:1&quot; daemon prio=5 Id=429 RUNNABLE
        at java.base@11.0.22/sun.nio.fs.UnixNativeDispatcher.unlink0(Native Method)
        at java.base@11.0.22/sun.nio.fs.UnixNativeDispatcher.unlink(UnixNativeDispatcher.java:156)
        at java.base@11.0.22/sun.nio.fs.UnixFileSystemProvider.implDelete(UnixFileSystemProvider.java:236)
        at java.base@11.0.22/sun.nio.fs.AbstractFileSystemProvider.delete(AbstractFileSystemProvider.java:105)
        at java.base@11.0.22/java.nio.file.Files.delete(Files.java:1142)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17893987" author="JIRAUSER306480" created="Tue, 29 Oct 2024 20:34:23 +0000"  >&lt;p&gt;Thanks for the pointer &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rustyrazorblade&quot; class=&quot;user-hover&quot; rel=&quot;rustyrazorblade&quot;&gt;rustyrazorblade&lt;/a&gt; . Here is the full thread dump: &lt;a href=&quot;https://justpaste.it/bxnpr&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://justpaste.it/bxnpr&lt;/a&gt;&lt;br/&gt;
Here is the error log from the thread dump related to MemtablePostFlush:&lt;/p&gt;



&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;MemtablePostFlush:1&quot;&lt;/span&gt; - &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; t@45
&#160; &#160;java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING
&#160;at java.base@11.0.20.1/jdk.internal.misc.Unsafe.park(Native Method)
&#160;- parking to wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; &amp;lt;2994ecaf&amp;gt; (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)
&#160;at java.base@11.0.20.1/java.util.concurrent.locks.LockSupport.park(LockSupport.java:194)
&#160;at java.base@11.0.20.1/java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2081)
&#160;at java.base@11.0.20.1/java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:433)
&#160;at java.base@11.0.20.1/java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1054)
&#160;at java.base@11.0.20.1/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1114)
&#160;at java.base@11.0.20.1/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
&#160;at app&lt;span class=&quot;code-comment&quot;&gt;//io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
&lt;/span&gt;&#160;at java.base@11.0.20.1/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)

&#160; &#160;Locked ownable synchronizers:
&#160;- None
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17894009" author="rustyrazorblade" created="Tue, 29 Oct 2024 21:35:40 +0000"  >&lt;p&gt;I took a look at the stack trace and it doesn&apos;t look like you&apos;re hitting the same filesystem related issue.&#160; Unfortunately going any further than this will require an investigation that I don&apos;t have the time to dig into right now.&lt;/p&gt;

&lt;p&gt;If you could grab a CPU flame graph of the node when it&apos;s stuck then it&apos;ll might make it easy to visually identify the stack trace.&#160; Here&apos;s a post I wrote explaining how to do it: &lt;a href=&quot;https://rustyrazorblade.com/post/2023/2023-11-07-async-profiler/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://rustyrazorblade.com/post/2023/2023-11-07-async-profiler/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17894054" author="JIRAUSER306480" created="Wed, 30 Oct 2024 02:52:05 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rustyrazorblade&quot; class=&quot;user-hover&quot; rel=&quot;rustyrazorblade&quot;&gt;rustyrazorblade&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17897047" author="chovatia.jaydeep@gmail.com" created="Sun, 10 Nov 2024 21:45:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gauravapiscean&quot; class=&quot;user-hover&quot; rel=&quot;gauravapiscean&quot;&gt;gauravapiscean&lt;/a&gt;, Upon further studying the thread dump, I think there is a deadlock between &lt;em&gt;CompactionExecutor&lt;/em&gt; (Thread1) &amp;amp; &lt;em&gt;MemtableReclaimMemory&lt;/em&gt; (Thread2) in the stack trace you have mentioned.&lt;/p&gt;

&lt;p&gt;Please find the details here:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;b&gt;&lt;font color=&quot;#4c9aff&quot;&gt;Thread1&lt;/font&gt;:&lt;/b&gt; It has invoked &lt;tt&gt;&lt;em&gt;readOrdering.start()&lt;/em&gt;&lt;/tt&gt; on &lt;em&gt;baseCf&lt;/em&gt; and &lt;tt&gt;&lt;em&gt;indexCf&lt;/em&gt;&lt;/tt&gt; as part of the &quot;&lt;tt&gt;&lt;em&gt;ReadExecutionController controller = cmd.executionController()&lt;/em&gt;&lt;/tt&gt;&quot; at a &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L921&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line no&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;&lt;font color=&quot;#4c9aff&quot;&gt;Thread1&lt;/font&gt;:&lt;/b&gt; It wants to apply the change locally to Memtable as part of&#160;&lt;tt&gt;indexer.insertRow(row) at a &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L962&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line no&lt;/a&gt;&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;&lt;font color=&quot;#4c9aff&quot;&gt;Thread1&lt;/font&gt;:&lt;/b&gt; There is not enough space available in Memtable; hence, Thread1 is blocked on space to become available&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;&lt;font color=&quot;#57d9a3&quot;&gt;Thread2&lt;/font&gt;:&lt;/b&gt; It wants to free up the space in Memtable, but before it does that, it is &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/ColumnFamilyStore.java#L1350&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;waiting&lt;/a&gt; on all the &lt;tt&gt;&lt;em&gt;readOrdering&lt;/em&gt;&lt;/tt&gt; for a given Cf to finish.&lt;/li&gt;
	&lt;li&gt;&lt;b&gt;&lt;font color=&quot;#57d9a3&quot;&gt;Thread2&lt;/font&gt;&lt;/b&gt;&lt;b&gt;:&lt;/b&gt; But Thread2&apos;s indefinite wait cannot succeed because Thread1 has already invoked &quot;&lt;em&gt;.start()&lt;/em&gt;&quot; on it, so unless and until Thread1 calls &lt;em&gt;&quot;.close()&quot;&lt;/em&gt; Threa2 cannot proceed. And here is the &lt;b&gt;&lt;font color=&quot;#de350b&quot;&gt;deadlock&lt;/font&gt;&lt;/b&gt;.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Here are the stack traces for Thread1 and Thread2 to prove the deadlock, as mentioned above.&lt;/p&gt;

&lt;p&gt;Thread1 (&lt;em&gt;CompactionExecutor&lt;/em&gt;)&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;CompactionExecutor:5&quot;&lt;/span&gt; - &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; t@118
&#160;&#160; java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING
&#160; &#160; &#160; &#160; at java.base@11.0.20.1/jdk.internal.misc.Unsafe.park(Native Method)
&#160; &#160; &#160; &#160; at java.base@11.0.20.1/java.util.concurrent.locks.LockSupport.park(LockSupport.java:323)
&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.WaitQueue$Standard$AbstractSignal.await(WaitQueue.java:289)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.WaitQueue$Standard$AbstractSignal.await(WaitQueue.java:282)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.Awaitable$Defaults.awaitThrowUncheckedOnInterrupt(Awaitable.java:131)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.Awaitable$AbstractAwaitable.awaitThrowUncheckedOnInterrupt(Awaitable.java:235)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.memory.MemtableAllocator$SubAllocator.allocate(MemtableAllocator.java:195)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.memory.SlabAllocator.allocate(SlabAllocator.java:89)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.memory.MemtableBufferAllocator$1.allocate(MemtableBufferAllocator.java:40)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.memory.ByteBufferCloner.clone(ByteBufferCloner.java:77)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.memory.ByteBufferCloner.clone(ByteBufferCloner.java:63)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Clustering.clone(Clustering.java:54)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.memory.ByteBufferCloner.clone(ByteBufferCloner.java:52)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.rows.BTreeRow.clone(BTreeRow.java:517)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.partitions.AtomicBTreePartition$RowUpdater.insert(AtomicBTreePartition.java:375)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.partitions.AtomicBTreePartition$RowUpdater.insert(AtomicBTreePartition.java:351)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.btree.BTree.updateLeaves(BTree.java:461)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.btree.BTree.update(BTree.java:368)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.partitions.AtomicBTreePartition.addAllWithSizeDeltaInternal(AtomicBTreePartition.java:146)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.partitions.AtomicBTreePartition.addAllWithSizeDelta(AtomicBTreePartition.java:190)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.memtable.SkipListMemtable.put(SkipListMemtable.java:134)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.ColumnFamilyStore.apply(ColumnFamilyStore.java:1431)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.CassandraTableWriteHandler.write(CassandraTableWriteHandler.java:40)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.index.internal.CassandraIndex.insert(CassandraIndex.java:529)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.index.internal.CassandraIndex$1.indexCell(CassandraIndex.java:445)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.index.internal.CassandraIndex$1.indexCells(CassandraIndex.java:437)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.index.internal.CassandraIndex$1.insertRow(CassandraIndex.java:387)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.index.SecondaryIndexManager.lambda$indexPartition$25(SecondaryIndexManager.java:985)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.index.SecondaryIndexManager$$Lambda$1396/0x00007f00861e2cb0.accept(Unknown Source)
&lt;/span&gt;&#160; &#160; &#160; &#160; at java.base@11.0.20.1/java.lang.Iterable.forEach(Iterable.java:75)
&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.index.SecondaryIndexManager.indexPartition(SecondaryIndexManager.java:985)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.index.internal.CollatedViewIndexBuilder.build(CollatedViewIndexBuilder.java:78)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.compaction.CompactionManager$13.run(CompactionManager.java:1888)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.concurrent.FutureTask$3.call(FutureTask.java:141)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.concurrent.FutureTask.call(FutureTask.java:61)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.concurrent.FutureTask.run(FutureTask.java:71)
&lt;/span&gt;&#160; &#160; &#160; &#160; at java.base@11.0.20.1/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
&#160; &#160; &#160; &#160; at java.base@11.0.20.1/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
&lt;/span&gt;&#160; &#160; &#160; &#160; at java.base@11.0.20.1/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thread2 (&lt;em&gt;MemtableReclaimMemory&lt;/em&gt;)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;MemtableReclaimMemory:1&quot;&lt;/span&gt; - &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt; t@56
&#160;&#160; java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING
&#160; &#160; &#160; &#160; at java.base@11.0.20.1/jdk.internal.misc.Unsafe.park(Native Method)
&#160; &#160; &#160; &#160; at java.base@11.0.20.1/java.util.concurrent.locks.LockSupport.park(LockSupport.java:323)
&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.WaitQueue$Standard$AbstractSignal.await(WaitQueue.java:289)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.WaitQueue$Standard$AbstractSignal.await(WaitQueue.java:282)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.Awaitable$Defaults.awaitUninterruptibly(Awaitable.java:186)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.Awaitable$AbstractAwaitable.awaitUninterruptibly(Awaitable.java:259)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.OpOrder$Group.await(OpOrder.java:267)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.concurrent.OpOrder$Barrier.await(OpOrder.java:425)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.ColumnFamilyStore$Flush$1.runMayThrow(ColumnFamilyStore.java:1357)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
&lt;/span&gt;&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.concurrent.ExecutionFailure$1.run(ExecutionFailure.java:133)
&lt;/span&gt;&#160; &#160; &#160; &#160; at java.base@11.0.20.1/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
&#160; &#160; &#160; &#160; at java.base@11.0.20.1/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
&#160; &#160; &#160; &#160; at app&lt;span class=&quot;code-comment&quot;&gt;//io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
&lt;/span&gt;&#160; &#160; &#160; &#160; at java.base@11.0.20.1/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17897054" author="benedict" created="Sun, 10 Nov 2024 23:38:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chovatia.jaydeep%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;chovatia.jaydeep@gmail.com&quot;&gt;chovatia.jaydeep@gmail.com&lt;/a&gt; I think you are correct, well done for tracking that down. The read&#160;&lt;tt&gt;OpOrder&lt;/tt&gt; should not really be used in a location that may block in this way. The &lt;tt&gt;writeOrder&lt;/tt&gt; has mechanisms in place to ensure that progress can continue to be made (see &lt;tt&gt;markBlocking&lt;/tt&gt; and &lt;tt&gt;MemtableAllocator.allocate&lt;/tt&gt;), but the &lt;tt&gt;readOrder&lt;/tt&gt; relies on readers always being able to make progress.&lt;/p&gt;

&lt;p&gt;Probably the simplest solution would be to copy any &lt;tt&gt;Memtable&lt;/tt&gt; contents used to serve the indexer request, so that we can immediately close the &lt;tt&gt;OpOrder&lt;/tt&gt; before we initiate the write - although the read/write contexts have ballooned in complexity over the years so that may not be as trivial as it once was.&lt;/p&gt;</comment>
                            <comment id="17897370" author="JIRAUSER306480" created="Tue, 12 Nov 2024 05:53:57 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chovatia.jaydeep%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;chovatia.jaydeep@gmail.com&quot;&gt;chovatia.jaydeep@gmail.com&lt;/a&gt; , it was a tricky finding.&lt;/p&gt;

&lt;p&gt;One solution would be to modify the code to ensure that memory space checks and allocations are done before initiating or locking readOrdering.&lt;br/&gt;
This change would allow Thread1 to determine whether enough space is available before starting the readOrdering. If not enough space is available, Thread1 could either wait without locking or try again later.&lt;br/&gt;
OR&lt;/p&gt;

&lt;p&gt;Prioritize &lt;tt&gt;MemtableReclaimMemory&lt;/tt&gt; operations over other tasks to ensure that memory is freed promptly and other threads like CompactionExecutor don&#8217;t end up in a deadlock waiting for space.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;What do you think.&lt;/p&gt;</comment>
                            <comment id="17897432" author="benedict" created="Tue, 12 Nov 2024 09:45:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gauravapiscean&quot; class=&quot;user-hover&quot; rel=&quot;gauravapiscean&quot;&gt;gauravapiscean&lt;/a&gt;: the idea of prioritising &lt;tt&gt;MemtableReclaimMemory&lt;/tt&gt; is a non-starter, because it cannot reclaim memory that is being actively read by another thread (as it is in this case). We need to decouple the other thread&apos;s read from the release of this memory. The typical way to do this is to copy the data.&lt;/p&gt;

&lt;p&gt;The idea of asking for memory upfront would work in most cases: we could reserve at least as much memory as we would need, and then release what we don&apos;t use. For these cases it would be a good approach, but it is not a small refactor, and I don&apos;t think it works in all cases. For instance, when resolving counters, I believe we can allocate a buffer larger than the input, so we don&apos;t actually know how much memory to allocate before starting.&lt;/p&gt;</comment>
                            <comment id="17898072" author="JIRAUSER306480" created="Wed, 13 Nov 2024 23:21:08 +0000"  >&lt;p&gt;Sounds good, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; . Copying &lt;tt&gt;Memtable&lt;/tt&gt; contents approach seems very reasonable to me.&lt;br/&gt;
Can you please reopen this ticket (cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rustyrazorblade&quot; class=&quot;user-hover&quot; rel=&quot;rustyrazorblade&quot;&gt;rustyrazorblade&lt;/a&gt;) or I can create a new ticket to address this issue.&#160;&lt;/p&gt;</comment>
                            <comment id="17898081" author="chovatia.jaydeep@gmail.com" created="Thu, 14 Nov 2024 00:46:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gauravapiscean&quot; class=&quot;user-hover&quot; rel=&quot;gauravapiscean&quot;&gt;gauravapiscean&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Copying Memtable is going to be a very tricky thing and might lead us to more future corner cases, in my opinion. How about a third option, which is not to wait indefinitely in &lt;em&gt;MemtableAllocator.java&lt;/em&gt;?&#160;The major problem is that the &lt;em&gt;MemtableAllocator.java&lt;/em&gt; thread has been waiting indefinitely to acquire the memory. &#160;Instead of having it stay forever, we can introduce a timeout, and if it is unsuccessful, then let that operation fail.&lt;/p&gt;

&lt;p&gt;That way, when &lt;em&gt;Memtable&lt;/em&gt; is almost full, the &lt;em&gt;MutationStage&lt;/em&gt; and &lt;em&gt;Compaction&lt;/em&gt; threads will eventually timeout and unblock &lt;b&gt;MemtableReclaimMemory.&lt;/b&gt; Once the &lt;b&gt;&lt;em&gt;MemtableReclaimMemory&lt;/em&gt;&lt;/b&gt;&#160; is unblocked, it will free up more space, and then the future &lt;em&gt;MutationStage&lt;/em&gt; and &lt;em&gt;Compaction&lt;/em&gt; threads will succeed.&lt;/p&gt;

&lt;p&gt;In short, bail out the compaction and mutation tasks after some interval to break the deadlock. If so, the change to the MemtableAllocator.java would look as follows:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
--- a/src/java/org/apache/cassandra/utils/memory/MemtableAllocator.java
+++ b/src/java/org/apache/cassandra/utils/memory/MemtableAllocator.java
@@ -25,9 +25,13 @@ &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.slf4j.LoggerFactory;
&#160;
&#160;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.codahale.metrics.Timer;
&#160;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.exceptions.RequestExecutionException;
&#160;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.utils.concurrent.OpOrder;
&#160;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.utils.concurrent.WaitQueue;
&#160;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; java.util.concurrent.TimeUnit.SECONDS;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; org.apache.cassandra.utils.Clock.Global.nanoTime;
+
&#160;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MemtableAllocator
&#160;{
&#160;&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Logger logger = LoggerFactory.getLogger(MemtableAllocator.class);
@@ -192,7 +196,11 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;abstract&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;MemtableAllocator
&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
&#160;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
-&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; signal.awaitThrowUncheckedOnInterrupt();
+&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!signal.awaitUntilThrowUncheckedOnInterrupt(nanoTime() + SECONDS.toNanos(5))) &lt;span class=&quot;code-comment&quot;&gt;//TODO: introduce a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; timeout configuration or use the write timeout
&lt;/span&gt;+&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; {
+&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; RuntimeException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Timed out waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; free memory&quot;&lt;/span&gt;);
+&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; }
+
&#160;&#160; &#160; &#160; &#160; &#160; &#160; }
&#160;&#160; &#160; &#160; &#160; }
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;wdyt?&lt;/p&gt;</comment>
                            <comment id="17898235" author="benedict" created="Thu, 14 Nov 2024 11:05:50 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chovatia.jaydeep%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;chovatia.jaydeep@gmail.com&quot;&gt;chovatia.jaydeep@gmail.com&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;There are no edge cases to consider here really. The logic to copy on heap already exists, in fact all you need to do is to first read the iterator into an &lt;tt&gt;ImmutableBTreePartition&lt;/tt&gt; and the job is done for you, i.e. pass the iterator to &lt;tt&gt;ImmutableBTreePartition.create()&lt;/tt&gt;, then close the &lt;tt&gt;ReadExecutionController&lt;/tt&gt; before iterating over this copy to perform the write.&lt;/p&gt;

&lt;p&gt;The problem with timing out is that we need to handle this exception reliably. One simple option might be to offer a special &lt;tt&gt;tryPut&lt;/tt&gt; method that tells the &lt;tt&gt;MemtableAllocator&lt;/tt&gt;&#160;to fail with some dedicated &lt;tt&gt;Exception&lt;/tt&gt; type that we can trap within &lt;tt&gt;tryPut&lt;/tt&gt;, to return &lt;tt&gt;false&lt;/tt&gt; if thrown, informing the compactor so it can loop and retry. I would oppose additional configuration for timeouts, this is not a detail the user should be exposed to. In this scheme, if &lt;tt&gt;tryPut&lt;/tt&gt; fails we can repeat the read/put. Or, we can copy the read only in this case and perform a normal &lt;tt&gt;put&lt;/tt&gt;. This all requires a lot more refactoring though.&lt;/p&gt;</comment>
                            <comment id="17898420" author="chovatia.jaydeep@gmail.com" created="Thu, 14 Nov 2024 21:32:33 +0000"  >&lt;p&gt;Ok, that makes sense. Let&apos;s go with the copy on the heap.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gauravapiscean&quot; class=&quot;user-hover&quot; rel=&quot;gauravapiscean&quot;&gt;gauravapiscean&lt;/a&gt;, Please let me know if you need more help with fixing this issue. I am opening this issue and assigning it to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gauravapiscean&quot; class=&quot;user-hover&quot; rel=&quot;gauravapiscean&quot;&gt;gauravapiscean&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17898421" author="chovatia.jaydeep@gmail.com" created="Thu, 14 Nov 2024 21:33:56 +0000"  >&lt;p&gt;Reopening as there is a deadlock that has existed for a long time and needs fixing.&lt;/p&gt;</comment>
                            <comment id="17898429" author="JIRAUSER306480" created="Thu, 14 Nov 2024 21:49:42 +0000"  >&lt;p&gt;Sure, thanks folks.&#160;&lt;/p&gt;</comment>
                            <comment id="17899821" author="chovatia.jaydeep@gmail.com" created="Wed, 20 Nov 2024 17:11:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; will work on this ticket.&lt;/p&gt;</comment>
                            <comment id="17899876" author="JIRAUSER291682" created="Wed, 20 Nov 2024 20:52:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; PR: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3700&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3700&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17900376" author="benedict" created="Fri, 22 Nov 2024 13:38:40 +0000"  >&lt;p&gt;The change looks reasonable to me, but I won&apos;t have time to shepherd this change through. It should also be noted that this could have some detrimental GC/heap impact for some workloads, if the pages for indexing are large. I don&apos;t have a particular opinion about whether this should be examined before merging.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Looking at it a bit more quickly, I think the likelihood of detrimental impact is minimal - we only copy to the heap native/offheap memtable entries, all other datums are already considered safe - we just might hold on to memtable slabs slightly longer, and sstable datums are allocated to heap buffers already. So we just materialise the rows at once, which should be fine if paging is reasonable.&lt;/p&gt;

&lt;p&gt;I do question slightly whether it&apos;s fine that we leak direct references to slab buffers when reading from Memtables, but... we do. Whether we are fine with that for this patch given it may block and hold onto them and cause heap pressure is a separate question, that I don&apos;t have a strong opinion on. We could explicitly copy the buffer to new heap buffers to avoid this issue.&lt;/p&gt;

&lt;p&gt;I hope that we will retire slab allocators for most workloads before too long anyway, so I have minimal feeling about this particular edge case of our behaviour.&lt;/p&gt;</comment>
                            <comment id="17911056" author="bereng" created="Wed, 8 Jan 2025 12:36:08 +0000"  >&lt;p&gt;4.0 is also affected. I ported the test and I noticed it fail and pass after applying the patch #justfyi&lt;/p&gt;</comment>
                            <comment id="17913882" author="JIRAUSER291682" created="Thu, 16 Jan 2025 23:40:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; are you able to help to find some committer to review the change?&lt;/p&gt;

&lt;p&gt;Link it again here: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3700&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3700&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rustyrazorblade&quot; class=&quot;user-hover&quot; rel=&quot;rustyrazorblade&quot;&gt;rustyrazorblade&lt;/a&gt; are you able to review this change?&lt;/p&gt;</comment>
                            <comment id="17914170" author="rustyrazorblade" created="Fri, 17 Jan 2025 16:29:48 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt; thanks for the patch, but my schedule is completely booked right now and I don&apos;t have time for a review.&#160;&lt;/p&gt;</comment>
                            <comment id="17923492" author="JIRAUSER291682" created="Mon, 3 Feb 2025 21:57:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3700&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3700&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17954098" author="JIRAUSER309453" created="Mon, 26 May 2025 13:57:16 +0000"  >&lt;p&gt;Hi folks, I believe we are also seeing this issue on Cassandra 4.1.2 and 4.1.6. Can you review below to see if you would expect to see these symptoms as well for this issue.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20610&quot; title=&quot;nodetool unreachable shows all other instances down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20610&quot;&gt;CASSANDRA-20610&lt;/a&gt; and&#160;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20598&quot; title=&quot;unexpected exception caught while processing inbound messages; terminating connection&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20598&quot;&gt;CASSANDRA-20598&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Thanks,&#160;&lt;/p&gt;

&lt;p&gt;Chris.&lt;/p&gt;</comment>
                            <comment id="17954155" author="chovatia.jaydeep@gmail.com" created="Mon, 26 May 2025 20:30:32 +0000"  >&lt;p&gt;Do you have a stack dump? Because without the stack dump, it is difficult to conclude if it is the same issue or different. Looking at the behavior in the tickets, it is likely that the deadlock would cause it; now, whether it is this deadlock or something new, only the stack dump would tell us.&lt;br/&gt;
Another important thing is that this ticket happens only with secondary indexes, so it&apos;s worth checking whether you have one.&lt;/p&gt;</comment>
                            <comment id="17954265" author="JIRAUSER309453" created="Tue, 27 May 2025 08:57:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chovatia.jaydeep%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;chovatia.jaydeep@gmail.com&quot;&gt;chovatia.jaydeep@gmail.com&lt;/a&gt; Yes, we have secondary indexes and will capture a stack dump the next time the incident takes place.&lt;/p&gt;</comment>
                            <comment id="17984922" author="smiklosovic" created="Fri, 20 Jun 2025 07:36:42 +0000"  >&lt;p&gt;I was told we do see this also on nodes without secondary indexes. I would highly appreciate if this ticket moved forward, it is being stuck across versions and clusters.&lt;/p&gt;</comment>
                            <comment id="17984995" author="chovatia.jaydeep@gmail.com" created="Fri, 20 Jun 2025 16:32:14 +0000"  >&lt;p&gt;I have just approved the proposed PR, as it has been already in production for more than six months now, so battle-tested already. The PR has solved the deadlock issue due to Secondary indexes. Appreciate if we can have another committer review it, then I can run a complete test suite and can help with the merge.&lt;/p&gt;

&lt;p&gt;&amp;gt;I was told we do see this also on nodes without secondary indexes.&lt;/p&gt;

&lt;p&gt;For the case w/o secondary indexes, I have added a possible explanation in this ticket, awaiting someone to validate it &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20610&quot; title=&quot;nodetool unreachable shows all other instances down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20610&quot;&gt;CASSANDRA-20610&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="18029593" author="maedhroz" created="Mon, 13 Oct 2025 18:52:06 +0000"  >&lt;p&gt;I know I said I would take a look at this at CoC. Still planning on doing that some time this week. Apologies for the delay...&lt;/p&gt;</comment>
                            <comment id="18029603" author="chovatia.jaydeep@gmail.com" created="Mon, 13 Oct 2025 20:14:21 +0000"  >&lt;p&gt;Sure, thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="18029626" author="maedhroz" created="Mon, 13 Oct 2025 23:19:54 +0000"  >&lt;p&gt;Dropped some comments in the PR. Overall, I think the approach is safe, as the paging apparatus handles large partitions. Will +1 when the little things are resolved and we have a CI run. (Let me know if you need me to kick one off...)&lt;/p&gt;</comment>
                            <comment id="18029627" author="maedhroz" created="Mon, 13 Oct 2025 23:22:36 +0000"  >&lt;p&gt;...and then we just need to port through to 5.0 and trunk.&lt;/p&gt;

&lt;p&gt;This doesn&apos;t affect SAI, if anyone was curious.&lt;/p&gt;</comment>
                            <comment id="18031956" author="JIRAUSER291682" created="Wed, 22 Oct 2025 04:28:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; just updated the PR, could you please take a look? Thanks. Also, it will be great if you can start one CI run.&lt;/p&gt;</comment>
                            <comment id="18032168" author="maedhroz" created="Wed, 22 Oct 2025 16:18:42 +0000"  >&lt;p&gt;Posted 4.1 CI summary. The only notable failure is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18440&quot; title=&quot;Test failure: org.apache.cassandra.distributed.test.RepairTest.testForcedNormalRepairWithOneNodeDown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18440&quot;&gt;&lt;del&gt;CASSANDRA-18440&lt;/del&gt;&lt;/a&gt;, but that will disappear on rebase.&lt;/p&gt;</comment>
                            <comment id="18032244" author="maedhroz" created="Wed, 22 Oct 2025 20:31:42 +0000"  >&lt;p&gt;+1 on the 4.1 PR&lt;/p&gt;</comment>
                            <comment id="18032318" author="JIRAUSER291682" created="Thu, 23 Oct 2025 00:40:02 +0000"  >&lt;p&gt;5.0: &lt;a href=&quot;https://github.com/apache/cassandra/pull/4435&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/4435&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;truck: &lt;a href=&quot;https://github.com/apache/cassandra/pull/4436&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/4436&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="18032535" author="maedhroz" created="Thu, 23 Oct 2025 16:48:47 +0000"  >&lt;p&gt;5.0 and trunk patches look good. I&apos;ll start CI for those, unless we have runs already...&lt;/p&gt;</comment>
                            <comment id="18032537" author="JIRAUSER291682" created="Thu, 23 Oct 2025 16:50:28 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; , please start the CI as the one I started failed with some resource issue.&lt;/p&gt;</comment>
                            <comment id="18032549" author="maedhroz" created="Thu, 23 Oct 2025 17:13:16 +0000"  >&lt;p&gt;Runs in progress. I&apos;ll report back here when they wrap up...&lt;/p&gt;</comment>
                            <comment id="18032600" author="maedhroz" created="Thu, 23 Oct 2025 20:59:15 +0000"  >&lt;p&gt;5.0 and trunk CI runs look fine (i.e. nothing new failing there). &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chovatia.jaydeep%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;chovatia.jaydeep@gmail.com&quot;&gt;chovatia.jaydeep@gmail.com&lt;/a&gt; I think this is ready to commit. (Just needs a CHANGES entry.)&lt;/p&gt;</comment>
                            <comment id="18033090" author="chovatia.jaydeep@gmail.com" created="Mon, 27 Oct 2025 01:08:32 +0000"  >&lt;p&gt;Committed 4.1 - &lt;a href=&quot;https://github.com/apache/cassandra/commit/59574a86a3a829d904ce3964e36ec71f5b62b961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/59574a86a3a829d904ce3964e36ec71f5b62b961&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="18033091" author="chovatia.jaydeep@gmail.com" created="Mon, 27 Oct 2025 01:09:23 +0000"  >&lt;p&gt;Received an automated build failure &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-4.1-artifacts/728/jdk=jdk_1.8_latest,label=cassandra/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-4.1-artifacts/728/jdk=jdk_1.8_latest,label=cassandra/console&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
00:53:41 eclipse-warnings:
00:53:41     [mkdir] Created dir: /home/jenkins/jenkins-slave/workspace/Cassandra-4.1-artifacts/jdk/jdk_1.8_latest/label/cassandra/build/ecj
00:53:41      [echo] Running Eclipse Code Analysis.  Output logged to /home/jenkins/jenkins-slave/workspace/Cassandra-4.1-artifacts/jdk/jdk_1.8_latest/label/cassandra/build/ecj/eclipse_compiler_checks.txt
00:53:47      [java] ----------
00:53:47      [java] 1. ERROR in /home/jenkins/jenkins-slave/workspace/Cassandra-4.1-artifacts/jdk/jdk_1.8_latest/label/cassandra/src/java/org/apache/cassandra/index/SecondaryIndexManager.java (at line 931)
00:53:47      [java] 	partition = ImmutableBTreePartition.create(onePartition).unfilteredIterator();
00:53:47      [java] 	^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
00:53:47      [java] Resource &lt;span class=&quot;code-quote&quot;&gt;&apos;partition&apos;&lt;/span&gt; should be managed by &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;-with-resource
00:53:47      [java] ----------
00:53:47      [java] 1 problem (1 error) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="18033094" author="JIRAUSER291682" created="Mon, 27 Oct 2025 01:16:12 +0000"  >&lt;p&gt;Not sure how we can disable this check for this one as the partition is intentionally moved out of the try with resource to fix the bug. We have added the&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (partition != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
{
&#160; &#160; partition.close();
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the finally block. So, this should be good.&lt;/p&gt;</comment>
                            <comment id="18033098" author="chovatia.jaydeep@gmail.com" created="Mon, 27 Oct 2025 01:27:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=curlylrt&quot; class=&quot;user-hover&quot; rel=&quot;curlylrt&quot;&gt;curlylrt&lt;/a&gt;&#160; The 4.1 upstream generated an above CI error due to the Eclipse syntax check. I have just fixed it. Could you please help quickly review the PR? &lt;a href=&quot;https://github.com/apache/cassandra/pull/4443&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/4443&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="18033138" author="michaelsembwever" created="Mon, 27 Oct 2025 08:39:25 +0000"  >&lt;p&gt;And the 4.1 commit wasn&apos;t the atomic forward-merge over branches as we expect&#8230;  (fyi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chovatia.jaydeep%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;chovatia.jaydeep@gmail.com&quot;&gt;chovatia.jaydeep@gmail.com&lt;/a&gt;).  I&apos;ll fix&#8230; &lt;/p&gt;</comment>
                            <comment id="18033145" author="michaelsembwever" created="Mon, 27 Oct 2025 09:04:59 +0000"  >&lt;p&gt;ninja in &lt;a href=&quot;https://github.com/apache/cassandra/commit/bfcba9c7c40a02db70393fc8651ff1a94f82cb69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/bfcba9c7c40a02db70393fc8651ff1a94f82cb69&lt;/a&gt; &lt;br/&gt;
also forward-merged (using PRs^ and adding ninja.  and duplicated import had to be removed in the trunk patch too)&lt;/p&gt;


&lt;p&gt;(fyi: fixVersion 5.0.6 gets bumped to 5.0.7 by the release manager when finalising the eventual 5.0.6 release)&lt;/p&gt;</comment>
                            <comment id="18033151" author="michaelsembwever" created="Mon, 27 Oct 2025 09:30:23 +0000"  >&lt;p&gt;uff, i have no idea what i just tested in cassandra-4.1 before pushing the ninja&#8230;  the SuppressWarnings needs to be brought up to the method level.&lt;/p&gt;

&lt;p&gt;( i tripped over eclipse-warnings not running in cassandra-5.0 and trunk, in lei of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18239&quot; title=&quot;Replace eclipse warnings based static code analysis with something better (CheckerFramework)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18239&quot;&gt;CASSANDRA-18239&lt;/a&gt; )&lt;/p&gt;</comment>
                            <comment id="18033166" author="michaelsembwever" created="Mon, 27 Oct 2025 10:11:11 +0000"  >&lt;p&gt;ninja&apos;d again in &lt;a href=&quot;https://github.com/apache/cassandra/commit/fdc422c16fa6bc4a534f3b8636e016b0fa1174f3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/fdc422c16fa6bc4a534f3b8636e016b0fa1174f3&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;i&apos;ve just removed the SuppressWarnings annotation altogether from cassandra-5.0 and trunk, these will need to be addressed post &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18239&quot; title=&quot;Replace eclipse warnings based static code analysis with something better (CheckerFramework)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18239&quot;&gt;CASSANDRA-18239&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="18033282" author="chovatia.jaydeep@gmail.com" created="Mon, 27 Oct 2025 16:39:35 +0000"  >&lt;p&gt;Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mck&quot; class=&quot;user-hover&quot; rel=&quot;mck&quot;&gt;mck&lt;/a&gt;&#160; for reviewing, doing a quick ninja-fix, and merging as well!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13078928" name="ci_summary-1.html" size="31202" author="maedhroz" created="Thu, 23 Oct 2025 20:51:47 +0000"/>
                            <attachment id="13078930" name="ci_summary-2.html" size="135103" author="maedhroz" created="Thu, 23 Oct 2025 20:52:15 +0000"/>
                            <attachment id="13078918" name="ci_summary.html" size="38833" author="maedhroz" created="Wed, 22 Oct 2025 20:30:34 +0000"/>
                            <attachment id="13068244" name="image-2024-04-16-11-55-54-750.png" size="437050" author="rustyrazorblade" created="Tue, 16 Apr 2024 18:55:56 +0000"/>
                            <attachment id="13068243" name="image-2024-04-16-12-29-15-386.png" size="100060" author="rustyrazorblade" created="Tue, 16 Apr 2024 19:29:16 +0000"/>
                            <attachment id="13068242" name="image-2024-04-16-13-43-11-064.png" size="98434" author="rustyrazorblade" created="Tue, 16 Apr 2024 20:43:11 +0000"/>
                            <attachment id="13068241" name="image-2024-04-16-13-53-24-455.png" size="251038" author="rustyrazorblade" created="Tue, 16 Apr 2024 20:53:25 +0000"/>
                            <attachment id="13068267" name="image-2024-04-17-18-46-29-474.png" size="221845" author="rustyrazorblade" created="Thu, 18 Apr 2024 01:46:30 +0000"/>
                            <attachment id="13068268" name="image-2024-04-17-19-13-06-769.png" size="160675" author="rustyrazorblade" created="Thu, 18 Apr 2024 02:13:07 +0000"/>
                            <attachment id="13068269" name="image-2024-04-17-19-14-34-344.png" size="412531" author="rustyrazorblade" created="Thu, 18 Apr 2024 02:14:35 +0000"/>
                            <attachment id="13078956" name="image.png" size="973" author="chovatia.jaydeep@gmail.com" created="Mon, 27 Oct 2025 00:31:34 +0000"/>
                            <attachment id="13078931" name="result_details.tar-1.gz" size="9145635" author="maedhroz" created="Thu, 23 Oct 2025 20:52:16 +0000"/>
                            <attachment id="13078929" name="result_details.tar.gz" size="2474906" author="maedhroz" created="Thu, 23 Oct 2025 20:51:48 +0000"/>
                            <attachment id="13068322" name="screenshot-1.png" size="187350" author="rustyrazorblade" created="Fri, 19 Apr 2024 17:03:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>14.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[curlylrt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12992" cascade-level="1"><![CDATA[Process Crash]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1ool4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
        <customfieldvalue><![CDATA[chovatia.jaydeep@gmail.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12353459">4.1.4</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/59574a86a3a829d904ce3964e36ec71f5b62b961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/59574a86a3a829d904ce3964e36ec71f5b62b961&lt;/a&gt; &lt;a href=&quot;https://github.com/apache/cassandra/commit/bfcba9c7c40a02db70393fc8651ff1a94f82cb69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/bfcba9c7c40a02db70393fc8651ff1a94f82cb69&lt;/a&gt; &lt;a href=&quot;https://github.com/apache/cassandra/commit/fdc422c16fa6bc4a534f3b8636e016b0fa1174f3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/fdc422c16fa6bc4a534f3b8636e016b0fa1174f3&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Added unit test&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>