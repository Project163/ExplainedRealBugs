<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:15:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15358] LARGE_MESSAGE connection allocates heap buffer when BufferPool exhausted</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15358</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Hitting a bug with cassandra 4 alpha version. The same bug is repeated with difefrent version of Java(8,11 &amp;amp;12) &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Stack trace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO [main] 2019-10-11 16:07:12,024 Server.java:164 - Starting listening &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; CQL clients on /1.3.0.6:9042 (unencrypted)...
WARN [OptionalTasks:1] 2019-10-11 16:07:13,961 CassandraRoleManager.java:343 - CassandraRoleManager skipped &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; role setup: some nodes were not ready
INFO [OptionalTasks:1] 2019-10-11 16:07:13,961 CassandraRoleManager.java:369 - Setup task failed with error, rescheduling
WARN [Messaging-EventLoop-3-2] 2019-10-11 16:07:22,038 NoSpamLogger.java:94 - 10.3x.4x.5x:7000-&amp;gt;1.3.0.5:7000-LARGE_MESSAGES-[no-channel] dropping message of type PING_REQ whose timeout expired before reaching the network
WARN [OptionalTasks:1] 2019-10-11 16:07:23,963 CassandraRoleManager.java:343 - CassandraRoleManager skipped &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; role setup: some nodes were not ready
INFO [OptionalTasks:1] 2019-10-11 16:07:23,963 CassandraRoleManager.java:369 - Setup task failed with error, rescheduling
INFO [Messaging-EventLoop-3-6] 2019-10-11 16:07:32,759 NoSpamLogger.java:91 - 10.3x.4x.5x:7000-&amp;gt;1.3.0.2:7000-URGENT_MESSAGES-[no-channel] failed to connect
io.netty.channel.AbstractChannel$AnnotatedConnectException: finishConnect(..) failed: Connection refused: /1.3.0.2:7000
Caused by: java.net.ConnectException: finishConnect(..) failed: Connection refused
at io.netty.channel.unix.Errors.throwConnectException(Errors.java:124)
at io.netty.channel.unix.Socket.finishConnect(Socket.java:243)
at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe.doFinishConnect(AbstractEpollChannel.java:667)
at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe.finishConnect(AbstractEpollChannel.java:644)
at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe.epollOutReady(AbstractEpollChannel.java:524)
at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:414)
at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:326)
at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834)

WARN [Messaging-EventLoop-3-3] 2019-10-11 16:11:32,639 NoSpamLogger.java:94 - 1.3.4.6:7000-&amp;gt;1.3.4.5:7000-URGENT_MESSAGES-[no-channel] dropping message of type GOSSIP_DIGEST_SYN whose timeout expired before reaching the network
INFO [Messaging-EventLoop-3-18] 2019-10-11 16:11:33,077 NoSpamLogger.java:91 - 1.3.4.5:7000-&amp;gt;1.3.4.4:7000-URGENT_MESSAGES-[no-channel] failed to connect
&#160;
ERROR [Messaging-EventLoop-3-11] 2019-10-10 01:34:34,407 InboundMessageHandler.java:657 - 1.3.4.5:7000-&amp;gt;1.3.4.8:7000-LARGE_MESSAGES-0b7d09cd unexpected exception caught &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing inbound messages; terminating connection
java.lang.IllegalArgumentException: initialBuffer is not a direct buffer.
at io.netty.buffer.UnpooledDirectByteBuf.&amp;lt;init&amp;gt;(UnpooledDirectByteBuf.java:87)
at io.netty.buffer.UnpooledUnsafeDirectByteBuf.&amp;lt;init&amp;gt;(UnpooledUnsafeDirectByteBuf.java:59)
at org.apache.cassandra.net.BufferPoolAllocator$Wrapped.&amp;lt;init&amp;gt;(BufferPoolAllocator.java:95)
at org.apache.cassandra.net.BufferPoolAllocator.newDirectBuffer(BufferPoolAllocator.java:56)
at io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:187)
at io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:178)
at io.netty.channel.unix.PreferredDirectByteBufAllocator.ioBuffer(PreferredDirectByteBufAllocator.java:53)
at io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator$MaxMessageHandle.allocate(DefaultMaxMessagesRecvByteBufAllocator.java:114)
at io.netty.channel.epoll.EpollRecvByteAllocatorHandle.allocate(EpollRecvByteAllocatorHandle.java:75)
at io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:777)
at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:424)
at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:326)
at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:835)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13262655">CASSANDRA-15358</key>
            <summary>LARGE_MESSAGE connection allocates heap buffer when BufferPool exhausted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="SRAM85">Santhosh Kumar Ramalingam</reporter>
                        <labels>
                            <label>4.0</label>
                            <label>alpha</label>
                    </labels>
                <created>Wed, 16 Oct 2019 15:39:39 +0000</created>
                <updated>Fri, 15 May 2020 08:54:31 +0000</updated>
                            <resolved>Fri, 10 Apr 2020 00:32:12 +0000</resolved>
                                        <fixVersion>4.0-alpha4</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Test/benchmark</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>16</watches>
                                                                                                                <comments>
                            <comment id="16961888" author="benedict" created="Tue, 29 Oct 2019 10:53:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SRAM85&quot; class=&quot;user-hover&quot; rel=&quot;SRAM85&quot;&gt;SRAM85&lt;/a&gt;, could you provide some reproduction steps, and other environmental information?&lt;/p&gt;

&lt;p&gt;I cannot see an easy way for this to happen without the &lt;tt&gt;cassandra.test.disable_buffer_pool&lt;/tt&gt; system property being set.&lt;/p&gt;</comment>
                            <comment id="16964055" author="progval" created="Thu, 31 Oct 2019 14:03:48 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I had a similar issue earlier today. It was triggered by a client using a code similar to this one: &lt;a href=&quot;https://docs.datastax.com/en/developer/python-driver/3.20/query_paging/#handling-paged-results-with-callbacks&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://docs.datastax.com/en/developer/python-driver/3.20/query_paging/#handling-paged-results-with-callbacks&lt;/a&gt; with these changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;typo fix (&#160;&lt;tt&gt;handle_err&lt;/tt&gt; -&amp;gt; &#160;&lt;tt&gt;handle_error&lt;/tt&gt;)&lt;/li&gt;
	&lt;li&gt;&#160;&lt;tt&gt;&quot;SELECT * FROM users&quot;&lt;/tt&gt; replaced with&#160; &lt;tt&gt;SimpleStatement(&quot;SELECT * FROM revision&quot;, fetch_size=100)&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The table I&apos;m querying had ~1 billion keys, and is defined with:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TYPE IF NOT EXISTS person (
    fullname    blob,
    name        blob,
    email       blob
);

CREATE TYPE IF NOT EXISTS microtimestamp (
    seconds             bigint,
    microseconds        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
);

CREATE TYPE IF NOT EXISTS microtimestamp_with_timezone (
    timestamp           frozen&amp;lt;microtimestamp&amp;gt;,
    offset              smallint,
    negative_utc        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;
);

CREATE TABLE IF NOT EXISTS revision (
    id                              blob PRIMARY KEY,
    date                            microtimestamp_with_timezone,
    committer_date                  microtimestamp_with_timezone,
    type                            ascii,
    directory                       blob,
    message                         blob,
    author                          person,
    committer                       person,
    parents                         frozen&amp;lt;list&amp;lt;blob&amp;gt;&amp;gt;,
    synthetic                       &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,
    metadata                        text
);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Cluster was initially created with Cassandra 3.11.4, but was migrated to 4.0-alpha1 a few weeks ago. There are four nodes in my cluster, and no replication.&lt;/p&gt;

&lt;p&gt;cassandra.yaml was the same as the one shipped with 4.0-alpha1, except for some paths/IP changes, and these changes:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
concurrent_reads: 32
concurrent_writes: 64
concurrent_counter_writes: 32
trickle_fsync: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
enable_user_defined_functions: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After a restart, I am unable to reproduce the issue, so I cannot tell if the issue was caused by my config.&lt;/p&gt;</comment>
                            <comment id="16964217" author="benedict" created="Thu, 31 Oct 2019 17:14:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=progval&quot; class=&quot;user-hover&quot; rel=&quot;progval&quot;&gt;progval&lt;/a&gt; do you have your stack trace to hand, to confirm it&apos;s precisely the same issue?&lt;/p&gt;</comment>
                            <comment id="16964366" author="progval" created="Thu, 31 Oct 2019 20:12:07 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  [Messaging-EventLoop-3-8] 2019-10-31 14:02:31,917 InboundConnectionInitiator.java:450 - 128.93.66.187:7000(128.93.66.187:43306)-&amp;gt;128.93.66.190:7000-LARGE_MESSAGES-d60d4cc1 connection established, version = 12, framing = CRC, encryption = disabled
ERROR [Messaging-EventLoop-3-8] 2019-10-31 14:02:31,920 InboundMessageHandler.java:657 - 128.93.66.187:7000-&amp;gt;128.93.66.190:7000-LARGE_MESSAGES-d60d4cc1 unexpected exception caught &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing inbound messages; terminating connection
java.lang.IllegalArgumentException: initialBuffer is not a direct buffer.
        at io.netty.buffer.UnpooledDirectByteBuf.&amp;lt;init&amp;gt;(UnpooledDirectByteBuf.java:87)
        at io.netty.buffer.UnpooledUnsafeDirectByteBuf.&amp;lt;init&amp;gt;(UnpooledUnsafeDirectByteBuf.java:59)
        at org.apache.cassandra.net.BufferPoolAllocator$Wrapped.&amp;lt;init&amp;gt;(BufferPoolAllocator.java:95)
        at org.apache.cassandra.net.BufferPoolAllocator.newDirectBuffer(BufferPoolAllocator.java:56)
        at io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:187)
        at io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:178)
        at io.netty.channel.unix.PreferredDirectByteBufAllocator.ioBuffer(PreferredDirectByteBufAllocator.java:53)
        at io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator$MaxMessageHandle.allocate(DefaultMaxMessagesRecvByteBufAllocator.java:114)
        at io.netty.channel.epoll.EpollRecvByteAllocatorHandle.allocate(EpollRecvByteAllocatorHandle.java:75)
        at io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:777)
        at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe$1.run(AbstractEpollChannel.java:382)
        at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:163)
        at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:416)
        at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:331)
        at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
        at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
        at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834)
DEBUG [Native-Transport-Requests-1] 2019-10-31 14:02:41,855 ReadCallback.java:114 - Timed out; received 0 of 1 responses

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16965153" author="sram85" created="Fri, 1 Nov 2019 23:21:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;, below is the setup&lt;/p&gt;

&lt;p&gt;Hardware - Azure vms L series (nvme&apos;s)&lt;/p&gt;

&lt;p&gt;OS - CentOS 7.6&lt;/p&gt;

&lt;p&gt;JDK - Java8,11,12,13&lt;/p&gt;

&lt;p&gt;GC collector - G!GC,ZGC&lt;/p&gt;

&lt;p&gt;Test conditions and results:&lt;/p&gt;

&lt;p&gt;TLP-Stress : Keyvalue&#160;&lt;/p&gt;

&lt;p&gt;/usr/local/bin/tlp-stress run KeyValue -n 10b -t 400 --cl LOCAL_ONE --compaction lcs --ho 1.3.0.6 --port 9042 -r 0.0 --field.keyvalue.value=&apos;book(3000,5000)&apos;&lt;/p&gt;

&lt;p&gt;Result : Ran absolutely fantastic no issues , throughput has gone upto 1.2milllion write ops with latency&#160; ~300microseconds.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;App test: Spark job (real production application)&lt;/p&gt;

&lt;p&gt;no of columns : 100&lt;/p&gt;

&lt;p&gt;batch size : 100&lt;/p&gt;

&lt;p&gt;local_quorum&lt;/p&gt;

&lt;p&gt;RF 3&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Result: we run into the above exception. The nodes are not failing anymore but then the latency and throughput is impacted. we are only able to do 30k write ops with latency up to 80ms.&lt;/p&gt;</comment>
                            <comment id="16966709" author="progval" created="Mon, 4 Nov 2019 14:49:06 +0000"  >&lt;p&gt;I am actually able to reproduce the issue (this allowed me to trim down the config I posted above).&lt;/p&gt;

&lt;p&gt;Restarts temporarily solve the issue, but after a couple million records fetched with the script above, the error happens again on one of the nodes; and keeps happening every time I run the query, until I restart the node.&lt;/p&gt;

&lt;p&gt;I just upgraded to 4.0-alpha2, and the problem is unchanged.&lt;/p&gt;</comment>
                            <comment id="16966714" author="benedict" created="Mon, 4 Nov 2019 14:51:57 +0000"  >&lt;p&gt;Interesting. Could you:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Find the log line that begins with &quot;Global buffer pool is enabled, when pool is exhausted&quot; and reproduce it in its entirety here?&lt;/li&gt;
	&lt;li&gt;Find if you have any log lines beginning with &quot;Maximum memory usage reached&quot; and reproduce them here?&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16966733" author="progval" created="Mon, 4 Nov 2019 15:10:20 +0000"  >&lt;p&gt;1:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO [SSTableBatchOpen:1] 2019-11-04 16:02:29,594 BufferPool.java:216 - Global buffer pool is enabled, when pool is exhausted (max is 512.000MiB) it will allocate on heap&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;2:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  [ReadStage-1] 2019-11-04 16:04:57,612 NoSpamLogger.java:91 - Maximum memory usage reached (512.000MiB), cannot allocate chunk of 8.000MiB
ERROR [Messaging-EventLoop-3-1] 2019-11-04 16:06:40,133 InboundMessageHandler.java:657 - 128.93.66.191:7000-&amp;gt;128.93.64.42:7000-LARGE_MESSAGES-0b6d3aaa unexpected exception caught &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing inbound messages; terminating connection
java.lang.IllegalArgumentException: initialBuffer is not a direct buffer. 
       at io.netty.buffer.UnpooledDirectByteBuf.&amp;lt;init&amp;gt;(UnpooledDirectByteBuf.java:87)
       at io.netty.buffer.UnpooledUnsafeDirectByteBuf.&amp;lt;init&amp;gt;(UnpooledUnsafeDirectByteBuf.java:59)
[...]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16966811" author="benedict" created="Mon, 4 Nov 2019 16:41:00 +0000"  >&lt;p&gt;Does &quot;&lt;tt&gt;Maximum memory usage reached&lt;/tt&gt;&quot; always precede the first &quot;&lt;tt&gt;java.lang.IllegalArgumentException: initialBuffer is not a direct buffer.&lt;/tt&gt;&quot;?&lt;/p&gt;

&lt;p&gt;There&apos;s a bug I spotted on inspection, but it shouldn&apos;t be possible to encounter, as it would entail converting the heap &lt;tt&gt;ByteBuffer&lt;/tt&gt; allocated by the first message to a read only &lt;tt&gt;ByteBuffer&lt;/tt&gt; before being recycled into the &lt;tt&gt;BufferPool&lt;/tt&gt;, causing it to be treated as though it were a &lt;tt&gt;DirectByteBuffer&lt;/tt&gt;.  I cannot imagine a scenario where this could happen, but that doesn&apos;t mean that it doesn&apos;t.  I will upload a branch to see if fixing this resolves the problem.&lt;/p&gt;</comment>
                            <comment id="16966832" author="progval" created="Mon, 4 Nov 2019 17:06:27 +0000"  >&lt;p&gt;&amp;gt; Does &quot;&lt;tt&gt;Maximum memory usage reached&lt;/tt&gt;&quot; always precede the first &quot;&lt;tt&gt;java.lang.IllegalArgumentException: initialBuffer is not a direct buffer.&lt;/tt&gt;&quot;?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Yes, &quot;Maximum memory usage reached&quot; is always printed right before the exception is printed for the first time (except for one occurence where there&apos;s some chatter about slow requests).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If I run my query again without restarting the process, the exception is raised again, without &quot;Maximum memory usage reached&quot; before it.&lt;/p&gt;

&lt;p&gt;&quot;Maximum memory usage reached&quot; does get printed again every ~15min if I leave the process running, though.&lt;/p&gt;</comment>
                            <comment id="16967610" author="benedict" created="Tue, 5 Nov 2019 15:24:55 +0000"  >&lt;p&gt;Could you try running the following branch? &lt;a href=&quot;https://github.geo.apple.com/belliottsmith/cassandra/tree/15358&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;15358&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It is based on trunk, so let me know if you would prefer it rebased to &lt;tt&gt;4.0-alpha1&lt;/tt&gt; or &lt;tt&gt;4.0-alpha2&lt;/tt&gt;, though I don&apos;t believe a great deal has changed since.&lt;/p&gt;

&lt;p&gt;Given the log statements, there&apos;s a good chance this is the problem.  Even though I still think it&apos;s nearly impossible for a read-only buffer to be created and returned to the pool, I cannot find another more plausible cause.  If this doesn&apos;t fix the problem, I&apos;ll see if I can put together a debug build that can maybe report where this &lt;tt&gt;ByteBuffer&lt;/tt&gt; materialises from.&lt;/p&gt;</comment>
                            <comment id="16967677" author="sram85" created="Tue, 5 Nov 2019 16:54:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Our spark test was run on the version taken from the trunk.&#160;&lt;/p&gt;</comment>
                            <comment id="16968448" author="progval" created="Wed, 6 Nov 2019 15:42:08 +0000"  >&lt;p&gt;I compiled a .jar from your commit (`CASSANDRA_USE_JDK11=true ant`) and copied the .jar in place of the one from the release.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;There is no change:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  [ReadStage-1] 2019-11-06 16:36:16,308 NoSpamLogger.java:91 - Maximum memory usage reached (512.000MiB), cannot allocate chunk of 8.000MiB
ERROR [Messaging-EventLoop-3-8] 2019-11-06 16:38:12,051 InboundMessageHandler.java:656 - 128.93.66.191:7000-&amp;gt;128.93.64.42:7000-LARGE_MESSAGES-0890f5a2 unexpected exception caught &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing inbound messages; terminating connection
java.lang.IllegalArgumentException: initialBuffer is not a direct buffer.
	at io.netty.buffer.UnpooledDirectByteBuf.&amp;lt;init&amp;gt;(UnpooledDirectByteBuf.java:87)
	at io.netty.buffer.UnpooledUnsafeDirectByteBuf.&amp;lt;init&amp;gt;(UnpooledUnsafeDirectByteBuf.java:59)
	at org.apache.cassandra.net.BufferPoolAllocator$Wrapped.&amp;lt;init&amp;gt;(BufferPoolAllocator.java:95)
	at org.apache.cassandra.net.BufferPoolAllocator.newDirectBuffer(BufferPoolAllocator.java:56)
	at io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:187)
	at io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:178)
	at io.netty.channel.unix.PreferredDirectByteBufAllocator.ioBuffer(PreferredDirectByteBufAllocator.java:53)
	at io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator$MaxMessageHandle.allocate(DefaultMaxMessagesRecvByteBufAllocator.java:114)
	at io.netty.channel.epoll.EpollRecvByteAllocatorHandle.allocate(EpollRecvByteAllocatorHandle.java:75)
	at io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:777)
	at io.netty.channel.epoll.AbstractEpollChannel$AbstractEpollUnsafe$1.run(AbstractEpollChannel.java:382)
	at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:163)
	at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:416)
	at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:331)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834)
DEBUG [Native-Transport-Requests-1] 2019-11-06 16:38:21,922 ReadCallback.java:114 - Timed out; received 0 of 1 responses

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16968457" author="benedict" created="Wed, 6 Nov 2019 15:51:28 +0000"  >&lt;p&gt;Just to confirm: you did restart the process after replacing the jar? (sorry if this is a silly question, it&apos;s just that this problem might turn into quite the wild goose chase, so want to be absolutely sure)&lt;/p&gt;</comment>
                            <comment id="16968460" author="benedict" created="Wed, 6 Nov 2019 15:53:31 +0000"  >&lt;p&gt;Could you also, as one last debug effort, try setting the following config property?&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;buffer_pool_use_heap_if_exhausted: false&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16968473" author="progval" created="Wed, 6 Nov 2019 16:05:56 +0000"  >&lt;p&gt;&amp;gt; you did restart the process after replacing the jar?&lt;/p&gt;

&lt;p&gt;Yes. (Don&apos;t worry I know what it feels like debugging this kind of issues remotely)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&amp;gt; Could you also, as one last debug effort, try setting the following config property?&lt;br/&gt;
 &lt;tt&gt;&amp;gt; buffer_pool_use_heap_if_exhausted: false&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;No apparent change. Here is the new stack trace, in case you see a difference:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  [ReadStage-1] 2019-11-06 17:02:16,511 NoSpamLogger.java:91 - Maximum memory usage reached (512.000MiB), cannot allocate chunk of 8.000MiB
ERROR [Messaging-EventLoop-3-8] 2019-11-06 17:04:06,423 InboundMessageHandler.java:656 - 128.93.66.191:7000-&amp;gt;128.93.64.42:7000-LARGE_MESSAGES-b5938d12 unexpected exception caught &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; processing inbound messages; terminating connection
java.lang.IllegalArgumentException: initialBuffer is not a direct buffer.
	at io.netty.buffer.UnpooledDirectByteBuf.&amp;lt;init&amp;gt;(UnpooledDirectByteBuf.java:87)
	at io.netty.buffer.UnpooledUnsafeDirectByteBuf.&amp;lt;init&amp;gt;(UnpooledUnsafeDirectByteBuf.java:59)
	at org.apache.cassandra.net.BufferPoolAllocator$Wrapped.&amp;lt;init&amp;gt;(BufferPoolAllocator.java:95)
	at org.apache.cassandra.net.BufferPoolAllocator.newDirectBuffer(BufferPoolAllocator.java:56)
	at io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:187)
	at io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:178)
	at io.netty.channel.unix.PreferredDirectByteBufAllocator.ioBuffer(PreferredDirectByteBufAllocator.java:53)
	at io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator$MaxMessageHandle.allocate(DefaultMaxMessagesRecvByteBufAllocator.java:114)
	at io.netty.channel.epoll.EpollRecvByteAllocatorHandle.allocate(EpollRecvByteAllocatorHandle.java:75)
	at io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:777)
	at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:424)
	at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:326)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:918)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(Only tried with the jar compiled from your commit)&lt;/p&gt;</comment>
                            <comment id="16968478" author="benedict" created="Wed, 6 Nov 2019 16:12:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;No apparent change. Here is the new stack trace, in case you see a change:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm, that&apos;s &lt;em&gt;really&lt;/em&gt; interesting.  That rules out any of the remotely plausible scenario I can imagine.  I&apos;m going to go and take another look at the code, and see what the best debug build is that I can put together to figure out what&apos;s happening here.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Yes. (Don&apos;t worry I know what it feels like debugging this kind of issues remotely)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for being understanding &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16968540" author="benedict" created="Wed, 6 Nov 2019 17:39:10 +0000"  >&lt;p&gt;Could you grep your log for every instance of this exception, and post them as a file to the ticket?&lt;/p&gt;</comment>
                            <comment id="16968579" author="progval" created="Wed, 6 Nov 2019 18:19:52 +0000"  >&lt;p&gt;I just tried adding some assertions and logging, and it gives interesting/weird results, see attachments: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12985097/12985097_verbose_logs.diff&quot; title=&quot;verbose_logs.diff attached to CASSANDRA-15358&quot;&gt;verbose_logs.diff&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &#160; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12985098/12985098_verbose_logs.txt&quot; title=&quot;verbose_logs.txt attached to CASSANDRA-15358&quot;&gt;verbose_logs.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;. I hope this will help.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Results of all instances of this exception (captured with `zgrep IllegalArgumentException apache-cassandra-4.0-alpha2/logs/debug.log* -A 20 -B 3`): &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12985099/12985099_all_errors.txt&quot; title=&quot;all_errors.txt attached to CASSANDRA-15358&quot;&gt;all_errors.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16968650" author="benedict" created="Wed, 6 Nov 2019 19:54:40 +0000"  >&lt;p&gt;Sorry, just for my sanity can you corroborate that the config setting is being picked up, and reproduce the log line &quot;&lt;tt&gt;Global buffer pool is enabled, when pool is exhausted&lt;/tt&gt;&quot; from the latest run(s)?&lt;/p&gt;</comment>
                            <comment id="16968663" author="benedict" created="Wed, 6 Nov 2019 20:15:01 +0000"  >&lt;p&gt;Nevermind.  I have found the problem, it was right there all along, hiding in plain sight.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;BufferPool&lt;/tt&gt; API needs to be cleaned up, as it&apos;s too easy to pass the wrong parameter.  In this case &lt;tt&gt;LocalBufferPoolAllocator.getAtLeast&lt;/tt&gt; requests an on-heap buffer &lt;em&gt;when the pool is exhausted&lt;/em&gt;.  So you can reproduce this easily on the &lt;tt&gt;LARGE_MESSAGE&lt;/tt&gt; connection.&lt;/p&gt;

&lt;p&gt;Sorry, this should have been easier to spot.  Thanks for the report, I will upload a fix shortly, and then follow-up with a modest refactor of &lt;tt&gt;BufferPool&lt;/tt&gt;.  I may also simply remove entirely the option for on-heap buffers, since there&apos;s only one place this is permitted that isn&apos;t a clear mistake, and it&apos;s not clearly beneficial there.&lt;/p&gt;</comment>
                            <comment id="16968666" author="benedict" created="Wed, 6 Nov 2019 20:17:21 +0000"  >&lt;p&gt;I&apos;ve pushed a fix to the branch.  Thank you for your patience in helping to diagnose it.&lt;/p&gt;</comment>
                            <comment id="16968684" author="benedict" created="Wed, 6 Nov 2019 20:32:56 +0000"  >&lt;p&gt;I&apos;ve also pushed some follow-up cleanups.  Not as much as I would like - I think I would prefer to entirely remove on-heap &lt;tt&gt;ByteBuffer&lt;/tt&gt; from &lt;tt&gt;BufferPool&lt;/tt&gt; entirely.  But at least now it is explicit what type you are requesting, by provision of enum, and you only get that type of buffer back.  Only one place in the codebase uses on-heap buffers here, and that is &lt;tt&gt;Deflate&lt;/tt&gt;.  I&apos;m sure we could get a compatible &lt;tt&gt;Deflate&lt;/tt&gt; implementation and remove this cruft.&lt;/p&gt;</comment>
                            <comment id="16968685" author="benedict" created="Wed, 6 Nov 2019 20:35:31 +0000"  >&lt;p&gt;On a separate note, this issue is also implicitly related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15229&quot; title=&quot;Segregate Network and Chunk Cache BufferPools and Recirculate Partially Freed Chunks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15229&quot;&gt;&lt;del&gt;CASSANDRA-15229&lt;/del&gt;&lt;/a&gt;, as the &lt;tt&gt;ChunkCache&lt;/tt&gt; is over-committing &lt;tt&gt;BufferPool&lt;/tt&gt; resources, leaving none for the remainder of the application.  So we must go to &lt;tt&gt;malloc&lt;/tt&gt; for memory each time.&lt;/p&gt;</comment>
                            <comment id="16969232" author="progval" created="Thu, 7 Nov 2019 13:06:14 +0000"  >&lt;p&gt;Thanks you for you help!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Unfortunately, I tried running from either of the last two commits of your branch (da3f8d521f556b521f6cb0bdc6abefde87df734f and c15cade21665d34665217a76911979763f909414), and it doesn&apos;t fix the issue&lt;/p&gt;</comment>
                            <comment id="16969284" author="benedict" created="Thu, 7 Nov 2019 14:15:24 +0000"  >&lt;p&gt;Hmm.  A colleague managed to reproduce this, and the patch fixed the issue for them.  I guess there could be another source of issue, but this looked to fully explain the behaviour you were witnessing, particularly the coincidence with the LARGE_MESSAGE connection and exhaustion.&lt;/p&gt;</comment>
                            <comment id="16969297" author="progval" created="Thu, 7 Nov 2019 14:27:15 +0000"  >&lt;p&gt;I missed the rebase on -alpha3, so I kept installing the .jar I compiled yesterday instead of the one compiled today.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;It works now, thanks a lot!&lt;/p&gt;</comment>
                            <comment id="16969300" author="benedict" created="Thu, 7 Nov 2019 14:30:58 +0000"  >&lt;p&gt;Fantastic.  Thanks for your assistance diagnosing the issue!&lt;/p&gt;</comment>
                            <comment id="16990021" author="sermandurai" created="Fri, 6 Dec 2019 17:43:40 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&#160;for fixing it. We are testing this change and will update you in a day time whether we are seeing this issue (context: Me and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=SRAM85&quot; class=&quot;user-hover&quot; rel=&quot;SRAM85&quot;&gt;SRAM85&lt;/a&gt;&#160;are in same project)&lt;/p&gt;

&lt;p&gt;When this change will be merged to master trunk and also when is the first stable cassandra 4 version release is expected.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="16992601" author="benedict" created="Tue, 10 Dec 2019 14:29:24 +0000"  >&lt;p&gt;I&apos;m afraid I don&apos;t know the answer to either question.  I&apos;m waiting for a review for the fix to be merged into trunk, and maybe I can try to accelerate that by poking some colleagues.  However a stable release of 4.0 is probably months away, given current community resources and where they are focused.&lt;/p&gt;

&lt;p&gt;nb: it&apos;s worth noting this delay is partially attributable to the community aiming for a much lower defect rate in the first GA release of this major version, and a large amount of effort is currently being invested in automated testing.  Depending on your prior approach to GA releases you might be comfortable treating a beta or RC release as usable, which I hope will come much sooner.&lt;/p&gt;</comment>
                            <comment id="17021835" author="g-ashok" created="Thu, 23 Jan 2020 07:50:37 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I also experienced this error while testing out 4.alpha2 version.&#160;&lt;/p&gt;

&lt;p&gt;I have been testing the incremental repair.&lt;/p&gt;

&lt;p&gt;In one of the test a node was missing 30GB of data. (~ 100GB total data, #nodes = 3, rf = 3). Soon after starting the repair, I get this exception and the repair process stops making any progress.&lt;/p&gt;

&lt;p&gt;I do get &quot;Maximum memory usage reached (2.000GiB), cannot allocate chunk of 8.000MiB&quot; before the exception.&lt;/p&gt;

&lt;p&gt;I am attaching the trace of a repair process and the debug logs.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12991611/12991611_repair_1_trace.txt&quot; title=&quot;repair_1_trace.txt attached to CASSANDRA-15358&quot;&gt;repair_1_trace.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12991613/12991613_debug_logs_during_repair.txt&quot; title=&quot;debug_logs_during_repair.txt attached to CASSANDRA-15358&quot;&gt;debug_logs_during_repair.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17044603" author="dcapwell" created="Tue, 25 Feb 2020 15:51:39 +0000"  >&lt;p&gt;I&#8217;ll try to start review later today &lt;/p&gt;</comment>
                            <comment id="17047034" author="dcapwell" created="Thu, 27 Feb 2020 23:17:01 +0000"  >&lt;p&gt;Update (I am not ignoring this patch!)&lt;/p&gt;

&lt;p&gt;I am making sure we have tests which are able to confirm the reported issue (I did manually, I want our tests to as well).  My tests are now able to hit it frequently but there was one thing that popped up that I want to debug a bit more before really getting into the change; I hope to get back to this tomorrow.&lt;/p&gt;</comment>
                            <comment id="17048373" author="benedict" created="Sat, 29 Feb 2020 19:04:55 +0000"  >&lt;p&gt;rebased and pushed &lt;a href=&quot;http://github.com/belliottsmith/cassandra/tree/15358&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17049851" author="dcapwell" created="Tue, 3 Mar 2020 02:45:31 +0000"  >&lt;p&gt;Been running this for a while and the patch does look to resolve it; no longer able to replicate.&lt;/p&gt;

&lt;p&gt;Ill dive into the code tomorrow.&lt;/p&gt;</comment>
                            <comment id="17050728" author="dcapwell" created="Wed, 4 Mar 2020 03:08:07 +0000"  >&lt;p&gt;Sorry its been so long...&lt;/p&gt;

&lt;p&gt;I put this under load several times without the patch and replicated with easy, and with the patch I am no longer able to replicate.  I want to do one more test where I set the pool to be 0 or 1mb, just to see if I can flesh out any more issues.&lt;/p&gt;

&lt;p&gt;As far as I can tell the core change which appears to fix the issue is &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:15358#diff-613d97c28af63fff3cf1f52baa7f6caaR647&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;; we switch from heap buffers to direct buffers when out of space and org.apache.cassandra.utils.memory.BufferPool.LocalPool#put(java.nio.ByteBuffer) will just release right away.&lt;/p&gt;

&lt;p&gt;General comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;+1 to removing ALLOCATE_ON_HEAP_WHEN_EXAHUSTED and DISABLED&lt;/li&gt;
	&lt;li&gt;I don&apos;t think it makes sense to have the get methods take a BufferType, if you write&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
get(42, BufferType.ON_HEAP) instanceOf HeapByteBuffer
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;you expect that to return true (it does) AND that its buffered (it is not).  I feel that every call to BufferPool with BufferType.ON_HEAP should instead just allocate the ByteBuffer directly; I do know that ChunkCache relies on this (figures out what type to do based off org.apache.cassandra.io.util.ChunkReader#preferredBufferType) but I don&apos;t feel it should in these cases. This is not a blocking comment and I am 100% fine if a different JIRA addresses.&lt;/p&gt;


&lt;p&gt;To be clear, I have not +1 because I want to test more, my goal is to sign off this week&lt;/p&gt;</comment>
                            <comment id="17051081" author="benedict" created="Wed, 4 Mar 2020 10:22:39 +0000"  >&lt;blockquote&gt;
&lt;p&gt;+1 to removing ALLOCATE_ON_HEAP_WHEN_EXAHUSTED and DISABLED&lt;br/&gt;
I don&apos;t think it makes sense to have the get methods take a BufferType, if you write&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Great, I&apos;ll rustle up a modified patch with those changes, as I agree.  At some point we might want to start offering pooled heap buffers (which would be a simple change), but there&apos;s no call for it at the moment, and I prefer to remove disused options.&lt;/p&gt;</comment>
                            <comment id="17051127" author="benedict" created="Wed, 4 Mar 2020 11:38:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t think it makes sense to have the get methods take a BufferType, if you write&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ok, so I went to do this and it&apos;s not trivial to do as part of this ticket.  I think the right thing to do is to entirely remove &lt;tt&gt;compressor.preferredBufferType()&lt;/tt&gt;, as the need for the parameter vanishes, but this means dropping support for &lt;tt&gt;Deflate&lt;/tt&gt;, at least for JDK8.  I would be fine requiring JDK11 for Deflate support in 4.0 though, WDYT?&lt;/p&gt;

&lt;p&gt;We anyway need to address the &lt;tt&gt;ChunkCache&lt;/tt&gt; use of &lt;tt&gt;BufferPool&lt;/tt&gt; in a separate ticket.&lt;/p&gt;

&lt;p&gt;We do have a simple option, which is to rename the &lt;tt&gt;get&lt;/tt&gt; method to e.g. &lt;tt&gt;getPooledIfOffHeap&lt;/tt&gt;, or renaming &lt;tt&gt;BufferPool&lt;/tt&gt; to &lt;tt&gt;OffHeapBufferPool&lt;/tt&gt; so that it&apos;s clear we never pool on-heap.  Or alternatively we could start pooling on-heap, but that should probably be a separate ticket (and is probably unjustified compared to the above options).&lt;/p&gt;</comment>
                            <comment id="17051402" author="dcapwell" created="Wed, 4 Mar 2020 16:43:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;but this means dropping support for Deflate, at least for JDK8. I would be fine requiring JDK11 for Deflate support in 4.0 though, WDYT?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We should support JDK8, that isn&apos;t going away any time soon and we would still be able to keep it even if it didn&apos;t use the pool.&lt;/p&gt;

&lt;p&gt;To be clear, my statement was that &quot;if you are requested unpooled buffers you should not be using this API&quot;, if you request a native buffer I am fine with using it (though would still prefer isolated memory, thats a different issue though &lt;sup&gt;_&lt;/sup&gt;).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We anyway need to address the ChunkCache use of BufferPool in a separate ticket.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Works for me, can you create a JIRA to address it and link with this one?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;rename the get method to e.g. getPooledIfOffHeap, or renaming BufferPool to OffHeapBufferPool so that it&apos;s clear we never pool on-heap&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The class rename makes the most sense to me (self documenting) but we would still need to guard access at the call sites&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ByteBuffer bb = compressor.preferredBufferType() == ON_HEAP ? ByteBuffer.allocate(size) : OffHeapBufferPool.get(size)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;Or alternatively we could start pooling on-heap, but that should probably be a separate ticket (and is probably unjustified compared to the above options).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This really should be a different JIRA.  There is still a lot of code which assumes the array isn&apos;t shared so would need to do a lot of work to find all those patterns and change them (found org.apache.cassandra.gms.TokenSerializer#serialize with a quick search, this isn&apos;t the only one).  &lt;/p&gt;

&lt;p&gt;In doing that scan, most of the sites which require array buffers could be changed to support native (or do and special case) as well which makes me ask a different question, &quot;why not drop array buffer support&quot;; again, different JIRA should tackle this question.&lt;/p&gt;</comment>
                            <comment id="17051418" author="benedict" created="Wed, 4 Mar 2020 16:57:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;We should support JDK8, that isn&apos;t going away any time soon and we would still be able to keep it even if it didn&apos;t use the pool.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We&apos;re only talking about dropping &lt;tt&gt;Deflate&lt;/tt&gt; support for JDK8, and I believe the project is unlikely to support JDK8 in our next major release anyway (since JDK8 is no longer freely supported).  Since &lt;tt&gt;Deflate&lt;/tt&gt; is very much not recommended, the restriction is minimal and solves this problem neatly.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;though would still prefer isolated memory&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;&quot;if you are requested unpooled buffers you should not be using this API&quot;,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;To also be clear, none of the users of this API when requesting &lt;tt&gt;ON_HEAP&lt;/tt&gt; really require it to be pooled.  There is no guarantee that &lt;tt&gt;get&lt;/tt&gt; must supply a pooled buffer, and in fact will not pool if the pool threshold has been exceeded (which can be modelled to be zero for heap buffers, which is a reasonable pool size given the very different impact on GC).&lt;/p&gt;

&lt;p&gt;So at best we want to reconfigure your expectations of a combination of method and class name to better self-document, or otherwise actual documention making it clear that &lt;tt&gt;get&lt;/tt&gt; only returns a pooled buffer for &lt;tt&gt;OFF_HEAP&lt;/tt&gt; would also be fine.  &lt;/p&gt;

&lt;p&gt;Literally none of this is a real issue in my book, and I am actually fine leaving this unchanged in all honesty, so I&apos;m not going to spend ages agonising over it.  The only thing I wish is that we do not even permit the option of &lt;tt&gt;ON_HEAP&lt;/tt&gt;, because it only exists for something nobody uses in practice, since &lt;tt&gt;Deflate&lt;/tt&gt; is a really bad idea (since it is cripplingly slow) and completely superseded by &lt;tt&gt;Zstd&lt;/tt&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Works for me, can you create a JIRA to address it and link with this one?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It already exists, you and I have even discussed it recently (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15229&quot; title=&quot;Segregate Network and Chunk Cache BufferPools and Recirculate Partially Freed Chunks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15229&quot;&gt;&lt;del&gt;CASSANDRA-15229&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="17053071" author="dcapwell" created="Fri, 6 Mar 2020 06:23:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;We&apos;re only talking about dropping Deflate support for JDK8&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Even then we should keep it; I don&apos;t disagree there is better.&lt;/p&gt;

&lt;p&gt;Sorry, I wanted to run the test this week but 3 things came up, ill try for next week but I may not be able to.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; if you could run the test that would be great =)&lt;/p&gt;</comment>
                            <comment id="17053198" author="benedict" created="Fri, 6 Mar 2020 09:20:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;Sorry, I wanted to run the test this week but 3 things came up, ill try for next week but I may not be able to.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What test?  From my perspective this patch is both ready to merge, and can wait (as I have other priorities right now), so probably not.&lt;/p&gt;</comment>
                            <comment id="17058240" author="dcapwell" created="Thu, 12 Mar 2020 20:46:45 +0000"  >&lt;p&gt;+1. tests look good, only issues that stand out look unrelated to this work.&lt;/p&gt;</comment>
                            <comment id="17065431" author="jasonstack" created="Tue, 24 Mar 2020 08:48:01 +0000"  >&lt;p&gt;Just FYI:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;BufferPoolTest#testBufferPoolDisabled&lt;/tt&gt; failed because we cannot disable buffer pool any more. Should we remove it?&lt;br/&gt;
 &lt;tt&gt;BufferPoolTest#testPageAligned&lt;/tt&gt; failed because &lt;tt&gt;testBufferPoolDisabled&lt;/tt&gt; didn&apos;t release the non-page-aligned buffer on failure.&lt;/p&gt;</comment>
                            <comment id="17071922" author="jmckenzie" created="Tue, 31 Mar 2020 16:01:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&#160;- anything I or others can do to help get this merged in? We&apos;re testing things and hitting this bug quite frequently.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12985099" name="all_errors.txt" size="195301" author="progval" created="Wed, 6 Nov 2019 18:18:59 +0000"/>
                            <attachment id="12991613" name="debug_logs_during_repair.txt" size="23803" author="G-Ashok" created="Thu, 23 Jan 2020 07:48:47 +0000"/>
                            <attachment id="12991611" name="repair_1_trace.txt" size="4762" author="G-Ashok" created="Thu, 23 Jan 2020 07:46:58 +0000"/>
                            <attachment id="12985097" name="verbose_logs.diff" size="4650" author="progval" created="Wed, 6 Nov 2019 18:14:33 +0000"/>
                            <attachment id="12985098" name="verbose_logs.txt" size="2840" author="progval" created="Wed, 6 Nov 2019 18:14:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12991" cascade-level="1"><![CDATA[Response Crash]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 33 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z07nls:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
        <customfieldvalue><![CDATA[djoshi]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/443bca18839268cd100930b380e0534b052a8c89&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/443bca18839268cd100930b380e0534b052a8c89&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;n/a - entirely removed causative mechanism&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>