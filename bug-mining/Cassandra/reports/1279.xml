<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:27:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3481] During repair, &quot;incorrect data size&quot; &amp; &quot;Connection reset&quot; errors. Repair unable to complete.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3481</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This has been happening since 1.0.2. I wasn&apos;t on 1.0 for very long but I&apos;m fairly certain repair was working ok. Repair worked decently for me in 0.8 (data bloat sucked). All my SSTables are version h.&lt;/p&gt;

&lt;p&gt;On one node:&lt;/p&gt;

&lt;p&gt;java.lang.AssertionError: incorrect row data size 596045 written to /mnt/cassandra/data/TRProd/Metrics1m-tmp-h-25036-Data.db; correct is 586675&lt;br/&gt;
	at org.apache.cassandra.io.sstable.SSTableWriter.appendFromStream(SSTableWriter.java:253)&lt;br/&gt;
	at org.apache.cassandra.streaming.IncomingStreamReader.streamIn(IncomingStreamReader.java:146)&lt;br/&gt;
	at org.apache.cassandra.streaming.IncomingStreamReader.read(IncomingStreamReader.java:87)&lt;br/&gt;
	at org.apache.cassandra.net.IncomingTcpConnection.stream(IncomingTcpConnection.java:184)&lt;br/&gt;
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:81)&lt;/p&gt;

&lt;p&gt;On the other node:&lt;/p&gt;

&lt;p&gt;4999 - 0%, /mnt/cassandra/data/TRProd/Metrics1m-h-24953-Data.db sections=1707 progress=0/1513497639 - 0%, /mnt/cassandra/data/TRProd/Metrics1m-h-25000-Data.db sections=635 progress=0/53400713 - 0%, /mnt/cassandra/data/TRProd/Metrics1m-h-25002-Data.db sections=570 progress=0/709993 - 0%, /mnt/cassandra/data/TRProd/Metrics1m-h-25003-Data.db sections=550 progress=0/449498 - 0%, /mnt/cassandra/data/TRProd/Metrics1m-h-25005-Data.db sections=516 progress=0/316301 - 0%], 6 sstables.&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamStage:1&amp;#93;&lt;/span&gt; 2011-11-09 19:45:22,795 StreamOutSession.java (line 203) Streaming to /10.38.69.192&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Streaming:1&amp;#93;&lt;/span&gt; 2011-11-09 19:47:47,964 AbstractCassandraDaemon.java (line 133) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Streaming:1,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: java.net.SocketException: Connection reset&lt;br/&gt;
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:34)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
Caused by: java.net.SocketException: Connection reset&lt;br/&gt;
	at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:96)&lt;br/&gt;
	at java.net.SocketOutputStream.write(SocketOutputStream.java:136)&lt;br/&gt;
	at com.ning.compress.lzf.ChunkEncoder.encodeAndWriteChunk(ChunkEncoder.java:133)&lt;br/&gt;
	at com.ning.compress.lzf.LZFOutputStream.writeCompressedBlock(LZFOutputStream.java:203)&lt;br/&gt;
	at com.ning.compress.lzf.LZFOutputStream.write(LZFOutputStream.java:97)&lt;br/&gt;
	at org.apache.cassandra.streaming.FileStreamTask.write(FileStreamTask.java:181)&lt;br/&gt;
	at org.apache.cassandra.streaming.FileStreamTask.stream(FileStreamTask.java:145)&lt;br/&gt;
	at org.apache.cassandra.streaming.FileStreamTask.runMayThrow(FileStreamTask.java:91)&lt;br/&gt;
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
	... 3 more&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Streaming:1&amp;#93;&lt;/span&gt; 2011-11-09 19:47:47,970 AbstractCassandraDaemon.java (line 133) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Streaming:1,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: java.net.SocketException: Connection reset&lt;br/&gt;
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:34)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
Caused by: java.net.SocketException: Connection reset&lt;br/&gt;
	at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:96)&lt;br/&gt;
	at java.net.SocketOutputStream.write(SocketOutputStream.java:136)&lt;br/&gt;
	at com.ning.compress.lzf.ChunkEncoder.encodeAndWriteChunk(ChunkEncoder.java:133)&lt;br/&gt;
	at com.ning.compress.lzf.LZFOutputStream.writeCompressedBlock(LZFOutputStream.java:203)&lt;br/&gt;
	at com.ning.compress.lzf.LZFOutputStream.write(LZFOutputStream.java:97)&lt;br/&gt;
	at org.apache.cassandra.streaming.FileStreamTask.write(FileStreamTask.java:181)&lt;br/&gt;
	at org.apache.cassandra.streaming.FileStreamTask.stream(FileStreamTask.java:145)&lt;br/&gt;
	at org.apache.cassandra.streaming.FileStreamTask.runMayThrow(FileStreamTask.java:91)&lt;br/&gt;
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
	... 3 more&lt;/p&gt;</description>
                <environment></environment>
        <key id="12530929">CASSANDRA-3481</key>
            <summary>During repair, &quot;incorrect data size&quot; &amp; &quot;Connection reset&quot; errors. Repair unable to complete.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="efalcao">Eric Falcao</reporter>
                        <labels>
                            <label>connection</label>
                            <label>repair</label>
                    </labels>
                <created>Wed, 9 Nov 2011 21:31:56 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:46 +0000</updated>
                            <resolved>Wed, 16 Nov 2011 13:39:47 +0000</resolved>
                                        <fixVersion>1.0.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13147561" author="slebresne" created="Thu, 10 Nov 2011 08:53:57 +0000"  >&lt;p&gt;What is in this &apos;Metrics&apos; column family? Is it normal columns, some expiring ones, super columns, counters?&lt;/p&gt;</comment>
                            <comment id="13147648" author="slebresne" created="Thu, 10 Nov 2011 12:56:42 +0000"  >&lt;p&gt;We do have a problem with counters that leads to that exact problem.&lt;/p&gt;

&lt;p&gt;During streaming, we must ensure that whatever we deserialize from the wire has the same size once reserialized. For counters, whenever we should have clean deltas, instead we just &apos;mark&apos; the delta to be clean in a way that doesn&apos;t change the size and let them be clean later. Problem is, if you stream a file that still have those &apos;marked&apos; delta, it will remove them, changing the size of the data and thus triggering the exception at end.&lt;/p&gt;

&lt;p&gt;Fixing this require knowing at deserialization that we are in this &apos;preserve the size&apos; mode. Attaching a patch for that. Instead of adding a new flag to deserialization, I replaced &apos;fromRemote&apos; boolean by an enum flag. The patch includes a unit test.&lt;/p&gt;</comment>
                            <comment id="13147693" author="jbellis" created="Thu, 10 Nov 2011 14:10:19 +0000"  >&lt;p&gt;is this 1.x only or 0.8 too?&lt;/p&gt;</comment>
                            <comment id="13147698" author="slebresne" created="Thu, 10 Nov 2011 14:16:19 +0000"  >&lt;p&gt;It&apos;s 1.x only as far as the bug is concerned (it&apos;s really linked to single-pass streaming). That being said, the bulk of the patch, i.e, replacing the fromRemote boolean by a Flag, could be backported in 0.8 for purpose of making future merge easier. But I&apos;m skeptical this is worth it.&lt;/p&gt;</comment>
                            <comment id="13147763" author="efalcao" created="Thu, 10 Nov 2011 15:27:00 +0000"  >&lt;p&gt;Metrics1m is a Counter CF. I originally tried CounterColumns with TTL&apos;s but was advised against it. They have no expiration.&lt;/p&gt;

&lt;p&gt;Let me know if I can be any more help. I might be able to try the patch a bit later in the day.&lt;/p&gt;</comment>
                            <comment id="13147872" author="jbellis" created="Thu, 10 Nov 2011 18:03:34 +0000"  >&lt;p&gt;Shouldn&apos;t IncomingStreamReader use PRESERVE_SIZE instead of FROM_REMOTE?&lt;/p&gt;

&lt;p&gt;What does the commented-out test do, and why is it commented out?&lt;/p&gt;

&lt;p&gt;nit: this comment needs updating:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;             // deserialize column with fromRemote false, in order to keep size of streamed column
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13147881" author="slebresne" created="Thu, 10 Nov 2011 18:19:39 +0000"  >&lt;p&gt;v2 attached&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Shouldn&apos;t IncomingStreamReader use PRESERVE_SIZE instead of FROM_REMOTE?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That would work too but we don&apos;t need to, because we won&apos;t echo the columns like in the other branch. So it&apos;s better to use FROM_REMOTE and have the counter delta cleaned right away rather than later (as this is slightly more efficient). I added a comment.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What does the commented-out test do, and why is it commented out?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Oups, attached the wrong patch. I just copied a previous test but commented it out when I realized it was simpler to just add a few lines into the existing test. v2 removes the commented-out one.&lt;/p&gt;</comment>
                            <comment id="13147888" author="jbellis" created="Thu, 10 Nov 2011 18:27:36 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13151192" author="slebresne" created="Wed, 16 Nov 2011 13:39:47 +0000"  >&lt;p&gt;Forgot to close this one but it&apos;s been committed already.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12503265" name="3481-v2.patch" size="35032" author="slebresne" created="Thu, 10 Nov 2011 18:19:39 +0000"/>
                            <attachment id="12503201" name="3481.patch" size="37160" author="slebresne" created="Thu, 10 Nov 2011 12:56:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>216667</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 1 week, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gkfj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94740</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>