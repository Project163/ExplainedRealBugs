<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:00:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11102] Data lost during compaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11102</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have experienced data loses in some tables during few weeks since update to cassandra 3.0. I thing I successfully found test case now. &lt;/p&gt;

&lt;p&gt;Step one - test table:&lt;/p&gt;

&lt;p&gt;CREATE TABLE aaa (&lt;br/&gt;
    r int,&lt;br/&gt;
    c1 int,&lt;br/&gt;
    c2 ascii,&lt;br/&gt;
    PRIMARY KEY (r, c1, c2));&lt;/p&gt;

&lt;p&gt;Step two - run few queries:&lt;/p&gt;

&lt;p&gt;	insert into aaa (r, c1, c2) values (1,2,&apos;A&apos;);&lt;br/&gt;
	delete from aaa where r=1 and c1=2 and c2=&apos;B&apos;;&lt;br/&gt;
	insert into aaa (r, c1, c2) values (2,3,&apos;A&apos;);&lt;br/&gt;
	delete from aaa where r=2 and c1=3 and c2=&apos;B&apos;;&lt;br/&gt;
	insert into aaa (r, c1, c2) values (3,4,&apos;A&apos;);&lt;br/&gt;
	delete from aaa where r=3 and c1=4 and c2=&apos;B&apos;;&lt;br/&gt;
	insert into aaa (r, c1, c2) values (4,5,&apos;A&apos;);&lt;br/&gt;
	delete from aaa where r=4 and c1=5 and c2=&apos;B&apos;;&lt;/p&gt;

&lt;p&gt;It creates 4 rows (select count says 4) and 4 tombstones.&lt;/p&gt;

&lt;p&gt;Step 3 - Restart Cassandra&lt;/p&gt;

&lt;p&gt;You will see new files written into C* data folder. I tried sstable-tools to print table structure, it shows 4 rows, data and tombstones are there.&lt;/p&gt;

&lt;p&gt;Step 4 - set GC grace to 1 to force tombstone removing during compaction.&lt;/p&gt;

&lt;p&gt;alter table aaa with GC_GRACE_SECONDS = 1;&lt;/p&gt;

&lt;p&gt;Step 5 - Compact tables&lt;/p&gt;

&lt;p&gt;./nodetool compact&lt;/p&gt;

&lt;p&gt;aaa files dissapeares during compaction. &lt;br/&gt;
select count&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; says 0&lt;br/&gt;
compaction history says&lt;br/&gt;
... aaa  2016-02-01T14:24:01.433   329   0   {}&lt;/p&gt;</description>
                <environment>&lt;p&gt;Cassandra 3.2.1 (single node, 5 node cluster)&lt;br/&gt;
JDK 8&lt;/p&gt;</environment>
        <key id="12935628">CASSANDRA-11102</key>
            <summary>Data lost during compaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="shinigami">Jaroslav Kamenik</reporter>
                        <labels>
                    </labels>
                <created>Mon, 1 Feb 2016 14:10:24 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:43 +0000</updated>
                            <resolved>Tue, 2 Feb 2016 13:35:51 +0000</resolved>
                                        <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.3</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="15126476" author="shinigami" created="Mon, 1 Feb 2016 16:17:07 +0000"  >&lt;p&gt;Another case:&lt;/p&gt;

&lt;p&gt;CREATE TABLE bbb (&lt;br/&gt;
    r int,&lt;br/&gt;
    c int,&lt;br/&gt;
    PRIMARY KEY (r, c));&lt;/p&gt;

&lt;p&gt;insert into bbb (r, c) values (1, 2);&lt;/p&gt;

&lt;p&gt;... pause&lt;/p&gt;

&lt;p&gt;delete from bbb where r=1 and c=2;&lt;br/&gt;
insert into bbb (r, c) values (2, 3);&lt;/p&gt;

&lt;p&gt;... pause&lt;/p&gt;

&lt;p&gt;delete from bbb where r=2 and c=3;&lt;br/&gt;
insert into bbb (r, c) values (1, 2);&lt;/p&gt;

&lt;p&gt;... pause&lt;/p&gt;

&lt;p&gt;delete from bbb where r=1 and c=2;&lt;br/&gt;
insert into bbb (r, c) values (2, 3);&lt;/p&gt;

&lt;p&gt;... pause&lt;/p&gt;

&lt;p&gt;delete from bbb where r=2 and c=3;&lt;br/&gt;
insert into bbb (r, c) values (1, 2);&lt;/p&gt;

&lt;p&gt;select * from bbb;&lt;/p&gt;

&lt;p&gt; r | c&lt;br/&gt;
--&lt;del&gt;+&lt;/del&gt;--&lt;br/&gt;
 1 | 2&lt;/p&gt;

&lt;p&gt;alter table bbb with GC_GRACE_SECONDS = 1;&lt;br/&gt;
restart&lt;br/&gt;
compact&lt;/p&gt;

&lt;p&gt;table is empty...&lt;/p&gt;</comment>
                            <comment id="15126804" author="krummas" created="Mon, 1 Feb 2016 18:59:43 +0000"  >&lt;p&gt;problem is that we collect the wrong maxLocalDeletionTime since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8099&quot; title=&quot;Refactor and modernize the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8099&quot;&gt;&lt;del&gt;CASSANDRA-8099&lt;/del&gt;&lt;/a&gt; if we don&apos;t have any regular columns (ie, columns not part of the clustering). (&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/rows/Rows.java#L77&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/rows/Rows.java#L77&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;pushed an ugly &quot;fix&quot; to show the problem here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/11102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/11102&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ll have another go tomorrow without a fried brain, unless &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; has an obvious fix for this&lt;/p&gt;</comment>
                            <comment id="15128037" author="slebresne" created="Tue, 2 Feb 2016 10:37:54 +0000"  >&lt;p&gt;I think all we want is to make sure we always update the deletion time stats if the row &lt;tt&gt;LivenessInfo&lt;/tt&gt; is not empty, so just removing the condition in &lt;tt&gt;MetadataCollection.update(LivenessInfo newInfo)&lt;/tt&gt; as in &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/11102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this patch&lt;/a&gt;. That&apos;s actually consistent with how we treat cells which makes sense. I&apos;ve started a run of CI on this to check if it&apos;s not breaking something else but they seems to be in the queue so I&apos;ll update once I get the results.&lt;/p&gt;</comment>
                            <comment id="15128079" author="krummas" created="Tue, 2 Feb 2016 11:12:35 +0000"  >&lt;p&gt;I did the same first, but it makes TTLExpiryTest.testCheckForExpiredSSTableBlockers fail. maxLocalDeletionTime for all sstables gets collected as Integer.MAX_VALUE. In this test we generate a single cell tombstone, which makes liveness info be non-expiring even if the row has tombstones&lt;/p&gt;</comment>
                            <comment id="15128129" author="slebresne" created="Tue, 2 Feb 2016 11:48:45 +0000"  >&lt;p&gt;Hum, but that&apos;s because the test is wrong. That is, &lt;tt&gt;RowUpdateUpdater&lt;/tt&gt; by default inserts a &quot;row marker&quot; (a non empty &lt;tt&gt;LivenessInfo&lt;/tt&gt;), so the delete done by that test is equivalent to doing both an insert for the partition key and a delete for just the &lt;tt&gt;col1&lt;/tt&gt; column, which definitively mean that the sstable should have a &lt;tt&gt;maxLocalDeletionTime&lt;/tt&gt; of &lt;tt&gt;MAX_VALUE&lt;/tt&gt;. I modified the test in my patch to do what it meant to do and no insert any row marker, and the test pass with those changes.&lt;/p&gt;</comment>
                            <comment id="15128155" author="krummas" created="Tue, 2 Feb 2016 12:15:57 +0000"  >&lt;p&gt;oh, alright, makes sense, +1&lt;/p&gt;</comment>
                            <comment id="15128228" author="slebresne" created="Tue, 2 Feb 2016 13:16:34 +0000"  >&lt;p&gt;Test on that last branch seems to look good for info (not sure why that &lt;tt&gt;RoleSyntaxTest.customOptionsSyntaxTest&lt;/tt&gt; unit test timeouted, but it&apos;s clearly unrelated and pass fine locally):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11102-testall/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;unit test&lt;/a&gt; &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11102-dtest/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15128254" author="slebresne" created="Tue, 2 Feb 2016 13:35:51 +0000"  >&lt;p&gt;Alright, committed thanks (I had forgotten to include a regression test in my commit but will commit said test right away).&lt;/p&gt;</comment>
                            <comment id="15136743" author="shinigami" created="Mon, 8 Feb 2016 09:34:45 +0000"  >&lt;p&gt;Hi guys,&lt;br/&gt;
we deployed 3.3-snapshot to our test cluster last week. Test case from this bug report was ok, but after 5 days compaction cleared part of one table again. It looks like some files are still there and some dissapeared during compaction (nodetool compactionhistory shows XXXX bytes read but 0 written). Before upgrade to 3.3 it was clean 3.2.1 instalation, no old sstables and so. It seems deletion happens 10 days (default gc_grace) after initial instalation. &lt;/p&gt;</comment>
                            <comment id="15136746" author="krummas" created="Mon, 8 Feb 2016 09:37:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=shinigami&quot; class=&quot;user-hover&quot; rel=&quot;shinigami&quot;&gt;shinigami&lt;/a&gt; you probably need to run &lt;tt&gt;nodetool upgradesstables -a&lt;/tt&gt; to collect the correct timestamps for the sstables&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12933908">CASSANDRA-11068</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 41 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2s8hr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>