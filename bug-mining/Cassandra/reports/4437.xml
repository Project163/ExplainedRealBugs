<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:04:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11752] histograms/metrics in 2.2 do not appear recency biased</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11752</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In addition to upgrading to metrics3, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5657&quot; title=&quot;Upgrade metrics lib and remove deprecated metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5657&quot;&gt;&lt;del&gt;CASSANDRA-5657&lt;/del&gt;&lt;/a&gt; switched to using  a custom histogram implementation.  After upgrading to Cassandra 2.2 histograms/timer metrics are not suspiciously flat.  To be useful for graphing and alerting metrics need to be biased towards recent events.&lt;/p&gt;

&lt;p&gt;I have attached images that I think illustrate this.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The first two are a comparison between latency observed by a C* 2.2 (us) cluster shoring very flat lines and a client (using metrics 2.2.0, ms) showing server performance problems.  We can&apos;t rule out with total certainty that something else isn&apos;t the cause (that&apos;s why we measure from both the client &amp;amp; server) but they very rarely disagree.&lt;/li&gt;
	&lt;li&gt;The 3rd image compares jconsole viewing of metrics on a 2.2 and 2.1 cluster over several minutes.  Not a single digit changed on the 2.2 cluster.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12967566">CASSANDRA-11752</key>
            <summary>histograms/metrics in 2.2 do not appear recency biased</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="eperott">Per Otterstr&#246;m</assignee>
                                    <reporter username="cburroughs">Chris Burroughs</reporter>
                        <labels>
                            <label>metrics</label>
                    </labels>
                <created>Wed, 11 May 2016 17:44:22 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:33 +0000</updated>
                            <resolved>Wed, 10 Aug 2016 18:45:22 +0000</resolved>
                                        <fixVersion>2.2.8</fixVersion>
                    <fixVersion>3.0.9</fixVersion>
                    <fixVersion>3.8</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>14</watches>
                                                                                                                <comments>
                            <comment id="15280722" author="cnlwsu" created="Wed, 11 May 2016 20:04:29 +0000"  >&lt;p&gt;you can collect getValues on the histogram&apos;s mbean, and delta the buckets yourself over time pretty easily. Its better to merge the histograms than average the percentiles anyway if doing cluster/node aggregates.&lt;/p&gt;</comment>
                            <comment id="15280806" author="cburroughs" created="Wed, 11 May 2016 20:46:20 +0000"  >&lt;p&gt;I&apos;ve patched production and verified that using ExponentiallyDecayingReservoir looks much more reasonable (so the issue is probably with the custom histogram and not metrics3).&lt;/p&gt;</comment>
                            <comment id="15280857" author="cnlwsu" created="Wed, 11 May 2016 21:25:17 +0000"  >&lt;p&gt;ExponentiallyDecayingReservoir is based on idea of that the data has a normal distribution, in latencies with long tails (ie GCs) the max/99th quickly becomes very inaccurate as more and more data goes through it. &lt;/p&gt;

&lt;p&gt;The EH does not by itself provide a &quot;recent&quot; view but you can derive it easily enough. Probably a change to hdr histogram, or adding an exp decay to the EH, or exposing the clear operation on the mbean (reset when you read them) would help. but using random sampling for latencies is the wrong direction imho.&lt;/p&gt;</comment>
                            <comment id="15280940" author="cburroughs" created="Wed, 11 May 2016 22:47:24 +0000"  >&lt;p&gt;So the &lt;a href=&quot;http://metrics.dropwizard.io/3.1.0/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;point&lt;/a&gt; of the metrics library is to &quot;insight into what your code does in production&quot;.   It is integrated into many projects.  Users expect to be able to take those metrics and:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Draw a &lt;a href=&quot;http://www.datastax.com/dev/blog/pluggable-metrics-reporting-in-cassandra-2-0-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line graph&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;Alert on values so they know when there are problems with a cluster.&lt;/li&gt;
	&lt;li&gt;Use jconsole to inspect beans and determine what is happening Right Now.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I am aware that there are concerns both in implementation and assumptions (normal distribution) with the metrics library.  They have been brought up both on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6486&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;this bug tracker&lt;/a&gt; and other forums. However imperfect, jconsole, line graphs, and threshold based alerts are of critical practical use today.  All of these require &lt;b&gt;recent&lt;/b&gt; data.  When my cluster is failing to meet business needs I want to know as soon as possible.  &lt;/p&gt;

&lt;p&gt;If I understand your proposal correctly, you are saying it would be better to drop all of that, much more powerful (and mathematically sound!) if we did an out of band export and merge of all of the histograms and create a heatmap.  This would provide better insight into the distribution of values (by showing the full distribution instead of a handful of percentiles) and allow for cluster wide aggregation.  This could be further augmented by using &lt;a href=&quot;https://docs.joyent.com/public-cloud/d-40-performance/cloud-analytics/use-of-color-in-cloud-analytics&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;hue and saturaiton&lt;/a&gt; to call out latencies for individual nodes or column families.  I think that sounds fantastic, but that is very much not where the industry is today.  Maybe Circonus can do that, but graphite definitely can&apos;t.&lt;/p&gt;

&lt;p&gt;And however cool that future sounds, the NEWS entry makes no mention of this as an intentional fundamental change. Nor does &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5657&quot; title=&quot;Upgrade metrics lib and remove deprecated metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5657&quot;&gt;&lt;del&gt;CASSANDRA-5657&lt;/del&gt;&lt;/a&gt; discuss the consequences. Indeed &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5657&quot; title=&quot;Upgrade metrics lib and remove deprecated metrics&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5657&quot;&gt;&lt;del&gt;CASSANDRA-5657&lt;/del&gt;&lt;/a&gt; hoped for improved accuracy and went out of the way to keep JMX functioning!&lt;/p&gt;</comment>
                            <comment id="15281526" author="tjake" created="Thu, 12 May 2016 13:45:17 +0000"  >&lt;p&gt;I see your point &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cburroughs&quot; class=&quot;user-hover&quot; rel=&quot;cburroughs&quot;&gt;cburroughs&lt;/a&gt;  there is value to both (correctness vs recency)  &lt;/p&gt;

&lt;p&gt;If there is no way to diff it in graphite we could perhaps do this  server side. &lt;br/&gt;
  Keep a snapshot of the histogram for the last 5 min and add them.&lt;/p&gt;
</comment>
                            <comment id="15281528" author="aweisberg" created="Thu, 12 May 2016 13:47:34 +0000"  >&lt;p&gt;Maybe the server should provide the raw histogram, but for the percentiles provide a value that is for a recent window of time. IOW do the work of munging the histogram for the monitoring programs instead of forcing them to provide an integration for munging EstimatedHistogram. This would also make it less of a change in behavior for people who are upgrading.&lt;/p&gt;

&lt;p&gt;I think that a percentile that is based on a window of time going back to when the server was started is an inappropriate metric for what JMX is/should be used for. Providing it has 0 value so lets use that API for something more useful and similar to what existed before.&lt;/p&gt;</comment>
                            <comment id="15281541" author="tjake" created="Thu, 12 May 2016 14:13:23 +0000"  >&lt;p&gt;I&apos;m pretty sure the raw histogram is there in JMX&lt;/p&gt;</comment>
                            <comment id="15281549" author="cnlwsu" created="Thu, 12 May 2016 14:22:49 +0000"  >&lt;p&gt;Well I will prefix this with I had nothing to do with any of the decisions, or have any real say in this. I am just an observer who has been impacted by the changes a bit.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If I understand your proposal correctly,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;apparently not, Ill elaborate a few ideas I listed above&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;change the reservoir to use hdr histogram.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;This is how most of the metrics community resolves this (on ML) &lt;a href=&quot;https://bitbucket.org/marshallpierce/hdrhistogram-metrics-reservoir&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bitbucket.org/marshallpierce/hdrhistogram-metrics-reservoir&lt;/a&gt;. it has the HdrHistogramResetOnSnapshotReservoir (can be implemented in EH too) that would essentially do the deltas. Unfortunately when you read 1 attribute at a time this will cause issues per codahales comment when people asked for the feature in metrics &quot;Definitely not. Concurrency and reset operations don&apos;t play nicely.&quot;.&lt;/li&gt;
		&lt;li&gt;a lot of the push for using a non-lossy histograms vs the random samping reservoirs (pre 2.2) came up every time someone sees one of Gene Tills talks for the first time. So this would make a lot of people happy&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Adding an exp decay to the EH
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;Can add forward decay to the values of EH buckets, actually pretty trivial to implement (id be willing to give this a shot, also sound fun)&lt;/li&gt;
		&lt;li&gt;This would give the same &quot;recent&quot; view as the ExpDecayingReservoir without the randomness that loses outliers.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Exposing the clear operation on the mbean, after reading if you clear the histogram it would give you what your looking for really.
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;pre 2.2 this is how it worked for cfhistograms and such, there were two ways to read each histogram, one that cleared and one that did not.&lt;/li&gt;
		&lt;li&gt;same comment as the ResetOnSnapshotReservoir above, this is easy to manage when doing it programmatically but it fails with things like dumb jmx readers.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;If I understand your proposal correctly, you are saying it would be better to drop all of that, much more powerful (and mathematically sound!) if we did an out of band export and merge of all of the histograms and create a heatmap. This would provide better insight into the distribution of values (by showing the full distribution instead of a handful of percentiles) and allow for cluster wide aggregation. This could be further augmented by using hue and saturaiton to call out latencies for individual nodes or column families. I think that sounds fantastic, but that is very much not where the industry is today. Maybe Circonus can do that, but graphite definitely can&apos;t.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;For what its worth, thats more or less of what opscenter does. It still uses percentiles vs heatmap for ease to conceptualize, but it generates percentiles on merged histograms vs the &lt;em&gt;averaging&lt;/em&gt; of the percentile value (which apparently makes some people very very angry). Thats not helpful here, but we shouldnt necessarily sacrifice the more accurate mechanism either. There were very loud complaints with how latencies were reported before so I was pretty glad to see the change in 2.2. I purpose we provide both.&lt;/p&gt;</comment>
                            <comment id="15281554" author="aweisberg" created="Thu, 12 May 2016 14:27:11 +0000"  >&lt;p&gt;It is. My point is that requiring people to munge a histogram to get the a value when you aren&apos;t providing an integration for all the different monitoring frameworks is maybe not the best way to go about it.&lt;/p&gt;

&lt;p&gt;The values provided by the percentiles are not useful so why not make them useful?&lt;/p&gt;</comment>
                            <comment id="15281556" author="cnlwsu" created="Thu, 12 May 2016 14:30:31 +0000"  >&lt;p&gt;You thinking keeping a snapshot of histogram around from 5 min ago or something and compute the percentile attributes from the deltas instead of the total one? I think that would be pretty good approach&lt;/p&gt;</comment>
                            <comment id="15281560" author="tjake" created="Thu, 12 May 2016 14:35:24 +0000"  >&lt;p&gt;I&apos;m pretty -1 on the idea of ResetOnSnapshot.   This makes the window arbitrary (whenever a client hits it).&lt;/p&gt;

&lt;p&gt;I think our EH offers most of what hdr does, just doesn&apos;t support arbitrary buckets.  I think keeping a rolling snapshot every 60s is the simplest fix (though the issue might he heap per table).  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnlwsu&quot; class=&quot;user-hover&quot; rel=&quot;cnlwsu&quot;&gt;cnlwsu&lt;/a&gt; how would you add decay?&lt;/p&gt;</comment>
                            <comment id="15281564" author="tjake" created="Thu, 12 May 2016 14:40:24 +0000"  >&lt;p&gt;Well keep 5 snapshots of 60 sec intervals. I just worry about the size.  Perhaps since they are just diffs they can be kept as an array of ints vs longs&lt;/p&gt;</comment>
                            <comment id="15281575" author="cnlwsu" created="Thu, 12 May 2016 14:52:38 +0000"  >&lt;p&gt;each bucket is a counter of events in that range, so you use either backward or forward decaying of each buckets value. It isnt perfect but it will give an approximate that would not miss the outliers that the sampling reservoir does.&lt;/p&gt;</comment>
                            <comment id="15312467" author="eperott" created="Thu, 2 Jun 2016 15:23:18 +0000"  >&lt;p&gt;I&apos;m also missing the simplicity of just graphing the percentiles directly. Still, I like the accuracy you get from getValues(), wasn&apos;t aware of it until now.&lt;/p&gt;

&lt;p&gt;I&apos;d be willing to create a patch for this. I&apos;m thinking of something like this:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Keep the existing EH implementation as it is. I think we wan&apos;t to keep the getValues() implementation for external tools to use. Also, the EH class seem to have some complexity due to the fact that is is used for SSTable metadata which don&apos;t match well with decay functionality.&lt;/li&gt;
	&lt;li&gt;Instead, create a new DecayingEstimatedHistogram implementation which keeps 5 arrays of buckets and switch out the oldest one every minute. Also, every minute, perform backward decay on values in the old arrays with a factor of two in order to make the recent minute more significant in the percentiles. It should be sufficient to use int rather than long in the buckets in order to save some memory.&lt;/li&gt;
	&lt;li&gt;Every time a new metric value is registered, it is added to both an EH and a DecayingEH.&lt;/li&gt;
	&lt;li&gt;When reading the bean a call to getValues() is directed to the EH, while calls to min/max/mean and percentiles are directed to DecayingEH.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Some code would be duplicated in the EH and DecayingEH class, but I think I would prefer this approach over adding decay complexity to the existing EH. One option would be to do the decay operation on read. Another option would be to use forward decay.&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="15312659" author="cnlwsu" created="Thu, 2 Jun 2016 16:57:26 +0000"  >&lt;p&gt;I am confused on why you have a sliding window and decaying function. can kinda just do one or the other. &lt;/p&gt;

&lt;p&gt;Sliding Window: if keeping 5 copies of the EH why not just have the same as EH but keep a buffer of long&lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;offsetsize&amp;#93;&lt;/span&gt; that every minute takes the current values of the bucket and stores them. then on read compare oldest in the buffer to the current, and the delta is the last 5 minutes. can treat the long&lt;span class=&quot;error&quot;&gt;&amp;#91;5&amp;#93;&lt;/span&gt; as a cyclic buffer. Can still provide the current &quot;getValues&quot; as the current total value but the percentiles can be computed on the delta.&lt;/p&gt;

&lt;p&gt;Decayed: I was thinking more like a &lt;a href=&quot;http://www.source-code.biz/snippets/java/11.htm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.source-code.biz/snippets/java/11.htm&lt;/a&gt; per bucket (a forward decaying i think would be best). Why keep the 5 sets of them?&lt;/p&gt;

&lt;p&gt;Decaying the snapshots sounds like it has the overhead of a sliding window and the complexity/performance/accuracy impact of a decaying algorithm. although I might have to see the implementation and may be missing something though.&lt;/p&gt;</comment>
                            <comment id="15312796" author="eperott" created="Thu, 2 Jun 2016 18:07:54 +0000"  >&lt;p&gt;By using sliding window only, all collected metrics from the last 5 minutes will be equally significant.&lt;/p&gt;

&lt;p&gt;On the other hand, by using decay only, the user may very well see values on the percentiles even thought the node has not processed any requests for the last five minutes.&lt;/p&gt;

&lt;p&gt;The reason for having both a sliding window and decay would be to make the metrics from the last minute more significant than the metrics collected 5 minutes ago. And an idling node would show zero-values on the percentiles after 5 minutes. But I may be over engineering this a bit. A pure decay approach is probably good enough.&lt;/p&gt;</comment>
                            <comment id="15327891" author="urandom" created="Mon, 13 Jun 2016 18:43:00 +0000"  >&lt;p&gt;Just adding a Me Too to the list of those looking for a solution to this; For those limited to something like Grafana/Graphite to plot these percentiles, the status quo is pretty unhelpful, (I was forced to patch my production systems to use &lt;tt&gt;com.codahale.metrics.ExponentiallyDecayingResvoir&lt;/tt&gt; in the interim).&lt;/p&gt;</comment>
                            <comment id="15327901" author="tjake" created="Mon, 13 Jun 2016 18:46:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eperott&quot; class=&quot;user-hover&quot; rel=&quot;eperott&quot;&gt;eperott&lt;/a&gt; are you working on this? &lt;/p&gt;</comment>
                            <comment id="15328026" author="eperott" created="Mon, 13 Jun 2016 19:35:42 +0000"  >&lt;p&gt;Yes, I would like to give it a try.&lt;/p&gt;

&lt;p&gt;Had a talk with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnlwsu&quot; class=&quot;user-hover&quot; rel=&quot;cnlwsu&quot;&gt;cnlwsu&lt;/a&gt; about it on NGCC. The idea is to create a separate DecayingEH implementation based on forward decay.&lt;/p&gt;</comment>
                            <comment id="15328050" author="tjake" created="Mon, 13 Jun 2016 19:46:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eperott&quot; class=&quot;user-hover&quot; rel=&quot;eperott&quot;&gt;eperott&lt;/a&gt; I assigned you to it thanks!&lt;/p&gt;</comment>
                            <comment id="15328269" author="cnlwsu" created="Mon, 13 Jun 2016 21:09:38 +0000"  >&lt;p&gt;for what its worth, if patching in ExponentiallyDecayingResvoir may want to consider &lt;a href=&quot;https://bitbucket.org/marshallpierce/hdrhistogram-metrics-reservoir&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://bitbucket.org/marshallpierce/hdrhistogram-metrics-reservoir&lt;/a&gt; instead. the random sampling can lose 90th+ percentile pretty easily. If just want trending its fine though.&lt;/p&gt;</comment>
                            <comment id="15355290" author="eperott" created="Wed, 29 Jun 2016 14:03:01 +0000"  >&lt;p&gt;Attached fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11752&quot; title=&quot;histograms/metrics in 2.2 do not appear recency biased&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11752&quot;&gt;&lt;del&gt;CASSANDRA-11752&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I ended up implementing a completely new histogram reservoir as it seemed to be the most clean approach.&lt;/p&gt;

&lt;p&gt;The new DecayingEstimatedHistogramReservoir class holds two different sets of buckets, one with decay and one without. The buckets without decay will only be exposed on call to getValues(), other methods in a snapshot will expose values based on the decaying buckets. This way we&apos;re compatible with clients pulling raw bucket values, while still serving reasonable values on the percentiles which are biased towards the most recent minutes.&lt;/p&gt;

&lt;p&gt;The snapshot will not create a copy of the non-decaying buckets up front in order to not allocate and free memory without using it. Internal calls as well as most clients will probably not use the raw values any way.&lt;/p&gt;</comment>
                            <comment id="15364475" author="tjake" created="Wed, 6 Jul 2016 15:37:26 +0000"  >&lt;p&gt;Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eperott&quot; class=&quot;user-hover&quot; rel=&quot;eperott&quot;&gt;eperott&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;I&apos;m a little concerned about the impact of the lock every 30 minutes.  Do you think buffering during the period of locking would be possible to not interrupt the active workload?  Where did the 30 minute interval come from? (i.e why not 60) how does the decay look when plotting the quantiles before and after the interval?&lt;/p&gt;

&lt;p&gt;I&apos;ll try running some stress tests and see if there is any meaningful impact as well as try and generate some charts from reporting live data (unless you have some)&lt;/p&gt;</comment>
                            <comment id="15366750" author="eperott" created="Thu, 7 Jul 2016 20:55:27 +0000"  >&lt;p&gt;I understand your concern. I have not verified the performance impact myself. The locking scheme is very much inspired by the one used by the &lt;a href=&quot;https://github.com/dropwizard/metrics/blob/3.1-maintenance/metrics-core/src/main/java/com/codahale/metrics/ExponentiallyDecayingReservoir.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ExponentiallyDecayingReservoir&lt;/a&gt; in the Metrics library.&lt;/p&gt;

&lt;p&gt;It should be possible to add some kind of buffering during rescale. Another option with less complexity could be to simply skip the collection of metrics during rescale and let threads continue. We would loose some accuracy in the percentiles and possibly an outlier in the min/max values. We can still add metrics to the non-decaying buckets during rescale, so getValues() will still be just as accurate as it is now. Any opinion on this?&lt;/p&gt;

&lt;p&gt;I went for 30 minutes rescale interval based on the assumption that in an extreme case a metric could hit the same bucket a million times every second, so 60M times every minute. After 30 minutes forward decay factor will be 29^2=536870912. Accumulated value will be 60M, 180M, 420M...64P which will be represented with 56 bits, giving us some extra head room in a signed 64 bit long. Based on these assumptions it could be possible to fit another few minutes, but 60 would be to much. Should perhaps mention these assumptions in the java-doc.&lt;/p&gt;

&lt;p&gt;I don&apos;t have plots showing the effect of the rescale. I&apos;m out of office for a few weeks but I&apos;ll try to verify this and performance impact as soon as I find the time.&lt;/p&gt;
</comment>
                            <comment id="15413543" author="eperott" created="Tue, 9 Aug 2016 13:56:50 +0000"  >&lt;p&gt;I&apos;ve executed a few tests on this and I&apos;m not able to see any performance impact caused by the exclusive lock every 30 minutes. In my opinion there is no reason to implement a buffer solution.&lt;/p&gt;

&lt;p&gt;Attaching a graph which show 50th percentile, 99,9th percentile and max. The result is somewhat edgy since we are using buckets, but the graph is consistent before and after rescale. The notable exception is of course the max value which will dip a lot every time, but that is kind of expected when we are using forward decay.&lt;/p&gt;

&lt;p&gt;Also attaching an update of the patch which should make the graph somewhat more smooth and responsive as the weight is calculated for each metric. Improved documentation.&lt;/p&gt;
</comment>
                            <comment id="15413722" author="tjake" created="Tue, 9 Aug 2016 15:26:49 +0000"  >&lt;p&gt;Great thanks for this verification:&lt;/p&gt;

&lt;p&gt;I&apos;ve kicked off the tests:&lt;/p&gt;

&lt;p&gt;2.2&lt;br/&gt;
&lt;a href=&quot;https://github.com/tjake/cassandra/tree/11752-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/tjake-11752-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/tjake-11752-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;3.0&lt;br/&gt;
&lt;a href=&quot;https://github.com/tjake/cassandra/tree/11752-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/tjake-11752-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/tjake-11752-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/p&gt;


&lt;p&gt;3.9&lt;br/&gt;
&lt;a href=&quot;https://github.com/tjake/cassandra/tree/11752-3.9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/tjake-11752-3.9-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/tjake-11752-3.9-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15415761" author="tjake" created="Wed, 10 Aug 2016 18:45:22 +0000"  >&lt;p&gt;Committed thanks Per!&lt;/p&gt;</comment>
                            <comment id="15428987" author="dbrosius" created="Fri, 19 Aug 2016 22:54:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eperott&quot; class=&quot;user-hover&quot; rel=&quot;eperott&quot;&gt;eperott&lt;/a&gt; DecayingEstimatedHistogramReservoir.rescale does&lt;/p&gt;

&lt;p&gt;                    long newValue = Math.round((decayingBuckets.get&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/information.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; / rescaleFactor));&lt;/p&gt;

&lt;p&gt;ie, rounds a long. Did you want to do something else, do double division perhaps?&lt;/p&gt;</comment>
                            <comment id="15439541" author="urandom" created="Fri, 26 Aug 2016 18:38:27 +0000"  >&lt;p&gt;FWIW, I tested this patch, and compared the plots to those created from using &lt;a href=&quot;https://github.com/dropwizard/metrics/blob/3.1-maintenance/metrics-core/src/main/java/com/codahale/metrics/ExponentiallyDecayingReservoir.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ExponentiallyDecayingReservoir&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Results can be seen here: &lt;a href=&quot;https://phabricator.wikimedia.org/T137474#2584099&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://phabricator.wikimedia.org/T137474#2584099&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15448194" author="eperott" created="Tue, 30 Aug 2016 06:28:13 +0000"  >&lt;p&gt;Yes, should have been double division. Good catch!&lt;/p&gt;

&lt;p&gt;I overlooked this when I created the v2 patch. I&apos;m attaching v2b which should fix this.&lt;/p&gt;</comment>
                            <comment id="15448198" author="eperott" created="Tue, 30 Aug 2016 06:29:45 +0000"  >&lt;p&gt;Fixing double division and rounding.&lt;/p&gt;</comment>
                            <comment id="15448327" author="eperott" created="Tue, 30 Aug 2016 07:30:11 +0000"  >&lt;p&gt;Interesting comparison. And I&apos;m a bit surprised by the results. I would expect the EH to exaggerate peaks rather than the other way around as it registers measurements in fixed value buckets rounding &lt;em&gt;upwards&lt;/em&gt;.&lt;/p&gt;

&lt;p&gt;I wonder if this could be an effect of the fact that the EDR is based on samples. This means that sometimes it can miss an outlier, but could this also mean that if an outlier is caught it can be over-represented in the histogram?&lt;/p&gt;

&lt;p&gt;Another explanation could be that the decay is to quick or slow in the DEHR (half-time set to one minute right now). How frequently do you take readings?&lt;/p&gt;</comment>
                            <comment id="15450845" author="dbrosius" created="Wed, 31 Aug 2016 02:35:27 +0000"  >&lt;p&gt;committed 12826139/11752-2.2-v2b.txt as ac24b88e56275583b71bd6a1feba443e05e88c39 to cassandra-2.2&lt;/p&gt;</comment>
                            <comment id="15651153" author="eperott" created="Wed, 9 Nov 2016 14:54:29 +0000"  >&lt;p&gt;Just noticed that this patch set never found its way into 2.2 branch. It&apos;s in 3.0 though.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12822793" name="11752-2.2-v2.txt" size="44054" author="eperott" created="Tue, 9 Aug 2016 13:56:50 +0000"/>
                            <attachment id="12826139" name="11752-2.2-v2b.txt" size="1942" author="eperott" created="Tue, 30 Aug 2016 06:29:43 +0000"/>
                            <attachment id="12814761" name="11752-2.2.txt" size="41814" author="eperott" created="Wed, 29 Jun 2016 14:03:01 +0000"/>
                            <attachment id="12803463" name="boost-metrics.png" size="155571" author="cburroughs" created="Wed, 11 May 2016 17:44:23 +0000"/>
                            <attachment id="12803465" name="c-jconsole-comparison.png" size="145679" author="cburroughs" created="Wed, 11 May 2016 17:44:23 +0000"/>
                            <attachment id="12803464" name="c-metrics.png" size="80257" author="cburroughs" created="Wed, 11 May 2016 17:44:23 +0000"/>
                            <attachment id="12803511" name="default-histogram.png" size="31831" author="cburroughs" created="Wed, 11 May 2016 20:46:20 +0000"/>
                            <attachment id="12822794" name="server-patch-v2.png" size="35876" author="eperott" created="Tue, 9 Aug 2016 13:56:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[eperott]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 1 week, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2xllj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334797">2.2.6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>