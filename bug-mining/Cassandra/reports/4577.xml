<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:05:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12796] Heap exhaustion when rebuilding secondary index over a table with wide partitions</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12796</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have a table with rather wide partition and a secondary index defined over it. As soon as we try to rebuild the index we observed exhaustion of Java heap and eventual OOM error. After a lengthy investigation we have managed to find a culprit which appears to be a wrong granule of barrier issuances in method &lt;tt&gt;org.apache.cassandra.db.Keyspace.indexRow&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (OpOrder.Group opGroup = cfs.keyspace.writeOrder.start()){html}
        {
            Set&amp;lt;SecondaryIndex&amp;gt; indexes = cfs.indexManager.getIndexesByNames(idxNames);

            Iterator&amp;lt;ColumnFamily&amp;gt; pager = QueryPagers.pageRowLocally(cfs, key.getKey(), DEFAULT_PAGE_SIZE);
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (pager.hasNext())
            {
                ColumnFamily cf = pager.next();
                ColumnFamily cf2 = cf.cloneMeShallow();
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Cell cell : cf)
                {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (cfs.indexManager.indexes(cell.name(), indexes))
                        cf2.addColumn(cell);
                }
                cfs.indexManager.indexRow(key.getKey(), cf2, opGroup);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Please note the operation group granule is a partition of the source table which poses a problem for wide partition tables as flush runnable (&lt;tt&gt;org.apache.cassandra.db.ColumnFamilyStore.Flush.run()&lt;/tt&gt;) won&apos;t proceed with flushing secondary index memtable before completing operations prior recent issue of the barrier. In our situation the flush runnable waits until whole wide partition gets indexed into the secondary index memtable before flushing it. This causes an exhaustion of the heap and eventual OOM error.&lt;/p&gt;

&lt;p&gt;After we changed granule of barrier issue in method &lt;tt&gt;org.apache.cassandra.db.Keyspace.indexRow&lt;/tt&gt; to query page as opposed to table partition secondary index (see &lt;a href=&quot;https://github.com/mmajercik/cassandra/commit/7e10e5aa97f1de483c2a5faf867315ecbf65f3d6?diff=unified&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mmajercik/cassandra/commit/7e10e5aa97f1de483c2a5faf867315ecbf65f3d6?diff=unified&lt;/a&gt;), rebuild started to work without heap exhaustion. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13012791">CASSANDRA-12796</key>
            <summary>Heap exhaustion when rebuilding secondary index over a table with wide partitions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="mmajercik">Milan Majercik</reporter>
                        <labels>
                    </labels>
                <created>Mon, 17 Oct 2016 09:10:54 +0000</created>
                <updated>Tue, 14 Oct 2025 12:14:00 +0000</updated>
                            <resolved>Tue, 13 Dec 2016 10:41:54 +0000</resolved>
                                        <fixVersion>2.2.9</fixVersion>
                    <fixVersion>3.0.11</fixVersion>
                    <fixVersion>3.10</fixVersion>
                                    <component>Feature/2i Index</component>
                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15637535" author="anmolsharma.141" created="Fri, 4 Nov 2016 20:10:23 +0000"  >&lt;p&gt;I am able to reproduce this issue in Apache Cassandra 3.0.8 with a wide partition and a secondary index defined over it.&lt;/p&gt;

&lt;p&gt;The code has changed significantly between the version reported here and 3.0.8 however the characteristics of the failure are fairly similar, i.e. when a secondary index is rebuild there is a build up of large number of pending memtable flush runnables and the node gets overwhelmed and crashes due to an OOM.&lt;/p&gt;

&lt;p&gt;Adjusting the granule on which the write barrier applies (taking a pass with the suggested patch&apos;s logic on the 3.0.8 code) does seem to alleviate the problem and I do not see the memtable flush runnables queue up, however I am not sure if there are other unintended consequences of tweaking this write barrier granule which need to be considered.&lt;/p&gt;

&lt;p&gt;I would like to know if this patch can be brought into Cassandra 3.0.x or are there other solutions to deal with large partitions with secondary indexes?&lt;/p&gt;</comment>
                            <comment id="15644622" author="beobal" created="Mon, 7 Nov 2016 16:25:57 +0000"  >&lt;p&gt;b.q. I would like to know if this patch can be brought into Cassandra 3.0.x or are there other solutions to deal with large partitions with secondary indexes?&lt;/p&gt;

&lt;p&gt;There aren&apos;t I&apos;m afraid, so if you could post your patches for 2.2 &amp;amp; 3.0 I&apos;ll make sure they get reviewed (I shouldn&apos;t think a separate patch for trunk will be necessary).&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="15647229" author="mmajercik" created="Tue, 8 Nov 2016 11:02:11 +0000"  >&lt;p&gt;I&apos;ll post the formal patch for 2.2 shortly.&lt;/p&gt;</comment>
                            <comment id="15653529" author="mmajercik" created="Thu, 10 Nov 2016 09:06:01 +0000"  >&lt;p&gt;The patch for &lt;b&gt;2.2&lt;/b&gt; can be found at &lt;a href=&quot;https://github.com/mmajercik/cassandra/tree/12796-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mmajercik/cassandra/tree/12796-2.2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I made some attempt to adjust this patch for branch &lt;b&gt;3.0&lt;/b&gt; but was overwhelmed by sheer extent of refactoring that virtually left no stone untouched. I suppose it takes a while until I&apos;ll be able to issue patch for &lt;b&gt;3.0&lt;/b&gt;.&lt;/p&gt;</comment>
                            <comment id="15653734" author="githubbot" created="Thu, 10 Nov 2016 10:48:08 +0000"  >&lt;p&gt;GitHub user mmajercik opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/82&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    12796 2.2&lt;/p&gt;

&lt;p&gt;    This is a proposed fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12796&quot; title=&quot;Heap exhaustion when rebuilding secondary index over a table with wide partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12796&quot;&gt;&lt;del&gt;CASSANDRA-12796&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/mmajercik/cassandra&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mmajercik/cassandra&lt;/a&gt; 12796-2.2&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/82.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/82.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #82&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit caaa9fc82cd51b7321da4dad0715ebc561d180dd&lt;br/&gt;
Author: Josh McKenzie &amp;lt;josh.mckenzie@datastax.com&amp;gt;&lt;br/&gt;
Date:   2016-04-01T15:46:15Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;cassandra-2.1&apos; into cassandra-2.2&lt;/p&gt;

&lt;p&gt;commit c662259fe9e1e25e10e58eb1146de80c53e69867&lt;br/&gt;
Author: Yuki Morishita &amp;lt;yukim@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-02-16T18:45:36Z&lt;/p&gt;

&lt;p&gt;    Use canonical path for directory in SSTable descriptor&lt;/p&gt;

&lt;p&gt;    patch by yukim; reviewed by Paulo Motta for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10587&quot; title=&quot;sstablemetadata NPE on cassandra 2.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10587&quot;&gt;&lt;del&gt;CASSANDRA-10587&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit 0ac2072bb2cc6d8e069e07f5cbcdf2e83cdc5b5c&lt;br/&gt;
Author: Andrzej Ludwikowski &amp;lt;andrzejlud@op.pl&amp;gt;&lt;br/&gt;
Date:   2016-03-07T18:27:54Z&lt;/p&gt;

&lt;p&gt;    DatabaseDescriptor should log stacktrace in case of Eception during seed provider creation&lt;/p&gt;

&lt;p&gt;    patch by Andrzej Ludwikowski; reviewed by jasobrown for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11312&quot; title=&quot;DatabaseDescriptor#applyConfig should log stacktrace in case of Eception during seed provider creation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11312&quot;&gt;&lt;del&gt;CASSANDRA-11312&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit ea9b42e7d7bf9003dd6ed911035d3a85a2d99bac&lt;br/&gt;
Author: Benjamin Lerer &amp;lt;b.lerer@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-02T15:55:04Z&lt;/p&gt;

&lt;p&gt;    Fix paging for COMPACT tables without clustering columns&lt;/p&gt;

&lt;p&gt;    patch by Benjamin Lerer; reviewed by Tyler Hobbs for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11467&quot; title=&quot;Paging loses rows in certain conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11467&quot;&gt;&lt;del&gt;CASSANDRA-11467&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit 2ed855592ab77399e061f03f73a943aefbd44eaf&lt;br/&gt;
Author: Benjamin Lerer &amp;lt;b.lerer@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-02T15:59:37Z&lt;/p&gt;

&lt;p&gt;    Merge branch cassandra-2.1 into cassandra-2.2&lt;/p&gt;

&lt;p&gt;commit 1ff9df75c46edb02bf1f994e7ecc651e29b277fb&lt;br/&gt;
Author: Marcus Olsson &amp;lt;marcus.olsson@ericsson.com&amp;gt;&lt;br/&gt;
Date:   2016-03-24T14:06:23Z&lt;/p&gt;

&lt;p&gt;    Remove duplicate logging of sending MerkleTree request&lt;/p&gt;

&lt;p&gt;    Patch by Marcus Olsson; reviewed by marcuse for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11486&quot; title=&quot;Duplicate logging of merkle tree request&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11486&quot;&gt;&lt;del&gt;CASSANDRA-11486&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit a33038be23e4114f5b6f0736887d35656b0aa40f&lt;br/&gt;
Author: Ryan Magnusson &amp;lt;ryan.magnusson@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-04T12:09:54Z&lt;/p&gt;

&lt;p&gt;    IncomingStreamingConnection version check message wrong&lt;/p&gt;

&lt;p&gt;    patch by Ryan Magnusson reviewed by Robert Stupp for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11462&quot; title=&quot;IncomingStreamingConnection version check message wrong&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11462&quot;&gt;&lt;del&gt;CASSANDRA-11462&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit 96c53e0a5e73046acb77e2ac2a3aa9d9ef64fc65&lt;br/&gt;
Author: Josh McKenzie &amp;lt;josh.mckenzie@datastax.com&amp;gt;&lt;br/&gt;
Date:   2016-04-06T22:37:08Z&lt;/p&gt;

&lt;p&gt;    Fix launch with whitespace in path on Windows&lt;/p&gt;

&lt;p&gt;    Patch by jmckenzie; reviewed by pmotta for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11515&quot; title=&quot;C* won&amp;#39;t launch with whitespace in path on Windows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11515&quot;&gt;&lt;del&gt;CASSANDRA-11515&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit 2dd244b439049baa1a9f175237acf802e1946d74&lt;br/&gt;
Author: Benjamin Lerer &amp;lt;b.lerer@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-11T07:41:44Z&lt;/p&gt;

&lt;p&gt;    Ninja: fix typo in CommitLog error message&lt;/p&gt;

&lt;p&gt;commit e22faeb8c5463a34b630aff8e265aefbe950b58d&lt;br/&gt;
Author: Benjamin Lerer &amp;lt;b.lerer@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-11T07:43:56Z&lt;/p&gt;

&lt;p&gt;    Merge branch cassandra-2.1 into cassandra-2.2&lt;/p&gt;

&lt;p&gt;commit 3557d2e05c8d1059562de2a91c1b33b4fcfcc6eb&lt;br/&gt;
Author: Paulo Motta &amp;lt;pauloricardomg@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-05T19:58:06Z&lt;/p&gt;

&lt;p&gt;    Make deprecated repair methods backward-compatible with previous notification service&lt;/p&gt;

&lt;p&gt;    patch by Paulo Motta; reviewed by Yuki Morishita for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11430&quot; title=&quot;Add legacy notifications backward-support on deprecated repair methods&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11430&quot;&gt;&lt;del&gt;CASSANDRA-11430&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit c1b1d3bccf30a7ee1deb633d2bc2dfbd7b9c542f&lt;br/&gt;
Author: Stefania Alborghetti &amp;lt;stefania.alborghetti@datastax.com&amp;gt;&lt;br/&gt;
Date:   2016-04-08T03:52:17Z&lt;/p&gt;

&lt;p&gt;    Checking if an unlogged batch is local is inefficient&lt;/p&gt;

&lt;p&gt;    patch by Stefania Alborghetti; reviewed by Paulo Motta for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11529&quot; title=&quot;Checking if an unlogged batch is local is inefficient&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11529&quot;&gt;&lt;del&gt;CASSANDRA-11529&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit ab2b8a60c4b6d27081d632fefa0e19ee13816e2c&lt;br/&gt;
Author: Aleksey Yeschenko &amp;lt;aleksey@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-04-11T18:14:41Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;cassandra-2.1&apos; into cassandra-2.2&lt;/p&gt;

&lt;p&gt;commit 19b4b637ac79b5d53b9384bd95bed8e08b43f111&lt;br/&gt;
Author: Jacek Lewandowski &amp;lt;lewandowski.jacek@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-08T15:31:00Z&lt;/p&gt;

&lt;p&gt;    CqlConfigHelper no longer requires both a keystore and truststore to work.&lt;/p&gt;

&lt;p&gt;    patch by Jacek Lewandowski; reviewed by Jeremiah Jordan for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11532&quot; title=&quot;CqlConfigHelper requires both truststore and keystore to work with SSL encryption&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11532&quot;&gt;&lt;del&gt;CASSANDRA-11532&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit 69edeaa46b78bb168f7e9d0b1c991c07b90f41ca&lt;br/&gt;
Author: Alex Petrov &amp;lt;oleksandr.petrov@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-14T10:26:52Z&lt;/p&gt;

&lt;p&gt;    Allow only DISTINCT queries with partition keys restrictions&lt;/p&gt;

&lt;p&gt;    patch by Alex Petrov; reviewed by Benjamin Lerer for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11339&quot; title=&quot;WHERE clause in SELECT DISTINCT can be ignored&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11339&quot;&gt;&lt;del&gt;CASSANDRA-11339&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit 220e4f62db7fe14c4d6c0e499c52059f7ebc5a53&lt;br/&gt;
Author: T Jake Luciani &amp;lt;jake@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-04-15T14:00:04Z&lt;/p&gt;

&lt;p&gt;    2.2.6 version bump&lt;/p&gt;

&lt;p&gt;commit 5c5c5b44c6d952d4d6f8170fa4ef239060275b76&lt;br/&gt;
Author: T Jake Luciani &amp;lt;jake@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-04-15T14:30:21Z&lt;/p&gt;

&lt;p&gt;    2.1.14 version bump&lt;/p&gt;

&lt;p&gt;commit 37f63ecc5d3b36fc115fd7ae98e4fc1f4bc2d1d6&lt;br/&gt;
Author: T Jake Luciani &amp;lt;jake@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-04-15T14:34:48Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;cassandra-2.1&apos; into cassandra-2.2&lt;/p&gt;

&lt;p&gt;commit 77ab77328e7e263a8e93ff24ff9b5d4be33e7c27&lt;br/&gt;
Author: Artem Aliev &amp;lt;artem.aliev@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-18T14:24:12Z&lt;/p&gt;

&lt;p&gt;    Always close cluster with connection in CqlRecordWriter&lt;/p&gt;

&lt;p&gt;    patch by Artem Aliev; reviewed by Aleksey Yeschenko for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11553&quot; title=&quot;hadoop.cql3.CqlRecordWriter does not close cluster on reconnect&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11553&quot;&gt;&lt;del&gt;CASSANDRA-11553&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit d200d137823d5b250406bccb35473a8fc2f14faf&lt;br/&gt;
Author: Ruoran Wang &amp;lt;ruoranwang@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-18T22:49:30Z&lt;/p&gt;

&lt;p&gt;    Replace sstables on DataTracker before marking them as non-compacting during anti-compaction&lt;/p&gt;

&lt;p&gt;    Patch by Ruoran Wang; reviewed by Paulo Motta for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11548&quot; title=&quot;Anticompaction not removing old sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11548&quot;&gt;&lt;del&gt;CASSANDRA-11548&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit 209ebd380b641c4f065e9687186f546f8a50b242&lt;br/&gt;
Author: Paulo Motta &amp;lt;pauloricardomg@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-18T21:44:07Z&lt;/p&gt;

&lt;p&gt;    Add unit test for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11548&quot; title=&quot;Anticompaction not removing old sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11548&quot;&gt;&lt;del&gt;CASSANDRA-11548&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    Patch by Paulo Motta; reviewed by Marcus Eriksson for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11548&quot; title=&quot;Anticompaction not removing old sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11548&quot;&gt;&lt;del&gt;CASSANDRA-11548&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit 97a43ffff2610f5f57678c69ca674b7d795c36b4&lt;br/&gt;
Author: Marcus Eriksson &amp;lt;marcuse@apache.org&amp;gt;&lt;br/&gt;
Date:   2016-04-19T13:48:52Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;cassandra-2.1&apos; into cassandra-2.2&lt;/p&gt;

&lt;p&gt;commit 60997c2dedc23a80dcc15fe6b1e2e7769ad2d383&lt;br/&gt;
Author: Benjamin Lerer &amp;lt;b.lerer@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-19T15:46:21Z&lt;/p&gt;

&lt;p&gt;    Fix javadoc in AggregateFcts&lt;/p&gt;

&lt;p&gt;commit 4389c9cfd86fb3f31a9419c44f0521604be3637b&lt;br/&gt;
Author: Stefania Alborghetti &amp;lt;stefania.alborghetti@datastax.com&amp;gt;&lt;br/&gt;
Date:   2016-04-11T02:31:34Z&lt;/p&gt;

&lt;p&gt;    cqlsh: Fix potential COPY deadlock&lt;/p&gt;

&lt;p&gt;    This deadlock could occur when the parent process is terminating child&lt;br/&gt;
    processes (partial backport of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11320&quot; title=&quot;Improve backoff policy for cqlsh COPY FROM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11320&quot;&gt;&lt;del&gt;CASSANDRA-11320&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;    Patch by Stefania Alborghetti; reviewed by Tyler Hobbs for&lt;br/&gt;
    &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11505&quot; title=&quot;dtest failure in cqlsh_tests.cqlsh_copy_tests.CqlshCopyTest.test_reading_max_parse_errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11505&quot;&gt;&lt;del&gt;CASSANDRA-11505&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit e865e396cdd6281f7eaac9cde8b5528547cb8e98&lt;br/&gt;
Author: Tyler Hobbs &amp;lt;tylerlhobbs@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-20T18:55:28Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;cassandra-2.1&apos; into cassandra-2.2&lt;/p&gt;

&lt;p&gt;commit eb072a0fa05292dd347e96d3bc45b445995227ec&lt;br/&gt;
Author: Stefania Alborghetti &amp;lt;stefania.alborghetti@datastax.com&amp;gt;&lt;br/&gt;
Date:   2016-04-06T09:14:11Z&lt;/p&gt;

&lt;p&gt;    cqlsh: COPY FROM should use regular inserts for single statement batches&lt;br/&gt;
    and report errors correctly if workers processes crash on initialization&lt;/p&gt;

&lt;p&gt;    patch by Stefania Alborghetti; reviewed by Paulo Motta for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11474&quot; title=&quot;cqlsh: COPY FROM should use regular inserts for single statement batches&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11474&quot;&gt;&lt;del&gt;CASSANDRA-11474&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit c8914c0725f190df6e522179157850ebc855fdcb&lt;br/&gt;
Author: Stefania Alborghetti &amp;lt;stefania.alborghetti@datastax.com&amp;gt;&lt;br/&gt;
Date:   2016-04-12T02:12:18Z&lt;/p&gt;

&lt;p&gt;    cqlsh: COPY FROM ignores NULL values in conversion&lt;/p&gt;

&lt;p&gt;    patch by Stefania Alborghetti; reviewed by Paulo Motta for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11549&quot; title=&quot;cqlsh: COPY FROM ignores NULL values in conversion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11549&quot;&gt;&lt;del&gt;CASSANDRA-11549&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit b80ff541e25d4123f772dd82f00094e7c3837698&lt;br/&gt;
Author: Stefania Alborghetti &amp;lt;stefania.alborghetti@datastax.com&amp;gt;&lt;br/&gt;
Date:   2016-04-21T02:12:24Z&lt;/p&gt;

&lt;p&gt;    Merge branch &apos;cassandra-2.1&apos; into cassandra-2.2&lt;/p&gt;

&lt;p&gt;commit 3244774572c56400ed96da4d57912779878c16e5&lt;br/&gt;
Author: Alex Petrov &amp;lt;oleksandr.petrov@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-21T09:46:09Z&lt;/p&gt;

&lt;p&gt;    Avoid possible stack overflow in ModificationStatement::getFunctions&lt;/p&gt;

&lt;p&gt;    Patch by Alex Petrov; reviewed by Sam Tunnicliffe for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11621&quot; title=&quot;Stack Overflow inserting value with many columns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11621&quot;&gt;&lt;del&gt;CASSANDRA-11621&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit c42f5f68532a9e42e3f228b9dba5fdc9de5c37ca&lt;br/&gt;
Author: Tyler Hobbs &amp;lt;tylerlhobbs@gmail.com&amp;gt;&lt;br/&gt;
Date:   2016-04-21T20:31:40Z&lt;/p&gt;

&lt;p&gt;    Ninja: use logger.trace() when we only intend to log at trace&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15653743" author="githubbot" created="Thu, 10 Nov 2016 10:53:07 +0000"  >&lt;p&gt;Github user mmajercik closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/82&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15653748" author="githubbot" created="Thu, 10 Nov 2016 10:54:52 +0000"  >&lt;p&gt;GitHub user mmajercik opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/83&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    12796 2.2&lt;/p&gt;

&lt;p&gt;    This is a proposed patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12796&quot; title=&quot;Heap exhaustion when rebuilding secondary index over a table with wide partitions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12796&quot;&gt;&lt;del&gt;CASSANDRA-12796&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/mmajercik/cassandra&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mmajercik/cassandra&lt;/a&gt; 12796-2.2&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/83.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/83.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #83&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit de57fc5ddc3fffdd6a1eed2dee53a638d5053fab&lt;br/&gt;
Author: mmajercik &amp;lt;mmajercik@specter.firstmobileaffiliate.com&amp;gt;&lt;br/&gt;
Date:   2016-10-14T13:54:02Z&lt;/p&gt;

&lt;p&gt;    Changed operation group granularity to page rathen than partition when rebuilding secondary index&lt;/p&gt;

&lt;p&gt;commit f5d4f1cfb8dbaf550bb1685408279cd6935d3cbf&lt;br/&gt;
Author: mmajercik &amp;lt;mmajercik@specter.firstmobileaffiliate.com&amp;gt;&lt;br/&gt;
Date:   2016-11-10T08:22:24Z&lt;/p&gt;

&lt;p&gt;    replaced tabs with spaces&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="15653787" author="beobal" created="Thu, 10 Nov 2016 11:11:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmajercik&quot; class=&quot;user-hover&quot; rel=&quot;mmajercik&quot;&gt;mmajercik&lt;/a&gt; no worries, I can take care of porting your patch to 3.0. Leave it with me and I&apos;ll try to get to it in the next day or two.&lt;/p&gt;</comment>
                            <comment id="15657377" author="beobal" created="Fri, 11 Nov 2016 15:49:40 +0000"  >&lt;p&gt;Forward ported the original patch to 3.0/3.X/trunk and submitted CI jobs:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/12796-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12796-2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-2.2-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-2.2-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/12796-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12796-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/12796-3.X&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12796-3.X&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-3.X-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-3.X-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/12796-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12796-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15687809" author="anmolsharma.141" created="Tue, 22 Nov 2016 20:29:47 +0000"  >&lt;p&gt;It looks like the proposed solution is only partially adequate for 3.0.x; while it enables memtable &lt;em&gt;flushes&lt;/em&gt; to proceed while a partition is being indexed, the read ordering &lt;tt&gt;OpGroup&lt;/tt&gt; introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11905&quot; title=&quot;Index building fails to start CFS.readOrdering when reading&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11905&quot;&gt;&lt;del&gt;CASSANDRA-11905&lt;/del&gt;&lt;/a&gt; continues to block memtable memory from being &lt;em&gt;reclaimed&lt;/em&gt;.  In our environment, this ultimately blocks new memtables from being allocated while indexing is underway, which in turn blocks new mutations from finishing while they for new memtables to become available.  That ultimately also leads to heap exhaustion as blocked mutations accumulate.&lt;/p&gt;

&lt;p&gt;So it looks like the granularity of the read &lt;tt&gt;OpOrder&lt;/tt&gt; lock also needs to be reduced.  Following the logic of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11905&quot; title=&quot;Index building fails to start CFS.readOrdering when reading&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11905&quot;&gt;&lt;del&gt;CASSANDRA-11905&lt;/del&gt;&lt;/a&gt;, before 3.0.x that was implicitly accomplished by using a pager to read the partition, which handled the read &lt;tt&gt;OpOrder&lt;/tt&gt; correctly behind the scenes.  Is doing something like that an option now?&lt;/p&gt;</comment>
                            <comment id="15689291" author="mmajercik" created="Wed, 23 Nov 2016 08:07:43 +0000"  >&lt;p&gt;I observed the same issue when did brief testing on 3.0 branch&lt;/p&gt;</comment>
                            <comment id="15694012" author="beobal" created="Thu, 24 Nov 2016 18:50:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;So it looks like the granularity of the read OpOrder lock also needs to be reduced&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point, and like you said it&apos;s possible to use a Pager here, as in pre 3.0 versions. &lt;/p&gt;

&lt;p&gt;I&apos;ve force-pushed new versions for 3.0/3.11/3.X/trunk (the 2.2 version is unchanged of course). There have been some issues with dtests in CI today, so I&apos;ll kick those off when the infra is stable again.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/12796-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12796-2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-2.2-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-2.2-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/12796-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12796-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/12796-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12796-3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-3.11-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-3.11-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/12796-3.X&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12796-3.X&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-3.X-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-3.X-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/12796-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12796-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12796-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15705225" author="beobal" created="Tue, 29 Nov 2016 12:50:49 +0000"  >&lt;p&gt;The CI looks reasonable: 3 dtest failures on the 3.0 branch, which all have corresponding failures upstream, plus a couple of failures on the original 2.2 branch which have since been addressed by other tickets. &lt;/p&gt;

&lt;p&gt;The internal paging will aim to read rows in chunks of ~4mb and I&apos;ve used the default CQL page size of 10k rows for a floor as it seems like as good a place to start as any. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmajercik&quot; class=&quot;user-hover&quot; rel=&quot;mmajercik&quot;&gt;mmajercik&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=anmols&quot; class=&quot;user-hover&quot; rel=&quot;anmols&quot;&gt;anmols&lt;/a&gt; how does this latest 3.0 version look with your testing? &lt;/p&gt;</comment>
                            <comment id="15725358" author="mmajercik" created="Tue, 6 Dec 2016 12:37:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;, the patch for branch &lt;em&gt;3.0&lt;/em&gt; works fine, however the page size for single partition pager appears to be calculated incorrectly. My table&apos;s average partition size is around &lt;b&gt;7GB&lt;/b&gt; and yet the page size got calculated as &lt;b&gt;1&lt;/b&gt;.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; calculateIndexingPageSize()
    {
        &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; averageRowSize = baseCfs.getMeanPartitionSize();
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (averageRowSize &amp;lt;= 0)
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; DEFAULT_PAGE_SIZE;

        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.max(1, &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(DEFAULT_PAGE_SIZE, 4 * 1024 * 1024 / averageRowSize));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This rendered index rebuild extremely slow as registering read/write order group implies significant performance overhead and for this reason the page size should have reasonable value.&lt;/p&gt;

&lt;p&gt;I think there is no harm if we set page size to &lt;tt&gt;DEFAULT_PAGE_SIZE&lt;/tt&gt; as the pager doesn&apos;t span across different partitions in case the partition is small (&lt;a href=&quot;https://github.com/mmajercik/cassandra/commit/3fc016e73d3032f4d04584a45945141151a49213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mmajercik/cassandra/commit/3fc016e73d3032f4d04584a45945141151a49213&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/mmajercik/cassandra/tree/12796-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12796-3.0&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15728596" author="JIRAUSER308715" created="Wed, 7 Dec 2016 12:01:55 +0000"  >&lt;p&gt;I think you want (row per part / (mean part size / 4 MB)) if you are guessing at &quot;rows per 4 MB&quot;&lt;/p&gt;</comment>
                            <comment id="15728610" author="beobal" created="Wed, 7 Dec 2016 12:07:52 +0000"  >&lt;p&gt;Yep, the method was totally wrong. I&apos;m not 100% comfortable with hardcoding the page size as suggested so I&apos;m just running some quick experiments to figure out a reasonable X for &quot;rows per X MB&quot;.&lt;/p&gt;</comment>
                            <comment id="15731594" author="beobal" created="Thu, 8 Dec 2016 08:58:39 +0000"  >&lt;p&gt;Pushed another commit with an implementation of &lt;tt&gt;calculateIndexingPageSize&lt;/tt&gt; which actually works. It isn&apos;t perfect of course, but when the average row size is smallish, it will tend to use the default page size of 10000, which is no problem as the each ordering will still only be held open for a matter of milliseconds. When rows are larger though, that default page size could cause problems as the orderings will be held open for much longer, so this will help to keep that window more consistently bounded. &lt;/p&gt;

&lt;p&gt;I&apos;ve also made the page size an argument to &lt;tt&gt;indexPartition&lt;/tt&gt; so we don&apos;t perform the redundant calculation for every partition. &lt;/p&gt;</comment>
                            <comment id="15731712" author="mmajercik" created="Thu, 8 Dec 2016 09:56:58 +0000"  >&lt;p&gt;Excellent. This is the closest we can get to keep target page size in bytes. Do you want me to test it with our test data? If not, could it be merged into the primary repository?&lt;/p&gt;</comment>
                            <comment id="15731908" author="beobal" created="Thu, 8 Dec 2016 11:26:07 +0000"  >&lt;p&gt;If you could double check with your test data, that&apos;d be awesome. I&apos;m just waiting for the latest CI runs to finish, so if all looks good with that &amp;amp; your test data I&apos;ll commit asap.&lt;/p&gt;</comment>
                            <comment id="15732258" author="JIRAUSER308715" created="Thu, 8 Dec 2016 13:48:45 +0000"  >&lt;p&gt;I think the new algorithm looks good. It has a much better chance of doing the right thing.  Couple nits on just that commit, I would put the table name in the TRACE log message, and you might add the new -D to the jvm.options file in 3.11+.&lt;/p&gt;</comment>
                            <comment id="15741428" author="mmajercik" created="Mon, 12 Dec 2016 09:25:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;, sorry for delay in response. Just tested your fix on our sample data and it works fine. Thank you for your help.&lt;/p&gt;</comment>
                            <comment id="15744831" author="beobal" created="Tue, 13 Dec 2016 10:41:54 +0000"  >&lt;p&gt;Thanks, committed to 2.2 in &lt;tt&gt;fb2940050e27a5642a23f3e9b5aaa7ae65e018b1&lt;/tt&gt; and to 3.0 (with the additional log info) in &lt;tt&gt;36ce4e02b429b1297d71c5c8a963623c62d9e159&lt;/tt&gt;. Also added the new -D switch to &lt;tt&gt;jvm.options&lt;/tt&gt; from 3.10 (i.e. the cassandra-3.11 branch) onwards.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 49 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34ywv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332984">2.1.9</customfieldvalue>
    <customfieldvalue id="12335581">2.2.7</customfieldvalue>
    <customfieldvalue id="12336056">3.0.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jjordan</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jjordan]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335581">2.2.7</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>