<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:09:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13069] Local batchlog for MV may not be correctly written on node movements</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13069</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Unless I&apos;m really reading this wrong, I think the code &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageProxy.java#L829-L843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, which comes from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10674&quot; title=&quot;Materialized View SSTable streaming/leaving status race on decommission&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10674&quot;&gt;&lt;del&gt;CASSANDRA-10674&lt;/del&gt;&lt;/a&gt;, isn&apos;t working properly.&lt;/p&gt;

&lt;p&gt;More precisely, I believe we can have both paired and unpaired mutations, so that both &lt;tt&gt;if&lt;/tt&gt; can be taken, but if that&apos;s the case, the 2nd write to the batchlog will basically overwrite (remove) the batchlog write of the 1st &lt;tt&gt;if&lt;/tt&gt; and I don&apos;t think that&apos;s the intention. In practice, this means &quot;paired&quot; mutation won&apos;t be in the batchlog, which mean they won&apos;t be replayed at all if they fail.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13029803">CASSANDRA-13069</key>
            <summary>Local batchlog for MV may not be correctly written on node movements</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pauloricardomg">Paulo Motta</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Wed, 21 Dec 2016 16:02:11 +0000</created>
                <updated>Fri, 15 May 2020 08:03:43 +0000</updated>
                            <resolved>Tue, 12 Sep 2017 13:40:06 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Feature/Materialized Views</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15768495" author="pauloricardomg" created="Wed, 21 Dec 2016 23:39:41 +0000"  >&lt;p&gt;Good catch! In the patch below I fixed this by writing a single batchlog for all non-local mutations (remote as well as non-paired). If the batchlog contains non-paired mutations, it will not receive acks and thus it will not be cleared, so it will be hopefully replayed after the ring has stabilized.&lt;/p&gt;

&lt;p&gt;I also removed the &lt;tt&gt;pendingEndpoints.isEmpty()&lt;/tt&gt; condition to skip the batchlog for local mutations, since this was a pre-&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10674&quot; title=&quot;Materialized View SSTable streaming/leaving status race on decommission&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10674&quot;&gt;&lt;del&gt;CASSANDRA-10674&lt;/del&gt;&lt;/a&gt; leftover when &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0.0-rc1/src/java/org/apache/cassandra/db/view/ViewUtils.java#L100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ViewUtils.getViewNaturalEndpoint&lt;/a&gt; returned the local address to force non-paired replicas to be written to the batchlog.&lt;/p&gt;

&lt;p&gt;While fixing this I noticed that we don&apos;t decrement the &lt;tt&gt;BatchlogCleanup&lt;/tt&gt; counter on local mutations, so if there are both local and remote paired mutations the batchlog is never cleared. This was reproduced on &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/compare/master...pauloricardomg:13069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this dtest&lt;/a&gt;. This might explain why &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brstgt&quot; class=&quot;user-hover&quot; rel=&quot;brstgt&quot;&gt;brstgt&lt;/a&gt; experienced multi-GB batchlogs when bootstrapping nodes with multiple MVs on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12905&quot; title=&quot;Retry acquire MV lock on failure instead of throwing WTE on streaming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12905&quot;&gt;&lt;del&gt;CASSANDRA-12905&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Patch and tests available below:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-13069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...pauloricardomg:3.11-13069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-13069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/riptano/cassandra-dtest/compare/master...pauloricardomg:13069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-13069-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.11-13069-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-13069-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-13069-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.11-13069-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-13069-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15857905" author="slebresne" created="Wed, 8 Feb 2017 12:10:32 +0000"  >&lt;p&gt;The patch looks good (though please add braces after the &lt;tt&gt;if ((pairedEndpoint.get().equals(...))&lt;/tt&gt;) in that it fixes the issue mentioned in the description, and I agree not decrementing the cleanup on local mutations was wrong. But I&apos;m honestly a bit confused about our use of the (local) batchlog for MVs and I don&apos;t think it&apos;s right.&lt;/p&gt;

&lt;p&gt;As far as I can tell, the goal of using a local batchlog is to guarantee eventual consistency of a the base table and its views. That is, no matter what happens for a given update, either both that update and all the related view updates get eventually applied, or none of it is. But unless I&apos;m missing something subtle (for which there is no comment in the code), the batchlog will only guarantees that if &lt;em&gt;all&lt;/em&gt; mutations are grouped in it. So I don&apos;t understand why:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;we don&apos;t include local view mutations in the batchlog in &lt;tt&gt;SP.mutateMV&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;the base table mutation isn&apos;t included in said batchlog alongside it&apos;s related view updates.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I&apos;ll note that fixing the first point in &lt;tt&gt;mutateMV&lt;/tt&gt; would actually simplify the method and If I&apos;m not completely wrong here I suggest we at least do that on this ticket. It still won&apos;t solve the 2nd point, but that&apos;s arguably more involved so I&apos;m ok creating a follow-up ticket for that (still, it kind of breaks the one basic guarantee MVs are supposed to provide, so it&apos;s kind of critical).&lt;/p&gt;</comment>
                            <comment id="16091232" author="kurtg" created="Tue, 18 Jul 2017 07:42:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt; are you still working on this? If you want I can take over.&lt;/p&gt;</comment>
                            <comment id="16091707" author="pauloricardomg" created="Tue, 18 Jul 2017 15:23:49 +0000"  >&lt;p&gt; sorry for the delay, got sucked into other things but I am halfway through a patch so will submit this or next week.&lt;/p&gt;</comment>
                            <comment id="16139795" author="pauloricardomg" created="Thu, 24 Aug 2017 09:13:31 +0000"  >&lt;p&gt;Finally getting back to this after a while, sorry for the delay! Going back to the question of the last review round:&lt;/p&gt;

&lt;blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;As far as I can tell, the goal of using a local batchlog is to guarantee eventual consistency of a the base table and its views. That is, no matter what happens for a given update, either both that update and all the related view updates get eventually applied, or none of it is. So I don&apos;t understand why:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;1. we don&apos;t include local view mutations in the batchlog in SP.mutateMV.&lt;br/&gt;
2. the base table mutation isn&apos;t included in said batchlog alongside it&apos;s related view updates.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I ended up writing a &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/00a0bef75129a396aeee2cedc89d6a6ec66f610e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk patch&lt;/a&gt; to include both local and base table mutations in the batchlog as suggested, but then looking at the original code I figured that whatever failure happens during views update (but before the local base or views are persisted) is safeguarded by the &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/Keyspace.java#L595&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;base tablecommit log write&lt;/a&gt; prior to the view update, so I don&apos;t think we actually need to include the local mutations in the batchlog.&lt;/p&gt;

&lt;p&gt;Given that remote view writes are &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageProxy.java#L843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fire and forget&lt;/a&gt;,  the most probable cause of failure during local view writing would be a crash, and in that case the commit log replay will re-apply the base mutations and views. The two downsides I can think of are:&lt;br/&gt;
a) We cannot ensure the commit log is actually persisted before the crash, unless batch commit log is used.&lt;br/&gt;
b) The user may have durable_writes=false&lt;br/&gt;
c) I&apos;m not sure if many other non-crash failures are possible in this case (fail local base and view mutations), besides full/corrupted disk, in which case you are screwed anyway, but if they happen you&apos;ll need to wait until the next restart/commitlog replay to have your base-views consistent.&lt;/p&gt;

&lt;p&gt;There&apos;s not much we can do about a), so it seems we&apos;ll just need to live with this and rely on repair to fix potential inconsistencies? b) is actually a problem even with including local mutations in the batchlog write, unless we force batchlog writes to be durable. c) is not a big deal unless there are other legitimate non-crash scenarios which I&apos;m not aware of.&lt;/p&gt;

&lt;p&gt;Adding the local base mutation to the view batchlog requires the following changes:&lt;br/&gt;
a) Special case the batchlog write-path to &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/00a0bef75129a396aeee2cedc89d6a6ec66f610e#diff-b8ec5deb7141558cf8f868460077be31R94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;skip writing the base mutation&lt;/a&gt;, since that will be written by the calling thread after the view updates, and &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/00a0bef75129a396aeee2cedc89d6a6ec66f610e#diff-9ca8d303d375e01a14d42154eaf46e37R556&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ack it&lt;/a&gt; after the base table write is done so the batchlog can be clean.&lt;br/&gt;
b) Special case the batchlog &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/00a0bef75129a396aeee2cedc89d6a6ec66f610e#diff-c77d5f1027ee5e8a49e106903a4ca937R458&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;replay path&lt;/a&gt; to avoid generating views when replaying base table mutations in the case of view batchlogs.&lt;/p&gt;

&lt;p&gt;So, unless there&apos;s a good reason not mentioned above to include the local mutations on the view batchlog, I&apos;d prefer to keep the current approach of writing only remote view mutations in the view batchlog. If you agree with that, I &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/8314ced9f1077224008e79e4c23d00d3277073d5#diff-71f06c193f5b5e270cf8ac695164f43aR732&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;added a comment&lt;/a&gt; in the original patch explaining why the local mutations are not included in the local batchlog to avoid confusion in the future. Please find the updated patch below:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-13069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-13069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/riptano/cassandra-dtest/compare/master...pauloricardomg:13069&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://jenkins-cassandra.datastax.lan/view/Dev/view/paulomotta/job/pauloricardomg-3.0-13069-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://jenkins-cassandra.datastax.lan/view/Dev/view/paulomotta/job/pauloricardomg-trunk-13069-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://jenkins-cassandra.datastax.lan/view/Dev/view/paulomotta/job/pauloricardomg-3.0-13069-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://jenkins-cassandra.datastax.lan/view/Dev/view/paulomotta/job/pauloricardomg-trunk-13069-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;I&apos;ve added 2 &lt;a href=&quot;https://github.com/pauloricardomg/cassandra-dtest/commit/f0b7983dd26cd269c8f629f6de8ddd585e644b29#diff-62ba429edee6a4681782f078246c9893R1575&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; to check that base and view are consistent on crash before and after the view is applied, which detected that a newly &lt;a href=&quot;https://github.com/apache/cassandra/blob/8314ced9f1077224008e79e4c23d00d3277073d5/src/java/org/apache/cassandra/service/StorageProxy.java#L726&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;created&lt;/a&gt; batchlog from commit-log replay is not immediately replayed due to the batchlog replay delay, so I removed that wait on the &lt;a href=&quot;https://github.com/apache/cassandra/blob/96168c00a85559fd687d64f9df664b08711b933b/src/java/org/apache/cassandra/batchlog/BatchlogManager.java#L210&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;first replay&lt;/a&gt;. I also updated the MV test to verify that the view batchlog is &lt;a href=&quot;https://github.com/pauloricardomg/cassandra-dtest/commit/f0b7983dd26cd269c8f629f6de8ddd585e644b29#diff-62ba429edee6a4681782f078246c9893R124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;empty after replay&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I did a few simplifications in the MV and batchlog write path in the &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/tree/trunk-13069-add-local-to-view-batchlog&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;other patch&lt;/a&gt; which may be worth keeping, so if we decide keeping the current approach of skipping local mutations on the batchlog I will open a new ticket with the refactoring suggestions.&lt;/p&gt;</comment>
                            <comment id="16161002" author="slebresne" created="Mon, 11 Sep 2017 10:00:09 +0000"  >&lt;p&gt;What I had in mind was more about simplifying the whole view write patch to be 1) write a batchlog for local+view mutations and then 2) apply those mutations, which implied rewriting &lt;tt&gt;Keyspace.apply&lt;/tt&gt; so we don&apos;t start by writing the base mutation in the commit log for instance, and I still think it would be both simpler code-wise and be more easy to reason about correction. But this is admittedly not the place to debate about this, and you are right that things aren&apos;t as grim as I portrayed it in my previous comment anyway, so happy to focus on just the bug for which this was opened for.&lt;/p&gt;

&lt;p&gt;So things mostly look good except for the &lt;tt&gt;isFirstReplay&lt;/tt&gt; addition in &lt;tt&gt;BatchLogManager&lt;/tt&gt; that I&apos;m fairly unsure about. My understanding is that the main goal of the batchlog delay is to avoid replaying batches that may still have a change to succeed, but your change seems to break that, so it sounds like that could have adverse performance effect, including on non-view usages of the batchlog. To be honest though, the batchlog code isn&apos;t my main area of expertise, so if if you feel this is important and not a real problem, I&apos;d prefer we isolate that change to a separate ticket so it is looked in its own right (and preferably by someone more knowledgeable of that code).&lt;/p&gt;</comment>
                            <comment id="16162434" author="pauloricardomg" created="Tue, 12 Sep 2017 03:08:33 +0000"  >&lt;p&gt;Thanks for the review!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But this is admittedly not the place to debate about this, and you are right that things aren&apos;t as grim as I portrayed it in my previous comment anyway, so happy to focus on just the bug for which this was opened for.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;My understanding is that the main goal of the batchlog delay is to avoid replaying batches that may still have a change to succeed, but your change seems to break that, so it sounds like that could have adverse performance effect, including on non-view usages of the batchlog.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed, I was not very happy with this either, thanks for noting. The main reason was to ensure the view batchlog would be replayed on startup, to be able to test that properly, but I was able to achieve the same effect by &lt;a href=&quot;https://github.com/apache/cassandra/commit/a3672d5bb825a53c732e9534073c4e1ea729dedd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;exposing the batchlog timeout&lt;/a&gt; via a &lt;tt&gt;-Dcassandra.batchlog.replay_timeout_in_ms&lt;/tt&gt; property, which &lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/master...pauloricardomg:13069#diff-62ba429edee6a4681782f078246c9893R1943&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;is set during dtest&lt;/a&gt; and waited before replay. &lt;/p&gt;

&lt;p&gt;In practice, this means the user will still need to wait &lt;tt&gt;cassandra.batchlog.replay_timeout_in_ms=2*write_request_timeout_in_ms&lt;/tt&gt; to ensure its failed views will be properly applied after a node is restartated, but since this is 4s by default it should be acceptable.&lt;/p&gt;

&lt;p&gt;Resubmitted CI with the above change. Please let me know what do you think.&lt;/p&gt;</comment>
                            <comment id="16162589" author="slebresne" created="Tue, 12 Sep 2017 07:13:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;Resubmitted CI with the above change. Please let me know what do you think.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Lgtm, +1 if CI is happy (or at least as happy as it usually is).&lt;/p&gt;</comment>
                            <comment id="16162945" author="pauloricardomg" created="Tue, 12 Sep 2017 13:40:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;Lgtm, +1 if CI is happy (or at least as happy as it usually is).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;CI look good, committed as &lt;tt&gt;12103653f313d6f1ef030a535986123ddcffea9c&lt;/tt&gt; to cassandra-3.0 and merge up to cassandra-3.11 and master. Dtests merged to cassandra-dtest master as &lt;tt&gt;c39a85c3e7b2869ef3fffafe1380362d6469919d&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Thanks for the review!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13140056">CASSANDRA-14251</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="13038502">CASSANDRA-13162</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="13161" cascade-level="1"><![CDATA[Unrecoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 10 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37vuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>