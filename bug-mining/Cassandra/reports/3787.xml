<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:57:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10057] RepairMessageVerbHandler.java:95 - Cannot start multiple repair sessions over the same sstables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10057</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I bootstrapped a DC2 by restoring the snapshots from DC1 into equivalent nodes in DC2. Everything comes up just fine, but when I tried to run a &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;repair -dcpar -j4&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; in DC2, I got this error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[root@cassandra-i-2677cce3 ~]# nodetool repair -dcpar -j4
[2015-08-12 15:56:05,682] Nothing to repair &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; keyspace &lt;span class=&quot;code-quote&quot;&gt;&apos;system_auth&apos;&lt;/span&gt;
[2015-08-12 15:56:05,949] Starting repair command #4, repairing keyspace crawl with repair options (parallelism: dc_parallel, primary range: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, incremental: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, job threads: 4, ColumnFamilies: [], dataCenters: [], hosts: [], # of ranges: 2275)
[2015-08-12 15:59:33,050] Repair session 1b8d7810-410b-11e5-b71c-71288cf05b1d &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (-1630840392403060839,-1622173360499444177] finished (progress: 0%)
[2015-08-12 15:59:33,284] Repair session 1b92a830-410b-11e5-b71c-71288cf05b1d &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (-2766833977081486018,-2766120936176524808] failed with error Could not create snapshot at /10.20.144.15 (progress: 0%)
[2015-08-12 15:59:35,543] Repair session 1b8fe910-410b-11e5-b71c-71288cf05b1d &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (5127720400742928658,5138864412691114632] finished (progress: 0%)
[2015-08-12 15:59:36,040] Repair session 1b960390-410b-11e5-b71c-71288cf05b1d &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (749871306972906628,751065038788146229] failed with error Could not create snapshot at /10.20.144.15 (progress: 0%)
[2015-08-12 15:59:36,454] Repair session 1b9455e0-410b-11e5-b71c-71288cf05b1d &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (-8769666365699147423,-8767955202550789015] finished (progress: 0%)
[2015-08-12 15:59:38,765] Repair session 1b97b140-410b-11e5-b71c-71288cf05b1d &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (-4434580467371714601,-4433394767535421669] finished (progress: 0%)
[2015-08-12 15:59:41,520] Repair session 1b99d420-410b-11e5-b71c-71288cf05b1d &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (-1085112943862424751,-1083156277882030877] finished (progress: 0%)
[2015-08-12 15:59:43,806] Repair session 1b9da4b0-410b-11e5-b71c-71288cf05b1d &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (2125359121242932804,2126816999370470831] failed with error Could not create snapshot at /10.20.144.15 (progress: 0%)
[2015-08-12 15:59:43,874] Repair session 1b9ba8e0-410b-11e5-b71c-71288cf05b1d &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (-7469857353178912795,-7459624955099554284] finished (progress: 0%)
[2015-08-12 15:59:48,384] Repair session 1b9fa080-410b-11e5-b71c-71288cf05b1d &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (-8005238987831093686,-8005057803798566519] finished (progress: 0%)
[2015-08-12 15:59:48,392] Repair session 1ba17540-410b-11e5-b71c-71288cf05b1d &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (7291056720707652994,7292508243124389877] failed with error Could not create snapshot at /10.20.144.15 (progress: 0%)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems like now that all 4 threads ran into an error, the repair process just sits forever.&lt;/p&gt;

&lt;p&gt;Looking at 10.20.144.15, I see this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [AntiEntropyStage:2] 2015-08-12 15:59:35,965 RepairMessageVerbHandler.java:95 - Cannot start multiple repair sessions over the same sstables
ERROR [AntiEntropyStage:2] 2015-08-12 15:59:35,966 RepairMessageVerbHandler.java:153 - Got error, removing parent repair session
ERROR [AntiEntropyStage:2] 2015-08-12 15:59:35,966 CassandraDaemon.java:182 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[AntiEntropyStage:2,5,main]
java.lang.RuntimeException: java.lang.RuntimeException: Cannot start multiple repair sessions over the same sstables
        at org.apache.cassandra.repair.RepairMessageVerbHandler.doVerb(RepairMessageVerbHandler.java:156) ~[apache-cassandra-2.2.0.jar:2.2.0]
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:64) ~[apache-cassandra-2.2.0.jar:2.2.0]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_85]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) ~[na:1.7.0_85]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) ~[na:1.7.0_85]
Caused by: java.lang.RuntimeException: Cannot start multiple repair sessions over the same sstables
        at org.apache.cassandra.repair.RepairMessageVerbHandler.doVerb(RepairMessageVerbHandler.java:96) ~[apache-cassandra-2.2.0.jar:2.2.0]
        ... 4 common frames omitted
ERROR [AntiEntropyStage:3] 2015-08-12 15:59:38,722 RepairMessageVerbHandler.java:153 - Got error, removing parent repair session
ERROR [AntiEntropyStage:3] 2015-08-12 15:59:38,723 CassandraDaemon.java:182 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[AntiEntropyStage:3,5,main]
java.lang.RuntimeException: java.lang.NullPointerException
        at org.apache.cassandra.repair.RepairMessageVerbHandler.doVerb(RepairMessageVerbHandler.java:156) ~[apache-cassandra-2.2.0.jar:2.2.0]
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:64) ~[apache-cassandra-2.2.0.jar:2.2.0]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_85]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) ~[na:1.7.0_85]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) ~[na:1.7.0_85]
Caused by: java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at org.apache.cassandra.repair.RepairMessageVerbHandler.doVerb(RepairMessageVerbHandler.java:98) ~[apache-cassandra-2.2.0.jar:2.2.0]
        ... 4 common frames omitted
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I thought maybe the -j4 was causing the issue, but when I run it without the -j param, I get the same error but on a different node.&lt;/p&gt;

&lt;p&gt;It seems like there are two problems:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The error on the node: 
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;RepairMessageVerbHandler.java:95 - Cannot start multiple repair sessions over the same sstables&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;The repair process on the initiating node just sits there forever after the threads ran into an error. It seems to me that it should exit out and report back an error to the user.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment>&lt;p&gt;Amazon Linux: 3.14.48-33.39.amzn1.x86_64&lt;br/&gt;
java version &quot;1.7.0_85&quot;&lt;br/&gt;
OpenJDK Runtime Environment (amzn-2.6.1.3.61.amzn1-x86_64 u85-b01)&lt;br/&gt;
OpenJDK 64-Bit Server VM (build 24.85-b03, mixed mode)&lt;br/&gt;
Cassandra RPM: cassandra22-2.2.0-1.noarch&lt;/p&gt;</environment>
        <key id="12855615">CASSANDRA-10057</key>
            <summary>RepairMessageVerbHandler.java:95 - Cannot start multiple repair sessions over the same sstables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="victortrac">Victor Trac</reporter>
                        <labels>
                    </labels>
                <created>Wed, 12 Aug 2015 17:27:14 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:00 +0000</updated>
                            <resolved>Tue, 1 Sep 2015 14:35:57 +0000</resolved>
                                        <fixVersion>2.2.2</fixVersion>
                    <fixVersion>3.0 beta 2</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14707161" author="yukim" created="Fri, 21 Aug 2015 18:00:37 +0000"  >&lt;p&gt;I haven&apos;t been able to reprodece this myself yet, but it looks like users can get this error.&lt;br/&gt;
There are two problems here:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;del&gt;&lt;tt&gt;-j&lt;/tt&gt; runs repair on table concurrently within given range. there can be the same table but different range repairing at the same time, and both repair tries to snapshot the same SSTable.&lt;/del&gt; I missed the code. This is taken care of in &lt;tt&gt;currentlyRepairing&lt;/tt&gt; so the same SSTable within the same parent session is fine.&lt;/li&gt;
	&lt;li&gt;When above error occurs, RuntimeException is just thrown, so repair can be stuck.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="14707274" author="yukim" created="Fri, 21 Aug 2015 19:08:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=victortrac&quot; class=&quot;user-hover&quot; rel=&quot;victortrac&quot;&gt;victortrac&lt;/a&gt; If you invoke repair on multiple node at once, this can be happen. Can you confirm?&lt;br/&gt;
And once it happens, the error will continue unless you restart the node since some resources remain due to the hang.&lt;br/&gt;
I will post the patch not to hang.&lt;/p&gt;</comment>
                            <comment id="14710159" author="yukim" created="Mon, 24 Aug 2015 22:17:17 +0000"  >&lt;p&gt;Patch to prevent hang while snapshot. It also deletes created snapshot as pointed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8327&quot; title=&quot;snapshots taken before repair are not cleared if snapshot fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8327&quot;&gt;&lt;del&gt;CASSANDRA-8327&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/yukim/cassandra/tree/10057&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yukim/cassandra/tree/10057&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;testall: &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/yukim/job/yukim-10057-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/yukim/job/yukim-10057-testall/&lt;/a&gt;&lt;br/&gt;
dtest: &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/yukim/job/yukim-10057-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/yukim/job/yukim-10057-dtest/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14710217" author="victortrac" created="Mon, 24 Aug 2015 22:53:47 +0000"  >&lt;p&gt;I&apos;ve since blown away the cluster and reverted back to Cassandra 2.1, but this sounds about right. I definitely invoked repair on more than one node, ctrl-c&apos;d the repair, and tried on another node without restarting the cassandra process on any nodes. &lt;/p&gt;</comment>
                            <comment id="14711136" author="krummas" created="Tue, 25 Aug 2015 11:57:28 +0000"  >&lt;p&gt;Can&apos;t we send the failure response in the existing catch block? That would make sure we fail properly during all repair messages&lt;/p&gt;</comment>
                            <comment id="14715550" author="yukim" created="Wed, 26 Aug 2015 21:28:36 +0000"  >&lt;p&gt;Snapshot is taken per repair job, and one repair job failure does not have to fail entire repair session.&lt;br/&gt;
Catch block wipes parent repair session, so it&apos;s not suitable to continue repairing by sending failure response.&lt;/p&gt;</comment>
                            <comment id="14723092" author="krummas" created="Mon, 31 Aug 2015 07:32:33 +0000"  >&lt;p&gt;ok, +1 on the current patch then&lt;/p&gt;</comment>
                            <comment id="14725487" author="yukim" created="Tue, 1 Sep 2015 14:35:58 +0000"  >&lt;p&gt;Thanks, committed.&lt;/p&gt;</comment>
                            <comment id="14947105" author="cowardlydragon" created="Wed, 7 Oct 2015 16:09:43 +0000"  >&lt;p&gt;We are encountering this error. We will try restarts of nodes to see if it fixes it&lt;/p&gt;

&lt;p&gt;When is this being backported to 2.1.X?&lt;/p&gt;</comment>
                            <comment id="15136158" author="nnishant" created="Sun, 7 Feb 2016 06:33:10 +0000"  >&lt;p&gt;Guys,&lt;br/&gt;
is this fix also applicable for V2.2.4? We are running into same issues in addition to following error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[2016-02-07 01:00:17,477] Repair session 26c3c380-cd36-11e5-abde-1d9681013b36 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (2881082214758500134,2995213907575973035] failed with error [repair #26c3c380-cd36-11e5-abde-1d9681013b36 on &amp;lt;keyspace&amp;gt;/&amp;lt;CF&amp;gt;, (2881082214758500134,2995213907575973035]] Validation failed in /&amp;lt;node IP&amp;gt; (progress: 74%)
---
---
[2016-02-07 01:00:17,815] Some repair failed.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We tried bouncing the nodes which help with error &quot;Multiple repair session&quot; but we still face &quot;Validation failed error&quot;&lt;br/&gt;
on a specific Keyspace. &lt;/p&gt;

&lt;p&gt;As per &lt;a href=&quot;https://support.datastax.com/hc/en-us/articles/205256895--Validation-failed-when-running-a-nodetool-repair&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://support.datastax.com/hc/en-us/articles/205256895--Validation-failed-when-running-a-nodetool-repair&lt;/a&gt;&lt;br/&gt;
We did tried to scrub the table on the node it is complaining but again it started complaining for some other nodes.&lt;/p&gt;

&lt;p&gt;Any help in this regard would be much appreciated.&lt;br/&gt;
Thanks!!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12888754">CASSANDRA-10375</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 41 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2iu33:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>