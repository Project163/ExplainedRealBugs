<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:12:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14672] After deleting data in 3.11.3, reads fail with &quot;open marker and close marker have different deletion times&quot;</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14672</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We had 3.11.0, then we upgraded to 3.11.3 last week.&#160;We routinely perform deletions as the one described below. After upgrading we run the following deletion query:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
DELETE FROM measurement_events_dbl WHERE measurement_source_id IN ( 9df798a2-6337-11e8-b52b-42010afa015a,&#160; 9df7717e-6337-11e8-b52b-42010afa015a, a08b8042-6337-11e8-b52b-42010afa015a, a08e52cc-6337-11e8-b52b-42010afa015a, a08e6654-6337-11e8-b52b-42010afa015a, a08e6104-6337-11e8-b52b-42010afa015a, a08e6c76-6337-11e8-b52b-42010afa015a, a08e5a9c-6337-11e8-b52b-42010afa015a, a08bcc50-6337-11e8-b52b-42010afa015a) AND year IN (2018) AND measurement_time &amp;gt;= &lt;span class=&quot;code-quote&quot;&gt;&apos;2018-07-19 04:00:00&apos;&lt;/span&gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Immediately after that, trying to read the last value produces an error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select * FROM measurement_events_dbl WHERE measurement_source_id = a08b8042-6337-11e8-b52b-42010afa015a AND year IN (2018) order by measurement_time desc limit 1;
ReadFailure: Error from server: code=1300 [Replica(s) failed to execute read] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;Operation failed - received 0 responses and 2 failures&quot;&lt;/span&gt; info={&lt;span class=&quot;code-quote&quot;&gt;&apos;failures&apos;&lt;/span&gt;: 2, &lt;span class=&quot;code-quote&quot;&gt;&apos;received_responses&apos;&lt;/span&gt;: 0, &lt;span class=&quot;code-quote&quot;&gt;&apos;required_responses&apos;&lt;/span&gt;: 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;consistency&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;ONE&apos;&lt;/span&gt;}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;And the following exception:&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN [ReadStage-4] 2018-08-29 06:59:53,505 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread[ReadStage-4,5,main]: {}
java.lang.RuntimeException: java.lang.IllegalStateException: UnfilteredRowIterator for pvpms_mevents.measurement_events_dbl has an illegal RT bounds sequence: open marker and close marker have different deletion times
 at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2601) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_181]
 at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:162) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:134) [apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:109) [apache-cassandra-3.11.3.jar:3.11.3]
 at java.lang.Thread.run(Thread.java:748) [na:1.8.0_181]
Caused by: java.lang.IllegalStateException: UnfilteredRowIterator for pvpms_mevents.measurement_events_dbl has an illegal RT bounds sequence: open marker and close marker have different deletion times
 at org.apache.cassandra.db.transform.RTBoundValidator$RowsTransformation.ise(RTBoundValidator.java:103) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.transform.RTBoundValidator$RowsTransformation.applyToMarker(RTBoundValidator.java:81) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:148) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:136) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:92) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:79) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:308) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.ReadResponse$LocalDataResponse.build(ReadResponse.java:187) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:180) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:176) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.ReadResponse.createDataResponse(ReadResponse.java:76) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:352) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1889) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2597) ~[apache-cassandra-3.11.3.jar:3.11.3]
 ... 5 common frames omitted
 Suppressed: java.lang.IllegalStateException: UnfilteredRowIterator for pvpms_mevents.measurement_events_dbl has an illegal RT bounds sequence: expected all RTs to be closed, but the last one is open
 at org.apache.cassandra.db.transform.RTBoundValidator$RowsTransformation.ise(RTBoundValidator.java:103) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.transform.RTBoundValidator$RowsTransformation.onPartitionClose(RTBoundValidator.java:96) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.transform.BaseRows.runOnClose(BaseRows.java:91) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.transform.BaseIterator.close(BaseIterator.java:86) ~[apache-cassandra-3.11.3.jar:3.11.3]
 at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:309) ~[apache-cassandra-3.11.3.jar:3.11.3]
 ... 12 common frames omitted
&#160;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We have 9 nodes ~2TB each, leveled compaction, repairs run daily in sequence.&lt;/p&gt;

&lt;p&gt;Table definition is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE pvpms_mevents.measurement_events_dbl (
 measurement_source_id uuid,
 year int,
 measurement_time timestamp,
 event_reception_time timestamp,
 quality double,
 value double,
 PRIMARY KEY ((measurement_source_id, year), measurement_time)
) WITH CLUSTERING ORDER BY (measurement_time ASC)
 AND bloom_filter_fp_chance = 0.1
 AND caching = {&apos;keys&apos;: &apos;ALL&apos;, &apos;rows_per_partition&apos;: &apos;NONE&apos;}
 AND comment = &apos;&apos;
 AND compaction = {&apos;class&apos;: &apos;org.apache.cassandra.db.compaction.LeveledCompactionStrategy&apos;}
 AND compression = {&apos;chunk_length_in_kb&apos;: &apos;64&apos;, &apos;class&apos;: &apos;org.apache.cassandra.io.compress.LZ4Compressor&apos;}
 AND crc_check_chance = 1.0
 AND dclocal_read_repair_chance = 0.1
 AND default_time_to_live = 0
 AND gc_grace_seconds = 864000
 AND max_index_interval = 2048
 AND memtable_flush_period_in_ms = 0
 AND min_index_interval = 128
 AND read_repair_chance = 0.0
 AND speculative_retry = &apos;99PERCENTILE&apos;;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We host those on GCE and recreated all the nodes with disk snapshots, and we reproduced the error: after re-running the&#160;DELETE with all nodes up and no other queries running, the&#160;error was reproduced immediately.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We tried so far:&lt;/p&gt;

&lt;p&gt;re-running repairs on all nodes and running nodetool&#160;garbagecollect with no success.&lt;/p&gt;

&lt;p&gt;We downgraded to 3.11.2 for now, no issues so far.&lt;/p&gt;

&lt;p&gt;This may be related to&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14515&quot; title=&quot;Short read protection in presence of almost-purgeable range tombstones may cause permanent data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14515&quot;&gt;&lt;del&gt;CASSANDRA-14515&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;CentOS 7, GCE, 9 nodes, 4TB disk/~2TB full each, level compaction, timeseries data&lt;/p&gt;</environment>
        <key id="13181807">CASSANDRA-14672</key>
            <summary>After deleting data in 3.11.3, reads fail with &quot;open marker and close marker have different deletion times&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="sivann">Spiros Ioannou</reporter>
                        <labels>
                    </labels>
                <created>Wed, 29 Aug 2018 07:09:11 +0000</created>
                <updated>Fri, 15 May 2020 08:01:37 +0000</updated>
                            <resolved>Tue, 25 Sep 2018 16:48:51 +0000</resolved>
                                        <fixVersion>3.0.18</fixVersion>
                    <fixVersion>3.11.4</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="16617214" author="mitsis" created="Mon, 17 Sep 2018 08:29:13 +0000"  >&lt;p&gt;We did some testing on a replica environment. Specifically added some printf statements to check the timestamps on open and close marker that Cassandra complains.&lt;/p&gt;

&lt;p&gt;The replication factor is 3, nodes 6, 8 &amp;amp; 9 contain the data. Node 8 &amp;amp; 9 are throwing the exception, node 6 when queried with consistency one does not fail (returns proper data - see below why).&lt;/p&gt;

&lt;p&gt;On node8 &amp;amp; node9 the following timestamps are found:&lt;/p&gt;

&lt;p&gt;Printf:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;==&amp;gt; openMarkerDeletionTime: null
==&amp;gt; openMarkerDeletionTime: deletedAt=1537103654634113, localDeletion=1537103654
==&amp;gt; deletionTime: deletedAt=1530205388555918, localDeletion=1530205388
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Exception:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN [ReadStage-1] 2018-09-16 14:40:44,252 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread[ReadStage-1,5,main]: {}
java.lang.IllegalStateException: ==&amp;gt; UnfilteredRowIterator for pvpms_mevents.measurement_events_dbl has an illegal RT bounds sequence: open marker and close marker have different deletion times [deletedAt=1537103654634113, localDeletion=1537103654 deletedAt=1530205388555918, localDeletion=1530205388]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Converted timestamps:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;openDeletionTime: Sun Sep 16 13:14:14 UTC 2018
closeDeletionTime: Thu Jun 28 17:03:08 UTC 2018
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;DELETE FROM command above was run on Sep 16.&lt;/p&gt;

&lt;p&gt;On node6 :&lt;/p&gt;

&lt;p&gt;Printf:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;==&amp;gt; openMarkerDeletionTime: null
==&amp;gt; openMarkerDeletionTime: deletedAt=1537103654634113, localDeletion=1537103654
==&amp;gt; deletionTime: deletedAt=1537103654634113, localDeletion=1537103654
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Converted timestamps:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Sun Sep 16 13:14:14 UTC 2018
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;No Exception!&lt;/p&gt;

&lt;p&gt;We did a json dump of the specified data from node 8 &amp;amp; 9 and found a range_tombstone_bound with timestamp start/end of &quot;2018-06-28T17:03:08Z&quot; that contains data from Jul &amp;amp; Aug (see rows below). On node 6 the same same data are not within a tombstone marker (it&#8217;s the same json without the range_tombstone_bound).&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   &quot;partition&quot; : {
      {
        &quot;type&quot; : &quot;range_tombstone_bound&quot;,
        &quot;start&quot; : {
          &quot;type&quot; : &quot;exclusive&quot;,
          &quot;clustering&quot; : [ &quot;2018-06-27 04:55:00.000Z&quot; ],
          &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2018-06-28T17:03:08.555918Z&quot;, &quot;local_delete_time&quot; : &quot;2018-06-28T17:03:08Z&quot; }
        }
      },
      {
        &quot;type&quot; : &quot;row&quot;,
        &quot;position&quot; : 83860313,
        &quot;clustering&quot; : [ &quot;2018-06-27 05:00:00.000Z&quot; ],
        &quot;liveness_info&quot; : { &quot;tstamp&quot; : &quot;2018-06-28T19:45:30.803293Z&quot; },
        &quot;cells&quot; : [
          { &quot;name&quot; : &quot;event_reception_time&quot;, &quot;value&quot; : &quot;2018-06-28 19:45:30.784Z&quot; },
          { &quot;name&quot; : &quot;quality&quot;, &quot;value&quot; : 100.0 },
          { &quot;name&quot; : &quot;value&quot;, &quot;value&quot; : 408307.66 }
        ]
      },
&#8230;
      {
        &quot;type&quot; : &quot;row&quot;,
        &quot;position&quot; : 83953463,
        &quot;clustering&quot; : [ &quot;2018-07-19 03:45:00.000Z&quot; ],
        &quot;liveness_info&quot; : { &quot;tstamp&quot; : &quot;2018-07-19T03:46:29.195118Z&quot; },
        &quot;cells&quot; : [
          { &quot;name&quot; : &quot;event_reception_time&quot;, &quot;value&quot; : &quot;2018-07-19 03:46:29.193Z&quot; },
          { &quot;name&quot; : &quot;quality&quot;, &quot;value&quot; : 100.0 },
          { &quot;name&quot; : &quot;value&quot;, &quot;value&quot; : 593846.06 }
        ]
      },
&#8230;
      {
        &quot;type&quot; : &quot;row&quot;,
        &quot;position&quot; : 84054985,
        &quot;clustering&quot; : [ &quot;2018-08-11 04:00:00.000Z&quot; ],
        &quot;liveness_info&quot; : { &quot;tstamp&quot; : &quot;2018-08-11T04:01:15.708470Z&quot; },
        &quot;cells&quot; : [
          { &quot;name&quot; : &quot;event_reception_time&quot;, &quot;value&quot; : &quot;2018-08-11 04:01:15.703Z&quot; },
          { &quot;name&quot; : &quot;quality&quot;, &quot;value&quot; : 100.0 },
          { &quot;name&quot; : &quot;value&quot;, &quot;value&quot; : 372654.53 }
        ]
      },
      {
        &quot;type&quot; : &quot;range_tombstone_bound&quot;,
        &quot;end&quot; : {
          &quot;type&quot; : &quot;inclusive&quot;,
          &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2018-06-28T17:03:08.555918Z&quot;, &quot;local_delete_time&quot; : &quot;2018-06-28T17:03:08Z&quot; }
        }
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We have downgraded on the mean time to Cassandra 3.11.2. Shouldn&apos;t at least these inconsistencies have more graceful assertions?&lt;/p&gt;</comment>
                            <comment id="16617522" author="jjirsa" created="Mon, 17 Sep 2018 13:29:50 +0000"  >&lt;p&gt;In chatting with the folks who wrote &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14515&quot; title=&quot;Short read protection in presence of almost-purgeable range tombstones may cause permanent data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14515&quot;&gt;&lt;del&gt;CASSANDRA-14515&lt;/del&gt;&lt;/a&gt; offline (namely &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; ), it sounds like what you&apos;re seeing is likely corruption that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14515&quot; title=&quot;Short read protection in presence of almost-purgeable range tombstones may cause permanent data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14515&quot;&gt;&lt;del&gt;CASSANDRA-14515&lt;/del&gt;&lt;/a&gt; was meant to protect. That is: the bug in cassandra 3.11.0 to 3.11.2 that causes data loss (14515) is also leaving your data files in an invalid corrupt state. The exception is letting you know it&apos;s broken, and in this case, that you&apos;ve probably lost data due to that bug.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; - any thoughts on how to prove this is really just 14515 corruption? Any ideas on recovery (will scrub help here)? &lt;/p&gt;</comment>
                            <comment id="16618804" author="iamaleksey" created="Tue, 18 Sep 2018 09:56:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; I don&apos;t think we can say that this was &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14515&quot; title=&quot;Short read protection in presence of almost-purgeable range tombstones may cause permanent data loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14515&quot;&gt;&lt;del&gt;CASSANDRA-14515&lt;/del&gt;&lt;/a&gt; corruption specifically.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mitsis&quot; class=&quot;user-hover&quot; rel=&quot;mitsis&quot;&gt;mitsis&lt;/a&gt; Where is this dump from? I&apos;m interested in seeing both mismatched bounds in a dump from an affected node, to prove conclusively that there is corrupt data on disk - and I&apos;m yet to see the half with deletion time in September.&lt;/p&gt;</comment>
                            <comment id="16619001" author="mitsis" created="Tue, 18 Sep 2018 11:55:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; The dump is from the &quot;bad&quot; node 9 and truncated heavily. I&apos;m presenting the dumps that contain the specific partition key below. These dumps are after DELETE (see in ticket the full command) was run on Sep 16 on a replica cluster created with snapshots from Aug 29.&lt;/p&gt;

&lt;p&gt;From node 9 there are 3 SSTables with that partition key:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;SSTable 1 below (I&apos;ve truncated a lot of rows):&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;mc-2228-big-Data.json 
  {
    &quot;partition&quot; : {
      &quot;key&quot; : [ &quot;a08b8042-6337-11e8-b52b-42010afa015a&quot;, &quot;2018&quot; ],
      &quot;position&quot; : 83756793
    },
    &quot;rows&quot; : [
      {
        &quot;type&quot; : &quot;row&quot;,
        &quot;position&quot; : 83756879,
        &quot;clustering&quot; : [ &quot;2018-06-03 18:45:00.000Z&quot; ],
        &quot;liveness_info&quot; : { &quot;tstamp&quot; : &quot;2018-06-03T19:48:27.570903Z&quot; },
        &quot;cells&quot; : [
          { &quot;name&quot; : &quot;event_reception_time&quot;, &quot;value&quot; : &quot;2018-06-03 19:48:27.570Z&quot; },
          { &quot;name&quot; : &quot;quality&quot;, &quot;value&quot; : 100.0 },
          { &quot;name&quot; : &quot;value&quot;, &quot;value&quot; : 185532.77 }
        ]
      },
*
* many more rows
*
      {
        &quot;type&quot; : &quot;row&quot;,
        &quot;position&quot; : 83860241,
        &quot;clustering&quot; : [ &quot;2018-06-27 04:45:00.000Z&quot; ],
        &quot;liveness_info&quot; : { &quot;tstamp&quot; : &quot;2018-06-27T04:50:08.969007Z&quot; },
        &quot;cells&quot; : [
          { &quot;name&quot; : &quot;event_reception_time&quot;, &quot;value&quot; : &quot;2018-06-27 04:50:08.968Z&quot; },
          { &quot;name&quot; : &quot;quality&quot;, &quot;value&quot; : 100.0 },
          { &quot;name&quot; : &quot;value&quot;, &quot;value&quot; : 408307.66 }
        ]
      },
      {
        &quot;type&quot; : &quot;range_tombstone_bound&quot;,
        &quot;start&quot; : {
          &quot;type&quot; : &quot;exclusive&quot;,
          &quot;clustering&quot; : [ &quot;2018-06-27 04:55:00.000Z&quot; ],
          &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2018-06-28T17:03:08.555918Z&quot;, &quot;local_delete_time&quot; : &quot;2018-06-28T17:03:08Z&quot; }
        }
      },
      {
        &quot;type&quot; : &quot;row&quot;,
        &quot;position&quot; : 83860313,
        &quot;clustering&quot; : [ &quot;2018-06-27 05:00:00.000Z&quot; ],
        &quot;liveness_info&quot; : { &quot;tstamp&quot; : &quot;2018-06-28T19:45:30.803293Z&quot; },
        &quot;cells&quot; : [
          { &quot;name&quot; : &quot;event_reception_time&quot;, &quot;value&quot; : &quot;2018-06-28 19:45:30.784Z&quot; },
          { &quot;name&quot; : &quot;quality&quot;, &quot;value&quot; : 100.0 },
          { &quot;name&quot; : &quot;value&quot;, &quot;value&quot; : 408307.66 }
        ]
      },
*
* many more rows
* 
      {
        &quot;type&quot; : &quot;row&quot;,
        &quot;position&quot; : 84054985,
        &quot;clustering&quot; : [ &quot;2018-08-11 04:00:00.000Z&quot; ],
        &quot;liveness_info&quot; : { &quot;tstamp&quot; : &quot;2018-08-11T04:01:15.708470Z&quot; },
        &quot;cells&quot; : [
          { &quot;name&quot; : &quot;event_reception_time&quot;, &quot;value&quot; : &quot;2018-08-11 04:01:15.703Z&quot; },
          { &quot;name&quot; : &quot;quality&quot;, &quot;value&quot; : 100.0 },
          { &quot;name&quot; : &quot;value&quot;, &quot;value&quot; : 372654.53 }
        ]
      },
      {
        &quot;type&quot; : &quot;range_tombstone_bound&quot;,
        &quot;end&quot; : {
          &quot;type&quot; : &quot;inclusive&quot;,
          &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2018-06-28T17:03:08.555918Z&quot;, &quot;local_delete_time&quot; : &quot;2018-06-28T17:03:08Z&quot; }
        }
      }
    ]
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
	&lt;li&gt;SSTable 2 (I&apos;ve truncated NOTHING)&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;mc-35045-big-Data.json 
  {
    &quot;partition&quot; : {
      &quot;key&quot; : [ &quot;a08b8042-6337-11e8-b52b-42010afa015a&quot;, &quot;2018&quot; ],
      &quot;position&quot; : 194666614
    },
    &quot;rows&quot; : [
      {
        &quot;type&quot; : &quot;range_tombstone_bound&quot;,
        &quot;start&quot; : {
          &quot;type&quot; : &quot;inclusive&quot;,
          &quot;clustering&quot; : [ &quot;2018-07-19 04:00:00.000Z&quot; ],
          &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2018-09-16T13:14:14.634113Z&quot;, &quot;local_delete_time&quot; : &quot;2018-09-16T13:14:14Z&quot; }
        }
      },
      {
        &quot;type&quot; : &quot;range_tombstone_bound&quot;,
        &quot;end&quot; : {
          &quot;type&quot; : &quot;inclusive&quot;,
          &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2018-09-16T13:14:14.634113Z&quot;, &quot;local_delete_time&quot; : &quot;2018-09-16T13:14:14Z&quot; }
        }
      }
    ]
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
	&lt;li&gt;SSTable 3 contains rows with dates &lt;b&gt;before &quot;2018-06-03 18:45:00.000Z&quot;&lt;/b&gt; with no tombstone information so not presented here.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;From node 6 (the &quot;good&quot; node) there are also 3 SSTables with that partition key:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;SSTable 1 below (I&apos;ve truncated NOTHING):&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;mc-2763209-big-Data.json 
  {
    &quot;partition&quot; : {
      &quot;key&quot; : [ &quot;a08b8042-6337-11e8-b52b-42010afa015a&quot;, &quot;2018&quot; ],
      &quot;position&quot; : 101207516
    },
    &quot;rows&quot; : [
      {
        &quot;type&quot; : &quot;range_tombstone_bound&quot;,
        &quot;start&quot; : {
          &quot;type&quot; : &quot;inclusive&quot;,
          &quot;clustering&quot; : [ &quot;2018-07-19 04:00:00.000Z&quot; ],
          &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2018-09-16T08:37:18.429276Z&quot;, &quot;local_delete_time&quot; : &quot;2018-09-16T08:37:18Z&quot; }
        }
      },
      {
        &quot;type&quot; : &quot;range_tombstone_bound&quot;,
        &quot;end&quot; : {
          &quot;type&quot; : &quot;inclusive&quot;,
          &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2018-09-16T08:37:18.429276Z&quot;, &quot;local_delete_time&quot; : &quot;2018-09-16T08:37:18Z&quot; }
        }
      }
    ]
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
	&lt;li&gt;SSTable 2 below (I&apos;ve truncated NOTHING):&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;mc-2763214-big-Data.json 
  {
    &quot;partition&quot; : {
      &quot;key&quot; : [ &quot;a08b8042-6337-11e8-b52b-42010afa015a&quot;, &quot;2018&quot; ],
      &quot;position&quot; : 191837790
    },
    &quot;rows&quot; : [
      {
        &quot;type&quot; : &quot;range_tombstone_bound&quot;,
        &quot;start&quot; : {
          &quot;type&quot; : &quot;inclusive&quot;,
          &quot;clustering&quot; : [ &quot;2018-07-19 04:00:00.000Z&quot; ],
          &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2018-09-16T13:14:14.634113Z&quot;, &quot;local_delete_time&quot; : &quot;2018-09-16T13:14:14Z&quot; }
        }
      },
      {
        &quot;type&quot; : &quot;range_tombstone_bound&quot;,
        &quot;end&quot; : {
          &quot;type&quot; : &quot;inclusive&quot;,
          &quot;deletion_info&quot; : { &quot;marked_deleted&quot; : &quot;2018-09-16T13:14:14.634113Z&quot;, &quot;local_delete_time&quot; : &quot;2018-09-16T13:14:14Z&quot; }
        }
      }
    ]
  }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
	&lt;li&gt;SSTable 3 contains rows with dates &lt;b&gt;up to &quot;2018-08-17 13:30:00.000Z&quot;&lt;/b&gt; with no tombstone information so not presented here.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16619035" author="iamaleksey" created="Tue, 18 Sep 2018 12:18:17 +0000"  >&lt;p&gt;Thanks. At first glance, individually these dumps seem normal. So this could be a bug in reading/merging, or even a bug in RT validation logic.&lt;/p&gt;

&lt;p&gt;I&apos;ll do my best to investigate further this week.&lt;/p&gt;</comment>
                            <comment id="16619051" author="iamaleksey" created="Tue, 18 Sep 2018 12:30:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mitsis&quot; class=&quot;user-hover&quot; rel=&quot;mitsis&quot;&gt;mitsis&lt;/a&gt; JIRA no longer displays email addresses (presumably due to GDPR). If you could maybe share those sstables alongside schema with me (privately and confidentially) please contact me at aleksey@apache.org. Having the sstables will go a long way with helping to reproduce locally and determine what the problem is.&lt;/p&gt;</comment>
                            <comment id="16623853" author="iamaleksey" created="Fri, 21 Sep 2018 16:38:06 +0000"  >&lt;p&gt;Quick update: the bug is legit, the problem lies in &lt;tt&gt;PurgeFunction&lt;/tt&gt; applied to the merged iterator, before the filtering step. Its logic to partially purge a range tombstone is broken (&lt;tt&gt;PurgeFunction.applyToMarker()&lt;/tt&gt;), or, rather, what&apos;s broken are &lt;tt&gt;RangeTombstoneBoundaryMarker.createCorrespondingCloseMarker()&lt;/tt&gt; and &lt;tt&gt;RangeTombstoneBoundaryMarker.createCorrespondingOpenMarker()&lt;/tt&gt; methods - in case of reverse iteration they don&apos;t swap the deletion times, leading to creation of a range tombstone marker with an invalid deletion time when reading in DESC order.&lt;/p&gt;

&lt;p&gt;The patch is a trivial two-liner, but I&apos;ll need to finish unit tests and complete analysis of worst-case impact of the issue in 3.11.2 and corresponding 3.0 versions before &lt;tt&gt;RTBoundValidator&lt;/tt&gt; introduction.&lt;/p&gt;</comment>
                            <comment id="16626030" author="iamaleksey" created="Mon, 24 Sep 2018 15:34:04 +0000"  >&lt;p&gt;3.0: &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/14672-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/771&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/789&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;br/&gt;
3.11: &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/14672-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/772&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/784&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;br/&gt;
4.0: &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/14672-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/775&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/786&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16626040" author="iamaleksey" created="Mon, 24 Sep 2018 15:39:17 +0000"  >&lt;p&gt;Will rerun dtests once the underlying issue with the yaml has been taken care of, but it&apos;s otherwise ready to review.&lt;/p&gt;</comment>
                            <comment id="16626507" author="iamaleksey" created="Mon, 24 Sep 2018 21:57:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; CI&apos;s fine now&lt;/p&gt;</comment>
                            <comment id="16627562" author="bdeggleston" created="Tue, 25 Sep 2018 16:02:12 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16627633" author="iamaleksey" created="Tue, 25 Sep 2018 16:48:30 +0000"  >&lt;p&gt;Thanks, committed to 3.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/d496dca6729853ece49d68c4837fed35149c95d0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;d496dca6729853ece49d68c4837fed35149c95d0&lt;/a&gt; and merged upwards with 3.11 and 4.0.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13165618">CASSANDRA-14515</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12986" cascade-level="1"><![CDATA[Recoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 8 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3xjaf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12342778">3.0.17</customfieldvalue>
    <customfieldvalue id="12342779">3.11.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>bdeggleston</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>