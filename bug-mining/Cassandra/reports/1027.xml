<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:22:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2946] HintedHandoff fails with could not reach schema agreement</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2946</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;To reproduce, have two nodes A and B.&lt;/p&gt;

&lt;p&gt;1. On node A, create a keyspace with replication factor 1 and add a column family&lt;br/&gt;
2. Ensure node B has created the keyspace and column family&lt;br/&gt;
3. Take down node B&lt;br/&gt;
4. Insert some keys to A at CL.ANY, ensuring some keys should be written to B&lt;br/&gt;
5. Bring up node B&lt;br/&gt;
6. When hints are delivered, I get the error:&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:1&amp;#93;&lt;/span&gt; 2011-07-25 17:19:14,729 AbstractCassandraDaemon.java (line 139) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:1,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: java.lang.RuntimeException: Could not reach schema agreement with /10.2.129.9 in 60000ms&lt;br/&gt;
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:34)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:636)&lt;br/&gt;
Caused by: java.lang.RuntimeException: Could not reach schema agreement with /10.2.129.9 in 60000ms&lt;br/&gt;
        at org.apache.cassandra.db.HintedHandOffManager.waitForSchemaAgreement(HintedHandOffManager.java:290)&lt;br/&gt;
        at org.apache.cassandra.db.HintedHandOffManager.deliverHintsToEndpoint(HintedHandOffManager.java:301)&lt;br/&gt;
        at org.apache.cassandra.db.HintedHandOffManager.access$100(HintedHandOffManager.java:89)&lt;br/&gt;
        at org.apache.cassandra.db.HintedHandOffManager$2.runMayThrow(HintedHandOffManager.java:394)&lt;br/&gt;
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
        ... 3 more&lt;/p&gt;

&lt;p&gt;If I use DatabaseDescriptor.getDefsVersion() instead of gossiper.getEndpointStateForEndpoint(FBUtilities.getLocalAddress()).getApplicationState(ApplicationState.SCHEMA) then the error goes away, and the hints are correctly delivered.&lt;/p&gt;

&lt;p&gt;This may be the same issue as Aaron saw here: &lt;a href=&quot;http://cassandra-user-incubator-apache-org.3065146.n2.nabble.com/ApplicationState-Schema-has-drifted-from-DatabaseDescriptor-td6006576.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassandra-user-incubator-apache-org.3065146.n2.nabble.com/ApplicationState-Schema-has-drifted-from-DatabaseDescriptor-td6006576.html&lt;/a&gt;, and may be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2083&quot; title=&quot;Hinted Handoff and schema race&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2083&quot;&gt;&lt;del&gt;CASSANDRA-2083&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12515285">CASSANDRA-2946</key>
            <summary>HintedHandoff fails with could not reach schema agreement</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="richardlow">Richard Low</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Jul 2011 16:38:31 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:54 +0000</updated>
                            <resolved>Wed, 27 Jul 2011 15:14:31 +0000</resolved>
                                        <fixVersion>0.8.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13070921" author="jbellis" created="Tue, 26 Jul 2011 03:36:40 +0000"  >&lt;p&gt;does the disagreement show up with &quot;describe cluster&quot; from the cli?  if so, at what point do the schemas of A and B diverge?&lt;/p&gt;</comment>
                            <comment id="13071024" author="richardlow" created="Tue, 26 Jul 2011 10:28:12 +0000"  >&lt;p&gt;describe cluster always shows agreement.  Selected log messages:&lt;/p&gt;

&lt;p&gt;DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:1&amp;#93;&lt;/span&gt; 2011-07-26 11:22:35,526 HintedHandOffManager.java (line 300) Checking remote schema before delivering hints&lt;br/&gt;
...&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-2-thread-1&amp;#93;&lt;/span&gt; 2011-07-26 11:22:44,965 CassandraServer.java (line 1123) checking schema agreement&lt;br/&gt;
...&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-2-thread-1&amp;#93;&lt;/span&gt; 2011-07-26 11:22:44,969 StorageProxy.java (line 823) Schemas are in agreement.&lt;br/&gt;
...&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:1&amp;#93;&lt;/span&gt; 2011-07-26 11:23:36,788 AbstractCassandraDaemon.java (line 138) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:1,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: java.lang.RuntimeException: Could not reach schema agreement with /10.2.129.9 in 60000ms&lt;/p&gt;

&lt;p&gt;So StorageProxy thinks the schema agrees but HintedHandoffManager doesn&apos;t.&lt;/p&gt;</comment>
                            <comment id="13071107" author="jbellis" created="Tue, 26 Jul 2011 13:57:05 +0000"  >&lt;p&gt;this should fix the gossip-out-of-sync bug.&lt;/p&gt;

&lt;p&gt;if it does we can also change the HH code to use DD.&lt;/p&gt;</comment>
                            <comment id="13071298" author="brandon.williams" created="Tue, 26 Jul 2011 19:21:51 +0000"  >&lt;p&gt;+1, what happened was node A never updated it&apos;s gossip state, but the other node learned of its schema version by RPC.  When node B restarted, it no longer knew the schema version for A, and tried to get it from gossip where it was still old.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;if it does we can also change the HH code to use DD.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I don&apos;t know about that, having this as a check to make sure this doesn&apos;t happen again is a far easier thing to catch than other &quot;gossip is out of date&quot; problems we might encounter.&lt;/p&gt;</comment>
                            <comment id="13071382" author="jbellis" created="Tue, 26 Jul 2011 22:05:13 +0000"  >&lt;p&gt;okay, then I&apos;ll add a comment to that effect, assuming Richard confirms this fixes the bug.&lt;/p&gt;</comment>
                            <comment id="13071609" author="richardlow" created="Wed, 27 Jul 2011 09:03:54 +0000"  >&lt;p&gt;Yes, that fix works.  Thanks.&lt;/p&gt;</comment>
                            <comment id="13071791" author="jbellis" created="Wed, 27 Jul 2011 15:14:31 +0000"  >&lt;p&gt;Committed to 0.8.3 and trunk.  (And verified that this is not a problem on the 0.7 branch.)&lt;/p&gt;</comment>
                            <comment id="13071829" author="hudson" created="Wed, 27 Jul 2011 16:12:39 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #240 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/240/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/240/&lt;/a&gt;)&lt;br/&gt;
    keep gossipped version in sync with actual on migration coordinator&lt;br/&gt;
patch by jbellis; reviewed by brandonwilliams and tested by Richard Low for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2946&quot; title=&quot;HintedHandoff fails with could not reach schema agreement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2946&quot;&gt;&lt;del&gt;CASSANDRA-2946&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1151494&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1151494&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/migration/Migration.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/HintedHandOffManager.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12487836" name="2946.txt" size="606" author="jbellis" created="Tue, 26 Jul 2011 13:57:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20903</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gefj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93768</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>richardlow</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[richardlow]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>