<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10731] Bootstrap starts before migration responses have completed</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10731</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have a number of failing tests running on slow VMs that are failing because &lt;tt&gt;MigrationManager.isReadyForBootstrap&lt;/tt&gt; is return &lt;tt&gt;true&lt;/tt&gt; when there are still inflight responses being processed to migration requests. This is happening because the &lt;tt&gt;MigrationTask.runMayThrow&lt;/tt&gt; has completed but the &lt;tt&gt;IAsyncCallback.response&lt;/tt&gt; is still running.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12914198">CASSANDRA-10731</key>
            <summary>Bootstrap starts before migration responses have completed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mike_tr_adamson">Mike Adamson</assignee>
                                    <reporter username="mike_tr_adamson">Mike Adamson</reporter>
                        <labels>
                    </labels>
                <created>Wed, 18 Nov 2015 18:21:15 +0000</created>
                <updated>Tue, 14 Oct 2025 12:14:00 +0000</updated>
                            <resolved>Tue, 24 Nov 2015 23:26:24 +0000</resolved>
                                        <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="15011615" author="mike_tr_adamson" created="Wed, 18 Nov 2015 18:36:34 +0000"  >&lt;p&gt;The proposed solution for this is as follows. &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;MigrationTask&lt;/tt&gt; maintains a queue of &lt;tt&gt;CountdownLatch&lt;/tt&gt; that complete as each response callback completes. &lt;tt&gt;MigrationManager.isReadyForBootstrap&lt;/tt&gt; returns &lt;tt&gt;true&lt;/tt&gt; if the queue is empty. If the queue is not empty then a new method &lt;tt&gt;MigrationManager.waitTillReadyForBootstrap&lt;/tt&gt; is called by &lt;tt&gt;StorageService&lt;/tt&gt;. This waits on each latch in the queue until they complete. The wait uses a system property &lt;tt&gt;cassandra.migration_task_wait_in_seconds&lt;/tt&gt; defined timeout which defaults to 1 second.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/mike-tr-adamson/cassandra/tree/10731-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/mike-tr-adamson/cassandra/tree/10731-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/madamson/job/mike-tr-adamson-10731-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/madamson/job/mike-tr-adamson-10731-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/madamson/job/mike-tr-adamson-10731-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/madamson/job/mike-tr-adamson-10731-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15011705" author="JIRAUSER308715" created="Wed, 18 Nov 2015 19:06:11 +0000"  >&lt;p&gt;Do we really want to continue at all if this hasn&apos;t completed?  Does it make more sense to fail the bootstrap?&lt;/p&gt;</comment>
                            <comment id="15013349" author="mike_tr_adamson" created="Thu, 19 Nov 2015 11:09:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjordan&quot; class=&quot;user-hover&quot; rel=&quot;jjordan&quot;&gt;jjordan&lt;/a&gt; Probably, yes. I&apos;ve changed the &lt;tt&gt;MigrationManager.waitTillReadyForBootstrap&lt;/tt&gt; to error if a latch times out or is interrupted.&lt;/p&gt;</comment>
                            <comment id="15013672" author="mike_tr_adamson" created="Thu, 19 Nov 2015 15:11:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjordan&quot; class=&quot;user-hover&quot; rel=&quot;jjordan&quot;&gt;jjordan&lt;/a&gt; With the above change in &lt;tt&gt;bootstrap_test.resumable_bootstrap_test&lt;/tt&gt; failed in the dtest run for it. I&apos;m now questioning whether we should fail if a latch wait times out. I think by doing that we are defeating the ability to resume bootstrapping if the node we are bootstrapping from dies during the process.&lt;/p&gt;

&lt;p&gt;Let me know what you think and I&apos;ll take the change out again.&lt;/p&gt;</comment>
                            <comment id="15013774" author="JIRAUSER308715" created="Thu, 19 Nov 2015 16:17:51 +0000"  >&lt;p&gt;Hmm. Dunno. The main thing is that I don&apos;t think we should try to bootstrap if schema isn&apos;t in sync. Is the problem because of tha way things are working if the schema is actually empty?  No user created tables?&lt;/p&gt;</comment>
                            <comment id="15013795" author="mike_tr_adamson" created="Thu, 19 Nov 2015 16:26:41 +0000"  >&lt;p&gt;If we are saying that a migration request failing or overrunning is an indication of the schema not being in sync then we should keep the failure mechanism. Maybe the test is not strictly correct in that case and is shutting node1 down at the wrong point. I&apos;ll have a play with it and see if that is the case.&lt;/p&gt;</comment>
                            <comment id="15015595" author="mike_tr_adamson" created="Fri, 20 Nov 2015 10:56:28 +0000"  >&lt;p&gt;Ok, I&apos;ve removed the fail hard on the inflight check because it was breaking the ability to resume bootstrap if the node being bootstrapped from goes down.&lt;/p&gt;</comment>
                            <comment id="15018269" author="sbtourist" created="Fri, 20 Nov 2015 16:36:08 +0000"  >&lt;p&gt;Looks good to me, only a minor note: when catching &lt;tt&gt;InterruptedException&lt;/tt&gt; in &lt;tt&gt;MigrationManager#waitTillReadyForBootstrap()&lt;/tt&gt;, the interrupt status should be propagated. &lt;/p&gt;

&lt;p&gt;Other than that, just an awareness note: &lt;tt&gt;MigrationManager#scheduleSchemaPull()&lt;/tt&gt; is only called via gossip schema updates, which means there&apos;s no actual guarantee that by the time we call &lt;tt&gt;MigrationManager#waitTillReadyForBootstrap()&lt;/tt&gt;, we will have received any schema updates, despite the forced announce and subsequent ring delay in &lt;tt&gt;StorageService&lt;/tt&gt;; that is, &lt;tt&gt;MigrationTask#getInflightTasks()&lt;/tt&gt; could just be empty because no gossip update was received yet, and &lt;tt&gt;MigrationManager#waitTillReadyForBootstrap()&lt;/tt&gt; would still happily return. Anyway, if no gossip update was received after the ring delay, there isn&apos;t probably much we can do by just waiting longer, so the only think that makes sense is to proceed and eventually resume bootstrap later.&lt;/p&gt;
</comment>
                            <comment id="15018377" author="mike_tr_adamson" created="Fri, 20 Nov 2015 17:24:12 +0000"  >&lt;p&gt;I have pushed the branches again with the above change to propagate the interrupt status. Re-running tests against the branch.&lt;/p&gt;</comment>
                            <comment id="15018387" author="sbtourist" created="Fri, 20 Nov 2015 17:33:45 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15022561" author="iamaleksey" created="Mon, 23 Nov 2015 17:36:00 +0000"  >&lt;p&gt;I fail to see anything that would pop the &lt;tt&gt;inflightTasks&lt;/tt&gt; queue. Is that intentional?&lt;/p&gt;</comment>
                            <comment id="15022578" author="sbtourist" created="Mon, 23 Nov 2015 17:44:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;I fail to see anything that would pop the inflightTasks queue. Is that intentional?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think so, I just missed it. Getting back to in progress until Mike can clarify.&lt;/p&gt;</comment>
                            <comment id="15024308" author="mike_tr_adamson" created="Tue, 24 Nov 2015 11:31:25 +0000"  >&lt;p&gt;Sorry, my bad. I&apos;ve changed it to poll off the queue now.&lt;/p&gt;</comment>
                            <comment id="15025695" author="iamaleksey" created="Tue, 24 Nov 2015 23:26:04 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/ae315b5ec944571342146867c51b2ceb50f3845e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ae315b5ec944571342146867c51b2ceb50f3845e&lt;/a&gt; to 3.0, merged with 3.1 and trunk. Thanks.&lt;/p&gt;</comment>
                            <comment id="15326187" author="chrislovecnm" created="Sun, 12 Jun 2016 04:58:45 +0000"  >&lt;p&gt;This may be causing me some issues.  I am backing out these changes from 3.6 and testing.  See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11983&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-11983&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12977044">CASSANDRA-11983</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mike_tr_adamson]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 23 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2oldr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>sbtourist</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[sbtourist]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/ae315b5ec944571342146867c51b2ceb50f3845e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/ae315b5ec944571342146867c51b2ceb50f3845e&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>