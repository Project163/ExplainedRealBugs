<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:40:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6004] Performing a &quot;Select count(*)&quot; when replication factor &lt; node count causes assertion error and timeout</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6004</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When performing a &quot;Select Count()&quot; query on a table belonging to a keyspace with a replication factor less than the total node count, the following error is encountered which ultimately results in an rpc_timeout for the request:&lt;/p&gt;

&lt;p&gt;ERROR 18:47:54,660 Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-5,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError&lt;br/&gt;
	at org.apache.cassandra.db.filter.IDiskAtomFilter$Serializer.deserialize(IDiskAtomFilter.java:116)&lt;br/&gt;
	at org.apache.cassandra.db.RangeSliceCommandSerializer.deserialize(RangeSliceCommand.java:247)&lt;br/&gt;
	at org.apache.cassandra.db.RangeSliceCommandSerializer.deserialize(RangeSliceCommand.java:156)&lt;br/&gt;
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:99)&lt;br/&gt;
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:148)&lt;br/&gt;
	at org.apache.cassandra.net.IncomingTcpConnection.handleModernVersion(IncomingTcpConnection.java:125)&lt;br/&gt;
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:73)&lt;/p&gt;

&lt;p&gt;The issue is not encountered when the replication factor is &amp;gt;= node count&lt;/p&gt;

&lt;p&gt;To replicate the issue:&lt;br/&gt;
1) Create the keyspace: CREATE KEYSPACE demodb WITH REPLICATION = &lt;/p&gt;
{&apos;class&apos; : &apos;SimpleStrategy&apos;, &apos;replication_factor&apos;: 1}
&lt;p&gt;;&lt;/p&gt;

&lt;p&gt;2) Create the table CREATE TABLE users (&lt;br/&gt;
  user_name varchar,&lt;br/&gt;
  password varchar,&lt;br/&gt;
  gender varchar,&lt;br/&gt;
  session_token varchar,&lt;br/&gt;
  state varchar,&lt;br/&gt;
  birth_year bigint,&lt;br/&gt;
  PRIMARY KEY (user_name));&lt;/p&gt;

&lt;p&gt;3) Do a CQL query: &quot;SELECT count( * ) FROM demodb.users&quot; ;&lt;/p&gt;

&lt;p&gt;The issue is reproducible even if the table is empty. Both CQLSH and client (astyanax) api calls are affected. Tested on two different clusters (2-node and 8-node)&lt;/p&gt;</description>
                <environment>&lt;p&gt;Two node setup&lt;br/&gt;
Ubuntu Server 12.04&lt;br/&gt;
Tested on JDK 1.6 and 1.7&lt;/p&gt;</environment>
        <key id="12667965">CASSANDRA-6004</key>
            <summary>Performing a &quot;Select count(*)&quot; when replication factor &lt; node count causes assertion error and timeout</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="james0915">James P</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Sep 2013 02:04:51 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:05 +0000</updated>
                            <resolved>Mon, 16 Sep 2013 15:24:55 +0000</resolved>
                                        <fixVersion>2.0.1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13764552" author="brandon.williams" created="Wed, 11 Sep 2013 17:47:12 +0000"  >&lt;p&gt;Reproduces well.  Looks like something related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4415&quot; title=&quot;Add cursor API/auto paging to the native CQL protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4415&quot;&gt;&lt;del&gt;CASSANDRA-4415&lt;/del&gt;&lt;/a&gt;, and IDAF is receiving a type of -1 it wasn&apos;t expecting.&lt;/p&gt;</comment>
                            <comment id="13768136" author="slebresne" created="Mon, 16 Sep 2013 07:38:00 +0000"  >&lt;p&gt;Seems &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4415&quot; title=&quot;Add cursor API/auto paging to the native CQL protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4415&quot;&gt;&lt;del&gt;CASSANDRA-4415&lt;/del&gt;&lt;/a&gt; had forgotten to register the verb handlers correctly. Attaching simple patch to fix.&lt;/p&gt;</comment>
                            <comment id="13768260" author="jbellis" created="Mon, 16 Sep 2013 11:56:09 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13768405" author="slebresne" created="Mon, 16 Sep 2013 15:24:55 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="13769406" author="vongocminh" created="Tue, 17 Sep 2013 10:26:41 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;We got the same issue on our 4-node cluster on normal &quot;SELECT *&quot; query but changing replication_factor to 4 did not help.&lt;/p&gt;

&lt;p&gt;I rolled back our dev cluster to 1.2.9 while waiting for the patch. Everything is working now but we don&apos;t have Batch for PreparedStatements (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4693&quot; title=&quot;CQL Protocol should allow multiple PreparedStatements to be atomically executed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4693&quot;&gt;&lt;del&gt;CASSANDRA-4693&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Could you please confirm that the bugfix is not related to the condition (replication_factor &amp;lt; node_count)? and not specific to &quot;SELECT COUNT(1)&quot; either?&lt;/p&gt;

&lt;p&gt;Thanks for your help.&lt;br/&gt;
Best regards,&lt;br/&gt;
Minh&lt;/p&gt;</comment>
                            <comment id="13769411" author="slebresne" created="Tue, 17 Sep 2013 10:38:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;could you please confirm that the bugfix is not related to the condition&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I can. It&apos;s not related to the replication factor. And it will affect any select that requests a range of partition keys (select * without conditions is one) and that use the native protocol v2.&lt;/p&gt;</comment>
                            <comment id="13770121" author="james0915" created="Tue, 17 Sep 2013 23:00:52 +0000"  >&lt;p&gt;Hi Minh,&lt;/p&gt;

&lt;p&gt;For existing keyspaces, I was able to workaround the issue in our cluster by changing the replication factor to be the same as the number of nodes and then doing a &quot;nodetool repair&quot; on each node. I tested &quot;Select *&quot; and &quot;Select count&quot;, both works.&lt;/p&gt;

&lt;p&gt;Not sure, (Sylvain can confirm or not) but having (replication = nodecount) probably allows queries to be performed without having to request a range of partition keys which triggers the bug as Sylvain mentioned.&lt;/p&gt;</comment>
                            <comment id="13777628" author="vongocminh" created="Wed, 25 Sep 2013 15:39:29 +0000"  >&lt;p&gt;Hello,&lt;/p&gt;

&lt;p&gt;I&apos;ve deployed the new version v2.0.1 but it seems that the bug is not fixed. Here is how to reproduce the bug:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE KEYSPACE mykeyspace WITH replication = {
    &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;,
    &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;3&apos;&lt;/span&gt;
};

USE mykeyspace;

CREATE TABLE mytable (
    id text,
    num &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
    str text,

    PRIMARY KEY (id, num)
);
CREATE INDEX ON mytable(str);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The following request always fails with rpc_timeout:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM mytable WHERE str=&lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt; AND num=1; -- NOT OK
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But when we execute a &quot;should-be-the-same&quot; query, it works:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM mytable WHERE num=1 AND str=&lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt;; -- OK
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And by miracle, the first query becomes functionals&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM mytable WHERE str=&lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt; AND num=1; -- now is OK
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Could you please have a look at the issue? It might be related to C* native secondary index?&lt;/p&gt;

&lt;p&gt;Thanks for your help.&lt;br/&gt;
Best regards,&lt;br/&gt;
Minh&lt;/p&gt;</comment>
                            <comment id="13777983" author="brandon.williams" created="Wed, 25 Sep 2013 19:36:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vongocminh&quot; class=&quot;user-hover&quot; rel=&quot;vongocminh&quot;&gt;vongocminh&lt;/a&gt; I can&apos;t reproduce on 2.0 HEAD, but if it is an issue it&apos;s not related to this one so please open a new ticket.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12603299" name="6004.txt" size="2474" author="slebresne" created="Mon, 16 Sep 2013 07:38:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>347901</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 8 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nznb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>348198</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324629">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324629">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>