<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12886] Streaming failed due to SSL Socket connection reset</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12886</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;While running &quot;nodetool repair&quot;, I see many instances of &quot;javax.net.ssl.SSLException: java.net.SocketException: Connection reset&quot; in system.logs on some nodes in the cluster. Timestamps correspond to streaming source/initiator&apos;s error messages of &quot;sync failed between ...&quot;&lt;/p&gt;

&lt;p&gt;Setup: &lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Cassandra 3.7.01&lt;/li&gt;
	&lt;li&gt;CentOS 6.7 in AWS (multi-region)&lt;/li&gt;
	&lt;li&gt;JDK version: 
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java version &quot;1.8.0_102&quot;
Java(TM) SE Runtime Environment (build 1.8.0_102-b14)
Java HotSpot(TM) 64-Bit Server VM (build 25.102-b14, mixed mode)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;cassandra.yaml:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;server_encryption_options:
    internode_encryption: all
    keystore: [path]
    keystore_password: [password]
    truststore: [path]
    truststore_password: [password]
    # More advanced defaults below:
    # protocol: TLS
    # algorithm: SunX509
    # store_type: JKS
    # cipher_suites: [TLS_RSA_WITH_AES_128_CBC_SHA,TLS_RSA_WITH_AES_256_CBC_SHA,TLS_DHE_RSA_WITH_AES_128_CBC_SHA,TLS_DHE_RSA_WITH_AES_256_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA,TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA]
    require_client_auth: false
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Error messages in system.log on the target host:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [STREAM-OUT-/54.247.111.232:7001] 2016-11-07 07:30:56,475 StreamSession.java:529 - [Stream #e14abcb0-a4bb-11e6-9758-55b9ac38b78e] Streaming error occurred on session with peer 54.247.111.232
javax.net.ssl.SSLException: Connection has been shutdown: javax.net.ssl.SSLException: java.net.SocketException: Connection reset
        at sun.security.ssl.SSLSocketImpl.checkEOF(SSLSocketImpl.java:1541) ~[na:1.8.0_102]
        at sun.security.ssl.SSLSocketImpl.checkWrite(SSLSocketImpl.java:1553) ~[na:1.8.0_102]
        at sun.security.ssl.AppOutputStream.write(AppOutputStream.java:71) ~[na:1.8.0_102]
        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82) ~[na:1.8.0_102]
        at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140) ~[na:1.8.0_102]
        at org.apache.cassandra.io.util.WrappedDataOutputStreamPlus.flush(WrappedDataOutputStreamPlus.java:66) ~[apache-cassandra-3.7.0.jar:3.7.0]
        at org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.sendMessage(ConnectionHandler.java:371) [apache-cassandra-3.7.0.jar:3.7.0]
        at org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.run(ConnectionHandler.java:342) [apache-cassandra-3.7.0.jar:3.7.0]
        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_102]
Caused by: javax.net.ssl.SSLException: java.net.SocketException: Connection reset
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13019362">CASSANDRA-12886</key>
            <summary>Streaming failed due to SSL Socket connection reset</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pauloricardomg">Paulo Motta</assignee>
                                    <reporter username="bing1wu">Bing Wu</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Nov 2016 20:37:32 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:15 +0000</updated>
                            <resolved>Thu, 2 Mar 2017 01:38:09 +0000</resolved>
                                        <fixVersion>2.2.10</fixVersion>
                    <fixVersion>3.0.12</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15652089" author="pauloricardomg" created="Wed, 9 Nov 2016 21:29:49 +0000"  >&lt;ul&gt;
	&lt;li&gt;Can you check if the source/destination &lt;tt&gt;STREAM-(IN/OUT)-IP&lt;/tt&gt; of failed streams is the same throughout the cluster?&lt;/li&gt;
	&lt;li&gt;What are your tcp_keepalive settings? (see tuning guide &lt;a href=&quot;http://docs.datastax.com/en/cassandra/2.0/cassandra/troubleshooting/trblshootIdleFirewall.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;Also, can you paste full debug.log sample of a node with this error?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15660915" author="bing1wu" created="Sun, 13 Nov 2016 05:41:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt; To answer your questions&lt;br/&gt;
&lt;b&gt;Q:&lt;/b&gt; Can you check if the source/destination STREAM-(IN/OUT)-IP of failed streams is the same throughout the cluster?&lt;br/&gt;
&lt;b&gt;A:&lt;/b&gt; Yes. More details: Not all nodes in the cluster reported SSL failure. About 7 out of 30 nodes did. I used a combination of &quot;java.net.SocketException: Connection reset&quot; and the timestamp when the &quot;initiator&quot; (the host that was running repair) reported failure to search the system.log on every node. Can confirm those failures all pointed back to the initiator, e.g. &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [STREAM-IN-/52.220.127.181:7001] 2016-11-10 22:23:31,196 StreamSession.java:529 - [Stream #49719e00-a794-11e6-be90-f1ad7e862a5b] Streaming error occurred on session with peer 52.220.127.181
...
ERROR [StreamConnectionEstablisher:6] 2016-11-10 22:23:30,303 StreamSession.java:529 - [Stream #496c6de0-a794-11e6-bf13-7df2869901ea] Streaming error occurred on session with peer *initiator-public-ip*
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;Q:&lt;/b&gt; What are your tcp_keepalive settings? (see tuning guide here)&lt;br/&gt;
&lt;b&gt;A:&lt;/b&gt; They are what&apos;s recommended: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ sudo  sysctl -A | grep net.ipv4.tcp_keep
net.ipv4.tcp_keepalive_time = 60
net.ipv4.tcp_keepalive_probes = 3
net.ipv4.tcp_keepalive_intvl = 10
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;Q:&lt;/b&gt; Also, can you paste full debug.log sample of a node with this error?&lt;br/&gt;
&lt;b&gt;A:&lt;/b&gt; Here is the debug.log file on a remote machine (&lt;b&gt;Note&lt;/b&gt; &lt;em&gt;the IP/timestamp in the log file differ from those in the original bug report as this is from another round of test&lt;/em&gt;) debug.log.2016-11-10_2319.gz&lt;/p&gt;</comment>
                            <comment id="15867946" author="pauloricardomg" created="Wed, 15 Feb 2017 14:48:07 +0000"  >&lt;p&gt;This is hard to reproduce but I&apos;ve got a similar issue when working on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11841&quot; title=&quot;Add keep-alive to stream protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11841&quot;&gt;&lt;del&gt;CASSANDRA-11841&lt;/del&gt;&lt;/a&gt;, and what is probably happening is a race where the handler sender thread is started and pushes a message to the socket before the init message is sent, what breaks the connection in the receiver side. In order to avoid this, we must first send the init message before starting the handler thread. This should already be fixed on 3.10 by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11841&quot; title=&quot;Add keep-alive to stream protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11841&quot;&gt;&lt;del&gt;CASSANDRA-11841&lt;/del&gt;&lt;/a&gt;, but this fix is for 2.2+.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-12886&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-12886-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-12886-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15874062" author="yukim" created="Mon, 20 Feb 2017 05:31:56 +0000"  >&lt;p&gt;Patch looks good to me. +1.&lt;/p&gt;

&lt;p&gt;Unfortunately, test pages were missing at the moment, so I was not able to check the result.&lt;br/&gt;
Can you run once again just in case?&lt;/p&gt;</comment>
                            <comment id="15878991" author="pauloricardomg" created="Wed, 22 Feb 2017 19:04:50 +0000"  >&lt;p&gt;Thanks for review! Some streaming unit tests failed due to the &lt;tt&gt;procotolVersion&lt;/tt&gt; variable not being initialized after calling &lt;tt&gt;ConnectionHandler.sendInitMessage&lt;/tt&gt; before &lt;tt&gt;ConnectionHandler.start(socket, protocolVersion&lt;/tt&gt;, so I updated the patch to use a similar approach as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11841&quot; title=&quot;Add keep-alive to stream protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11841&quot;&gt;&lt;del&gt;CASSANDRA-11841&lt;/del&gt;&lt;/a&gt; and send the init message on &lt;tt&gt;ConnectionHandler.start(socket, protocolVersion, initiator&lt;/tt&gt;. Could you have a quick look?&lt;/p&gt;

&lt;p&gt;Resubmitted tests using new approach.&lt;/p&gt;</comment>
                            <comment id="15879214" author="pauloricardomg" created="Wed, 22 Feb 2017 20:56:01 +0000"  >&lt;p&gt;Tests look good now, can you have a look in the updated patch before I commit &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt;? Thanks!&lt;/p&gt;</comment>
                            <comment id="15879647" author="yukim" created="Thu, 23 Feb 2017 01:19:58 +0000"  >&lt;p&gt;+1. (looks like 2 failed unit tests were due to some env issue.)&lt;/p&gt;

&lt;p&gt;So this goes to 3.0 also, right?&lt;/p&gt;</comment>
                            <comment id="15891430" author="pauloricardomg" created="Thu, 2 Mar 2017 01:38:09 +0000"  >&lt;p&gt;Committed to 2.2 as 06feaefba50301734c490521d720c8a482f638e4 and merged to 3.0. Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12838671" name="debug.log.2016-11-10_2319.gz" size="1674875" author="bing1wu" created="Sun, 13 Nov 2016 05:45:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 37 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i363fb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335693">3.7</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>