<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:12:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-781] in a cluster, get_range_slice() does not return all the keys it should</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-781</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;get_range_slice() does not return the same set of keys as get_key_range() in 0.5.0 final.&lt;/p&gt;

&lt;p&gt;I posted a program to reproduce the behavior:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.mail-archive.com/cassandra-dev@incubator.apache.org/msg01474.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/cassandra-dev@incubator.apache.org/msg01474.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Apparently, you must have more than one node to get the behavior. Also, it may depend on the locations of the nodes on the ring.. I.e., if you don&apos;t generate enough keys randomly, then by chance they could all fall on the same host and you might not see the behavior, although I was able to get it to happen using only 2 nodes and 10 keys.&lt;/p&gt;

&lt;p&gt;Here are the other emails describing the issue:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.mail-archive.com/cassandra-user@incubator.apache.org/msg02423.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/cassandra-user@incubator.apache.org/msg02423.html&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Debian 5 lenny on EC2, Gentoo linux, Windows XP&lt;/p&gt;</environment>
        <key id="12455694">CASSANDRA-781</key>
            <summary>in a cluster, get_range_slice() does not return all the keys it should</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="bjc">bjc</reporter>
                        <labels>
                    </labels>
                <created>Mon, 8 Feb 2010 22:32:35 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:28 +0000</updated>
                            <resolved>Tue, 23 Feb 2010 17:06:05 +0000</resolved>
                                        <fixVersion>0.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="12831305" author="jbellis" created="Tue, 9 Feb 2010 05:52:43 +0000"  >&lt;p&gt;Reproduced on trunk.  Can you try the attached patch there?  (We can backport to 0.5 afterwards.)&lt;/p&gt;</comment>
                            <comment id="12831346" author="bjc" created="Tue, 9 Feb 2010 08:16:02 +0000"  >&lt;p&gt;Before applying 781.txt to trunk I was getting an exception. The exception is now gone! Awesome. However, I still have the range scanning problem. Here are a few example runs of the test:&lt;/p&gt;

&lt;p&gt;$ python test_bug.py get_range_slice&lt;br/&gt;
ebbde791748641be951802d64d48c62d not marked 0&lt;br/&gt;
9bfa7ad8abce48a9a45daccfa3772f29 not marked 0&lt;br/&gt;
$ python test_bug.py get_range_slice&lt;br/&gt;
c554dc532bfb462b950990b6824f11c1 not marked 0&lt;br/&gt;
e6c4a0100508451ea3a1d13088877dd9 not marked 0&lt;br/&gt;
$ python test_bug.py get_range_slice&lt;br/&gt;
$ python test_bug.py get_range_slice&lt;br/&gt;
$ python test_bug.py get_range_slice&lt;br/&gt;
27fc88c8e7ab489d96f4c749cc86aca1 not marked 0&lt;br/&gt;
$ python test_bug.py get_range_slice&lt;br/&gt;
b522cca4bd6f4282a507525598139f95 not marked 0&lt;br/&gt;
$ python test_bug.py get_range_slice&lt;br/&gt;
d045b3edabc949fea30242722a11587a not marked 0&lt;br/&gt;
$ &lt;/p&gt;

&lt;p&gt;Sigh, I just realized that under trunk my nodetool doesn&apos;t work. However, I got the tokens from the log:&lt;/p&gt;

&lt;p&gt;INFO 08:10:50,338 Saved Token not found. Using 68054825649105441942293089893012253843&lt;br/&gt;
INFO 08:10:53,293 Saved Token not found. Using 44181284974408316254372647768836513112&lt;/p&gt;</comment>
                            <comment id="12831443" author="hbadenes" created="Tue, 9 Feb 2010 12:53:57 +0000"  >&lt;p&gt;I am hitting a similar problem on 3-node cluster I run. I do receive 5 rows in the get_range_slice query (from &quot;&quot; to &quot;&quot;), instead of an empty result set as described here (there exist more than just those 5 returned).&lt;/p&gt;

&lt;p&gt;I am running 0.5.0 and could be able to test a patch for that version.&lt;/p&gt;</comment>
                            <comment id="12831451" author="slebresne" created="Tue, 9 Feb 2010 13:30:00 +0000"  >&lt;p&gt;I add the same problem, range_slice on 2 nodes was missing results.&lt;br/&gt;
I updated to trunk and applied 781.txt. It fixes the missing results but&lt;br/&gt;
introduce a timeout exception (I don&apos;t believe it is the patch fault though).&lt;/p&gt;

&lt;p&gt;The timeout happens with consistencyLevel.ONE (but I suspect it could happen&lt;br/&gt;
with QUORUM too). Looking a bit to the details, it seems that&lt;br/&gt;
RangeSliceResponseResolver wait for a response from every live natural&lt;br/&gt;
endpoints (in isDataPresent()). But in StorageProxy, the rangeSlice message is&lt;br/&gt;
only sent to &apos;responseCount&apos; endpoints (which will be 1 for&lt;br/&gt;
consistencyLevel.ONE). Hence the timeout.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what would be the best way to deal with that though.&lt;/p&gt;</comment>
                            <comment id="12831468" author="jbellis" created="Tue, 9 Feb 2010 14:27:27 +0000"  >&lt;p&gt;Sylvain: absolutely right, patch 01 has a fix for this.&lt;/p&gt;

&lt;p&gt;Jack: updated patch 02 with more logging at INFO, maybe that will help.  I can&apos;t reproduce even w/ your tokens and several runs of 100 keys.  I am using a slightly simpler test, though:&lt;/p&gt;

&lt;p&gt;        import uuid&lt;br/&gt;
        ks = &quot;Keyspace1&quot;&lt;br/&gt;
        cf = &quot;Super1&quot;&lt;br/&gt;
        path = ColumnPath(cf, &quot;foo&quot;, &quot;is&quot;)&lt;br/&gt;
        value = &quot;cool&quot;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;insert, record keys in `keys` set&lt;br/&gt;
        keys = set()&lt;br/&gt;
        for i in xrange(100):&lt;br/&gt;
            key = uuid.uuid4().hex&lt;br/&gt;
            client.insert(ks, key, path, value, 0, ConsistencyLevel.ONE)&lt;br/&gt;
            keys.add(key)&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;remove keys found from set&lt;br/&gt;
        parent = ColumnParent(column_family=cf)&lt;br/&gt;
        slice_range = SliceRange(start=&quot;key&quot;, finish=&quot;key&quot;)&lt;br/&gt;
        predicate = SlicePredicate(slice_range=slice_range)        &lt;br/&gt;
        result = client.get_range_slice(ks, parent, predicate, &quot;&quot;, &quot;&quot;, 1000, ConsistencyLevel.ONE)&lt;br/&gt;
        for row in result:&lt;br/&gt;
            keys.discard(row.key)&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;if there are any left over, there is a bug&lt;br/&gt;
        assert not keys, list(sorted(keys))&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;... this will of course only work until you insert more than 1000 keys.  (maybe your original test has a similar limitation, i don&apos;t remember.)&lt;/p&gt;

&lt;p&gt;(Are you still testing w/ RF of 2?  If so maybe patch 01 will help you too.)&lt;/p&gt;</comment>
                            <comment id="12831668" author="bjc" created="Tue, 9 Feb 2010 21:08:57 +0000"  >&lt;p&gt;Ok, I checked out a fresh copy of trunk and applied both new patches (0001 and 0002). There were some errors for 0002, but upon looking at the code it seems parts of the patch have already been committed to the SVN repo, so what I ended up with is the right thing.&lt;/p&gt;

&lt;p&gt;$ patch -p1 &amp;lt;0001-fix-timeout-bug.txt &lt;br/&gt;
patching file src/java/org/apache/cassandra/service/StorageProxy.java&lt;br/&gt;
$ patch -p1 &amp;lt;0002-fix-slices-over-non-trivial-wrapped-ranges.txt&lt;br/&gt;
patching file src/java/org/apache/cassandra/db/ColumnFamilyStore.java&lt;br/&gt;
Hunk #1 succeeded at 43 (offset 1 line).&lt;br/&gt;
Hunk #2 succeeded at 1075 (offset 2 lines).&lt;br/&gt;
patching file src/java/org/apache/cassandra/dht/AbstractBounds.java&lt;br/&gt;
Hunk #1 FAILED at 29.&lt;br/&gt;
1 out of 1 hunk FAILED &amp;#8211; saving rejects to file src/java/org/apache/cassandra/dht/AbstractBounds.java.rej&lt;br/&gt;
patching file src/java/org/apache/cassandra/dht/Bounds.java&lt;br/&gt;
Hunk #1 FAILED at 1.&lt;br/&gt;
Hunk #2 FAILED at 11.&lt;br/&gt;
2 out of 2 hunks FAILED &amp;#8211; saving rejects to file src/java/org/apache/cassandra/dht/Bounds.java.rej&lt;br/&gt;
patching file src/java/org/apache/cassandra/dht/Range.java&lt;br/&gt;
patching file src/java/org/apache/cassandra/service/StorageProxy.java&lt;br/&gt;
patching file src/java/org/apache/cassandra/service/StorageService.java&lt;br/&gt;
Reversed (or previously applied) patch detected!  Assume -R? &lt;span class=&quot;error&quot;&gt;&amp;#91;n&amp;#93;&lt;/span&gt; &lt;br/&gt;
Apply anyway? &lt;span class=&quot;error&quot;&gt;&amp;#91;n&amp;#93;&lt;/span&gt; &lt;br/&gt;
Skipping patch.&lt;br/&gt;
3 out of 3 hunks ignored &amp;#8211; saving rejects to file src/java/org/apache/cassandra/service/StorageService.java.rej&lt;br/&gt;
patching file test/unit/org/apache/cassandra/dht/BoundsTest.java&lt;br/&gt;
patching file test/unit/org/apache/cassandra/dht/RangeTest.java&lt;br/&gt;
$ &lt;/p&gt;

&lt;p&gt;Copied my storage-conf.xml into place, which has only two changes: Seeds defined and binding addresses changed to null strings. Thus, my RF is 1 now, not 2 as it was before.&lt;/p&gt;

&lt;p&gt;I now use your simpler test. Here is the test with all the import statements:&lt;/p&gt;

&lt;p&gt;import uuid&lt;/p&gt;

&lt;p&gt;from thrift import Thrift&lt;br/&gt;
from thrift.transport import TTransport&lt;br/&gt;
from thrift.transport import TSocket&lt;br/&gt;
from thrift.protocol.TBinaryProtocol import TBinaryProtocolAccelerated&lt;br/&gt;
from cassandra import Cassandra&lt;br/&gt;
from cassandra.ttypes import *&lt;/p&gt;

&lt;p&gt;num_keys = 10&lt;/p&gt;

&lt;p&gt;socket = TSocket.TSocket(&quot;10.212.87.165&quot;, 9160)&lt;br/&gt;
transport = TTransport.TBufferedTransport(socket)&lt;br/&gt;
protocol = TBinaryProtocol.TBinaryProtocolAccelerated(transport)&lt;br/&gt;
client = Cassandra.Client(protocol)&lt;/p&gt;

&lt;p&gt;transport.open()&lt;/p&gt;

&lt;p&gt;ks = &quot;Keyspace1&quot;&lt;br/&gt;
cf = &quot;Super1&quot;&lt;br/&gt;
path = ColumnPath(cf, &quot;foo&quot;, &quot;is&quot;)&lt;br/&gt;
value = &quot;cool&quot;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;insert, record keys in `keys` set&lt;br/&gt;
keys = set()&lt;br/&gt;
for i in xrange(100):&lt;br/&gt;
    key = uuid.uuid4().hex&lt;br/&gt;
    client.insert(ks, key, path, value, 0, ConsistencyLevel.ONE)&lt;br/&gt;
    keys.add(key)&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;remove keys found from set&lt;br/&gt;
parent = ColumnParent(column_family=cf)&lt;br/&gt;
slice_range = SliceRange(start=&quot;key&quot;, finish=&quot;key&quot;)&lt;br/&gt;
predicate = SlicePredicate(slice_range=slice_range)&lt;br/&gt;
result = client.get_range_slice(ks, parent, predicate, &quot;&quot;, &quot;&quot;, 1000, ConsistencyLevel.ONE)&lt;br/&gt;
for row in result:&lt;br/&gt;
    keys.discard(row.key)&lt;/li&gt;
&lt;/ol&gt;


&lt;ol&gt;
	&lt;li&gt;if there are any left over, there is a bug&lt;br/&gt;
assert not keys, list(sorted(keys))&lt;/li&gt;
&lt;/ol&gt;



&lt;p&gt;I cleared out the data/commitlog dirs and launched both nodes. The tokens:&lt;/p&gt;

&lt;p&gt; INFO 21:02:08,768 Saved Token not found. Using 136351045523563703929320485474511375137&lt;br/&gt;
 INFO 21:02:09,509 Saved Token not found. Using 20118706661854036583649958139769313744&lt;/p&gt;

&lt;p&gt;Now.. run the test!&lt;/p&gt;

&lt;p&gt;$ python test_bug_simple.py&lt;br/&gt;
Traceback (most recent call last):&lt;br/&gt;
  File &quot;test_bug_simple.py&quot;, line 36, in &amp;lt;module&amp;gt;&lt;br/&gt;
    result = client.get_range_slice(ks, parent, predicate, &quot;&quot;, &quot;&quot;, 1000, ConsistencyLevel.ONE) &lt;br/&gt;
  File &quot;/usr/local/python//lib/python2.6/site-packages/cassandra/Cassandra.py&quot;, line 486, in get_range_slice&lt;br/&gt;
  File &quot;/usr/local/python//lib/python2.6/site-packages/cassandra/Cassandra.py&quot;, line 508, in recv_get_range_slice&lt;br/&gt;
thrift.Thrift.TApplicationException: Internal error processing get_range_slice&lt;/p&gt;


&lt;p&gt;The log from the node I am querying:&lt;/p&gt;

&lt;p&gt; INFO 21:02:08,768 Saved Token not found. Using 13635104552356370392932048547451&lt;br/&gt;
1375137&lt;br/&gt;
 INFO 21:02:08,933 Starting up server gossip&lt;br/&gt;
 INFO 21:02:09,118 Cassandra starting up...&lt;br/&gt;
 INFO 21:02:10,686 Node /10.212.230.176 is now part of the cluster&lt;br/&gt;
 INFO 21:02:11,750 InetAddress /10.212.230.176 is now UP&lt;br/&gt;
 INFO 21:05:43,927 scanning node range (136351045523563703929320485474511375137,&lt;br/&gt;
20118706661854036583649958139769313744]&lt;br/&gt;
ERROR 21:05:43,927 Internal error processing get_range_slice&lt;br/&gt;
java.lang.AssertionError&lt;br/&gt;
        at org.apache.cassandra.dht.Bounds.&amp;lt;init&amp;gt;(Bounds.java:16)&lt;br/&gt;
        at org.apache.cassandra.dht.Bounds.restrictTo(Bounds.java:34)&lt;br/&gt;
        at org.apache.cassandra.service.StorageProxy.getRangeSlice(StorageProxy.&lt;br/&gt;
java:559)&lt;br/&gt;
        at org.apache.cassandra.thrift.CassandraServer.get_range_slice(Cassandra&lt;br/&gt;
Server.java:560)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor$get_range_slice.proce&lt;br/&gt;
ss(Cassandra.java:1189)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor.process(Cassandra.jav&lt;br/&gt;
a:984)&lt;br/&gt;
        at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadP&lt;br/&gt;
oolServer.java:253)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExec&lt;br/&gt;
utor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor&lt;br/&gt;
.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;


</comment>
                            <comment id="12831677" author="jbellis" created="Tue, 9 Feb 2010 21:28:14 +0000"  >&lt;p&gt;Sorry, those patches that didn&apos;t apply were probably important. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve rebased against r908163, can you revert and try again?&lt;/p&gt;</comment>
                            <comment id="12831682" author="bjc" created="Tue, 9 Feb 2010 21:44:55 +0000"  >&lt;p&gt;Makes sense! Can you try one more time? I still can&apos;t apply the patch properly.. Or, maybe I&apos;m doing something wrong? Here is the transcript.&lt;/p&gt;

&lt;p&gt;$ svn checkout -r908163 &lt;a href=&quot;https://svn.apache.org/repos/asf/incubator/cassandra/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/incubator/cassandra/trunk&lt;/a&gt; cassandra&lt;br/&gt;
...&lt;br/&gt;
A    cassandra/README.txt&lt;br/&gt;
 U   cassandra&lt;br/&gt;
Checked out revision 908163.&lt;br/&gt;
$ cd cassandra&lt;br/&gt;
$ wget &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12435345/0001-fix-timeout-bug.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12435345/0001-fix-timeout-bug.txt&lt;/a&gt;&lt;br/&gt;
-&lt;del&gt;2010-02-09 21:40:51&lt;/del&gt;-  &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/124353&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/124353&lt;/a&gt;&lt;br/&gt;
45/0001-fix-timeout-bug.txt&lt;br/&gt;
Resolving issues.apache.org... 140.211.11.140&lt;br/&gt;
Connecting to issues.apache.org|140.211.11.140|:443... connected.&lt;br/&gt;
HTTP request sent, awaiting response... 200 OK&lt;br/&gt;
Length: 1873 (1.8K) &lt;span class=&quot;error&quot;&gt;&amp;#91;text/plain&amp;#93;&lt;/span&gt;&lt;br/&gt;
Saving to: `0001-fix-timeout-bug.txt&apos;&lt;/p&gt;

&lt;p&gt;100%&lt;span class=&quot;error&quot;&gt;&amp;#91;======================================&amp;gt;&amp;#93;&lt;/span&gt; 1,873       --.-K/s   in 0s      &lt;/p&gt;

&lt;p&gt;2010-02-09 21:40:52 (47.0 MB/s) - `0001-fix-timeout-bug.txt&apos; saved &lt;span class=&quot;error&quot;&gt;&amp;#91;1873/1873&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;$ patch -p1 &amp;lt;0001-fix-timeout-bug.txt &lt;br/&gt;
patching file src/java/org/apache/cassandra/service/StorageProxy.java&lt;br/&gt;
$ wget &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12435346/0002-fix-slices-over-non-trivial-wrapped-ranges.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12435346/0002-fix-slices-over-non-trivial-wrapped-ranges.txt&lt;/a&gt;&lt;br/&gt;
-&lt;del&gt;2010-02-09 21:41:13&lt;/del&gt;-  &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/124353&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/124353&lt;/a&gt;&lt;br/&gt;
46/0002-fix-slices-over-non-trivial-wrapped-ranges.txt&lt;br/&gt;
Resolving issues.apache.org... 140.211.11.140&lt;br/&gt;
Connecting to issues.apache.org|140.211.11.140|:443... connected.&lt;br/&gt;
HTTP request sent, awaiting response... 200 OK&lt;br/&gt;
Length: 14776 (14K) &lt;span class=&quot;error&quot;&gt;&amp;#91;text/plain&amp;#93;&lt;/span&gt;&lt;br/&gt;
Saving to: `0002-fix-slices-over-non-trivial-wrapped-ranges.txt&apos;&lt;/p&gt;

&lt;p&gt;100%&lt;span class=&quot;error&quot;&gt;&amp;#91;======================================&amp;gt;&amp;#93;&lt;/span&gt; 14,776      74.8K/s   in 0.2s    &lt;/p&gt;

&lt;p&gt;2010-02-09 21:41:14 (74.8 KB/s) - `0002-fix-slices-over-non-trivial-wrapped-ranges.txt&apos; saved &lt;span class=&quot;error&quot;&gt;&amp;#91;14776/14776&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;$ patch -p1 &amp;lt;0002-fix-slices-over-non-trivial-wrapped-ranges.txt &lt;br/&gt;
patching file src/java/org/apache/cassandra/db/ColumnFamilyStore.java&lt;br/&gt;
patching file src/java/org/apache/cassandra/dht/AbstractBounds.java&lt;br/&gt;
Hunk #1 FAILED at 29.&lt;br/&gt;
1 out of 1 hunk FAILED &amp;#8211; saving rejects to file src/java/org/apache/cassandra/dht/AbstractBounds.java.rej&lt;br/&gt;
patching file src/java/org/apache/cassandra/dht/Bounds.java&lt;br/&gt;
Hunk #1 FAILED at 1.&lt;br/&gt;
Hunk #2 FAILED at 11.&lt;br/&gt;
2 out of 2 hunks FAILED &amp;#8211; saving rejects to file src/java/org/apache/cassandra/dht/Bounds.java.rej&lt;br/&gt;
patching file src/java/org/apache/cassandra/dht/Range.java&lt;br/&gt;
patching file src/java/org/apache/cassandra/service/StorageProxy.java&lt;br/&gt;
patching file src/java/org/apache/cassandra/service/StorageService.java&lt;br/&gt;
patching file test/unit/org/apache/cassandra/dht/BoundsTest.java&lt;br/&gt;
patching file test/unit/org/apache/cassandra/dht/RangeTest.java&lt;br/&gt;
$ &lt;/p&gt;</comment>
                            <comment id="12831707" author="jbellis" created="Tue, 9 Feb 2010 22:22:29 +0000"  >&lt;p&gt;weird, happens for me too.  lame!&lt;/p&gt;

&lt;p&gt;attached Bounds and AbstractBounds as they should look, post-patch.  just do what you showed in the transcript, then overwrite the local copies with these.&lt;/p&gt;</comment>
                            <comment id="12831752" author="bjc" created="Tue, 9 Feb 2010 23:24:57 +0000"  >&lt;p&gt;Ok, got the patch applied properly and things look better! The simple test passes. Awesome!! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; However, the more complicated test uses a &quot;start&quot; offset after the first get_range_slice(), and that still causes an exception. From the log:&lt;/p&gt;

&lt;p&gt; INFO 23:15:52,425 scanning node range (20123910036548544936247138992367052936,67283373037552029587203789575295250400]&lt;br/&gt;
ERROR 23:15:52,425 Internal error processing get_range_slice&lt;br/&gt;
java.lang.AssertionError: &lt;span class=&quot;error&quot;&gt;&amp;#91;124451343962032323897724984972289130546,67283373037552029587203789575295250400&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.dht.Bounds.&amp;lt;init&amp;gt;(Bounds.java:26)&lt;br/&gt;
        at org.apache.cassandra.dht.Bounds.getRangeOrBounds(Bounds.java:74)&lt;br/&gt;
        at org.apache.cassandra.dht.Bounds.restrictTo(Bounds.java:59)&lt;br/&gt;
        at org.apache.cassandra.service.StorageProxy.getRangeSlice(StorageProxy.java:559)&lt;br/&gt;
        at org.apache.cassandra.thrift.CassandraServer.get_range_slice(CassandraServer.java:560)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor$get_range_slice.process(Cassandra.java:1189)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor.process(Cassandra.java:984)&lt;br/&gt;
        at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:253)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;

&lt;p&gt;If you have trouble duplicating this one I can give you more information, but I did not have difficulty getting it to happen. It happened every time I tried. For example, you can get it to happen just by modifying one line of the simple test:&lt;/p&gt;

&lt;p&gt;result = client.get_range_slice(ks, parent, predicate, &quot;b37e14bb37304e0096e2e77a8fc88a5b&quot;, &quot;&quot;, 1000, ConsistencyLevel.ONE)&lt;/p&gt;

&lt;p&gt;Of course, if you don&apos;t scan starting from &quot;&quot; then the simple test doesn&apos;t make sense, because you might specifically exclude keys you are looking for by starting from the string I put in.&lt;/p&gt;

&lt;p&gt;However, the more complicated test I posted earlier makes sense and exercises the start and end ranges of get_range_slice(). So..can we go back to the complicated test and specifically make that one work? It&apos;s also nice because you should be able to run it over and over, since it removes the keys at the end. With the simple test you have to manually flush the data and restart the servers each time.&lt;/p&gt;

&lt;p&gt;Thanks so much for fixing this! I am getting more familiar with the java so soon I might be able to fix some bugs like this.&lt;/p&gt;</comment>
                            <comment id="12832385" author="jbellis" created="Thu, 11 Feb 2010 05:27:42 +0000"  >&lt;p&gt;committed patch 1, the timeout fix.&lt;/p&gt;

&lt;p&gt;here is a new patch that should fix the remaining range issues.&lt;/p&gt;</comment>
                            <comment id="12832399" author="bjc" created="Thu, 11 Feb 2010 06:53:03 +0000"  >&lt;p&gt;Almost there I think. I found that the keys were not being returned in sorted order as they were before, so my trick of taking the last key in a limited range, and using that to start the next limited range did not work. So, I modified the test to sort the keys, then take the last one. When I did this I found another bug: when there are fewer keys in the specified range, duplicates are returned. Also, when I played around with the start and end for the range the server starting giving AssertionErrors:&lt;/p&gt;

&lt;p&gt;ERROR 06:25:41,032 Internal error processing get_range_slice&lt;br/&gt;
java.lang.AssertionError: [125358492461525499902293558181143752059,1244525150549&lt;br/&gt;
22950280650433865080672503]&lt;br/&gt;
        at org.apache.cassandra.dht.Bounds.&amp;lt;init&amp;gt;(Bounds.java:26)&lt;br/&gt;
        at org.apache.cassandra.dht.Bounds.&amp;lt;init&amp;gt;(Bounds.java:18)&lt;br/&gt;
        at org.apache.cassandra.thrift.CassandraServer.get_range_slice(Cassandra&lt;br/&gt;
Server.java:558)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor$get_range_slice.proce&lt;br/&gt;
ss(Cassandra.java:1189)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor.process(Cassandra.jav&lt;br/&gt;
a:984)&lt;br/&gt;
        at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadP&lt;br/&gt;
oolServer.java:253)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExec&lt;br/&gt;
utor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor&lt;br/&gt;
.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;


&lt;p&gt;The modified test (below) gets stuck in an infinite loop. If you run it in ipython, you can control-c to get back to the interpretor, then type &quot;result&quot; to look at it&apos;s contents. It is a sorted list of keys. Look at the last key.. Here is the transcript showing the last two keys from result:&lt;/p&gt;

&lt;p&gt; &apos;ff8bfa30777f455695bf934ac7cfedac&apos;,&lt;br/&gt;
 &apos;ffb701ea740646b9955f0e339f8e3ee2&apos;]&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;70&amp;#93;&lt;/span&gt;: result2 = client.get_range_slice(ks, cparent, p, start, &quot;&quot;, seg, cl)&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;71&amp;#93;&lt;/span&gt;: len(result2)&lt;br/&gt;
Out&lt;span class=&quot;error&quot;&gt;&amp;#91;71&amp;#93;&lt;/span&gt;: 1000&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;72&amp;#93;&lt;/span&gt;: result3 = client.get_range_slice(ks, cparent, p, start, &quot;&quot;, seg, cl)&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;73&amp;#93;&lt;/span&gt;: len(result3)&lt;br/&gt;
Out&lt;span class=&quot;error&quot;&gt;&amp;#91;73&amp;#93;&lt;/span&gt;: 1000&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;74&amp;#93;&lt;/span&gt;: start&lt;br/&gt;
Out&lt;span class=&quot;error&quot;&gt;&amp;#91;74&amp;#93;&lt;/span&gt;: &apos;ffb701ea740646b9955f0e339f8e3ee2&apos;&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;75&amp;#93;&lt;/span&gt;: result4 = client.get_range_slice(ks, cparent, p, start, start, seg, cl)&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;76&amp;#93;&lt;/span&gt;: len(result4)&lt;br/&gt;
Out&lt;span class=&quot;error&quot;&gt;&amp;#91;76&amp;#93;&lt;/span&gt;: 1000&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;77&amp;#93;&lt;/span&gt;: result5 = client.get_range_slice(ks, cparent, p, start, start, seg, cl)&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;78&amp;#93;&lt;/span&gt;: len(result5)&lt;br/&gt;
Out&lt;span class=&quot;error&quot;&gt;&amp;#91;78&amp;#93;&lt;/span&gt;: 1&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;79&amp;#93;&lt;/span&gt;: &lt;/p&gt;

&lt;p&gt;That can&apos;t be right. Here is the latest test..&lt;/p&gt;

&lt;p&gt;import sys&lt;br/&gt;
import time&lt;br/&gt;
import uuid&lt;/p&gt;

&lt;p&gt;from thrift import Thrift&lt;br/&gt;
from thrift.transport import TTransport&lt;br/&gt;
from thrift.transport import TSocket&lt;br/&gt;
from thrift.protocol.TBinaryProtocol import TBinaryProtocolAccelerated&lt;/p&gt;

&lt;p&gt;import sys&lt;br/&gt;
sys.path.insert(0,&apos;/usr/local/cassandra/interface/thrift/gen-py&apos;)&lt;/p&gt;

&lt;p&gt;from cassandra import Cassandra&lt;br/&gt;
from cassandra.ttypes import *&lt;/p&gt;

&lt;p&gt;num_keys = 10000&lt;/p&gt;

&lt;p&gt;socket = TSocket.TSocket(&quot;10.212.87.165&quot;, 9160)&lt;br/&gt;
transport = TTransport.TBufferedTransport(socket)&lt;br/&gt;
protocol = TBinaryProtocol.TBinaryProtocolAccelerated(transport)&lt;br/&gt;
client = Cassandra.Client(protocol)&lt;/p&gt;

&lt;p&gt;ks = &quot;Keyspace1&quot;&lt;br/&gt;
cf = &quot;Super1&quot;&lt;br/&gt;
cl = ConsistencyLevel.ONE&lt;/p&gt;

&lt;p&gt;d = {}&lt;/p&gt;

&lt;p&gt;transport.open()&lt;/p&gt;

&lt;p&gt;if 1:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;insert keys using the raw thrift interface&lt;br/&gt;
    cpath = ColumnPath(cf, &quot;foo&quot;, &quot;is&quot;)&lt;br/&gt;
    value = &quot;cool&quot;&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    for i in xrange(num_keys):&lt;br/&gt;
        ts = time.time()&lt;br/&gt;
        key = uuid.uuid4().hex&lt;br/&gt;
        client.insert(ks, key, cpath, value, ts, cl)&lt;br/&gt;
        d&lt;span class=&quot;error&quot;&gt;&amp;#91;key&amp;#93;&lt;/span&gt; = 1&lt;/p&gt;

&lt;p&gt;else:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;insert keys using pycassa!&lt;br/&gt;
    import pycassa&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    client = pycassa.connect(&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;10.212.87.165:9160&amp;quot;&amp;#93;&lt;/span&gt;)&lt;br/&gt;
    cf_test = pycassa.ColumnFamily(client, ks, cf, super=True)&lt;/p&gt;

&lt;p&gt;    for i in xrange(num_keys):&lt;br/&gt;
        key = uuid.uuid4().hex&lt;br/&gt;
        cf_test.insert(key, { &apos;params&apos; : { &apos;is&apos; : &apos;cool&apos; }})&lt;br/&gt;
        d&lt;span class=&quot;error&quot;&gt;&amp;#91;key&amp;#93;&lt;/span&gt; = 1&lt;/p&gt;


&lt;p&gt;cparent = ColumnParent(column_family=cf)&lt;br/&gt;
slice_range = SliceRange(start=&quot;key&quot;, finish=&quot;key&quot;)&lt;br/&gt;
p = SlicePredicate(slice_range=slice_range)&lt;/p&gt;

&lt;p&gt;done = False&lt;br/&gt;
seg = 1000&lt;br/&gt;
start = &quot;&quot;&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;do a scan using either get_key_range() (deprecated) or get_range_slice()&lt;/li&gt;
		&lt;li&gt;for every key returned that is in the dictionary, mark it as found&lt;br/&gt;
while not done:&lt;br/&gt;
    print &quot;start&quot;, start&lt;br/&gt;
    result = client.get_range_slice(ks, cparent, p, start, &quot;&quot;, seg, cl)&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    def getkey&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;:&lt;br/&gt;
        return x.key&lt;br/&gt;
    result = map(getkey, result)   &lt;br/&gt;
    result.sort()&lt;/p&gt;

&lt;p&gt;    for r in result:&lt;br/&gt;
        if d.has_key(r): &lt;br/&gt;
            d&lt;span class=&quot;error&quot;&gt;&amp;#91;r&amp;#93;&lt;/span&gt; = 0&lt;/p&gt;

&lt;p&gt;    if len(result) &amp;lt; seg: done = True&lt;br/&gt;
    else: start = result&lt;span class=&quot;error&quot;&gt;&amp;#91;seg-1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;cpath = ColumnPath(column_family=cf, super_column=&apos;foo&apos;)&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;
	&lt;ol&gt;
		&lt;li&gt;get, remove all the keys&lt;/li&gt;
		&lt;li&gt;print all the keys that were not marked 0&lt;br/&gt;
for k in d:&lt;br/&gt;
    result = client.get(ks, k, cpath, cl)&lt;br/&gt;
    #print result&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    if d&lt;span class=&quot;error&quot;&gt;&amp;#91;k&amp;#93;&lt;/span&gt; == 1: &lt;br/&gt;
        print k, &quot;not marked 0&quot;&lt;br/&gt;
    #else:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;print k, &quot;was marked 0!&quot;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;    ts = time.time()&lt;br/&gt;
    client.remove(ks, k, cpath, ts, cl)&lt;/p&gt;




&lt;p&gt;BTW, this time around my nodetool worked perfectly! When I first brought the two nodes up, they selected keys that were too close, and one node ended up with all the load. So I ran loadbalance, and it worked great! That was really awesome. The only thing I noticed was a single key that should have been found returned a NotFoundException. I&apos;ll keep an eye on this one, too. Best,&lt;/p&gt;

&lt;p&gt;Jack&lt;/p&gt;</comment>
                            <comment id="12832704" author="jbellis" created="Thu, 11 Feb 2010 22:17:28 +0000"  >&lt;p&gt;new patch attached.&lt;/p&gt;

&lt;p&gt;&amp;gt; ERROR 06:25:41,032 Internal error processing get_range_slice &lt;/p&gt;

&lt;p&gt;added InvalidRequestException when start &amp;gt; end, which fixes this.&lt;/p&gt;

&lt;p&gt;&amp;gt; The modified test (below) gets stuck in an infinite loop&lt;/p&gt;

&lt;p&gt;Your test is buggy. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;range_slice (like key_range) is start-INCLUSIVE, so if you pass a key that exists as start, you will always get at least one result, the start one.&lt;/p&gt;

&lt;p&gt;&amp;gt; the keys were not being returned in sorted order &lt;/p&gt;

&lt;p&gt;This is working fine for me.  Not sure what you were seeing.&lt;/p&gt;

&lt;p&gt;&amp;gt; when there are fewer keys in the specified range, duplicates are returned&lt;/p&gt;

&lt;p&gt;Sounds like another illustration of start-inclusiveness.&lt;/p&gt;

&lt;p&gt;If you still see problems, can you narrow it down to a specific set of keys, rather than relying on randomness to maybe reproduce it once in a while?  That would help a lot.  Thanks!&lt;/p&gt;</comment>
                            <comment id="12832827" author="bjc" created="Fri, 12 Feb 2010 03:44:06 +0000"  >&lt;p&gt;I don&apos;t think my test is buggy. I realize that the range is start inclusive, and it does pass a key that exists as start, but sets &quot;done = True&quot; if the range scan returns less keys than requested. Since it passes &quot;&quot; as the end/finish, this should return less keys than requested when you get to the end, provided you ask for more than one key (which I do).&lt;/p&gt;

&lt;p&gt;I think the last remaining problem is with the sorting! I bet that is why using &quot;&quot; for my finish string doesn&apos;t work. Here&apos;s the problem I see now (transcript followed by test):&lt;/p&gt;

&lt;p&gt;I put 10 random keys in, ask for them back. They aren&apos;t sorted, so I sort them and take the highest. I use that as start, and &quot;&quot; as finish. This should give me one key back, but instead I get 10. Could it be that my columnfamily definition is different than yours? Here&apos;s mine:&lt;/p&gt;

&lt;p&gt;      &amp;lt;ColumnFamily ColumnType=&quot;Super&quot;&lt;br/&gt;
                    CompareWith=&quot;UTF8Type&quot;&lt;br/&gt;
                    CompareSubcolumnsWith=&quot;UTF8Type&quot;&lt;br/&gt;
                    Name=&quot;Super1&quot;&lt;br/&gt;
                    RowsCached=&quot;1000&quot;&lt;br/&gt;
                    KeysCachedFraction=&quot;0&quot;&lt;br/&gt;
                    Comment=&quot;A column family with supercolumns, whose column and subcolumn names are UTF8 strings&quot;/&amp;gt;&lt;/p&gt;


&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;17&amp;#93;&lt;/span&gt;: run test_bug_simple2.py&lt;br/&gt;
result1 before sorting&lt;br/&gt;
af37b718213b4219897ea1564ebc8900&lt;br/&gt;
f196ad5537294840b2de0a636202dbd2&lt;br/&gt;
7578ba38b66d4708a38663717e020959&lt;br/&gt;
b5266af926a647c3a1a4d2f62dfe952c&lt;br/&gt;
d729d5181bac42a48ac3e49d9700047e&lt;br/&gt;
4d58b6fbea214d0c9c7a9f288feba2d8&lt;br/&gt;
41df7aee7d674a75a4943d89153f9bde&lt;br/&gt;
4e121f95459e4f67a6cd3c06b2d078e7&lt;br/&gt;
99b2b03675a8413f94e60e3d1bbded8c&lt;br/&gt;
66121c5c863f4c1f804a46b8c2136fe9&lt;br/&gt;
result1 after sorting&lt;br/&gt;
41df7aee7d674a75a4943d89153f9bde&lt;br/&gt;
4d58b6fbea214d0c9c7a9f288feba2d8&lt;br/&gt;
4e121f95459e4f67a6cd3c06b2d078e7&lt;br/&gt;
66121c5c863f4c1f804a46b8c2136fe9&lt;br/&gt;
7578ba38b66d4708a38663717e020959&lt;br/&gt;
99b2b03675a8413f94e60e3d1bbded8c&lt;br/&gt;
af37b718213b4219897ea1564ebc8900&lt;br/&gt;
b5266af926a647c3a1a4d2f62dfe952c&lt;br/&gt;
d729d5181bac42a48ac3e49d9700047e&lt;br/&gt;
f196ad5537294840b2de0a636202dbd2&lt;br/&gt;
start f196ad5537294840b2de0a636202dbd2&lt;br/&gt;
result2&lt;br/&gt;
f196ad5537294840b2de0a636202dbd2&lt;br/&gt;
7578ba38b66d4708a38663717e020959&lt;br/&gt;
b5266af926a647c3a1a4d2f62dfe952c&lt;br/&gt;
d729d5181bac42a48ac3e49d9700047e&lt;br/&gt;
4d58b6fbea214d0c9c7a9f288feba2d8&lt;br/&gt;
41df7aee7d674a75a4943d89153f9bde&lt;br/&gt;
4e121f95459e4f67a6cd3c06b2d078e7&lt;br/&gt;
99b2b03675a8413f94e60e3d1bbded8c&lt;br/&gt;
66121c5c863f4c1f804a46b8c2136fe9&lt;br/&gt;
b8b290a864464271ad30df1bbab2f2b7&lt;br/&gt;
---------------------------------------------------------------------------&lt;br/&gt;
AssertionError                            Traceback (most recent call last)&lt;/p&gt;

&lt;p&gt;/k/jack/bridge/test_bug_simple2.py in &amp;lt;module&amp;gt;()&lt;br/&gt;
     54 for r in result2: print r.key&lt;br/&gt;
     55 &lt;br/&gt;
---&amp;gt; 56 assert len(result2) == 1&lt;br/&gt;
     57 &lt;br/&gt;
     58 &lt;/p&gt;

&lt;p&gt;AssertionError: &lt;br/&gt;
WARNING: Failure executing file: &amp;lt;test_bug_simple2.py&amp;gt;&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;18&amp;#93;&lt;/span&gt;: &lt;/p&gt;





&lt;p&gt;import uuid&lt;/p&gt;

&lt;p&gt;from thrift import Thrift&lt;br/&gt;
from thrift.transport import TTransport&lt;br/&gt;
from thrift.transport import TSocket&lt;br/&gt;
from thrift.protocol.TBinaryProtocol import TBinaryProtocolAccelerated&lt;/p&gt;

&lt;p&gt;import sys&lt;br/&gt;
sys.path.insert(0,&apos;/usr/local/cassandra/interface/thrift/gen-py&apos;)&lt;/p&gt;

&lt;p&gt;from cassandra import Cassandra&lt;br/&gt;
from cassandra.ttypes import *&lt;/p&gt;

&lt;p&gt;socket = TSocket.TSocket(&quot;10.212.87.165&quot;, 9160)&lt;br/&gt;
transport = TTransport.TBufferedTransport(socket)&lt;br/&gt;
protocol = TBinaryProtocol.TBinaryProtocolAccelerated(transport)&lt;br/&gt;
client = Cassandra.Client(protocol)&lt;/p&gt;

&lt;p&gt;transport.open()&lt;/p&gt;

&lt;p&gt;ks = &quot;Keyspace1&quot;&lt;br/&gt;
cf = &quot;Super1&quot;&lt;br/&gt;
path = ColumnPath(cf, &quot;foo&quot;, &quot;is&quot;)&lt;br/&gt;
value = &quot;cool&quot;&lt;/p&gt;

&lt;p&gt;for i in xrange(100):&lt;br/&gt;
    key = uuid.uuid4().hex&lt;br/&gt;
    client.insert(ks, key, path, value, 0, ConsistencyLevel.ONE)&lt;/p&gt;

&lt;p&gt;parent = ColumnParent(column_family=cf)&lt;br/&gt;
slice_range = SliceRange(start=&quot;key&quot;, finish=&quot;key&quot;)&lt;br/&gt;
predicate = SlicePredicate(slice_range=slice_range)&lt;/p&gt;

&lt;p&gt;result1 = client.get_range_slice(ks, parent, predicate, &quot;&quot;, &quot;&quot;, 10, ConsistencyLevel.ONE)&lt;/p&gt;

&lt;p&gt;print &quot;result1 before sorting&quot;&lt;br/&gt;
for r in result1: print r.key&lt;/p&gt;

&lt;p&gt;def getkey&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;: return x.key&lt;/p&gt;

&lt;p&gt;print &quot;result1 after sorting&quot;&lt;br/&gt;
result1 = map(getkey, result1)&lt;br/&gt;
result1.sort()&lt;/p&gt;

&lt;p&gt;for r in result1: print r&lt;/p&gt;

&lt;p&gt;start = result1&lt;span class=&quot;error&quot;&gt;&amp;#91;-1&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;print &quot;start&quot;, start&lt;/p&gt;

&lt;p&gt;result2 = client.get_range_slice(ks, parent, predicate, start, &quot;&quot;, 10, ConsistencyLevel.ONE)&lt;/p&gt;

&lt;p&gt;print &quot;result2&quot;&lt;br/&gt;
for r in result2: print r.key&lt;/p&gt;

&lt;p&gt;assert len(result2) == 1&lt;/p&gt;

</comment>
                            <comment id="12832828" author="jbellis" created="Fri, 12 Feb 2010 03:48:30 +0000"  >&lt;p&gt;If you&apos;re using RP instead of OPP you will see that.&lt;/p&gt;</comment>
                            <comment id="12832830" author="bjc" created="Fri, 12 Feb 2010 04:18:48 +0000"  >&lt;p&gt;Ahh!! Right you are, I was using RP instead of OPP. Ok, but now here is another problem: if I insert 10 keys and then ask for them back, it works. However, if I insert 10 more and do a range scan with start=&quot;&quot;, I don&apos;t get the lowest key:&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;17&amp;#93;&lt;/span&gt;: run test_bug_simple3.py&lt;br/&gt;
insert aa3cf33059d64dac8aef4a250bc5ea9c&lt;br/&gt;
insert a7dbda2925eb4b439c89cd71d56b5113&lt;br/&gt;
insert f28e92d5e5554857940c9d3386bf4121&lt;br/&gt;
insert 2b8ec460e7d346cbaf3dcb00e1aaaf91&lt;br/&gt;
insert 7792c98f0c3948299c622c73b906df66&lt;br/&gt;
insert 37a8bfdb69b642ba8e96d33b060f789d&lt;br/&gt;
insert 38c18f5d3d2c46cbb4e44b603a8acdbd&lt;br/&gt;
insert bef8104ea9184abaa3f0788ef7b2e0db&lt;br/&gt;
insert 934fe04d30cc4a96b1f1a9e7930316b8&lt;br/&gt;
insert 1d3413e88af946349f148c4fafeb6bf7&lt;br/&gt;
result 1d3413e88af946349f148c4fafeb6bf7&lt;br/&gt;
result 2b8ec460e7d346cbaf3dcb00e1aaaf91&lt;br/&gt;
result 37a8bfdb69b642ba8e96d33b060f789d&lt;br/&gt;
result 38c18f5d3d2c46cbb4e44b603a8acdbd&lt;br/&gt;
result 7792c98f0c3948299c622c73b906df66&lt;br/&gt;
result a7dbda2925eb4b439c89cd71d56b5113&lt;br/&gt;
result aa3cf33059d64dac8aef4a250bc5ea9c&lt;br/&gt;
result bef8104ea9184abaa3f0788ef7b2e0db&lt;br/&gt;
result f28e92d5e5554857940c9d3386bf4121&lt;br/&gt;
start f28e92d5e5554857940c9d3386bf4121&lt;br/&gt;
result f28e92d5e5554857940c9d3386bf4121&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;18&amp;#93;&lt;/span&gt;: run test_bug_simple3.py&lt;br/&gt;
insert 4eb0300540ec4b4083fbaf33741fc4a5&lt;br/&gt;
insert 12b43ba967314b369faff7e59902d6c2&lt;br/&gt;
insert 5b4b729676bc4ea2816620c3b6dff080&lt;br/&gt;
insert cf2fda1b11d843f1ae7949dbbb7d179d&lt;br/&gt;
insert c9d0cf4a1e9a48caa143afd2b0268f70&lt;br/&gt;
insert 9a044cff59b940d5bfbeffd58b01ee8e&lt;br/&gt;
insert d2ee042f0b0b4f7ea86e6e2c0dfdcfdd&lt;br/&gt;
insert d239aee577684c27afea2fe7e3361bdf&lt;br/&gt;
insert 706b20976f974de49bda61d55b9c2a63&lt;br/&gt;
insert 36177455bc3b4469b7e6f51897c9f3ba&lt;br/&gt;
result a7dbda2925eb4b439c89cd71d56b5113&lt;br/&gt;
result aa3cf33059d64dac8aef4a250bc5ea9c&lt;br/&gt;
result bef8104ea9184abaa3f0788ef7b2e0db&lt;br/&gt;
result c9d0cf4a1e9a48caa143afd2b0268f70&lt;br/&gt;
result cf2fda1b11d843f1ae7949dbbb7d179d&lt;br/&gt;
start cf2fda1b11d843f1ae7949dbbb7d179d&lt;br/&gt;
result cf2fda1b11d843f1ae7949dbbb7d179d&lt;br/&gt;
result d239aee577684c27afea2fe7e3361bdf&lt;br/&gt;
result d2ee042f0b0b4f7ea86e6e2c0dfdcfdd&lt;br/&gt;
result f28e92d5e5554857940c9d3386bf4121&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;19&amp;#93;&lt;/span&gt;: &lt;/p&gt;


&lt;p&gt;See what I mean? In the first run I inserted &quot;1d3413e88af946349f148c4fafeb6bf7&quot; but the second range scan I get &quot;a7dbda2925eb4b439c89cd71d56b5113&quot; back first, even when I set start=&quot;&quot;. Could this somehow be my fault too?&lt;/p&gt;

&lt;p&gt;Test follows:&lt;/p&gt;


&lt;p&gt;import uuid&lt;/p&gt;

&lt;p&gt;from thrift import Thrift&lt;br/&gt;
from thrift.transport import TTransport&lt;br/&gt;
from thrift.transport import TSocket&lt;br/&gt;
from thrift.protocol.TBinaryProtocol import TBinaryProtocolAccelerated&lt;/p&gt;

&lt;p&gt;import sys&lt;br/&gt;
sys.path.insert(0,&apos;/usr/local/cassandra/interface/thrift/gen-py&apos;)&lt;/p&gt;

&lt;p&gt;from cassandra import Cassandra&lt;br/&gt;
from cassandra.ttypes import *&lt;/p&gt;

&lt;p&gt;socket = TSocket.TSocket(&quot;10.212.87.165&quot;, 9160)&lt;br/&gt;
transport = TTransport.TBufferedTransport(socket)&lt;br/&gt;
protocol = TBinaryProtocol.TBinaryProtocolAccelerated(transport)&lt;br/&gt;
client = Cassandra.Client(protocol)&lt;/p&gt;

&lt;p&gt;transport.open()&lt;/p&gt;

&lt;p&gt;ks = &quot;Keyspace1&quot;&lt;br/&gt;
cf = &quot;Super1&quot;&lt;br/&gt;
path = ColumnPath(cf, &quot;foo&quot;, &quot;is&quot;)&lt;br/&gt;
value = &quot;cool&quot;&lt;/p&gt;

&lt;p&gt;for i in xrange(10):&lt;br/&gt;
    key = uuid.uuid4().hex&lt;br/&gt;
    print &quot;insert&quot;, key&lt;br/&gt;
    client.insert(ks, key, path, value, 0, ConsistencyLevel.ONE)&lt;/p&gt;

&lt;p&gt;parent = ColumnParent(column_family=cf)&lt;br/&gt;
slice_range = SliceRange(start=&quot;key&quot;, finish=&quot;key&quot;)&lt;br/&gt;
predicate = SlicePredicate(slice_range=slice_range)&lt;/p&gt;


&lt;p&gt;result = client.get_range_slice(ks, parent, predicate, &quot;&quot;, &quot;&quot;, 5, ConsistencyLevel.ONE)&lt;br/&gt;
for row in result:&lt;br/&gt;
    print &quot;result&quot;, row.key&lt;/p&gt;

&lt;p&gt;start = result&lt;span class=&quot;error&quot;&gt;&amp;#91;-1&amp;#93;&lt;/span&gt;.key&lt;/p&gt;

&lt;p&gt;print &quot;start&quot;, start&lt;/p&gt;

&lt;p&gt;result = client.get_range_slice(ks, parent, predicate, start, &quot;&quot;, 10, ConsistencyLevel.ONE)&lt;br/&gt;
for row in result:&lt;br/&gt;
    print &quot;result&quot;, row.key&lt;/p&gt;
</comment>
                            <comment id="12833322" author="jbellis" created="Sat, 13 Feb 2010 04:28:50 +0000"  >&lt;p&gt;Ah, yes, definitely reintroduced a bug in picking the range to start scanning in.  Fix attached.&lt;/p&gt;</comment>
                            <comment id="12833454" author="bjc" created="Sat, 13 Feb 2010 21:04:38 +0000"  >&lt;p&gt;Some of the patches didn&apos;t apply, some problem as before? I checked out freshly just now. Can you post the individual files again? Thanks.. Or..maybe this is the problem: why does your most recently attached patch have a Wednesday time stamp on it? Here is what I get at the top:&lt;/p&gt;

&lt;p&gt;commit 630c33353647f062134d66afa3b487d95abe03fe&lt;br/&gt;
Author: Jonathan Ellis &amp;lt;jonathan.ellis@rackspace.com&amp;gt;&lt;br/&gt;
Date:   Wed Feb 10 18:04:08 2010 -0600&lt;/p&gt;

&lt;p&gt;    fix range queries&lt;/p&gt;

&lt;p&gt;Shouldn&apos;t that be Friday? Here&apos;s the transcript:&lt;/p&gt;

&lt;p&gt;$ svn checkout &lt;a href=&quot;https://svn.apache.org/repos/asf/incubator/cassan&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://svn.apache.org/repos/asf/incubator/cassan&lt;/a&gt;&lt;br/&gt;
dra/trunk cassandra&lt;br/&gt;
A    cassandra/test&lt;br/&gt;
A    cassandra/test/unit&lt;br/&gt;
...&lt;br/&gt;
$ cd cassandra&lt;br/&gt;
$ wget &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12435762&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12435762&lt;/a&gt;&lt;br/&gt;
/781.txt&lt;br/&gt;
-&lt;del&gt;2010-02-13 20:57:49&lt;/del&gt;-  &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/124357&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/124357&lt;/a&gt;&lt;br/&gt;
62/781.txt&lt;br/&gt;
Resolving issues.apache.org... 140.211.11.140&lt;br/&gt;
Connecting to issues.apache.org|140.211.11.140|:443... connected.&lt;br/&gt;
HTTP request sent, awaiting response... 200 OK&lt;br/&gt;
Length: 47140 (46K) &lt;span class=&quot;error&quot;&gt;&amp;#91;text/plain&amp;#93;&lt;/span&gt;&lt;br/&gt;
Saving to: `781.txt&apos;&lt;/p&gt;

&lt;p&gt;100%&lt;span class=&quot;error&quot;&gt;&amp;#91;======================================&amp;gt;&amp;#93;&lt;/span&gt; 47,140       120K/s   in 0.4s    &lt;/p&gt;

&lt;p&gt;2010-02-13 20:57:50 (120 KB/s) - `781.txt&apos; saved &lt;span class=&quot;error&quot;&gt;&amp;#91;47140/47140&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;$ patch -p1 &amp;lt;781.txt &lt;br/&gt;
patching file src/java/org/apache/cassandra/db/ColumnFamilyStore.java&lt;br/&gt;
patching file src/java/org/apache/cassandra/db/RangeSliceReply.java&lt;br/&gt;
patching file src/java/org/apache/cassandra/dht/AbstractBounds.java&lt;br/&gt;
Hunk #1 FAILED at 1.&lt;br/&gt;
Hunk #2 FAILED at 25.&lt;br/&gt;
2 out of 2 hunks FAILED &amp;#8211; saving rejects to file src/java/org/apache/cassandra/&lt;br/&gt;
dht/AbstractBounds.java.rej&lt;br/&gt;
patching file src/java/org/apache/cassandra/dht/Bounds.java&lt;br/&gt;
Hunk #1 FAILED at 1.&lt;br/&gt;
Hunk #2 FAILED at 8.&lt;br/&gt;
2 out of 2 hunks FAILED &amp;#8211; saving rejects to file src/java/org/apache/cassandra/&lt;br/&gt;
dht/Bounds.java.rej&lt;br/&gt;
patching file src/java/org/apache/cassandra/dht/Range.java&lt;br/&gt;
patching file src/java/org/apache/cassandra/service/RangeSliceResponseResolver.j&lt;br/&gt;
ava&lt;br/&gt;
patching file src/java/org/apache/cassandra/service/StorageProxy.java&lt;br/&gt;
patching file src/java/org/apache/cassandra/service/StorageService.java&lt;br/&gt;
patching file src/java/org/apache/cassandra/thrift/CassandraServer.java&lt;br/&gt;
patching file src/java/org/apache/cassandra/thrift/ThriftValidation.java&lt;br/&gt;
patching file test/system/test_server.py&lt;br/&gt;
patching file test/unit/org/apache/cassandra/dht/BoundsTest.java&lt;br/&gt;
patching file test/unit/org/apache/cassandra/dht/RangeIntersectionTest.java&lt;br/&gt;
patching file test/unit/org/apache/cassandra/dht/RangeTest.java&lt;br/&gt;
$&lt;/p&gt;
</comment>
                            <comment id="12833461" author="jbellis" created="Sat, 13 Feb 2010 21:43:50 +0000"  >&lt;p&gt;re-attached w/ line endings fixed.  &lt;/p&gt;</comment>
                            <comment id="12833477" author="bjc" created="Sun, 14 Feb 2010 00:12:06 +0000"  >&lt;p&gt;Thanks for fixing the patch, but I&apos;m sorry...it still doesn&apos;t work right.. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I found a couple of weird things. First, sometimes when I ask for 10, it gives more. Second, if I pass start=&quot;&quot; it still doesn&apos;t start at the beginning. &lt;/p&gt;

&lt;p&gt;However, this doesn&apos;t happen every time I start fresh. Maybe it&apos;s depedent on the tokens. Here are the tokens for the case I show below: &lt;/p&gt;

&lt;p&gt; INFO 23:38:21,989 Saved Token not found. Using 0njMRYmU9KiXE80d &lt;br/&gt;
 INFO 23:38:20,112 Saved Token not found. Using I8LW8J6h9UCuz0dC &lt;/p&gt;

&lt;p&gt;The first token belongs to the node I am attaching the client to.&lt;/p&gt;

&lt;p&gt;This functionality seems surprisingly complicated. Maybe it would help to write down pseudo-code for the way it should work? I have to admit that I cannot piece it together by reading the comments in your patch.&lt;/p&gt;

&lt;p&gt;Here is a transcript and test: &lt;/p&gt;

&lt;p&gt;First run, looks ok: &lt;/p&gt;

&lt;p&gt;ip-10-212-87-165$ python test_bug_simple3.py &lt;br/&gt;
insert 10b470f49a7c46bd938d784ca4096b63 &lt;br/&gt;
insert 47f70aacb3e94e10acaf8e86edac7169 &lt;br/&gt;
insert 9a3b7d3b921345bebc4f2bedc1db7c01 &lt;br/&gt;
insert c1c9dab59abd4f4ca33ee79f71a179e9 &lt;br/&gt;
insert cff81b145faf4648ac8ae001973c6c75 &lt;br/&gt;
insert c752d33e5d344312908e5008e6cdae3e &lt;br/&gt;
insert 6e9e32e8b89845bb935d993a9c8bcb13 &lt;br/&gt;
insert c286bf2711bc45c1ab033561112c2313 &lt;br/&gt;
insert 2dad487ddfa94c81b52c8b4d35d3cb5c &lt;br/&gt;
insert 9c62c7dafdb94dfdbdf52b527bdd2b24 &lt;/p&gt;

&lt;p&gt;result 10b470f49a7c46bd938d784ca4096b63 &lt;br/&gt;
result 2dad487ddfa94c81b52c8b4d35d3cb5c &lt;br/&gt;
result 47f70aacb3e94e10acaf8e86edac7169 &lt;br/&gt;
result 6e9e32e8b89845bb935d993a9c8bcb13 &lt;br/&gt;
result 9a3b7d3b921345bebc4f2bedc1db7c01 &lt;br/&gt;
result 9c62c7dafdb94dfdbdf52b527bdd2b24 &lt;br/&gt;
result c1c9dab59abd4f4ca33ee79f71a179e9 &lt;br/&gt;
result c286bf2711bc45c1ab033561112c2313 &lt;br/&gt;
result c752d33e5d344312908e5008e6cdae3e &lt;br/&gt;
result cff81b145faf4648ac8ae001973c6c75 &lt;br/&gt;
total_keys 10 &lt;/p&gt;

&lt;p&gt;Second run, get 18 keys when I asked for 10: &lt;/p&gt;

&lt;p&gt;ip-10-212-87-165$ python test_bug_simple3.py &lt;br/&gt;
insert f873d662dccf46c28080a01286e09ed8 &lt;br/&gt;
insert 903776c2f45740389aa52675bf47c7ec &lt;br/&gt;
insert 0e80401a9052405a898d11e5ae874a13 &lt;br/&gt;
insert 398d51ba174b4c9db8c25ca6cd2c9454 &lt;br/&gt;
insert 50f1cd47dd284ee9b9573b4dfce39134 &lt;br/&gt;
insert 20fa43d2365b4dfab9b05a93992315d0 &lt;br/&gt;
insert e009d5b76e8840b784fe6b9b649ae1df &lt;br/&gt;
insert 63497f9d63c74b99a681fa2fc52751ac &lt;br/&gt;
insert 824bbcf997de48a99cad174e9e1f1eec &lt;br/&gt;
insert 01c5a6506f4247068660c20338a03bb3 &lt;/p&gt;

&lt;p&gt;result 01c5a6506f4247068660c20338a03bb3 &lt;br/&gt;
result 0e80401a9052405a898d11e5ae874a13 &lt;br/&gt;
result 10b470f49a7c46bd938d784ca4096b63 &lt;br/&gt;
result 20fa43d2365b4dfab9b05a93992315d0 &lt;br/&gt;
result 2dad487ddfa94c81b52c8b4d35d3cb5c &lt;br/&gt;
result 398d51ba174b4c9db8c25ca6cd2c9454 &lt;br/&gt;
result 47f70aacb3e94e10acaf8e86edac7169 &lt;br/&gt;
result 50f1cd47dd284ee9b9573b4dfce39134 &lt;br/&gt;
result 63497f9d63c74b99a681fa2fc52751ac &lt;br/&gt;
result 6e9e32e8b89845bb935d993a9c8bcb13 &lt;br/&gt;
result 824bbcf997de48a99cad174e9e1f1eec &lt;br/&gt;
result 903776c2f45740389aa52675bf47c7ec &lt;br/&gt;
result c1c9dab59abd4f4ca33ee79f71a179e9 &lt;br/&gt;
result c286bf2711bc45c1ab033561112c2313 &lt;br/&gt;
result c752d33e5d344312908e5008e6cdae3e &lt;br/&gt;
result cff81b145faf4648ac8ae001973c6c75 &lt;br/&gt;
result e009d5b76e8840b784fe6b9b649ae1df &lt;br/&gt;
result f873d662dccf46c28080a01286e09ed8 &lt;br/&gt;
total_keys 18 &lt;/p&gt;

&lt;p&gt;Third run, start at &quot;ca..&quot; even though I pass start=&quot;&quot; and all the previous keys remain: &lt;/p&gt;

&lt;p&gt;ip-10-212-87-165$ python test_bug_simple3.py &lt;br/&gt;
insert ca97d7efb63448f8a62d6f7f73044236 &lt;br/&gt;
insert 91363a713b714af88ac2191caeea5351 &lt;br/&gt;
insert 7b6756d0ab8e450b826b1abc7210d524 &lt;br/&gt;
insert e6c6765497af4078b93e1a1470bd3194 &lt;br/&gt;
insert e3457f26754c4e7cb7ef606f98e7bb78 &lt;br/&gt;
insert 99643eb237ea4ca8b50cac4bb4d58edd &lt;br/&gt;
insert ec3e1f81359b4ae08cfed73899934a93 &lt;br/&gt;
insert ae2b990ceb044bf194a879059f823ecf &lt;br/&gt;
insert 2c1494f0ad3d48d2bf4feb33f40cf38e &lt;br/&gt;
insert 0cb1c2e906b64fee89f7729052e0810e &lt;/p&gt;

&lt;p&gt;result ae2b990ceb044bf194a879059f823ecf &lt;br/&gt;
result c1c9dab59abd4f4ca33ee79f71a179e9 &lt;br/&gt;
result c286bf2711bc45c1ab033561112c2313 &lt;br/&gt;
result c752d33e5d344312908e5008e6cdae3e &lt;br/&gt;
result ca97d7efb63448f8a62d6f7f73044236 &lt;br/&gt;
result cff81b145faf4648ac8ae001973c6c75 &lt;br/&gt;
result e009d5b76e8840b784fe6b9b649ae1df &lt;br/&gt;
result e3457f26754c4e7cb7ef606f98e7bb78 &lt;br/&gt;
result e6c6765497af4078b93e1a1470bd3194 &lt;br/&gt;
result ec3e1f81359b4ae08cfed73899934a93 &lt;br/&gt;
total_keys 10 &lt;br/&gt;
ip-10-212-87-165$ &lt;/p&gt;

&lt;p&gt;Here is another run (different tokens):&lt;/p&gt;

&lt;p&gt; INFO 00:04:17,105 Saved Token not found. Using Iw1khrAgM5sd6WnX&lt;br/&gt;
 INFO 00:04:15,795 Saved Token not found. Using IgLbq912n2xEP99G&lt;/p&gt;

&lt;p&gt;In this case I don&apos;t see the problem where I get back more keys than I asked for, but I don&apos;t get the 10 lowest keys in the second request. 10 are returned, but they are not ordered consistently with what I know is in the db.&lt;/p&gt;

&lt;p&gt;First run, notice key &quot;893..&quot; is inserted:&lt;/p&gt;

&lt;p&gt;ip-10-212-87-165$ python test_bug_simple3.py &lt;br/&gt;
insert 7be5d87bc45843cfaffd36fd654aee53&lt;br/&gt;
insert 8ef4727d83474570aa2111bee3929a5f&lt;br/&gt;
insert 9a9a91b6b662430092db0209d63a5c9e&lt;br/&gt;
insert e45afe1f0e364012acd0dead5b75ea13&lt;br/&gt;
insert 10171c87634842aea4f16d46d611c435&lt;br/&gt;
insert 10b6f92ac6a447088a82c4ec13056f1e&lt;br/&gt;
insert c1acbde9ae454ea2819322975322206b&lt;br/&gt;
insert 89352cf117dd4cb9ab935cbb5f230ba0&lt;br/&gt;
insert 0b5d924f04174459969594d6293b9aca&lt;br/&gt;
insert e2471db4d8f445f2b0c36f3b2a5bb650&lt;/p&gt;

&lt;p&gt;result 0b5d924f04174459969594d6293b9aca&lt;br/&gt;
result 10171c87634842aea4f16d46d611c435&lt;br/&gt;
result 10b6f92ac6a447088a82c4ec13056f1e&lt;br/&gt;
result 7be5d87bc45843cfaffd36fd654aee53&lt;br/&gt;
result 89352cf117dd4cb9ab935cbb5f230ba0&lt;br/&gt;
result 8ef4727d83474570aa2111bee3929a5f&lt;br/&gt;
result 9a9a91b6b662430092db0209d63a5c9e&lt;br/&gt;
result c1acbde9ae454ea2819322975322206b&lt;br/&gt;
result e2471db4d8f445f2b0c36f3b2a5bb650&lt;br/&gt;
result e45afe1f0e364012acd0dead5b75ea13&lt;br/&gt;
total_keys 10&lt;/p&gt;

&lt;p&gt;Second run, notice the results start with &quot;0..&quot; but &quot;893..&quot; is not returned (though &quot;b2..&quot; is, and other higher keys):&lt;/p&gt;

&lt;p&gt;ip-10-212-87-165$ python test_bug_simple3.py &lt;br/&gt;
insert 85d282dfa03a466eb51d03f4eb5dacd5&lt;br/&gt;
insert a61e7757eaed4ef79fc7bf35f47843f7&lt;br/&gt;
insert 9b9b6e3f22994827b0dddcc16105ff7d&lt;br/&gt;
insert 880b1644636845d8b1c92faf1f6d8484&lt;br/&gt;
insert 5d1d7d7b26ec4540a89c027bccc17e06&lt;br/&gt;
insert 4df05d38950f44b29df604c165e1148f&lt;br/&gt;
insert 0c9f818aa28a47fb832b6a0929b94280&lt;br/&gt;
insert 7e7b829c136046a88b120a4a373d9a6b&lt;br/&gt;
insert b2d497713f9342de85bb31b5c0e69af6&lt;br/&gt;
insert 80e250253f1942aaab2e9b49880918c0&lt;/p&gt;

&lt;p&gt;result 0b5d924f04174459969594d6293b9aca&lt;br/&gt;
result 0c9f818aa28a47fb832b6a0929b94280&lt;br/&gt;
result 10171c87634842aea4f16d46d611c435&lt;br/&gt;
result 10b6f92ac6a447088a82c4ec13056f1e&lt;br/&gt;
result 4df05d38950f44b29df604c165e1148f&lt;br/&gt;
result a61e7757eaed4ef79fc7bf35f47843f7&lt;br/&gt;
result b2d497713f9342de85bb31b5c0e69af6&lt;br/&gt;
result c1acbde9ae454ea2819322975322206b&lt;br/&gt;
result e2471db4d8f445f2b0c36f3b2a5bb650&lt;br/&gt;
result e45afe1f0e364012acd0dead5b75ea13&lt;br/&gt;
total_keys 10&lt;br/&gt;
ip-10-212-87-165$ &lt;/p&gt;

&lt;p&gt;I found another issue with &quot;nodetool ring&quot; which might be related to the patch: &lt;/p&gt;

&lt;p&gt;$ sudo bin/nodetool -h localhost ring &lt;br/&gt;
Exception in thread &quot;main&quot; java.lang.reflect.UndeclaredThrowableException &lt;br/&gt;
        at $Proxy0.getRangeToEndPointMap(Unknown Source) &lt;br/&gt;
        at org.apache.cassandra.tools.NodeProbe.getRangeToEndPointMap(NodeProbe.java:151) &lt;br/&gt;
        at org.apache.cassandra.tools.NodeCmd.printRing(NodeCmd.java:74) &lt;br/&gt;
        at org.apache.cassandra.tools.NodeCmd.main(NodeCmd.java:403) &lt;br/&gt;
Caused by: java.rmi.UnmarshalException: error unmarshalling return; nested exception is: &lt;br/&gt;
        java.io.WriteAbortedException: writing aborted; java.io.NotSerializableException: org.apache.cassandra.dht.OrderPreservingPartitioner &lt;br/&gt;
        at sun.rmi.server.UnicastRef.invoke(UnicastRef.java:173) &lt;br/&gt;
        at com.sun.jmx.remote.internal.PRef.invoke(Unknown Source) &lt;br/&gt;
        at javax.management.remote.rmi.RMIConnectionImpl_Stub.invoke(Unknown Source) &lt;br/&gt;
        at javax.management.remote.rmi.RMIConnector$RemoteMBeanServerConnection.invoke(RMIConnector.java:993) &lt;br/&gt;
        at javax.management.MBeanServerInvocationHandler.invoke(MBeanServerInvocationHandler.java:288) &lt;br/&gt;
        ... 4 more &lt;br/&gt;
Caused by: java.io.WriteAbortedException: writing aborted; java.io.NotSerializableException: org.apache.cassandra.dht.OrderPreservingPartitioner &lt;br/&gt;
        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1333) &lt;br/&gt;
        at java.io.ObjectInputStream.defaultReadFields(ObjectInputStream.java:1947) &lt;br/&gt;
        at java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1871) &lt;br/&gt;
        at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1753) &lt;br/&gt;
        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1329) &lt;br/&gt;
        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:351) &lt;br/&gt;
        at java.util.HashMap.readObject(HashMap.java:1029) &lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) &lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39) &lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25) &lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597) &lt;br/&gt;
        at java.io.ObjectStreamClass.invokeReadObject(ObjectStreamClass.java:974) &lt;br/&gt;
        at java.io.ObjectInputStream.readSerialData(ObjectInputStream.java:1849) &lt;br/&gt;
        at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1753) &lt;br/&gt;
        at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1329) &lt;br/&gt;
        at java.io.ObjectInputStream.readObject(ObjectInputStream.java:351) &lt;br/&gt;
        at sun.rmi.server.UnicastRef.unmarshalValue(UnicastRef.java:306) &lt;br/&gt;
        at sun.rmi.server.UnicastRef.invoke(UnicastRef.java:155) &lt;br/&gt;
        ... 8 more &lt;br/&gt;
Caused by: java.io.NotSerializableException: org.apache.cassandra.dht.OrderPreservingPartitioner &lt;br/&gt;
        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1156) &lt;br/&gt;
        at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:1509) &lt;br/&gt;
        at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1474) &lt;br/&gt;
        at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1392) &lt;br/&gt;
        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1150) &lt;br/&gt;
        at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:326) &lt;br/&gt;
        at java.util.HashMap.writeObject(HashMap.java:1000) &lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method) &lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39) &lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25) &lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597) &lt;br/&gt;
        at java.io.ObjectStreamClass.invokeWriteObject(ObjectStreamClass.java:945) &lt;br/&gt;
        at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:1461) &lt;br/&gt;
        at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:1392) &lt;br/&gt;
        at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:1150) &lt;br/&gt;
        at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:326) &lt;br/&gt;
        at sun.rmi.server.UnicastRef.marshalValue(UnicastRef.java:274) &lt;br/&gt;
        at sun.rmi.server.UnicastServerRef.dispatch(UnicastServerRef.java:315) &lt;br/&gt;
        at sun.rmi.transport.Transport$1.run(Transport.java:159) &lt;br/&gt;
        at java.security.AccessController.doPrivileged(Native Method) &lt;br/&gt;
        at sun.rmi.transport.Transport.serviceCall(Transport.java:155) &lt;br/&gt;
        at sun.rmi.transport.tcp.TCPTransport.handleMessages(TCPTransport.java:535) &lt;br/&gt;
        at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run0(TCPTransport.java:790) &lt;br/&gt;
        at sun.rmi.transport.tcp.TCPTransport$ConnectionHandler.run(TCPTransport.java:649) &lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886) &lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908) &lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619) &lt;br/&gt;
$ &lt;/p&gt;


&lt;p&gt;Here is the test I ran above: &lt;/p&gt;

&lt;p&gt;import uuid &lt;/p&gt;

&lt;p&gt;from thrift import Thrift &lt;br/&gt;
from thrift.transport import TTransport &lt;br/&gt;
from thrift.transport import TSocket &lt;br/&gt;
from thrift.protocol.TBinaryProtocol import TBinaryProtocolAccelerated &lt;/p&gt;

&lt;p&gt;import sys &lt;br/&gt;
sys.path.insert(0,&apos;/usr/local/cassandra/interface/thrift/gen-py&apos;) &lt;/p&gt;

&lt;p&gt;from cassandra import Cassandra &lt;br/&gt;
from cassandra.ttypes import * &lt;/p&gt;

&lt;p&gt;socket = TSocket.TSocket(&quot;10.212.87.165&quot;, 9160) &lt;br/&gt;
transport = TTransport.TBufferedTransport(socket) &lt;br/&gt;
protocol = TBinaryProtocol.TBinaryProtocolAccelerated(transport) &lt;br/&gt;
client = Cassandra.Client(protocol) &lt;/p&gt;

&lt;p&gt;transport.open() &lt;/p&gt;

&lt;p&gt;ks = &quot;Keyspace1&quot; &lt;br/&gt;
cf = &quot;Super1&quot; &lt;br/&gt;
path = ColumnPath(cf, &quot;foo&quot;, &quot;is&quot;) &lt;br/&gt;
value = &quot;cool&quot; &lt;/p&gt;

&lt;p&gt;for i in xrange(10): &lt;br/&gt;
    key = uuid.uuid4().hex &lt;br/&gt;
    print &quot;insert&quot;, key &lt;br/&gt;
    client.insert(ks, key, path, value, 0, ConsistencyLevel.ONE) &lt;/p&gt;

&lt;p&gt;print &lt;/p&gt;

&lt;p&gt;parent = ColumnParent(column_family=cf) &lt;br/&gt;
slice_range = SliceRange(start=&quot;key&quot;, finish=&quot;key&quot;) &lt;br/&gt;
predicate = SlicePredicate(slice_range=slice_range) &lt;/p&gt;

&lt;p&gt;total_keys = 0 &lt;/p&gt;

&lt;p&gt;result = client.get_range_slice(ks, parent, predicate, &quot;&quot;, &quot;&quot;, 10, ConsistencyLevel.ONE) &lt;br/&gt;
for row in result: &lt;br/&gt;
    total_keys += 1 &lt;br/&gt;
    print &quot;result&quot;, row.key &lt;/p&gt;

&lt;p&gt;print &quot;total_keys&quot;, total_keys &lt;/p&gt;

</comment>
                            <comment id="12833889" author="jbellis" created="Mon, 15 Feb 2010 17:03:44 +0000"  >&lt;p&gt;Yes, it&apos;s more complicated than it looks. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Attached version fixes regression w/ result set size, and also start key when it falls into a wrapped node range.&lt;/p&gt;

&lt;p&gt;There&apos;s also a ton of debug logging if you turn that on in log4j, btw.&lt;/p&gt;</comment>
                            <comment id="12834016" author="bjc" created="Mon, 15 Feb 2010 23:18:12 +0000"  >&lt;p&gt;Victory!! I think this patch works. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;One last possible issue: if I remove keys, then do a get_range_slice(), they still show up. A get() on a removed key will return a &quot;not found&quot; exception. Should get_range_slice() be aware of the removal? I&apos;m guessing this is an issue about not properly processing the &quot;tombstone&quot;.&lt;/p&gt;

&lt;p&gt;Due to the complexity of get_range_slice(), maybe it&apos;s not worth processing the tombstone?&lt;/p&gt;</comment>
                            <comment id="12834042" author="jbellis" created="Tue, 16 Feb 2010 01:38:22 +0000"  >&lt;p&gt;right, for get_range_slice we changed the contract from get_key_range &amp;#8211; it can&apos;t tell the difference between &quot;this row has other data, but not data in the columns you requested&quot; and &quot;this row has been deleted entirely&quot; w/o a relatively expensive query, so we decided to just return the slice as-is.&lt;/p&gt;</comment>
                            <comment id="12834053" author="jbellis" created="Tue, 16 Feb 2010 02:48:32 +0000"  >&lt;p&gt;fix committed to trunk.  backport to 0.5 pending.&lt;/p&gt;</comment>
                            <comment id="12834886" author="hudson" created="Wed, 17 Feb 2010 17:54:46 +0000"  >&lt;p&gt;Integrated in Cassandra #357 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/357/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/357/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="12836603" author="herchu" created="Mon, 22 Feb 2010 12:46:34 +0000"  >&lt;p&gt;Is this fix going to be backported to 0.5? (any ETA?)&lt;br/&gt;
Thanks!&lt;/p&gt;</comment>
                            <comment id="12836612" author="jbellis" created="Mon, 22 Feb 2010 13:08:49 +0000"  >&lt;p&gt;Yes, that&apos;s at the top of my list.  (I&apos;ve been busy with PyCon.)&lt;/p&gt;</comment>
                            <comment id="12836616" author="herchu" created="Mon, 22 Feb 2010 13:20:59 +0000"  >&lt;p&gt;Great, thank you. The testcases for the current fix seem thorough, but if it helps I can do the testing with my own data as soon as a new patch is available.&lt;/p&gt;</comment>
                            <comment id="12836886" author="jbellis" created="Mon, 22 Feb 2010 20:38:23 +0000"  >&lt;p&gt;attached backport of fix to 0.5.&lt;/p&gt;</comment>
                            <comment id="12837242" author="herchu" created="Tue, 23 Feb 2010 14:04:09 +0000"  >&lt;p&gt;+1 to 781-backport.txt, it solved the problem in my cluster. Thank you!&lt;/p&gt;</comment>
                            <comment id="12837316" author="jbellis" created="Tue, 23 Feb 2010 17:06:05 +0000"  >&lt;p&gt;committed to 0.5, thanks for testing.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12436624" name="781-backport.txt" size="82956" author="jbellis" created="Mon, 22 Feb 2010 20:38:23 +0000"/>
                            <attachment id="12435887" name="781.txt" size="54632" author="jbellis" created="Mon, 15 Feb 2010 17:03:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19861</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 40 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g11b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91598</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>