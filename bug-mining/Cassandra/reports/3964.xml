<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10631] JSON Update not working with PreparedStatement</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10631</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When using PreparedStatement to insert and update a row with JSON the first &quot;INSERT INTO &lt;/p&gt;
{tablename} JSON ?&quot; statement works OK. But when calling it a second time with a changed value on a field the field is not updated. If I use a SimpleStatement instead (&quot;INSERT INTO {tablename}
&lt;p&gt; JSON &apos;&quot;&lt;ins&gt;json&lt;/ins&gt;&quot;&apos;&quot;) the modified field is updated as expected.&lt;/p&gt;

&lt;p&gt;Attaching a test project that shows the problem.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows 7, Datastax Java Driver 2.2.0-rc2&lt;/p&gt;</environment>
        <key id="12909485">CASSANDRA-10631</key>
            <summary>JSON Update not working with PreparedStatement</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="heka">Henrik Karlsson</reporter>
                        <labels>
                    </labels>
                <created>Sun, 1 Nov 2015 09:46:12 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:51 +0000</updated>
                            <resolved>Thu, 26 Nov 2015 09:25:52 +0000</resolved>
                                        <fixVersion>2.2.4</fixVersion>
                    <fixVersion>3.0.1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14985218" author="slebresne" created="Mon, 2 Nov 2015 13:42:06 +0000"  >&lt;p&gt;Not sure how this sneaked in, but we try to avoid re-parsing json values for every column in prepared statements but to do that, we store the parsed value in the &lt;tt&gt;Json.PreparedMarker&lt;/tt&gt; object which is unfortunately part of the prepared statement, and so this is reused by all execution (so concretely, all execution will use the first value and all following will be ignored).&lt;/p&gt;

&lt;p&gt;I was surprised our tests didn&apos;t caught that, but it seems to be because despite the fact that our unit do use prepared statements, they don&apos;t reuse them, the recreate a statement every time.&lt;/p&gt;

&lt;p&gt;So I&apos;ve pushed 2 commits to fix this &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/10631&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. The first one just modify the tests to reuse prepared statements (within a single test class). I see no reason not to do this and this does catch this bug trivially. The 2nd commit is the actual fix: I&apos;ve move the &quot;caching&quot; of the parsed Json object to &lt;tt&gt;QueryOptions&lt;/tt&gt;. It may not be absolute perfection, but it&apos;s the most logical place I can think of that is correct and don&apos;t require too much changes. &lt;/p&gt;</comment>
                            <comment id="14989365" author="slebresne" created="Wed, 4 Nov 2015 11:17:05 +0000"  >&lt;p&gt;The changes to &lt;tt&gt;CQLTester&lt;/tt&gt; actually exposed an unrelated bug: when a function is replaced, we were not invalidating statement using that function. And since we resolve functions at preparation time, this means the new function wasn&apos;t taken into account for statements prepared prior to the change. While this isn&apos;t really related to this issue, this does create unit test failure on this branch and the fix is pretty simple, so I included it in my branch above.&lt;/p&gt;

&lt;p&gt;Test results are here: &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-10631-testall/4/#showFailuresLink&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; and &lt;span class=&quot;error&quot;&gt;&amp;#91;dtesthttp://cassci.datastax.com/view/Dev/view/pcmanus/job/pcmanus-10631-dtest/lastCompletedBuild/testReport/|&amp;#93;&lt;/span&gt; (the dtests have a few more failures than the last 2.2 run I&apos;ve looked at. Nothing seems related to this so I suspect it&apos;s just flapping tests, but I&apos;ve re-started the dtest to see).&lt;/p&gt;</comment>
                            <comment id="14989508" author="slebresne" created="Wed, 4 Nov 2015 13:08:56 +0000"  >&lt;p&gt;Last &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-10631-dtest/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; run confirms this is on par with the 2.2 branch.&lt;/p&gt;</comment>
                            <comment id="15009071" author="thobbs" created="Tue, 17 Nov 2015 17:23:25 +0000"  >&lt;p&gt;Sorry for the slow response, I didn&apos;t realize I was reviewer on this one.  Can you rebase if necessary and also run tests against 3.0 and 3.1?&lt;/p&gt;

&lt;p&gt;EDIT: Other than that, +1 on the changes.&lt;/p&gt;</comment>
                            <comment id="15013401" author="slebresne" created="Thu, 19 Nov 2015 11:46:00 +0000"  >&lt;p&gt;I&apos;ve rebased and updated the patch for 3.0 (I&apos;m pretty certain there is no change in 3.1 that impact the same area so I&apos;ll just merge on commit):&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/10631-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/10631-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-10631-2.2-testall/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-10631-3.0-testall/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-10631-2.2-dtest/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-10631-3.0-dtest/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Results looks good except for the 3.0 unit tests which I&apos;ve restarted because I apparently picked a bad apple in my initial rebase on that branch so that there was some clearly unrelated failures.&lt;/p&gt;</comment>
                            <comment id="15014114" author="thobbs" created="Thu, 19 Nov 2015 18:37:15 +0000"  >&lt;p&gt;Hmm, the unit test failures on 3.0 appear to be legit, as 3.0 doesn&apos;t show the same problems without your patch (I checked locally).  I thought that perhaps the re-use of prepared statements was exposing an existing bug, but changing &lt;tt&gt;cassandra.test.reuse_prepared&lt;/tt&gt; to false doesn&apos;t seem to affect the failures.  However, setting &lt;tt&gt;cassandra.test.use_prepared&lt;/tt&gt; to false does fix the test failures.  Unfortunately, I don&apos;t have time to investigate further than that.&lt;/p&gt;</comment>
                            <comment id="15014117" author="slebresne" created="Thu, 19 Nov 2015 18:39:59 +0000"  >&lt;p&gt;Yeah, saw the unit test were still failing, sorry for not updating. It&apos;s really weird cause the test seems to fail due to an error message not being the one they expect, and the patch doesn&apos;t touch that message, but I&apos;ll try to have a closer look tomorrow.&lt;/p&gt;</comment>
                            <comment id="15024572" author="slebresne" created="Tue, 24 Nov 2015 14:12:47 +0000"  >&lt;p&gt;So, there were more bugs that the change to CQLTester (so prepared statements are reused) was triggering. The first one, I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10758&quot; title=&quot;Dropping an index does not invalidate prepared statements anymore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10758&quot;&gt;&lt;del&gt;CASSANDRA-10758&lt;/del&gt;&lt;/a&gt; for: fixing it is not trivial enough that I feel confident shoving it in that (unrelated) ticket. To work-around that ticket, I&apos;ve disabled the prepared statement reuse for the 2 class of tests that were failing otherwise (and I&apos;ll add a comment in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10768&quot; title=&quot;Optimize the way we check if a token is repaired in anticompaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10768&quot;&gt;&lt;del&gt;CASSANDRA-10768&lt;/del&gt;&lt;/a&gt; to remove that work-around).&lt;/p&gt;

&lt;p&gt;The 2nd problem was that the implementation of the &lt;tt&gt;DROP INDEX&lt;/tt&gt; statement was stateful: we were looking up the metadata for table for which the index is dropped and saving it in an instance field, reusing it afterwards. Except that it&apos;s during this lookup that we&apos;re throwing an exception if the index doesn&apos;t exists, so this saving the result of the lookup was breaking if a &lt;tt&gt;DROP INDEX&lt;/tt&gt; was prepared and reused. One could argue that preparing any schema related statement is borderline useless since you can&apos;t use bind marker anywhere (I guess you save parsing ...), but we actually don&apos;t disallow it and hence should probably fix that.  Now, the main reason for saving the result of that metadata lookup was due to the fact that we need that metadata when creating the &lt;tt&gt;Event.SchemaChange&lt;/tt&gt;, but by the time &lt;tt&gt;changeEvent()&lt;/tt&gt; is called, the index has been dropped and the lookup method would fail. Anyway, what that mean is that &lt;tt&gt;changeEvent&lt;/tt&gt; needed access to values that where only available in &lt;tt&gt;announceMigration&lt;/tt&gt; (there is a few other function related statement that saves stuffs in fields for the very same reason) and so I make the change of removing the &lt;tt&gt;changeEvent()&lt;/tt&gt; and making the event be the result of the &lt;tt&gt;announceMigration()&lt;/tt&gt; call. I happen to think it&apos;s cleaner that way anyway and the change is trivial, so I&apos;ve included a commit for this one.&lt;/p&gt;

&lt;p&gt;Only the 3.0 branch has new commits (there were no tests failure in 2.2 so I&apos;ve let it alone):&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/10631-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-10631-3.0-testall/4/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-10631-3.0-dtest/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The unit test had 2 failures but those are junit timeouts so I suspect this is just a case of being unluky. I&apos;ve restarted the job one more time to check however.&lt;/p&gt;</comment>
                            <comment id="15024719" author="slebresne" created="Tue, 24 Nov 2015 15:58:36 +0000"  >&lt;p&gt;The re-run of the unit test still had one failure but it&apos;s different from the previous run and is in &lt;tt&gt;testCompactionProgress&lt;/tt&gt; which almost surely don&apos;t go into any code changed by this patch, so I&apos;m confident we&apos;re good here.&lt;/p&gt;</comment>
                            <comment id="15027847" author="thobbs" created="Thu, 26 Nov 2015 00:09:15 +0000"  >&lt;p&gt;+1, with just a couple of minor typos to fix on commit:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&apos;cannot be found bu &quot;IF EXISTS&quot; is&apos; - in &lt;tt&gt;DropIndexStatement&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&apos;occured&apos; - in &lt;tt&gt;SchemaAlteringStatement&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15028415" author="slebresne" created="Thu, 26 Nov 2015 09:25:52 +0000"  >&lt;p&gt;Committed with typos fixed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12769983" name="test-json.zip" size="2684" author="heka" created="Sun, 1 Nov 2015 09:46:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 51 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2nsgv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333745">2.2.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>