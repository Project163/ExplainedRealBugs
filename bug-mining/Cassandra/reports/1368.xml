<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:28:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3641] inconsistent/corrupt counters w/ broken shards never converge</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3641</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We ran into a case (which MIGHT be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3070&quot; title=&quot;counter repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3070&quot;&gt;&lt;del&gt;CASSANDRA-3070&lt;/del&gt;&lt;/a&gt;) whereby we had counters that were corrupt (hopefully due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3178&quot; title=&quot;Counter shard merging is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3178&quot;&gt;&lt;del&gt;CASSANDRA-3178&lt;/del&gt;&lt;/a&gt;). The corruption was that there would exist shards with the &lt;b&gt;same&lt;/b&gt; node_id, &lt;b&gt;same&lt;/b&gt; clock id, but &lt;b&gt;different&lt;/b&gt; counts.&lt;/p&gt;

&lt;p&gt;The counter column diffing and reconciliation code assumes that this never happens, and ignores the count. The problem with this is that if there is an inconsistency, the result of a reconciliation will depend on the order of the shards.&lt;/p&gt;

&lt;p&gt;In our case for example, we would see the value of the counter randomly fluctuating on a CL.ALL read, but we would get consistent (whatever the node had) on CL.ONE (submitted to one of the nodes in the replica set for the key).&lt;/p&gt;

&lt;p&gt;In addition, read repair would not work despite digest mismatches because the diffing algorithm also did not care about the counts when determining the differences to send.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching patches that fixes this. The first patch is against our 0.8 branch, which is not terribly useful to people, but I include it because it is the well-tested version that we have used on the production cluster which was subject to this corruption.&lt;/p&gt;

&lt;p&gt;The other patch is against trunk, and contains the same change.&lt;/p&gt;

&lt;p&gt;What the patch does is:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;On diffing, treat as DISJOINT if there is a count discrepancy.&lt;/li&gt;
	&lt;li&gt;On reconciliation, look at the count and &lt;b&gt;deterministically&lt;/b&gt; pick the higher one, and:
	&lt;ul&gt;
		&lt;li&gt;log the fact that we detected a corrupt counter&lt;/li&gt;
		&lt;li&gt;increment a JMX observable counter for monitoring purposes&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;A cluster which is subject to such corruption and has this patch, will fix itself with and AES + compact (or just repeated compactions assuming the replicate-on-compact is able to deliver correctly).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12535364">CASSANDRA-3641</key>
            <summary>inconsistent/corrupt counters w/ broken shards never converge</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="scode">Peter Schuller</assignee>
                                    <reporter username="scode">Peter Schuller</reporter>
                        <labels>
                    </labels>
                <created>Thu, 15 Dec 2011 20:09:45 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:44 +0000</updated>
                            <resolved>Mon, 2 Jan 2012 17:21:34 +0000</resolved>
                                        <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13171380" author="scode" created="Sat, 17 Dec 2011 00:44:37 +0000"  >&lt;p&gt;Sorry, this depends on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3603&quot; title=&quot;CounterColumn and CounterContext use a log4j logger instead of using slf4j like the rest of the code base&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3603&quot;&gt;&lt;del&gt;CASSANDRA-3603&lt;/del&gt;&lt;/a&gt;. I&apos;ll submit the patch there in a minute.&lt;/p&gt;</comment>
                            <comment id="13172181" author="slebresne" created="Mon, 19 Dec 2011 10:47:00 +0000"  >&lt;p&gt;The fix lgtm, but I&apos;d be in favor of removing the JMX reporting. Logging at ERROR seems enough and I fear a JMX counter will confuse users more than anything else (you can always use a specific log4j logger if you&apos;re so inclined to monitor logged errors through JMX).&lt;/p&gt;

&lt;p&gt;Nit: I&apos;d also change the comment from &quot;We should never see shards w/ same id+clock but different counts&quot; to &quot;We should never see &lt;b&gt;non-delta&lt;/b&gt; shards w/ same id+clock but different counts&quot;, just to make sure someone reading this comment too quickly don&apos;t leave with the wrong info. &lt;/p&gt;</comment>
                            <comment id="13172436" author="scode" created="Mon, 19 Dec 2011 17:36:30 +0000"  >&lt;p&gt;I&apos;ll fix the comment (it was written before I understood fully the role of deltas).&lt;/p&gt;

&lt;p&gt;As for the JMX counter: I kind of see your concern, but at the same time - most people that have monitoring of Cassandra at all will have setups to easily monitor/graph/alert on JMX exposed values and I really think it&apos;s a shame if we can&apos;t add additional instrumentation because it would confuse users.&lt;/p&gt;

&lt;p&gt;How about putting it somewhere else, where it&apos;s clearly nothing you need to worry about normally? I actually had an original patch before I submitted upstream where I had created a separate MBean I called &quot;RedFlags&quot; because I found no good place to put the counter. The idea was that it felt completely overkill to have a dedicated MBean for the purpose, but at the same time I really wanted it accounted for. RedFlags was intended as a place to put counters that you essentially always expect to be exactly 0 during healthy production use.&lt;/p&gt;

&lt;p&gt;I could see putting more stuff there like exception counts in places where any exception indicates a sever problem, or a count of out of disk space conditions preventing or affecting (different bucket) compaction, or a count of GC pauses above a certain threshold, etc.&lt;/p&gt;

&lt;p&gt;If you agree I&apos;ll volunteer to go through and add some things I can think of, along with this count.&lt;/p&gt;

&lt;p&gt;Else I can certainly re-submit without the JMX counter. Or just submit a separate JIRA for it (but that&apos;s only worth it if you might be okay with a RedFlags style approach and it&apos;s not just this one counter).&lt;/p&gt;</comment>
                            <comment id="13173138" author="slebresne" created="Tue, 20 Dec 2011 12:19:08 +0000"  >&lt;p&gt;Let&apos;s open a separate ticket to discuss that. So far we&apos;ve use the log only for recording errors so let&apos;s keep it at that for this ticket.&lt;/p&gt;</comment>
                            <comment id="13175648" author="scode" created="Sat, 24 Dec 2011 03:15:08 +0000"  >&lt;p&gt;New version attached. Rebased to current trunk, and no JMX. Otherwise identical.&lt;/p&gt;</comment>
                            <comment id="13178470" author="slebresne" created="Mon, 2 Jan 2012 17:21:34 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12519835">CASSANDRA-3070</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12522749">CASSANDRA-3178</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12536328">CASSANDRA-3670</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12507575" name="3641-0.8-internal-not-for-inclusion.txt" size="6664" author="scode" created="Thu, 15 Dec 2011 20:12:19 +0000"/>
                            <attachment id="12507574" name="3641-trunk.txt" size="6731" author="scode" created="Thu, 15 Dec 2011 20:12:19 +0000"/>
                            <attachment id="12508582" name="CASSANDRA-3641-trunk-nojmx.txt" size="4068" author="scode" created="Sat, 24 Dec 2011 03:15:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[scode]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>221048</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 47 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gmfb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95063</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>