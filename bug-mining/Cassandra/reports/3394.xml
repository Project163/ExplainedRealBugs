<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8812] JVM Crashes on Windows x86</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8812</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Under Windows (32 or 64 bit) with the 32-bit Oracle JDK, the JVM may crash due to EXCEPTION_ACCESS_VIOLATION. This happens inconsistently. The attached test project can recreate the crash - sometimes it works successfully, sometimes there&apos;s a Java exception in the log, and sometimes the hotspot JVM crash shows up (regardless of whether the JUnit test results in success - you can ignore that). Run it a bunch of times to see the various outcomes. It also contains a sample hotspot error log.&lt;/p&gt;

&lt;p&gt;Note that both when the Java exception is thrown and when the JVM crashes, the stack trace is almost the same - they both eventually occur when the PERIODIC-COMMIT-LOG-SYNCER thread calls CommitLogSegment.sync and accesses the buffer (MappedByteBuffer): if it happens to be in buffer.force(), then the Java exception is thrown, and if it&apos;s in one of the buffer.put() calls before it, then the JVM crashes. This possibly exposes a JVM bug as well in this case. So it basically looks like a race condition which results in the buffer sometimes being used after it is no longer valid.&lt;/p&gt;

&lt;p&gt;I recreated this on a PC with Windows 7 64-bit running the 32-bit Oracle JDK, as well as on a modern.ie virtualbox image of Windows 7 32-bit running the JDK, and it happens both with JDK 7 and JDK 8. Also defining an explicit dependency on cassandra 2.1.2 (as opposed to the cassandra-unit dependency on 2.1.0) doesn&apos;t make a difference. At some point in my testing I&apos;ve also seen a Java-level exception on Linux, but I can&apos;t recreate it at the moment with this test project, so I can&apos;t guarantee it.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows 7 running x86(32-bit) Oracle JDK 1.8.0_u31&lt;/p&gt;</environment>
        <key id="12775363">CASSANDRA-8812</key>
            <summary>JVM Crashes on Windows x86</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="amichai">Amichai Rothman</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Feb 2015 13:17:55 +0000</created>
                <updated>Wed, 15 Oct 2025 09:48:59 +0000</updated>
                            <resolved>Fri, 15 May 2015 16:52:53 +0000</resolved>
                                        <fixVersion>2.1.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14323297" author="amichai" created="Mon, 16 Feb 2015 21:10:50 +0000"  >&lt;p&gt;I don&apos;t know if it&apos;s related or not, but it&apos;s suspicious that the segment&apos;s sync method in some cases closes itself without it being removed from its associated segment manager...&lt;/p&gt;</comment>
                            <comment id="14324051" author="benedict" created="Tue, 17 Feb 2015 10:59:59 +0000"  >&lt;p&gt;Do you have the Java exception thrown by buffer.force()?&lt;/p&gt;</comment>
                            <comment id="14324775" author="amichai" created="Tue, 17 Feb 2015 19:57:58 +0000"  >&lt;p&gt;Sure, I just ran it a few more times (with cassandra-all 2.1.2, if any of the line numbers changed) and got several of these:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2015-02-17 11:35:13,470 | PERIODIC-COMMIT-LOG-SYNCER | o.a.c.d.c.CommitLog | ERROR | CommitLog.java:367 | Failed to persist commits to disk. Commit disk failure policy is stop; terminating thread
org.apache.cassandra.io.FSWriteError: java.io.IOException: The handle is invalid
        at org.apache.cassandra.db.commitlog.CommitLogSegment.sync(CommitLogSegment.java:329) ~[cassandra-all-2.1.2.jar:2.1.2]
        at org.apache.cassandra.db.commitlog.CommitLog.sync(CommitLog.java:195)~[cassandra-all-2.1.2.jar:2.1.2]
        at org.apache.cassandra.db.commitlog.AbstractCommitLogService$1.run(AbstractCommitLogService.java:81) ~[cassandra-all-2.1.2.jar:2.1.2]
        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_31]
Caused by: java.io.IOException: The handle is invalid
        at java.nio.MappedByteBuffer.force0(Native Method) ~[na:1.8.0_31]
        at java.nio.MappedByteBuffer.force(MappedByteBuffer.java:203) ~[na:1.8.0_31]
        at org.apache.cassandra.db.commitlog.CommitLogSegment.sync(CommitLogSegment.java:315) ~[cassandra-all-2.1.2.jar:2.1.2]
... 3 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However in the past I also got exceptions with an exactly identical stack trace other than a different IOException message &quot;Attempt to access invalid address&quot; instead of &quot;The handle is invalid&quot;.&lt;/p&gt;</comment>
                            <comment id="14325844" author="benedict" created="Wed, 18 Feb 2015 13:20:53 +0000"  >&lt;p&gt;I suspect this is the bug. It looks like if the amount of utilised CL space exceeds the limit, we can close without ensuring all writes pending have finished or been synced IFF we are force discarding the segments. &lt;/p&gt;

&lt;p&gt;Since we mark the segments as clean and discard the tail of the segment, the isUnused() property returns true even if there are still writes modifying the segment or syncs pending. This would be fine ordinarily, because recycle calls sync() which ensures any pending writes and sync complete first, however if we&apos;re exceeding the allocated space, we skip this step and just immediately close (and delete) the file. The simplest solution is to ensure that close() prevents any future sync() from doing any work, and also ensures any pending writes to the file/buffer complete before closing it.&lt;/p&gt;</comment>
                            <comment id="14326296" author="jmckenzie" created="Wed, 18 Feb 2015 18:17:36 +0000"  >&lt;p&gt;Seems a reasonable hypothesis and code LGTM - &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amichai&quot; class=&quot;user-hover&quot; rel=&quot;amichai&quot;&gt;amichai&lt;/a&gt;: any chance you could try to reproduce the problem with a build using the attached patch?&lt;/p&gt;</comment>
                            <comment id="14326853" author="amichai" created="Thu, 19 Feb 2015 01:19:00 +0000"  >&lt;p&gt;I ran a build from the 2.1.2 tag and recreated the exceptions and JVM crash, then applied the attached patch, rebuilt and ran it quite a few more times and was unable to reproduce them again, so the patch seems to fix the issue.&lt;/p&gt;

&lt;p&gt;I still get occasional failures (which were there before the patch as well) due to what looks like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8390&quot; title=&quot;The process cannot access the file because it is being used by another process&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8390&quot;&gt;&lt;del&gt;CASSANDRA-8390&lt;/del&gt;&lt;/a&gt;, but that&apos;s a separate issue.&lt;/p&gt;

&lt;p&gt;Thanks guys for the quick solution!&lt;/p&gt;</comment>
                            <comment id="14535855" author="aweisberg" created="Fri, 8 May 2015 23:19:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; &lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I suspect this is the bug. It looks like if the amount of utilised CL space exceeds the limit, we can close without ensuring all writes pending have finished or been synced IFF we are force discarding the segments.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Is this a scenario we want to create as part of some other test? Also no regression test?&lt;/p&gt;</comment>
                            <comment id="14536324" author="benedict" created="Sat, 9 May 2015 09:50:10 +0000"  >&lt;p&gt;Somehow missed this in the retrospective. This should be caught by the kitchen sink tests, since it requires a lot of concurrent work in parallel to schema changes (DROP TABLE), but it could do with its own regression test as well. Reopening for that.&lt;/p&gt;</comment>
                            <comment id="14538050" author="aweisberg" created="Mon, 11 May 2015 15:28:44 +0000"  >&lt;p&gt;Can you capture what has to be done as part of the kitchen sink in the &lt;a href=&quot;https://docs.google.com/document/d/1kccPqxEAoYQpT0gXnp20MYQUDmjOrakAeQhf6vkqjGo/edit#heading=h.zd5nw0kl2ypi&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;kitchen sink doc &lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14538505" author="benedict" created="Mon, 11 May 2015 19:37:36 +0000"  >&lt;p&gt;Sure, I&apos;ve updated the doc. It should be caught by one of the most basic concepts of the kitchen sink tests (i.e. stress workload with parallel schema changes), though, so I very much hope it&apos;s only needed as a corroborative double-check.&lt;/p&gt;</comment>
                            <comment id="14545777" author="iamaleksey" created="Fri, 15 May 2015 16:52:41 +0000"  >&lt;p&gt;I&apos;m assuming that this was reopened by accident. Either way, since the patch made it into 2.1.5, if the issue is still real, a new ticket should be opened instead of reopening one.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12699470" name="8812.txt" size="1006" author="benedict" created="Wed, 18 Feb 2015 13:20:53 +0000"/>
                            <attachment id="12699099" name="crashtest.tgz" size="8148" author="amichai" created="Mon, 16 Feb 2015 13:17:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 27 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25ofr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>joshuamckenzie</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[joshuamckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>