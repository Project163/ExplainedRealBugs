<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8087] Multiple non-DISTINCT rows returned when page_size set</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8087</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Using the following statements to reproduce:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE test (
                k &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
                p &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
                s &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;,
                PRIMARY KEY (k, p)
            );
INSERT INTO test (k, p) VALUES (1, 1);
INSERT INTO test (k, p) VALUES (1, 2);
SELECT DISTINCT k, s FROM test ;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Native clients that set result_page_size in the query message receive multiple non-distinct rows back (one per clustered value p in row k).&lt;/p&gt;

&lt;p&gt;This is only reproduced on 2.0.10. Does not appear in 2.1.0&lt;/p&gt;

&lt;p&gt;It does not appear in cqlsh for 2.0.10 because thrift.&lt;/p&gt;

&lt;p&gt;See &lt;a href=&quot;https://datastax-oss.atlassian.net/browse/PYTHON-164&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://datastax-oss.atlassian.net/browse/PYTHON-164&lt;/a&gt; for background&lt;/p&gt;</description>
                <environment></environment>
        <key id="12746828">CASSANDRA-8087</key>
            <summary>Multiple non-DISTINCT rows returned when page_size set</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="aholmber">Adam Holmberg</reporter>
                        <labels>
                            <label>qa-resolved</label>
                    </labels>
                <created>Wed, 8 Oct 2014 21:22:00 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:31 +0000</updated>
                            <resolved>Fri, 19 Dec 2014 18:31:13 +0000</resolved>
                                        <fixVersion>2.0.12</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14172568" author="philipthompson" created="Wed, 15 Oct 2014 16:43:04 +0000"  >&lt;p&gt;This is causing the dtest cql_tests:TestCQL.static_columns_with_distinct_test to fail.&lt;/p&gt;</comment>
                            <comment id="14173186" author="thobbs" created="Thu, 16 Oct 2014 00:43:28 +0000"  >&lt;p&gt;One of the fixes in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8108&quot; title=&quot;Errors paging DISTINCT queries on static columns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8108&quot;&gt;&lt;del&gt;CASSANDRA-8108&lt;/del&gt;&lt;/a&gt; resolves this, so I&apos;m marking this as a duplicate.&lt;/p&gt;</comment>
                            <comment id="14188470" author="philipthompson" created="Wed, 29 Oct 2014 15:43:13 +0000"  >&lt;p&gt;The test is still failing with the same problem, despite &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8108&quot; title=&quot;Errors paging DISTINCT queries on static columns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8108&quot;&gt;&lt;del&gt;CASSANDRA-8108&lt;/del&gt;&lt;/a&gt; being marked as resolved. We aren&apos;t seeing the issue in 2.1.1.&lt;/p&gt;</comment>
                            <comment id="14192380" author="thobbs" created="Fri, 31 Oct 2014 20:11:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=philipthompson&quot; class=&quot;user-hover&quot; rel=&quot;philipthompson&quot;&gt;philipthompson&lt;/a&gt; hmm, it doesn&apos;t reproduce for me with the latest 2.0.  Can you confirm and see what&apos;s different with Jenkins?&lt;/p&gt;</comment>
                            <comment id="14195137" author="philipthompson" created="Mon, 3 Nov 2014 21:32:10 +0000"  >&lt;p&gt;I can reproduce locally and on Jenkins on 2.0-HEAD that the test is failing with multiple rows being returned.&lt;/p&gt;</comment>
                            <comment id="14226785" author="thobbs" created="Wed, 26 Nov 2014 20:33:37 +0000"  >&lt;p&gt;The root of the problem ended up being &lt;tt&gt;countCQL3&lt;/tt&gt; rows erroneously being set to true in PagedRangeCommand because the logic in &lt;tt&gt;PagedRangeCommand.countCQL3Rows()&lt;/tt&gt; didn&apos;t handle the DISTINCT with static columns case.  In 2.1 this isn&apos;t a problem because we serialize &lt;tt&gt;countCQL3Rows&lt;/tt&gt; as part of the message.&lt;/p&gt;

&lt;p&gt;The attached patch attempts to update the &lt;tt&gt;PagedRangeCommand.countCQL3Rows()&lt;/tt&gt; logic to handle DISTINCT with statics.  I believe this logic is safe, but I&apos;m not 100% sure.  (It doesn&apos;t seem to cause any regressions in the tests.)  The patch also adds a bit of documentation and some toStrings() to clarify things that were confusing to me when debugging.&lt;/p&gt;

&lt;p&gt;Last, the patch fixes an overcounting problem in &lt;tt&gt;SliceQueryFilter.lastCounted()&lt;/tt&gt;.  This fix ended up not being required for this ticket, but I figured that it&apos;s good to prevent a possible future bug.  The overcounting happens because in &lt;tt&gt;SliceQueryFilter.collectReducedColumns()&lt;/tt&gt;, we have to call &lt;tt&gt;columnCounter.count()&lt;/tt&gt; &lt;em&gt;before&lt;/em&gt; adding cells to the container, and we only break once the count &lt;em&gt;exceeds&lt;/em&gt; the limit.  So, if we exceed the limit, the counter will have overcounted by one.  In practice, this doesn&apos;t seem to cause any problems (due to the conditions under which &lt;tt&gt;collectionReducedColumns()&lt;/tt&gt; is called and when we set a limit on the slice), but it&apos;s definitely erroneous.&lt;/p&gt;

&lt;p&gt;I also extended the failing dtest here: &lt;a href=&quot;https://github.com/thobbs/cassandra-dtest/tree/CASSANDRA-8087&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/thobbs/cassandra-dtest/tree/CASSANDRA-8087&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14251871" author="slebresne" created="Thu, 18 Dec 2014 16:27:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;I believe this logic is safe, but I&apos;m not 100% sure.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it works, but can be simplified. That is, I don&apos;t really think the fact that the table has some statics plays a role in deciding if it&apos;s a distinct or not. However, I believe we can just have &lt;tt&gt;countCQL3Rows&lt;/tt&gt; be&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public boolean countCQL3Rows()
{
    return ((SliceQueryFilter)predicate).count != 1;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;because:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;unless it&apos;s a &lt;tt&gt;DISTINCT&lt;/tt&gt; query, the slice filter count is the &lt;tt&gt;LIMIT&lt;/tt&gt; of the query&lt;/li&gt;
	&lt;li&gt;we don&apos;t modify that count in that code path. We do update the slice count in &lt;tt&gt;SliceQueryPager&lt;/tt&gt; but not in &lt;tt&gt;RangeSliceQueryPager&lt;/tt&gt;. Not sure why though, and I think that can make us fetch more than we should so it might be kind of a bug.&lt;/li&gt;
	&lt;li&gt;we don&apos;t page queries in the first place if their &lt;tt&gt;LIMIT &amp;lt;= pageSize&lt;/tt&gt; and so we&apos;ll never page a query with a limit of 1.&lt;/li&gt;
	&lt;li&gt;it follows that only distinct can have 1 for the slice count in that method.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14252204" author="thobbs" created="Thu, 18 Dec 2014 20:36:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;We do update the slice count in SliceQueryPager but not in RangeSliceQueryPager. Not sure why though, and I think that can make us fetch more than we should so it might be kind of a bug.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think the current behavior is okay (although it&apos;s hard to follow).  AbstractQueryPager updates the page size (taking &quot;remaining&quot; into account) before calling queryNextPage().  The new page size is used as the limit for the new PagedRangeCommand.  It then gets passed to CFS.makeExtendedFilter(), which makes an ExtendedFilter with maxResults as the limit.  When countCQL3Rows is true, this is used as the column (cql3 row) limit.&lt;/p&gt;</comment>
                            <comment id="14252572" author="thobbs" created="Thu, 18 Dec 2014 23:50:04 +0000"  >&lt;p&gt;8087-2.0-v2.txt simplifies the logic as suggested.&lt;/p&gt;</comment>
                            <comment id="14253305" author="slebresne" created="Fri, 19 Dec 2014 11:36:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;It then gets passed to CFS.makeExtendedFilter(), which makes an ExtendedFilter with maxResults as the limit.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, but what I mean is that when we actually query the underlying partition, the slice filter count might be a lot more than what we care for (it could be Integer.MAX_VALUE if there wasn&apos;t any LIMIT on the statement in the first place) and if that&apos;s the case, we will read a lot more than we should.  This will be only true for the first partition, because after that we will update the SliceQueryFilter at the end of the loop of &lt;tt&gt;CFS.filter()&lt;/tt&gt;, but still, it&apos;s potentially inefficient for that that first partition and might even end up blowing up the heap if the partition is big, which defeats the purpose of paging. I&apos;ll note that provided we don&apos;t blow up the heap then the resultSet returned to the user will be fine since we&apos;ll trim it in SelectStatement, but it&apos;s still a bug (provided I&apos;m not missing something).&lt;/p&gt;

&lt;p&gt;Anyway, this is unrelated to this issue, and even if we fix it we can make sure to never set that count to 1 to not break the fix of this issue. So +1 on the patch.&lt;/p&gt;</comment>
                            <comment id="14253742" author="thobbs" created="Fri, 19 Dec 2014 18:31:13 +0000"  >&lt;p&gt;Thanks, committed as 2acbab6 and opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8521&quot; title=&quot;RangeSliceQueryPager may fetch too much data in the first partition&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8521&quot;&gt;&lt;del&gt;CASSANDRA-8521&lt;/del&gt;&lt;/a&gt; to fix the RangeSliceQueryPager problem.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12747641">CASSANDRA-8108</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12688181" name="8087-2.0-v2.txt" size="10690" author="thobbs" created="Thu, 18 Dec 2014 23:50:04 +0000"/>
                            <attachment id="12683914" name="8087-2.0.txt" size="11154" author="thobbs" created="Wed, 26 Nov 2014 20:33:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20yd3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326830">2.0.9</customfieldvalue>
    <customfieldvalue id="12327164">2.0.10</customfieldvalue>
    <customfieldvalue id="12327942">2.0.11</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326830">2.0.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>philipthompson</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>