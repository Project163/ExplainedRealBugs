<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12098] dtest failure in secondary_indexes_test.TestSecondaryIndexes.test_only_coordinator_chooses_index_for_query</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12098</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;example failure:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/trunk_offheap_dtest/273/testReport/secondary_indexes_test/TestSecondaryIndexes/test_only_coordinator_chooses_index_for_query&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/trunk_offheap_dtest/273/testReport/secondary_indexes_test/TestSecondaryIndexes/test_only_coordinator_chooses_index_for_query&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Failed on CassCI build trunk_offheap_dtest #273&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Standard Output

Unexpected error in node1 log, error: 
ERROR [MessagingService-Incoming-/127.0.0.3] 2016-06-26 08:11:32,185 CassandraDaemon.java:219 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MessagingService-Incoming-/127.0.0.3,5,main]
java.lang.RuntimeException: Unknown column b during deserialization
	at org.apache.cassandra.db.Columns$Serializer.deserialize(Columns.java:433) ~[main/:na]
	at org.apache.cassandra.db.SerializationHeader$Serializer.deserializeForMessaging(SerializationHeader.java:407) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.deserializeHeader(UnfilteredRowIteratorSerializer.java:192) ~[main/:na]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize30(PartitionUpdate.java:668) ~[main/:na]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize(PartitionUpdate.java:642) ~[main/:na]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:349) ~[main/:na]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:368) ~[main/:na]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:305) ~[main/:na]
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:114) ~[main/:na]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:190) ~[main/:na]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:178) ~[main/:na]
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:92) ~[main/:na]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12983834">CASSANDRA-12098</key>
            <summary>dtest failure in secondary_indexes_test.TestSecondaryIndexes.test_only_coordinator_chooses_index_for_query</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="sean.mccarthy">Sean McCarthy</reporter>
                        <labels>
                            <label>dtest</label>
                    </labels>
                <created>Mon, 27 Jun 2016 15:54:19 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:28 +0000</updated>
                            <resolved>Wed, 6 Jul 2016 11:20:06 +0000</resolved>
                                        <fixVersion>3.0.9</fixVersion>
                    <fixVersion>3.8</fixVersion>
                                    <component>Feature/2i Index</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15359400" author="beobal" created="Fri, 1 Jul 2016 18:12:53 +0000"  >&lt;p&gt;I&apos;m going to say that this is unrelated to the actual area under test (i.e. the index functionality) because the error in the log is a) symptomatic of a schema mismatch on the base table b) occurring during the initial data setup, not the main test code. &lt;/p&gt;

&lt;p&gt;This specific failure is the only instance in the available history of both the offheap (where this isolated failure occurred) and the main dtest jobs. Given that, I&apos;m hesitant to just mark it as flakey. I also failed to repro in 100 iterations on either job (&lt;a href=&quot;https://cassci.datastax.com/view/Parameterized/job/parameterized_dtest_multiplexer/156/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;onheap&lt;/a&gt;, &lt;a href=&quot;https://cassci.datastax.com/view/Parameterized/job/parameterized_dtest_multiplexer/158/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;offheap&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;There have been are some other failures on the offheap jobs recently, so I&apos;ll spend a bit of time digging there and also go over the attached logs again.&lt;/p&gt;</comment>
                            <comment id="15362774" author="beobal" created="Tue, 5 Jul 2016 16:58:37 +0000"  >&lt;p&gt;What appears to have happened here is another race during schema update. From &lt;tt&gt;node1_debug.log&lt;/tt&gt; we can see that the schema update to add &lt;tt&gt;b_index&lt;/tt&gt; is being processed directly before the attempted deserialization of the mutation which causes the test failure (&lt;tt&gt;2016-06-26 08:11:32,179&lt;/tt&gt;). This involves a call to &lt;tt&gt;apply(CFMetadata)&lt;/tt&gt; on the existing &lt;tt&gt;CFMetaData&lt;/tt&gt; for the table obtained from &lt;tt&gt;Schema.instance&lt;/tt&gt;. The problem lies in &lt;tt&gt;CFMetaData::rebuild()&lt;/tt&gt; called during &lt;tt&gt;apply&lt;/tt&gt;, as therein exists a window where the &lt;tt&gt;columnMetadata&lt;/tt&gt; map does not contain all of the &lt;tt&gt;name -&amp;gt; ColumnDefinition&lt;/tt&gt; mappings for the table. &lt;/p&gt;

&lt;p&gt;It appears that the deserialization of the mutation message occurs during this window. The &lt;tt&gt;cfId&lt;/tt&gt; is first read from the wire, then used to fetch the &lt;tt&gt;CFMetaData&lt;/tt&gt; from &lt;tt&gt;Schema.instance&lt;/tt&gt; (this will be the same instance as is being mutated by the migration thread). Down the line, this is then used for lookups in &lt;tt&gt;Columns.Serializer&lt;/tt&gt; when deserializing the &lt;tt&gt;SerializationHeader&lt;/tt&gt;. This lookup seems to have occurred precisely between &lt;tt&gt;columnMetadata&lt;/tt&gt; being cleared and repopulated, resulting in the unknown column error. &lt;/p&gt;

&lt;p&gt;The real solution is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9425&quot; title=&quot;Make node-local schema fully immutable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9425&quot;&gt;&lt;del&gt;CASSANDRA-9425&lt;/del&gt;&lt;/a&gt;, but in the meantime I believe it is safe to make &lt;tt&gt;columnMetadata&lt;/tt&gt; non-final &amp;amp; volatile and swap in a fresh map during rebuild. The only places that the map is actually mutated is in schema alterting statements where the new &lt;tt&gt;CFMetaData&lt;/tt&gt; is constructed . &lt;/p&gt;

&lt;p&gt;I&apos;ve pushed branches with that change &amp;amp; CI is pending:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/12098-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12098-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12098-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12098-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/12098-3.9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12098-3.9&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12098-3.9-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12098-3.9-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/12098-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12098-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12098-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-12098-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15362825" author="iamaleksey" created="Tue, 5 Jul 2016 17:30:03 +0000"  >&lt;p&gt;Yes, this should be safe. LGTM.&lt;/p&gt;

&lt;p&gt;nit: no need to be clever here with &lt;tt&gt;HashMap&lt;/tt&gt; constructor, and the logic is not exactly right. Just use &lt;tt&gt;Maps::newHashMapWithExpectedSize()&lt;/tt&gt; if you really want to avoid resizing, though. But I wouldn&apos;t bother.&lt;/p&gt;</comment>
                            <comment id="15364155" author="beobal" created="Wed, 6 Jul 2016 11:20:06 +0000"  >&lt;p&gt;Thanks, committed (using the default HashMap constructor) to 3.0/3.9/trunk in &lt;tt&gt;dd05e46f0cb5475edf72676230474e0ad0f9cdbf&lt;/tt&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12813774" name="node1.log" size="38311" author="sean.mccarthy" created="Mon, 27 Jun 2016 15:54:19 +0000"/>
                            <attachment id="12813772" name="node1_debug.log" size="218569" author="sean.mccarthy" created="Mon, 27 Jun 2016 15:54:19 +0000"/>
                            <attachment id="12813773" name="node1_gc.log" size="42602" author="sean.mccarthy" created="Mon, 27 Jun 2016 15:54:19 +0000"/>
                            <attachment id="12813777" name="node2.log" size="36435" author="sean.mccarthy" created="Mon, 27 Jun 2016 15:54:19 +0000"/>
                            <attachment id="12813775" name="node2_debug.log" size="209510" author="sean.mccarthy" created="Mon, 27 Jun 2016 15:54:19 +0000"/>
                            <attachment id="12813776" name="node2_gc.log" size="39576" author="sean.mccarthy" created="Mon, 27 Jun 2016 15:54:19 +0000"/>
                            <attachment id="12813780" name="node3.log" size="40240" author="sean.mccarthy" created="Mon, 27 Jun 2016 15:54:19 +0000"/>
                            <attachment id="12813778" name="node3_debug.log" size="198786" author="sean.mccarthy" created="Mon, 27 Jun 2016 15:54:19 +0000"/>
                            <attachment id="12813779" name="node3_gc.log" size="40185" author="sean.mccarthy" created="Mon, 27 Jun 2016 15:54:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3070n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>