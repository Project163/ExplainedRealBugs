<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:23:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3203] Odd flush behavior</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3203</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Given the same workload against 0.8, trunk is creating more than twice the amount of sstables.  Even though a uniform stress workload is being generated, flush size degrades quickly:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO [NonPeriodicTasks:1] 2011-09-09 18:24:22,878 ColumnFamilyStore.java (line 658) Enqueuing flush of Memtable-Standard1@2058235391(7741
035/110172631 serialized/live bytes, 151785 ops)
 INFO [NonPeriodicTasks:1] 2011-09-09 18:24:24,888 ColumnFamilyStore.java (line 658) Enqueuing flush of Memtable-Standard1@1520390052(3887
220/72403158 serialized/live bytes, 76220 ops)
 INFO [NonPeriodicTasks:1] 2011-09-09 18:24:26,890 ColumnFamilyStore.java (line 658) Enqueuing flush of Memtable-Standard1@1868496516(4097
085/76255481 serialized/live bytes, 80335 ops)
 INFO [NonPeriodicTasks:1] 2011-09-09 18:24:28,893 ColumnFamilyStore.java (line 658) Enqueuing flush of Memtable-Standard1@498232521(43513
20/80922269 serialized/live bytes, 85320 ops)
 INFO [NonPeriodicTasks:1] 2011-09-09 18:24:29,895 ColumnFamilyStore.java (line 658) Enqueuing flush of Memtable-Standard1@1592308290(2310
810/44514839 serialized/live bytes, 45310 ops)
 INFO [NonPeriodicTasks:1] 2011-09-09 18:24:30,897 ColumnFamilyStore.java (line 658) Enqueuing flush of Memtable-Standard1@775439677(22684
80/64984390 serialized/live bytes, 44480 ops)
 INFO [NonPeriodicTasks:1] 2011-09-09 18:24:31,899 ColumnFamilyStore.java (line 658) Enqueuing flush of Memtable-Standard1@928217914(26741
85/76231422 serialized/live bytes, 52435 ops)
 INFO [NonPeriodicTasks:1] 2011-09-09 18:24:32,901 ColumnFamilyStore.java (line 658) Enqueuing flush of Memtable-Standard1@158103119(27511
95/77317732 serialized/live bytes, 53945 ops)
 INFO [NonPeriodicTasks:1] 2011-09-09 18:24:33,903 ColumnFamilyStore.java (line 658) Enqueuing flush of Memtable-Standard1@2035169258(3132
420/88934701 serialized/live bytes, 61420 ops)
 INFO [NonPeriodicTasks:1] 2011-09-09 18:24:34,905 ColumnFamilyStore.java (line 658) Enqueuing flush of Memtable-Standard1@1097314626(2979
675/83651699 serialized/live bytes, 58425 ops)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The serialized to live size ratio appears completely out of whack.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12522964">CASSANDRA-3203</key>
            <summary>Odd flush behavior</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Tue, 13 Sep 2011 21:49:01 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:51 +0000</updated>
                            <resolved>Wed, 14 Sep 2011 23:09:04 +0000</resolved>
                                        <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13104124" author="brandon.williams" created="Wed, 14 Sep 2011 00:56:03 +0000"  >&lt;p&gt;Here is what I&apos;ve noticed:&lt;/p&gt;

&lt;p&gt;Things proceed normally for a while:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO 00:50:16,801 Enqueuing flush of Memtable-Standard1@304913075(36443580/45554475 serialized/live bytes, 714580 ops)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Eventually, something bad happens:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO 00:51:00,001 flushing high-traffic column family ColumnFamilyStore(table=&apos;Keyspace1&apos;, columnFamily=&apos;Counter1&apos;) (estimated 0 bytes)
 INFO 00:51:00,002 flushing high-traffic column family ColumnFamilyStore(table=&apos;Keyspace1&apos;, columnFamily=&apos;Super1&apos;) (estimated 0 bytes)
 INFO 00:51:00,002 flushing high-traffic column family ColumnFamilyStore(table=&apos;Keyspace1&apos;, columnFamily=&apos;SuperCounter1&apos;) (estimated 0 bytes)
 INFO 00:51:00,002 flushing high-traffic column family ColumnFamilyStore(table=&apos;Keyspace1&apos;, columnFamily=&apos;Standard1&apos;) (estimated 88291581 bytes)
 INFO 00:51:00,004 Enqueuing flush of Memtable-Standard1@741697653(2646900/88291581 serialized/live bytes, 51900 ops)
 INFO 00:51:00,004 flushing high-traffic column family ColumnFamilyStore(table=&apos;system&apos;, columnFamily=&apos;NodeIdInfo&apos;) (estimated 0 bytes)
 INFO 00:51:00,004 flushing high-traffic column family ColumnFamilyStore(table=&apos;system&apos;, columnFamily=&apos;IndexInfo&apos;) (estimated 0 bytes)
 INFO 00:51:00,004 flushing high-traffic column family ColumnFamilyStore(table=&apos;system&apos;, columnFamily=&apos;LocationInfo&apos;) (estimated 87 bytes)
 INFO 00:51:00,005 Enqueuing flush of Memtable-LocationInfo@1706933590(70/87 serialized/live bytes, 2 ops)
 INFO 00:51:00,005 flushing high-traffic column family ColumnFamilyStore(table=&apos;system&apos;, columnFamily=&apos;Migrations&apos;) (estimated 0 bytes)
 INFO 00:51:00,006 flushing high-traffic column family ColumnFamilyStore(table=&apos;system&apos;, columnFamily=&apos;HintsColumnFamily&apos;) (estimated 0 bytes)
 INFO 00:51:00,006 flushing high-traffic column family ColumnFamilyStore(table=&apos;system&apos;, columnFamily=&apos;Schema&apos;) (estimated 0 bytes)
 INFO 00:51:00,006 estimated 0 bytes used by all memtables pre-flush
 INFO 00:51:00,008 flushing ColumnFamilyStore(table=&apos;Keyspace1&apos;, columnFamily=&apos;Standard1&apos;) to free up 459320 bytes
 INFO 00:51:00,009 Enqueuing flush of Memtable-Standard1@456936648(14280/476332 serialized/live bytes, 280 ops)
 INFO 00:51:00,010 flushing ColumnFamilyStore(table=&apos;system&apos;, columnFamily=&apos;Schema&apos;) to free up 0 bytes
 INFO 00:51:00,010 flushing ColumnFamilyStore(table=&apos;system&apos;, columnFamily=&apos;HintsColumnFamily&apos;) to free up 0 bytes
 INFO 00:51:00,011 flushing ColumnFamilyStore(table=&apos;system&apos;, columnFamily=&apos;Migrations&apos;) to free up 0 bytes
 INFO 00:51:00,011 flushing ColumnFamilyStore(table=&apos;system&apos;, columnFamily=&apos;LocationInfo&apos;) to free up 0 bytes
 INFO 00:51:00,012 flushing ColumnFamilyStore(table=&apos;system&apos;, columnFamily=&apos;IndexInfo&apos;) to free up 0 bytes
 INFO 00:51:00,013 flushing ColumnFamilyStore(table=&apos;system&apos;, columnFamily=&apos;NodeIdInfo&apos;) to free up 0 bytes
 INFO 00:51:00,013 flushing ColumnFamilyStore(table=&apos;Keyspace1&apos;, columnFamily=&apos;SuperCounter1&apos;) to free up 0 bytes
 INFO 00:51:00,014 flushing ColumnFamilyStore(table=&apos;Keyspace1&apos;, columnFamily=&apos;Super1&apos;) to free up 0 bytes
 INFO 00:51:00,014 flushing ColumnFamilyStore(table=&apos;Keyspace1&apos;, columnFamily=&apos;Counter1&apos;) to free up 0 bytes
 INFO 00:51:01,016 flushing high-traffic column family ColumnFamilyStore(table=&apos;Keyspace1&apos;, columnFamily=&apos;Counter1&apos;) (estimated 0 bytes)
 INFO 00:51:01,016 flushing high-traffic column family ColumnFamilyStore(table=&apos;Keyspace1&apos;, columnFamily=&apos;Super1&apos;) (estimated 0 bytes)
 INFO 00:51:01,016 flushing high-traffic column family ColumnFamilyStore(table=&apos;Keyspace1&apos;, columnFamily=&apos;SuperCounter1&apos;) (estimated 0 bytes)
 INFO 00:51:01,016 flushing high-traffic column family ColumnFamilyStore(table=&apos;Keyspace1&apos;, columnFamily=&apos;Standard1&apos;) (estimated 83808954 bytes)
 INFO 00:51:01,017 Enqueuing flush of Memtable-Standard1@911886300(2512770/83817460 serialized/live bytes, 49270 ops)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After this point, it stays bad:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO 00:51:01,879 Enqueuing flush of Memtable-Standard1@937412989(2670870/96531021 serialized/live bytes, 52370 ops)
 INFO 00:51:02,029 Enqueuing flush of Memtable-Standard1@282282499(2668065/88997573 serialized/live bytes, 52315 ops)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13104243" author="jbellis" created="Wed, 14 Sep 2011 04:32:14 +0000"  >&lt;p&gt;patch that fixes two problems:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;removes double-counting of ByteBuffer overhead in jamm 0.2.4&lt;/li&gt;
	&lt;li&gt;removes 25% fudge factor that is no longer useful with Slab allocation&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;That still leaves us with at least one other problem, though.&lt;/p&gt;</comment>
                            <comment id="13104258" author="brandon.williams" created="Wed, 14 Sep 2011 05:19:45 +0000"  >&lt;p&gt;Something strange is going on here, as this patch actually exacerbated the problem slightly.&lt;/p&gt;</comment>
                            <comment id="13104856" author="jbellis" created="Wed, 14 Sep 2011 20:30:26 +0000"  >&lt;p&gt;v2 attached:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fixed-better version of jamm 0.2.5 (now just includes buffer.remaining() + shallow overhead)&lt;/li&gt;
	&lt;li&gt;pre-adds the CFMetadata object to the &quot;seen&quot; set for MemoryMeter so we don&apos;t re-count it for each row &lt;span class=&quot;error&quot;&gt;&amp;#91;this is the big one&amp;#93;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;m getting liveRatio of 4-6 now which makes me wonder if we need to add a higher fudge factor to make it not OOM again. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13104883" author="brandon.williams" created="Wed, 14 Sep 2011 21:17:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m getting liveRatio of 4-6 now which makes me wonder if we need to add a higher fudge factor to make it not OOM again. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I couldn&apos;t OOM it, and I get much more consistent flush behavior now, even better than before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1610&quot; title=&quot;Pluggable Compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1610&quot;&gt;&lt;del&gt;CASSANDRA-1610&lt;/del&gt;&lt;/a&gt; which inadvertently caused the re-counting.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13104985" author="jbellis" created="Wed, 14 Sep 2011 23:09:04 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13105047" author="brandon.williams" created="Thu, 15 Sep 2011 01:21:23 +0000"  >&lt;p&gt;Here&apos;s what jconsole looks like with with a 1G heap receiving 100M inserts from stress.  Analysis of the heap indicates the memory decrease is due to bloom filters and index sampling, so I think we&apos;re safe without a fudge factor, especially since the fudge factor predated the SlabAllocator.  The points where the heap did hit ~75%, the GCI pressure valve did a good job in combination with CMS of dropping the usage back down before there was any danger.&lt;/p&gt;</comment>
                            <comment id="13105859" author="jbellis" created="Fri, 16 Sep 2011 05:09:20 +0000"  >&lt;p&gt;If MeteredFlusher + getLiveSize were really doing their job right though, the pressure valve wouldn&apos;t be getting involved.  (However, I&apos;m not sure it&apos;s entirely fair to tell it &quot;you can have 1/3 of the heap&quot; and then fill up more than 2/3 w/ BF + index.)&lt;/p&gt;

&lt;p&gt;I think I&apos;d like to hold off on further tweaking until after 1.0; the current fudge factor means we&apos;re erring on the side of extra safety, and I&apos;m okay with that (especially since, as you noted, leveled compaction isn&apos;t very sensitive to initial flush size).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12494378" name="3203-prelim.txt" size="9012" author="jbellis" created="Wed, 14 Sep 2011 04:32:14 +0000"/>
                            <attachment id="12494507" name="3203-v2.txt" size="4352" author="jbellis" created="Wed, 14 Sep 2011 20:34:47 +0000"/>
                            <attachment id="12494549" name="3203.png" size="105689" author="brandon.williams" created="Thu, 15 Sep 2011 01:21:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4024</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 10 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gh1z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94193</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>