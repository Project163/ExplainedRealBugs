<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:08:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13691] Fix incorrect [2.1 &lt;&#8212; 3.0] serialization of counter cells with pre-2.1 local shards</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13691</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We stopped generating local shards in C* 2.1, after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6504&quot; title=&quot;counters++&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6504&quot;&gt;&lt;del&gt;CASSANDRA-6504&lt;/del&gt;&lt;/a&gt; (Counters 2.0). But it&#8217;s still possible to have counter cell values&lt;br/&gt;
around, remaining from 2.0 times, on 2.1, 3.0, 3.11, and even trunk nodes, if they&#8217;ve never been overwritten.&lt;/p&gt;

&lt;p&gt;In 2.1, we used two classes for two kinds of counter columns:&lt;br/&gt;
&lt;tt&gt;CounterCell&lt;/tt&gt; class to store counters - internally as collections of &lt;tt&gt;CounterContext&lt;/tt&gt; blobs, encoding collections of (host id, count, clock) tuples&lt;br/&gt;
&lt;tt&gt;CounterUpdateCell&lt;/tt&gt; class to represent unapplied increments - essentially a single long value; this class was never written to commit log, memtables, or sstables, and was only used inside &lt;tt&gt;Mutation&lt;/tt&gt; object graph - in memory, and marshalled over network in cases when counter write coordinator and counter write leader were different nodes&lt;br/&gt;
3.0 got rid of &lt;tt&gt;CounterCell&lt;/tt&gt; and &lt;tt&gt;CounterUpdateCell&lt;/tt&gt;, among other &lt;tt&gt;Cell&lt;/tt&gt; classes. In order to represent these unapplied increments - equivalents of 2.1 &lt;tt&gt;CounterUpdateCell&lt;/tt&gt; - in 3.0 we encode them as regular counter columns, with a &#8216;special&#8217; &lt;tt&gt;CounterContext&lt;/tt&gt; value. I.e. a counter context with a single local shard. We do that so that we can reuse local shard reconcile logic (summing up) to seamlessly support counters with same names collapsing to single increments in batches. See &lt;tt&gt;UpdateParameters.addCounter()&lt;/tt&gt; method comments &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0.14/src/java/org/apache/cassandra/cql3/UpdateParameters.java#L157-L171&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; for details. It also assumes that nothing else can generate a counter with local shards.&lt;/p&gt;

&lt;p&gt;It works fine in pure 3.0 clusters, and in mixed 2.1/3.0 clusters, assuming that there are no counters with legacy local shards remaining from 2.0 era. It breaks down badly if there are.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;LegacyLayout.serializeAsLegacyPartition()&lt;/tt&gt; and consequently &lt;tt&gt;LegacyCell.isCounterUpdate()&lt;/tt&gt; - classes responsible for serializing and deserialising in 2.1 format for compatibility - use the following logic to tell if a cell of &lt;tt&gt;COUNTER&lt;/tt&gt; kind is a regular final counter or an unapplied increment:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isCounterUpdate()
{
    &lt;span class=&quot;code-comment&quot;&gt;// See UpdateParameters.addCounter() &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more details on &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;
&lt;/span&gt;    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; isCounter() &amp;amp;&amp;amp; CounterContext.instance().isLocal(value);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;CounterContext.isLocal()&lt;/tt&gt; method here looks at the first shard of the collection of tuples and returns true if it&#8217;s a local one.&lt;/p&gt;

&lt;p&gt;This method would correctly identify a cell generated by &lt;tt&gt;UpdateParameters.addCounter()&lt;/tt&gt; as a counter update and serialize it correctly as a 2.1 &lt;tt&gt;CounterUpdateCell&lt;/tt&gt;. However, it would also incorrectly flag any regular counter cell that just so happens to have a local shard as the first tuple of the counter context as a counter update. If a 2.1 node as a coordinator of a read requests fetches such a value from a 3.0 node, during a rolling upgrade, instead of the expected &lt;tt&gt;CounterCell&lt;/tt&gt; object it will receive a &lt;tt&gt;CounterUpdateCell&lt;/tt&gt;, breaking all the things. In the best case scenario it will cause an assert in &lt;tt&gt;AbstractCell.reconcileCounter()&lt;/tt&gt; to be raised.&lt;/p&gt;

&lt;p&gt;To fix the problem we must find an unambiguous way, without false positives or false negatives, to represent and identify unapplied counter updates on 3.0 side. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13087066">CASSANDRA-13691</key>
            <summary>Fix incorrect [2.1 &lt;&#8212; 3.0] serialization of counter cells with pre-2.1 local shards</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                            <label>counters</label>
                            <label>upgrade</label>
                    </labels>
                <created>Fri, 14 Jul 2017 02:04:09 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:02 +0000</updated>
                            <resolved>Tue, 1 Aug 2017 15:00:00 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                                    <component>Legacy/Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16088314" author="iamaleksey" created="Sat, 15 Jul 2017 00:06:34 +0000"  >&lt;p&gt;Ended up using a special clock id for counter update contexts, so that we can change for that clock id instead of merely looking at the shard type, to unambiguously tell regular counter values from counter updates in 3.0.&lt;/p&gt;

&lt;p&gt;Branches with the fix: &lt;a href=&quot;https://github.com/iamaleksey/cassandra/tree/13691-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://github.com/iamaleksey/cassandra/tree/13691-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;, &lt;a href=&quot;https://github.com/iamaleksey/cassandra/tree/13691-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The commits include a small unit test to confirm that regular counter contexts with old local shards in first spot are no longer recognized as counter updates. Unfortunately it&apos;s a lot more painful given our existing framework to create upgrade tests that would span the whole range from 2.0 to 3.0, due to differences in supported driver protocol version.&lt;/p&gt;

&lt;p&gt;Steps for manual reproduction and fix verification:&lt;/p&gt;

&lt;p&gt;1. generate some 2.0 counter columns with local shards&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccm create test -n 3 -s -v 2.0.17

ccm node1 cqlsh
cqlsh&amp;gt; CREATE KEYSPACE test WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 3};
cqlsh&amp;gt; CREATE TABLE test.test (id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PRIMARY KEY, v1 counter, v2 counter, v3 counter);

python
&amp;gt;&amp;gt;&amp;gt; from cassandra.cluster &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; Cluster
&amp;gt;&amp;gt;&amp;gt; cluster = Cluster([&lt;span class=&quot;code-quote&quot;&gt;&apos;127.0.0.1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;127.0.0.2&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;127.0.0.3&apos;&lt;/span&gt;])
&amp;gt;&amp;gt;&amp;gt; session = cluster.connect()
&amp;gt;&amp;gt;&amp;gt; query = &lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE test.test SET v1 = v1 + 1, v2 = v2 + 1, v3 = v3 + 1 where id = ?&quot;&lt;/span&gt;
&amp;gt;&amp;gt;&amp;gt; prepared = session.prepare(query)
&amp;gt;&amp;gt;&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in range(0, 1000):
...     session.execute(prepared, [i])
...

ccm flush
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2. upgrade cluster to 2.1&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccm stop
ccm setdir -v 2.1.17
ccm start

ccm node1 nodetool upgradesstables
ccm node2 nodetool upgradesstables
ccm node3 nodetool upgradesstables
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3. upgrade node3 to 3.0&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccm node3 stop
ccm node3 setdir -v 3.0.14
ccm node3 start
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;4. with a 2.1 coordinator, try to read the table with CL.ALL&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccm node1 cqlsh
cqlsh&amp;gt; CONSISTENCY ALL;
cqlsh&amp;gt; SELECT COUNT(*) FROM test.test;
ServerError: &amp;lt;ErrorMessage code=0000 [Server error] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.AssertionError: Wrong &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;type: &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.db.BufferCounterUpdateCell&quot;&lt;/span&gt;&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;5. upgrade node3 to patched 3.0&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccm node3 stop
ccm node3 setdir --install-dir=/Users/aleksey/Code/cassandra
ccm node3 start
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;6. with a 2.1 coordinator, try again to read the table with CL.ALL&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccm node1 cqlsh
cqlsh&amp;gt; CONSISTENCY ALL;
cqlsh&amp;gt; SELECT COUNT(*) FROM test.test;

 count
-------
  1000

(1 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I&apos;ll try to automate it as an upgrade test, too, but for now the manual steps and the unit test will have to do.&lt;/p&gt;</comment>
                            <comment id="16101898" author="iamaleksey" created="Wed, 26 Jul 2017 16:36:05 +0000"  >&lt;p&gt;Dtest &lt;a href=&quot;https://github.com/iamaleksey/cassandra-dtest/commits/13691&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; - requires latest ccm with &lt;a href=&quot;https://github.com/pcmanus/ccm/issues/463&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;issue 463&lt;/a&gt; addressed.&lt;/p&gt;</comment>
                            <comment id="16108981" author="slebresne" created="Tue, 1 Aug 2017 14:20:08 +0000"  >&lt;p&gt;Had a look, and this lgtm. Don&apos;t mean to stole Sam&apos;s thunder, but +1 as far as I&apos;m concerned.&lt;/p&gt;</comment>
                            <comment id="16109046" author="iamaleksey" created="Tue, 1 Aug 2017 14:59:28 +0000"  >&lt;p&gt;Thanks.&lt;/p&gt;

&lt;p&gt;Committed to 3.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/ba71289778369e71d9abbdb93cb6b91ba67f9c85&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ba71289778369e71d9abbdb93cb6b91ba67f9c85&lt;/a&gt; and merged into 3.11 and 4.0. dtest committed as &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/55c4ca8bd450b81da6eed5055981b629b55dea15&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;55c4ca8bd450b81da6eed5055981b629b55dea15&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13208067">CASSANDRA-14958</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 16 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3hidj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>