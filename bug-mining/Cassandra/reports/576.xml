<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:17:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-1756] DatabaseDescriptor static initialization circular reference when initialized through call to StorageService.instance.initClient </title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-1756</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In trunk, attempting to invoke StorageService.instance.initClient results in an NPE due to static definition field ordering in StorageService and a circular reference from DatabaseDescriptor back into an uninitialized field (scheduledTasks). Changing the ordering of the static fields such that scheduledTasks is defined before the static partitioner fixes the issue.&lt;/p&gt;

&lt;p&gt;I&apos;ve also marked the scheduledTasks executor as final as it doesn&apos;t seem to make sense changing it.&lt;/p&gt;

&lt;p&gt;All tests pass with this change locally.&lt;/p&gt;

&lt;p&gt;I suspect this hasn&apos;t surfaced in tests as calling initServer first in the same JVM will allow later calls to initClient to see the correctly defined scheduledTasks fields.&lt;/p&gt;

&lt;p&gt;I&apos;m following the recommended way to do this from ClientOnlyExample, if this isn&apos;t the right way to initialize things let me know.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12480378">CASSANDRA-1756</key>
            <summary>DatabaseDescriptor static initialization circular reference when initialized through call to StorageService.instance.initClient </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gdusbabek">Gary Dusbabek</assignee>
                                    <reporter username="eonnen">Erik Onnen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Nov 2010 21:58:59 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:13 +0000</updated>
                            <resolved>Fri, 19 Nov 2010 16:31:12 +0000</resolved>
                                        <fixVersion>0.7.0 rc 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12933584" author="eonnen" created="Thu, 18 Nov 2010 22:01:06 +0000"  >&lt;p&gt;Attached&lt;/p&gt;</comment>
                            <comment id="12933597" author="eonnen" created="Thu, 18 Nov 2010 22:57:26 +0000"  >&lt;p&gt;I forgot to add the stack trace resulting in the NPE in the original bug, sorry about that.&lt;/p&gt;

&lt;p&gt;Exception in thread &quot;main&quot; java.lang.ExceptionInInitializerError&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.&amp;lt;clinit&amp;gt;(StorageService.java:199)&lt;br/&gt;
	at io.eao.cassandra.http.Main.main(Main.java:24)&lt;br/&gt;
Caused by: java.lang.RuntimeException: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.cassandra.config.DatabaseDescriptor.&amp;lt;clinit&amp;gt;(DatabaseDescriptor.java:396)&lt;br/&gt;
	... 2 more&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
	at org.apache.cassandra.locator.DynamicEndpointSnitch.&amp;lt;init&amp;gt;(DynamicEndpointSnitch.java:74)&lt;br/&gt;
	at org.apache.cassandra.config.DatabaseDescriptor.createEndpointSnitch(DatabaseDescriptor.java:403)&lt;br/&gt;
	at org.apache.cassandra.config.DatabaseDescriptor.&amp;lt;clinit&amp;gt;(DatabaseDescriptor.java:275)&lt;/p&gt;</comment>
                            <comment id="12933804" author="gdusbabek" created="Fri, 19 Nov 2010 13:42:29 +0000"  >&lt;p&gt;That patch does fix the circular reference but exposes other problems in the fat client.  I&apos;ve attached a test case that never finishes.  I suspect over time we&apos;ve introduced changes that couple a few of the singleton services together in undesirable ways.  &lt;/p&gt;

&lt;p&gt;I&apos;ll spend some time looking at it this morning and see if I can make sense of it.&lt;/p&gt;</comment>
                            <comment id="12933820" author="gdusbabek" created="Fri, 19 Nov 2010 14:39:59 +0000"  >&lt;p&gt;0001 is Erik&apos;s patch&lt;br/&gt;
0002 is a test case that exposes an bug in the assumption DynamicEndpointSnitch makes about service initialization.&lt;br/&gt;
0003 fixes the bug.&lt;/p&gt;

&lt;p&gt;Here is the chain of events.&lt;br/&gt;
StorageService.initClient() triggers static initializer in DD which instantiates a DynamicEndpointSnitch.  DES, as part of it&apos;s constructors schedule some tasks with SS.scheduledTasks which promptly starts executing them.  This causes MessagingService to initialize out of order which tries to access the not-fully-initialized SS, causing deadlock.  &lt;/p&gt;

&lt;p&gt;SS cannot finish initializing until MS is done initializing, but MS is waiting on SS to do the same thing, near as I can tell.&lt;/p&gt;</comment>
                            <comment id="12933821" author="jbellis" created="Fri, 19 Nov 2010 14:43:31 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12933854" author="gdusbabek" created="Fri, 19 Nov 2010 16:31:12 +0000"  >&lt;p&gt;committed with a few changes.  It turns out System.exit() in a unit test is not good and I had to change the DES unit test to (rightfully) initialize StorageService.&lt;/p&gt;</comment>
                            <comment id="12933948" author="hudson" created="Fri, 19 Nov 2010 20:05:42 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #19 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/19/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/19/&lt;/a&gt;)&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12460006" name="ASF.LICENSE.NOT.GRANTED--v1-0001-fix-cicular-initialization-problem-between-StorageServ.txt" size="1492" author="gdusbabek" created="Fri, 19 Nov 2010 14:34:15 +0000"/>
                            <attachment id="12460007" name="ASF.LICENSE.NOT.GRANTED--v1-0002-StorageService.initClient-unit-test-that-never-finishe.txt" size="2501" author="gdusbabek" created="Fri, 19 Nov 2010 14:34:15 +0000"/>
                            <attachment id="12460008" name="ASF.LICENSE.NOT.GRANTED--v1-0003-DynamicEndpointSnitch-shouldn-t-update-if-SS-isn-t-ini.txt" size="2420" author="gdusbabek" created="Fri, 19 Nov 2010 14:34:15 +0000"/>
                            <attachment id="12459948" name="CS-1756" size="944" author="eonnen" created="Thu, 18 Nov 2010 21:59:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[gdusbabek]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20295</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 1 week, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g773:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92596</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>