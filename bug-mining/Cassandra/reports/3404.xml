<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:12 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8290] archiving commitlogs after restart fails</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8290</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After update to Cassandra 2.0.11 Cassandra mostly  fails during startup while archiving commitlogs&lt;/p&gt;

&lt;p&gt;see logfile:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;RROR [main] 2014-11-03 13:08:59,388 CassandraDaemon.java (line 513) Exception encountered during startup
java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.RuntimeException: java.io.IOException: Exception while executing the command: /bin/ln /var/lib/cassandra/commitlog/CommitLog-3-1413451666161.log /var/lib/cassandra/archive/CommitLog-3-1413451666161.log, command error Code: 1, command output: /bin/ln: failed to create hard link `/var/lib/cassandra/archive/CommitLog-3-1413451666161.log&apos;: File exists

        at org.apache.cassandra.db.commitlog.CommitLogArchiver.maybeWaitForArchiving(CommitLogArchiver.java:158)
        at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:124)
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:336)
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:496)
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:585)
Caused by: java.util.concurrent.ExecutionException: java.lang.RuntimeException: java.io.IOException: Exception while executing the command: /bin/ln /var/lib/cassandra/commitlog/CommitLog-3-1413451666161.log /var/lib/cassandra/archive/CommitLog-3-1413451666161.log, command error Code: 1, command output: /bin/ln: failed to create hard link `/var/lib/cassandra/archive/CommitLog-3-1413451666161.log&apos;: File exists

        at java.util.concurrent.FutureTask.report(FutureTask.java:122)
        at java.util.concurrent.FutureTask.get(FutureTask.java:188)
        at org.apache.cassandra.db.commitlog.CommitLogArchiver.maybeWaitForArchiving(CommitLogArchiver.java:145)
        ... 4 more
Caused by: java.lang.RuntimeException: java.io.IOException: Exception while executing the command: /bin/ln /var/lib/cassandra/commitlog/CommitLog-3-1413451666161.log /var/lib/cassandra/archive/CommitLog-3-1413451666161.log, command error Code: 1, command output: /bin/ln: failed to create hard link `/var/lib/cassandra/archive/CommitLog-3-1413451666161.log&apos;: File exists

        at com.google.common.base.Throwables.propagate(Throwables.java:160)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:32)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.Thread.run(Thread.java:745)
Caused by: java.io.IOException: Exception while executing the command: /bin/ln /var/lib/cassandra/commitlog/CommitLog-3-1413451666161.log /var/lib/cassandra/archive/CommitLog-3-1413451666161.log, command error Code: 1, command output: /bin/ln: failed to create hard link `/var/lib/cassandra/archive/CommitLog-3-1413451666161.log&apos;: File exists

        at org.apache.cassandra.utils.FBUtilities.exec(FBUtilities.java:604)
        at org.apache.cassandra.db.commitlog.CommitLogArchiver.exec(CommitLogArchiver.java:197)
        at org.apache.cassandra.db.commitlog.CommitLogArchiver.access$100(CommitLogArchiver.java:44)
        at org.apache.cassandra.db.commitlog.CommitLogArchiver$1.runMayThrow(CommitLogArchiver.java:132)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        ... 5 more
ERROR [commitlog_archiver:1] 2014-11-03 13:08:59,388 CassandraDaemon.java (line 199) Exception in thread Thread[commitlog_archiver:1,5,main]
java.lang.RuntimeException: java.io.IOException: Exception while executing the command: /bin/ln /var/lib/cassandra/commitlog/CommitLog-3-1413451666161.log /var/lib/cassandra/archive/CommitLog-3-1413451666161.log, command error Code: 1, command output: /bin/ln: failed to create hard link `/var/lib/cassandra/archive/CommitLog-3-1413451666161.log&apos;: File exists

        at com.google.common.base.Throwables.propagate(Throwables.java:160)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:32)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.Thread.run(Thread.java:745)
Caused by: java.io.IOException: Exception while executing the command: /bin/ln /var/lib/cassandra/commitlog/CommitLog-3-1413451666161.log /var/lib/cassandra/archive/CommitLog-3-1413451666161.log, command error Code: 1, command output: /bin/ln: failed to create hard link `/var/lib/cassandra/archive/CommitLog-3-1413451666161.log&apos;: File exists

        at org.apache.cassandra.utils.FBUtilities.exec(FBUtilities.java:604)
        at org.apache.cassandra.db.commitlog.CommitLogArchiver.exec(CommitLogArchiver.java:197)
        at org.apache.cassandra.db.commitlog.CommitLogArchiver.access$100(CommitLogArchiver.java:44)
        at org.apache.cassandra.db.commitlog.CommitLogArchiver$1.runMayThrow(CommitLogArchiver.java:132)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        ... 5 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The commitlogs are archived already. In this case it makes no sense to crash.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Cassandra 2.0.11 &lt;br/&gt;
Debian wheezy&lt;/p&gt;</environment>
        <key id="12754422">CASSANDRA-8290</key>
            <summary>archiving commitlogs after restart fails</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="mlausch">Manuel Lausch</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Nov 2014 09:41:29 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:28 +0000</updated>
                            <resolved>Tue, 3 Mar 2015 23:17:57 +0000</resolved>
                                        <fixVersion>2.1.5</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14206860" author="mshuler" created="Tue, 11 Nov 2014 19:16:54 +0000"  >&lt;p&gt;It looks like the archive commitlogs were already created, so the linking failed.  The exact steps you took during upgrade might be interesting to look at, so we can reproduce the problem. Deleting the /var/lib/cassandra/archive/CommitLog*.log files that it&apos;s failing on would at least be simple workaround.&lt;/p&gt;</comment>
                            <comment id="14207023" author="mshuler" created="Tue, 11 Nov 2014 20:47:13 +0000"  >&lt;p&gt;One option here is to reconfigure your commitlog archive command to force the link with &lt;tt&gt;ln -f ...&lt;/tt&gt;, so the startup continues, relinking the same files again, if they exist. I&apos;m not sure of the ramifications of &lt;b&gt;not&lt;/b&gt; failing the startup as above - something indeed went wrong, do we really want to continue as if nothing happened?&lt;/p&gt;</comment>
                            <comment id="14207918" author="mlausch" created="Wed, 12 Nov 2014 10:41:48 +0000"  >&lt;p&gt;The Upgrade was quite easy. Stopping Cassandra via init-script, Upgrade the Package, starting the cassandra via init-script&lt;/p&gt;

&lt;p&gt;The Problem occured not only while upgradeing. Yesterday I instelled OS-Updates and rebootet the Nodes. After the reboot I run in this problem too. If I disable gossip, the clientports and flush the memtable via nodetool bevor stopping the Node all will work fine.&lt;/p&gt;

&lt;p&gt;As far as I see archived commitlogs are not deleted in the commitlog dir. After startup all commitlogs will be archived but the links were already created before the shutdown of the cassandra happend. &lt;/p&gt;


&lt;p&gt;PS: In 2.0.10 restarting of cassandra did not fail. This is new in 2.0.11&lt;/p&gt;</comment>
                            <comment id="14207955" author="beobal" created="Wed, 12 Nov 2014 11:44:14 +0000"  >&lt;p&gt;Yes, this is caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6904&quot; title=&quot;commitlog segments may not be archived after restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6904&quot;&gt;&lt;del&gt;CASSANDRA-6904&lt;/del&gt;&lt;/a&gt;. The dtests around archiving use &lt;tt&gt;cp&lt;/tt&gt; rather than &lt;tt&gt;ln&lt;/tt&gt; so didn&apos;t hit this. I&apos;ll take a look.&lt;/p&gt;</comment>
                            <comment id="14208487" author="beobal" created="Wed, 12 Nov 2014 19:12:28 +0000"  >&lt;p&gt;The specific problem here is that we pre-emptively archive segments once we know they&apos;re not going to receive any further mutations (i.e. they&apos;re full). However, the segment may not actually be discarded or recycled immediately as it can still contain mutations for unflushed column families. If the server is stopped while we&apos;re in this state, the original segment file will remain in the commitlog directory. When the server is restarted, it tries to archive any pre-existing segment files (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6904&quot; title=&quot;commitlog segments may not be archived after restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6904&quot;&gt;&lt;del&gt;CASSANDRA-6904&lt;/del&gt;&lt;/a&gt;), but in this case the target already exists, which leads to the reported error.&lt;/p&gt;

&lt;p&gt;We could help this somewhat by moving the archival to the point where the segment is recycled or discarded, shortening the window in which we have archived, but not active files present (of course, it wouldn&apos;t completely close that window). &lt;/p&gt;

&lt;p&gt;However, there&apos;s a bigger issue here which is that due to recycling, CL segments are not really immutable and so hardlinking probably isn&apos;t the right way to archive them. I would modify the command you&apos;re using to copy the files to the archive location instead. &lt;/p&gt;

&lt;p&gt;I noticed we use &lt;tt&gt;ln&lt;/tt&gt; in the example command, so I&apos;ve attached a patch that changes that to &lt;tt&gt;cp&lt;/tt&gt; &lt;/p&gt;</comment>
                            <comment id="14216010" author="mlausch" created="Tue, 18 Nov 2014 09:53:46 +0000"  >&lt;p&gt;Okay, I have testet it with &quot;cp&quot; and it works for me.&lt;/p&gt;</comment>
                            <comment id="14216435" author="mshuler" created="Tue, 18 Nov 2014 17:06:22 +0000"  >&lt;p&gt;lgtm&lt;/p&gt;</comment>
                            <comment id="14345979" author="iamaleksey" created="Tue, 3 Mar 2015 23:17:15 +0000"  >&lt;p&gt;Committed, thanks. We might want to change it back in 3.0, once &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6809&quot; title=&quot;Compressed Commit Log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6809&quot;&gt;&lt;del&gt;CASSANDRA-6809&lt;/del&gt;&lt;/a&gt; removes segment recycling, but that&apos;s a question for another ticket.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12828963">CASSANDRA-9350</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12681121" name="8290.txt" size="1379" author="samt" created="Wed, 12 Nov 2014 19:12:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 37 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2286n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327942">2.0.11</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>mshuler</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mshuler]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327942">2.0.11</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>