<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:08:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13592] Null Pointer exception at SELECT JSON statement</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13592</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;A Nulll pointer exception appears when the command&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT JSON * FROM examples.basic;

---MORE---
&amp;lt;Error from server: code=0000 [Server error] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.NullPointerException&quot;&lt;/span&gt;&amp;gt;

Examples.basic has the following description (DESC examples.basic;):
CREATE TABLE examples.basic (
    key frozen&amp;lt;tuple&amp;lt;uuid, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt; PRIMARY KEY,
    wert text
) WITH bloom_filter_fp_chance = 0.01
    AND caching = {&lt;span class=&quot;code-quote&quot;&gt;&apos;keys&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;ALL&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;rows_per_partition&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;NONE&apos;&lt;/span&gt;}
    AND comment = &apos;&apos;
    AND compaction = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;max_threshold&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;32&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;min_threshold&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;4&apos;&lt;/span&gt;}
    AND compression = {&lt;span class=&quot;code-quote&quot;&gt;&apos;chunk_length_in_kb&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;64&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.io.compress.LZ4Compressor&apos;&lt;/span&gt;}
    AND crc_check_chance = 1.0
    AND dclocal_read_repair_chance = 0.1
    AND default_time_to_live = 0
    AND gc_grace_seconds = 864000
    AND max_index_interval = 2048
    AND memtable_flush_period_in_ms = 0
    AND min_index_interval = 128
    AND read_repair_chance = 0.0
    AND speculative_retry = &lt;span class=&quot;code-quote&quot;&gt;&apos;99PERCENTILE&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The error appears after the --&lt;del&gt;MORE&lt;/del&gt;-- line.&lt;/p&gt;

&lt;p&gt;The field &quot;wert&quot; has a JSON formatted string.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Debian Linux&lt;/p&gt;</environment>
        <key id="13079207">CASSANDRA-13592</key>
            <summary>Null Pointer exception at SELECT JSON statement</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jasonstack">Zhao Yang</assignee>
                                    <reporter username="panibus">Wyss Philipp</reporter>
                        <labels>
                            <label>beginner</label>
                    </labels>
                <created>Mon, 12 Jun 2017 13:33:50 +0000</created>
                <updated>Fri, 15 May 2020 08:06:28 +0000</updated>
                            <resolved>Fri, 7 Jul 2017 16:17:34 +0000</resolved>
                                        <fixVersion>2.2.11</fixVersion>
                    <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16064405" author="jasonstack" created="Tue, 27 Jun 2017 07:39:44 +0000"  >&lt;p&gt;In Json path, the bytebuffer is being consumed with position = capacity. So in page-state, no partition key bytes are written.  &lt;/p&gt;

&lt;p&gt;Using bf.duplicate() would fix this issue.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; List&amp;lt;ByteBuffer&amp;gt; rowToJson(List&amp;lt;ByteBuffer&amp;gt; row, ProtocolVersion protocolVersion, ResultSet.ResultMetadata metadata)
    {
        StringBuilder sb = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder(&lt;span class=&quot;code-quote&quot;&gt;&quot;{&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; metadata.names.size(); i++)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (i &amp;gt; 0)
                sb.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;, &quot;&lt;/span&gt;);

            ColumnSpecification spec = metadata.names.get(i);
            &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; columnName = spec.name.toString();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!columnName.equals(columnName.toLowerCase(Locale.US)))
                columnName = &lt;span class=&quot;code-quote&quot;&gt;&quot;\&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot; + columnName + &quot;&lt;/span&gt;\&quot;&quot;;

            ByteBuffer buffer = row.get(i);
            sb.append(&lt;span class=&quot;code-quote&quot;&gt;&apos;&quot;&apos;&lt;/span&gt;);
            sb.append(Json.quoteAsJsonString(columnName));
            sb.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;\&quot;&lt;/span&gt;: &quot;);
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (buffer == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                sb.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                &lt;span class=&quot;code-comment&quot;&gt;// use duplicate() to avoid buffer being consumed
&lt;/span&gt;                sb.append(spec.type.toJSONString(buffer.duplicate(), protocolVersion));
        }
        sb.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;}&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.singletonList(UTF8Type.instance.getSerializer().serialize(sb.toString()));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16065895" author="jasonstack" created="Wed, 28 Jun 2017 04:03:14 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; source &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; junit-result &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; dtest-result&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jasonstack/cassandra/commits/CASSANDRA-13592&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/jasonstack/cassandra/65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/jasonstack/cassandra/65&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&amp;nbsp;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;let the user of &apos;type.toJSONString()&apos; to handle BB position changes.&lt;/p&gt;</comment>
                            <comment id="16066797" author="blerer" created="Wed, 28 Jun 2017 16:16:50 +0000"  >&lt;p&gt;Thanks for the patch.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;pagingOnToJsonQuery()&lt;/tt&gt; test is passing even without the change to &lt;tt&gt;Selection::rowToJson&lt;/tt&gt;. After looking into it seems that the problem is in fact in &lt;tt&gt;TupleType::toJSONString&lt;/tt&gt;. The method is actually moving the buffer position while it should not. Which is why simple types like &lt;tt&gt;int&lt;/tt&gt; or &lt;tt&gt;text&lt;/tt&gt; are not affected by the problem.&lt;br/&gt;
I guess that we might have similar problems with the &lt;tt&gt;list&lt;/tt&gt;, &lt;tt&gt;set&lt;/tt&gt;, &lt;tt&gt;map&lt;/tt&gt; or UDT types. So, it will be nice to add some extra tests for those type as well.&lt;/p&gt;

&lt;p&gt;I would put the tests in &lt;tt&gt;JsonTest&lt;/tt&gt; instead of in &lt;tt&gt;PagingQueryTest&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;json&lt;/tt&gt; support has been introduced in 2.2 so we will also need some patches for 2.2, 3.0, 3.11. &lt;/p&gt;</comment>
                            <comment id="16067738" author="jasonstack" created="Thu, 29 Jun 2017 05:01:24 +0000"  >&lt;p&gt;Thanks for reviewing.. I will update the 2.0/3.0/3.11 branch when trunk CI finishes.&lt;/p&gt;

&lt;p&gt;&quot;list , set, map or UDT types&quot; are not allowed in key, ideally it shouldn&apos;t cause issues. I think only key buffer will be reused eg. paging-state, subsequent rows deserialization. &lt;br/&gt;
I have included them in the test.&lt;/p&gt;

&lt;p&gt;One more issue is in ToJsonFct.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ByteBuffer execute(ProtocolVersion protocolVersion, List&amp;lt;ByteBuffer&amp;gt; parameters) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; InvalidRequestException
    {
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; parameters.size() == 1 : &lt;span class=&quot;code-quote&quot;&gt;&quot;Expected 1 argument &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; toJson(), but got &quot;&lt;/span&gt; + parameters.size();
        ByteBuffer parameter = parameters.get(0);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (parameter == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ByteBufferUtil.bytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-comment&quot;&gt;// same..
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ByteBufferUtil.bytes(argTypes.get(0).toJSONString(parameter.duplicate(), protocolVersion));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16067987" author="blerer" created="Thu, 29 Jun 2017 08:26:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;&quot;list , set, map or UDT types&quot; are not allowed in key&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;They are, as long as they are &lt;tt&gt;frozen&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Sorry, it seems that I was not clear. Fixing the problem in &lt;tt&gt;rowToJson&lt;/tt&gt; or in the &lt;tt&gt;ToJsonFct&lt;/tt&gt; is in my opinion wrong. Most of the types will not change the buffer position in the &lt;tt&gt;toJSONString&lt;/tt&gt; method and I will argue that it is the correct behavior. The  &lt;tt&gt;toJSONString&lt;/tt&gt; methods should not change the buffer position.&lt;br/&gt;
If you fix it at a higher level, like in the &lt;tt&gt;rowToJson&lt;/tt&gt; method or in the &lt;tt&gt;ToJsonFct&lt;/tt&gt; class, you let a potential bug in the code that can hit us later if we add some new code that use the &lt;tt&gt;toJSONString&lt;/tt&gt; method.&lt;br/&gt;
Moreover, your changes create in most of the cases some unnecessary objects.&lt;/p&gt;

&lt;p&gt;The proper way to fix that problem is to fix the &lt;tt&gt;toJSONString&lt;/tt&gt; methods that changes the buffer position which seems to be the one of: &lt;tt&gt;TupleType&lt;/tt&gt;, &lt;tt&gt;MapType&lt;/tt&gt;, &lt;tt&gt;ListType&lt;/tt&gt; and &lt;tt&gt;SetType&lt;/tt&gt;.   &lt;/p&gt;</comment>
                            <comment id="16068410" author="jasonstack" created="Thu, 29 Jun 2017 14:28:00 +0000"  >&lt;p&gt;Thanks.. Yes, it&apos;s better solve it within &lt;tt&gt;type.toJSONString&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I will add test the specification of &lt;tt&gt;type.toJSONString&lt;/tt&gt;.  all should not change buffer position.&lt;/p&gt;

&lt;p&gt;Got a question about &lt;tt&gt;DurationType.toJSONString()&lt;/tt&gt;, imo, it should return string value with double quote &lt;tt&gt;&quot;-2h9m&quot;&lt;/tt&gt;, like &lt;tt&gt;TimeType.toJSONString()&lt;/tt&gt;.   but it only returns string value &lt;tt&gt;-2h9m&lt;/tt&gt; .  Is it expected?  it would be different from user&apos;s json input. &lt;/p&gt;

&lt;p&gt;One more thing is about: EmptyType. it should directly &lt;tt&gt;return &quot;\&quot;\&quot;&quot;;&lt;/tt&gt; instead of using parent method which causes null-pointer exception.  EmptyType seems not used for json-path, but good to keep it safe.&lt;/p&gt;</comment>
                            <comment id="16069565" author="jasonstack" created="Fri, 30 Jun 2017 06:18:07 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; source &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; junit-result &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; dtest-result&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jasonstack/cassandra/commits/CASSANDRA-13592&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/jasonstack/cassandra/84&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;junit&lt;/a&gt;  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;tt&gt;cql_tests.py:SlowQueryTester.local_query_test&lt;/tt&gt; failed on trunk&lt;br/&gt;
&lt;tt&gt;cql_tests.py:SlowQueryTester.remote_query_test&lt;/tt&gt; failed on trunk&lt;br/&gt;
&lt;tt&gt;bootstrap_test.TestBootstrap.simultaneous_bootstrap_test&lt;/tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13506&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;known&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jasonstack/cassandra/commits/CASSANDRA-13592-cassandra-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  &lt;a href=&quot;https://circleci.com/gh/jasonstack/cassandra/82&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;junit&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;tt&gt;topology_test.TestTopology.size_estimates_multidc_test&lt;/tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13229&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;known&lt;/a&gt;&lt;br/&gt;
&lt;tt&gt;cqlsh_tests.cqlsh_tests.TestCqlsh.test_describe&lt;/tt&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13250&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;known&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jasonstack/cassandra/commits/CASSANDRA-13592-cassandra-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  &lt;a href=&quot;https://circleci.com/gh/jasonstack/cassandra/83&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;junit&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;tt&gt;auth_test.TestAuth.system_auth_ks_is_alterable_test&lt;/tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13113&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;known&lt;/a&gt;&lt;br/&gt;
&lt;tt&gt;offline_tools_test.TestOfflineTools.sstableofflinerelevel_test&lt;/tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12617&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;known&lt;/a&gt;&lt;br/&gt;
&lt;tt&gt;repair_tests.incremental_repair_test.TestIncRepair.multiple_repair_test&lt;/tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13515&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;known&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jasonstack/cassandra/commits/CASSANDRA-13592-cassandra-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  &lt;a href=&quot;https://circleci.com/gh/jasonstack/cassandra/85&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;junit&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; passed &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;1. in &lt;tt&gt;listType, mapType, setType, TupleType&lt;/tt&gt;.toJSONString(), keep buffer position the same.&lt;br/&gt;
2. change &lt;tt&gt;DurationType&lt;/tt&gt;.toJSONString() to &lt;tt&gt;return &quot;\&quot;&quot; +.... +&quot;\&quot;&quot;;&lt;/tt&gt; (with double-quote) to be consistent with user json input&lt;br/&gt;
3. change &lt;tt&gt;EmptyType&lt;/tt&gt;.toJSONString() to directly &lt;tt&gt;return &quot;\&quot;\&quot;&quot;;&lt;/tt&gt;, otherwise parent method throws NPE.&lt;/p&gt;</comment>
                            <comment id="16069843" author="jasonstack" created="Fri, 30 Jun 2017 10:18:05 +0000"  >&lt;p&gt;I have created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13650&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;ticket&lt;/a&gt; for &lt;tt&gt;cql_tests.py:SlowQueryTester.local_query_test&lt;/tt&gt; &amp;amp; &lt;tt&gt;cql_tests.py:SlowQueryTester.remote_query_test&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16072449" author="blerer" created="Mon, 3 Jul 2017 13:36:36 +0000"  >&lt;p&gt;The patch looks mostly good. I just have the following nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The unit test: &lt;tt&gt;JsonTest::testPagingWithJsonQuery&lt;/tt&gt; is hard to read. It seems to me that the loop does not bring much and makes the code harder to understand. I would remove it, even if it results in a longer method.&lt;/li&gt;
	&lt;li&gt;In the same method you should check the output and not only the number of rows. The returned values could be invalid even if the number of returned rows is the good one.&lt;/li&gt;
	&lt;li&gt;I would replace &lt;tt&gt;/** Converts a value to a JSON string. buffer position not changed */&lt;/tt&gt; by something like:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/** 
 * Converts the specified value into its JSON representation. 
 * &amp;lt;p&amp;gt;The buffer position will stay the same.&amp;lt;/p&amp;gt;
* @param buffer the value to convert
* @param protocolVersion the protocol version to use &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the conversion
* @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;  a JSON string representing the specified value
 */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16073057" author="jasonstack" created="Tue, 4 Jul 2017 03:06:37 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; source &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; junit-result &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; dtest-result&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jasonstack/cassandra/commits/CASSANDRA-13592&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/jasonstack/cassandra/102&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;junit&lt;/a&gt;  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;tt&gt;cql_tests.py:SlowQueryTester.local_query_test&lt;/tt&gt; &lt;tt&gt;cql_tests.py:SlowQueryTester.remote_query_test&lt;/tt&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13592&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;known&lt;/a&gt;&lt;br/&gt;
&lt;tt&gt;bootstrap_test.TestBootstrap.consistent_range_movement_false_with_rf1_should_succeed_test&lt;/tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13576&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;known&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jasonstack/cassandra/commits/CASSANDRA-13592-cassandra-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  &lt;a href=&quot;https://circleci.com/gh/jasonstack/cassandra/99&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;junit&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;tt&gt;topology_test.TestTopology.size_estimates_multidc_test&lt;/tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13229&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;known&lt;/a&gt;&lt;br/&gt;
&lt;tt&gt;cqlsh_tests.cqlsh_tests.TestCqlsh.test_describe&lt;/tt&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13250&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;known&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jasonstack/cassandra/commits/CASSANDRA-13592-cassandra-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  &lt;a href=&quot;https://circleci.com/gh/jasonstack/cassandra/100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;junit&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;tt&gt;offline_tools_test.TestOfflineTools.sstableofflinerelevel_test&lt;/tt&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12617&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;known&lt;/a&gt; &lt;br/&gt;
&lt;tt&gt;cqlsh_tests.cqlsh_copy_tests.CqlshCopyTest.test_bulk_round_trip_with_single_cor&lt;/tt&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13244&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;known&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jasonstack/cassandra/commits/CASSANDRA-13592-cassandra-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  &lt;a href=&quot;https://circleci.com/gh/jasonstack/cassandra/97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;junit&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; passed &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;Updated java doc and split the test cases. &lt;/p&gt;</comment>
                            <comment id="16078309" author="blerer" created="Fri, 7 Jul 2017 16:15:49 +0000"  >&lt;p&gt;Thanks for the changes. &lt;br/&gt;
The paging tests were not using paging. I fixed that before committing.&lt;/p&gt;</comment>
                            <comment id="16078315" author="blerer" created="Fri, 7 Jul 2017 16:17:34 +0000"  >&lt;p&gt;Committed into 2.2 at cb6fad3efcd7cd3dc87d02ca7e8e97eb277a66ab and merged into 3.0, 3.11 and trunk.&lt;/p&gt;</comment>
                            <comment id="16236755" author="mildebrandt" created="Thu, 2 Nov 2017 22:50:52 +0000"  >&lt;p&gt;I&apos;m getting almost exactly the same stacktrace using Cassandra 3.11.1:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException: null
        at org.apache.cassandra.dht.Murmur3Partitioner.getHash(Murmur3Partitioner.java:230) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.dht.Murmur3Partitioner.decorateKey(Murmur3Partitioner.java:66) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.config.CFMetaData.decorateKey(CFMetaData.java:627) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.service.pager.PartitionRangeQueryPager.&amp;lt;init&amp;gt;(PartitionRangeQueryPager.java:44) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.db.PartitionRangeReadCommand.getPager(PartitionRangeReadCommand.java:268) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.cql3.statements.SelectStatement.getPager(SelectStatement.java:475) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:288) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:118) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:224) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:530) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:507) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.transport.messages.ExecuteMessage.execute(ExecuteMessage.java:146) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:517) [apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:410) [apache-cassandra-3.11.1.jar:3.11.1]
        at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) [netty-all-4.0.44.Final.jar:4.0.44.Final]
        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:357) [netty-all-4.0.44.Final.jar:4.0.44.Final]
        at io.netty.channel.AbstractChannelHandlerContext.access$600(AbstractChannelHandlerContext.java:35) [netty-all-4.0.44.Final.jar:4.0.44.Final]
        at io.netty.channel.AbstractChannelHandlerContext$7.run(AbstractChannelHandlerContext.java:348) [netty-all-4.0.44.Final.jar:4.0.44.Final]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [na:1.8.0_131]
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:162) [apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:109) [apache-cassandra-3.11.1.jar:3.11.1]
        at java.lang.Thread.run(Thread.java:748) [na:1.8.0_131]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It can be recreated with this project:&lt;br/&gt;
&lt;a href=&quot;https://github.com/eyeofthefrog/CASSANDRA-13592&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/eyeofthefrog/CASSANDRA-13592&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think it&apos;s the same root cause, but let me know if I should open another issue. &lt;/p&gt;</comment>
                            <comment id="16237281" author="blerer" created="Fri, 3 Nov 2017 08:42:05 +0000"  >&lt;p&gt;It is a different issue. Could you open another ticket?&lt;/p&gt;</comment>
                            <comment id="16237969" author="mildebrandt" created="Fri, 3 Nov 2017 16:51:45 +0000"  >&lt;p&gt;Sure, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13991&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-13991&lt;/a&gt;&lt;br/&gt;
Thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12872697" name="system.log" size="3153211" author="panibus" created="Mon, 12 Jun 2017 13:33:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasonstack]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3g613:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12337348">3.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>