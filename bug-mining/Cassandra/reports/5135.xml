<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:12:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14554] Streaming needs to synchronise access to LifecycleTransaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14554</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When LifecycleTransaction is used in a multi-threaded context, we encounter this exception -&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;java.util.ConcurrentModificationException: null&lt;br/&gt;
 at java.util.LinkedHashMap$LinkedHashIterator.nextNode(LinkedHashMap.java:719)&lt;br/&gt;
 at java.util.LinkedHashMap$LinkedKeyIterator.next(LinkedHashMap.java:742)&lt;br/&gt;
 at java.lang.Iterable.forEach(Iterable.java:74)&lt;br/&gt;
 at org.apache.cassandra.db.lifecycle.LogReplicaSet.maybeCreateReplica(LogReplicaSet.java:78)&lt;br/&gt;
 at org.apache.cassandra.db.lifecycle.LogFile.makeRecord(LogFile.java:320)&lt;br/&gt;
 at org.apache.cassandra.db.lifecycle.LogFile.add(LogFile.java:285)&lt;br/&gt;
 at org.apache.cassandra.db.lifecycle.LogTransaction.trackNew(LogTransaction.java:136)&lt;br/&gt;
 at org.apache.cassandra.db.lifecycle.LifecycleTransaction.trackNew(LifecycleTransaction.java:529)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;During streaming we create a reference to a &lt;tt&gt;LifeCycleTransaction&lt;/tt&gt; and share it between threads -&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/5cc68a87359dd02412bdb70a52dfcd718d44a5ba/src/java/org/apache/cassandra/db/streaming/CassandraStreamReader.java#L156&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/5cc68a87359dd02412bdb70a52dfcd718d44a5ba/src/java/org/apache/cassandra/db/streaming/CassandraStreamReader.java#L156&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This is used in a multi-threaded context inside&#160;&lt;tt&gt;CassandraIncomingFile&lt;/tt&gt; which is an&#160;&lt;tt&gt;IncomingStreamMessage&lt;/tt&gt;. This is being deserialized in parallel.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;LifecycleTransaction&lt;/tt&gt; is not meant to be used in a multi-threaded context and this leads to streaming failures due to object sharing. On trunk, this object is shared across all threads that transfer sstables in parallel for the given &lt;tt&gt;TableId&lt;/tt&gt; in a &lt;tt&gt;StreamSession&lt;/tt&gt;. There are two options to solve this - make &lt;tt&gt;LifecycleTransaction&lt;/tt&gt; and the associated objects thread safe, scope the transaction to a single &lt;tt&gt;CassandraIncomingFile&lt;/tt&gt;. The consequences of the latter option is that if we experience streaming failure we may have redundant SSTables on disk. This is ok as compaction should clean this up. A third option is we synchronize access in the streaming infrastructure.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13169701">CASSANDRA-14554</key>
            <summary>Streaming needs to synchronise access to LifecycleTransaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="djoshi">Dinesh Joshi</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Jul 2018 06:00:31 +0000</created>
                <updated>Sun, 25 Oct 2020 23:39:52 +0000</updated>
                            <resolved>Mon, 10 Dec 2018 15:33:09 +0000</resolved>
                                        <fixVersion>3.0.18</fixVersion>
                    <fixVersion>3.11.4</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Messaging/Internode</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="16677739" author="stefania" created="Wed, 7 Nov 2018 06:33:31 +0000"  >&lt;p&gt;We had a related issue where one of our customers ended up with a corrupt txn log file during streaming, with an ADD record following an ABORT record. We couldn&apos;t look at the logs as they weren&apos;t available any longer, since the customer only noticed the problem when the node would not restart 22 days later. However, it&apos;s pretty obvious in my opinion that one thread aborted the streaming session whilst the receiving thread was adding a new sstable. So this seems the same root cause as reported in this ticket, which is that streaming is using the txn in a thread unsafe way. In my opinion, the problem exists since 3.0. However it becomes significanlty more likely with the Netty streaming refactoring. Our customer was on a branch based on 3.11.&lt;/p&gt;

&lt;p&gt;We took a very conservative approach with the fix, in that we didn&apos;t want to fully synchronize abstract transactional and the lifecycle transaction on released branches. We could consider synchronizing these classes for 4.0 however, or reworking streaming.&lt;/p&gt;

&lt;p&gt;Here are the 3.11 changes, if there is interest in this approach I can create patches for 3.0 and trunk as well:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...stef1927:db-2633-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/cassandra-3.11...stef1927:db-2633-3.11&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We simply extracted a new interface, the &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...stef1927:db-2633-3.11#diff-9d71c7ad9ad16368bd0429d3b34e2b21R15&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;sstable tracker&lt;/a&gt;, which is also &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...stef1927:db-2633-3.11#diff-1a464da4a62ac4a734c725059cbc918bR144&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;implemented&lt;/a&gt; by &lt;tt&gt;StreamReceiveTask&lt;/tt&gt; by synchronizing the access to the txn, just like it does for all its other accesses to the txn. Whilst it&apos;s not ideal to have an additional interface, the change should be quite safe for released branches.&lt;/p&gt;</comment>
                            <comment id="16678497" author="benedict" created="Wed, 7 Nov 2018 16:49:25 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt;. Thanks for the patch!&lt;/p&gt;

&lt;p&gt;I haven&apos;t reviewed it, but just skimming it, I wonder if you had considered (and potentially discarded) what might be a slightly simpler approach of allocating a separate &lt;tt&gt;LifecycleTransaction&lt;/tt&gt; for each operation, and atomically transferring their contents as they &quot;complete&quot; to the shared &lt;tt&gt;LivecycleTransaction&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;Semantically the behaviour remains the same as today, but we should need to minimally change existing code - just encapsulate the offending &lt;tt&gt;LifecycleTransaction&lt;/tt&gt; to avoid future temptation for unsafe access, and introduce a &lt;tt&gt;transferTo&lt;/tt&gt; method (or equivalent) to update the shared state.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="16679214" author="stefania" created="Thu, 8 Nov 2018 02:47:46 +0000"  >&lt;p&gt;You&apos;re welcome &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; !&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I wonder if you had considered (and potentially discarded) what might be a slightly simpler approach of allocating a separate LifecycleTransaction for each operation, and atomically transferring their contents as they &quot;complete&quot; to the shared LivecycleTransaction?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No I hadn&apos;t considered it. It sounds elegant in principle but in order to atomically transfer child transactions to their parent, we&apos;d have to add some complexity to transactions that I&apos;m not sure we need. Obviously, the state of the parent transaction could change at any time (due to an abort), including whilst a child transaction is trying to transfer its state. So this would require some form of synchronization or CAS. The same is true for two child transactions transferring their state simultaneously. The state on disk should be fine as long as child transactions are never committed but only transferred. Child transaction should be allowed to abort independently though. So different rules for child and parent transactions would apply. &lt;/p&gt;

&lt;p&gt;I&apos;m not sure we need this additional complexity because the txn state only changes rarely. &lt;tt&gt;LifecycleTransaction&lt;/tt&gt; exposes a large API, but many methods are probably only used during compaction. Extracting a more comprehensive interface that can be implemented with a synchronized wrapper may be an easier approach.&lt;/p&gt;

&lt;p&gt;I submitted a safe patch that fixes a known problem with streaming and that is safe for branches that will not undergo a major release testing cycle. Unfortunately, I do not have the time to work on a more comprehensive solution, at least not right now. I could however review whichever approach we choose.&lt;/p&gt;</comment>
                            <comment id="16680015" author="benedict" created="Thu, 8 Nov 2018 17:00:08 +0000"  >&lt;p&gt;I was actually thinking of something very simple.  Child transactions would not have any direct relationship to parents, there would just be a method to transfer their contents, and this method would be synchronised.  The other methods on a &lt;tt&gt;LifecycleTransaction&lt;/tt&gt; could simply be marked synchronised as well.  I don&apos;t think there would be any major problem with this?  It&apos;s not a high-traffic object, so the cost would be low even without extracting a synchronised interface, particularly as this object requires regular fsyncs.&lt;/p&gt;

&lt;p&gt;I completely understand that you may be too busy to try this alternative approach.  I think it would be &lt;em&gt;preferable&lt;/em&gt; for somebody to have a brief try at the alternative, just to see if we can isolate the complexity, but if we find we don&apos;t have time I think your patch looks good too (modulo a proper review).  &lt;/p&gt;

&lt;p&gt;Perhaps we should wait and see how things pan out with finding time for review, as I know &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi3&quot; class=&quot;user-hover&quot; rel=&quot;djoshi3&quot;&gt;djoshi3&lt;/a&gt; had been planning to take a crack at this too.&lt;/p&gt;</comment>
                            <comment id="16680787" author="stefania" created="Fri, 9 Nov 2018 03:17:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;The other methods on a LifecycleTransaction could simply be marked synchronised as well.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If we are synchronizing the LifecycleTransaction methods anyway, I&apos;m not sure I understand why we need child transactions. Even in 4.0, where Netty threads call &lt;tt&gt;trackNew&lt;/tt&gt;, I don&apos;t think we&apos;re adding sstables so frequently to introduce contention on a shared, synchronized txn. Considering &lt;tt&gt;trackNew&lt;/tt&gt; performs a file sync as you correctly reminded me, surely this blocks Netty threads more than a synchronized &lt;tt&gt;trackNew&lt;/tt&gt;. Maybe if many sstables are created concurrently during streaming, child transactions would make sense. I&apos;m still not totally sure.&lt;/p&gt;

&lt;p&gt;It&apos;s fine with me if we prefer to try a different alternative, the patch is available at any time. This code is not changing much so there is little risk of the patch getting stale. For info, internally &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt; already reviewed the patch.&lt;/p&gt;</comment>
                            <comment id="16683835" author="benedict" created="Mon, 12 Nov 2018 14:13:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;If we are synchronizing the LifecycleTransaction methods anyway, I&apos;m not sure I understand why we need child transactions.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The only reason would be simplifying analysis of the code&apos;s behaviour.  For instance, it&apos;s not clear to me how we either would (or should) behave in the stream writers actively working (and creating sstable files) but for whom the transaction has already been cancelled.  Does such a scenario even arise?  Is it possible it would leave partially written sstables?&lt;/p&gt;

&lt;p&gt;A separate transaction is very easy to reason about, so we have only to consider what happens when we transfer ownership.&lt;/p&gt;

&lt;p&gt;I agree that there is no sensible reason to worry about blocking behaviour specifically, and perhaps synchronising the transaction object is a simple first step we can follow-up later (we could even do it with a delegating SynchronizedLifecycleTransaction, which would seem to be equivalent to your patch, but with the changes isolated to a couple of classes, I think?)&lt;/p&gt;</comment>
                            <comment id="16684618" author="stefania" created="Tue, 13 Nov 2018 02:03:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;The only reason would be simplifying analysis of the code&apos;s behaviour. For instance, it&apos;s not clear to me how we either would (or should) behave in the stream writers actively working (and creating sstable files) but for whom the transaction has already been cancelled. Does such a scenario even arise? Is it possible it would leave partially written sstables?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;m not sure if this scenario may arise when a streaming transaction is aborted, it depends on streaming details which I&apos;ve forgotten, but let&apos;s step through it:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The new sstables are recorded as new records before the files are created. If the recording fails, because the transaction was aborted, the streamer will abort with an exception. Fine.&lt;/li&gt;
	&lt;li&gt;So long as the sstables are recorded, the transaction tidier will delete the files on disk and so the contents will be removed from disk as soon as the streamer finishes writing. Also fine.&lt;/li&gt;
	&lt;li&gt;We may however have a race is if the streamer has added a new record to a txn that is about to be aborted, and the streamer hasn&apos;t created sstable files when the transaction tidier is running. This could leave files on disk. It&apos;s an extremely small window, but it&apos;s not impossible.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We keep a reference to the txn only for obsoleted readers of existing files, we should also keep a reference to the txn until all new files are at least created and the directory has been synced. Child transactions would solve this without the need for this extra reference, but we would need to enforce them for all multi-threaded code (the presence of synchronized methods may lure people on sharing transactions). The alternative to child transactions is to force writers to reference the txn.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;we could even do it with a delegating SynchronizedLifecycleTransaction, which would seem to be equivalent to your patch&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This was exactly the starting point of my patch. I did not implement a fully synchronized transaction because the API is quite large. I thought it may need some cleanup in order to extract the methods related to the transaction behavior. I did not have the time to look into this, and also cleaning up the API is not an option on our released branches, due to the risk of introducing problems, so I extracted the three methods that are used by the writers and implemented the easiest and safest approach.&lt;/p&gt;</comment>
                            <comment id="16685312" author="benedict" created="Tue, 13 Nov 2018 14:40:25 +0000"  >&lt;p&gt;I&#160;think&#160;the situation would actually be, essentially,&#160;undefined behaviour? &#160;Since even with this patch we&apos;ve got a race for modifying the various collections between &lt;tt&gt;abort()&lt;/tt&gt; and &lt;tt&gt;trackNew()&lt;/tt&gt;. Even if this window is narrow, this is probably not acceptable for the fix?&lt;/p&gt;

&lt;p&gt;We could perhaps create a synchronised transaction object that wraps the &lt;tt&gt;LifecycleTransaction&lt;/tt&gt; and exposes largely the API you have exposed, but also synchronises its prepare/commit/abort phases? This would avoid the possibility of corrupting the internal state and producing undefined behaviour.&lt;/p&gt;

&lt;p&gt;But we&apos;re still at least broken on Windows platforms (unless their FS semantics have changed), because we abort the shared transaction before we have closed our in-progress file handles, and so we cannot delete all of the sstables. Not sure what state that leaves us in, but hopefully it would be recovered on restart.&lt;/p&gt;

&lt;p&gt;Ultimately, the child transaction approach still feels easier to reason about for me. &#160;With the right comments, I don&apos;t see why we should worry about people&#160;misusing it for concurrent scenario - and&#160;we could only synchronise the internal methods (and only synchronise externally the transfer method, for clarity).&lt;/p&gt;

&lt;p&gt;On a bikeshedding note, I&apos;m very unconvinced by the name &lt;tt&gt;SSTableTracker&lt;/tt&gt;. It&apos;s generic, and very close to &lt;tt&gt;Tracker&lt;/tt&gt; which is a much more global thing. Perhaps &lt;tt&gt;LifecycleTransactionNewTracker&lt;/tt&gt; or something, to make clear its scope? The variables&#160;wouldn&apos;t need to be renamed, also. I don&apos;t see us ever wanting to back this by something other than a &lt;tt&gt;LifecycleTransaction&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;Probably we should have originally called &lt;tt&gt;LifecycleTransaction&lt;/tt&gt; &lt;tt&gt;LifecycleTxn&lt;/tt&gt;, or simply &lt;tt&gt;SSTableTxn&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16685995" author="stefania" created="Wed, 14 Nov 2018 01:53:06 +0000"  >&lt;p&gt;Looking at the 3.11 code, &lt;tt&gt;StreamReceiveTask&lt;/tt&gt; does synchronize all access to the txn: update/abort/finish. With the proposed patch the same lock is used for track/untrackNew.  So this patch takes care of the txn status at least up to 3.11. Looking briefly at the code on trunk, it seems the txn has been moved to &lt;tt&gt;CassandraStreamReceiver&lt;/tt&gt;. I think the intention was still to synchronize access to it, but I haven&apos;t checked in detail whether that was achieved correctly.&lt;/p&gt;

&lt;p&gt;Ultimately we also need to fix the problem of writers still not having created files when the txn is cleared, or still having files open on Windows.&lt;/p&gt;

&lt;p&gt;If you are confident that child transactions are the best solution I&apos;m not opposed but the same can be achieved with a synchronized transaction and a reference to the txn kept by the writers.&lt;/p&gt;</comment>
                            <comment id="16686209" author="benedict" created="Wed, 14 Nov 2018 08:45:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;If you are confident that child transactions are the best solution I&apos;m not opposed but the same can be achieved with a synchronized transaction and a reference to the txn kept by the writers.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Well,&#160;we&apos;ve seen a&#160;few edge cases now where the synchronised version was difficult&#160;to reason about and left&#160;problematic behaviours, and it might be more brittle in future.&lt;/p&gt;

&lt;p&gt;But if you&apos;re confident you can resolve the remaining issues through&#160;synchronisation (and we can establish if trunk is (effectively) synchronised, or should be),&#160;that has the advantage of already being (almost) done.&lt;/p&gt;</comment>
                            <comment id="16691225" author="stefania" created="Mon, 19 Nov 2018 03:58:57 +0000"  >&lt;p&gt;For trunk, we should probably either introduce a synchronized transaction and add references in the writers, or look into child transactions.&lt;/p&gt;

&lt;p&gt;The patch I proposed is suitable for released branches. I see this ticket is now classified for 4.0 only. In my opinion, there is an issue also for 3.0 and 3.11. The explanation is in my original &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14554?focusedCommentId=16677739&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16677739&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;comment&lt;/a&gt;. Perhaps we should create a different ticket for this problem and commit the patch only to 3.0 and 3.11?&lt;/p&gt;

&lt;p&gt;I also would like to follow up with a more comprehensive approach for trunk but I don&apos;t know when I&apos;ll have time to work on this. I&apos;ll post another update if I do start work.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16691277" author="djoshi3" created="Mon, 19 Nov 2018 05:41:54 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; thanks for submitting a patch. When I originally created this ticket, I had&#160;scoped it for 4.0. I did not investigate it for previous versions. It is fine to use this ticket to address previous versions as well.&lt;/p&gt;</comment>
                            <comment id="16692560" author="stefania" created="Tue, 20 Nov 2018 02:25:13 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi3&quot; class=&quot;user-hover&quot; rel=&quot;djoshi3&quot;&gt;djoshi3&lt;/a&gt; !&lt;/p&gt;</comment>
                            <comment id="16710665" author="benedict" created="Wed, 5 Dec 2018 21:56:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;: Could you take a look at &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...stef1927:db-2633-3.11#diff-5d2d6808d387dcbd1937ee23496ac10aR95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this line&lt;/a&gt;?  It looks like it was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6696&quot; title=&quot;Partition sstables by token range&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6696&quot;&gt;&lt;del&gt;CASSANDRA-6696&lt;/del&gt;&lt;/a&gt;, but I&apos;m not sure why?&lt;/p&gt;

&lt;p&gt;I&apos;ll be posting a 3.0, 3.11 and trunk patch tomorrow.&lt;/p&gt;

&lt;p&gt;Stefania, are you comfortable with calling the new interface &lt;tt&gt;LifecycleNewTracker&lt;/tt&gt;?  Or do you have another proposal?  I&apos;d simply prefer a term that doesn&apos;t clash so strongly with &lt;tt&gt;Tracker&lt;/tt&gt; which is a much more general concept.&lt;/p&gt;</comment>
                            <comment id="16710890" author="stefania" created="Thu, 6 Dec 2018 02:01:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;, I&apos;m fine with renaming the new interface &lt;tt&gt;LifecycleNewTracker&lt;/tt&gt;, or with any other change that you see fit.&lt;/p&gt;</comment>
                            <comment id="16711204" author="krummas" created="Thu, 6 Dec 2018 09:43:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;Marcus Eriksson: Could you take a look at this line? It looks like it was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6696&quot; title=&quot;Partition sstables by token range&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6696&quot;&gt;&lt;del&gt;CASSANDRA-6696&lt;/del&gt;&lt;/a&gt;, but I&apos;m not sure why?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;with 6696 we might create sstablewriters but not write anything to them - say you have 2 disks but flush a single partition, the empty writer is then .abort:ed, but the full transaction is not, so we make sure the files are deleted by untrack:ing them. What I can&apos;t remember is why &lt;tt&gt;SSTableWriter#abort&lt;/tt&gt; is not removing the files though, that feels like it would be the correct solution to the problem...&lt;/p&gt;

&lt;p&gt;edit: We do the same in &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/io/sstable/SSTableRewriter.java#L311&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SSTableRewriter&lt;/a&gt; when we encounter an empty writer&lt;/p&gt;</comment>
                            <comment id="16711307" author="benedict" created="Thu, 6 Dec 2018 11:19:22 +0000"  >&lt;p&gt;Thanks.  I was just a little confused as to why it was in &lt;tt&gt;abort&lt;/tt&gt; - in &lt;tt&gt;SSTableRewriter&lt;/tt&gt; we do this on commit / switchWriter.  I can see now that there&apos;s an invocation of &lt;tt&gt;SSTableMultiWriter.abortOrDie&lt;/tt&gt;  (which invokes &lt;tt&gt;abort&lt;/tt&gt;) in &lt;tt&gt;RangeAwareSSTableWriter&lt;/tt&gt; on commit).  &lt;/p&gt;

&lt;p&gt;Probably this should all be rejigged slightly as you say, moving both of these to &lt;tt&gt;SSTableWriter&lt;/tt&gt;, perhaps with a parameter to &lt;tt&gt;abort&lt;/tt&gt; to indicate you want to do this (because in the case of a full abort it&apos;s preferable to leave cleanup to the &lt;tt&gt;LogFile&lt;/tt&gt;&apos;s abort).&lt;/p&gt;</comment>
                            <comment id="16712803" author="benedict" created="Fri, 7 Dec 2018 12:45:45 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/14554-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/14554-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/14554-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/3e615cf7-a985-448b-9ba0-6d52f9b87eec&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/a74915a5-ea21-49ed-ab0a-389964b606f4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/64915295-ab06-4946-b736-85b799765003&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;AFAICT the CI failures are related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14921&quot; title=&quot;thrift_test.py failures on 3.0 and 3.x branches&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14921&quot;&gt;&lt;del&gt;CASSANDRA-14921&lt;/del&gt;&lt;/a&gt;.  There was a &lt;a href=&quot;https://circleci.com/gh/belliottsmith/cassandra/1032#tests/containers/2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;brief single unit test failure&lt;/a&gt; for one run, but probably environment or timing related.&lt;/p&gt;

&lt;p&gt;This patch is simply a slightly modified and ported version of Stefania&apos;s patch above.  As discussed, this doesn&apos;t necessarily solve the problem perfectly, but it is close enough that it&apos;s worth applying now and worrying about that later.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt;: I would appreciate it if you could take a quick look at &lt;a href=&quot;https://github.com/belliottsmith/cassandra/commit/fd54c420da81ee6ebfa1d29f45b8edc4922c8bdb#diff-374d64d7ac810fe7be021a2ef356c071R216&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt;, as it&apos;s not clear to me why there is a separate synchronised &lt;tt&gt;finishTransaction&lt;/tt&gt; method.  Was there anticipated to be some kind of potential deadlock?&lt;/p&gt;</comment>
                            <comment id="16713129" author="bdeggleston" created="Fri, 7 Dec 2018 17:49:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; I&apos;m afraid I don&apos;t have a great explanation other than&#160;that&apos;s just how it was in StreamReceiveTask before the refactor.&lt;/p&gt;</comment>
                            <comment id="16713138" author="benedict" created="Fri, 7 Dec 2018 18:00:35 +0000"  >&lt;p&gt;Thanks.  I had a suspicion it might have simply been migrated, but I wasn&apos;t quite sure where form.  Looks like it goes all the way back to 2016; I don&apos;t think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; is around anymore?&lt;/p&gt;

&lt;p&gt;I guess we&apos;ll just leave it be; I&apos;m not terribly thrilled at the asymmetry between fully synchronising &lt;tt&gt;abort&lt;/tt&gt; (and hence accesses to &lt;tt&gt;sstables&lt;/tt&gt;), and only synchronising &lt;tt&gt;finishTransaction&lt;/tt&gt; in &lt;tt&gt;finish&lt;/tt&gt; - though this &lt;b&gt;should&lt;/b&gt; be fine, the asymmetry suggests maybe there&apos;s something we&apos;re missing.  Anyway, it certainly maintains the prior behaviour.&lt;/p&gt;</comment>
                            <comment id="16713569" author="djoshi3" created="Sat, 8 Dec 2018 07:04:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; thanks, I have assigned the ticket to you. I can review it and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; please feel free to add yourself as a reviewer too.&lt;/p&gt;</comment>
                            <comment id="16713630" author="benedict" created="Sat, 8 Dec 2018 11:09:38 +0000"  >&lt;p&gt;The bulk of the work was Stefania&apos;s, so I&apos;ll leave myself reviewer.&lt;/p&gt;</comment>
                            <comment id="16714205" author="stefania" created="Mon, 10 Dec 2018 01:44:38 +0000"  >&lt;p&gt;Thanks for the pull requests &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;, they LGTM. Do put both names as authors, since you&apos;ve done quite a fair bit of work too.&lt;/p&gt;</comment>
                            <comment id="16714873" author="benedict" created="Mon, 10 Dec 2018 15:08:38 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt;.  I&apos;ve committed to &lt;a href=&quot;https://github.com/apache/cassandra/commit/84ffcb82a74667b957201f2cdae2d6b308956549&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;84ffcb82a74667b957201f2cdae2d6b308956549&lt;/a&gt; on 3.0 and merged upwards.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13336950">CASSANDRA-16225</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12977"><![CDATA[Adhoc Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vh93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
        <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>