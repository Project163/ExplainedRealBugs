<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13740] Orphan hint file gets created while node is being removed from cluster</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13740</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I have found this new issue during my test, whenever node is being removed then hint file for that node gets written and stays inside the hint directory forever. I debugged the code and found that it is due to the race condition between &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsWriteExecutor.java#L195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HintsWriteExecutor.java::flush &lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsWriteExecutor.java#L106&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HintsWriteExecutor.java::closeWriter &lt;/a&gt;&lt;br/&gt;
. &lt;/p&gt;

&lt;p&gt;&lt;b&gt;Time t1&lt;/b&gt; Node is down, as a result Hints are being written by &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsWriteExecutor.java#L195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HintsWriteExecutor.java::flush &lt;/a&gt;&lt;br/&gt;
&lt;b&gt;Time t2&lt;/b&gt; Node is removed from cluster as a result it calls &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsService.java#L327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HintsService.java-exciseStore &lt;/a&gt; which removes hint files for the node being removed&lt;br/&gt;
&lt;b&gt;Time t3&lt;/b&gt; Mutation stage keeps pumping Hints through &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsService.java#L145&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HintService.java::write &lt;/a&gt; which again calls &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsWriteExecutor.java#L215&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HintsWriteExecutor.java::flush &lt;/a&gt; and new orphan file gets created&lt;/p&gt;

&lt;p&gt;I was writing a new dtest for &lt;/p&gt;
{CASSANDRA-13562, CASSANDRA-13308}
&lt;p&gt; and that helped me reproduce this new bug. I will submit patch for this new dtest later.&lt;/p&gt;

&lt;p&gt;I also tried following to check how this orphan hint file responds:&lt;br/&gt;
1. I tried &lt;tt&gt;nodetool truncatehints &amp;lt;node&amp;gt;&lt;/tt&gt; but it fails as node is no longer part of the ring&lt;br/&gt;
2. I then tried &lt;tt&gt;nodetool truncatehints&lt;/tt&gt;, that still doesn&#8217;t remove hint file because it is not yet included in the &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsStore.java#L53&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dispatchDequeue &lt;/a&gt;&lt;/p&gt;


&lt;p&gt;Reproducible steps:&lt;br/&gt;
Please find dTest python file &lt;tt&gt;gossip_hang_test.py&lt;/tt&gt; attached which reproduces this bug.&lt;/p&gt;

&lt;p&gt;Solution:&lt;br/&gt;
This is due to race condition as mentioned above. Since &lt;tt&gt;HintsWriteExecutor.java&lt;/tt&gt; creates thread pool with only 1 worker, so solution becomes little simple. Whenever we &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsService.java#L303&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HintService.java::excise &lt;/a&gt; a host, just store it in-memory, and check for already evicted host inside &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsWriteExecutor.java#L215&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HintsWriteExecutor.java::flush &lt;/a&gt;. If already evicted host is found then ignore hints.&lt;/p&gt;

&lt;p&gt;Jaydeep&lt;/p&gt;</description>
                <environment></environment>
        <key id="13092315">CASSANDRA-13740</key>
            <summary>Orphan hint file gets created while node is being removed from cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chovatia.jaydeep@gmail.com">Jaydeepkumar Chovatia</assignee>
                                    <reporter username="chovatia.jaydeep@gmail.com">Jaydeepkumar Chovatia</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Aug 2017 22:04:12 +0000</created>
                <updated>Wed, 16 Mar 2022 11:08:36 +0000</updated>
                            <resolved>Mon, 30 Apr 2018 18:06:01 +0000</resolved>
                                        <fixVersion>3.0.17</fixVersion>
                    <fixVersion>3.11.3</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Hints</component>
                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                                        <aggregatetimeremainingestimate seconds="0">0h</aggregatetimeremainingestimate>
                                        <aggregatetimespent seconds="600">10m</aggregatetimespent>
                                    <comments>
                            <comment id="16113625" author="chovatia.jaydeep@gmail.com" created="Thu, 3 Aug 2017 22:37:26 +0000"  >&lt;p&gt;Please find patch with this fix attached.&lt;/p&gt;</comment>
                            <comment id="16114869" author="jay.zhuang" created="Fri, 4 Aug 2017 19:30:38 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=chovatia.jaydeep%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;chovatia.jaydeep@gmail.com&quot;&gt;chovatia.jaydeep@gmail.com&lt;/a&gt; nice catch. One comment about your patch, I don&apos;t think it&apos;s a good idea to have &lt;tt&gt;static final Set&amp;lt;UUID&amp;gt; evictedHostIds&lt;/tt&gt; set in &lt;tt&gt;HintsStore&lt;/tt&gt;, as the HintsStore instance is for one hints file. How about adding a field &lt;tt&gt;private boolean isEvicted = false;&lt;/tt&gt;? To indicate if the target host is evicted or not.&lt;/p&gt;</comment>
                            <comment id="16115027" author="chovatia.jaydeep@gmail.com" created="Fri, 4 Aug 2017 22:11:23 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt; for review comments.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;HintsStore&lt;/tt&gt; object may get created multiple times for same &lt;tt&gt;hostId&lt;/tt&gt; as following:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;time t1&lt;/b&gt; removenode thread calls &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsService.java#L327&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;catalog.exciseStore &lt;/a&gt;&lt;br/&gt;
and it removes from &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsCatalog.java#L41&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Map&amp;lt;UUID, HintsStore&amp;gt; stores &lt;/a&gt;&lt;br/&gt;
&lt;b&gt;time t2&lt;/b&gt; HintWriter thread calls &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/hints/HintsCatalog.java#L85&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HintsStore::get &lt;/a&gt; which creates a new &lt;tt&gt;HintStore&lt;/tt&gt; object and will write hints again.&lt;/p&gt;

&lt;p&gt;For this bug specifically above mentioned scenario is been happening, please let me know your comments.&lt;/p&gt;

&lt;p&gt;I think we should atleast move &lt;tt&gt;static final Set&amp;lt;UUID&amp;gt; evictedHostIds&lt;/tt&gt; from &lt;tt&gt;HintStore.java&lt;/tt&gt; to &lt;tt&gt;HintService.java&lt;/tt&gt; which is a singleton?&lt;/p&gt;</comment>
                            <comment id="16115152" author="chovatia.jaydeep@gmail.com" created="Sat, 5 Aug 2017 00:13:48 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt; Please find patch file &quot;13740-2_3.0.15.txt&quot; attached with your review comments incorporated.&lt;/p&gt;</comment>
                            <comment id="16119094" author="githubbot" created="Tue, 8 Aug 2017 22:10:01 +0000"  >&lt;p&gt;GitHub user jaydeepkumar1984 opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/136&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13740&quot; title=&quot;Orphan hint file gets created while node is being removed from cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13740&quot;&gt;&lt;del&gt;CASSANDRA-13740&lt;/del&gt;&lt;/a&gt; orphan hint file get created&lt;/p&gt;



&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/jaydeepkumar1984/cassandra&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jaydeepkumar1984/cassandra&lt;/a&gt; 13740-3.0&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/136.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/136.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #136&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 993d5891e69f5cda402ae2158e06914f653a644d&lt;br/&gt;
Author: Jaydeepkumar Chovatia &amp;lt;chovatia.jaydeep@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-08-03T22:34:26Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13740&quot; title=&quot;Orphan hint file gets created while node is being removed from cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13740&quot;&gt;&lt;del&gt;CASSANDRA-13740&lt;/del&gt;&lt;/a&gt; orphan hint file get created&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16119106" author="chovatia.jaydeep@gmail.com" created="Tue, 8 Aug 2017 22:19:00 +0000"  >&lt;p&gt;Please find pull request against Cassandra-3.0 here: &lt;a href=&quot;https://github.com/apache/cassandra/pull/136/commits/993d5891e69f5cda402ae2158e06914f653a644d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/136/commits/993d5891e69f5cda402ae2158e06914f653a644d&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16119799" author="iamaleksey" created="Wed, 9 Aug 2017 12:24:19 +0000"  >&lt;p&gt;The patch likely works, but I think we can do better.&lt;/p&gt;

&lt;p&gt;Some of the issues I have with it:&lt;br/&gt;
1. It introduces a dependency on &lt;tt&gt;HintsService&lt;/tt&gt; and &lt;tt&gt;StorageService&lt;/tt&gt; to &lt;tt&gt;HintsWriteExecutor&lt;/tt&gt;&lt;br/&gt;
2. It introduces a dependency on &lt;tt&gt;HintsService&lt;/tt&gt; to &lt;tt&gt;HintsStore&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;When designing the current iteration of hints I was very careful to design the system in a top-down way without any interleaving that&#8217;s avoidable. Each class is a dumb as possible on its own, and as you go up, you just compose dumb classes that by themselves know nothing of layers above them.&lt;/p&gt;

&lt;p&gt;As for the problem itself, we do acknowledge that &#8220;The worst that can happen if we don&apos;t get everything right is a hints file (or two) remaining undeleted.&#8221; - comments to &lt;tt&gt;excise()&lt;/tt&gt;, it&#8217;s more of a known limitation than a bug. But of course we can improve on it. What is a problem, however, is the inability to programmatically remove those orphan files via JMX. &lt;tt&gt;nodetool truncatehints&lt;/tt&gt; should get results no matter what, and it should be fixed.&lt;/p&gt;

&lt;p&gt;If we want to deal with the orphans for sure - and I don&#8217;t see why not improve this as well - I suggest you do so in a different way. Perhaps as last step of &lt;tt&gt;excise()&lt;/tt&gt; schedule an task - on &lt;tt&gt;ScheduledExecutors.optionalTasks&lt;/tt&gt; to clean up any orphans, if any, after some delay.&lt;/p&gt;</comment>
                            <comment id="16120714" author="chovatia.jaydeep@gmail.com" created="Wed, 9 Aug 2017 21:56:23 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; for the code review. I will change it as per your suggestion and will provide updated patch.&lt;/p&gt;</comment>
                            <comment id="16124249" author="chovatia.jaydeep@gmail.com" created="Fri, 11 Aug 2017 23:17:45 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have modified code as per your review comments, please find it attached &quot;13740-3.0.15.txt&quot;&lt;br/&gt;
Also please find same patch here: &lt;a href=&quot;https://github.com/jaydeepkumar1984/cassandra/commit/173fce0362246595d26b24196d6690223d132d5e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jaydeepkumar1984/cassandra/commit/173fce0362246595d26b24196d6690223d132d5e&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I will create patch for 3.11 as well as will run &lt;tt&gt;circleci&lt;/tt&gt; after receiving your review comments.&lt;/p&gt;

&lt;p&gt;Jaydeep&lt;/p&gt;</comment>
                            <comment id="16135814" author="iamaleksey" created="Mon, 21 Aug 2017 21:01:48 +0000"  >&lt;p&gt;Hey. There are a few &lt;a href=&quot;https://wiki.apache.org/cassandra/CodeStyle&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code style&lt;/a&gt; issues: we don&apos;t use &lt;tt&gt;final&lt;/tt&gt; for arguments and local variables, brackets go to new lines always. And the patch doesn&apos;t wait for &lt;tt&gt;closeWriter&lt;/tt&gt; future to be completed.&lt;/p&gt;

&lt;p&gt;And a more interesting issue is that of the delay. &lt;tt&gt;RING_DELAY&lt;/tt&gt; doesn&apos;t have anything to do with hints. What does is write timeouts, and &lt;tt&gt;MessagingService&lt;/tt&gt; &apos;s timeout reporter the callbacks expiring map firing - that&apos;s where the race ultimately is.&lt;/p&gt;

&lt;p&gt;Also, we aren&apos;t fixing the issue of &lt;tt&gt;nodetool truncatehints&lt;/tt&gt; not being able to clean up after we excise.&lt;/p&gt;

&lt;p&gt;The more I think about it, the more I&apos;m inclined to just correct that last issue and leave everything else be as is (and also commit your unit tests, thanks for those).&lt;/p&gt;</comment>
                            <comment id="16140263" author="chovatia.jaydeep@gmail.com" created="Thu, 24 Aug 2017 16:29:05 +0000"  >&lt;p&gt;Thanks for the review comments, I will change it and send updated one soon.&lt;/p&gt;</comment>
                            <comment id="16144419" author="chovatia.jaydeep@gmail.com" created="Mon, 28 Aug 2017 22:00:27 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tuxslayer&quot; class=&quot;user-hover&quot; rel=&quot;tuxslayer&quot;&gt;tuxslayer&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Isn&#8217;t the race condition is as following:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Thread T1 - Time 1:&lt;/b&gt; Removes &lt;tt&gt;HintStore&lt;/tt&gt; by calling &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/service/StorageService.java#L2268&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;HintsService.instance.excise &lt;/a&gt; but&lt;br/&gt;
at this time node has not yet been removed from &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/service/StorageService.java#L133&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tokenMetadata  &lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Thread T2 - Time 2:&lt;/b&gt; Mutation stage does a lookup to &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/service/StorageProxy.java#L2617&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tokenMetadata  &lt;/a&gt; and finds node as valid hence it dumps hint for it.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Thread T1 - Time 3:&lt;/b&gt; Now removes node from &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/service/StorageService.java#L2270&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tokenMetadata  &lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Hence I decided it is safer to sleep for &lt;tt&gt;StorageService.RING_DELAY&lt;/tt&gt; and then schedule optional &lt;tt&gt;removeOrphanHintFiles&lt;/tt&gt;  task. Please let me know your comments.&lt;/p&gt;

&lt;p&gt;I have also incorporated your review comment, please find updated patch attached as well as here: &lt;a href=&quot;https://github.com/jaydeepkumar1984/cassandra/commit/16d4ab3316ab71a9a3b96ab67944384092be40ca&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jaydeepkumar1984/cassandra/commit/16d4ab3316ab71a9a3b96ab67944384092be40ca&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Jaydeep&lt;/p&gt;</comment>
                            <comment id="16162052" author="chovatia.jaydeep@gmail.com" created="Mon, 11 Sep 2017 21:36:49 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Can you please review my latest patch?&lt;/p&gt;

&lt;p&gt;Jaydeep&lt;/p&gt;</comment>
                            <comment id="16164951" author="iamaleksey" created="Wed, 13 Sep 2017 16:57:42 +0000"  >&lt;p&gt;A bit busy currently, sorry. Will have a look as soon as I can.&lt;/p&gt;</comment>
                            <comment id="16387326" author="chovatia.jaydeep@gmail.com" created="Tue, 6 Mar 2018 05:47:11 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;A gentle ping. If you have some time then can you please help me close this?&lt;/p&gt;

&lt;p&gt;&#160;Jaydeep&lt;/p&gt;</comment>
                            <comment id="16400985" author="iamaleksey" created="Thu, 15 Mar 2018 19:19:17 +0000"  >&lt;p&gt;Sure. So what the current patch is doing is it does excise, and then, in essence, schedules another excise in &lt;tt&gt;RING_DELAY&lt;/tt&gt;?&lt;/p&gt;

&lt;p&gt;In other words, we simply don&apos;t trust the immediate excise, and rely on the follow-up one. In that case, to make sure that hints for writes that will time out at some later point get deleted from disk, shouldn&apos;t we just say &quot;alright, let&apos;s just delay the first excise, instead of doing the immediate one and then another one&quot;?&lt;/p&gt;</comment>
                            <comment id="16400994" author="iamaleksey" created="Thu, 15 Mar 2018 19:26:21 +0000"  >&lt;p&gt;And the changes to &lt;tt&gt;deleteAllHints()&lt;/tt&gt; I don&apos;t fully understand. I don&apos;t think it&apos;s the responsibility of the method to close any writers. The contract is (as I understand it) - please remove all written hints files at this point. One problem is that for catalogues that aren&apos;t loaded, if some files are remaining, they won&apos;t be deleted - but this change doesn&apos;t address it. More importantly, I think that with excise fixed, that would be less of a problem and probably not needed to fix..&lt;/p&gt;

&lt;p&gt;So let&apos;s leave &lt;tt&gt;deleteAllHints()&lt;/tt&gt; alone. And also leave excise more or less alone, but call it instead at the end of &lt;tt&gt;StorageProxy.excise()&lt;/tt&gt;, with a delay. Not sure why you picked &lt;tt&gt;RING_DELAY&lt;/tt&gt; for the delay though.. can you explain? &lt;/p&gt;</comment>
                            <comment id="16402241" author="chovatia.jaydeep@gmail.com" created="Fri, 16 Mar 2018 17:40:26 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; for the review.&lt;/p&gt;

&lt;p&gt;Reason behind &lt;tt&gt;RING_DELAY&lt;/tt&gt; is as following, in this fix one thing is clear that we have to delay &lt;tt&gt;StorageProxy.excise()&lt;/tt&gt; which means we have to put some sleep. So we have two options to put sleep:&lt;br/&gt;
 1. Hardcode some random value say for example delay &lt;tt&gt;StorageProxy.excise()&lt;/tt&gt; for 10 seconds&lt;br/&gt;
 OR&lt;br/&gt;
 2. Other nodes in the ring will no longer accept writes once they learn that given node is no longer part of the ring. Hence I have used &lt;tt&gt;RING_DELAY&lt;/tt&gt; which is general delay used at &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/gms/Gossiper.java#L553&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;many places&lt;/a&gt; and after this delay we can assume ring has&#160;stabilized. So my theory is that once ring has&#160;stabilized then everyone in the ring would have learnt about node that just left and at this time it is safe to do {{StorageProxy.excise().&#160;}}Please let me know if my understanding is not correct, I can change it to some hardcoded value say 20 seconds.&lt;/p&gt;

&lt;p&gt;I will incorporate other code review comments and will send you updated patch soon.&lt;/p&gt;</comment>
                            <comment id="16405567" author="chovatia.jaydeep@gmail.com" created="Mon, 19 Mar 2018 22:57:14 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please find updated patch here:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...jaydeepkumar1984:13740-trunk?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...jaydeepkumar1984:CASSANDRA-13740_1?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jaydeepkumar1984/cassandra/46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jaydeepkumar1984/cassandra/44&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Jaydeep&lt;/p&gt;</comment>
                            <comment id="16458817" author="iamaleksey" created="Mon, 30 Apr 2018 18:05:44 +0000"  >&lt;p&gt;Made some changes and committed to 3.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/b2f6ce961f38a3e4cd744e102026bf7a471056c9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;b2f6ce961f38a3e4cd744e102026bf7a471056c9&lt;/a&gt; and merged upwards.&lt;/p&gt;

&lt;p&gt;Changes made:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;fixed &lt;tt&gt;excise()&lt;/tt&gt; to properly handle non-existing stores instead of re-initializing them&lt;/li&gt;
	&lt;li&gt;changed the delay to be min rpc timeout + write rpc timeout, which roughly the time you may expect a new hint written after node decom&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thank you for you patience and for the added tests.&lt;/p&gt;</comment>
                            <comment id="16458820" author="chovatia.jaydeep@gmail.com" created="Mon, 30 Apr 2018 18:08:50 +0000"  >&lt;p&gt;Thank&#160;You!!!&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12884139" name="13740-3.0.15.txt" size="9899" author="chovatia.jaydeep@gmail.com" created="Mon, 28 Aug 2017 22:01:11 +0000"/>
                            <attachment id="12880316" name="gossip_hang_test.py" size="3052" author="chovatia.jaydeep@gmail.com" created="Thu, 3 Aug 2017 22:03:06 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="13167447">CASSANDRA-14535</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[chovatia.jaydeep@gmail.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 29 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ie9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>