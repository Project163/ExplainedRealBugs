<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:57:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10198] 3.0 hints should be streamed on decomission</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10198</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6230&quot; title=&quot;Write hints to flat files instead of the system.hints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6230&quot;&gt;&lt;del&gt;CASSANDRA-6230&lt;/del&gt;&lt;/a&gt; added all the necessary pieces in the initial release, but streaming itself didn&apos;t make it in time.&lt;/p&gt;

&lt;p&gt;Now that hints are stored in flat files, we cannot just stream hints sstables. Instead we need to handoff hints files.&lt;/p&gt;

&lt;p&gt;Essentially we need to rewrite &lt;tt&gt;StorageService::streamHints&lt;/tt&gt; to be &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6230&quot; title=&quot;Write hints to flat files instead of the system.hints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6230&quot;&gt;&lt;del&gt;CASSANDRA-6230&lt;/del&gt;&lt;/a&gt; aware.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;HintMessage&lt;/tt&gt; and &lt;tt&gt;HintVerbHandler&lt;/tt&gt; can already handle hints targeted for other nodes (see javadoc for both, it&apos;s documented reasonably).&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;HintsDispatcher&lt;/tt&gt; also takes hostId as an argument, and can stream any hints to any nodes.&lt;/p&gt;

&lt;p&gt;The building blocks are all there - we just need &lt;tt&gt;StorageService::streamHints&lt;/tt&gt; to pick the optimal candidate for each file and use &lt;tt&gt;HintsDispatcher&lt;/tt&gt; to stream the files.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12858992">CASSANDRA-10198</key>
            <summary>3.0 hints should be streamed on decomission</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Aug 2015 14:11:58 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:58 +0000</updated>
                            <resolved>Fri, 18 Sep 2015 18:19:23 +0000</resolved>
                                        <fixVersion>3.0.0 rc1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14725406" author="krummas" created="Tue, 1 Sep 2015 13:39:35 +0000"  >&lt;p&gt;branch here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/10198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/10198&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;will mark patchavail once ci has run&lt;/p&gt;</comment>
                            <comment id="14725435" author="krummas" created="Tue, 1 Sep 2015 14:01:46 +0000"  >&lt;p&gt;a dtest is pushed &lt;a href=&quot;https://github.com/krummas/cassandra-dtest/commits/marcuse/10198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; as well, it fails for other reasons sometimes during decom, i will look into that further&lt;/p&gt;</comment>
                            <comment id="14726959" author="krummas" created="Wed, 2 Sep 2015 08:05:15 +0000"  >&lt;p&gt;CI runs:&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/krummas-marcuse-10198-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/krummas-marcuse-10198-dtest/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/krummas-marcuse-10198-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/krummas-marcuse-10198-testall/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14738772" author="krummas" created="Thu, 10 Sep 2015 13:49:08 +0000"  >&lt;p&gt;and dtest is &lt;a href=&quot;https://github.com/krummas/cassandra-dtest/commits/marcuse/10198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fixed &lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14742703" author="iamaleksey" created="Sun, 13 Sep 2015 22:26:06 +0000"  >&lt;p&gt;1. If we were to continue using an &lt;tt&gt;Iterable&amp;lt;Future&amp;gt;&lt;/tt&gt; there, then the Java 8 way to deal with streams would be to use a collector (&lt;tt&gt;Collectors.toList()&lt;/tt&gt; in this case)&lt;br/&gt;
2. However, in Java 8, we should use a &lt;tt&gt;CompletableFuture&lt;/tt&gt; here, and not an &lt;tt&gt;Iterable&lt;/tt&gt; of &lt;tt&gt;Future&lt;/tt&gt;, or a single future.&lt;br/&gt;
3. We are picking just one destination for hints. Which is fine, I guess. Yet we potentially use multiple threads to deliver to the same node, and thus disrespect the configured rate limit, which is per-destination. These should be serialized.&lt;br/&gt;
4. Failure to deliver is completely ignored. We must deliver all hints before returning, as this has implications for batchlog-generated hints.&lt;br/&gt;
5. Please add some documentation for the method. On the level of &lt;tt&gt;excise&lt;/tt&gt; javadoc at least.&lt;/p&gt;</comment>
                            <comment id="14743427" author="krummas" created="Mon, 14 Sep 2015 12:12:47 +0000"  >&lt;p&gt;Force pushed a new version to the same repo&lt;/p&gt;

&lt;p&gt;It should address all your comments.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We must deliver all hints before returning&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Patch has an upper limit to how many times we retry before failing - do we want to retry forever?&lt;/p&gt;</comment>
                            <comment id="14744041" author="iamaleksey" created="Mon, 14 Sep 2015 19:00:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;Patch has an upper limit to how many times we retry before failing - do we want to retry forever?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not sure. But failure should be more obvious than just an error log line. We should probably fail the decom?&lt;/p&gt;</comment>
                            <comment id="14744981" author="krummas" created="Tue, 15 Sep 2015 07:15:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;We should probably fail the decom?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yup, pushed a new commit which throws exception if it fails to stream hints&lt;/p&gt;</comment>
                            <comment id="14863273" author="iamaleksey" created="Fri, 18 Sep 2015 13:22:43 +0000"  >&lt;p&gt;The patch is good as is, almost, with the exception of one issue: if hints dispatch were paused, transfer wouldn&apos;t work, so we need to explicitly resume dispatch before doing all this, just in case.&lt;/p&gt;

&lt;p&gt;Otherwise the suggestions I pushed &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commit/be5c42ef184dd98c4b7bf812b407ad920685aa5f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; are mostly cosmetic, and we can commit without them:&lt;/p&gt;

&lt;p&gt;1. moved checking for catalog emptiness to &lt;tt&gt;HintsCatalog::hasFiles&lt;/tt&gt;, closer to the data, and to match &lt;tt&gt;HintsStore::hasFiles&lt;/tt&gt;&lt;br/&gt;
2. renamed &apos;decommission&apos; to &apos;transfer&apos;&lt;br/&gt;
3. removed the &lt;tt&gt;hasFiles&lt;/tt&gt; filter as it&apos;s redundant - if there are no files to stream, &lt;tt&gt;DispatchHintsTask::run&lt;/tt&gt; will simply be a NOOP&lt;br/&gt;
4. for consistency with &lt;tt&gt;HintsDispatcher&lt;/tt&gt; itself, only retry once on failure (after a fixed delay of 10 seconds, here)&lt;/p&gt;
</comment>
                            <comment id="14876083" author="iamaleksey" created="Fri, 18 Sep 2015 18:19:08 +0000"  >&lt;p&gt;CI results: &lt;a href=&quot;http://cassci.datastax.com/job/iamaleksey-10198-3.0-dtest/2/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; and &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/iamaleksey/job/iamaleksey-10198-3.0-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/959b96efee613363fde28de1e2b34aa9201efd7a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;959b96efee613363fde28de1e2b34aa9201efd7a&lt;/a&gt; to cassandra-3.0 and merged with trunk.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="14876134" author="iamaleksey" created="Fri, 18 Sep 2015 18:49:34 +0000"  >&lt;p&gt;Pushed the dtest commit too, &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/commit/603d8b3900794591db1821459bfb0a7ab0ed612a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 9 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jejj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>