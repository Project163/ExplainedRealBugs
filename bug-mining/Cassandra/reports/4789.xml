<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:07:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10130] Node failure during 2i update after streaming can have incomplete 2i when restarted</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10130</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Since MV/2i update happens after SSTables are received, node failure during MV/2i update can leave received SSTables live when restarted while MV/2i are partially up to date.&lt;/p&gt;

&lt;p&gt;We can add some kind of tracking mechanism to automatically rebuild at the startup, or at least warn user when the node restarts.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12857283">CASSANDRA-10130</key>
            <summary>Node failure during 2i update after streaming can have incomplete 2i when restarted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="adelapena">Andres de la Pe&#241;a</assignee>
                                    <reporter username="yukim">Yuki Morishita</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Aug 2015 17:40:50 +0000</created>
                <updated>Fri, 7 Jul 2023 22:58:19 +0000</updated>
                            <resolved>Fri, 23 Jun 2017 10:06:51 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Coordination</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14709293" author="tjake" created="Mon, 24 Aug 2015 13:35:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; I don&apos;t think this is an issue.  We have a transaction for the StreamingFileTask that only succeeds if all the mutations were applied.  If the node dies during then the sstable isn&apos;t marked finished AFAIK.  &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; If the transaction doesn&apos;t succeed would the sstables be used or cleaned up on restart? I would expect the latter.&lt;/p&gt;</comment>
                            <comment id="14709298" author="benedict" created="Mon, 24 Aug 2015 13:38:58 +0000"  >&lt;p&gt;The latter. Unless there were disk corruption of the transaction log detected, in which case it is pessimistic and assumes they should be kept. We could change this behaviour for MVs, and default to deletion instead.&lt;/p&gt;</comment>
                            <comment id="14709306" author="tjake" created="Mon, 24 Aug 2015 13:43:47 +0000"  >&lt;p&gt;Thx, closing&lt;/p&gt;</comment>
                            <comment id="15957404" author="pauloricardomg" created="Wed, 5 Apr 2017 18:38:26 +0000"  >&lt;p&gt;I&apos;m afraid this is still an issue for 2is though, since if a node fails &lt;a href=&quot;https://github.com/apache/cassandra/blob/af3fe39dcabd9ef77a00309ce6741268423206df/src/java/org/apache/cassandra/streaming/StreamReceiveTask.java#L212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;during 2i rebuild after stream&lt;/a&gt; the sstables are already live in the indexed table so 2is will not be fixed by a subsequent repair. Reopening and updating title.&lt;/p&gt;</comment>
                            <comment id="15989138" author="adelapena" created="Fri, 28 Apr 2017 16:51:06 +0000"  >&lt;p&gt;The most straightforward solution would be to use the write path, as it is done with materialized views and CDC. &lt;/p&gt;

&lt;p&gt;As we want to avoid this, we could use &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/10130-trunk/src/java/org/apache/cassandra/db/SystemKeyspace.java#L147&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a new table&lt;/a&gt; in the system keyspace to keep track of indexes that should be rebuilt before start. So, we could mark the indexes to be rebuilt &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/10130-trunk/src/java/org/apache/cassandra/streaming/StreamReceiveTask.java#L231&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;right before&lt;/a&gt; adding the sstables to the column family and rebuilding the index. If everything is ok, we &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/10130-trunk/src/java/org/apache/cassandra/streaming/StreamReceiveTask.java#L238&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;unmark&lt;/a&gt; the indexes for rebuilding. Otherwise, if the node dies, the next node start would &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/10130-trunk/src/java/org/apache/cassandra/index/internal/CassandraIndex.java#L173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;detect&lt;/a&gt; the indexes as marked for rebuilding and would throw a full index rebuild.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/adelapena/cassandra/commit/cd5c3faab5d59cc75b98a8151f6245034c634e53&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Here&lt;/a&gt; is the draft of the approach.&lt;/p&gt;</comment>
                            <comment id="16002728" author="adelapena" created="Tue, 9 May 2017 14:03:29 +0000"  >&lt;p&gt;And &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/compare/master...adelapena:CASSANDRA-10130&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here is a dtest&lt;/a&gt; reproducing the problem and testing the patch. &lt;/p&gt;

&lt;p&gt;It uses byteman to simulate an index building failure during the load of SSTables with sstableloader. It checks that after the sstableloader failure the table rows are loaded but not indexed, and the index is marked for future rebuilding. Then, it restarts the node and checks that the index is rebuilt and not marked for rebuilding anymore.&lt;/p&gt;</comment>
                            <comment id="16006528" author="pauloricardomg" created="Thu, 11 May 2017 14:35:39 +0000"  >&lt;p&gt;The approach looks mostly good, great job! I was thinking we could perhaps merge the &lt;tt&gt;IndexInfo&lt;/tt&gt; and &lt;tt&gt;indexes_to_rebuild&lt;/tt&gt; table into a single &lt;tt&gt;index_build_status&lt;/tt&gt; table, which has the same schema as &lt;tt&gt;IndexInfo&lt;/tt&gt; plus an additional &lt;tt&gt;status&lt;/tt&gt; field with the possible values and implications:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;not_built&lt;/tt&gt; or not present: throws unavailable exception when queried&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;built&lt;/tt&gt;: serves requests normally&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;rebuilding&lt;/tt&gt;: serves requests normally on already started node, rebuild on restart.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;needs_rebuild&lt;/tt&gt;: serves requests normally on already started node while printing a periodic message asking the user to run a manual rebuild, rebuilds on restart.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;WDYT?&lt;/p&gt;

&lt;p&gt;We would need to deprecate the &lt;tt&gt;IndexInfo&lt;/tt&gt; table for a couple of major versions and also require a migration of values from the &lt;tt&gt;IndexInfo&lt;/tt&gt; to the &lt;tt&gt;index_build_status&lt;/tt&gt; table though, see &lt;tt&gt;LegacyHintsMigrator&lt;/tt&gt; and &lt;tt&gt;LegacyBatchlogMigrator&lt;/tt&gt; - we should at some point generalize these migrations.&lt;/p&gt;</comment>
                            <comment id="16006895" author="sbtourist" created="Thu, 11 May 2017 17:56:29 +0000"  >&lt;p&gt;I had a quick look at this one and I think we could avoid adding yet another system table by just reusing the &lt;tt&gt;BUILT_INDEXES&lt;/tt&gt; table and following the same pattern used by &lt;tt&gt;SIM#rebuildIndexesBlocking()&lt;/tt&gt;, that is:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Call &lt;tt&gt;SystemKeyspace#setIndexRemoved()&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Build index.&lt;/li&gt;
	&lt;li&gt;Call &lt;tt&gt;SystemKeyspace#setIndexBuilt()&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thoughts? Am I missing anything actually requiring a new table?&lt;/p&gt;</comment>
                            <comment id="16007042" author="adelapena" created="Thu, 11 May 2017 19:27:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sbtourist&quot; class=&quot;user-hover&quot; rel=&quot;sbtourist&quot;&gt;sbtourist&lt;/a&gt;, I think you are right, this could make things much easier &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Here is the updated patch:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I have also updated &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/compare/master...adelapena:CASSANDRA-10130&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the dtest&lt;/a&gt; to be sure that it is still possible to query the index when it is not marked as built.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;, what do you think? Are we missing something? The idea about adding a status to the index info table looked nice for future changes. At least we could have renamed the column containing the keyspace name as &lt;tt&gt;keyspace_name&lt;/tt&gt; instead of &lt;tt&gt;table_name&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16007507" author="pauloricardomg" created="Fri, 12 May 2017 01:45:35 +0000"  >&lt;p&gt;Good call &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sbtourist&quot; class=&quot;user-hover&quot; rel=&quot;sbtourist&quot;&gt;sbtourist&lt;/a&gt;! I thought setting the index removed would make the queries unavailable so I haven&apos;t considered this route, my bad!&lt;/p&gt;

&lt;p&gt;There is still a slight possibility of race though if an index is being built by some other thread and we mark the index as built after the streaming operation but before the  other thread build is completed.&lt;/p&gt;

&lt;p&gt;Perhaps we could have a counter incremented each time an index starts rebuilding and only call &lt;tt&gt;markIndexBuilt&lt;/tt&gt; if this counter is zero when the index finishes rebuilding?&lt;/p&gt;

&lt;p&gt;Dtest looks good!&lt;/p&gt;</comment>
                            <comment id="16007956" author="adelapena" created="Fri, 12 May 2017 10:59:28 +0000"  >&lt;p&gt;Good catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;. We could make the &lt;tt&gt;SecondaryIndexManager#markIndexRemoved&lt;/tt&gt;/&lt;tt&gt;SecondaryIndexManager#markIndexBuilt&lt;/tt&gt; pair rely on these per index counters, and make sure that all index rebuildings use them.&lt;/p&gt;</comment>
                            <comment id="16007972" author="sbtourist" created="Fri, 12 May 2017 11:14:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;There is still a slight possibility of race though if an index is being built by some other thread and we mark the index as built after the streaming operation but before the other thread build is completed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There&apos;s actually a very probable race in case of parallel repairs when multiple streaming tasks for the same table are created. We should either find a better (race-free) place where to put those calls, or employ a guarded counter as suggested.&lt;/p&gt;</comment>
                            <comment id="16008617" author="adelapena" created="Fri, 12 May 2017 19:40:16 +0000"  >&lt;p&gt;I have updated the patch to use counters, as suggested by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;To complement &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/55c1fbad6116b8a8b9ccc86ce9fa50396d6bc522/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L421&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SecondaryIndexManager#markIndexBuilt&lt;/tt&gt;&lt;/a&gt; and &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/55c1fbad6116b8a8b9ccc86ce9fa50396d6bc522/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L432&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SecondaryIndexManager#markIndexRemoved&lt;/tt&gt;&lt;/a&gt; I have added a new method &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/55c1fbad6116b8a8b9ccc86ce9fa50396d6bc522/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L410&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SecondaryIndexManager#markIndexBuilding&lt;/tt&gt;&lt;/a&gt; to be called before any index (re)building. When this method is called it increases a &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/55c1fbad6116b8a8b9ccc86ce9fa50396d6bc522/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L1216&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SecondaryIndexManager.PendingIndexBuildsCounter&lt;/tt&gt;&lt;/a&gt; associated to the index, and if the counter value is zero it removes the index from the &lt;tt&gt;IndexInfo&lt;/tt&gt; table. Later, after the index (re)building has successfully ended, a call to the modified &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/55c1fbad6116b8a8b9ccc86ce9fa50396d6bc522/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L421&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SecondaryIndexManager#markIndexBuilt&lt;/tt&gt;&lt;/a&gt; will decrease the counter and, if it is zero, it will add the index to the &lt;tt&gt;IndexInfo&lt;/tt&gt; table.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure about if the assert in &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/55c1fbad6116b8a8b9ccc86ce9fa50396d6bc522/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L1236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SecondaryIndexManager.PendingIndexBuildsCounter#decrease()&lt;/tt&gt;&lt;/a&gt; is too aggressive. The idea is to easily detect calls to &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/55c1fbad6116b8a8b9ccc86ce9fa50396d6bc522/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L421&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SecondaryIndexManager#markIndexBuilt&lt;/tt&gt;&lt;/a&gt; that are not preceded by a call to &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/55c1fbad6116b8a8b9ccc86ce9fa50396d6bc522/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L410&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SecondaryIndexManager#markIndexBuilding&lt;/tt&gt;&lt;/a&gt;, but maybe it could be replaced by a warning, or even write the &lt;tt&gt;IndexInfo&lt;/tt&gt; table anyway. What do you think?&lt;/p&gt;

&lt;p&gt;Also, it&apos;s worth noting that, with this approach, if any (re)building fails for a index, it will get inevitably marked for rebuilding at restart, even if an index rebuilding is manually run. Should we avoid this? If so, how could we avoid race conditions between these manual (re)buildings and those produced by streaming?&lt;/p&gt;</comment>
                            <comment id="16011169" author="pauloricardomg" created="Mon, 15 May 2017 19:24:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;To complement SecondaryIndexManager#markIndexBuilt and SecondaryIndexManager#markIndexRemoved I have added a new method SecondaryIndexManager#markIndexBuilding to be called before any index (re)building. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The approach looks good, but do we really need a &lt;tt&gt;PendingIndexBuildsCounter&lt;/tt&gt; class? I thought it would be simpler to make &lt;tt&gt;pendingBuilds&lt;/tt&gt; a &lt;tt&gt;Map&amp;lt;String, AtomicInteger&amp;gt;&lt;/tt&gt; and keep the inc/dec logic on &lt;tt&gt;markIndexBuilding&lt;/tt&gt; and &lt;tt&gt;markIndexBuilt&lt;/tt&gt; instead, which are the only consumers of this class.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also, it&apos;s worth noting that, with this approach, if any (re)building fails for a index, it will get inevitably marked for rebuilding at restart, even if an index rebuilding is manually run. Should we avoid this? If so, how could we avoid race conditions between these manual (re)buildings and those produced by streaming?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm that is a bit less than ideal, since the user will expect the index &lt;b&gt;NOT&lt;/b&gt; to be rebuilt on restart if there was a subsequent successful rebuild. How about making &lt;tt&gt;markIndexBuilding&lt;/tt&gt; return the current counter value, and on full index rebuilds we could pass the value to &lt;tt&gt;markIndexBuilt&lt;/tt&gt;, and if it&apos;s the same as before we could assume no new partial or full rebuild was submitted in-between and so we can mark the index as built and reset/remove the counters?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure about if the assert in SecondaryIndexManager.PendingIndexBuildsCounter#decrease() is too aggressive.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The previous API did not require users to call &lt;tt&gt;markIndexBuilding&lt;/tt&gt; before &lt;tt&gt;markIndexBuilt&lt;/tt&gt;, so we should probably leave the &lt;tt&gt;markIndexBuilt&lt;/tt&gt; API with the current unsafe behavior (while marking it as deprecated), and add the assertion only on the new API. WDYT?&lt;/p&gt;</comment>
                            <comment id="16012006" author="sbtourist" created="Tue, 16 May 2017 08:48:04 +0000"  >&lt;p&gt;Some more feedback by my side too.&lt;/p&gt;

&lt;p&gt;I think there still is a subtle concurrency issue, due to the fact we have some methods managing the &quot;index status&quot; in the system keyspace via the counter, and other methods directly messing with the system keyspace and/or the pending builds map; i.e., what happens if the index is unregistered while it is being rebuilt? Probably an &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk#diff-3f2c8994c4ff8748c3faf7e70958520dR424&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;NPE&lt;/a&gt;. I would suggest to clean it up a bit by avoiding to keep &quot;pending builds&quot; in the map after they&apos;re all done, that is after the index has been marked as built: by doing so, you can just remove the pending build inside &lt;tt&gt;markIndexBuilt&lt;/tt&gt; if the counter reaches 0 (you&apos;d have to guard the &lt;tt&gt;mark*&lt;/tt&gt; methods rather than the counter ones), and hence keep the &quot;build management&quot; code inside the two &quot;mark building/built&quot; methods only.&lt;/p&gt;

&lt;p&gt;I&apos;m kinda unsure if we should actually call &lt;tt&gt;markIndexBuilding&lt;/tt&gt; inside &lt;tt&gt;createIndex&lt;/tt&gt;: what if the user forgets to call &lt;tt&gt;markIndexBuilt&lt;/tt&gt; inside the initialization task? There&apos;s no such contract forcing the user to do that. So, as a corollary, we should probably accept calls to &lt;tt&gt;markIndexBuilt&lt;/tt&gt; even without a previous &lt;tt&gt;markIndexBuilding&lt;/tt&gt; call (that is, making it idempotent).&lt;/p&gt;

&lt;p&gt;Also, &lt;tt&gt;buildAllIndexesBlocking&lt;/tt&gt; doesn&apos;t follow the &quot;mark building/built&quot; pattern: isn&apos;t that a weird anomaly? I know the &lt;tt&gt;StreamReceiveTask&lt;/tt&gt; does that, but what about other callers?&lt;/p&gt;

&lt;p&gt;Regarding &lt;tt&gt;PendingIndexBuildsCounter&lt;/tt&gt;, it isn&apos;t really just a counter, I would rename it (i.e. just &lt;tt&gt;PendingBuild&lt;/tt&gt;), and rename its methods as well for further clarity; or we could ditch it altogether as suggested by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Finally regarding:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;the user will expect the index NOT to be rebuilt on restart if there was a subsequent successful rebuild.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is it what &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; actually meant? I do not think the index is actually rebuilt on restart if successfully rebuilt manually, or am I missing the point?&lt;/p&gt;</comment>
                            <comment id="16014004" author="adelapena" created="Wed, 17 May 2017 13:18:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;do we really need a &lt;tt&gt;PendingIndexBuildsCounter&lt;/tt&gt; class? I thought it would be simpler to make &lt;tt&gt;pendingBuilds&lt;/tt&gt; a &lt;tt&gt;Map&amp;lt;String, AtomicInteger&amp;gt;&lt;/tt&gt; and keep the inc/dec logic on &lt;tt&gt;markIndexBuilding&lt;/tt&gt; and &lt;tt&gt;markIndexBuilt&lt;/tt&gt; instead, which are the only consumers of this class.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Probably not. The &lt;tt&gt;AtomicInteger&lt;/tt&gt; s are going to be manipulated inside a &lt;tt&gt;synchronized&lt;/tt&gt; block, so a not thread-safe mutable integer should be enough. This is what led me to build the &lt;tt&gt;PendingIndexBuildsCounter&lt;/tt&gt; class. But is true that it is easier to just use a &lt;tt&gt;Map&amp;lt;String, AtomicInteger&amp;gt;&lt;/tt&gt; and keep the logic inside the markIndex* methods.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m kinda unsure if we should actually call &lt;tt&gt;markIndexBuilding&lt;/tt&gt; inside &lt;tt&gt;createIndex&lt;/tt&gt;: what if the user forgets to call &lt;tt&gt;markIndexBuilt&lt;/tt&gt; inside the initialization task? There&apos;s no such contract forcing the user to do that. So, as a corollary, we should probably accept calls to &lt;tt&gt;markIndexBuilt&lt;/tt&gt; even without a previous &lt;tt&gt;markIndexBuilding&lt;/tt&gt; call (that is, making it idempotent).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It is true that an implementation could forget to call &lt;tt&gt;markIndexBuilding&lt;/tt&gt; or &lt;tt&gt;markIndexBuilt&lt;/tt&gt;. But I think that if we relax the counters system then we could have the race conditions that we try to solve. I mean, an effective call to &lt;tt&gt;markIndexBuilt&lt;/tt&gt; (marking) without a preceding &lt;tt&gt;markIndexBuilding&lt;/tt&gt; could spoil the efforts of a proper &lt;tt&gt;markIndexBuilding&lt;/tt&gt;/&lt;tt&gt;markIndexBuilt&lt;/tt&gt; pair usage. The approach suggested by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt; could help. Also, as it is pointed, there is no contract forcing the users to use any of the &lt;tt&gt;markIndex*&lt;/tt&gt; methods, so it&apos;s hard to anticipate all possible scenarios to avoid race conditions.&lt;/p&gt;

&lt;p&gt;As, an alternative approach, we could hide all the &lt;tt&gt;markIndex*&lt;/tt&gt; and let the &lt;tt&gt;SecondaryIndexManager&lt;/tt&gt; to internally manage it. This should avoid the risk of index implementations or other components making calls out of order. Here is a patch showing the approach:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;It adds a &lt;tt&gt;Runnable&lt;/tt&gt; argument to &lt;tt&gt;buildAllIndexesBlocking&lt;/tt&gt; to provide the ability of retrying failed new sstables indexing guaranteeing that the hidden &lt;tt&gt;markIndex*&lt;/tt&gt; methods are properly called. &lt;/p&gt;

&lt;p&gt;The index implementations are not responsible anymore of marking the index as built. This eliminates the bidirectional dependency between &lt;tt&gt;SecondaryIndexManager&lt;/tt&gt; and the index implementations. We might consider updating the log messages produced by &lt;tt&gt;CassandraIndex.buildBlocking&lt;/tt&gt; and &lt;tt&gt;CustomCassandraIndex.buildBlocking&lt;/tt&gt;, or even moving them to the &lt;tt&gt;SecondaryIndexManager&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;What do you think? Does it make sense?&lt;/p&gt;</comment>
                            <comment id="16015593" author="sbtourist" created="Thu, 18 May 2017 11:11:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;, the approach looks good to me, here is some specific feedback:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Why executing the &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk#diff-3f2c8994c4ff8748c3faf7e70958520dR389&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;preBuildTask&lt;/a&gt; in another thread via &lt;tt&gt;executeBlocking&lt;/tt&gt;, rather than just calling &lt;tt&gt;Runnable#run&lt;/tt&gt;?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Currently, &lt;tt&gt;buildIndexesBlocking&lt;/tt&gt; will end up rebuilding &lt;b&gt;all&lt;/b&gt; indexes even if just a single one failed, because &lt;tt&gt;markIndexBuilt&lt;/tt&gt; is called in bulk at the very end; I know this is in line with the previous behaviour, but wouldn&apos;t it make sense to improve it in this issue?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Do we have tests checking:
	&lt;ul&gt;
		&lt;li&gt;Index status pre and post (re)building actions (create index, rebuild index).&lt;/li&gt;
		&lt;li&gt;Index status upon index removal.&lt;/li&gt;
		&lt;li&gt;Index status and automatic rebuild in case of failures.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16018124" author="pauloricardomg" created="Fri, 19 May 2017 22:26:31 +0000"  >&lt;p&gt;Overall I like the new approach and the idea of keeping &lt;tt&gt;markIndex*&lt;/tt&gt; usage restricted to &lt;tt&gt;SecondaryIndexManager&lt;/tt&gt;, since it will keep things more self-contained and prevent bad usages.&lt;/p&gt;

&lt;p&gt;While inspecting usages of &lt;tt&gt;buildAllIndexesBlocking&lt;/tt&gt; with the &lt;tt&gt;preBuildTask&lt;/tt&gt; parameter, I noticed that rebuilding indexes is a natural consequence of adding new SSTables to the tracker - I don&apos;t see a situation where we want to add SSTables to the tracker and NOT rebuild the indexes, so instead of requiring users of &lt;tt&gt;Tracker.addSSTables&lt;/tt&gt; to figure out they need to rebuild indexes and create a dependency with the &lt;tt&gt;SecondaryIndexManager&lt;/tt&gt; (such as &lt;tt&gt;OnCompletionRunnable&lt;/tt&gt; or &lt;tt&gt;ColumnFamilyStore.loadNewSSTables&lt;/tt&gt;), or even creating a dependency between &lt;tt&gt;Tracker.addSSTables&lt;/tt&gt; and the secondary index manager, we could leverage the tracker notification support and make the secondary index automatically rebuild indexes when receiving an &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt; from the tracker.&lt;/p&gt;

&lt;p&gt;However this notification is only triggered &lt;b&gt;after&lt;/b&gt; the SSTables are added to the tracker, but there is a possibility that there is a failure after some SSTables were already added and we would need to rebuild indexes in that case, so we could maybe add a new &lt;tt&gt;SSTableBeforeAddedNotification&lt;/tt&gt; (or better name) that is triggered at the start of &lt;tt&gt;Tracker.addSSTables&lt;/tt&gt;, mark the index as building when receiving that notification and actually trigger &lt;tt&gt;buildAllIndexesBlocking&lt;/tt&gt; when receiving the &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;WDYT of this suggestion?&lt;/p&gt;</comment>
                            <comment id="16019655" author="adelapena" created="Mon, 22 May 2017 14:51:31 +0000"  >&lt;p&gt;Here is the updated patch:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;blockquote&gt;&lt;p&gt;Why executing the &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk#diff-3f2c8994c4ff8748c3faf7e70958520dR389&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;preBuildTask&lt;/a&gt; in another thread via &lt;tt&gt;executeBlocking&lt;/tt&gt;, rather than just calling &lt;tt&gt;Runnable#run&lt;/tt&gt;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Totally agree, &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/627266a894d7a34c2c0c7d3226cd91c07fad5a6d/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L390&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;changed&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Currently, &lt;tt&gt;buildIndexesBlocking&lt;/tt&gt; will end up rebuilding all indexes even if just a single one failed, because &lt;tt&gt;markIndexBuilt&lt;/tt&gt; is called in bulk at the very end; I know this is in line with the previous behaviour, but wouldn&apos;t it make sense to improve it in this issue?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ve just changed it to use a &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/627266a894d7a34c2c0c7d3226cd91c07fad5a6d/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L416&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;per-builder callback&lt;/a&gt; that flushes the indexes, marks them as built and logs the index building completion message.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Do we have tests checking:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Index status pre and post (re)building actions (create index, rebuild index).&lt;/li&gt;
	&lt;li&gt;Index status upon index removal.&lt;/li&gt;
	&lt;li&gt;Index status and automatic rebuild in case of failures.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;Indeed, some more tests were needed:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;For unit tests, I have extended the already existent &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/627266a894d7a34c2c0c7d3226cd91c07fad5a6d/test/unit/org/apache/cassandra/index/internal/CassandraIndexTest.java#L510&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;CassandraIndexTest#indexCorrectlyMarkedAsBuildAndRemoved&lt;/tt&gt;&lt;/a&gt; to cover the new cases.&lt;/li&gt;
	&lt;li&gt;For dtests, &lt;a href=&quot;https://github.com/adelapena/cassandra-dtest/blob/8da749e26a4712f4581cabf56c60df92aa65f066/sstable_generation_loading_test.py#L297&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;sstable_generation_loading_test.py#sstableloader_with_failing_2i_test&lt;/tt&gt;&lt;/a&gt; covers index status with &lt;tt&gt;StreamReceiveTask&lt;/tt&gt;. I have also added &lt;a href=&quot;https://github.com/adelapena/cassandra-dtest/blob/8da749e26a4712f4581cabf56c60df92aa65f066/secondary_indexes_test.py#L338-L396&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;test_failing_manual_rebuild_index&lt;/tt&gt;&lt;/a&gt;, &lt;a href=&quot;https://github.com/adelapena/cassandra-dtest/blob/8da749e26a4712f4581cabf56c60df92aa65f066/secondary_indexes_test.py#L398-L434&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;test_drop_index_while_building&lt;/tt&gt;&lt;/a&gt; and &lt;a href=&quot;https://github.com/adelapena/cassandra-dtest/blob/8da749e26a4712f4581cabf56c60df92aa65f066/secondary_indexes_test.py#L436-L471&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;test_index_is_not_always_rebuilt_at_start&lt;/tt&gt;&lt;/a&gt; to &lt;a href=&quot;https://github.com/adelapena/cassandra-dtest/blob/8da749e26a4712f4581cabf56c60df92aa65f066/secondary_indexes_test.py&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;secondary_indexes_test.py#TestSecondaryIndexes&lt;/tt&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;
&lt;p&gt;While inspecting usages of &lt;tt&gt;buildAllIndexesBlocking&lt;/tt&gt; with the &lt;tt&gt;preBuildTask&lt;/tt&gt; parameter, I noticed that rebuilding indexes is a natural consequence of adding new SSTables to the tracker - I don&apos;t see a situation where we want to add SSTables to the tracker and NOT rebuild the indexes, so instead of requiring users of &lt;tt&gt;Tracker.addSSTables&lt;/tt&gt; to figure out they need to rebuild indexes and create a dependency with the &lt;tt&gt;SecondaryIndexManager&lt;/tt&gt; (such as &lt;tt&gt;OnCompletionRunnable&lt;/tt&gt; or &lt;tt&gt;ColumnFamilyStore.loadNewSSTables&lt;/tt&gt;), or even creating a dependency between &lt;tt&gt;Tracker.addSSTables&lt;/tt&gt; and the secondary index manager, we could leverage the tracker notification support and make the secondary index automatically rebuild indexes when receiving an &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt; from the tracker.&lt;/p&gt;

&lt;p&gt;However this notification is only triggered &lt;b&gt;after&lt;/b&gt; the SSTables are added to the tracker, but there is a possibility that there is a failure after some SSTables were already added and we would need to rebuild indexes in that case, so we could maybe add a new &lt;tt&gt;SSTableBeforeAddedNotification&lt;/tt&gt; (or better name) that is triggered at the start of &lt;tt&gt;Tracker.addSSTables&lt;/tt&gt;, mark the index as building when receiving that notification and actually trigger &lt;tt&gt;buildAllIndexesBlocking&lt;/tt&gt; when receiving the &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This would be similar to how SASI indexes work. However, I&apos;m not sure about if there are cases where a &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt; shouldn&apos;t trigger the indexing of the notified SSTables. For example, &lt;tt&gt;Tracker#replaceFlushed(Memtable, Iterable&amp;lt;SSTableReader&amp;gt;)&lt;/tt&gt; sends a &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;. If I understand it right, this happens when a memtable is flushed to disk. I guess that something similar happens when SSTables are merged by compaction. Currently, these &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt; s are not associated to an reindexing because the added SSTables contain data that has been already indexed. What do you think?&lt;/p&gt;</comment>
                            <comment id="16022206" author="pauloricardomg" created="Wed, 24 May 2017 02:07:59 +0000"  >&lt;p&gt;Thanks for the update! I haven&apos;t reviewed new patch yet, but just commenting on the latest statement to get you unblocked:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Currently, these SSTableAddedNotification s are not associated to an reindexing because the added SSTables contain data that has been already indexed. What do you think?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;good point! since loading external sstables (either via streaming or &lt;tt&gt;CFS.loadNewSSTables&lt;/tt&gt;) requires rebuilding indexes while flushing does not this probably indicate we want to further specialize &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt; to indicate whether the new sstables added were flushed or loaded from an external source. By the way, sstables replaced by compaction use the &lt;tt&gt;SSTableListChangedNotification&lt;/tt&gt; so this would not be a problem there.&lt;/p&gt;

&lt;p&gt;We could either add a new field to &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt; to indicate wether the added sstables come from flush or external sstables or create two new notifications which would inherit from  &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt; to maintain backward compatibility, perhaps: &lt;tt&gt;SSTableFlushedNotification&lt;/tt&gt; and &lt;tt&gt;ExternalSSTableLoadedNotification&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;I think it would be cleaner to have a notification-based 2i rebuild, since this would remove a dependency from components that need to load external sstables from the secondary index manager and this is probably a good opportunity to do it.&lt;/p&gt;</comment>
                            <comment id="16029960" author="maedhroz" created="Tue, 30 May 2017 19:07:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;We could either add a new field to SSTableAddedNotification to indicate wether the added sstables come from flush or external sstables or create two new notifications which would inherit from SSTableAddedNotification to maintain backward compatibility, perhaps: SSTableFlushedNotification and ExternalSSTableLoadedNotification.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The &lt;tt&gt;SSTableFlushedNotification&lt;/tt&gt; approach sounds cleaner, mostly because it could carry an unambiguously non-null reference to the flushed &lt;tt&gt;Memtable&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16031177" author="adelapena" created="Wed, 31 May 2017 13:49:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;, definitively the event driven approach is a better idea than the lambda. Here is the updated patch:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:33a603bf89f95a2cfea737572840897fb26c6585&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;There is a new &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/33a603bf89f95a2cfea737572840897fb26c6585/src/java/org/apache/cassandra/notifications/SSTableLoadedNotification.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SSTableLoadedNotification&lt;/tt&gt;&lt;/a&gt;. This notification contains the unused list of added SSTables; maybe be could remove them.&lt;/p&gt;

&lt;p&gt;There is a new attribute named &lt;tt&gt;areLoaded&lt;/tt&gt; to &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/33a603bf89f95a2cfea737572840897fb26c6585/src/java/org/apache/cassandra/notifications/SSTableAddedNotification.java#L27&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;&lt;/a&gt;. This attribute indicates if the added SSTables come from an external source such as streaming or sstableoader.&lt;/p&gt;

&lt;p&gt;The new &lt;tt&gt;SSTableLoadedNotification&lt;/tt&gt; is sent by &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/33a603bf89f95a2cfea737572840897fb26c6585/src/java/org/apache/cassandra/db/lifecycle/Tracker.java#L204&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;Tracker#addSSTables&lt;/tt&gt;&lt;/a&gt; depending on its new &lt;tt&gt;areLoaded&lt;/tt&gt; parameter, with the same meaning as in &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/adelapena/cassandra/blob/33a603bf89f95a2cfea737572840897fb26c6585/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L289&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SecondaryIndexManager#buildAllIndexesBlocking&lt;/tt&gt;&lt;/a&gt; is now private and called by &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/33a603bf89f95a2cfea737572840897fb26c6585/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L1231&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SecondaryIndexManager#handleNotification&lt;/tt&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16031557" author="adelapena" created="Wed, 31 May 2017 17:24:34 +0000"  >&lt;p&gt;And here is an alternative version of the patch in which &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/10130-trunk-memtable/src/java/org/apache/cassandra/notifications/SSTableAddedNotification.java#L31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;&lt;/a&gt; uses the origin &lt;tt&gt;Memtable&lt;/tt&gt; instead of the boolean parameter:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk-memtable&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-memtable-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-memtable-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Probably the boolean argument if strictly enough but consumers could be interested in the &lt;tt&gt;Memtable&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16031771" author="sbtourist" created="Wed, 31 May 2017 19:15:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;, excellent suggestion.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;, I personally like the &quot;memtable&quot; version more, as logically speaking, if an sstable is added with a memtable, it means it has been also indexed, while in all other cases it means the sstable(s) have been externally loaded and needs indexing, but I have a few concerns:&lt;br/&gt;
1) There are too many overloads of &lt;tt&gt;addSSTable(s)&lt;/tt&gt;, and some of them do not make much sense and are there just to support self calls (i.e. the version with many sstables and a single memtable I believe), so can we clean that up?&lt;br/&gt;
2) Who is actually calling the &lt;tt&gt;addSSTable&lt;/tt&gt; method with the memtable? I think I&apos;m missing where it&apos;s actually used...&lt;br/&gt;
3) Why did you reduce the test coverage in &lt;tt&gt;indexCorrectlyMarkedAsBuildAndRemoved&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="16032098" author="pauloricardomg" created="Wed, 31 May 2017 22:16:04 +0000"  >&lt;p&gt;I also like the &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt; version with the memtable better. It would be nice if you could add a short comment explaining when the memtable is present or not.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure we should restrict the &lt;tt&gt;SSTableLoadedNotification&lt;/tt&gt; to only loaded sstables, since a subscriber may want to do an action before and after sstables are added to the tracker, regardless if they are flushed or externally loaded, so we should probably trigger regardless if memtable is null or not and rename the notification to &lt;tt&gt;SSTableBeforeAddedNotification&lt;/tt&gt; (or similar) - this will also prevent confusion from users thinking the sstables are already in the tracker when receiving an &lt;tt&gt;SSTableLoadedNotification&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Also you should probably ubsubscribe from the tracker when the index is dropped.&lt;/p&gt;

&lt;p&gt;This is looking much cleaner now, good job!&lt;/p&gt;</comment>
                            <comment id="16033389" author="adelapena" created="Thu, 1 Jun 2017 17:52:06 +0000"  >&lt;p&gt;Here is the updated version of the patch:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk-memtable&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-memtable-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-memtable-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;blockquote&gt;&lt;p&gt;I personally like the &quot;memtable&quot; version more, as logically speaking, if an sstable is added with a memtable, it means it has been also indexed, while in all other cases it means the sstable(s) have been externally loaded and needs indexing&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The only exception to this seems to be &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/tools/stress/src/org/apache/cassandra/stress/CompactionStress.java#L147&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;CompactionStress&lt;/tt&gt;&lt;/a&gt;. It calls to &lt;tt&gt;ColumnFamilyStore#addSSTables&lt;/tt&gt; without memtable and without indexing. Fortunately there shouldn&apos;t be any associated 2i when the call is done, I have added &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/bb1f80b0b7be5122887621878fd6137627f72558/tools/stress/src/org/apache/cassandra/stress/CompactionStress.java#L148&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a check&lt;/a&gt; to make sure that it is so.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;1) There are too many overloads of addSSTable(s), and some of them do not make much sense and are there just to support self calls (i.e. the version with many sstables and a single memtable I believe), so can we clean that up?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Cleaned.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2) Who is actually calling the addSSTable method with the memtable? I think I&apos;m missing where it&apos;s actually used...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is called from &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/bb1f80b0b7be5122887621878fd6137627f72558/src/java/org/apache/cassandra/db/lifecycle/Tracker.java#L340-L371&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;Tracker#replaceFlushed&lt;/tt&gt;&lt;/a&gt;, and it is checked in &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/bb1f80b0b7be5122887621878fd6137627f72558/test/unit/org/apache/cassandra/db/lifecycle/TrackerTest.java#L312&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;TrackerTest#testMemtableReplacement&lt;/tt&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;3) Why did you reduce the test coverage in &lt;tt&gt;indexCorrectlyMarkedAsBuildAndRemoved&lt;/tt&gt;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Because it seemed covered by dtests and simulating an index building failure seemed harder without the function passed as parameter. But really there is a case that is not covered by dtests and the failure can be simulated passing a null sstable collections, so I have added &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/bb1f80b0b7be5122887621878fd6137627f72558/test/unit/org/apache/cassandra/index/internal/CassandraIndexTest.java#L512&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;an equivalent check&lt;/a&gt; using rebuilding.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It would be nice if you could add a short comment explaining when the memtable is present or not.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I have just added &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/bb1f80b0b7be5122887621878fd6137627f72558/src/java/org/apache/cassandra/notifications/SSTableAddedNotification.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;several comments&lt;/a&gt;, not sure about if they are clear enough or too repetitive.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure we should restrict the &lt;tt&gt;SSTableLoadedNotification&lt;/tt&gt; to only loaded sstables, since a subscriber may want to do an action before and after sstables are added to the tracker, regardless if they are flushed or externally loaded, so we should probably trigger regardless if memtable is null or not and rename the notification to &lt;tt&gt;SSTableBeforeAddedNotification&lt;/tt&gt; (or similar) - this will also prevent confusion from users thinking the sstables are already in the tracker when receiving an &lt;tt&gt;SSTableLoadedNotification&lt;/tt&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good idea. I have replaced &lt;tt&gt;SSTableLoadedNotification&lt;/tt&gt; by a &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/bb1f80b0b7be5122887621878fd6137627f72558/src/java/org/apache/cassandra/notifications/SSTableBeforeAddedNotification.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SSTableBeforeAddedNotification&lt;/tt&gt;&lt;/a&gt; that is always send before &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;. It includes the memtable to allow consumers to know if it comes from a flush.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also you should probably ubsubscribe from the tracker when the index is dropped.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It is the &lt;tt&gt;SecondaryIndexManager&lt;/tt&gt; who is subscribed to the tracker. It manages all the indexes on its column family store, so it shouldn&apos;t unsubscribe when one of its indexes is dropped, unless I&apos;m missing something.&lt;/p&gt;</comment>
                            <comment id="16034087" author="pauloricardomg" created="Fri, 2 Jun 2017 03:34:43 +0000"  >&lt;p&gt;Thanks for the update! The notification comments look great! See follow-up below:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;It&apos;s not clear that users of &lt;tt&gt;buildIndexesBlocking&lt;/tt&gt; should mark the indexes as building beforehand, so we should make that explicit via an assertion and probably also add a comment - or perhaps provide a default version where it marks indexes as building beforehand, since the only case we will not want to do that is when receiving an &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;, since we have already marked them as building when receiving an &lt;tt&gt;SSTableBeforeAddedNotification&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Even though we have unit tests testing the tracker notifications and marking indexes as build, we don&apos;t have a SecondaryIndexManager unit test that checks that it&apos;s correctly marking the index as building when receiving an &lt;tt&gt;SSTableBeforeAddedNotification&lt;/tt&gt; and marked as built after a successful &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;. Could you add that please?&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;There&apos;s still a slight chance that an index is created between an &lt;tt&gt;SSTableBeforeAddedNotification&lt;/tt&gt; and &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt; and we won&apos;t have marked it as building, so we should probably save the indexes we have marked as building when receiving the &lt;tt&gt;SSTableBeforeAddedNotification&lt;/tt&gt; and mark any new index as building after receiving an &lt;tt&gt;SSTableBeforeAddedNotification&lt;/tt&gt; but before building all indexes, and maybe extend the previous unit test to test this unlikely scenario.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Is there any particular reason why you moved the &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk-memtable#diff-a1dda2df07c96dc42ddb58766362703fL357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;order&lt;/a&gt; of &lt;tt&gt;updateSizeTracking&lt;/tt&gt; on &lt;tt&gt;Tracker.addSSTables&lt;/tt&gt;?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;After those are addressed I think this should be mostly done unless &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sbtourist&quot; class=&quot;user-hover&quot; rel=&quot;sbtourist&quot;&gt;sbtourist&lt;/a&gt; has further comments. Thanks!&lt;/p&gt;</comment>
                            <comment id="16034094" author="pauloricardomg" created="Fri, 2 Jun 2017 03:54:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;There&apos;s still a slight chance that an index is created between an SSTableBeforeAddedNotification and SSTableAddedNotification and we won&apos;t have marked it as building, so we should probably save the indexes we have marked as building when receiving the SSTableBeforeAddedNotification and mark any new index as building after receiving an SSTableBeforeAddedNotification but before building all indexes, and maybe extend the previous unit test to test this unlikely scenario.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The suggestion above feels a bit ugly, so this made me think that when loading external sstables we actually don&apos;t care about individual indices: on failure we wan&apos;t to rebuild them all on restart, so instead of marking individual indices in need of rebuild, we could instead have a special entry (such as all_indexes_need_rebuild ) in the BUILT_INDEXES table, indicating that on restart if a table contains that entry it needs to rebuild all indexes. If we did this we could probably get rid of the &lt;tt&gt;pendingBuilds&lt;/tt&gt; counter complexity since we wouldn&apos;t race with manual individual index rebuilds on the BUILT_INDEXES table. WDYT?&lt;/p&gt;</comment>
                            <comment id="16034482" author="sbtourist" created="Fri, 2 Jun 2017 10:45:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;I have replaced SSTableLoadedNotification by a SSTableBeforeAddedNotification&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nit: &lt;tt&gt;SSTableBeforeAddedNotification&lt;/tt&gt; would probably read better as &lt;tt&gt;SSTableBeforeAddNotification&lt;/tt&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;It&apos;s not clear that users of buildIndexesBlocking should mark the indexes as building beforehand, so we should make that explicit via an assertion and probably also add a comment&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;A comment is a good idea, but I think we shouldn&apos;t go further than that: &lt;tt&gt;buildIndexesBlocking&lt;/tt&gt; is private so we can assume callers know what they&apos;re doing.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;There&apos;s still a slight chance that an index is created between an SSTableBeforeAddedNotification and SSTableAddedNotification and we won&apos;t have marked it as building&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think in such case the new &lt;tt&gt;Index&lt;/tt&gt; initialization task would take care of indexing, so it doesn&apos;t really matter if the new index misses the sstable notification. So, to cover against the specific race you mentioned, we can just filter out in &lt;tt&gt;SIM#handleNotification()&lt;/tt&gt;, when receiving the &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;, all indexes not marked as building, as we can assume those missed the first notification because not yet registered (and being just registered, the initialization task will eventually take care of any initial indexing).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;we could probably get rid of the pendingBuilds counter complexity since we wouldn&apos;t race with manual individual index rebuilds on the BUILT_INDEXES table&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think the race above can be solved easily without adding columns to the system table. Other than that, let&apos;s not forget the &lt;tt&gt;pendingBuilds&lt;/tt&gt; counter was needed to protect us not just against concurrent building of multiple indexes, but also against concurrent building of multiple sstables &quot;batches&quot; for the same index.&lt;/p&gt;

&lt;p&gt;Thoughts? I&apos;ll now proceed with reviewing the latest code changes.&lt;/p&gt;</comment>
                            <comment id="16034602" author="pauloricardomg" created="Fri, 2 Jun 2017 12:23:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think in such case the new Index initialization task would take care of indexing, so it doesn&apos;t really matter if the new index misses the sstable notification. So, to cover against the specific race you mentioned, we can just filter out in SIM#handleNotification(), when receiving the SSTableAddedNotification, all indexes not marked as building, as we can assume those missed the first notification because not yet registered (and being just registered, the initialization task will eventually take care of any initial indexing).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s still possible that an index is created after the &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt; but before all sstables are added to the tracker, in this case the initial index rebuild will not index the sstables that were added and filtering all indexes marked as building will not re-mark the new index as building since it may be still doing the initial rebuild:&lt;br/&gt;
1. &lt;tt&gt;SSTableBeforeAddNotification&lt;/tt&gt; is received by SIM&lt;br/&gt;
3. new index is created (it will not index the new sstables since they are not in the tracker yet) and mark as building&lt;br/&gt;
4. New sstables are added to the tracker&lt;br/&gt;
5. &lt;tt&gt;SSTableAddeNotification&lt;/tt&gt; is received and index rebuild of new sstables is triggered - the index is not re-marked as building because it&apos;s already marked as building by the index creation&lt;br/&gt;
6. original index rebuild is finished and index is marked as built&lt;br/&gt;
7. index rebuild of new sstables fail but index is marked as built&lt;/p&gt;

&lt;p&gt;This case is extremely unlikely to happen but shows the fragility of this approach, which may be prone to other races we&apos;re not aware of.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think the race above can be solved easily without adding columns to the system table. Other than that, let&apos;s not forget the pendingBuilds counter was needed to protect us not just against concurrent building of multiple indexes, but also against concurrent building of multiple sstables &quot;batches&quot; for the same index.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My suggestion was not to add new columns to the system table, but rather overload the existing columns with the following semantics:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When an index is created for the first time for a table add new entry &lt;tt&gt;INSERT INTO system.IndexInfo (table_name, index_name) VALUES (&quot;table&quot;, &quot;table&quot;)&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;When new sstables are received remove this entry from the index while these sstables are being indexed&lt;/li&gt;
	&lt;li&gt;On restart, if this entry is not present it means index rebuild failure for all indexes which need rebuild&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;To protect against concurrent building of multiple sstables &quot;batches&quot; for the same index, we could still have a pendingBuilds counter but a single counter for all indexes rather than one counter per index. For manual rebuilds we could simply prevent a new index rebuild if there&apos;s one already running, since it doesn&apos;t make much sense to do simultaneous full rebuilds of the same indexes.&lt;/p&gt;

&lt;p&gt;In any case this is just a suggestion, I&apos;m fine if we go with other approach (such as saving which indices were marked on the first notification) or decide this race is too unlikely to bother doing anything.&lt;/p&gt;</comment>
                            <comment id="16034963" author="sbtourist" created="Fri, 2 Jun 2017 16:10:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;It&apos;s still possible that an index is created after the SSTableAddedNotification but before all sstables are added to the tracker&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That made me also think of an ABA-like race, where a new index is registered &lt;em&gt;and built&lt;/em&gt; in-between the two notifications, causing it to miss the new-to-be-added sstables. Weird stuff, and overall excellent points &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Given most of the races come from the 2-phase event-based solution, I&apos;d say to simplify it in a way that still at least solves the original issue: that is, keep just the &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;, and mark the index building/built around that; this will not protect against failures happening &lt;em&gt;while&lt;/em&gt; adding SSTables, but again, it would at least solve the original problem of the index itself failing after adding the SSTables and missing to rebuild. Then, we can think about a more complete solution (i.e. one that doesn&apos;t rebuild the whole index because of a single failed stream) in another ticket.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="16036027" author="adelapena" created="Sat, 3 Jun 2017 17:53:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Given most of the races come from the 2-phase event-based solution, I&apos;d say to simplify it in a way that still at least solves the original issue: that is, keep just the SSTableAddedNotification, and mark the index building/built around that; this will not protect against failures happening while adding SSTables, but again, it would at least solve the original problem of the index itself failing after adding the SSTables and missing to rebuild. Then, we can think about a more complete solution (i.e. one that doesn&apos;t rebuild the whole index because of a single failed stream) in another ticket.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agree, we can think in a wider solution in another ticket. Here is a version of the patch that uses only &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;, keeping the 2-phase &lt;tt&gt;markIndexBuilding&lt;/tt&gt;/&lt;tt&gt;markIndexBuilt&lt;/tt&gt; internal to &lt;tt&gt;SecondaryIndexManager&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The &lt;a href=&quot;https://github.com/adelapena/cassandra-dtest/tree/CASSANDRA-10130&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tests&lt;/a&gt; should show how the approach solves the original problem.&lt;/p&gt;</comment>
                            <comment id="16038189" author="pauloricardomg" created="Tue, 6 Jun 2017 05:04:36 +0000"  >&lt;p&gt;Sorry for being picky here but while we are fixing the original limitation, we are introducing a new limitation that if there&apos;s ever a non-fatal index build failure, a successful full index rebuild will not mark the index as built until the node is restarted and the index is unnecessarily rebuilt.&lt;/p&gt;

&lt;p&gt;We can probably lift this limitation fairly simply by marking the index as built (and clear the pending counters) if there was no other index build submission since the start of the full rebuild - even if there are (likely failed) pending builds. We also should probably log a warning when there is an index build failure instructing the user to run a full index rebuild to fix it.&lt;/p&gt;</comment>
                            <comment id="16038692" author="sbtourist" created="Tue, 6 Jun 2017 11:45:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;Sorry for being picky here but while we are fixing the original limitation, we are introducing a new limitation that if there&apos;s ever a non-fatal index build failure, a successful full index rebuild will not mark the index as built until the node is restarted and the index is unnecessarily rebuilt.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Excellent point, you&apos;re not being picky at all. There&apos;s actually a related problem: if a single sstable indexing fails, we restart the node, and try to load a &lt;b&gt;new&lt;/b&gt; sstable, the index will be marked as built, even if there&apos;s an sstable whose indexing failed.&lt;/p&gt;

&lt;p&gt;In other words, it seems to me we should mark the index as built &lt;em&gt;only&lt;/em&gt; if:&lt;br/&gt;
1) It is a full rebuild.&lt;br/&gt;
2) It is an initialization task (which should be considered as the initial full build).&lt;br/&gt;
3) It is a single/group sstable(s) indexing, and the index was &lt;b&gt;already built&lt;/b&gt;: that is, if we initiate an sstable indexing, but the index was &lt;b&gt;not&lt;/b&gt; marked as built, we should preserve such state (that implementation-wise probably means to just keep the counters at 0 and avoid any marking).&lt;/p&gt;

&lt;p&gt;Other than that, I have a concern about &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk#diff-3f2c8994c4ff8748c3faf7e70958520dR399&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;flushing indexes in the future transformation&lt;/a&gt;, which would cause such blocking activity to happen in the compaction thread, a departure from previous behaviour and probably an unwanted one.&lt;/p&gt;</comment>
                            <comment id="16044472" author="adelapena" created="Fri, 9 Jun 2017 14:06:43 +0000"  >&lt;p&gt;Here is another version of the patch:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The key changes are forbidding concurrent full (re)builds of the same index (there is no reason to want them) and making the initial mark operation of a full index rebuild wait until there are no running partial builds:&lt;/p&gt;


&lt;ul&gt;
	&lt;li&gt;Partial builds are always fired during the addition of a new SSTables, notified by &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;. These use the regular counters system and only wait if there are ongoing calls to &lt;tt&gt;markReindexingAllSSTables&lt;/tt&gt;. These calls are done by full index rebuilds and should be a very fast operation to don&apos;t block repairs for long.&lt;/li&gt;
	&lt;li&gt;Full builds during index creation acquire a lock to avoid full index rebuilds of the index and call to &lt;tt&gt;markIndexingAllSSTables&lt;/tt&gt;, without checking if there are running partial builds. Since this is done before registering the index, this is the very first and unique build for the index being created. Once the call to &lt;tt&gt;markIndexingAllSSTables&lt;/tt&gt; has finished we can register the index and throw the build task. Once the task has finished we release the lock to avoid full index rebuilds of the index.&lt;/li&gt;
	&lt;li&gt;Manual full index rebuilds fail if there is any another running (re)build of the index or if it&apos;s being created. In the case of finding a full build the fail is instantaneously, whereas there is a small wait period if there are running partial rebuilds. This shouldn&apos;t be a big problem given that they are manually thrown and they can be retried if they are rejected. If they are not rejected, the initial call to &lt;tt&gt;markReindexingAllSSTables&lt;/tt&gt; will set the involved partial builds counters to zero.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This way, manual rebuilds will be able to reset the pending-for-rebuild-during-restart of the indexes. at the price of requiring mutual exclusion with other rebuilds of the same index. Partial rebuilds can always run but they can be held during the presumably fast call to &lt;tt&gt;markReindexingAllSSTables&lt;/tt&gt; of the manual full index rebuilds.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Other than that, I have a concern about &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk#diff-3f2c8994c4ff8748c3faf7e70958520dR399&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;flushing indexes in the future transformation&lt;/a&gt;, which would cause such blocking activity to happen in the compaction thread, a departure from previous behaviour and probably an unwanted one.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Right, I have modified the transformation to be run &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/ebfcb302bcc8301928c329a377f0d694976eb477/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L500&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;in the asyncExecutor&lt;/a&gt;. The reason for flushing indexes in each future is that we should flush before marking the indexes as built, specially for non &lt;tt&gt;ColumnFamilyStore&lt;/tt&gt;-based indexes, which is not in line with the previous behaviour.&lt;/p&gt;

&lt;p&gt;What do you think? Am I missing some case? Is the &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/ebfcb302bcc8301928c329a377f0d694976eb477/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;timeout of index rebuilds waiting for partial rebuilds&lt;/a&gt; adequate or should we use another value or fail instantly?&lt;/p&gt;</comment>
                            <comment id="16049090" author="sbtourist" created="Wed, 14 Jun 2017 11:46:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;, I reviewed your latest patch and found the concurrent lifecycle implementation a bit hard to understand and maintain. I tried to explain it and give suggestions in writing, but in the end I found it easier and more productive to try an alternative implementation by myself, which you can find &lt;a href=&quot;https://github.com/sbtourist/cassandra/commit/efe452846d29173e8b0d522651e7dc9f49f2597e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;; in a nutshell, this implementation doesn&apos;t require any additional locks and manages a fully thread safe lifecycle whose cases I tried to extensively test.&lt;/p&gt;

&lt;p&gt;Let me know if you (and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;) have any feedback, and feel free to pull it in your branch (just note the patch is implemented against &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/c002d26255eaf53070a840d7232788e33f852e19&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; commit in your branch, that is the one previous to your latest changes).&lt;/p&gt;</comment>
                            <comment id="16049637" author="pauloricardomg" created="Wed, 14 Jun 2017 20:40:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;Let me know if you (and Paulo Motta) have any feedback&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I found the lockless version easier to follow and overall I like the simplified approach of preventing starting a full index rebuild altogether if any other index build is ongoing. Overall I think this is looking very good and nearly good to go, I did some minor updates, please let me know what do you think:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/24f6616c7980ceac5c5ef356205223b78d357846&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Unify&lt;/a&gt; nested try-clause on &lt;tt&gt;SecondaryIndexManager.buildIndexesBlocking&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/9a4008f83bbaf83703d56cabada98db2cf00e3de&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Fix&lt;/a&gt; doc nits and &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/7d8586a7aee8d4c8a252ffddf0d1a21d6a96a21f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;remove&lt;/a&gt; trailing whitespaces&lt;/li&gt;
	&lt;li&gt;The fact that the &lt;tt&gt;SecondaryIndexManager.rebuildIndexesBlocking&lt;/tt&gt; took a collection of SSTables as argument and passed &lt;tt&gt;fullIndexRebuild=true&lt;/tt&gt; downstream was a bit misleading, since it could be wrongly used for a partial index rebuild with only a subset of the SSTables, so I &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/a945358a36f97632e94e9103650d72c04735354d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;simplified&lt;/a&gt; that to expose a single method for full index rebuilds externally which is used by both &lt;tt&gt;ColumnFamilyStore&lt;/tt&gt; and tests. I&apos;m not sure if we should keep the &lt;tt&gt;rebuildFromSSTablesBlocking&lt;/tt&gt; protected or make it public, I can see if being useful to rebuild a subset of the SSTables but It&apos;s not currently used anywhere, but it could maybe used by extensions.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;On a side note, I noticed that &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/c5604ffd5ae36cc34d13af6c4c4eadba98458fa3/test/unit/org/apache/cassandra/index/SecondaryIndexManagerTest.java#L369&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this statement&lt;/a&gt; is wrong (missing table name) but it&apos;s not throwing exception? Should we create a ticket for this?&lt;/p&gt;</comment>
                            <comment id="16050168" author="adelapena" created="Thu, 15 Jun 2017 08:42:54 +0000"  >&lt;p&gt;I also think that the lockless version is cleaner. I have pulled it and made some changes &lt;a href=&quot;https://github.com/adelapena/cassandra/tree/10130-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;:
&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/adelapena/cassandra/commit/ffc328e7af8f32c0f6027338ec3fb503ce75f983&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Set&lt;/a&gt; the &lt;tt&gt;SettableFuture&lt;/tt&gt; in &lt;tt&gt;createIndex&lt;/tt&gt; callback after marking the index to be sure that the marking is done when the returned future finishes.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/adelapena/cassandra/commit/c5604ffd5ae36cc34d13af6c4c4eadba98458fa3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Fix&lt;/a&gt; &lt;tt&gt;SIM#isIndexQueryable&lt;/tt&gt; to ensure that the indexes are not queryable while they are been initialized, which was making &lt;a href=&quot;https://github.com/apache/cassandra/blob/69aa1737d17089278c725cffeca3f69fb25f0aa0/test/unit/org/apache/cassandra/cql3/validation/entities/SecondaryIndexTest.java#L1065&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this test&lt;/a&gt; &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-sergio-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fail&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/adelapena/cassandra/commit/e075b42e4a7c3a8fcc11ca51388e38ebcbd075b4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Update&lt;/a&gt; &lt;tt&gt;CassandraIndexTest#indexCorrectlyMarkedAsBuildAndRemoved&lt;/tt&gt; again to the check new expected behaviour.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It seems that new lockless version is making &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/blob/4031157a28bbefa068820c757457f340f4b77fa0/scrub_test.py#L391&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;scrub_test.TestScrubIndexes.test_standalone_scrub&lt;/tt&gt;&lt;/a&gt; to &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-dtest/lastCompletedBuild/testReport/scrub_test/TestScrubIndexes/test_standalone_scrub/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fail&lt;/a&gt;, I&apos;m still diving into it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure if we should keep the rebuildFromSSTablesBlocking protected or make it public, I can see if being useful to rebuild a subset of the SSTables but It&apos;s not currently used anywhere, but it could maybe used by extensions.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it&apos;s a good idea to make it public to allow extensions to use it, and it is used in &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/eb0316d651bbdec70896be041ab1981cc9349a18/test/unit/org/apache/cassandra/index/internal/CassandraIndexTest.java#L542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;CassandraIndexTest#indexCorrectlyMarkedAsBuildAndRemoved&lt;/tt&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;On a side note, I noticed that &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/c5604ffd5ae36cc34d13af6c4c4eadba98458fa3/test/unit/org/apache/cassandra/index/SecondaryIndexManagerTest.java#L369&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this statement&lt;/a&gt; is wrong (missing table name) but it&apos;s not throwing exception? Should we create a ticket for this?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it isn&apos;t wrong. The &lt;tt&gt;%%s&lt;/tt&gt; is transformed into &lt;tt&gt;%s&lt;/tt&gt; by the first &lt;tt&gt;String#format&lt;/tt&gt;. Then, &lt;tt&gt;CQLTest#createIndex&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/test/unit/org/apache/cassandra/cql3/CQLTester.java#L650&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;applies&lt;/a&gt; another &lt;tt&gt;String#format&lt;/tt&gt; call to set the name of the current table.&lt;/p&gt;




</comment>
                            <comment id="16050253" author="sbtourist" created="Thu, 15 Jun 2017 09:55:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;, excellent additions overall, just a few comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I mistakenly removed &lt;tt&gt;queryableIndexes&lt;/tt&gt; in my refactor (as noted); &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/c5604ffd5ae36cc34d13af6c4c4eadba98458fa3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; commit added it back, but it&apos;s unfortunately not enough, as if the initialization task fails, the index will never be made queryable: we need to fix this, and we need a test for such failure case.&lt;/li&gt;
	&lt;li&gt;Nit/OCD: I would change the &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/a945358a36f97632e94e9103650d72c04735354d#diff-3f2c8994c4ff8748c3faf7e70958520dR306&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;rebuildFromSSTablesBlocking&lt;/a&gt; signature to have the &lt;tt&gt;sstables&lt;/tt&gt; first, consistently with &lt;tt&gt;buildIndexesBlocking&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;buildIndexesBlocking&lt;/tt&gt;, any exceptions thrown by &lt;tt&gt;flushIndexesBlocking&lt;/tt&gt; in the &lt;tt&gt;finally&lt;/tt&gt; block will hide previous exceptions: we should accumulate them.&lt;/li&gt;
	&lt;li&gt;Nit/OCD: In &lt;tt&gt;buildIndexesBlocking&lt;/tt&gt;, we should put an additional comment before invoking &lt;tt&gt;flushIndexesBlocking&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;If &lt;tt&gt;rebuildFromSSTablesBlocking&lt;/tt&gt; is not used elsewhere, I would strongly recommend to make it private/protected and move its comment to &lt;tt&gt;rebuildIndexesBlocking&lt;/tt&gt;: the &lt;a href=&quot;https://image.slidesharecdn.com/effectivejava-2ndedition-chapter4-151203200429-lva1-app6891/95/effective-java-chapter-4-classes-and-interfaces-4-638.jpg?cb=1449173201&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;general rule&lt;/a&gt; is methods (as well as attributes) should have the most restricted visibility allowed by working code.&lt;/li&gt;
	&lt;li&gt;Regarding the &lt;tt&gt;test_standalone_scrub&lt;/tt&gt; failure, I &lt;em&gt;believe&lt;/em&gt; it&apos;s due to the fact we only manage counters in our marking methods when &lt;tt&gt;DatabaseDescriptor.isDaemonInitialized()&lt;/tt&gt;, which is obviously not the case with the scrubber; if so, it&apos;s probably an easy fix.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16050313" author="sbtourist" created="Thu, 15 Jun 2017 10:48:05 +0000"  >&lt;p&gt;As a side note, I opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13606&quot; title=&quot;Improve handling of 2i initialization failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13606&quot;&gt;&lt;del&gt;CASSANDRA-13606&lt;/del&gt;&lt;/a&gt; to further improve initialization failures handling.&lt;/p&gt;</comment>
                            <comment id="16050347" author="sbtourist" created="Thu, 15 Jun 2017 11:15:20 +0000"  >&lt;p&gt;Also, a style note about indentation for lambdas and anonymous classes; I see &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/eb0316d651bbdec70896be041ab1981cc9349a18/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L453&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;some&lt;/a&gt; are deeply indented, but I think that makes the code harder to read, and I prefer &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/eb0316d651bbdec70896be041ab1981cc9349a18/src/java/org/apache/cassandra/index/SecondaryIndexManager.java#L492&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;standard 4 spaces indent&lt;/a&gt;: thoughts? Whatever the choice, we should make the patch consistent (but possibly avoid to change other untouched code)&lt;/p&gt;</comment>
                            <comment id="16050702" author="adelapena" created="Thu, 15 Jun 2017 16:17:12 +0000"  >&lt;p&gt;Here is another version of the patch:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;blockquote&gt;&lt;p&gt;I mistakenly removed {{queryableIndexes]] in my refactor (as noted); &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/c5604ffd5ae36cc34d13af6c4c4eadba98458fa3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; commit added it back, but it&apos;s unfortunately not enough, as if the initialization task fails, the index will never be made queryable: we need to fix this, and we need a test for such failure case.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/adelapena/cassandra/commit/2994aece1e936b81ad507f2e9baf0092e79edce0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Here&lt;/a&gt; a successful full rebuild adds the index to the set of queryable indexes. I have also added &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/2994aece1e936b81ad507f2e9baf0092e79edce0/test/unit/org/apache/cassandra/index/SecondaryIndexManagerTest.java#L386-L456&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;some tests&lt;/a&gt; to check the behaviour. Note that a partial build doesn&apos;t set the index as queryable.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Nit/OCD: I would change the &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/a945358a36f97632e94e9103650d72c04735354d#diff-3f2c8994c4ff8748c3faf7e70958520dR306&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;rebuildFromSSTablesBlocking&lt;/a&gt; signature to have the &lt;tt&gt;sstables&lt;/tt&gt; first, consistently with &lt;tt&gt;buildIndexesBlocking&lt;/tt&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Initially done &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/7dfc959703231c9f90f53a3b474cf7f66b240213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, but see three quotes below.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In &lt;tt&gt;buildIndexesBlocking&lt;/tt&gt;, any exceptions thrown by &lt;tt&gt;flushIndexesBlocking&lt;/tt&gt; in the &lt;tt&gt;finally&lt;/tt&gt; block will hide previous exceptions: we should accumulate them.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/fbce3657132a8b87d2ff2446504634f5efdf2b59&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Nit/OCD: In buildIndexesBlocking, we should put an additional comment before invoking flushIndexesBlocking.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/b7bf81acd66c3bdac66ba86117e07cac251ca312&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If &lt;tt&gt;rebuildFromSSTablesBlocking&lt;/tt&gt; is not used elsewhere, I would strongly recommend to make it private/protected and move its comment to &lt;tt&gt;rebuildIndexesBlocking&lt;/tt&gt;: the &lt;a href=&quot;https://image.slidesharecdn.com/effectivejava-2ndedition-chapter4-151203200429-lva1-app6891/95/effective-java-chapter-4-classes-and-interfaces-4-638.jpg?cb=1449173201&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;general rule&lt;/a&gt; is methods (as well as attributes) should have the most restricted visibility allowed by working code.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually &lt;tt&gt;rebuildFromSSTablesBlocking&lt;/tt&gt; is only called by full rebuilds, so we can eve get rid of this method and move its content and doc to &lt;tt&gt;rebuildIndexesBlocking&lt;/tt&gt;, as it is done &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/cdd32e54f86bd831faa4463489bad153520e2754&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Tests still have access to partial builds through &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/fbce3657132a8b87d2ff2446504634f5efdf2b59/test/unit/org/apache/cassandra/index/SecondaryIndexManagerTest.java#L115&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;handleNotification&lt;/tt&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Regarding the &lt;tt&gt;test_standalone_scrub failure&lt;/tt&gt;, I believe it&apos;s due to the fact we only manage counters in our marking methods when &lt;tt&gt;DatabaseDescriptor.isDaemonInitialized()&lt;/tt&gt;, which is obviously not the case with the scrubber; if so, it&apos;s probably an easy fix.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, it&apos;s fixed &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/a2744560b2d3262b1872c5f989d1baee645b7c5c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Apart form this, &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/70b477bc4c83613474756d39ac36c1301c4a54b2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; I have restored &lt;tt&gt;CassandraIndexTest#indexCorrectlyMarkedAsBuildAndRemoved&lt;/tt&gt; to its initial shape because all the added cases are (better) covered by &lt;tt&gt;SecondaryIndexManagerTest&lt;/tt&gt;. The reason to preserve the test is that it uses a real index implementation instead of a mocked one, which can be useful although the difficulties to simulate failures, blocking, etc.&lt;/p&gt;

&lt;p&gt;I have also removed some unused imports.&lt;/p&gt;</comment>
                            <comment id="16051208" author="pauloricardomg" created="Thu, 15 Jun 2017 23:44:24 +0000"  >&lt;p&gt;The current version looks good to me, except for the following minor stylistic nits that I found that could be improved during review (feel free to take it or disregard):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/74f3eea2d7aa89b644f1ddbc96f9f6d987a27f73&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Update queryableIndexes only on markIndexBuilt and markIndexRemoved&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/07be39d7db7030bb5616344074c1c96d27c90d15&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Rename failedIndexes list to needsFullRebuild&lt;/a&gt; (this is mostly because failed index gives the impression the index is not queryable, while in reality the index can be queryable but only needs full rebuild)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/856ec08d24f615399b0d4a4b063fc96259f60be4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Remove unnecessary marking of index in need of full rebuild on index creation&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/19b6f3c68d1b00895de2d3da5aec54102b44ce9f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Warn user to run full rebuild after index failure and log failure stack trace if present&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Great job guys! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16051794" author="adelapena" created="Fri, 16 Jun 2017 11:44:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;, I think that the suggestions have a lot of sense, we are so close to finish it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. &lt;/p&gt;

&lt;p&gt;It seems that &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/74f3eea2d7aa89b644f1ddbc96f9f6d987a27f73&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;moving the update of &lt;tt&gt;queryableIndexes&lt;/tt&gt;&lt;/a&gt; is &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-paulo-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;breaking some tests at &lt;tt&gt;SASIIndexTest&lt;/tt&gt;&lt;/a&gt;. These tests assume that an invalidated index is still able of responding queries, &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/test/unit/org/apache/cassandra/index/sasi/SASIIndexTest.java#L858-L870&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and also &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/test/unit/org/apache/cassandra/index/sasi/SASIIndexTest.java#L799-L815&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Not sure about if we should preserve this behaviour or change the SASI test.&lt;/p&gt;</comment>
                            <comment id="16051990" author="sbtourist" created="Fri, 16 Jun 2017 14:49:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;Update queryableIndexes only on markIndexBuilt and markIndexRemoved&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we should preserve the original behaviour; it is not perfect, but &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13606&quot; title=&quot;Improve handling of 2i initialization failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13606&quot;&gt;&lt;del&gt;CASSANDRA-13606&lt;/del&gt;&lt;/a&gt; should provide a proper fix.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Remove unnecessary marking of index in need of full rebuild on index creation&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I do not think that was unnecessary, because `createIndex` could fail due to an exception in &lt;tt&gt;Index#getInitializationTask()&lt;/tt&gt;, hence should be considered as failed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Warn user to run full rebuild after index failure and log failure stack trace if present&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 (but &lt;tt&gt;logAndMarkIndexesFailed&lt;/tt&gt; seems to have a bug &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/19b6f3c68d1b00895de2d3da5aec54102b44ce9f#diff-3f2c8994c4ff8748c3faf7e70958520dR627&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Other than that, I&apos;m +1 on the latest changes, I think we&apos;re almost done &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16052046" author="adelapena" created="Fri, 16 Jun 2017 15:41:52 +0000"  >&lt;p&gt;Here we go with &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/3ab7275114f09a4c2581ba1013f1a2a45c0e97e8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the renaming of &lt;tt&gt;failedIndexes&lt;/tt&gt;&lt;/a&gt; and &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/eed1a0f07571b6a3b9e3568c3278cb9bcf37c90a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the new &lt;tt&gt;logAndMarkIndexesFailed&lt;/tt&gt; method&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16052165" author="pauloricardomg" created="Fri, 16 Jun 2017 17:31:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we should preserve the original behaviour; it is not perfect, but &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13606&quot; title=&quot;Improve handling of 2i initialization failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13606&quot;&gt;&lt;del&gt;CASSANDRA-13606&lt;/del&gt;&lt;/a&gt; should provide a proper fix.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I really think it makes the code cleaner and less prone to errors to update &lt;tt&gt;SecondaryIndexManager&lt;/tt&gt; state (&lt;tt&gt;needsFullRebuild&lt;/tt&gt;, &lt;tt&gt;queryableIndexes&lt;/tt&gt; and &lt;tt&gt;inProgressBuilds&lt;/tt&gt;) exclusively in the &lt;tt&gt;mark*&lt;/tt&gt; methods rather than in many places throughout the code.&lt;/p&gt;

&lt;p&gt;The SASI test failures was due to the fact that the &lt;tt&gt;invalidateAllIndexesBlocking&lt;/tt&gt; name was misleading, since this was actually dropping all indexes, so I renamed it to &lt;tt&gt;dropAllIndexes&lt;/tt&gt; and extracted the invalidate part into another method which can be used by the SASI tests.&lt;/p&gt;

&lt;p&gt;Here is the &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/ad8beb0bb4bf40d0e5cc4aee3c1bf02ace3f6929&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit with these changes&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In the same spirit, I also removed the marking of index as failed before fetching the initialization task &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/33f56de12f3573f42e0426cd915fb049405c883d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;on this commit&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Regarding the exception being passed as the last parameter to the logger, that&apos;s not a bug since sl4j &lt;a href=&quot;https://www.slf4j.org/faq.html#paramException&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;will properly handle that case&lt;/a&gt;, so I added &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/b5771f010191b06198880b5c2bb1dfc0c46b3b1c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this commit&lt;/a&gt; reinstating this behavior.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sbtourist&quot; class=&quot;user-hover&quot; rel=&quot;sbtourist&quot;&gt;sbtourist&lt;/a&gt; let me know what do you think before &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; updates the branch with these suggestions.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16053861" author="sbtourist" created="Mon, 19 Jun 2017 11:48:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;I really think it makes the code cleaner and less prone to errors to update SecondaryIndexManager state (needsFullRebuild, queryableIndexes and inProgressBuilds) exclusively in the mark* methods rather than in many places throughout the code.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I know that would be cleaner, but bear in mind that&apos;s also a change from previous behaviour &lt;b&gt;and&lt;/b&gt; would cause the index to be considered queryable even if the initialization task failed and later a non-full rebuild succeeded. I&apos;m not a fan of that, but I&apos;ll leave it to you guys.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I also removed the marking of index as failed before fetching the initialization task on this commit.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Looks good, and also properly marks the index failed (which we forgot to do before).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Regarding the exception being passed as the last parameter to the logger, that&apos;s not a bug since sl4j will properly handle that case&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Apologies, I misread the diff.&lt;/p&gt;

&lt;p&gt;I&apos;d like to finally highlight two further changes from previous behaviour that just crossed my mind (unrelated to Paulo&apos;s patches):&lt;br/&gt;
1) If the index initialization fails because of a non build error, and the index was previously built, it will be rebuilt again from scratch anyway.&lt;br/&gt;
2) If a single sstable build fails, the index will be (potentially) fully rebuilt at restart; while theoretically correct, this could have a non-trivial performance impact at startup.&lt;/p&gt;

&lt;p&gt;That said, #1 is probably better addressed by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13606&quot; title=&quot;Improve handling of 2i initialization failures&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13606&quot;&gt;&lt;del&gt;CASSANDRA-13606&lt;/del&gt;&lt;/a&gt;, while #2 is what worries me most; I personally do not think that automatically rebuilding the indexes at startup gives much advantages, as it&apos;s an async operation anyway, so I&apos;d propose to either/both add a &lt;tt&gt;cassandra.yaml&lt;/tt&gt; option to enable automatic rebuilds explicitly or/and add a flag to NodeTool to rebuild indexes &lt;em&gt;only if&lt;/em&gt; not already built.&lt;/p&gt;

&lt;p&gt;Thoughts?&lt;/p&gt;</comment>
                            <comment id="16054219" author="adelapena" created="Mon, 19 Jun 2017 15:34:35 +0000"  >&lt;p&gt;I have merged the changes by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I really think it makes the code cleaner and less prone to errors to update SecondaryIndexManager state (needsFullRebuild, queryableIndexes and inProgressBuilds) exclusively in the mark* methods rather than in many places throughout the code.&lt;/p&gt;&lt;/blockquote&gt;

&lt;blockquote&gt;&lt;p&gt;I know that would be cleaner, but bear in mind that&apos;s also a change from previous behaviour and would cause the index to be considered queryable even if the initialization task failed and later a non-full rebuild succeeded. I&apos;m not a fan of that, but I&apos;ll leave it to you guys.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What we can do here is adding &lt;tt&gt;isFullRebuild&lt;/tt&gt; to &lt;tt&gt;markIndexBuilt&lt;/tt&gt; to only set the index as queryable if the method is invoked by a full index rebuild, as it is done &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/ca7da30f621e742f85b6a7b1f66d320ba224a6a4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. I have also added a new test to check how a successful partial build doesn&apos;t set the index as queryable when the initialization has failed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;d propose to either/both add a cassandra.yaml option to enable automatic rebuilds explicitly or/and add a flag to NodeTool to rebuild indexes only if not already built.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Adding a cassandra.yaml option seems like a good idea, I think we could address it as an improvement in a separate ticket. About adding a flag to &lt;tt&gt;nodetool rebuild_index&lt;/tt&gt;, I think I&apos;d prefer to add a command to let the user query if/which indexes are built in a more friendly way than looking in the &lt;tt&gt;IndexInfo&lt;/tt&gt; table. Does it make sense?&lt;/p&gt;

</comment>
                            <comment id="16054255" author="pauloricardomg" created="Mon, 19 Jun 2017 16:04:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;What we can do here is adding isFullRebuild to markIndexBuilt to only set the index as queryable if the method is invoked by a full index rebuild&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good call! This approach looks better to me than handling state in non mark-methods and will still keep the current behavior.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Adding a cassandra.yaml option seems like a good idea, I think we could address it as an improvement in a separate ticket. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed. The most typical failures during index rebuild are:&lt;br/&gt;
a) node crash&lt;br/&gt;
b) file system failure&lt;/p&gt;

&lt;p&gt;This patch already provides a good solution to A), and B) should in most cases stop the node via the default &lt;tt&gt;disk_failure_policy: stop&lt;/tt&gt;, so while it would be nice to provide more tools to allow handling 2i rebuild failure more gracefully (via auto-rebuild or nodetool) I think non-crash/stop cases will be pretty uncommon so we can address those in a separate improvement ticket. BTW, relating to point 2, I think we should probably run exceptions during 2i rebuild failure (&lt;tt&gt;logAndMarkIndexesFailed&lt;/tt&gt;) via the &lt;tt&gt;JVMStabilityInspector&lt;/tt&gt;. WDYT?&lt;/p&gt;</comment>
                            <comment id="16054296" author="sbtourist" created="Mon, 19 Jun 2017 16:40:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we should probably run exceptions during 2i rebuild failure (logAndMarkIndexesFailed) via the JVMStabilityInspector&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed.&lt;/p&gt;

&lt;p&gt;+1 otherwise, excellent job everyone &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16055571" author="adelapena" created="Tue, 20 Jun 2017 10:49:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think we should probably run exceptions during 2i rebuild failure (logAndMarkIndexesFailed) via the JVMStabilityInspector&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done &lt;a href=&quot;https://github.com/adelapena/cassandra/compare/ca7da30f621e742f85b6a7b1f66d320ba224a6a4...adelapena:0f6972eacdab6b0c81e00d8c0c59968106d3f462&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, with tests for both create and rebuild.&lt;/p&gt;

&lt;p&gt;Here is the full patch with CI results:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16059129" author="sbtourist" created="Thu, 22 Jun 2017 10:32:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;, the latest commit looks good, just two minor notes about tests:&lt;br/&gt;
1) Shouldn&apos;t we set the &lt;a href=&quot;https://github.com/adelapena/cassandra/compare/ca7da30f621e742f85b6a7b1f66d320ba224a6a4...adelapena:0f6972eacdab6b0c81e00d8c0c59968106d3f462#diff-0ccfd193eadf8f1c2a48cf846b4eb791R549&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;throwable&lt;/a&gt; null on &lt;tt&gt;TestingIndex#clear()&lt;/tt&gt;?&lt;br/&gt;
2) Shouldn&apos;t we test the stability inspector on index creation too?&lt;/p&gt;</comment>
                            <comment id="16059186" author="adelapena" created="Thu, 22 Jun 2017 11:17:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;1) Shouldn&apos;t we set the &lt;a href=&quot;https://github.com/adelapena/cassandra/compare/ca7da30f621e742f85b6a7b1f66d320ba224a6a4...adelapena:0f6972eacdab6b0c81e00d8c0c59968106d3f462#diff-0ccfd193eadf8f1c2a48cf846b4eb791R549&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;throwable&lt;/a&gt; null on TestingIndex#clear()?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I totally forgot to reset the two throwables, fixed &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/387b21f2e8d2c1f6cc6b5f46be8ed0039d32c0bf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2) Shouldn&apos;t we test the stability inspector on index creation too?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There were tests for the the stability inspector on index creation &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/387b21f2e8d2c1f6cc6b5f46be8ed0039d32c0bf/test/unit/org/apache/cassandra/index/SecondaryIndexManagerTest.java#L477-L512&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="16059279" author="adelapena" created="Thu, 22 Jun 2017 12:37:45 +0000"  >&lt;p&gt;I have also fixed &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/3e82cd890f64bd75463568ee67d69a5003f6d935&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;SecondaryIndexManagerTest#rebuildWithFailure&lt;/tt&gt;&lt;/a&gt; to wait until the index creation has finished before attempting the failing rebuild. This test was slightly flaky, failing very rarely.&lt;/p&gt;</comment>
                            <comment id="16059725" author="sbtourist" created="Thu, 22 Jun 2017 17:37:59 +0000"  >&lt;p&gt;Excellent, can we have another utests/dtests run before the final +1?&lt;/p&gt;</comment>
                            <comment id="16059753" author="adelapena" created="Thu, 22 Jun 2017 17:54:49 +0000"  >&lt;p&gt;Sure:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:10130-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/adelapena/job/adelapena-10130-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The last execution doesn&apos;t contain the last commit fixing &lt;tt&gt;SecondaryIndexManagerTest#rebuildWithFailure&lt;/tt&gt;. The new job execution should take a little bit more than two hours.&lt;/p&gt;</comment>
                            <comment id="16059763" author="pauloricardomg" created="Thu, 22 Jun 2017 17:59:41 +0000"  >&lt;p&gt;LGTM after CI is happy. Great job!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The last execution doesn&apos;t contain the last commit fixing SecondaryIndexManagerTest#rebuildWithFailure. The new job execution should take a little bit more than two hours.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not sure if you already prepared for commit (CHANGES, squash+rebase) but it would probably be wise to do that before submitting another CI round to make sure we catch any potential problems on CI after rebase.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16060038" author="adelapena" created="Thu, 22 Jun 2017 21:30:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure if you already prepared for commit (CHANGES, squash+rebase) but it would probably be wise to do that before submitting another CI round to make sure we catch any potential problems on CI after rebase.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Wise idea, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;. I hadn&apos;t prepared it for commit, but now I have. The squashed and rebased patch is in &lt;a href=&quot;https://github.com/adelapena/cassandra/commits/10130-trunk-squash&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this branch&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The notice for CHANGES.txt is &quot;Fix management of secondary indexes (re)builds (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10130&quot; title=&quot;Node failure during 2i update after streaming can have incomplete 2i when restarted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10130&quot;&gt;&lt;del&gt;CASSANDRA-10130&lt;/del&gt;&lt;/a&gt;)&quot;, which is quite generic and distant from the title of this ticket. Suggestions are welcome.&lt;/p&gt;

&lt;p&gt;I ran the final patch on our internal CI. There are not failures for the unit tests and the failing dtests are not related to the change.&lt;/p&gt;</comment>
                            <comment id="16060108" author="pauloricardomg" created="Thu, 22 Jun 2017 22:20:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;The squashed and rebased patch is in this branch.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The squashed patch LGTM, you should just need to format the commit message to include the reviewers (&lt;a href=&quot;https://wiki.apache.org/cassandra/HowToContribute#Committing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;format here&lt;/a&gt;).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The notice for CHANGES.txt is &quot;Fix management of secondary indexes (re)builds (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10130&quot; title=&quot;Node failure during 2i update after streaming can have incomplete 2i when restarted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10130&quot;&gt;&lt;del&gt;CASSANDRA-10130&lt;/del&gt;&lt;/a&gt;)&quot;, which is quite generic and distant from the title of this ticket. Suggestions are welcome.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Perhaps &quot;Improve secondary index (re)build failure and concurrency handling&quot;? &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I ran the final patch on our internal CI. There are not failures for the unit tests and the failing dtests are not related to the change.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Great job, ship it! (pending &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sbtourist&quot; class=&quot;user-hover&quot; rel=&quot;sbtourist&quot;&gt;sbtourist&lt;/a&gt; final +1) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16060582" author="adelapena" created="Fri, 23 Jun 2017 08:37:07 +0000"  >&lt;p&gt;I have just updated both the CHANGES.txt and the commit message, &lt;a href=&quot;https://github.com/adelapena/cassandra/commits/10130-trunk-squash&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Thanks!&lt;/p&gt;</comment>
                            <comment id="16060619" author="sbtourist" created="Fri, 23 Jun 2017 09:23:21 +0000"  >&lt;p&gt;Excellent job everyone! +1&lt;/p&gt;</comment>
                            <comment id="16060672" author="adelapena" created="Fri, 23 Jun 2017 10:05:01 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/679c31718b709f5619bba80eeb6f388484b94c3c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;679c31718b709f5619bba80eeb6f388484b94c3c&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Thanks a lot for your help!&lt;/p&gt;</comment>
                            <comment id="16060684" author="adelapena" created="Fri, 23 Jun 2017 10:14:34 +0000"  >&lt;p&gt;PR for dtests &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1486&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12827376">CASSANDRA-9308</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13542853">CASSANDRA-18656</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="13080050">CASSANDRA-13606</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 21 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2j467:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>pauloricardomg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
        <customfieldvalue><![CDATA[sbtourist]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>