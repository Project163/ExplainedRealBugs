<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:34:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-20596] NPE when executing IF block in transactions with invalid comparison</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-20596</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I managed to catch a NPE when trying to execute a transaction.&#160; This came about from an error in my syntax, but I think we should handle this more gracefully.&lt;/p&gt;

&lt;p&gt;Here&apos;s the setup:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;create KEYSPACE games WITH replication = {&apos;class&apos;: &apos;SimpleStrategy&apos;, &apos;replication_factor&apos;: 1};
USE games;
CREATE TABLE games.high_scores_by_user ( user text, game text, score int, primary key(user, game))
WITH compaction = {&apos;class&apos;: &apos;UnifiedCompactionStrategy&apos;, &apos;scaling_parameters&apos;: &apos;L10&apos;}
AND transactional_mode = &apos;full&apos;;
CREATE TABLE games.leaderboard (game text, score int, user text, primary key (game, score, &#160;user))
WITH compaction = {&apos;class&apos;: &apos;UnifiedCompactionStrategy&apos;, &apos;scaling_parameters&apos;: &apos;L10&apos;}
AND clustering order by (score DESC, user ASC)
AND transactional_mode = &apos;full&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The query:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;BEGIN TRANSACTION
&#160; LET high_score = (SELECT * from games.high_scores_by_user WHERE user = &apos;jon&apos; and game = &apos;pictionary&apos;);
&#160; SELECT high_score.score;
&#160; IF high_score = 100 THEN
&#160; INSERT INTO games.high_scores_by_user (game, score, user) VALUES (&apos;pictionary&apos;, 110, &apos;jon&apos;);
&#160; INSERT INTO games.leaderboard (game, score, user) VALUES (&apos;pictionary&apos;, 110, &apos;jon&apos;);
&#160; DELETE from games.leaderboard WHERE user = &apos;jon&apos; AND game = &apos;pictionary&apos; AND score = 100;
&#160; END IF
COMMIT TRANSACTION;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the IF block I forgot to put the field I was comparing, it should have been high_score.score, and got the following:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;NoHostAvailable: (&apos;Unable to complete the operation against any hosts&apos;, {&amp;lt;Host: 127.0.0.1:9042 datacenter1&amp;gt;: &amp;lt;Error from server: code=0000 [Server error] message=&quot;java.lang.NullPointerException: Cannot read field &quot;type&quot; because &quot;receiver&quot; is null&quot;&amp;gt;})&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;On the server side, I see this:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [Native-Transport-Requests-1] 2025-04-24 16:00:15,711 QueryMessage.java:130 - Unexpected error during query
java.lang.NullPointerException: Cannot read field &quot;type&quot; because &quot;receiver&quot; is null
&#160; &#160; at org.apache.cassandra.cql3.terms.Constants$Literal.testAssignment(Constants.java:326)
&#160; &#160; at org.apache.cassandra.cql3.terms.Constants$Literal.prepare(Constants.java:295)
&#160; &#160; at org.apache.cassandra.cql3.terms.Constants$Literal.prepare(Constants.java:243)
&#160; &#160; at org.apache.cassandra.cql3.transactions.ConditionStatement$Raw.prepare(ConditionStatement.java:105)
&#160; &#160; at org.apache.cassandra.cql3.statements.TransactionStatement$Parsed.prepare(TransactionStatement.java:734)
&#160; &#160; at org.apache.cassandra.cql3.QueryProcessor.getStatement(QueryProcessor.java:911)
&#160; &#160; at org.apache.cassandra.cql3.QueryProcessor.parse(QueryProcessor.java:360)
&#160; &#160; at org.apache.cassandra.transport.messages.QueryMessage.execute(QueryMessage.java:116)
&#160; &#160; at org.apache.cassandra.transport.Message$Request.execute(Message.java:259)
&#160; &#160; at org.apache.cassandra.transport.Dispatcher.processRequest(Dispatcher.java:423)
&#160; &#160; at org.apache.cassandra.transport.Dispatcher.processRequest(Dispatcher.java:442)
&#160; &#160; at org.apache.cassandra.transport.Dispatcher.processRequest(Dispatcher.java:469)
&#160; &#160; at org.apache.cassandra.transport.Dispatcher$RequestProcessor.run(Dispatcher.java:314)
&#160; &#160; at org.apache.cassandra.concurrent.FutureTask$1.call(FutureTask.java:99)
&#160; &#160; at org.apache.cassandra.concurrent.FutureTask.call(FutureTask.java:61)
&#160; &#160; at org.apache.cassandra.concurrent.FutureTask.run(FutureTask.java:71)
&#160; &#160; at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:145)
&#160; &#160; at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
&#160; &#160; at java.base/java.lang.Thread.run(Thread.java:840)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13616308">CASSANDRA-20596</key>
            <summary>NPE when executing IF block in transactions with invalid comparison</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pranavshenoy06">Pranav</assignee>
                                    <reporter username="rustyrazorblade">Jon Haddad</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Apr 2025 23:05:31 +0000</created>
                <updated>Thu, 26 Jun 2025 01:56:27 +0000</updated>
                            <resolved>Thu, 26 Jun 2025 01:56:14 +0000</resolved>
                                        <fixVersion>6.x</fixVersion>
                                    <component>Accord</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17947177" author="rustyrazorblade" created="Fri, 25 Apr 2025 01:02:51 +0000"  >&lt;p&gt;I&apos;m not sure if this is because of what I did before, but it looks like the journal is now corrupt:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [AccordExecutor[3,3]] 2025-04-24 17:56:39,671 AccordAgent.java:149 - Uncaught accord exception
java.lang.IllegalStateException: Command [23,1745536687761000,146(KW),1] that is being loaded is not owned by this shard on route {homeKey:1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,[1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,1b255f4d-ef25-40a6-0000-000000000016:6237401078196462507]}
	at accord.utils.Invariants.createIllegalState(Invariants.java:77)
	at accord.utils.Invariants.illegalState(Invariants.java:82)
	at accord.utils.Invariants.require(Invariants.java:272)
	at accord.local.Cleanup.cleanupWithFullRoute(Cleanup.java:181)
	at accord.local.Cleanup.shouldCleanupInternal(Cleanup.java:170)
	at accord.local.Cleanup.shouldCleanup(Cleanup.java:128)
	at accord.impl.CommandChange$Builder.shouldCleanup(CommandChange.java:321)
	at accord.impl.CommandChange$Builder.maybeCleanup(CommandChange.java:329)
	at org.apache.cassandra.service.accord.AccordJournal.loadCommand(AccordJournal.java:232)
	at org.apache.cassandra.service.accord.AccordCommandStore.loadCommand(AccordCommandStore.java:475)
	at org.apache.cassandra.service.accord.AccordCache$CommandAdapter.load(AccordCache.java:1178)
	at org.apache.cassandra.service.accord.AccordCache$CommandAdapter.load(AccordCache.java:1169)
	at org.apache.cassandra.service.accord.AccordCacheEntry.lambda$load$0(AccordCacheEntry.java:333)
	at org.apache.cassandra.service.accord.AccordExecutor$PlainRunnable.run(AccordExecutor.java:1074)
	at org.apache.cassandra.service.accord.AccordExecutorAbstractLockLoop.runWithoutLock(AccordExecutorAbstractLockLoop.java:257)
	at org.apache.cassandra.service.accord.AccordExecutorLoops.lambda$wrap$0(AccordExecutorLoops.java:63)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:840)
ERROR [AccordExecutor[3,3]] 2025-04-24 17:56:39,671 JVMStabilityInspector.java:71 - Exception in thread Thread[AccordExecutor[3,3],5,system]
java.lang.IllegalStateException: Command [23,1745536687761000,146(KW),1] that is being loaded is not owned by this shard on route {homeKey:1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,[1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,1b255f4d-ef25-40a6-0000-000000000016:6237401078196462507]}
	at accord.utils.Invariants.createIllegalState(Invariants.java:77)
	at accord.utils.Invariants.illegalState(Invariants.java:82)
	at accord.utils.Invariants.require(Invariants.java:272)
	at accord.local.Cleanup.cleanupWithFullRoute(Cleanup.java:181)
	at accord.local.Cleanup.shouldCleanupInternal(Cleanup.java:170)
	at accord.local.Cleanup.shouldCleanup(Cleanup.java:128)
	at accord.impl.CommandChange$Builder.shouldCleanup(CommandChange.java:321)
	at accord.impl.CommandChange$Builder.maybeCleanup(CommandChange.java:329)
	at org.apache.cassandra.service.accord.AccordJournal.loadCommand(AccordJournal.java:232)
	at org.apache.cassandra.service.accord.AccordCommandStore.loadCommand(AccordCommandStore.java:475)
	at org.apache.cassandra.service.accord.AccordCache$CommandAdapter.load(AccordCache.java:1178)
	at org.apache.cassandra.service.accord.AccordCache$CommandAdapter.load(AccordCache.java:1169)
	at org.apache.cassandra.service.accord.AccordCacheEntry.lambda$load$0(AccordCacheEntry.java:333)
	at org.apache.cassandra.service.accord.AccordExecutor$PlainRunnable.run(AccordExecutor.java:1074)
	at org.apache.cassandra.service.accord.AccordExecutorAbstractLockLoop.runWithoutLock(AccordExecutorAbstractLockLoop.java:257)
	at org.apache.cassandra.service.accord.AccordExecutorLoops.lambda$wrap$0(AccordExecutorLoops.java:63)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:840)
ERROR [AccordExecutor[3,3]] 2025-04-24 17:56:39,672 AccordAgent.java:149 - Uncaught accord exception
java.lang.IllegalStateException: Command [23,1745536687761000,146(KW),1] that is being loaded is not owned by this shard on route {homeKey:1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,[1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,1b255f4d-ef25-40a6-0000-000000000016:6237401078196462507]}
	at accord.utils.Invariants.createIllegalState(Invariants.java:77)
	at accord.utils.Invariants.illegalState(Invariants.java:82)
	at accord.utils.Invariants.require(Invariants.java:272)
	at accord.local.Cleanup.cleanupWithFullRoute(Cleanup.java:181)
	at accord.local.Cleanup.shouldCleanupInternal(Cleanup.java:170)
	at accord.local.Cleanup.shouldCleanup(Cleanup.java:128)
	at accord.impl.CommandChange$Builder.shouldCleanup(CommandChange.java:321)
	at accord.impl.CommandChange$Builder.maybeCleanup(CommandChange.java:329)
	at org.apache.cassandra.service.accord.AccordJournal.loadCommand(AccordJournal.java:232)
	at org.apache.cassandra.service.accord.AccordCommandStore.loadCommand(AccordCommandStore.java:475)
	at org.apache.cassandra.service.accord.AccordCache$CommandAdapter.load(AccordCache.java:1178)
	at org.apache.cassandra.service.accord.AccordCache$CommandAdapter.load(AccordCache.java:1169)
	at org.apache.cassandra.service.accord.AccordCacheEntry.lambda$load$0(AccordCacheEntry.java:333)
	at org.apache.cassandra.service.accord.AccordExecutor$PlainRunnable.run(AccordExecutor.java:1074)
	at org.apache.cassandra.service.accord.AccordExecutorAbstractLockLoop.runWithoutLock(AccordExecutorAbstractLockLoop.java:257)
	at org.apache.cassandra.service.accord.AccordExecutorLoops.lambda$wrap$0(AccordExecutorLoops.java:63)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:840)
ERROR [AccordExecutor[3,3]] 2025-04-24 17:56:39,672 JVMStabilityInspector.java:71 - Exception in thread Thread[AccordExecutor[3,3],5,system]
java.lang.IllegalStateException: Command [23,1745536687761000,146(KW),1] that is being loaded is not owned by this shard on route {homeKey:1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,[1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,1b255f4d-ef25-40a6-0000-000000000016:6237401078196462507]}
	at accord.utils.Invariants.createIllegalState(Invariants.java:77)
	at accord.utils.Invariants.illegalState(Invariants.java:82)
	at accord.utils.Invariants.require(Invariants.java:272)
	at accord.local.Cleanup.cleanupWithFullRoute(Cleanup.java:181)
	at accord.local.Cleanup.shouldCleanupInternal(Cleanup.java:170)
	at accord.local.Cleanup.shouldCleanup(Cleanup.java:128)
	at accord.impl.CommandChange$Builder.shouldCleanup(CommandChange.java:321)
	at accord.impl.CommandChange$Builder.maybeCleanup(CommandChange.java:329)
	at org.apache.cassandra.service.accord.AccordJournal.loadCommand(AccordJournal.java:232)
	at org.apache.cassandra.service.accord.AccordCommandStore.loadCommand(AccordCommandStore.java:475)
	at org.apache.cassandra.service.accord.AccordCache$CommandAdapter.load(AccordCache.java:1178)
	at org.apache.cassandra.service.accord.AccordCache$CommandAdapter.load(AccordCache.java:1169)
	at org.apache.cassandra.service.accord.AccordCacheEntry.lambda$load$0(AccordCacheEntry.java:333)
	at org.apache.cassandra.service.accord.AccordExecutor$PlainRunnable.run(AccordExecutor.java:1074)
	at org.apache.cassandra.service.accord.AccordExecutorAbstractLockLoop.runWithoutLock(AccordExecutorAbstractLockLoop.java:257)
	at org.apache.cassandra.service.accord.AccordExecutorLoops.lambda$wrap$0(AccordExecutorLoops.java:63)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:840)
Exception (java.lang.RuntimeException) encountered during startup: Can not replay journal.
java.lang.RuntimeException: Can not replay journal.
	at org.apache.cassandra.service.accord.AccordJournal.replay(AccordJournal.java:471)
	at org.apache.cassandra.service.accord.AccordService.replayJournal(AccordService.java:246)
	at org.apache.cassandra.service.accord.AccordService.startup(AccordService.java:235)
	at org.apache.cassandra.tcm.Startup.startup(Startup.java:427)
	at org.apache.cassandra.tcm.Startup.startup(Startup.java:399)
	at org.apache.cassandra.service.StorageService.joinRing(StorageService.java:954)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:849)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:373)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:735)
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:889)
Caused by: java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.IllegalStateException: Command [23,1745536687761000,146(KW),1] that is being loaded is not owned by this shard on route {homeKey:1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,[1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,1b255f4d-ef25-40a6-0000-000000000016:6237401078196462507]}
	at accord.utils.async.AsyncChains.getUnchecked(AsyncChains.java:865)
	at org.apache.cassandra.service.accord.AccordJournal.replay(AccordJournal.java:454)
	... 9 more
Caused by: java.util.concurrent.ExecutionException: java.lang.IllegalStateException: Command [23,1745536687761000,146(KW),1] that is being loaded is not owned by this shard on route {homeKey:1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,[1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,1b255f4d-ef25-40a6-0000-000000000016:6237401078196462507]}
	at accord.utils.async.AsyncChains.getBlocking(AsyncChains.java:818)
	at accord.utils.async.AsyncChains.getUninterruptibly(AsyncChains.java:842)
	at accord.utils.async.AsyncChains.getUninterruptibly(AsyncChains.java:825)
	at accord.utils.async.AsyncChains.getUnchecked(AsyncChains.java:861)
	... 10 more
Caused by: java.lang.IllegalStateException: Command [23,1745536687761000,146(KW),1] that is being loaded is not owned by this shard on route {homeKey:1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,[1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,1b255f4d-ef25-40a6-0000-000000000016:6237401078196462507]}
	at accord.utils.Invariants.createIllegalState(Invariants.java:77)
	at accord.utils.Invariants.illegalState(Invariants.java:82)
	at accord.utils.Invariants.require(Invariants.java:272)
	at accord.local.Cleanup.cleanupWithFullRoute(Cleanup.java:181)
	at accord.local.Cleanup.shouldCleanupInternal(Cleanup.java:170)
	at accord.local.Cleanup.shouldCleanup(Cleanup.java:128)
	at accord.impl.CommandChange$Builder.shouldCleanup(CommandChange.java:321)
	at accord.impl.CommandChange$Builder.maybeCleanup(CommandChange.java:329)
	at org.apache.cassandra.service.accord.AccordJournal.loadCommand(AccordJournal.java:232)
	at org.apache.cassandra.service.accord.AccordCommandStore.loadCommand(AccordCommandStore.java:475)
	at org.apache.cassandra.service.accord.AccordCache$CommandAdapter.load(AccordCache.java:1178)
	at org.apache.cassandra.service.accord.AccordCache$CommandAdapter.load(AccordCache.java:1169)
	at org.apache.cassandra.service.accord.AccordCacheEntry.lambda$load$0(AccordCacheEntry.java:333)
	at org.apache.cassandra.service.accord.AccordExecutor$PlainRunnable.run(AccordExecutor.java:1074)
	at org.apache.cassandra.service.accord.AccordExecutorAbstractLockLoop.runWithoutLock(AccordExecutorAbstractLockLoop.java:257)
	at org.apache.cassandra.service.accord.AccordExecutorLoops.lambda$wrap$0(AccordExecutorLoops.java:63)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:840)
ERROR [main] 2025-04-24 17:56:39,672 CassandraDaemon.java:916 - Exception encountered during startup
java.lang.RuntimeException: Can not replay journal.
	at org.apache.cassandra.service.accord.AccordJournal.replay(AccordJournal.java:471)
	at org.apache.cassandra.service.accord.AccordService.replayJournal(AccordService.java:246)
	at org.apache.cassandra.service.accord.AccordService.startup(AccordService.java:235)
	at org.apache.cassandra.tcm.Startup.startup(Startup.java:427)
	at org.apache.cassandra.tcm.Startup.startup(Startup.java:399)
	at org.apache.cassandra.service.StorageService.joinRing(StorageService.java:954)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:849)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:373)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:735)
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:889)
Caused by: java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.IllegalStateException: Command [23,1745536687761000,146(KW),1] that is being loaded is not owned by this shard on route {homeKey:1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,[1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,1b255f4d-ef25-40a6-0000-000000000016:6237401078196462507]}
	at accord.utils.async.AsyncChains.getUnchecked(AsyncChains.java:865)
	at org.apache.cassandra.service.accord.AccordJournal.replay(AccordJournal.java:454)
	... 9 common frames omitted
Caused by: java.util.concurrent.ExecutionException: java.lang.IllegalStateException: Command [23,1745536687761000,146(KW),1] that is being loaded is not owned by this shard on route {homeKey:1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,[1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,1b255f4d-ef25-40a6-0000-000000000016:6237401078196462507]}
	at accord.utils.async.AsyncChains.getBlocking(AsyncChains.java:818)
	at accord.utils.async.AsyncChains.getUninterruptibly(AsyncChains.java:842)
	at accord.utils.async.AsyncChains.getUninterruptibly(AsyncChains.java:825)
	at accord.utils.async.AsyncChains.getUnchecked(AsyncChains.java:861)
	... 10 common frames omitted
Caused by: java.lang.IllegalStateException: Command [23,1745536687761000,146(KW),1] that is being loaded is not owned by this shard on route {homeKey:1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,[1b255f4d-ef25-40a6-0000-000000000015:-4837685732957183785,1b255f4d-ef25-40a6-0000-000000000016:6237401078196462507]}
	at accord.utils.Invariants.createIllegalState(Invariants.java:77)
	at accord.utils.Invariants.illegalState(Invariants.java:82)
	at accord.utils.Invariants.require(Invariants.java:272)
	at accord.local.Cleanup.cleanupWithFullRoute(Cleanup.java:181)
	at accord.local.Cleanup.shouldCleanupInternal(Cleanup.java:170)
	at accord.local.Cleanup.shouldCleanup(Cleanup.java:128)
	at accord.impl.CommandChange$Builder.shouldCleanup(CommandChange.java:321)
	at accord.impl.CommandChange$Builder.maybeCleanup(CommandChange.java:329)
	at org.apache.cassandra.service.accord.AccordJournal.loadCommand(AccordJournal.java:232)
	at org.apache.cassandra.service.accord.AccordCommandStore.loadCommand(AccordCommandStore.java:475)
	at org.apache.cassandra.service.accord.AccordCache$CommandAdapter.load(AccordCache.java:1178)
	at org.apache.cassandra.service.accord.AccordCache$CommandAdapter.load(AccordCache.java:1169)
	at org.apache.cassandra.service.accord.AccordCacheEntry.lambda$load$0(AccordCacheEntry.java:333)
	at org.apache.cassandra.service.accord.AccordExecutor$PlainRunnable.run(AccordExecutor.java:1074)
	at org.apache.cassandra.service.accord.AccordExecutorAbstractLockLoop.runWithoutLock(AccordExecutorAbstractLockLoop.java:257)
	at org.apache.cassandra.service.accord.AccordExecutorLoops.lambda$wrap$0(AccordExecutorLoops.java:63)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:840)
INFO  [StorageServiceShutdownHook] 2025-04-24 17:56:39,675 HintsService.java:268 - Paused hints dispatch
INFO  [StorageServiceShutdownHook] 2025-04-24 17:56:39,675 Gossiper.java:1827 - Announcing shutdown
INFO  [StorageServiceShutdownHook] 2025-04-24 17:56:39,675 StorageService.java:2190 - Node localhost/127.0.0.1:7000 state jump to shutdown
ERROR [StorageServiceShutdownHook] 2025-04-24 17:56:41,682 StorageService.java:3933 - Caught an exception while draining
java.lang.IllegalStateException: Caught interrupt while shutting down org.apache.cassandra.service.accord.AccordJournal@63f1c136
	at org.apache.cassandra.utils.ExecutorUtils.shutdownSequentiallyAndWait(ExecutorUtils.java:108)
	at org.apache.cassandra.service.accord.AccordService.shutdownAndWait(AccordService.java:708)
	at org.apache.cassandra.service.StorageService.drain(StorageService.java:3811)
	at org.apache.cassandra.service.StorageService$1.runMayThrow(StorageService.java:736)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:26)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.Thread.run(Thread.java:840)
Caused by: java.lang.IllegalStateException: STARTING
	at accord.utils.Invariants.createIllegalState(Invariants.java:77)
	at accord.utils.Invariants.illegalState(Invariants.java:82)
	at accord.utils.Invariants.require(Invariants.java:260)
	at org.apache.cassandra.service.accord.AccordJournal.shutdown(AccordJournal.java:201)
	at org.apache.cassandra.utils.ExecutorUtils.shutdownSequentiallyAndWait(ExecutorUtils.java:99)
	... 6 common frames omitted
INFO  [StorageServiceShutdownHook] 2025-04-24 17:56:41,683 StorageService.java:740 - Cassandra shutdown complete
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17947298" author="benedict" created="Fri, 25 Apr 2025 10:04:38 +0000"  >&lt;p&gt;The &lt;tt&gt;IllegalStateException&lt;/tt&gt; is probably not a journal &quot;corruption&quot; issue per se, and it shouldn&apos;t be due to what you did. This might be down to schema changes, but we probably don&apos;t print enough debug log info just yet to easily diagnose this remotely. Have you dropped a table by any chance? Or even re-created a table with the same name? It looks like this is a table created on epoch 15, and it is trying to execute in epoch 23. If it got erased in-between, it might be an issue with our logic to reject commands, or it could be we have some other command store mapping or epoch handling issue that we haven&apos;t seen yet.&lt;/p&gt;</comment>
                            <comment id="17947908" author="dcapwell" created="Mon, 28 Apr 2025 18:27:55 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
IF high_score = 100 THEN
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This should not NPE, and instead tell you that this doesn&apos;t make sense.  The desired behavior here is that during validation we check if a row reference is used for any condition other than IF EXISTS or IF NOT EXISTS&lt;/p&gt;</comment>
                            <comment id="17950636" author="JIRAUSER308790" created="Sat, 10 May 2025 04:13:10 +0000"  >&lt;p&gt;will take this up.&lt;/p&gt;</comment>
                            <comment id="17950638" author="JIRAUSER308790" created="Sat, 10 May 2025 04:35:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rustyrazorblade&quot; class=&quot;user-hover&quot; rel=&quot;rustyrazorblade&quot;&gt;rustyrazorblade&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt;&#160; raised a CR for this fix. Could you please review it?&#160; Thanks&#160;&lt;br/&gt;
link: &lt;a href=&quot;https://github.com/apache/cassandra/pull/4153&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/4153&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17951066" author="dcapwell" created="Mon, 12 May 2025 23:07:12 +0000"  >&lt;p&gt;thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pranavshenoy06&quot; class=&quot;user-hover&quot; rel=&quot;pranavshenoy06&quot;&gt;pranavshenoy06&lt;/a&gt;, did a review and put my feedback.&lt;/p&gt;</comment>
                            <comment id="17951270" author="rustyrazorblade" created="Tue, 13 May 2025 19:17:03 +0000"  >&lt;p&gt;Please also add tests to prevent regressions and validate everything works properly.  I should be able to look at the test and know the feature works as intended.&lt;/p&gt;</comment>
                            <comment id="17955299" author="dcapwell" created="Fri, 30 May 2025 19:34:47 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17955804" author="JIRAUSER308790" created="Tue, 3 Jun 2025 02:22:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rustyrazorblade&quot; class=&quot;user-hover&quot; rel=&quot;rustyrazorblade&quot;&gt;rustyrazorblade&lt;/a&gt;&#160; have added test cases, can you review it? Thanks&lt;/p&gt;</comment>
                            <comment id="17955934" author="rustyrazorblade" created="Tue, 3 Jun 2025 15:29:58 +0000"  >&lt;p&gt;I&apos;m afraid I don&apos;t have time to do reviews, someone else will have to pick this up.&lt;/p&gt;</comment>
                            <comment id="17985983" author="maxwellguo" created="Wed, 25 Jun 2025 03:27:06 +0000"  >&lt;p&gt;+1 &lt;/p&gt;

&lt;p&gt;let&apos;s see the ci &apos;s result : &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/310/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/310/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17986001" author="maxwellguo" created="Wed, 25 Jun 2025 05:55:22 +0000"  >&lt;p&gt;CI is good ,ready to commit &lt;/p&gt;</comment>
                            <comment id="17986264" author="maxwellguo" created="Thu, 26 Jun 2025 01:49:44 +0000"  >&lt;p&gt;committed as 4437fa4fd42f76106493965e400cc5b79510c00a, thanks .&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13076259" name="corrupt.zip" size="606340" author="rustyrazorblade" created="Fri, 25 Apr 2025 01:04:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pranavshenoy06]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12987" cascade-level="1"><![CDATA[Transient Incorrect Response]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            19 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1vjiw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
        <customfieldvalue><![CDATA[maxwellguo]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/4437fa4fd42f76106493965e400cc5b79510c00a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/4437fa4fd42f76106493965e400cc5b79510c00a&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;tested it locally and now the error explicitly states what the issue is.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
NoHostAvailable: (&lt;span class=&quot;code-quote&quot;&gt;&apos;Unable to complete the operation against any hosts&apos;&lt;/span&gt;, {&amp;lt;Host: 127.0.0.1:9042 datacenter1&amp;gt;: &amp;lt;Error from server: code=0000 [Server error] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.IllegalStateException: Row reference (high_score) can only be used with IS NULL/IS NOT NULL conditions&quot;&lt;/span&gt;&amp;gt;}) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>