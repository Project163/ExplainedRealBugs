<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:27:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14227] Extend maximum expiration date</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14227</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The maximum expiration timestamp that can be represented by the storage engine is&lt;br/&gt;
2038-01-19T03:14:06+00:00 due to the encoding of &lt;tt&gt;localExpirationTime&lt;/tt&gt; as an int32.&lt;/p&gt;

&lt;p&gt;On &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14092&quot; title=&quot;Max ttl of 20 years will overflow localDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14092&quot;&gt;&lt;del&gt;CASSANDRA-14092&lt;/del&gt;&lt;/a&gt; we added an overflow policy which rejects requests with expiration above the maximum date as a temporary measure, but we should remove this limitation by updating the storage engine to support at least the maximum allowed TTL of 20 years.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13137703">CASSANDRA-14227</key>
            <summary>Extend maximum expiration date</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bereng">Berenguer Blasi</assignee>
                                    <reporter username="pauloricardomg">Paulo Motta</reporter>
                        <labels>
                    </labels>
                <created>Sun, 11 Feb 2018 13:44:31 +0000</created>
                <updated>Wed, 7 Feb 2024 03:37:07 +0000</updated>
                            <resolved>Mon, 5 Jun 2023 05:23:08 +0000</resolved>
                                        <fixVersion>5.0-alpha1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>7</votes>
                                    <watches>23</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="16359946" author="pauloricardomg" created="Sun, 11 Feb 2018 13:46:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=VincentWhite&quot; class=&quot;user-hover&quot; rel=&quot;VincentWhite&quot;&gt;VincentWhite&lt;/a&gt; feel free to add your PoC patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14092&quot; title=&quot;Max ttl of 20 years will overflow localDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14092&quot;&gt;&lt;del&gt;CASSANDRA-14092&lt;/del&gt;&lt;/a&gt;. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16427544" author="pauloricardomg" created="Thu, 5 Apr 2018 20:30:18 +0000"  >&lt;p&gt;It would be great to get this in for 4.0. The simplest approach would be to change the &lt;tt&gt;localDeletionTime&lt;/tt&gt; representation to &lt;tt&gt;long&lt;/tt&gt; as proposed by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=VincentWhite&quot; class=&quot;user-hover&quot; rel=&quot;VincentWhite&quot;&gt;VincentWhite&lt;/a&gt;, but we need to verify the impact of this on heap for TTL and non-TTL workloads.&lt;/p&gt;

&lt;p&gt;Alternatives include using a unsigned int32 to represent &lt;tt&gt;localDeletionTime&lt;/tt&gt; and/or using a later start epoch (maybe 2000 or so) - but this would require some considerate work to maintain backward compatibility and would difficult interoperability with other systems - even though it&apos;s an internal structure.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=VincentWhite&quot; class=&quot;user-hover&quot; rel=&quot;VincentWhite&quot;&gt;VincentWhite&lt;/a&gt; would you be willing to work on this and maybe perform some stress tests to check impact on heap and GC of changing the &lt;tt&gt;localDeletionTime&lt;/tt&gt; representation from &lt;tt&gt;int&lt;/tt&gt; to &lt;tt&gt;long&lt;/tt&gt; ?&lt;/p&gt;</comment>
                            <comment id="16855350" author="laxmikant99" created="Tue, 4 Jun 2019 05:49:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt; Upgrade Sstable change to resume the original ttl should be in scope of this bug or should we open another jira ticket for this?&lt;br/&gt;
Note: This change is important for those users who are currently using CAP or CAP_NOWARN to avoid request rejection but want to resume to originally&#160; set TTL when they upgrade to new cassandra version with fix.&lt;/p&gt;</comment>
                            <comment id="16887860" author="laxmikant99" created="Thu, 18 Jul 2019 10:33:06 +0000"  >&lt;p&gt;Resuming the &lt;tt&gt;localDeletionTime&lt;/tt&gt;&#160; value as discussed &lt;a href=&quot;https://jira.apache.org/jira/browse/CASSANDRA-14092?focusedCommentId=16341749&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16341749&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; &#160;after an update operation on a row with TTL does not look feasible. Please see the below test case:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Step 1:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;insert into tab3(id,key,value) VALUES(&apos;id2&apos;, &apos;key1&apos;, 2) USING TTL 630720000; (20 years).&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sstabletojson: 
 {
 &lt;span class=&quot;code-quote&quot;&gt;&quot;partition&quot;&lt;/span&gt; : {
 &lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;id2&quot;&lt;/span&gt; ],
 &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 33
 },
 &lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt; : [
 {
 &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;row&quot;&lt;/span&gt;,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 75,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;clustering&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;key1&quot;&lt;/span&gt; ],
 &lt;span class=&quot;code-quote&quot;&gt;&quot;liveness_info&quot;&lt;/span&gt; : { &lt;span class=&quot;code-quote&quot;&gt;&quot;tstamp&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2019-07-18T07:03:22.198Z&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;ttl&quot;&lt;/span&gt; : 630720000, &lt;span class=&quot;code-quote&quot;&gt;&quot;expires_at&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2038-01-19T03:14:06Z&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;expired&quot;&lt;/span&gt; : &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; },
 &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt; : [
 { &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt; : 2 }
 ]
 }
 ]
 }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;Step 2:&lt;/b&gt; &lt;br/&gt;
 1. select ttl(value) from tab3 where id=&apos;id2&apos;;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;This results 584043668&lt;/b&gt;&#160;&lt;b&gt;and not 630720000 !&lt;/b&gt; and then updating the row with fetched ttl loses the original ttl value (20 years) so resuming &lt;tt&gt;localDeletionTime&lt;/tt&gt;&#160; based on ttl the value will not be feasible if someone chooses CAP or CAP_NOWARN option as in sstable, TTL value is no more 20 years (630720000).&lt;/p&gt;

&lt;p&gt;2. insert into tab3(id,key,value) VALUES(&apos;id2&apos;, &apos;key1&apos;, 3) USING TTL 584043668;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sstabletojson: 
 
 {
 &lt;span class=&quot;code-quote&quot;&gt;&quot;partition&quot;&lt;/span&gt; : {
 &lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;id2&quot;&lt;/span&gt; ],
 &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 33
 },
 &lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt; : [
 {
 &lt;span class=&quot;code-quote&quot;&gt;&quot;type&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;row&quot;&lt;/span&gt;,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 75,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;clustering&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;key1&quot;&lt;/span&gt; ],
 &lt;span class=&quot;code-quote&quot;&gt;&quot;liveness_info&quot;&lt;/span&gt; : { &lt;span class=&quot;code-quote&quot;&gt;&quot;tstamp&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2019-07-18T08:54:27.921Z&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;ttl&quot;&lt;/span&gt; : 584043668, &lt;span class=&quot;code-quote&quot;&gt;&quot;expires_at&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;2038-01-19T03:14:06Z&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;expired&quot;&lt;/span&gt; : &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; },
 &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt; : [
 { &lt;span class=&quot;code-quote&quot;&gt;&quot;name&quot;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;value&quot;&lt;/span&gt; : 3 }
 ]
 }
 ]
 }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16890992" author="pauloricardomg" created="Tue, 23 Jul 2019 13:23:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;This results 584043668 and not 630720000 ! and then updating the row with fetched ttl loses the original ttl value (20 years) so resuming localDeletionTime based on ttl the value will not be feasible if someone chooses CAP or CAP_NOWARN option as in sstable, TTL value is no more 20 years (630720000).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The fact that &lt;tt&gt;SELECT TTL&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/tt&gt; does not return the original TTL does not mean we cannot resume the original TTL once this is fixed. Data will need to be rewritten via &quot;upgradesstables&quot; to restore the original TTL once this limitation is fixed. If you are updating the row with fetched TTL you are overwriting the original value, so it&apos;s expected behavior that you&#160;lose the original TTL.&lt;/p&gt;

&lt;p&gt;If you are willing to take a stab at fixing this, I think the simplest approach is to change the &lt;tt&gt;localDeletionTime&lt;/tt&gt; field from integer to long.&lt;/p&gt;</comment>
                            <comment id="16892420" author="laxmikant99" created="Thu, 25 Jul 2019 05:23:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;&#160;I believe there are many use-cases where&#160;users maintain the TTL of a row while updating it. Hence in all such cases original TTL will be lost. So, is it worth giving TTL recalculation feature in upgradesstable which won&apos;t be applicable to all users ?&#160;&lt;/p&gt;

&lt;p&gt;I agree&#160;that a permanent fix, changing&#160;&lt;tt&gt;localDeletionTime&lt;/tt&gt;&#160;field from integer to long is simplest way to go but this change&#160;will be big in terms changes in number of classes and we need to carefully analyse the impact as well.&lt;/p&gt;</comment>
                            <comment id="17134300" author="mshuler" created="Fri, 12 Jun 2020 15:08:12 +0000"  >&lt;p&gt;Set this Jira to Severity = Critical and Complexity = Challenging to reflect the state of this problem, as time goes on, as well as the nature of the fix.&lt;/p&gt;</comment>
                            <comment id="17450322" author="sivann" created="Mon, 29 Nov 2021 10:18:52 +0000"  >&lt;p&gt;This is a critical issue, that severely limits TTL functionality; the CAP_NOWARN workaround of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14092&quot; title=&quot;Max ttl of 20 years will overflow localDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14092&quot;&gt;&lt;del&gt;CASSANDRA-14092&lt;/del&gt;&lt;/a&gt; is already limiting our data lifecycle.&#160; I&apos;m not sure why this is high-severity issue was not planned for 4.0, what&apos;s missing?&lt;/p&gt;</comment>
                            <comment id="17520768" author="mshuler" created="Mon, 11 Apr 2022 18:55:33 +0000"  >&lt;p&gt;Removed assignee. I only found a few random state changes by the user in Jira, so this assignment also looked random. If this was incorrect, please reassign!&lt;/p&gt;</comment>
                            <comment id="17610845" author="bereng" created="Thu, 29 Sep 2022 07:26:10 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;moving to this to review. Some comments:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Max TTL is now 68y and there is a new default NONE overflow policy, the other ones are kept for backwards compatibility.&lt;/li&gt;
	&lt;li&gt;All tests pass but for one upgrade rolling failing 10% of times. I am investigating it but given it is taking a lot of time and I can&apos;t repro locally I prefer to start with the review already.&lt;/li&gt;
	&lt;li&gt;The code has a few &apos;TODO 14227&apos; comments which are points I would like to discuss with the reviewer such as &lt;tt&gt;StreamingTombstoneHistogramBuilder#mergeNearestPoints()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Most files only change int to longs, think about sentinel values while reviewing and possible side-effects&lt;/li&gt;
	&lt;li&gt;The PR has a few self-contained commits for an easier review.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="17619357" author="bereng" created="Tue, 18 Oct 2022 08:51:02 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I have been asked to run some profiling to see the impact &apos;longs&apos; would have. I have tested on a single node doing inserts with a TTL + selects against that for 4m at around 100Kops/s after a warm up run. The results are virtual identical to both trunk and 14227 both at jfr and stress tool perf reporting&lt;/p&gt;

&lt;p&gt;Trunk:&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13051065/13051065_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;14227&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13051066/13051066_screenshot-2.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;If anything 14227&apos;s number are slightly better but probably just test env noise. GC pauses, total times, latencies, etc are all identical as well. The test CQL was:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CQL|INSERT INTO test.test (id, type, text) VALUES ($RANDOM_20000, $RANDOM_10, &apos;TTL Profiling&apos;) USING TTL $RANDOM_500000
CQL|SELECT id, type, text FROM test.test WHERE id=$RANDOM_20000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;where RANDOM_X means a random number up to X. Here we can see inserts, inserts colliding and selects. I will be happy to repeat the test if anybody has any suggestions. I am not posting the jfr for security reasons as the env vars section contains sensitive data (call me paranoid) but I can share them with known people on request. &lt;/p&gt;

&lt;p&gt;EDIT: I have been asked to confirm both runs are under &lt;tt&gt;memtable_allocation_type: heap_buffers&lt;/tt&gt; so it is on heap.&lt;/p&gt;</comment>
                            <comment id="17636510" author="bereng" created="Mon, 21 Nov 2022 07:54:38 +0000"  >&lt;p&gt;After some further perf testing we&apos;ve found out there is a 3% disk size increase hit we&apos;ve like to avoid as discussed in the &lt;a href=&quot;https://lists.apache.org/thread/fyf2d9jlrsor3hmz46qn282o5goooowd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ML&lt;/a&gt;. We&apos;re going to experiment and POC a bit a uint encoding to get rid of that and any extra flushes as well.&lt;/p&gt;</comment>
                            <comment id="17675917" author="bereng" created="Thu, 12 Jan 2023 10:04:13 +0000"  >&lt;p&gt;Update: The uint approach is giving good results in the POC on disk size, memtable, etc. I need to rebase, put capping back and revisit all perf.&lt;/p&gt;</comment>
                            <comment id="17680895" author="bereng" created="Thu, 26 Jan 2023 05:45:21 +0000"  >&lt;p&gt;Uint POC seems to be OK as well on the latency side. There are latencies on 2 completely different tests with even 2 diff test tooling:&lt;/p&gt;

&lt;p&gt;10 averaged runs latency&lt;br/&gt;
&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13054811/13054811_screenshot-3.png&quot; title=&quot;screenshot-3.png attached to CASSANDRA-14227&quot;&gt;screenshot-3.png&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13054811/13054811_screenshot-3.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Averaged latency on a 1h test&lt;br/&gt;
&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13054812/13054812_screenshot-4.png&quot; title=&quot;screenshot-4.png attached to CASSANDRA-14227&quot;&gt;screenshot-4.png&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13054812/13054812_screenshot-4.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17683716" author="bereng" created="Fri, 3 Feb 2023 07:45:25 +0000"  >&lt;p&gt;Putting this back for a first pass review with the new Uint approach. I have done a final round of perf testing:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Perf testing revolved around 10M rows and runs with random/fixed TTL for periods of 2m, 5m and 10m and averaging 10 runs. The exception being the much longer latency test.&lt;/li&gt;
	&lt;li&gt;Longer tests tend to give less noisy results. 14227 vs trunk may randomly appear one slightly better than the other which I attribute to env noise and lack of dedicated perf testing HW.&lt;/li&gt;
	&lt;li&gt;Latency seems to be aligned as per comment above&lt;/li&gt;
	&lt;li&gt;JFRs available on request&lt;/li&gt;
	&lt;li&gt;Disk size, flushes etc seem to be aligned. Here is some table stats where sometimes 14227 is slightly better and sometimes the other way around  &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13055091/13055091_unnamed-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The PR has several commits to make it easier to review. Some refactoring of an earlier commit might be found in a later one but nothing too big and quite straightforward. I have left a bunch of 14227 TODO comments to bring the attention of the reviewer just for feedback. CI can be found in the PR, yet repeat tests haven&apos;t been run yet due to the size. We can do it at a later time once we&apos;re happy with the approach&lt;/p&gt;

&lt;p&gt;The only thing to note is the addition of the NONE policy where it&apos;s later removed. That is the only bit it can&apos;t be easily collapsed, apologies in advance.&lt;/p&gt;</comment>
                            <comment id="17688462" author="benedict" created="Tue, 14 Feb 2023 11:23:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt; helpfully pointed out we should consider downgrade for this patch. It looks like we have an option to CAP to 2038, and if we default to this on upgrade I think a downgrade should be smooth. I&apos;m not certain we even need to change the sstable version? Though I haven&apos;t looked closely.&lt;/p&gt;</comment>
                            <comment id="17688862" author="bereng" created="Wed, 15 Feb 2023 06:51:51 +0000"  >&lt;p&gt;Seems like downgradability, at the time of writing, is still being discussed iiuc.&lt;/p&gt;

&lt;p&gt;Now we&apos;re also writing an int, with the uint approach, and the sstable version change is to signal a negative int being &apos;undefined data&apos; vs &apos;a valid uint&apos;. Regardless of the downgradability discussion &lt;em&gt;I think&lt;/em&gt; (not tested) an sstable scrub would suffice as scrub will either REJECT or CAP those entries. That is pending the downgradibility discussion detailed requirements: forward compatibility?, flag?, scrub?&lt;/p&gt;

&lt;p&gt;Sthg to take into account though, thx for bringing it up.&lt;/p&gt;</comment>
                            <comment id="17688923" author="benedict" created="Wed, 15 Feb 2023 08:28:39 +0000"  >&lt;p&gt;Downgradeability isn&apos;t under continuing discussion at present, no, but you are welcome to raise it for discussion.&lt;/p&gt;

&lt;p&gt;Either way, if it makes it simpler: this patch can easily avoid breaking downgrade, so my binding review feedback is that it &lt;b&gt;must&lt;/b&gt; not.&lt;/p&gt;</comment>
                            <comment id="17691217" author="blerer" created="Mon, 20 Feb 2023 15:00:47 +0000"  >&lt;blockquote&gt;&lt;p&gt; It looks like we have an option to CAP to 2038, and if we default to this on upgrade I think a downgrade should be smooth.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Could you elaborate a bit what you mean? I am not sure that I am understanding what you have in mind. &lt;/p&gt;</comment>
                            <comment id="17691224" author="benedict" created="Mon, 20 Feb 2023 15:20:01 +0000"  >&lt;p&gt;By default we should reject TTLs past 2038, and while this setting is in place we should continue to write &amp;#45;nc&amp;#45; format sstables. Once the operator configures longer TTLs, we can write &amp;#45;oa&amp;#45; format sstables.&lt;/p&gt;</comment>
                            <comment id="17691603" author="blerer" created="Tue, 21 Feb 2023 13:27:38 +0000"  >&lt;p&gt;I think, that I am misunderstanding what we call downgradability. What you propose is some kind of feature flag that delay the problem, no? If a problem occurs once we switch to the new sstable format then we cannot downgrade anymore.&lt;/p&gt;</comment>
                            <comment id="17691608" author="benedict" created="Tue, 21 Feb 2023 13:42:56 +0000"  >&lt;p&gt;This is the canonical example that was given in the original thread more than a year ago, i.e. that a cluster should not write files that are incompatible with the version we are upgrading from until the operator agrees the upgrade has been successful, yes. If there are performance or other regressions encountered during an upgrade, recovery should be as simple as restarting with the prior version (until the operator decides the new version is performing adequately). This minimises risks, without fully eliminating them. &lt;/p&gt;
</comment>
                            <comment id="17692872" author="benedict" created="Thu, 23 Feb 2023 19:28:45 +0000"  >&lt;p&gt;I decided to have a quick look at adding support for dynamically determining the output format based on whether the TTL data requires it, and I noticed that EncodingStats and EncodingStats.Collector likely treat TTL incorrectly, using simple min/max on int. This might not cause any bugs, but it might, and we should fix it - we should probably consider what additional testing we might need to catch this kind of error elsewhere.&lt;/p&gt;</comment>
                            <comment id="17703527" author="bereng" created="Wed, 22 Mar 2023 07:53:02 +0000"  >&lt;p&gt;Perf check report post review and big rebase  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13056567/13056567_C14227+Perf+check+2023.03.21.pdf&quot; title=&quot;C14227 Perf check 2023.03.21.pdf attached to CASSANDRA-14227&quot;&gt;C14227 Perf check 2023.03.21.pdf&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; LGTM&lt;/p&gt;</comment>
                            <comment id="17721186" author="bereng" created="Wed, 10 May 2023 05:00:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; a feature flag with upgrade tests etc has been added. I have provided links to the key bits of code &lt;a href=&quot;https://github.com/apache/cassandra/pull/1891#issuecomment-1541352411&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. If we could +1 I would start getting ready for the merge &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17723540" author="adelapena" created="Wed, 17 May 2023 16:56:06 +0000"  >&lt;p&gt;This looks good to me. I have left some final minor nits on the ticket.&lt;/p&gt;

&lt;p&gt;If &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; agrees with the approach for compatibility we can probably rebase and solve &lt;a href=&quot;https://github.com/apache/cassandra/pull/1891/files#r1188414272&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;those naming details&lt;/a&gt; on the new CircleCI jobs.&lt;/p&gt;</comment>
                            <comment id="17723785" author="bereng" created="Thu, 18 May 2023 05:14:34 +0000"  >&lt;p&gt;^The diff to the commit a few days ago is that the property has been moved to yaml as suggested by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17724760" author="bereng" created="Mon, 22 May 2023 05:00:53 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; we&apos;re a bit blocked here, if you could find a gap it should be a quick review for the FF having been moved to yaml and it would be highly appreciated. Thx.&lt;/p&gt;</comment>
                            <comment id="17724840" author="benedict" created="Mon, 22 May 2023 09:02:22 +0000"  >&lt;p&gt;Sorry, the downside of lots of Jira traffic (incl from GitHub comments) is that I don&apos;t check the email notifications for a high traffic ticket.&lt;/p&gt;

&lt;p&gt;I won&apos;t have time to look at the code soon, but I trust you to have addressed my concerns given what you describe above. Feel free to proceed.&lt;/p&gt;</comment>
                            <comment id="17724865" author="bereng" created="Mon, 22 May 2023 09:51:02 +0000"  >&lt;p&gt;Thx, it should be pretty non-controversial and we can always tweak the name etc.&lt;/p&gt;</comment>
                            <comment id="17726565" author="bereng" created="Fri, 26 May 2023 09:53:21 +0000"  >&lt;p&gt;Latest perf check after rebases etc LGTM &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13058571/13058571_C14227+Perf+check+2023.05.26.pdf&quot; title=&quot;C14227 Perf check 2023.05.26.pdf attached to CASSANDRA-14227&quot;&gt;C14227 Perf check 2023.05.26.pdf&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;The merge is coming...&lt;/p&gt;</comment>
                            <comment id="17727558" author="adelapena" created="Tue, 30 May 2023 14:37:39 +0000"  >&lt;p&gt;Looks good to me after rebase, and CI also looks good. +1 from me. The few remaining, trivial suggestions about comments can be addressed on commit.&lt;/p&gt;</comment>
                            <comment id="17727560" author="bereng" created="Tue, 30 May 2023 14:42:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Everything looks good as far as we can see. Do you think you could find a gap see if we can +1 and merge &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; You&apos;re probably most interested in the yaml feature flag commit &lt;a href=&quot;https://github.com/apache/cassandra/pull/1891/commits/159eabbc7a0dec932864447ecffbaae5ffe66c4c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17729180" author="bereng" created="Mon, 5 Jun 2023 05:27:18 +0000"  >&lt;p&gt;Merged. Thx everyone for all the help!&lt;/p&gt;</comment>
                            <comment id="17781651" author="michaelsembwever" created="Wed, 1 Nov 2023 08:51:19 +0000"  >&lt;p&gt;Shouldn&apos;t CASSANDRA_4 mode be using the `nb` format ? &lt;/p&gt;

&lt;p&gt;It&apos;s currently using `nc`, but looking through 4.0 and 4.1 latest versions they are on `nb`.&lt;br/&gt;
(See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18933&quot; title=&quot;Correct comment for nc SSTable format&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18933&quot;&gt;&lt;del&gt;CASSANDRA-18933&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="17783124" author="bereng" created="Mon, 6 Nov 2023 07:48:55 +0000"  >&lt;p&gt;That is weird because we always talked about &apos;nc&apos; and I remember testing 4.1 with nc. I will have to check...&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                                                <inwardlinks description="is a child of">
                                        <issuelink>
            <issuekey id="13122467">CASSANDRA-14092</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13539845">CASSANDRA-18593</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13567648">CASSANDRA-19373</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13132249">CASSANDRA-14178</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13557141">CASSANDRA-19010</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13527209">CASSANDRA-18301</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310760">
                    <name>Testing</name>
                                            <outwardlinks description="Testing discovered">
                                        <issuelink>
            <issuekey id="13538628">CASSANDRA-18564</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13056567" name="C14227 Perf check 2023.03.21.pdf" size="1060845" author="bereng" created="Wed, 22 Mar 2023 07:52:25 +0000"/>
                            <attachment id="13058571" name="C14227 Perf check 2023.05.26.pdf" size="1333023" author="bereng" created="Fri, 26 May 2023 09:51:07 +0000"/>
                            <attachment id="13051065" name="screenshot-1.png" size="135687" author="bereng" created="Tue, 18 Oct 2022 08:44:02 +0000"/>
                            <attachment id="13051066" name="screenshot-2.png" size="129094" author="bereng" created="Tue, 18 Oct 2022 08:44:33 +0000"/>
                            <attachment id="13054811" name="screenshot-3.png" size="25654" author="bereng" created="Thu, 26 Jan 2023 05:40:21 +0000"/>
                            <attachment id="13054812" name="screenshot-4.png" size="147109" author="bereng" created="Thu, 26 Jan 2023 05:43:31 +0000"/>
                            <attachment id="13055091" name="unnamed-1.png" size="103362" author="bereng" created="Fri, 3 Feb 2023 07:37:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 1 week, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3q1lj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12351720">5.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/1adbea5a068287f42f2421e558f4c404c69aea74&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/1adbea5a068287f42f2421e558f4c404c69aea74&lt;/a&gt; &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/58820de92eef140991a3e45f68f9152ae2fbc490&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/commit/58820de92eef140991a3e45f68f9152ae2fbc490&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;See PR&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>