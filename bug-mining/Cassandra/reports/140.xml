<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:11:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-405] Race condition with ConcurrentLinkedHashMap</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-405</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We are seeing a race condition with ConcurrentLinkedHashMap using appendToTail. We could remove the ConcurrentLinkedHashMap for now until that&apos;s resolved.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12434478">CASSANDRA-405</key>
            <summary>Race condition with ConcurrentLinkedHashMap</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="lenn0x">Chris Goffinet</reporter>
                        <labels>
                    </labels>
                <created>Tue, 1 Sep 2009 04:14:49 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:34 +0000</updated>
                            <resolved>Wed, 2 Sep 2009 15:04:26 +0000</resolved>
                                        <fixVersion>0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12749752" author="lenn0x" created="Tue, 1 Sep 2009 04:15:36 +0000"  >&lt;p&gt;Our stack trace from the running node in question. &lt;/p&gt;</comment>
                            <comment id="12749755" author="jbellis" created="Tue, 1 Sep 2009 04:53:14 +0000"  >&lt;p&gt;have you checked the other nodes for stuck threads like this?&lt;/p&gt;</comment>
                            <comment id="12749758" author="sammy.yu" created="Tue, 1 Sep 2009 04:57:11 +0000"  >&lt;p&gt;We did multiple stack dumps they are all the same.  There is no progression. &lt;/p&gt;

&lt;p&gt;In this stack trace there are two sets of stack traces&lt;br/&gt;
pool-1-thread-&lt;/p&gt;
{63,62,61,59,58,54,53,51,49,47}
&lt;p&gt; and ROW-READ-STAGE&lt;/p&gt;
{8,7,5,4,3,2,1}
&lt;p&gt;:&lt;br/&gt;
&quot;ROW-READ-STAGE:8&quot; prio=10 tid=0x00007f1b78b52000 nid=0x1945 runnable &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000046532000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
	at com.reardencommerce.kernel.collections.shared.evictable.ConcurrentLinkedHashMap$Node.appendToTail(ConcurrentLinkedHashMap.java:536)&lt;br/&gt;
	at com.reardencommerce.kernel.collections.shared.evictable.ConcurrentLinkedHashMap.putIfAbsent(ConcurrentLinkedHashMap.java:281)&lt;br/&gt;
	at com.reardencommerce.kernel.collections.shared.evictable.ConcurrentLinkedHashMap.put(ConcurrentLinkedHashMap.java:256)&lt;br/&gt;
	at org.apache.cassandra.io.SSTableReader.getPosition(SSTableReader.java:241)&lt;br/&gt;
	at org.apache.cassandra.db.filter.SSTableNamesIterator. (SSTableNamesIterator.java:46)&lt;br/&gt;
	at org.apache.cassandra.db.filter.NamesQueryFilter.getSSTableColumnIterator(NamesQueryFilter.java:69)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1445)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1379)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1398)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1379)&lt;br/&gt;
	at org.apache.cassandra.db.Table.getRow(Table.java:589)&lt;br/&gt;
	at org.apache.cassandra.db.SliceFromReadCommand.getRow(SliceFromReadCommand.java:65)&lt;br/&gt;
	at org.apache.cassandra.db.ReadVerbHandler.doVerb(ReadVerbHandler.java:78)&lt;br/&gt;
	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:44)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;

&lt;p&gt;ROW-READ-STAGE6 is a little different:&lt;br/&gt;
&quot;ROW-READ-STAGE:6&quot; prio=10 tid=0x00007f1b78b4e000 nid=0x1943 runnable &lt;span class=&quot;error&quot;&gt;&amp;#91;0x0000000046330000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: RUNNABLE&lt;br/&gt;
	at com.reardencommerce.kernel.collections.shared.evictable.ConcurrentLinkedHashMap$Node.appendToTail(ConcurrentLinkedHashMap.java:540)&lt;br/&gt;
	at com.reardencommerce.kernel.collections.shared.evictable.ConcurrentLinkedHashMap.putIfAbsent(ConcurrentLinkedHashMap.java:281)&lt;br/&gt;
	at com.reardencommerce.kernel.collections.shared.evictable.ConcurrentLinkedHashMap.put(ConcurrentLinkedHashMap.java:256)&lt;br/&gt;
	at org.apache.cassandra.io.SSTableReader.getPosition(SSTableReader.java:241)&lt;br/&gt;
	at org.apache.cassandra.db.filter.SSTableNamesIterator. (SSTableNamesIterator.java:46)&lt;br/&gt;
	at org.apache.cassandra.db.filter.NamesQueryFilter.getSSTableColumnIterator(NamesQueryFilter.java:69)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1445)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1379)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1398)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1379)&lt;br/&gt;
	at org.apache.cassandra.db.Table.getRow(Table.java:589)&lt;br/&gt;
	at org.apache.cassandra.db.SliceFromReadCommand.getRow(SliceFromReadCommand.java:65)&lt;br/&gt;
	at org.apache.cassandra.db.ReadVerbHandler.doVerb(ReadVerbHandler.java:78)&lt;br/&gt;
	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:44)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;

&lt;p&gt;All the other pool-1-threads are in the readLock waiting state due to the writeLock&lt;br/&gt;
&quot;pool-1-thread-12425&quot; prio=10 tid=0x00007f1b7857e000 nid=0x3fe6 waiting on condition &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f1892528000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (parking)&lt;br/&gt;
	at sun.misc.Unsafe.park(Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;parking to wait for  0x00007f1b8534e848&amp;gt; (a java.util.concurrent.locks.ReentrantReadWriteLock$FairSync)&lt;br/&gt;
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:747)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireShared(AbstractQueuedSynchronizer.java:877)&lt;br/&gt;
	at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireShared(AbstractQueuedSynchronizer.java:1197)&lt;br/&gt;
	at java.util.concurrent.locks.ReentrantReadWriteLock$ReadLock.lock(ReentrantReadWriteLock.java:594)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1412)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1379)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1398)&lt;br/&gt;
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1379)&lt;br/&gt;
	at org.apache.cassandra.db.Table.getRow(Table.java:589)&lt;br/&gt;
	at org.apache.cassandra.db.SliceFromReadCommand.getRow(SliceFromReadCommand.java:65)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy.weakReadLocal(StorageProxy.java:609)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy.readProtocol(StorageProxy.java:320)&lt;br/&gt;
	at org.apache.cassandra.service.CassandraServer.readColumnFamily(CassandraServer.java:92)&lt;br/&gt;
	at org.apache.cassandra.service.CassandraServer.getSlice(CassandraServer.java:173)&lt;br/&gt;
	at org.apache.cassandra.service.CassandraServer.get_slice(CassandraServer.java:213)&lt;br/&gt;
	at org.apache.cassandra.service.Cassandra$Processor$get_slice.process(Cassandra.java:551)&lt;br/&gt;
	at org.apache.cassandra.service.Cassandra$Processor.process(Cassandra.java:539)&lt;br/&gt;
	at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:252)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:619)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12749929" author="jbellis" created="Tue, 1 Sep 2009 14:44:59 +0000"  >&lt;p&gt;remove LRU key cache from 0.4; the ConcurrentLinkedHashMap library is buggy (see &lt;a href=&quot;http://code.google.com/p/concurrentlinkedhashmap/issues/detail?id=9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://code.google.com/p/concurrentlinkedhashmap/issues/detail?id=9&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;I will revisit some kind of key cache early in 0.5.&lt;/p&gt;</comment>
                            <comment id="12750242" author="lenn0x" created="Wed, 2 Sep 2009 02:45:27 +0000"  >&lt;p&gt;+1 This patch looks good. Let&apos;s remove from 0.4, and work on a better implementation on 0.5&lt;/p&gt;</comment>
                            <comment id="12750249" author="sammy.yu" created="Wed, 2 Sep 2009 03:08:57 +0000"  >&lt;p&gt;Yes we have this running fine in production now.  Mentioned to jbellis other Concurrent LRU cache implementation:&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc/lucene/solr/trunk/src/common/org/apache/solr/common/util/ConcurrentLRUCache.java?view=log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/lucene/solr/trunk/src/common/org/apache/solr/common/util/ConcurrentLRUCache.java?view=log&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://svn.apache.org/viewvc/lucene/solr/trunk/src/java/org/apache/solr/search/FastLRUCache.java?view=log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewvc/lucene/solr/trunk/src/java/org/apache/solr/search/FastLRUCache.java?view=log&lt;/a&gt;&lt;br/&gt;
that we could use in 0.5&lt;/p&gt;</comment>
                            <comment id="12750257" author="ben.manes" created="Wed, 2 Sep 2009 03:41:32 +0000"  >&lt;p&gt;When performing a postmortem on this issue, please review how the ConcurrentLinkedHashMap was added.  The project page stated:&lt;/p&gt;

&lt;p&gt;&amp;gt; Note: The algorithm needs further testing and is not deemed production ready. It is functional under concurrent tests, but needs additional load testing to assert correctness.&lt;/p&gt;

&lt;p&gt;That load testing, provided in the standard unit test runs, uncovered the issue and thus it was not promoted to a release status.  I haven&apos;t had time in the last few months to work on this project, but even the last check-in notes that its leaving debug code to help resolve it later.  The project states on the front page and FAQ that the goal is more educational than formal usage, hence I avoided known algorithms (which would be the correct approach if it was work-related).&lt;/p&gt;

&lt;p&gt;The ConcurrentLRUCache uses a watermark approach which is valid, but suffers from stampeding and is an offline algorithm.  Its still an excellent approach and one of many possibilities described in the FAQ.  I am personally a fan of soft-reference based caching for global data, which is evicted in LRU order, because it allows the GC to manage what it does best (memory!) and promotes not overburdening the application server.&lt;/p&gt;

&lt;p&gt;Please treat this as an issue where the blame is both 3p as I did not stress heavily enough not to use this in production and internal for not evaluating a 3p project enough to recognize that it warned about its production status.  I will update the project page to better communicate and provide a performant modification that is thread-safe for those that need a solution.  Please re-evaluate your own internal processes to determine why the bad call was made.&lt;/p&gt;

&lt;p&gt;I am not trying to shift blame, but my pet peeve is when firefighting production and no one learns because then it just happens again.  Its very frustrating, even more so if I actually work there! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Cheers!&lt;br/&gt;
Ben&lt;/p&gt;</comment>
                            <comment id="12750461" author="jbellis" created="Wed, 2 Sep 2009 14:57:49 +0000"  >&lt;p&gt;Actually, I did read your svn logs enough to note that the bug referenced on the front page found by the ehcache people was fixed.  Too bad I missed the other, but it&apos;s not the end of the world.&lt;/p&gt;

&lt;p&gt;In general, I suggest not getting all pissy with the people actually performing the &quot;additional load testing&quot; you claim is needed.  Early adopters are an important asset. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/tongue.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;(Note that this bug is against a beta version of Cassandra, so at the lowest level the process worked: the bug was uncovered before the final release.  Although if the front page of CLRU weren&apos;t so out of date, or there had actually been an issue in the tracker for a bug known for months, the pain could have been avoided.)&lt;/p&gt;</comment>
                            <comment id="12750466" author="jbellis" created="Wed, 2 Sep 2009 15:04:26 +0000"  >&lt;p&gt;committed 405.patch to 0.4 and trunk&lt;/p&gt;</comment>
                            <comment id="12750535" author="ben.manes" created="Wed, 2 Sep 2009 17:00:55 +0000"  >&lt;p&gt;No &quot;pissy&quot;-ness, and I agree with you.  I&apos;ve just been in too many firefighting sessions where the result is moving on and hitting the same problem 3 months later, and then 3 months later again.  People are usually so charged up fixing the issue that I find, perhaps incorrectly, that you have to be blunt to get their attention.  So no worries on my side. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;But yep, definately my fault for a good chunk of this.  Sorry for the inconvenience.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Ben&lt;/p&gt;</comment>
                            <comment id="12750999" author="hudson" created="Thu, 3 Sep 2009 12:52:59 +0000"  >&lt;p&gt;Integrated in Cassandra #186 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/186/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/186/&lt;/a&gt;)&lt;br/&gt;
    remove buggy concurrentlinkedhashmap library and lru cache.  too late in 0.4 to try to debug the library &amp;#8211; will revisit for 0.5.  patch by jbellis; reviewed by Chris Goffinet for &lt;/p&gt;</comment>
                            <comment id="12755670" author="jbellis" created="Tue, 15 Sep 2009 20:11:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-423&quot; title=&quot;add new LRU cache&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-423&quot;&gt;&lt;del&gt;CASSANDRA-423&lt;/del&gt;&lt;/a&gt; is the cache-for-0.5 ticket.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12418250" name="405.patch" size="25344" author="jbellis" created="Tue, 1 Sep 2009 14:44:59 +0000"/>
                            <attachment id="12418216" name="stack.log.gz" size="337562" author="lenn0x" created="Tue, 1 Sep 2009 04:15:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19673</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 11 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fyqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91225</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>