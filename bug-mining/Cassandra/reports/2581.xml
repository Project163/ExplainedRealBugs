<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5930] Offline scrubs can choke on broken files</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5930</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There are cases where offline scrub can hit an exception and die, like:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARNING: Non-fatal error reading row (stacktrace follows)
Exception in thread &quot;main&quot; java.io.IOError: java.io.IOError: java.io.EOFException
	at org.apache.cassandra.db.compaction.Scrubber.scrub(Scrubber.java:242)
	at org.apache.cassandra.tools.StandaloneScrubber.main(StandaloneScrubber.java:121)
Caused by: java.io.IOError: java.io.EOFException
	at org.apache.cassandra.db.compaction.PrecompactedRow.merge(PrecompactedRow.java:116)
	at org.apache.cassandra.db.compaction.PrecompactedRow.&amp;lt;init&amp;gt;(PrecompactedRow.java:99)
	at org.apache.cassandra.db.compaction.CompactionController.getCompactedRow(CompactionController.java:176)
	at org.apache.cassandra.db.compaction.CompactionController.getCompactedRow(CompactionController.java:182)
	at org.apache.cassandra.db.compaction.Scrubber.scrub(Scrubber.java:171)
	... 1 more
Caused by: java.io.EOFException
	at java.io.RandomAccessFile.readFully(RandomAccessFile.java:399)
	at java.io.RandomAccessFile.readFully(RandomAccessFile.java:377)
	at org.apache.cassandra.utils.BytesReadTracker.readFully(BytesReadTracker.java:95)
	at org.apache.cassandra.utils.ByteBufferUtil.read(ByteBufferUtil.java:401)
	at org.apache.cassandra.utils.ByteBufferUtil.readWithLength(ByteBufferUtil.java:363)
	at org.apache.cassandra.db.ColumnSerializer.deserialize(ColumnSerializer.java:120)
	at org.apache.cassandra.db.ColumnSerializer.deserialize(ColumnSerializer.java:37)
	at org.apache.cassandra.db.ColumnFamilySerializer.deserializeColumns(ColumnFamilySerializer.java:144)
	at org.apache.cassandra.io.sstable.SSTableIdentityIterator.getColumnFamilyWithColumns(SSTableIdentityIterator.java:234)
	at org.apache.cassandra.db.compaction.PrecompactedRow.merge(PrecompactedRow.java:112)
	... 5 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since the purpose of offline scrub is to fix broken stuff, it should be more resilient to broken stuff...&lt;/p&gt;</description>
                <environment></environment>
        <key id="12665333">CASSANDRA-5930</key>
            <summary>Offline scrubs can choke on broken files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="jeremiah">Jeremiah Jordan</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 Aug 2013 21:54:26 +0000</created>
                <updated>Tue, 14 Oct 2025 12:09:25 +0000</updated>
                            <resolved>Mon, 3 Feb 2014 20:33:07 +0000</resolved>
                                        <fixVersion>2.0.5</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13749055" author="jbellis" created="Fri, 23 Aug 2013 21:57:29 +0000"  >&lt;p&gt;Can you have a look, Jason?&lt;/p&gt;</comment>
                            <comment id="13756170" author="jeffpotter" created="Mon, 2 Sep 2013 16:49:04 +0000"  >&lt;p&gt;We&apos;re seeing this too &amp;#8211; slightly different stack trace, which I&apos;ll include here in case it&apos;s of use.&lt;/p&gt;


&lt;p&gt;WARNING: Non-fatal error reading row (stacktrace follows)&lt;br/&gt;
Exception in thread &quot;main&quot; java.io.IOError: java.lang.IllegalArgumentException&lt;br/&gt;
at org.apache.cassandra.db.compaction.Scrubber.scrub(Scrubber.java:244)&lt;br/&gt;
at org.apache.cassandra.tools.StandaloneScrubber.main(StandaloneScrubber.java:125)&lt;br/&gt;
Caused by: java.lang.IllegalArgumentException &lt;br/&gt;
at java.nio.Buffer.limit(Buffer.java:247)&lt;br/&gt;
at org.apache.cassandra.db.marshal.AbstractCompositeType.getBytes(AbstractCompositeType.java:51)&lt;br/&gt;
at org.apache.cassandra.db.marshal.AbstractCompositeType.getWithShortLength(AbstractCompositeType.java:60)&lt;br/&gt;
at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:78) &lt;br/&gt;
at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:31)&lt;br/&gt;
at org.apache.cassandra.db.ArrayBackedSortedColumns.addColumn(ArrayBackedSortedColumns.java:128)&lt;br/&gt;
at org.apache.cassandra.db.AbstractColumnContainer.addColumn(AbstractColumnContainer.java:114)&lt;br/&gt;
at org.apache.cassandra.db.AbstractColumnContainer.addColumn(AbstractColumnContainer.java:109) &lt;br/&gt;
at org.apache.cassandra.db.ColumnFamily.addAtom(ColumnFamily.java:219)&lt;br/&gt;
at org.apache.cassandra.db.ColumnFamilySerializer.deserializeColumnsFromSSTable(ColumnFamilySerializer.java:149)&lt;br/&gt;
at org.apache.cassandra.io.sstable.SSTableIdentityIterator.getColumnFamilyWithColumns(SSTableIdentityIterator.java:234)&lt;br/&gt;
at org.apache.cassandra.db.compaction.PrecompactedRow.merge(PrecompactedRow.java:114) &lt;br/&gt;
at org.apache.cassandra.db.compaction.PrecompactedRow.&amp;lt;init&amp;gt;(PrecompactedRow.java:98)&lt;br/&gt;
at org.apache.cassandra.db.compaction.CompactionController.getCompactedRow(CompactionController.java:160)&lt;br/&gt;
at org.apache.cassandra.db.compaction.CompactionController.getCompactedRow(CompactionController.java:166)&lt;br/&gt;
at org.apache.cassandra.db.compaction.Scrubber.scrub(Scrubber.java:173) &lt;br/&gt;
... 1 more&lt;/p&gt;</comment>
                            <comment id="13860591" author="thobbs" created="Thu, 2 Jan 2014 18:50:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeffpotter&quot; class=&quot;user-hover&quot; rel=&quot;jeffpotter&quot;&gt;jeffpotter&lt;/a&gt; what version of Cassandra were you running when you hit the above error?&lt;/p&gt;

&lt;p&gt;As far as the original stacktrace for this ticket goes, it&apos;s unfortunately necessary for counter CFs.  &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2759&quot; title=&quot;Scrub could lose increments and replicate that loss&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2759&quot;&gt;&lt;del&gt;CASSANDRA-2759&lt;/del&gt;&lt;/a&gt; explains the reasoning.  I suppose I could make the error message mention that and point to the ticket.&lt;/p&gt;

&lt;p&gt;The scrub code looks reasonably robust in general, so I think it&apos;s better to wait for individual bugs to get reported than to try to improve the code without any failure examples.&lt;/p&gt;</comment>
                            <comment id="13860912" author="jpotter" created="Thu, 2 Jan 2014 23:02:28 +0000"  >&lt;p&gt;Hi Tyler &amp;#8211; based on my notes, it should have been Cassandra 1.2.6.1 (DSE 3.1), at least, that&apos;s what other tickets we have filed at this same time suggest.&lt;/p&gt;</comment>
                            <comment id="13861968" author="thobbs" created="Fri, 3 Jan 2014 22:39:30 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jeffpotter&quot; class=&quot;user-hover&quot; rel=&quot;jeffpotter&quot;&gt;jeffpotter&lt;/a&gt;.  It looks like you also had a Counter table, in this case.&lt;/p&gt;

&lt;p&gt;5930-v1.patch (and &lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-5930-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;) clarifies the error message for counter tables.&lt;/p&gt;</comment>
                            <comment id="13862046" author="jbellis" created="Fri, 3 Jan 2014 23:52:18 +0000"  >&lt;p&gt;It would be nice to be able to tell people how to fix it (realistically: what their options are) rather than just &quot;sorry, scrub can&apos;t help you.&quot;  But I&apos;m not sure what those options are. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  /cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13862052" author="iamaleksey" created="Sat, 4 Jan 2014 00:00:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; There are no options. That said, we should probably allow users to override this behavior, if they prefer losing some of the counters history to not scrubbing at all.&lt;/p&gt;

&lt;p&gt;Also, with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6504&quot; title=&quot;counters++&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6504&quot;&gt;&lt;del&gt;CASSANDRA-6504&lt;/del&gt;&lt;/a&gt; in this becomes a non-issue (for the newly written &apos;global&apos; 2.1 shards, at least - we &lt;b&gt;can&lt;/b&gt; repair those after the scrub).&lt;/p&gt;</comment>
                            <comment id="13864718" author="thobbs" created="Tue, 7 Jan 2014 21:40:21 +0000"  >&lt;p&gt;You&apos;re right, it would be nice to give the user an option to skip the corrupted rows anyway.&lt;/p&gt;

&lt;p&gt;5930-v2.patch (the &lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-5930-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; is still good) adds a &lt;tt&gt;--skip-corrupted&lt;/tt&gt; option and a unit test to exercise it.&lt;/p&gt;</comment>
                            <comment id="13889886" author="iamaleksey" created="Mon, 3 Feb 2014 20:33:07 +0000"  >&lt;p&gt;LGTM, committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12621396" name="5930-v1.patch" size="2465" author="thobbs" created="Fri, 3 Jan 2014 22:39:30 +0000"/>
                            <attachment id="12621862" name="5930-v2.patch" size="22923" author="thobbs" created="Tue, 7 Jan 2014 21:40:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>345273</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1njhj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>345574</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12323354">1.1.7</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>