<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:58:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10608] Adding a dynamic column to a compact storage table with the same name as the partition key causes a memtable flush deadlock</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10608</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The reproduction steps for this are as follows: &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Create the following schema:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE KEYSPACE ks WITH replication = { &apos;class&apos;: &apos;SimpleStrategy&apos;, &apos;replication_factor&apos;: &apos;1&apos;};
CREATE TABLE ks.cf (k int, v int, PRIMARY KEY(k)) WITH COMPACT STORAGE;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
	&lt;li&gt;Using the thrift client execute the following:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        Column column = new Column(ByteBufferUtil.bytes(&quot;k&quot;));
        column.setValue(ByteBufferUtil.bytes(1));
        column.setTimestamp(1);
        client.insert(key, new ColumnParent(compactCf), column, ConsistencyLevel.ONE);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;This causes an invalid &lt;tt&gt;PartitionUpdate&lt;/tt&gt; to be added to &lt;tt&gt;Memtable&lt;/tt&gt; containing a &lt;tt&gt;PartitionColumns&lt;/tt&gt; containing the partition key &lt;tt&gt;ColumnDefinition&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This happens because &lt;tt&gt;LegacyLayout.decodeCellName&lt;/tt&gt; does not check whether the &lt;tt&gt;ColumnDefinition&lt;/tt&gt; is a partition key &lt;/p&gt;</description>
                <environment></environment>
        <key id="12908520">CASSANDRA-10608</key>
            <summary>Adding a dynamic column to a compact storage table with the same name as the partition key causes a memtable flush deadlock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mike_tr_adamson">Mike Adamson</assignee>
                                    <reporter username="mike_tr_adamson">Mike Adamson</reporter>
                        <labels>
                    </labels>
                <created>Wed, 28 Oct 2015 11:21:04 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:51 +0000</updated>
                            <resolved>Wed, 4 Nov 2015 10:42:51 +0000</resolved>
                                        <fixVersion>3.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14978523" author="mike_tr_adamson" created="Wed, 28 Oct 2015 14:42:03 +0000"  >&lt;p&gt;I&apos;ve added a check in &lt;tt&gt;decodeCellName&lt;/tt&gt; for a partition key and consider it to be a dynamic column if it is.&lt;/p&gt;

&lt;p&gt;Also add a unit test for this condition.&lt;/p&gt;</comment>
                            <comment id="14978995" author="tjake" created="Wed, 28 Oct 2015 18:47:17 +0000"  >&lt;p&gt;The change itself looks fine.  Do you have a dtest/utest run on cassci you can link?&lt;/p&gt;</comment>
                            <comment id="14980053" author="slebresne" created="Thu, 29 Oct 2015 08:36:31 +0000"  >&lt;p&gt;I would strongly suspect that clustering columns are also affected so I think the patch should use &lt;tt&gt;def.isPrimaryKeyColumn()&lt;/tt&gt; rather than &lt;tt&gt;def.isPartitionKey()&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14980486" author="beobal" created="Thu, 29 Oct 2015 14:14:18 +0000"  >&lt;p&gt;while &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mike_tr_adamson&quot; class=&quot;user-hover&quot; rel=&quot;mike_tr_adamson&quot;&gt;mike_tr_adamson&lt;/a&gt; gets set on with cassci I&apos;ve pushed his branches to my fork to get a CI run going:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/10608-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/10608-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-10608-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-10608-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-10608-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-10608-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="14980489" author="mike_tr_adamson" created="Thu, 29 Oct 2015 14:17:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; I have incorporated your suggestions in &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;&apos;s branch.&lt;/p&gt;</comment>
                            <comment id="14982338" author="slebresne" created="Fri, 30 Oct 2015 10:43:27 +0000"  >&lt;p&gt;Some tests are failing with a NPE because the 2nd branch doesn&apos;t account for &lt;tt&gt;def&lt;/tt&gt; being &lt;tt&gt;null&lt;/tt&gt; (nit: I&apos;d change that 2nd branch to test for &lt;tt&gt;def == null&lt;/tt&gt;).&lt;/p&gt;</comment>
                            <comment id="14982765" author="mike_tr_adamson" created="Fri, 30 Oct 2015 16:06:16 +0000"  >&lt;p&gt;Good point, missed that. I&apos;ve changed the branch logic in the inner branch to your suggestion. Here is my branch with the fixes:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/mike-tr-adamson/cassandra/tree/10608-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/mike-tr-adamson/cassandra/tree/10608-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/madamson/job/mike-tr-adamson-10608-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/madamson/job/mike-tr-adamson-10608-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/madamson/job/mike-tr-adamson-10608-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/madamson/job/mike-tr-adamson-10608-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="14985040" author="slebresne" created="Mon, 2 Nov 2015 10:50:00 +0000"  >&lt;p&gt;The patch lgtm, but the test results aren&apos;t all that good: the unit tests have a few failures in &lt;tt&gt;ReadCommandTest&lt;/tt&gt; that aren&apos;t in the cassandra-3.0 branch, and the dtests have basically all failed. I doubt any of this is related to this patch, but it would be nice to have slightly cleaner runs. Can you make sure your 3.0 branch is up to date and re-submit the tests?&lt;/p&gt;</comment>
                            <comment id="14985343" author="mike_tr_adamson" created="Mon, 2 Nov 2015 14:58:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Apologies, I thought I&apos;d rebased before the last run but obviously not. I&apos;ve kicked off the test builds again and am seeing 6 failures on the 3.0 branch. 4 of these are failing on the current 3.0 test build and the other 2 are successful here but seem to be failing on cassci. &lt;/p&gt;</comment>
                            <comment id="14985404" author="slebresne" created="Mon, 2 Nov 2015 15:41:44 +0000"  >&lt;p&gt;That last unit tests looks good. The &lt;tt&gt;CQLMetricsTest.testPreparedStatementsExecuted&lt;/tt&gt; is definitively not related to this (I&apos;ve seen that test flapping on other branches). Let&apos;s wait on the new dtest run to finish just to be sure and I&apos;ll commit (but please do ping me once the dtests finish since I won&apos;t get an email &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/p&gt;</comment>
                            <comment id="14989298" author="slebresne" created="Wed, 4 Nov 2015 10:42:40 +0000"  >&lt;p&gt;Alright, last dtest run looks good (we have too much flapping dtests right now so comparison to the 3.0 branch are a bit difficult, but I did ran this once more &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-10608-dtest/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and it does look good). Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12849600">CASSANDRA-9910</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12769290" name="10608.txt" size="4208" author="mike_tr_adamson" created="Wed, 28 Oct 2015 14:40:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mike_tr_adamson]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 2 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2nmif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>