<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:44:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6920] LatencyMetrics can return infinity</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6920</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There is a race condition when updating the recentLatency metrics exposed from LatencyMetrics.&lt;/p&gt;

&lt;p&gt;Attaching a patch with a test that exposes the issue and a potential fix.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12703321">CASSANDRA-6920</key>
            <summary>LatencyMetrics can return infinity</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="nickmbailey">Nick Bailey</reporter>
                        <labels>
                    </labels>
                <created>Mon, 24 Mar 2014 21:16:21 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:50 +0000</updated>
                            <resolved>Thu, 3 Apr 2014 23:35:33 +0000</resolved>
                                        <fixVersion>1.2.17</fixVersion>
                    <fixVersion>2.0.7</fixVersion>
                    <fixVersion>2.1 beta2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13947970" author="jbellis" created="Wed, 26 Mar 2014 14:58:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=lyubent&quot; class=&quot;user-hover&quot; rel=&quot;lyubent&quot;&gt;lyubent&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="13958204" author="lyubent" created="Wed, 2 Apr 2014 21:34:41 +0000"  >&lt;p&gt;LGTM.&lt;/p&gt;

&lt;p&gt;Attaching the 1.2 patch with some minor nit fixes (moving braces to a new line) and a 2.0 patch (should apply cleanly to 2.1 as well)&lt;/p&gt;</comment>
                            <comment id="13958233" author="brandon.williams" created="Wed, 2 Apr 2014 22:00:59 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="13958258" author="nickmbailey" created="Wed, 2 Apr 2014 22:24:01 +0000"  >&lt;p&gt;FWIW, I said &quot;potential&quot; fix because I didn&apos;t really know if there were performance concerns adding that synchronized block on a method we call for every read/write that comes in to the system.&lt;/p&gt;

&lt;p&gt;Just wanted to mention that here in case there are concerns.&lt;/p&gt;</comment>
                            <comment id="13958272" author="brandon.williams" created="Wed, 2 Apr 2014 22:38:54 +0000"  >&lt;p&gt;Do you actually need to synchronize on that part? totalLatency at least is just an AtomicLong in the end.&lt;/p&gt;</comment>
                            <comment id="13958313" author="brandon.williams" created="Wed, 2 Apr 2014 23:10:39 +0000"  >&lt;p&gt;mm, I guess it&apos;s because they both need to move in lock-step.  I&apos;m not sure there&apos;s any other solution there.&lt;/p&gt;</comment>
                            <comment id="13958901" author="lyubent" created="Thu, 3 Apr 2014 15:51:26 +0000"  >&lt;p&gt;Just to verify, the stress tool shows no signs of performance degradation (legacy completes within 48 sec on my machine regardless of the &lt;tt&gt;synchronise&lt;/tt&gt; block)&lt;/p&gt;</comment>
                            <comment id="13959334" author="benedict" created="Thu, 3 Apr 2014 22:17:32 +0000"  >&lt;p&gt;Do we really need the synchronized block? Just because it has no measurable performance impact in this test, or now, doesn&apos;t mean it won&apos;t in future, and taking that penalty on every operation just to guard an infrequent read operation seems really unpleasant to me. Also, it affects profiling output (has a tendency to erroneously indicate it as a CPU sink). &lt;/p&gt;

&lt;p&gt;At the very least we should be using a ReadWriteLock to make sure we don&apos;t put threads to sleep for no good reason, but frankly I&apos;d say simply checking that ops != lastOpCount would suffice on read. If they&apos;re the same return 0 and don&apos;t update the numbers, otherwise do what we were always doing before. Or have the reader spin until it sees two consistent values. Any of the above would be preferable to putting new places for threads to fall asleep on the read/write path (I am on a slow burning mission to eliminate thread signalling costs)&lt;/p&gt;</comment>
                            <comment id="13959346" author="nickmbailey" created="Thu, 3 Apr 2014 22:32:32 +0000"  >&lt;p&gt;Well, the metric is deprecated. The same metric (essentiall) is exposed as the 1/5/15 minute latency rates that metrics already exposes. Personally I don&apos;t think there is much difference between returning 0 if we hit the race and returning infinity since both are wrong. Infinity might even be better since it&apos;s more obviously wrong and easy to catch and work around.&lt;/p&gt;

&lt;p&gt;Maybe we just document the issue and let it go away when we drop the old metrics in favor of coda hale metrics.&lt;/p&gt;</comment>
                            <comment id="13959352" author="benedict" created="Thu, 3 Apr 2014 22:37:25 +0000"  >&lt;p&gt;Zero is not incorrect on race - zero is in fact completely correct, since the only scenario in which you can get infinite is when one of the two values has changed and the other hasn&apos;t, i.e. you peeked inbetween the only update for the interval. So if you&apos;d peeked a moment before you&apos;d have seen zero. So you just pretend you peeked a moment before.&lt;/p&gt;</comment>
                            <comment id="13959366" author="nickmbailey" created="Thu, 3 Apr 2014 22:44:04 +0000"  >&lt;p&gt;Thats true enough, it presents potential problems if there are multiple readers of the metric (the possibility of one reader always hitting the race and getting 0), but that&apos;s one of the problems with using this metric anyway.&lt;/p&gt;

&lt;p&gt;Like I said, since this metric is deprecated I&apos;m not particularly concerned now that I know where the infinity values are coming from and I can work around them.&lt;/p&gt;</comment>
                            <comment id="13959385" author="benedict" created="Thu, 3 Apr 2014 22:58:33 +0000"  >&lt;p&gt;Well, I&apos;m quite comfortable leaving the read operation synchronized - although it will still be nonsense if there&apos;s more than one caller, it will be marginally less nonsense. So long as we&apos;re only paying a penalty on read of the metric and not on every database operation.&lt;/p&gt;
</comment>
                            <comment id="13959395" author="brandon.williams" created="Thu, 3 Apr 2014 23:03:43 +0000"  >&lt;p&gt;This is a deprecated metric, and shows no problem now, so let&apos;s just leave this as it is.  When we remove the metric, any potential issues will solve themselves.&lt;/p&gt;</comment>
                            <comment id="13959400" author="benedict" created="Thu, 3 Apr 2014 23:06:26 +0000"  >&lt;p&gt;The fact that it is deprecated bears no relation to how much it costs to maintain it, and the impact of the synchronized block. Let&apos;s revert the patch, if we do anything, not leave this synchronized block in.&lt;/p&gt;</comment>
                            <comment id="13959403" author="benedict" created="Thu, 3 Apr 2014 23:07:47 +0000"  >&lt;p&gt;As a separate matter, I completely disagree with the metric being deprecated.&lt;/p&gt;</comment>
                            <comment id="13959415" author="benedict" created="Thu, 3 Apr 2014 23:19:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/6920&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/belliottsmith/cassandra/tree/6920&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Reverts the change and applies the fix discussed above. Reads are still racy, but this is fine - if we decide to keep these metrics we can always revisit and make them non-racy without impacting the updaters.&lt;/p&gt;</comment>
                            <comment id="13959428" author="brandon.williams" created="Thu, 3 Apr 2014 23:35:33 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12638343" name="6920-cassandra-1.2.patch" size="3124" author="lyubent" created="Wed, 2 Apr 2014 21:34:41 +0000"/>
                            <attachment id="12638344" name="6920-cassandra-2.0.patch" size="3217" author="lyubent" created="Wed, 2 Apr 2014 21:34:41 +0000"/>
                            <attachment id="12636431" name="6920-infinity-metrics.patch" size="3058" author="nickmbailey" created="Mon, 24 Mar 2014 21:17:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>381659</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 33 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tr7r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>381934</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>