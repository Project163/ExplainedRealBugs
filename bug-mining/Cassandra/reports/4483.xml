<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:05:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12457] dtest failure in upgrade_tests.cql_tests.TestCQLNodes2RF1_Upgrade_current_2_1_x_To_indev_2_2_x.bug_5732_test</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12457</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;example failure:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/cassandra-2.2_dtest_upgrade/16/testReport/upgrade_tests.cql_tests/TestCQLNodes2RF1_Upgrade_current_2_1_x_To_indev_2_2_x/bug_5732_test&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/cassandra-2.2_dtest_upgrade/16/testReport/upgrade_tests.cql_tests/TestCQLNodes2RF1_Upgrade_current_2_1_x_To_indev_2_2_x/bug_5732_test&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Stacktrace

  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/lib/python2.7/unittest/&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;.py&quot;&lt;/span&gt;, line 358, in run
    self.tearDown()
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/home/automaton/cassandra-dtest/upgrade_tests/upgrade_base.py&quot;&lt;/span&gt;, line 216, in tearDown
    &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(UpgradeTester, self).tearDown()
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/home/automaton/cassandra-dtest/dtest.py&quot;&lt;/span&gt;, line 666, in tearDown
    raise AssertionError(&lt;span class=&quot;code-quote&quot;&gt;&apos;Unexpected error in log, see stdout&apos;&lt;/span&gt;)
&lt;span class=&quot;code-quote&quot;&gt;&quot;Unexpected error in log, see stdout\n-------------------- &amp;gt;&amp;gt; begin captured logging &amp;lt;&amp;lt; --------------------\ndtest: DEBUG: Upgrade test beginning, setting CASSANDRA_VERSION to 2.1.15, and jdk to 8. (Prior values will be restored after test).\ndtest: DEBUG: cluster ccm directory: /mnt/tmp/dtest-D8UF3i\ndtest: DEBUG: Done setting configuration options:\n{   &lt;span class=&quot;code-quote&quot;&gt;&apos;initial_token&apos;&lt;/span&gt;: None,\n    &lt;span class=&quot;code-quote&quot;&gt;&apos;num_tokens&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;32&apos;&lt;/span&gt;,\n    &lt;span class=&quot;code-quote&quot;&gt;&apos;phi_convict_threshold&apos;&lt;/span&gt;: 5,\n    &lt;span class=&quot;code-quote&quot;&gt;&apos;range_request_timeout_in_ms&apos;&lt;/span&gt;: 10000,\n    &lt;span class=&quot;code-quote&quot;&gt;&apos;read_request_timeout_in_ms&apos;&lt;/span&gt;: 10000,\n    &lt;span class=&quot;code-quote&quot;&gt;&apos;request_timeout_in_ms&apos;&lt;/span&gt;: 10000,\n    &lt;span class=&quot;code-quote&quot;&gt;&apos;truncate_request_timeout_in_ms&apos;&lt;/span&gt;: 10000,\n    &lt;span class=&quot;code-quote&quot;&gt;&apos;write_request_timeout_in_ms&apos;&lt;/span&gt;: 10000}\ndtest: DEBUG: [[Row(table_name=u&lt;span class=&quot;code-quote&quot;&gt;&apos;ks&apos;&lt;/span&gt;, index_name=u&lt;span class=&quot;code-quote&quot;&gt;&apos;test.testindex&apos;&lt;/span&gt;)], [Row(table_name=u&lt;span class=&quot;code-quote&quot;&gt;&apos;ks&apos;&lt;/span&gt;, index_name=u&lt;span class=&quot;code-quote&quot;&gt;&apos;test.testindex&apos;&lt;/span&gt;)]]\ndtest: DEBUG: upgrading node1 to git:91f7387e1f785b18321777311a5c3416af0663c2\nccm: INFO: Fetching Cassandra updates...\ndtest: DEBUG: Querying upgraded node\ndtest: DEBUG: Querying old node\ndtest: DEBUG: removing ccm cluster test at: /mnt/tmp/dtest-D8UF3i\ndtest: DEBUG: clearing ssl stores from [/mnt/tmp/dtest-D8UF3i] directory\n--------------------- &amp;gt;&amp;gt; end captured logging &amp;lt;&amp;lt; ---------------------&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Standard Output

http:&lt;span class=&quot;code-comment&quot;&gt;//git-wip-us.apache.org/repos/asf/cassandra.git git:91f7387e1f785b18321777311a5c3416af0663c2
&lt;/span&gt;Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,581 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@73deb57f) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.sstable.SSTableReader$DescriptorTypeTidy@2098812276:/mnt/tmp/dtest-D8UF3i/test/node1/data1/system/schema_columns-296e9c049bec3085827dc17d3df2122a/system-schema_columns-ka-4 was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,581 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@7926de0f) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.utils.concurrent.WrappedSharedCloseable$1@1009016655:[[OffHeapBitSet]] was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,581 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@3a5760f9) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.util.MmappedSegmentedFile$Cleanup@223486002:/mnt/tmp/dtest-D8UF3i/test/node1/data0/system/schema_columns-296e9c049bec3085827dc17d3df2122a/system-schema_columns-ka-3-Index.db was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,582 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@42cb4131) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.utils.concurrent.WrappedSharedCloseable$1@1544265728:[Memory@[0..4), Memory@[0..a)] was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,582 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@5dda43d0) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.util.MmappedSegmentedFile$Cleanup@1100327913:/mnt/tmp/dtest-D8UF3i/test/node1/data1/system/schema_columns-296e9c049bec3085827dc17d3df2122a/system-schema_columns-ka-4-Index.db was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,582 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@59cfa823) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.utils.concurrent.WrappedSharedCloseable$1@1480923322:[Memory@[0..4), Memory@[0..a)] was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,601 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@570e14a1) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.util.CompressedPoolingSegmentedFile$Cleanup@992487242:/mnt/tmp/dtest-D8UF3i/test/node1/data1/system/schema_columns-296e9c049bec3085827dc17d3df2122a/system-schema_columns-ka-4-Data.db was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,602 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@1f021ebc) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.utils.concurrent.WrappedSharedCloseable$1@1878148398:[Memory@[0..4), Memory@[0..e)] was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,604 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@48feef6d) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.sstable.SSTableReader$DescriptorTypeTidy@848724815:/mnt/tmp/dtest-D8UF3i/test/node1/data0/system/schema_columns-296e9c049bec3085827dc17d3df2122a/system-schema_columns-ka-3 was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,605 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@3dee8c5f) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.sstable.SSTableReader$DescriptorTypeTidy@1078490617:/mnt/tmp/dtest-D8UF3i/test/node1/data1/system/schema_columns-296e9c049bec3085827dc17d3df2122a/system-schema_columns-ka-2 was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,614 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@7f726f1a) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.util.CompressedPoolingSegmentedFile$Cleanup@2037913408:/mnt/tmp/dtest-D8UF3i/test/node1/data0/system/schema_columns-296e9c049bec3085827dc17d3df2122a/system-schema_columns-ka-3-Data.db was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,615 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@303df044) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.util.CompressedPoolingSegmentedFile$Cleanup@861514759:/mnt/tmp/dtest-D8UF3i/test/node1/data1/system/schema_columns-296e9c049bec3085827dc17d3df2122a/system-schema_columns-ka-2-Data.db was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,616 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@5fbf0fc9) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.utils.concurrent.WrappedSharedCloseable$1@1715786089:[[OffHeapBitSet]] was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,616 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@3924b235) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.util.MmappedSegmentedFile$Cleanup@1197672578:/mnt/tmp/dtest-D8UF3i/test/node1/data1/system/schema_columns-296e9c049bec3085827dc17d3df2122a/system-schema_columns-ka-2-Index.db was not released before the reference was garbage collected
Unexpected error in node1 log, error: 
ERROR [Reference-Reaper:1] 2016-08-13 01:34:34,616 Ref.java:199 - LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@600596e0) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.utils.concurrent.WrappedSharedCloseable$1@545967120:[[OffHeapBitSet]] was not released before the reference was garbage collected
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12997278">CASSANDRA-12457</key>
            <summary>dtest failure in upgrade_tests.cql_tests.TestCQLNodes2RF1_Upgrade_current_2_1_x_To_indev_2_2_x.bug_5732_test</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="craig.kodman">Craig Kodman</reporter>
                        <labels>
                            <label>dtest</label>
                    </labels>
                <created>Mon, 15 Aug 2016 12:50:26 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:22 +0000</updated>
                            <resolved>Fri, 7 Oct 2016 09:04:35 +0000</resolved>
                                        <fixVersion>2.2.9</fixVersion>
                    <fixVersion>3.0.10</fixVersion>
                    <fixVersion>3.10</fixVersion>
                                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15421098" author="sean.mccarthy" created="Mon, 15 Aug 2016 14:57:47 +0000"  >&lt;p&gt;Also failing here: &lt;a href=&quot;http://cassci.datastax.com/job/trunk_dtest_upgrade/27/testReport/upgrade_tests.cql_tests/TestCQLNodes2RF1_Upgrade_current_2_1_x_To_indev_3_x/bug_5732_test/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/trunk_dtest_upgrade/27/testReport/upgrade_tests.cql_tests/TestCQLNodes2RF1_Upgrade_current_2_1_x_To_indev_3_x/bug_5732_test/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15422336" author="stefania" created="Tue, 16 Aug 2016 07:19:02 +0000"  >&lt;p&gt;I&apos;ve reproduced a failure &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/14/testReport/junit/node_0_iter_033.upgrade_tests.cql_tests/TestCQLNodes2RF1_Upgrade_current_2_1_x_To_indev_3_x/bug_5732_test/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; with &lt;tt&gt;-Dcassandra.debugrefcount=true&lt;/tt&gt; so that we have the call stack for the allocation:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [Reference-Reaper:1] 2016-08-16 03:56:11,412 Ref.java:228 - Allocate trace org.apache.cassandra.utils.concurrent.Ref$State@3b4fed59:
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:3,1,main]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.getStackTrace(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1552)
	at org.apache.cassandra.utils.concurrent.Ref$Debug.&amp;lt;init&amp;gt;(Ref.java:218)
	at org.apache.cassandra.utils.concurrent.Ref$State.&amp;lt;init&amp;gt;(Ref.java:151)
	at org.apache.cassandra.utils.concurrent.Ref.&amp;lt;init&amp;gt;(Ref.java:84)
	at org.apache.cassandra.utils.concurrent.Ref.tryRef(Ref.java:116)
	at org.apache.cassandra.utils.concurrent.Ref.ref(Ref.java:121)
	at org.apache.cassandra.utils.concurrent.SharedCloseableImpl.&amp;lt;init&amp;gt;(SharedCloseableImpl.java:35)
	at org.apache.cassandra.utils.concurrent.WrappedSharedCloseable.&amp;lt;init&amp;gt;(WrappedSharedCloseable.java:56)
	at org.apache.cassandra.utils.BloomFilter.&amp;lt;init&amp;gt;(BloomFilter.java:49)
	at org.apache.cassandra.utils.Murmur3BloomFilter.&amp;lt;init&amp;gt;(Murmur3BloomFilter.java:36)
	at org.apache.cassandra.utils.Murmur3BloomFilter.sharedCopy(Murmur3BloomFilter.java:46)
	at org.apache.cassandra.io.sstable.SSTableReader.cloneAndReplace(SSTableReader.java:1070)
	at org.apache.cassandra.io.sstable.SSTableReader.cloneAndReplace(SSTableReader.java:1048)
	at org.apache.cassandra.io.sstable.SSTableReader.cloneAsShadowed(SSTableReader.java:1106)
	at org.apache.cassandra.io.sstable.SSTableRewriter.moveStarts(SSTableRewriter.java:322)
	at org.apache.cassandra.io.sstable.SSTableRewriter.switchWriter(SSTableRewriter.java:405)
	at org.apache.cassandra.io.sstable.SSTableRewriter.finishAndMaybeThrow(SSTableRewriter.java:458)
	at org.apache.cassandra.io.sstable.SSTableRewriter.finish(SSTableRewriter.java:440)
	at org.apache.cassandra.io.sstable.SSTableRewriter.finish(SSTableRewriter.java:420)
	at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:214)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:73)
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59)
	at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionCandidate.run(CompactionManager.java:264)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15422449" author="stefania" created="Tue, 16 Aug 2016 09:00:01 +0000"  >&lt;p&gt;I&apos;ve verified that all 3 failures are in 2.1.15. We leak the sstable created in &lt;tt&gt;SSTableRewriter.moveStarts()&lt;/tt&gt; after a drain, possibly because compactions are interrupted. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11767&quot; title=&quot;dtest failure in upgrade_tests.upgrade_through_versions_test.ProtoV3Upgrade_AllVersions_EndsAt_Trunk_HEAD.rolling_upgrade_test&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11767&quot;&gt;&lt;del&gt;CASSANDRA-11767&lt;/del&gt;&lt;/a&gt; had a similar failure in 2.2, so I&apos;m trying to reproduce it in 2.2 since for 2.1 I don&apos;t think we should fix this, unless it turns out to be trivial, we should lower the LEAK DETECTED message from ERROR to WARN in 2.1 and fix only in 2.2+.&lt;/p&gt;</comment>
                            <comment id="15425831" author="stefania" created="Thu, 18 Aug 2016 02:52:17 +0000"  >&lt;p&gt;I&apos;ve started a multiplex run &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/18/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; that upgrades from 2.2 instead of 2.1 so that we can find out if 2.2 also has the same problem.&lt;/p&gt;</comment>
                            <comment id="15426078" author="stefania" created="Thu, 18 Aug 2016 08:19:22 +0000"  >&lt;p&gt;Reproduced in 2.2 &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/18/testReport/junit/node_0_iter_024.upgrade_tests.cql_tests/TestCQLNodes2RF1_Upgrade_current_2_2_x_To_indev_3_x/bug_5732_test/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; with a slightly different allocation call stack.&lt;/p&gt;

&lt;p&gt;In 2.1 the leak should be caused by shadow sstables not being released:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12457-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/19/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;multiplexed&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15426158" author="stefania" created="Thu, 18 Aug 2016 09:33:10 +0000"  >&lt;p&gt;In 2.2 the problem is completely different (shadow sstables no longer exist). What&apos;s happening in 2.2 is that we fail to flush memtables during a drain, and therefore the resources allocated in &lt;tt&gt;BigTableWriter.openFinal()&lt;/tt&gt; are leaked. Further, the shutdown hook in storage service doesn&apos;t report these errors because it just waits on the flushing futures, it doesn&apos;t check if they succeeded or not.&lt;/p&gt;</comment>
                            <comment id="15438702" author="stefania" created="Fri, 26 Aug 2016 09:14:07 +0000"  >&lt;p&gt;In 2.2 the leaks can be reproduced only on Jenkins at a rate of approximately one every 50 tests. I have a multiplexed run &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/38/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; which succeeded, all I did was to avoid stopping compactions. This would indicate a problem with interrupting compactions, but I haven&apos;t seen any interrupted compactions messages in the failed tests logs, so it may be a coincidence that I need to verify by repeating another run.&lt;/p&gt;

&lt;p&gt;Further, three additional multiplexed runs in 2.2 revealed that the allocation stacks of leaked sstables are not just when the sstables are created during a flush operation but also when they are opened. I&apos;ve attached the logs. So I don&apos;t think the issue is an exception thrown when flushing. Likewise, in 2.1 the problem may be unrelated to shadowed sstables. Besides, in all 3 runs starting from 2.2 as well as the run starting from 2.1, the sstable reference itself is not leaked, only the references of the fields released by &lt;tt&gt;SSTableReader.InstanceTidier&lt;/tt&gt; are leaked. This would indicate that the leaks are simply caused by stopping the non-periodic tasks too soon when draining. However, in only two runs I saw the warning logged when we fail to wait for the non periodic tasks to shutdown. I also haven&apos;t seen any execution rejected exception, which I would expect in this case, but I just noticed that the code of the non periodic executor may suppress error messages when SS is in the shutdown hook. So I&apos;ve rectified this and launched another multiplexed run &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/39/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, which is still pending. This run also checks if the executable submitted to the non periodic tasks in &lt;tt&gt;SSTableReader.InstanceTidier&lt;/tt&gt; is canceled.&lt;/p&gt;

&lt;p&gt;So in summary, this is very difficult to reproduce, so far I&apos;ve gathered contradicting evidence, and the allocation stacks are not helpful because leaked sstables are created in different places.&lt;/p&gt;</comment>
                            <comment id="15445222" author="stefania" created="Mon, 29 Aug 2016 08:22:16 +0000"  >&lt;p&gt;Launched one more &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/41/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;run&lt;/a&gt; without interrupting compactions during drain and the problem could not be reproduced. So the leaks must be related to the fact that the compaction executor is shutdown, I can also see how compaction background tasks are rejected when the leaks occur. At least in the logs of the 4th run with failures, &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12825970/12825970_12457_2.2_logs_with_allocation_stacks_4.tar.gz&quot; title=&quot;12457_2.2_logs_with_allocation_stacks_4.tar.gz attached to CASSANDRA-12457&quot;&gt;12457_2.2_logs_with_allocation_stacks_4.tar.gz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;, it seems that the sstables whose properties were leaked were part of a successful compaction that happened just after flushing a memtable. It seems that one of the compaction originals and the new sstables were released whilst the other 3 originals were leaked. If I add debug messages to &lt;tt&gt;LifecycleTransaction&lt;/tt&gt;, then the problem cannot be reproduced any longer, see &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/43/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/45&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. I&apos;m trying one more time &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;It also seems that it&apos;s always the schema tables that are leaked, although this could be just because they are amongst the last system tables to be flushed.&lt;/p&gt;</comment>
                            <comment id="15448330" author="stefania" created="Tue, 30 Aug 2016 07:31:52 +0000"  >&lt;p&gt;I&apos;ve reproduced one &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/53/testReport/junit/node_1_iter_026.upgrade_tests.cql_tests/TestCQLNodes2RF1_Upgrade_custom_2_To_custom_3/bug_5732_test/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failure&lt;/a&gt; out of 4 multiplexed runs with a combined 360 repetitions of this test. &lt;/p&gt;

&lt;p&gt;I am still not sure why the compacted sstables are leaked. The fact that it is now failing so infrequently means that my assumption above that this may be caused by stopping the compaction executor may not be true and hence it could be due, again, to the fact that we stop the non periodic tasks executor. Note that in this failure we see that we failed to wait for this executor to complete all tasks but the leaks occur also in tests where this is not true.&lt;/p&gt;

&lt;p&gt;I&apos;ve fixed a problem in &lt;tt&gt;SSTableReader.InstanceTidier&lt;/tt&gt;, in that the &lt;tt&gt;setup&lt;/tt&gt; boolean should have been volatile. This would cause leaks but only if the sstable was released immediately after loading, which I don&apos;t think is what is happening here.&lt;/p&gt;

&lt;p&gt;The additional debug logs from yesterday I think pretty much exclude bugs in the lifecycle transaction or sstable rewriter in that there is no cloning or early opening. I&apos;ve enhanced &lt;tt&gt;Ref.java&lt;/tt&gt; to also print out any stack trace for reference copies, just to be sure. &lt;/p&gt;

&lt;p&gt;I still believe the leaks must be due to the non periodic tasks being stopped but I just cannot understand why we don&apos;t see any errors related to the async tidiers not running. I&apos;ve added some more logs to the instance tidier as well, if &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/54/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this run&lt;/a&gt; fails it might give us more answers.&lt;/p&gt;</comment>
                            <comment id="15451024" author="stefania" created="Wed, 31 Aug 2016 04:02:08 +0000"  >&lt;p&gt;No failures on the &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/54/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;run&lt;/a&gt; mentioned above and none in this follow up &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/55/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;run&lt;/a&gt; either (except for 5 unrelated failures due to github problems). This is a total of 295 successful test iterations. I&apos;ve launched another 150 iterations &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/56/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15451369" author="stefania" created="Wed, 31 Aug 2016 06:51:00 +0000"  >&lt;p&gt;Latest multiplex &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/56&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;job&lt;/a&gt; also completed with no failures.&lt;/p&gt;

&lt;p&gt;I moved the logs in &lt;tt&gt;LifecycleTransaction&lt;/tt&gt; and &lt;tt&gt;SstableReader&lt;/tt&gt; back to trace level, but I&apos;ve left the &lt;tt&gt;volatile&lt;/tt&gt; keyword fix and other essential logs. I&apos;ve launched another &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/59/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;run&lt;/a&gt; that should indicate if it is indeed the missing &lt;tt&gt;volatile&lt;/tt&gt; keyword that fixed it, rather than the verbose logs masking another race. The final test would be to run it again without the &lt;tt&gt;volatile&lt;/tt&gt; keyword and to reproduce it only in that scenario.&lt;/p&gt;

&lt;p&gt;The patch for 2.2 is &lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12457-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15451702" author="stefania" created="Wed, 31 Aug 2016 09:20:17 +0000"  >&lt;p&gt;Run &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/59/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;above&lt;/a&gt; completed again without failures. I&apos;ve launched another run &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/60/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, this time with the &lt;tt&gt;volatile&lt;/tt&gt; flag temporarily removed, in the hope to reproduce failures now, which would confirm the &lt;tt&gt;volatile&lt;/tt&gt; keyword is enough to explain the leaks.&lt;/p&gt;</comment>
                            <comment id="15454087" author="stefania" created="Thu, 1 Sep 2016 02:33:14 +0000"  >&lt;p&gt;Run &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/60/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;above&lt;/a&gt; completed again without failures. So right now I have no idea why we cannot reproduce this any longer. Launching another run &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; using the unpatched 2.2 branch.&lt;/p&gt;</comment>
                            <comment id="15454370" author="stefania" created="Thu, 1 Sep 2016 05:30:00 +0000"  >&lt;p&gt;The run based on the unpatched 2.2 had one &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/61/testReport/junit/node_2_iter_011.upgrade_tests.cql_tests/TestCQLNodes2RF1_Upgrade_current_2_2_x_To_indev_3_0_x/bug_5732_test/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failure&lt;/a&gt;, so there must be something in my patch that prevents the failure, unless this has become extremely difficult to reproduce and it failed on 2.2 just by chance. &lt;/p&gt;

&lt;p&gt;I&apos;m launching another build &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/62/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; with even fewer changes in my patch, specifically I removed the added logs in Ref.java. However, I&apos;ve added back the logs in the sstable instance tidier, hoping for some more clues.&lt;/p&gt;</comment>
                            <comment id="15454585" author="stefania" created="Thu, 1 Sep 2016 07:17:02 +0000"  >&lt;p&gt;Previous &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/62&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;run&lt;/a&gt; produced 2 failures, which is great because it means we can reproduce it again with the patch; the additional logging that was added to Ref.java probably made it too slow to reproduce it. I&apos;m still analyzing the new failures. I&apos;ve also launched another &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/63/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;run&lt;/a&gt; with the volatile keyword re-introduced.&lt;/p&gt;</comment>
                            <comment id="15454784" author="stefania" created="Thu, 1 Sep 2016 08:44:16 +0000"  >&lt;p&gt;The analysis of the latest failure logs revealed two different scenarios:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;In one case the instance tidier for the sstable with leaks did run, so the reference is not leaked, but the runnable in the non periodic tasks that is launched asynchronously in the instance tidier did not run at all, explaining the leaked resources.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;In the other case, not only did the the non periodic task runnable not run, but also another runnable task did not complete.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Both could be explained by the shutdown call of the non periodic tasks and the fact that the execute-delayed-tasks policy is currently set to false, so I will schedule another run with this policy set to true. Still, it is really odd that there is no interrupted exception or trace of a canceled future (I did have runs with these logs enabled and never saw anything).&lt;/p&gt;

&lt;p&gt;For one of the two cases, we cannot rule out a deadlock whilst executing the runnable that did non complete. I noticed that the sstable global tidier calls &lt;tt&gt;SystemKeyspace.clearSSTableReadMeter()&lt;/tt&gt;, which &lt;b&gt;applies a mutation to &lt;tt&gt;sstable_activity&lt;/tt&gt; after all the system tables have been flushed and the commitlog has been stopped&lt;/b&gt;. So regardless of whether there is a deadlock or not, I think we should stop the compactions before we flush the system sstables and stop the commit log, so that any obsoleted sstable can update &lt;tt&gt;sstable_activity&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15454854" author="stefania" created="Thu, 1 Sep 2016 09:15:38 +0000"  >&lt;p&gt;As expected the &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/63/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt; with the &lt;tt&gt;volatile&lt;/tt&gt; keyword reintroduced still produced two failures and I&apos;ve launched a new &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/64/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt; to test the execute-delayed-task policy.&lt;/p&gt;

&lt;p&gt;One of the failures was unrelated but, nonetheless, it should be fixed in this patch. The way we submit tasks in &lt;tt&gt;CompactionManager&lt;/tt&gt; is not safe and could result in the following exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [CompactionExecutor:1] 2016-09-01 07:45:24,506 CassandraDaemon.java:195 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:1,1,main]
java.util.concurrent.RejectedExecutionException: ThreadPoolExecutor has shut down
        at org.apache.cassandra.concurrent.DebuggableThreadPoolExecutor$1.rejectedExecution(DebuggableThreadPoolExecutor.java:61) ~[main/:na]
        at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:823) ~[na:1.8.0_51]
        at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1364) ~[na:1.8.0_51]
        at org.apache.cassandra.concurrent.DebuggableThreadPoolExecutor.execute(DebuggableThreadPoolExecutor.java:165) ~[main/:na]
        at java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:112) ~[na:1.8.0_51]
        at org.apache.cassandra.db.compaction.CompactionManager.submitBackground(CompactionManager.java:176) ~[main/:na]
        at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionCandidate.run(CompactionManager.java:263) ~[main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_51]
        at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_51]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_51]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_51]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_51]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Even if we check that the executor has not been shutdown before calling submit, there could still be a race where the executor is shutdown after checking but before calling submit, we need to handle the exception instead, and release any compaction tasks if there is an exception. &lt;/p&gt;</comment>
                            <comment id="15457760" author="stefania" created="Fri, 2 Sep 2016 07:13:19 +0000"  >&lt;p&gt;The multiplex &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;run&lt;/a&gt; for testing the default execute-delayed-task policy completed without failures, confirming that there is a problem with non periodic tasks being skipped when this policy is set to false and shutdown is called.&lt;/p&gt;

&lt;p&gt;I&apos;ve also changed the order in SS drain and stopped the compactions and the batchlog manager before flushing system tables, for the reasons discussed above. Further, I&apos;ve enhanced compaction manager to handle rejected executions.&lt;/p&gt;

&lt;p&gt;Here is the patch for 2.2 with ordinary CI:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12457-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The multiplex run for the latest patch is &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/65/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15482752" author="stefania" created="Mon, 12 Sep 2016 01:38:51 +0000"  >&lt;p&gt;Multiplex run was fine, ticket is ready for review.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12457-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12457-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12457&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;For 2.1 we can try a scaled down version of the patch where we just remove &lt;tt&gt;nonPeriodicTasks.setExecuteExistingDelayedTasksAfterShutdownPolicy&lt;/tt&gt; or we can change the upgrade tests to ignore leaks in the 2.1 logs, I would rather not apply the full patch to 2.1.&lt;/p&gt;</comment>
                            <comment id="15554096" author="stefania" created="Fri, 7 Oct 2016 04:37:56 +0000"  >&lt;p&gt;Rebased on latest branches, the 3.0 patch applies cleanly upwards:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.X&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12457-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12457-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12457-3.X&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12457&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-3.X-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-3.X-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12457-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15554350" author="krummas" created="Fri, 7 Oct 2016 07:12:16 +0000"  >&lt;p&gt;+1 (3.x tests never ran but 3.x is similar enough to trunk still imo)&lt;/p&gt;</comment>
                            <comment id="15554591" author="stefania" created="Fri, 7 Oct 2016 09:04:10 +0000"  >&lt;p&gt;Thank you for the review! &lt;/p&gt;

&lt;p&gt;Committed to 2.2 as be6e6ea662b7da556a9e4ba5fd402b7451bdde10 and merged into 3.0, 3.X and trunk.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dseng&quot; class=&quot;user-hover&quot; rel=&quot;dseng&quot;&gt;dseng&lt;/a&gt;: the upgrade tests that upgrade from 2.1 will still show LEAK errors in 2.1 logs since this patch was not delivered in 2.1; I&apos;m not sure if there is a way to ignore LEAK errors in logs, but only for 2.1 nodes.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12969234">CASSANDRA-11767</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13016602">CASSANDRA-12866</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12825638" name="12457_2.1_logs_with_allocation_stacks.tar.gz" size="65092" author="stefania" created="Fri, 26 Aug 2016 09:05:13 +0000"/>
                            <attachment id="12825635" name="12457_2.2_logs_with_allocation_stacks_1.tar.gz" size="133982" author="stefania" created="Fri, 26 Aug 2016 09:04:45 +0000"/>
                            <attachment id="12825636" name="12457_2.2_logs_with_allocation_stacks_2.tar.gz" size="131757" author="stefania" created="Fri, 26 Aug 2016 09:04:45 +0000"/>
                            <attachment id="12825637" name="12457_2.2_logs_with_allocation_stacks_3.tar.gz" size="132346" author="stefania" created="Fri, 26 Aug 2016 09:04:45 +0000"/>
                            <attachment id="12825970" name="12457_2.2_logs_with_allocation_stacks_4.tar.gz" size="267010" author="stefania" created="Mon, 29 Aug 2016 08:16:05 +0000"/>
                            <attachment id="12823683" name="node1.log" size="156923" author="craig.kodman" created="Mon, 15 Aug 2016 12:50:26 +0000"/>
                            <attachment id="12823681" name="node1_debug.log" size="177365" author="craig.kodman" created="Mon, 15 Aug 2016 12:50:26 +0000"/>
                            <attachment id="12823682" name="node1_gc.log" size="31120" author="craig.kodman" created="Mon, 15 Aug 2016 12:50:26 +0000"/>
                            <attachment id="12823684" name="node2.log" size="90087" author="craig.kodman" created="Mon, 15 Aug 2016 12:50:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 6 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32bef:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>