<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:19:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2279] Tombstones not collected post-repair</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2279</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The keys would only show up in sstables2json and look like this:&lt;/p&gt;

&lt;p&gt;(root@aps4):/opt/cassandra/storage/queue/data/Panama Wed Feb 23 07:24:34am &lt;br/&gt;
===&amp;gt; /opt/cassandra/bin/sstable2json Queue-2527-Data.db -k waq:publicMessageIndexingWorkArea:PUM8a65ce95-9d35-4941-928c-dd5965e8b29b &lt;br/&gt;
2011-02-23 07:24:43,710 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.cassandra.config.DatabaseDescriptor&amp;#93;&lt;/span&gt; - DiskAccessMode &apos;auto&apos; determined to be mmap, indexAccessMode is mmap &lt;br/&gt;
2011-02-23 07:24:43,972 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;org.apache.cassandra.io.SSTableReader&amp;#93;&lt;/span&gt; - Opening /opt/cassandra/storage/queue/data/Panama/Queue-2527-Data.db &lt;br/&gt;
{ &lt;br/&gt;
&quot;waq:publicMessageIndexingWorkArea:PUM8a65ce95-9d35-4941-928c-dd5965e8b29b&quot;: [] &lt;br/&gt;
} &lt;br/&gt;
(root@aps4):/opt/cassandra/storage/queue/data/Panama Wed Feb 23 07:24:44am &lt;br/&gt;
===&amp;gt;&lt;/p&gt;

&lt;p&gt;The steps that I took to reproduce it were:&lt;br/&gt;
Create a keyspace, column family, and a key&lt;br/&gt;
Delete the key on Node 1 using the cli (del cf&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;key&amp;#39;&amp;#93;&lt;/span&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Flush &lt;br/&gt;
Repair on a cluster with more than 1 node&lt;br/&gt;
Wait GCSeconds &lt;br/&gt;
Compact&lt;br/&gt;
And the empty row would appear on Node 2&lt;/p&gt;

&lt;p&gt;However, when I was able to get rid of the empty rows, I was following these steps on a single machine: &lt;br/&gt;
Create a keyspace, column family, and a key&lt;br/&gt;
Delete the key&lt;br/&gt;
Flush&lt;br/&gt;
Sample write (writing to some temporary key)&lt;br/&gt;
Deleting the attribute to that temporary key (not the entire key)&lt;br/&gt;
Flush&lt;br/&gt;
Compact&lt;/p&gt;

&lt;p&gt;or these steps:&lt;br/&gt;
Create a keyspace, column family, and a key&lt;br/&gt;
Delete the key&lt;br/&gt;
Flush &lt;br/&gt;
Wait GCseconds&lt;br/&gt;
Compact&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12500654">CASSANDRA-2279</key>
            <summary>Tombstones not collected post-repair</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="j.casares">Joaquin Casares</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Mar 2011 17:42:22 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:05 +0000</updated>
                            <resolved>Fri, 8 Apr 2011 22:23:58 +0000</resolved>
                                        <fixVersion>0.7.5</fixVersion>
                                    <component>Legacy/Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13004613" author="slebresne" created="Wed, 9 Mar 2011 15:35:30 +0000"  >&lt;p&gt;I&apos;m not able to reproduce. And I don&apos;t see why repair would screw up with tombstones collection. Only compaction should remove them and repair shouldn&apos;t have anything to do with this. If sstable2json is the only one to show it, it&apos;s even weirder (that is, listing with the cli should also show an empty row if there was problem with tombstone collection).&lt;/p&gt;

&lt;p&gt;Are you sure you compacted node 2 (on which the empty row showed up) ? Are you sure there wasn&apos;t a Queue-2527-Compacted file alongside Queue-2527-Data.db ? Are you sure node 2 local time wasn&apos;t highly out of sync with node 1 ?&lt;/p&gt;</comment>
                            <comment id="13005582" author="slebresne" created="Fri, 11 Mar 2011 10:30:56 +0000"  >&lt;p&gt;Ok, strongest hypothesis: this is a sign of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2305&quot; title=&quot;Tombstoned rows not purged from cache after gcgraceseconds&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2305&quot;&gt;&lt;del&gt;CASSANDRA-2305&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
Joaquim: was some row cache enabled on the incriminated CF ?&lt;/p&gt;</comment>
                            <comment id="13005735" author="j.casares" created="Fri, 11 Mar 2011 17:35:26 +0000"  >&lt;p&gt;The entire thing was reproduced on a fresh install and I was just using the standard Keyspace that already exists, I believe. I&apos;ll go through and follow my steps again and give a more detailed account.&lt;/p&gt;</comment>
                            <comment id="13006407" author="slebresne" created="Mon, 14 Mar 2011 13:44:55 +0000"  >&lt;p&gt;It&apos;s a bit of a shot in the dark since I&apos;m not sure exactly how was produced and how to reproduce this, but I found a place in RowIteratorFactor where we don&apos;t handle a CF localDeletionTime correctly. Since RowIterator is used for repair and for sstable2json, it sounds like a promising candidate for this (and it&apos;s a legit problem even if not the one at hand here).&lt;/p&gt;

&lt;p&gt;Patch is against 0.7.&lt;/p&gt;</comment>
                            <comment id="13006429" author="jbellis" created="Mon, 14 Mar 2011 14:28:12 +0000"  >&lt;p&gt;how hard would it be to create a unit test that catches this?&lt;/p&gt;</comment>
                            <comment id="13006433" author="slebresne" created="Mon, 14 Mar 2011 14:38:08 +0000"  >&lt;p&gt;Should be doable. I&apos;ll do that.&lt;/p&gt;</comment>
                            <comment id="13006510" author="slebresne" created="Mon, 14 Mar 2011 16:50:31 +0000"  >&lt;p&gt;Attaching the unit test.&lt;/p&gt;</comment>
                            <comment id="13006519" author="jbellis" created="Mon, 14 Mar 2011 17:09:18 +0000"  >&lt;p&gt;what&apos;s the significance of gc_grace_seconds: 2 in the test CF?  I don&apos;t see any sleeps in the test.&lt;/p&gt;</comment>
                            <comment id="13006525" author="slebresne" created="Mon, 14 Mar 2011 17:19:58 +0000"  >&lt;p&gt;Sorry, that was me trying stuff and forgetting to remove it. I update the test to use an existing column with standard gc_grace&lt;/p&gt;</comment>
                            <comment id="13006547" author="slebresne" created="Mon, 14 Mar 2011 18:18:38 +0000"  >&lt;p&gt;There was actually 2 related bugs in RowIteratorFactory. Re-attaching new patch with the 2 unit tests and the fix (fixing both problem and simplifying, I think, RowIteratorFactory).&lt;/p&gt;</comment>
                            <comment id="13006587" author="jbellis" created="Mon, 14 Mar 2011 19:32:30 +0000"  >&lt;p&gt;that&apos;s a big improvement over the existing factory code!  committed.&lt;/p&gt;

&lt;p&gt;we&apos;ll need a separate patch for 0.6 &amp;#8211; RowIteratorFactory doesn&apos;t exist (the analogous code is inline in getRangeSlice).&lt;/p&gt;</comment>
                            <comment id="13006597" author="hudson" created="Mon, 14 Mar 2011 19:48:59 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #378 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/378/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/378/&lt;/a&gt;)&lt;br/&gt;
    fix tombstone handling in repair andsstable2json&lt;br/&gt;
patch by slebresne; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2279&quot; title=&quot;Tombstones not collected post-repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2279&quot;&gt;&lt;del&gt;CASSANDRA-2279&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13006679" author="j.casares" created="Mon, 14 Mar 2011 22:27:26 +0000"  >&lt;p&gt;Here are all the commands that were run. I was messing around with T2 references and the bug didn&apos;t show up the first time, so I tried it again.&lt;/p&gt;

&lt;p&gt;The second time it worked following the exact steps that I listed. I set the GCSeconds to be 30 minutes to wait for the repair to finish 100%.&lt;/p&gt;

&lt;p&gt;This time however, the SSTables actually have the old values as well.&lt;/p&gt;</comment>
                            <comment id="13008450" author="slebresne" created="Fri, 18 Mar 2011 14:30:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;we&apos;ll need a separate patch for 0.6&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think 0.6 suffers from the problem fixed by the attached patch. It uses CFStore.getFamily() for range slices to do its bidding which handles correctly the column family deletion times as far as I can tell.&lt;/p&gt;

&lt;p&gt;Which make me think that there could be something else at hand here. I&apos;ll have a look at Joaquin instructions to try to reproduce what he is seeing. &lt;/p&gt;</comment>
                            <comment id="13013702" author="j.casares" created="Wed, 30 Mar 2011 22:11:28 +0000"  >&lt;p&gt;I just read this and was wondering if this may be the case:&lt;br/&gt;
&lt;a href=&quot;http://wiki.apache.org/cassandra/Operations#Dealing_with_the_consequences_of_nodetool_repair_not_running_within_GCGraceSeconds&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/cassandra/Operations#Dealing_with_the_consequences_of_nodetool_repair_not_running_within_GCGraceSeconds&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;GCGraceSeconds was set to 30 minutes to allow the repair to finish and I waited 35 before running the compaction on the above steps.&lt;/p&gt;</comment>
                            <comment id="13017689" author="jbellis" created="Fri, 8 Apr 2011 22:06:42 +0000"  >&lt;p&gt;compaction should be runnable any time, as long as you do repair before gcgrace expires.&lt;/p&gt;</comment>
                            <comment id="13017694" author="slebresne" created="Fri, 8 Apr 2011 22:15:13 +0000"  >&lt;p&gt;For the record, we did try to reproduce with Joaquin and weren&apos;t able to find anything wrong in there. In particular, in one instance when we though we had a column coming back from the dead, we were actually looking at a compacted sstable (which sstable2json won&apos;t avoid).&lt;/p&gt;

&lt;p&gt;So I do not know if there is an actual problem here.&lt;/p&gt;</comment>
                            <comment id="13017704" author="jbellis" created="Fri, 8 Apr 2011 22:23:58 +0000"  >&lt;p&gt;Sounds good, thanks for looking into that.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12473595" name="RowIteration-unit-tests.patch" size="2851" author="slebresne" created="Mon, 14 Mar 2011 18:18:38 +0000"/>
                            <attachment id="12473596" name="fix-RowIteratorFactory.patch" size="6568" author="slebresne" created="Mon, 14 Mar 2011 18:18:38 +0000"/>
                            <attachment id="12473620" name="nodeA.txt" size="35443" author="j.casares" created="Mon, 14 Mar 2011 22:27:26 +0000"/>
                            <attachment id="12473621" name="nodeB.txt" size="8897" author="j.casares" created="Mon, 14 Mar 2011 22:27:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20537</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 33 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gafj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93120</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>