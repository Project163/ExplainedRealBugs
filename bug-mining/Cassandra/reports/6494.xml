<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:30:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19697] Test failure: materialized_views_test.py::TestMaterializedViews::test_rename_column_atomicity</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19697</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Breaking this out from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19683&quot; title=&quot;Investigate dtest timeouts after CASSANDRA-19534&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19683&quot;&gt;&lt;del&gt;CASSANDRA-19683&lt;/del&gt;&lt;/a&gt;.  The byteman script fails to execute in 5.0/trunk after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19534&quot; title=&quot;Unbounded queues in native transport requests lead to node instability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19534&quot;&gt;&lt;del&gt;CASSANDRA-19534&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13582268">CASSANDRA-19697</key>
            <summary>Test failure: materialized_views_test.py::TestMaterializedViews::test_rename_column_atomicity</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Jun 2024 13:46:45 +0000</created>
                <updated>Wed, 19 Jun 2024 11:06:48 +0000</updated>
                            <resolved>Wed, 19 Jun 2024 11:06:48 +0000</resolved>
                                        <fixVersion>5.0-rc1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Feature/Materialized Views</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="17854436" author="brandon.williams" created="Wed, 12 Jun 2024 13:45:38 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Checking rule inject node failure on merge schema exit against class org.apache.cassandra.schema.Schema&lt;br/&gt;
Parsed rule &quot;inject node failure on merge schema exit&quot; for class org.apache.cassandra.schema.Schema&lt;br/&gt;
Type checked rule &quot;inject node failure on merge schema exit&quot;&lt;/p&gt;

&lt;p&gt;TestScript: no errors&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="17854464" author="brandon.williams" created="Wed, 12 Jun 2024 15:16:34 +0000"  >&lt;p&gt;The mysterious commonality that connects this back to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19534&quot; title=&quot;Unbounded queues in native transport requests lead to node instability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19534&quot;&gt;&lt;del&gt;CASSANDRA-19534&lt;/del&gt;&lt;/a&gt; despite entirely different classes being targetted by byteman in 5.0 and trunk is that the JVM does not exit in either branch, where in 4.1 it shuts down gracefully. Here is where 5.0 and trunk stop:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-1&amp;#93;&lt;/span&gt; 2024-06-12 10:02:16,679 Keyspace.java:379 - Creating replication strategy bar params KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.SimpleStrategy, replication_factor=1}}&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StorageServiceShutdownHook&amp;#93;&lt;/span&gt; 2024-06-12 10:02:16,686 HintsService.java:234 - Paused hints dispatch&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;but 4.1 continues:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-1&amp;#93;&lt;/span&gt; 2024-06-12 09:59:04,474 Keyspace.java:394 - Creating replication strategy foo params KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.SimpleStrategy, replication_factor=1}}&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StorageServiceShutdownHook&amp;#93;&lt;/span&gt; 2024-06-12 09:59:04,481 HintsService.java:235 - Paused hints dispatch&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StorageServiceShutdownHook&amp;#93;&lt;/span&gt; 2024-06-12 09:59:04,483 Server.java:176 - Stop listening for CQL clients&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StorageServiceShutdownHook&amp;#93;&lt;/span&gt; 2024-06-12 09:59:04,484 Gossiper.java:2139 - Announcing shutdown&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StorageServiceShutdownHook&amp;#93;&lt;/span&gt; 2024-06-12 09:59:04,484 StorageService.java:3075 - Node localhost/127.0.0.1:7000 state jump to shutdown&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StorageServiceShutdownHook&amp;#93;&lt;/span&gt; 2024-06-12 09:59:04,485 StorageService.java:3075 - Node localhost/127.0.0.1:7000 state jump to shutdown&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StorageServiceShutdownHook&amp;#93;&lt;/span&gt; 2024-06-12 09:59:06,487 MessagingService.java:526 - Waiting for messaging service to quiesce&lt;br/&gt;
...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In the thread dump I see some epoll threads still running, but I&apos;m not sure if that&apos;s typical. I don&apos;t immediately see anything from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19534&quot; title=&quot;Unbounded queues in native transport requests lead to node instability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19534&quot;&gt;&lt;del&gt;CASSANDRA-19534&lt;/del&gt;&lt;/a&gt; that would cause this, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; could you take a look? The &lt;a href=&quot;https://github.com/apache/cassandra-dtest/blob/trunk/byteman/merge_schema_failure_4x.btm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;byteman script&lt;/a&gt; is calling System.exit(0) inside Schema.merge.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13069459/13069459_shutdown_stuck.txt&quot; title=&quot;shutdown_stuck.txt attached to CASSANDRA-19697&quot;&gt;shutdown_stuck.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="17854476" author="brandon.williams" created="Wed, 12 Jun 2024 15:56:26 +0000"  >&lt;p&gt;This appears to be the problematic thread:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;&quot;Native-Transport-Requests-1&quot; #61 daemon prio=5 os_prio=0 cpu=100.90ms elapsed=693.13s tid=0x00007f2dc1af34c0 nid=0x565f in Object.wait()  &lt;span class=&quot;error&quot;&gt;&amp;#91;0x00007f2d8d690000&amp;#93;&lt;/span&gt;&lt;br/&gt;
   java.lang.Thread.State: WAITING (on object monitor)&lt;br/&gt;
	at java.lang.Object.wait(java.base@11.0.18/Native Method)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting on &amp;lt;no object reference available&amp;gt;&lt;br/&gt;
	at java.lang.Thread.join(java.base@11.0.18/Thread.java:1300)&lt;/li&gt;
	&lt;li&gt;waiting to re-lock in wait() &amp;lt;0x00000000e84c3fc8&amp;gt; (a io.netty.util.concurrent.FastThreadLocalThread)&lt;br/&gt;
	at java.lang.Thread.join(java.base@11.0.18/Thread.java:1375)&lt;br/&gt;
	at java.lang.ApplicationShutdownHooks.runHooks(java.base@11.0.18/ApplicationShutdownHooks.java:107)&lt;br/&gt;
	at java.lang.ApplicationShutdownHooks$1.run(java.base@11.0.18/ApplicationShutdownHooks.java:46)&lt;br/&gt;
	at java.lang.Shutdown.runHooks(java.base@11.0.18/Shutdown.java:130)&lt;br/&gt;
	at java.lang.Shutdown.exit(java.base@11.0.18/Shutdown.java:174)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000000fef18198&amp;gt; (a java.lang.Class for java.lang.Shutdown)&lt;br/&gt;
	at java.lang.Runtime.exit(java.base@11.0.18/Runtime.java:116)&lt;br/&gt;
	at java.lang.System.exit(java.base@11.0.18/System.java:1752)&lt;br/&gt;
	at jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(java.base@11.0.18/Native Method)&lt;br/&gt;
	at jdk.internal.reflect.NativeMethodAccessorImpl.invoke(java.base@11.0.18/NativeMethodAccessorImpl.java:62)&lt;br/&gt;
	at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(java.base@11.0.18/DelegatingMethodAccessorImpl.java:43)&lt;br/&gt;
	at java.lang.reflect.Method.invoke(java.base@11.0.18/Method.java:566)&lt;br/&gt;
	at org.jboss.byteman.rule.expression.MethodExpression.interpret(MethodExpression.java:379)&lt;br/&gt;
	at org.jboss.byteman.rule.Action.interpret(Action.java:144)&lt;br/&gt;
	at org.jboss.byteman.rule.helper.InterpretedHelper.fire(InterpretedHelper.java:170)&lt;br/&gt;
	at org.jboss.byteman.rule.helper.InterpretedHelper.execute0(InterpretedHelper.java:138)&lt;br/&gt;
	at org.jboss.byteman.rule.helper.InterpretedHelper.execute(InterpretedHelper.java:100)&lt;br/&gt;
	at org.jboss.byteman.rule.Rule.execute(Rule.java:820)&lt;br/&gt;
	at org.jboss.byteman.rule.Rule.execute(Rule.java:789)&lt;br/&gt;
	at org.apache.cassandra.schema.Schema.merge(Schema.java:649)&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;</comment>
                            <comment id="17855057" author="brandon.williams" created="Fri, 14 Jun 2024 13:40:40 +0000"  >&lt;p&gt;This test will pass if force is set to true when stopping the native transport &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-5.0/src/java/org/apache/cassandra/service/CassandraDaemon.java#L836&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, but that is obviously a big hammer approach that is not entirely correct.&lt;/p&gt;</comment>
                            <comment id="17855065" author="brandon.williams" created="Fri, 14 Jun 2024 14:01:19 +0000"  >&lt;p&gt;I think the best place to add this is in SS.shutdownClientServers, which I&apos;ve done here, let&apos;s see how CI fares:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19697-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1673/workflows/9c90b782-103a-4047-9daf-8b0102f1c04d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17855080" author="brandon.williams" created="Fri, 14 Jun 2024 14:37:40 +0000"  >&lt;p&gt;That looks good, here&apos;s a full gamut:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19697-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1673/workflows/9c90b782-103a-4047-9daf-8b0102f1c04d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1673/workflows/ec9db305-47db-4991-8a44-6354bfefded3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19697-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1674/workflows/a5626e2b-97b6-4282-acf6-0ddbf8d2ba59&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1674/workflows/369a7930-33a2-4aa4-b12b-a7d462f047d1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17855094" author="smiklosovic" created="Fri, 14 Jun 2024 15:45:12 +0000"  >&lt;p&gt;Very interesting investigation.&lt;/p&gt;

&lt;p&gt;I wonder what is the side effect of us putting there true as you suggested. It ultimately boils down to&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void close(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; force)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!force)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (!dispatcher.isDone())
                LockSupport.parkNanos(TimeUnit.MILLISECONDS.toNanos(100));
        }

        &lt;span class=&quot;code-comment&quot;&gt;// Close opened connections
&lt;/span&gt;        connectionTracker.closeAll();

        logger.info(&lt;span class=&quot;code-quote&quot;&gt;&quot;Stop listening &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; CQL clients&quot;&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, we are not waiting until dispatcher is done, we just straight close it all ... Is this safe to do? &lt;/p&gt;</comment>
                            <comment id="17855114" author="maedhroz" created="Fri, 14 Jun 2024 18:08:21 +0000"  >&lt;p&gt;&lt;tt&gt;shutdownClientServers()&lt;/tt&gt; looks like it only affects drain and decom, so I have no problem w/ the patch, and all it seems to do is revert to pre &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19534&quot; title=&quot;Unbounded queues in native transport requests lead to node instability&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19534&quot;&gt;&lt;del&gt;CASSANDRA-19534&lt;/del&gt;&lt;/a&gt; behavior. It doesn&apos;t matter on 4.1, as that doesn&apos;t wait for the &lt;tt&gt;Dispatcher&lt;/tt&gt; anyway. I&apos;m just not entirely sure why 5.0 isn&apos;t getting into a state where &lt;tt&gt;Dispatcher#requestExecutor&lt;/tt&gt; is finished.&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17855862" author="smiklosovic" created="Tue, 18 Jun 2024 10:15:56 +0000"  >&lt;p&gt;any progress? This is basically the only blocker for RC.&lt;/p&gt;</comment>
                            <comment id="17855880" author="ifesdjeen" created="Tue, 18 Jun 2024 11:29:46 +0000"  >&lt;p&gt;Just do give you heads up, there is a huge problem in virtually all existing Cassandra clusters: timeouts on node bounces. If we do not wait for dispatcher threads, I recommend we use &lt;tt&gt;disablebinary -f&lt;/tt&gt; for those tests. But in general, I think we &lt;em&gt;should&lt;/em&gt; wait for the accepted client tasks to complete. &lt;/p&gt;</comment>
                            <comment id="17855938" author="smiklosovic" created="Tue, 18 Jun 2024 13:24:37 +0000"  >&lt;p&gt;Well that &lt;em&gt;is&lt;/em&gt; the progress and something to act on! Thanks for this insight.&lt;/p&gt;</comment>
                            <comment id="17855967" author="brandon.williams" created="Tue, 18 Jun 2024 15:08:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;there is a huge problem in virtually all existing Cassandra clusters: timeouts on node bounces&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t understand why they would be timeouts if we are forcibly closing the connections.  Indeed, this test is expecting a NoHostAvailable exception after injecting the failure.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If we do not wait for dispatcher threads, I recommend we use disablebinary -f for those tests&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; will this test still be valid if reworked without injecting the byteman failure?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;But in general, I think we should wait for the accepted client tasks to complete.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t disagree, it seems like the correct thing to do, but there is no need to wait longer than the native transport timeout, so maybe we should avoid hanging with something like &lt;a href=&quot;https://github.com/driftx/cassandra/commit/3c37f69e88b5d220f5f37b693bfc9e8ef27d9678&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt;.  That is still too long for this test to pass as it is, though.&lt;/p&gt;

&lt;p&gt;Also, I assume we don&apos;t wait in 4.1 so that no behavior was changed?&lt;/p&gt;</comment>
                            <comment id="17855974" author="adelapena" created="Tue, 18 Jun 2024 15:33:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;Andres de la Pe&#241;a will this test still be valid if reworked without injecting the byteman failure?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I added that test 7 years ago, so I barely remember anything. From what I read, it just makes sure that the column renames for the table and its MVs are sent in a single update. For that, it simply kills the node after the first schema update, so we would see inconsistencies if the column rename was split into multiple mutations. I don&apos;t know how we could do that without an injection. Maybe counting the number of schema merges, if there is some metric or log entry, to verify that the rename only produces one?&lt;/p&gt;</comment>
                            <comment id="17855975" author="ifesdjeen" created="Tue, 18 Jun 2024 15:35:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t understand why they would be timeouts if we are forcibly closing the connections. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The timeouts are for the in-flight requests. I.e. all in-flight (uncompleted) requests will be timed out, not for subsequently submitted ones. This is a rather large problem in production systems.&lt;/p&gt;</comment>
                            <comment id="17855988" author="brandon.williams" created="Tue, 18 Jun 2024 16:21:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t know how we could do that without an injection.&lt;/p&gt;&lt;/blockquote&gt;

&lt;blockquote&gt;&lt;p&gt;all in-flight (uncompleted) requests will be timed out.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Alright, let&apos;s take a different tack: make byteman &apos;quit harder&apos; as I&apos;ve done &lt;a href=&quot;https://github.com/driftx/cassandra-dtest/commit/5ee4a9275a8050454b429328f5802ee174ee1260&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, along with my patch to &lt;a href=&quot;https://github.com/driftx/cassandra/commit/ce94516b61e28d75aa0f39f5766257f2982056b3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;limit waiting&lt;/a&gt; on Dispatcher.isDone to native_transport_timeout.  I feel like that safeguard is a good idea since we don&apos;t know what other behavior may cause it to hang indefinitely.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19697-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1676/workflows/b09bf845-8ee8-4284-a1ed-e9606208a462&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1676/workflows/d77dca83-822b-497f-8607-f3f6ae23bfef&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-19697-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1677/workflows/1b90d2d9-f119-4a79-ad15-d3a6e4ac85a0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1677/workflows/f4ffa169-6e2e-4272-ad79-92e8d89782f2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17856013" author="brandon.williams" created="Tue, 18 Jun 2024 17:24:19 +0000"  >&lt;p&gt;Looks like we need to make sure we hit the commit log, &lt;a href=&quot;https://github.com/driftx/cassandra-dtest/commit/e6402c42719a827ee7d7a26041739a84d770e33b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fixed&lt;/a&gt; with repeats &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1680/workflows/6b2169e3-6d3a-430e-b555-4f5a8d77b9ef&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17856047" author="smiklosovic" created="Tue, 18 Jun 2024 19:28:23 +0000"  >&lt;p&gt;halt(0) is just fine imo. +1, multiplexer passes so ...&lt;/p&gt;</comment>
                            <comment id="17856123" author="maedhroz" created="Wed, 19 Jun 2024 04:51:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;along with my patch to limit waiting on Dispatcher.isDone to native_transport_timeout. I feel like that safeguard is a good idea since we don&apos;t know what other behavior may cause it to hang indefinitely.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17856240" author="brandon.williams" created="Wed, 19 Jun 2024 11:06:48 +0000"  >&lt;p&gt;Committed, thank you for the reviews!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13069459" name="shutdown_stuck.txt" size="92841" author="brandon.williams" created="Wed, 12 Jun 2024 15:17:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13861"><![CDATA[DTest]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 20 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1pqgo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348835">NA</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/3d878201fb4ed40357aa4312741a605151e7d7e6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/3d878201fb4ed40357aa4312741a605151e7d7e6&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;run CI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>