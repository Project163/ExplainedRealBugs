<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:35:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4782] Commitlog not replayed after restart</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4782</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;It seems that there are two corner cases where commitlog is not replayed after a restart :&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;After a reboot of a server + restart of cassandra (1.1.0 to 1.1.4)&lt;/li&gt;
	&lt;li&gt;After doing an upgrade from cassandra 1.1.X to cassandra 1.1.5&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is due to the fact that the commitlog segment id should always be an  incrementing number (see this condition : &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java#L247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java#L247&lt;/a&gt; )&lt;/p&gt;

&lt;p&gt;But this assertion can be broken :&lt;br/&gt;
In the first case, it is generated by System.nanoTime() but it seems that System.nanoTime() is using the boot time as the base/reference (at least on java6 &amp;amp; linux), thus after a reboot, System.nanoTime() can return a lower number than before the reboot (and the javadoc says the reference is a relative point in time...)&lt;br/&gt;
In the second case, this was introduced by #4601 (which changes System.nanoTime() by System.currentTimeMillis() thus people starting with 1.1.5 are safe)&lt;/p&gt;

&lt;p&gt;This could explain the following tickets : #4741 and #4481&lt;/p&gt;</description>
                <environment></environment>
        <key id="12611021">CASSANDRA-4782</key>
            <summary>Commitlog not replayed after restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="frousseau">Fabien Rousseau</reporter>
                        <labels>
                    </labels>
                <created>Tue, 9 Oct 2012 16:51:29 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:25 +0000</updated>
                            <resolved>Thu, 11 Oct 2012 13:59:06 +0000</resolved>
                                        <fixVersion>1.1.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13472573" author="brandon.williams" created="Tue, 9 Oct 2012 17:33:45 +0000"  >&lt;p&gt;Thanks for the summary.  What are you proposing we do?&lt;/p&gt;</comment>
                            <comment id="13473100" author="frousseau" created="Wed, 10 Oct 2012 08:44:32 +0000"  >&lt;p&gt;To solve the first case, it&apos;s probably better, when possible, to upgrade to a newer version, then rewrite all SSTables (or at least all SSTables metadata)&lt;br/&gt;
For the second case, just rewrite all SSTables (or at least all SSTables metadata)&lt;/p&gt;

&lt;p&gt;Each SSTable metadata contains the ReplayPosition (and the max is taken to know which commitlog to replay), thus if System.nanoTime() returned a number which is a timestamp in the future, previous commitlogs will be ignored),&lt;br/&gt;
thus a drain should prevent from losing data (because there is no commitlog to replay).&lt;br/&gt;
And because SSTables are immutables, then rewriting them completely seems a better option (rather than modifying previously written metadata)&lt;/p&gt;

&lt;p&gt;Maybe the simplest to do is to have a new option to nodetool (or a new option to nodetool upgradesstables) which only changes the metadata using the following rule :&lt;br/&gt;
if the replayPosition.segment of the SSTable is in the future, then reset it to NONE otherwise, let it to its current value. (NONE is valid value if node was drained and restarted)&lt;/p&gt;

&lt;p&gt;By using this rule :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if a sstable was generated previously using a higher System.nanoTime() then it is reset&lt;/li&gt;
	&lt;li&gt;if a sstable was generated previously using a lower System.nanoTime() OR System.currentTimeMillis() then it is left as is&lt;/li&gt;
	&lt;li&gt;if a sstable is generated between the start &amp;amp; this rewriting process, then it is left as is&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thus the upgrade should be :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;drain node&lt;/li&gt;
	&lt;li&gt;upgrade&lt;/li&gt;
	&lt;li&gt;start&lt;/li&gt;
	&lt;li&gt;run the process described above&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What do you think ?&lt;/p&gt;</comment>
                            <comment id="13473358" author="jbellis" created="Wed, 10 Oct 2012 16:52:11 +0000"  >&lt;p&gt;Thanks, Fabien.  I admit that I didn&apos;t realize at first the implications of the millis fix on existing sstable metadata.&lt;/p&gt;

&lt;p&gt;Patch attached that bumps the sstable version to hf as a marker that we know metadata with that version has sane replay positions.  Replay positions from older metadata will be treated as NONE.&lt;/p&gt;

&lt;p&gt;This will force a full replay the first restart on 1.1.6; afterwards, any newly flushed sstables will have the sane-replay-position marker and future restarts will not need to replay data unnecessarily.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="13473367" author="jbellis" created="Wed, 10 Oct 2012 17:01:31 +0000"  >&lt;p&gt;(patch revised to update CURRENT_VERSION as well)&lt;/p&gt;</comment>
                            <comment id="13474067" author="frousseau" created="Thu, 11 Oct 2012 12:08:20 +0000"  >&lt;p&gt;Thanks for the patch. This solution is more simple and elegant than the one I proposed.&lt;/p&gt;

&lt;p&gt;I tested it and it worked like a charm.&lt;br/&gt;
Nevertheless, if there are counters CF, a drain is probably necessary to avoid replaying the full commitlog and avoid having overcounts. (I don&apos;t think it is a problem, just something to know before the upgrade...)&lt;/p&gt;</comment>
                            <comment id="13474098" author="frousseau" created="Thu, 11 Oct 2012 12:44:05 +0000"  >&lt;p&gt;By the way, I just noticed that the commitlog files were not replayed in the order of their ids.&lt;br/&gt;
It seems that they are sorted by &quot;last modification date&quot; before being replayed, but this does not corresponds to their ids.&lt;br/&gt;
Moreover, &quot;last modification date&quot; is changed when a file is copied, so, this could also change the order of archived commitlogs.&lt;/p&gt;

&lt;p&gt;I suppose the sort order of commit log files is for schemas ?&lt;/p&gt;

&lt;p&gt;Maybe it&apos;s safer to sort them using the id in the file name ?&lt;/p&gt;</comment>
                            <comment id="13474168" author="jbellis" created="Thu, 11 Oct 2012 13:59:06 +0000"  >&lt;p&gt;Committed with a warning in NEWS to drain.&lt;/p&gt;

&lt;p&gt;Go ahead and open a separate ticket to fix sort order.&lt;/p&gt;</comment>
                            <comment id="13476266" author="rcoli" created="Mon, 15 Oct 2012 17:05:59 +0000"  >&lt;p&gt;If drain is required between versions to avoid this issue then &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4446&quot; title=&quot;nodetool drain sometimes doesn&amp;#39;t mark commitlog fully flushed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4446&quot;&gt;&lt;del&gt;CASSANDRA-4446&lt;/del&gt;&lt;/a&gt;, where drain sometimes doesn&apos;t actually drain, seems to have become more significant.&lt;/p&gt;</comment>
                            <comment id="13476948" author="omid" created="Tue, 16 Oct 2012 12:00:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4446&quot; title=&quot;nodetool drain sometimes doesn&amp;#39;t mark commitlog fully flushed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4446&quot;&gt;&lt;del&gt;CASSANDRA-4446&lt;/del&gt;&lt;/a&gt; does not happen to me any more (so far) when restarting 1.1.6 into 1.1.6. I could observe &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4446&quot; title=&quot;nodetool drain sometimes doesn&amp;#39;t mark commitlog fully flushed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4446&quot;&gt;&lt;del&gt;CASSANDRA-4446&lt;/del&gt;&lt;/a&gt; on upgrade from 1.1.3 to 1.1.6 though.&lt;/p&gt;</comment>
                            <comment id="13479127" author="arya" created="Thu, 18 Oct 2012 16:35:15 +0000"  >&lt;p&gt;+1. I think the issue I had with data loss after node restart, actually had to do with this bug. Thanks for the fix.&lt;/p&gt;</comment>
                            <comment id="14966396" author="htoulan" created="Wed, 21 Oct 2015 07:53:25 +0000"  >&lt;p&gt;Hi,&lt;br/&gt;
I know this is bug is fixed now, but I got  a loss of data in production with several nodes in Cassandra 1.1.0 (java 6 + Red Hat)&lt;br/&gt;
I&apos;ve been told that NTP and network issues occured, also the Cassandra servers have been restarted  probably due to power outage.&lt;br/&gt;
How can I identify that the loss of data are due to the bug described here? Is it reproducible ?&lt;/p&gt;

&lt;p&gt;I can&apos;t decide to upgrade my servers in production without a solid evidence...&lt;/p&gt;

&lt;p&gt;Thanks,&lt;/p&gt;

&lt;p&gt;Herv&#233;&lt;/p&gt;</comment>
                            <comment id="14973935" author="htoulan" created="Mon, 26 Oct 2015 09:37:53 +0000"  >&lt;p&gt;anyone can help ? how can I confirm I reproduced the bug ? &lt;br/&gt;
something in the logs?&lt;br/&gt;
a specific cassandra-cli command ?&lt;/p&gt;

&lt;p&gt;Thanks in advance.&lt;/p&gt;</comment>
                            <comment id="14978905" author="rcoli" created="Wed, 28 Oct 2015 17:59:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=htoulan&quot; class=&quot;user-hover&quot; rel=&quot;htoulan&quot;&gt;htoulan&lt;/a&gt; :&lt;/p&gt;

&lt;p&gt;1) JIRA is not a support forum, generally. You would get a better response from the #cassandra IRC channel on freenode or the cassandra-user@ mailing list.&lt;/p&gt;

&lt;p&gt;2) Cassandra 1.1.0 is an extremely old and extremely broken version. You should update to at least the final released version of the 1.1 line. Much better would be (first 1.2.x and then) at least the most recent 2.0.x version.&lt;/p&gt;

&lt;p&gt;3) No commit log replay bug, including this one, should be capable of losing data if you write with a sufficient ConsistencyLevel and Replication Factor and repair regularly.&lt;/p&gt;</comment>
                            <comment id="14980069" author="htoulan" created="Thu, 29 Oct 2015 08:57:37 +0000"  >&lt;p&gt;Hi Robert,&lt;/p&gt;

&lt;p&gt;1) Thank you, I did know that, I almost never encountered issue with Cassandra (even with the 1.1.0)&lt;br/&gt;
2) That&apos;s what I thought. I plan to upgrade to 1.2.9.&lt;br/&gt;
3) Now, I lose data on all 1.1.0 platforms if I insert data and reboot servers (ring composed by 2 servers)... &lt;br/&gt;
I can&apos;t believe we never saw that before. &lt;br/&gt;
I am not sure I understand how Cassandra works with System.nanoTime() and replay position but couold we imagine current timestamp reaches a value for wich this bug is now reproducibke systematically?? &lt;/p&gt;

&lt;p&gt;Anyway you&apos;re right, and upgrade is mandatory.&lt;/p&gt;


&lt;p&gt;Herv&#233;&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12548588" name="4782.txt" size="2785" author="jbellis" created="Wed, 10 Oct 2012 17:01:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>246195</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 3 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07i2n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>41695</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>frousseau</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[frousseau]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>