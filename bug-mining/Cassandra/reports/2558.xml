<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4375] FD incorrectly using RPC timeout to ignore gossip heartbeats</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4375</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Short version: You can&apos;t run a cluster with short RPC timeouts because nodes just constantly flap up/down.&lt;/p&gt;

&lt;p&gt;Long version:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3273&quot; title=&quot;FailureDetector can take a very long time to mark a host down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3273&quot;&gt;&lt;del&gt;CASSANDRA-3273&lt;/del&gt;&lt;/a&gt; tried to fix a problem resulting from the way the failure detector works, but did so by introducing a much more sever bug: With low RPC timeouts, that are lower than the typical gossip propagation time, a cluster will just constantly have all nodes flapping other nodes up and down.&lt;/p&gt;

&lt;p&gt;The cause is this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;+    &lt;span class=&quot;code-comment&quot;&gt;// in the event of a &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; partition, never record an interval longer than the rpc timeout,
&lt;/span&gt;+    &lt;span class=&quot;code-comment&quot;&gt;// since &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; a host is regularly experiencing connectivity problems lasting &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; we&apos;d
&lt;/span&gt;+    &lt;span class=&quot;code-comment&quot;&gt;// rather mark it down quickly instead of adapting
&lt;/span&gt;+    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; MAX_INTERVAL_IN_MS = DatabaseDescriptor.getRpcTimeout();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;-        tLast_ = value;            
-        arrivalIntervals_.add(interArrivalTime);        
+        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (interArrivalTime &amp;lt;= MAX_INTERVAL_IN_MS)
+            arrivalIntervals_.add(interArrivalTime);
+        &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
+            logger_.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Ignoring interval time of {}&quot;&lt;/span&gt;, interArrivalTime);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using the RPC timeout to ignore unreasonably long intervals is not correct, as the RPC timeout is completely orthogonal to gossip propagation delay (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3927&quot; title=&quot;demystify failure detector, consider partial failure handling, latency optimizations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3927&quot;&gt;&lt;del&gt;CASSANDRA-3927&lt;/del&gt;&lt;/a&gt; for a quick description of how the FD works).&lt;/p&gt;

&lt;p&gt;In practice, the propagation delay ends up being in the 0-3 second range on a cluster with good local latency. With a low RPC timeout of say 200 ms, very few heartbeat updates come in fast enough that it doesn&apos;t get ignored by the failure detector. This in turn means that the FD records a completely skewed average heartbeat interval, which in turn means that nodes almost always get flapped on interpret() unless they happen to &lt;b&gt;just&lt;/b&gt; have had their heartbeat updated. Then they flap back up whenever the next heartbeat comes in (since it gets brought up immediately).&lt;/p&gt;

&lt;p&gt;In our build, we are replacing the FD with an implementation that simply uses a fixed &lt;tt&gt;N&lt;/tt&gt; second time to convict, because this is just one of many ways in which the current FD hurts, while we still haven&apos;t found a way it actually helps relative to the trivial fixed-second conviction policy.&lt;/p&gt;

&lt;p&gt;For upstream, assuming people won&apos;t agree on changing it to a fixed timeout, I suggest, at minimum, never using a value lower than something like 10 seconds or something, when determining whether to ignore. Slightly better is to make it a config option.&lt;/p&gt;

&lt;p&gt;(I should note that if propagation delays are significantly off from the expected level, other things than the FD already breaks - such as the whole concept of &lt;tt&gt;RING_DELAY&lt;/tt&gt;, which assumes the propagation time is roughly constant with e.g. cluster size.)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12595863">CASSANDRA-4375</key>
            <summary>FD incorrectly using RPC timeout to ignore gossip heartbeats</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="scode">Peter Schuller</reporter>
                        <labels>
                            <label>gossip</label>
                    </labels>
                <created>Tue, 26 Jun 2012 04:41:33 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:31 +0000</updated>
                            <resolved>Wed, 22 Jan 2014 19:45:06 +0000</resolved>
                                        <fixVersion>1.2.14</fixVersion>
                    <fixVersion>2.0.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13401410" author="brandon.williams" created="Tue, 26 Jun 2012 14:21:03 +0000"  >&lt;p&gt;What if we set MAX_INTERVAL_IN_MS to the greater of DD.getRpcTimeout() or the gossip interval * 2?&lt;/p&gt;</comment>
                            <comment id="13401516" author="scode" created="Tue, 26 Jun 2012 17:00:47 +0000"  >&lt;p&gt;Why do we believe gossip interval * 2 is a good value? Empirically, that seems low given the 0-3x prop delay empirically observed. Remember that the gossip interval does not imply that the expected propagation delay is equal to the interval, since you&apos;re only gossiping to 1-2 random hosts.&lt;/p&gt;</comment>
                            <comment id="13401522" author="brandon.williams" created="Tue, 26 Jun 2012 17:07:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;since you&apos;re only gossiping to 1-2 random hosts&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re always gossiping to a seed, though I suppose with enough seeds that too isn&apos;t reliable.  I&apos;d be fine with setting it to something static like 10s to match the default rpc timeout, we just need some kind of reasonable bound to prevent &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3273&quot; title=&quot;FailureDetector can take a very long time to mark a host down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3273&quot;&gt;&lt;del&gt;CASSANDRA-3273&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13401761" author="scode" created="Tue, 26 Jun 2012 22:54:57 +0000"  >&lt;p&gt;Don&apos;t rely on seeds, unless we want to say that seeds are required to be up for gossip propagation to happen in a supported fashion (beyond just acting as a common set fo avoid partitions).&lt;/p&gt;

&lt;p&gt;Also, in my previous testing the seed:s ended up not impacting gossip propagation delay anyway; at least with a handful of seeds. With a single seed it might be different.&lt;/p&gt;</comment>
                            <comment id="13827147" author="jbellis" created="Wed, 20 Nov 2013 00:06:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;the RPC timeout to ignore unreasonably long intervals is not correct&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree; the two are unrelated.&lt;/p&gt;

&lt;p&gt;Suggest either hardcoding it to 10s or making it configurable.&lt;/p&gt;</comment>
                            <comment id="13829366" author="brandon.williams" created="Thu, 21 Nov 2013 21:22:30 +0000"  >&lt;p&gt;Well, let&apos;s just set it to 10s.  Probably what most people have been using anyway, and I don&apos;t think it&apos;s quite yet worth making configurable.&lt;/p&gt;</comment>
                            <comment id="13829419" author="jbellis" created="Thu, 21 Nov 2013 22:38:21 +0000"  >&lt;p&gt;Is that long enough for a Really Big Cluster?  It&apos;s only 10 gossip rounds.  Seems like RING_DELAY would be a better choice for &quot;this is the longest I should go w/o hearing from any given node.&quot;&lt;/p&gt;</comment>
                            <comment id="13830374" author="brandon.williams" created="Fri, 22 Nov 2013 22:38:54 +0000"  >&lt;p&gt;10s seemed &apos;most compatible&apos; but I think you&apos;re right, that RING_DELAY is more semantically correct.  That said, I tend to think we should just set it to 30s instead of ring delay itself, since people often inflate ring delay for various things that might not translate well to this, and since we already seed the initial value at 30s.&lt;/p&gt;</comment>
                            <comment id="13830386" author="jbellis" created="Fri, 22 Nov 2013 22:56:07 +0000"  >&lt;p&gt;Allowing people to tune it could be a feature. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13830389" author="brandon.williams" created="Fri, 22 Nov 2013 22:58:57 +0000"  >&lt;p&gt;Shouldn&apos;t they be able to tune what we seed the FD with then too? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13830398" author="jbellis" created="Fri, 22 Nov 2013 23:08:42 +0000"  >&lt;p&gt;I look forward to your patch. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13865562" author="brandon.williams" created="Wed, 8 Jan 2014 15:40:04 +0000"  >&lt;p&gt;I&apos;ve thought about this a bit, and still think it should default to ring delay, but not be coupled to it.  However, in normal operation, I do think it makes send to couple the initial value we seed the FD with and the max interval we accept.  I don&apos;t think most people should be tweaking these though, so I&apos;ve made them system properties (as ring delay is.)&lt;/p&gt;

&lt;p&gt;Patch adds cassandra.fd_initial_value_ms to control the value the FD is seeded with, which the max interval will also default to, but also adds cassandra.fd_max_interval_ms if you really need them to be disjoint (most likely for testing like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6558&quot; title=&quot;Failure Detector takes 4-5x longer than it used to&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6558&quot;&gt;&lt;del&gt;CASSANDRA-6558&lt;/del&gt;&lt;/a&gt; where you want the seed ridiculously low, but the max interval reasonable.)&lt;/p&gt;

&lt;p&gt;I will note that I changed the max interval from a double to an int, because a double just didn&apos;t make any sense.&lt;/p&gt;</comment>
                            <comment id="13877271" author="jbellis" created="Tue, 21 Jan 2014 06:37:03 +0000"  >&lt;p&gt;Shouldn&apos;t it actually default to StorageService.getRingDelay then?&lt;/p&gt;

&lt;p&gt;+1 otherwise, modulo whitespace issues&lt;/p&gt;</comment>
                            <comment id="13878996" author="brandon.williams" created="Wed, 22 Jan 2014 18:47:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;Shouldn&apos;t it actually default to StorageService.getRingDelay then?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This goes back to what I was saying about coupling RING_DELAY (which is set by getRingDelay) too closely with FD_INITIAL_VALUE.  Someone unaware of this ticket, who is changing ring delay for some reason, could ,get a nasty surprise, which would be pretty bad, especially in a minor since we&apos;re targeting 1.2.14 for this.  On the other hand, with the patch as it is if they &lt;b&gt;do&lt;/b&gt; want them to move in lockstep for some odd reason, they can just define both properties to be the same.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;+1 otherwise, modulo whitespace issues&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I couldn&apos;t see any whitespace issues.&lt;/p&gt;</comment>
                            <comment id="13879076" author="jbellis" created="Wed, 22 Jan 2014 19:33:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;if they do want them to move in lockstep for some odd reason, they can just define both properties to be the same.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good reasoning, +1&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I couldn&apos;t see any whitespace issues.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;tt&gt;if (newvalue!= null)&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="13879090" author="brandon.williams" created="Wed, 22 Jan 2014 19:45:06 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12687713">CASSANDRA-6558</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12621991" name="4375.txt" size="2914" author="brandon.williams" created="Wed, 8 Jan 2014 15:40:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256107</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 43 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gv6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96481</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>