<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:20:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2305] Tombstoned rows not purged from cache after gcgraceseconds</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2305</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;From email to list:&lt;/p&gt;

&lt;p&gt;I was wondering if this is the expected behavior of deletes (0.7.0). Let&apos;s say I have a 1-node cluster with a single CF which has gc_grace_seconds = 0. The following sequence of operations happens (in the given order):&lt;/p&gt;

&lt;p&gt;insert row X with timestamp T&lt;br/&gt;
delete row X with timestamp T+1&lt;br/&gt;
force flush + compaction&lt;br/&gt;
insert row X with timestamp T&lt;/p&gt;

&lt;p&gt;My understanding is that the tombstone created by the delete (and row X) will disappear with the flush + compaction which means the last insertion should show up. My experimentation, however, suggests otherwise (the last insertion does not show up).&lt;/p&gt;

&lt;p&gt;I believe I have traced this to the fact that the markedForDeleteAt field on the ColumnFamily does not get reset after a compaction (after gc_grace_seconds has passed); is this desirable? I think it introduces an inconsistency in how tombstoned columns work versus tombstoned CFs. Thanks.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12500984">CASSANDRA-2305</key>
            <summary>Tombstoned rows not purged from cache after gcgraceseconds</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="paladin8">Jeffrey Wang</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Mar 2011 04:39:30 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:04 +0000</updated>
                            <resolved>Sun, 10 Apr 2011 18:50:03 +0000</resolved>
                                        <fixVersion>0.7.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <workratio workratioPercent="100"/>
                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="7200">2h</timeoriginalestimate>
                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7200">2h</timespent>
                                <comments>
                            <comment id="13004960" author="paladin8" created="Thu, 10 Mar 2011 04:41:29 +0000"  >&lt;p&gt;For a little more info, I think this only happens when you remove an entire row. If you delete specific columns, the tombstones are handled appropriately.&lt;/p&gt;</comment>
                            <comment id="13005211" author="slebresne" created="Thu, 10 Mar 2011 18:01:28 +0000"  >&lt;p&gt;This will also happen if you remove all the columns inside the row (even though you didn&apos;t issued a row deletion command).&lt;/p&gt;

&lt;p&gt;The problem is that when you flush + compact and gcGrace has elapsed, if the row is empty (i.e. all tombstone have been collected), the row itself is collected. This means that when you issue the second wave of inserts, there is no trace whatsoever of the row.&lt;/p&gt;

&lt;p&gt;That&apos;s why you are not supposed to have a gcGrace too low and why it is highly advised to use the current time as a timestamp. If so, the scenario above will never happen.&lt;/p&gt;

&lt;p&gt;Best thing we can do is probably to edit &lt;a href=&quot;http://wiki.apache.org/cassandra/DistributedDeletes&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/cassandra/DistributedDeletes&lt;/a&gt; to add that gcGrace should be such that no insert with a timestamp lower that a delete could reach any given node after gcGrace has elapsed.&lt;/p&gt;</comment>
                            <comment id="13005228" author="jbellis" created="Thu, 10 Mar 2011 18:32:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;The problem is that when you flush + compact and gcGrace has elapsed, if the row is empty (i.e. all tombstone have been collected), the row itself is collected. This means that when you issue the second wave of inserts, there is no trace whatsoever of the row.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s what&apos;s supposed to happen, but Jeffrey is saying that is NOT what he observes.&lt;/p&gt;</comment>
                            <comment id="13005236" author="slebresne" created="Thu, 10 Mar 2011 18:49:25 +0000"  >&lt;p&gt;Oups, my mistake. I somehow confused myself. I was not able to reproduce though, but I&apos;ll try harder tomorrow.&lt;/p&gt;</comment>
                            <comment id="13005579" author="slebresne" created="Fri, 11 Mar 2011 10:24:55 +0000"  >&lt;p&gt;I think this is due to row cache. We do not invalidate the row cache when a row is fully collected by compaction.&lt;/p&gt;

&lt;p&gt;Jeffrey, can you confirm that you had some row cache enabled when doing your experiments ?&lt;/p&gt;

&lt;p&gt;Attaching 2 patch against 0.7. The first one is a unit test showing the failure, the second one is the fix.&lt;/p&gt;</comment>
                            <comment id="13005652" author="jbellis" created="Fri, 11 Mar 2011 14:26:08 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13005834" author="paladin8" created="Fri, 11 Mar 2011 20:57:01 +0000"  >&lt;p&gt;I actually don&apos;t have row cache enabled (I just checked cfstats to make sure), so I don&apos;t think that&apos;s the cause of my problem in particular. Here&apos;s some more info that may or may not be correct:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;When I run the compaction, in ColumnFamilyStore.removeDeletedStandard() I see that columns are being removed because of the c.timestamp() &amp;lt;= cf.getMarkedForDeleteAt() condition, which makes sense since I issued a delete on the entire row.&lt;/li&gt;
	&lt;li&gt;However, after the compaction, I do the insert, and if I flush/compact again, I still see the columns being removed because of that condition. It seems like the markedForDeleteAt field on the ColumnFamily is persisting across the major compaction which I believe is hiding the newly inserted column.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Also, my initial steps to repro were not correct, which made it hard to figure out the root cause. Here is a proper repro:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Create a CF with gc_grace_seconds = 0 and no row cache.&lt;/li&gt;
	&lt;li&gt;Insert row X, col A with timestamp 0.&lt;/li&gt;
	&lt;li&gt;Insert row X, col B with timestamp 2.&lt;/li&gt;
	&lt;li&gt;Remove row X with timestamp 1 (expect col A to disappear, col B to stay).&lt;/li&gt;
	&lt;li&gt;Wait 1 second.&lt;/li&gt;
	&lt;li&gt;Force flush and compaction.&lt;/li&gt;
	&lt;li&gt;Insert row X, col A with timestamp 0.&lt;/li&gt;
	&lt;li&gt;Read row X, col A (see nothing).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Inserting row X, col B is necessary for this to repro because if all the columns in a row disappear, the ColumnFamily object goes away and the markedForDeleteAt field is reset. Only when a column still exists does the field persist across the compaction. Hope this helps!&lt;/p&gt;</comment>
                            <comment id="13005835" author="paladin8" created="Fri, 11 Mar 2011 20:57:30 +0000"  >&lt;p&gt;I believe the cause to be something else (see latest comment).&lt;/p&gt;</comment>
                            <comment id="13005884" author="hudson" created="Fri, 11 Mar 2011 23:07:02 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #375 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/375/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/375/&lt;/a&gt;)&lt;/p&gt;
</comment>
                            <comment id="13006030" author="slebresne" created="Sat, 12 Mar 2011 11:22:07 +0000"  >&lt;p&gt;Ok, I understand what you meant. I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2317&quot; title=&quot;Column family deletion time is not always reseted after gc_grace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2317&quot;&gt;&lt;del&gt;CASSANDRA-2317&lt;/del&gt;&lt;/a&gt; with the fix since we have already committed a patch here. Thanks a lot for the report.&lt;/p&gt;</comment>
                            <comment id="13006031" author="slebresne" created="Sat, 12 Mar 2011 11:23:01 +0000"  >&lt;p&gt;Remarking this resolved, the follow up is in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2317&quot; title=&quot;Column family deletion time is not always reseted after gc_grace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2317&quot;&gt;&lt;del&gt;CASSANDRA-2317&lt;/del&gt;&lt;/a&gt; instead.&lt;/p&gt;</comment>
                            <comment id="13006413" author="slebresne" created="Mon, 14 Mar 2011 14:00:57 +0000"  >&lt;p&gt;I&apos;m reopening because the committed patch, while ok, is only a partial fix.&lt;/p&gt;</comment>
                            <comment id="13006415" author="slebresne" created="Mon, 14 Mar 2011 14:07:04 +0000"  >&lt;p&gt;The first patch was purging the cache when the full row is expired. But we don&apos;t remove expired tombstone from the cache.&lt;/p&gt;

&lt;p&gt;Attaching a second patch to purge the cache. This has two purposes: &lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;avoid surprise for client getting tombstones back from query (either sstable2json or rangeSlice) even well after gc_grace and compaction has occured&lt;/li&gt;
	&lt;li&gt;reclaim some memory for row sitting in the cache for a very long time&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Note that this patch introduces concurrent deletes, and as such SHOULDN&apos;T be applied to a branch that do not have &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1559&quot; title=&quot;make {SuperColumn,ColumnFamily}.addColumn() correct in the face of concurrent removals&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1559&quot;&gt;&lt;del&gt;CASSANDRA-1559&lt;/del&gt;&lt;/a&gt; (0.7 and 0.8 have it).&lt;/p&gt;

&lt;p&gt;Patch is against 0.7&lt;/p&gt;</comment>
                            <comment id="13017673" author="jbellis" created="Fri, 8 Apr 2011 21:47:33 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13018133" author="slebresne" created="Sun, 10 Apr 2011 18:50:03 +0000"  >&lt;p&gt;Committed to 0.7 (r1090867) and a rebased version to trunk (r1090866)&lt;/p&gt;</comment>
                            <comment id="13018136" author="hudson" created="Sun, 10 Apr 2011 19:07:14 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #429 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/429/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/429/&lt;/a&gt;)&lt;br/&gt;
    Purge tombstone from row cache (0.7 version)&lt;br/&gt;
patch by slebresne; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2305&quot; title=&quot;Tombstoned rows not purged from cache after gcgraceseconds&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2305&quot;&gt;&lt;del&gt;CASSANDRA-2305&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13018171" author="hudson" created="Sun, 10 Apr 2011 23:17:06 +0000"  >&lt;p&gt;Integrated in Cassandra #846 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra/846/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra/846/&lt;/a&gt;)&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12473375" name="0001-Compaction-test.patch" size="2741" author="slebresne" created="Fri, 11 Mar 2011 10:24:54 +0000"/>
                            <attachment id="12473376" name="0002-Invalidate-row-cache-on-compaction-purge.patch" size="1851" author="slebresne" created="Fri, 11 Mar 2011 10:24:54 +0000"/>
                            <attachment id="12473565" name="2305_2nd_patch.patch" size="1776" author="slebresne" created="Mon, 14 Mar 2011 14:07:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20550</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0galb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93146</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>