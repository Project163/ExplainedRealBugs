<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:16:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15861] Mutating sstable component may race with entire-sstable-streaming(ZCS) causing checksum validation failure</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15861</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Flaky dtest: &lt;a href=&quot;https://ci-cassandra.apache.org/view/all/job/Cassandra-devbranch-dtest/143/testReport/junit/dtest.repair_tests.repair_test/TestRepair/test_dead_sync_initiator/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test_dead_sync_initiator - repair_tests.repair_test.TestRepair&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;stacktrace&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Unexpected error found in node logs (see stdout &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; full details). Errors: [ERROR [Stream-Deserializer-127.0.0.1:7000-570871f3] 2020-06-03 04:05:19,081 CassandraEntireSSTableStreamReader.java:145 - [Stream 6f1c3360-a54f-11ea-a808-2f23710fdc90] Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; reading sstable from stream &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; table = keyspace1.standard1
org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /home/cassandra/cassandra/cassandra-dtest/tmp/dtest-te4ty0r9/test/node3/data0/keyspace1/standard1-5f5ab140a54f11eaa8082f23710fdc90/na-2-big-Statistics.db
	at org.apache.cassandra.io.sstable.metadata.MetadataSerializer.maybeValidateChecksum(MetadataSerializer.java:219)
	at org.apache.cassandra.io.sstable.metadata.MetadataSerializer.deserialize(MetadataSerializer.java:198)
	at org.apache.cassandra.io.sstable.metadata.MetadataSerializer.deserialize(MetadataSerializer.java:129)
	at org.apache.cassandra.io.sstable.metadata.MetadataSerializer.mutate(MetadataSerializer.java:226)
	at org.apache.cassandra.db.streaming.CassandraEntireSSTableStreamReader.read(CassandraEntireSSTableStreamReader.java:140)
	at org.apache.cassandra.db.streaming.CassandraIncomingFile.read(CassandraIncomingFile.java:78)
	at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:49)
	at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:36)
	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:49)
	at org.apache.cassandra.streaming.async.StreamingInboundHandler$StreamDeserializingTask.run(StreamingInboundHandler.java:181)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.io.IOException: Checksums &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; not match &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /home/cassandra/cassandra/cassandra-dtest/tmp/dtest-te4ty0r9/test/node3/data0/keyspace1/standard1-5f5ab140a54f11eaa8082f23710fdc90/na-2-big-Statistics.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;In the above test, it executes &quot;nodetool repair&quot; on node1 and kills node2 during repair. At the end, node3 reports checksum validation failure on sstable transferred from node1.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;what happened&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
1. When repair started on node1, it performs anti-compaction which modifies sstable&apos;s repairAt to 0 and pending repair id to session-id.
2. Then node1 creates {{ComponentManifest}} which contains file lengths to be transferred to node3.
3. Before node1 actually sends the files to node3, node2 is killed and node1 starts to broadcast repair-failure-message to all participants in {{CoordinatorSession#fail}}
4. Node1 receives its own repair-failure-message and fails its local repair sessions at {{LocalSessions#failSession}} which triggers async background compaction.
5. Node1&lt;span class=&quot;code-quote&quot;&gt;&apos;s background compaction will mutate sstable&apos;&lt;/span&gt;s repairAt to 0 and pending repair id to &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; via  {{PendingRepairManager#getNextRepairFinishedTask}}, as there is no more in-progress repair.
6. Node1 actually sends the sstable to node3 where the sstable&apos;s STATS component size is different from the original size recorded in the manifest.
7. At the end, node3 reports checksum validation failure when it tries to mutate sstable level and &lt;span class=&quot;code-quote&quot;&gt;&quot;isTransient&quot;&lt;/span&gt; attribute in {{CassandraEntireSSTableStreamReader#read}}.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Currently, entire-sstable-streaming requires sstable components to be immutable, because &lt;tt&gt;ComponentManifest&lt;/tt&gt;&lt;br/&gt;
with component sizes are sent before sending actual files. This isn&apos;t a problem in legacy streaming as STATS file length didn&apos;t matter.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Ideally it will be great to make sstable STATS metadata immutable, just like other sstable components, so we don&apos;t have to worry this special case.&lt;/p&gt;

&lt;p&gt;I can think of 2 ways:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Make STATS mutation as a proper compaction to create hard link on the compacting sstable components with a new descriptor, except STATS files which will be copied entirely. Then mutation will be applied on the new STATS file. At the end, old sstable will be released. This ensures all sstable components are immutable and shouldn&apos;t make these special compaction tasks slower.&lt;/li&gt;
	&lt;li&gt;Change STATS metadata format to use fixed length encoding for repair info&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13309944">CASSANDRA-15861</key>
            <summary>Mutating sstable component may race with entire-sstable-streaming(ZCS) causing checksum validation failure</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jasonstack">Zhao Yang</assignee>
                                    <reporter username="jasonstack">Zhao Yang</reporter>
                        <labels>
                    </labels>
                <created>Sun, 7 Jun 2020 14:05:08 +0000</created>
                <updated>Sun, 3 Jan 2021 17:02:35 +0000</updated>
                            <resolved>Thu, 10 Sep 2020 03:01:34 +0000</resolved>
                                        <fixVersion>4.0-beta3</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Repair</component>
                    <component>Consistency/Streaming</component>
                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17135889" author="jasonstack" created="Mon, 15 Jun 2020 14:01:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi&quot; class=&quot;user-hover&quot; rel=&quot;djoshi&quot;&gt;djoshi&lt;/a&gt; it looks like you are pretty experienced with compaction code, do you see any issue with first proposal? &lt;/p&gt;</comment>
                            <comment id="17137979" author="dcapwell" created="Tue, 16 Jun 2020 23:17:49 +0000"  >&lt;p&gt;If reading this correctly, I wonder if this should also be a issue with org.apache.cassandra.io.sstable.format.SSTableReader#cloneWithNewSummarySamplingLevel which is called by org.apache.cassandra.io.sstable.IndexSummaryRedistribution; this modifies the summary file in place.&lt;/p&gt;</comment>
                            <comment id="17138135" author="jasonstack" created="Wed, 17 Jun 2020 06:34:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt;&#160;you are right. &lt;tt&gt;IndexSummary&lt;/tt&gt; can definitely cause trouble for entire-sstable-streaming.. Then the only option we have is to apply first approach to &lt;tt&gt;IndexSummary&lt;/tt&gt;&#160;because we can&apos;t make &lt;tt&gt;IndexSummary&lt;/tt&gt;&#160;fixed-length encoding..&lt;/p&gt;

&lt;p&gt;Or we can consider a lock approach&lt;/p&gt;</comment>
                            <comment id="17138270" author="krummas" created="Wed, 17 Jun 2020 09:07:30 +0000"  >&lt;p&gt;One way could be to mark the sstable compacting while we stream the index summary and sstable metadata components&lt;/p&gt;</comment>
                            <comment id="17138303" author="jasonstack" created="Wed, 17 Jun 2020 10:02:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;One way could be to mark the sstable compacting while we stream the index summary and sstable metadata components&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;if the sstables are already in compacting state, does it mean entire-sstable-streaming will be blocked until compaction is finished? &lt;/p&gt;

&lt;p&gt;It&apos;d be nice to minize the lock scope, so &quot;critical section&quot; only include &quot;metadata mutation&quot; (rewrite index summary and stats metadata) which should be fast.&lt;/p&gt;</comment>
                            <comment id="17140036" author="dcapwell" created="Thu, 18 Jun 2020 22:41:05 +0000"  >&lt;p&gt;I took a quick look and have a few comments&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/642/files#diff-de503ddc819368b078a86f6d9e3921aeR211-R228&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/642/files#diff-de503ddc819368b078a86f6d9e3921aeR211-R228&lt;/a&gt;. isn&apos;t the write async; we are just storing on a buffer to be written later?  Looking at org.apache.cassandra.net.AsyncStreamingOutputPlus#writeFileToChannelZeroCopy it calls channel.writeAndFlush but doesn&apos;t look at the future, so the write is async.&lt;/li&gt;
	&lt;li&gt;have you done any longevity testing of this?  My fear is that compaction will get blocked while streaming is running which could cause slowness or stability issues.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17141548" author="jasonstack" created="Sun, 21 Jun 2020 17:33:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/642/files#diff-de503ddc819368b078a86f6d9e3921aeR211-R228&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/642/files#diff-de503ddc819368b078a86f6d9e3921aeR211-R228&lt;/a&gt;. isn&apos;t the write async; we are just storing on a buffer to be written later? Looking at org.apache.cassandra.net.AsyncStreamingOutputPlus#writeFileToChannelZeroCopy it calls channel.writeAndFlush but doesn&apos;t look at the future, so the write is async.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;tt&gt;writeFileToChannelZeroCopy&lt;/tt&gt; is async, but if I remember correctly about unix file system: once a file is opened, reader won&apos;t be affected by file deletion or rewrite. So when the synchronized block completes, all component file-channels are already opened and in-sync with &lt;tt&gt;ComponentManifest&lt;/tt&gt;, even if they are not flushed from netty outbound buffer to kernel.&lt;/p&gt;

&lt;p&gt;I agree with you that the atomicity should be made more obvious rather than relying on underlying FS. I will find a cleaner approach.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;have you done any longevity testing of this? My fear is that compaction will get blocked while streaming is running which could cause slowness or stability issues.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not yet, ticket is still &quot;in-progress&quot;.  It&apos;d be nice to reuse the tests did in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14556&quot; title=&quot;Stream entire SSTables when possible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14556&quot;&gt;&lt;del&gt;CASSANDRA-14556&lt;/del&gt;&lt;/a&gt;..&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Make STATS mutation as a proper compaction to create hard link on the compacting sstable components with a new descriptor, except STATS files which will be copied entirely. Then mutation will be applied on the new STATS file. At the end, old sstable will be released. This ensures all sstable components are immutable and shouldn&apos;t make these special compaction tasks slower.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I had a &lt;a href=&quot;https://github.com/jasonstack/cassandra/blob/cb9bdaf037fd550b84fe5b7da89f9c56dc729c35/src/java/org/apache/cassandra/db/compaction/StatsMutationCompaction.java#L72&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;prototype&lt;/a&gt; using the hardlink approach which should avoid blocking between compaction and streaming. The only thing I don&apos;t like is redistributing index summary every hour will explode sstable generation.. what do you guys think?&lt;/p&gt;</comment>
                            <comment id="17142390" author="dcapwell" created="Mon, 22 Jun 2020 20:25:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;writeFileToChannelZeroCopy is async, but if I remember correctly about unix file system: once a file is opened, reader won&apos;t be affected by file deletion or rewrite. So when the synchronized block completes, all component file-channels are already opened and in-sync with ComponentManifest, even if they are not flushed from netty outbound buffer to kernel.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yep, checked and see that each region in netty holds reference to the channel so you are right, will not be impacted by delete.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The only thing I don&apos;t like is redistributing index summary every hour will explode sstable generation..&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That could have negatives for third party tools like backups since they would look like new sstables; versioning the Statistics.db file would be nice but adds its own complexity as well.&lt;/p&gt;


&lt;p&gt;Looking closer at org.apache.cassandra.db.streaming.CassandraOutgoingFile#write, why not take advantage of the fact a FD will be immune to the swap and just create the FD at the start of the method?  This would give you the ability to write the header and the body without worrying about locking.&lt;/p&gt;</comment>
                            <comment id="17142896" author="jasonstack" created="Tue, 23 Jun 2020 12:51:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;Looking closer at org.apache.cassandra.db.streaming.CassandraOutgoingFile#write, why not take advantage of the fact a FD will be immune to the swap and just create the FD at the start of the method? This would give you the ability to write the header and the body without worrying about locking.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We can acquire the FD inside the lock to avoid accessing a partially written file, then use the FD during streaming.&lt;/p&gt;</comment>
                            <comment id="17143087" author="dcapwell" created="Tue, 23 Jun 2020 16:33:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;avoid accessing a partially written file&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Don&apos;t we write to a tmp file then do a atomic move and replace?  So would we need to worry about a partial file?&lt;/p&gt;</comment>
                            <comment id="17143096" author="jasonstack" created="Tue, 23 Jun 2020 16:42:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;Don&apos;t we write to a tmp file then do a atomic move and replace? So would we need to worry about a partial file?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;For index summary, it deletes first. (I believe the reason for deletion is that index summary file can be large, up to 2GB. It&apos;d be nice to release the old file earlier if it&apos;s not used) Of course, we can change it to use temp file..&lt;/p&gt;</comment>
                            <comment id="17148785" author="maedhroz" created="Tue, 30 Jun 2020 15:41:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;if the sstables are already in compacting state, does it mean entire-sstable-streaming will be blocked until compaction is finished?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; What if we just abort the ongoing compaction involving the SSTable we want to stream? (Then we can mark it ourselves for the period including manifest generation, stats streaming, and index summary streaming?)&lt;/p&gt;

&lt;p&gt;The danger, I guess, is aborting compactions that are almost done. Two ways around that I can see. One is to try to prioritize ZCS for non-compacting SSTables first. The other is just to fall back to legacy streaming if the SSTable is already compacting. Or we can do both of those things.&lt;/p&gt;</comment>
                            <comment id="17148893" author="maedhroz" created="Tue, 30 Jun 2020 18:38:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; I thought a bit more about our earlier chat (and had a quick chat w/ &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt;), and it seems like the simplest thing might be handling the stats and index summary in slightly different ways.&lt;/p&gt;

&lt;p&gt;The STATS component is small. We could just buffer it up, use that buffered size in the manifest, and stream that buffer. It special-cases this component, but we more or less avoid having to reason about the risk of blocking compactions, a repair completing, etc.&lt;/p&gt;

&lt;p&gt;For the SUMMARY, we take advantage of the fact that possibly/infrequently delaying the redistribution task isn&apos;t a big suboptimal outcome. We have a simple lock that protects it (on &lt;tt&gt;SSTableRader&lt;/tt&gt;, similar to what you&apos;ve already mentioned or as a threadsafe set of readers in a central location), i.e. streaming acquires it when the manifest is created and releases it when the index summary completes streaming (where that &quot;completion&quot; happens in the non-SSL case isn&apos;t 100% clear to me)...and index redistribution acquires it &lt;em&gt;before&lt;/em&gt; it creates a transaction in &lt;tt&gt;getRestributionTransactions()&lt;/tt&gt;, then releases it when the redistribution is complete (so we never have to block a compaction). Streaming might have to deal with a short delay if a redistribution is running, but a.) that doesn&apos;t happen that often and b.) the summary (I think) is usually not very large. (&lt;tt&gt;getRestributionTransactions()&lt;/tt&gt; can ignore streaming SSTables just like it ignores compacting ones.&lt;/p&gt;</comment>
                            <comment id="17160790" author="jasonstack" created="Sun, 19 Jul 2020 18:53:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; thanks for the suggestions.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;(where that &quot;completion&quot; happens in the non-SSL case isn&apos;t 100% clear to me)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The netty streaming itself is async, but &lt;tt&gt;CassandraEntireSSTableStreamWriter#write&lt;/tt&gt; is actually blocking because &lt;tt&gt;AsyncStreamingOutputPlus#flush&lt;/tt&gt; will wait for data being written to network. We don&apos;t need to worry about it.&lt;/p&gt;

&lt;p&gt;I ended up with sstable read/write lock approach:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;During entire-sstable streaming, &lt;tt&gt;CassandraOutgoingFile&lt;/tt&gt; will execute the streaming code within the sstable read-lock. So multiple streamings on the same sstable can start at the same time. I think it&apos;s fine to block stats-mutation/index-summary redistribution until streaming completion.&lt;/li&gt;
	&lt;li&gt;For stats mutation and index summary redistribution, they will perform the component mutation in the sstable write-lock.&lt;/li&gt;
	&lt;li&gt;Didn&apos;t reuse the synchronization on `tidy.global` because they are used in normal compaction tasks, so I added a separate read-write lock.&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;p&gt;simplest thing might be handling the stats an index summary in slightly different ways.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I feel handling stats differently may make it harder to maintain or to reason.&lt;/p&gt;</comment>
                            <comment id="17162356" author="maedhroz" created="Tue, 21 Jul 2020 21:27:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;During entire-sstable streaming, CassandraOutgoingFile will execute the streaming code within the sstable read-lock. So multiple streamings on the same sstable can start at the same time. I think it&apos;s fine to block stats-mutation/index-summary redistribution until streaming completion.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m still looking at the patch itself, but the thing I&apos;m most curious about at a design level is whether holding the SSTable read lock until we write the entirety of the SSTable to the network is safe in the face of a concurrent incremental repair. In other words, how likely is it that an incremental repair already in flight would have to wait a significant period of time to complete with an entire SSTable in the middle of streaming?&lt;/p&gt;

&lt;p&gt;We&apos;ve already talked about the possibility of just buffering the stats component, but if we think that makes things too hard to reason around, what if we instead broke the streaming into mutable vs. immutable components and wrote the mutable components first (then released the read lock)? That might at least reduce the window, and repair couldn&apos;t block while the largest components (like the data file, and perhaps index components in the future) are streaming.&lt;/p&gt;

&lt;p&gt;WDYT?&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17162384" author="bdeggleston" created="Tue, 21 Jul 2020 22:58:12 +0000"  >&lt;p&gt;I don&apos;t think introducing a lock here is going to work. The incremental repair concern is an issue, but I&apos;m more concerned about this freezing up compaction. If an outgoing stream is taking a really long time for some reason, any compaction task trying to mutate the level of that sstable will be blocking a compaction thread waiting to acquire that lock. There typically aren&apos;t a lot of compaction executors (2-8 if auto configured, probably no more than 4 in most cases), so a few of these would noticably constrain compaction throughput, or stop it entirely.&lt;/p&gt;</comment>
                            <comment id="17163769" author="jasonstack" created="Thu, 23 Jul 2020 17:01:18 +0000"  >&lt;p&gt;Updated the patch to load stats component into memory, so that entire-sstable streaming will not block LCS and incremental repair..&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;If we want to reduce the blocking time for index summary redistribution, we can consider:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;writing new index summary to a temp file and replacing the old file atomically; at the beginning of streaming, open all file channel instances which still point to the old files (this is file system dependent).&lt;/li&gt;
	&lt;li&gt;writing new index summary to a temp file and replacing the old file atomically; on the streaming side, use hard link to make sure it streams the same file.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;WDYT?&lt;/p&gt;</comment>
                            <comment id="17163844" author="maedhroz" created="Thu, 23 Jul 2020 18:13:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;writing new index summary to a temp file and replacing the old file atomically; on the streaming side, use hard link to make sure it streams the same file&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I like this a lot. It could also be used in the stats component case, which at least consolidates our approach to this kind of problem (in general). The &lt;tt&gt;ComponentManifest&lt;/tt&gt; becomes more of a &lt;tt&gt;ComponentStreamer&lt;/tt&gt;, given we&apos;d delegate the responsibility for putting bytes on the stream to it.&lt;/p&gt;</comment>
                            <comment id="17166767" author="maedhroz" created="Wed, 29 Jul 2020 00:23:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; I left a few more minor comments around the PR, but I&apos;m +1 overall at this point. I don&apos;t think there&apos;s a good alternative to the current approach unless we start trading away disk space to write the new index summary to a temp file and atomic rename (which doesn&apos;t even work on all supported operating systems).&lt;/p&gt;</comment>
                            <comment id="17167210" author="jasonstack" created="Wed, 29 Jul 2020 13:26:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt;&#160;thanks for the feedback. I have squashed and pushed.&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
There are two types of concurrent component mutations.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;index summary redistribution compaction - deletes index summary and write a new one&lt;/li&gt;
	&lt;li&gt;pending repair manager&apos;s RepairFinishedCompactionTask - atomic replace old stats with new stats file (delete and rewrite on Windows).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In order to avoid streaming mismatched ComponentManifest and files, now manifest will create hard links&lt;br/&gt;
on the mutatable components and stream the hard-linked files instead of the original files which may have been modified.&lt;/p&gt;

&lt;p&gt;To prevent creating hard links on partially written index summary or stats file in Windows OS, a read lock is&lt;br/&gt;
needed to create hard links and write lock is needed for saving index summary and stats metadata.&lt;/p&gt;

&lt;p&gt;With this approach, only saving index summary may block entire-sstable streaming but index summary redistribution is not very frequent. We can get rid of the blocking by writing index summary to a temp file and replace the old summary atomically.&lt;br/&gt;
(Note: atomic replace doesn&apos;t work on Windows, so we have to delete first)&lt;/p&gt;</comment>
                            <comment id="17168240" author="bdeggleston" created="Thu, 30 Jul 2020 21:40:21 +0000"  >&lt;p&gt;This is pretty close, I just have a few things to address.&lt;/p&gt;

&lt;p&gt;1) Orphaned hard links need to be cleaned up on startup.&lt;/p&gt;

&lt;p&gt;2) Using the streaming session id for the hard link name, instead of a time uuid, would make debugging some issues easier.&lt;/p&gt;

&lt;p&gt;3) ComponentManifest:&#160;the changes to this class feel a bit awkward to me. I think it would be cleaner if hard link creation and management was handled by a separate class. It should also be autocloseable so we&apos;re not deleting hard links in a finally block.&lt;/p&gt;

&lt;p&gt;4) Concurrency:&#160;This is much better wrt concurrency, but I think there&apos;s still some room for improvement. The main thing I&apos;m concerned about is the nested lock acquisition in &lt;tt&gt;cloneWithNewSummarySamplingLevel&lt;/tt&gt;. This makes it easier to introduce deadlocks in the future, and we should avoid doing this if we can.&#160;In this case, if you could guarantee that no more than 1 index resample can happen at once for a given sstable, the only thing you&apos;d need to synchronize in `cloneWithNewSummarySamplingLevel` is `saveSummary`.&#160;If you did that, you could just synchronize hard link creation on `tidy.global`, instead of introducing a new lock.&lt;/p&gt;</comment>
                            <comment id="17170479" author="maedhroz" created="Tue, 4 Aug 2020 00:23:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;1) Orphaned hard links need to be cleaned up on startup.&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;2) Using the streaming session id for the hard link name, instead of a time uuid, would make debugging some issues easier.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;3) ComponentManifest: the changes to this class feel a bit awkward to me. I think it would be cleaner if hard link creation and management was handled by a separate class. It should also be autocloseable so we&apos;re not deleting hard links in a finally block.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agree (and commented to this effect) that we should make whatever that class is auto-closable. I&apos;m just not sure what level we want to do this at. The creation of what we&apos;re now calling &lt;tt&gt;ComponentManifest&lt;/tt&gt; might not be simple to break up. We could leave &lt;tt&gt;ComponentManifest&lt;/tt&gt; the way it was before this patch and have a separate class, let&apos;s call it &lt;tt&gt;ComponentContext&lt;/tt&gt;, that embeds it. The &lt;tt&gt;ComponentContext&lt;/tt&gt; would only be used on the write side, where it would mostly be responsible for what the manifest doesn&apos;t do: provide a channel and file size. There could even be an interface, let&apos;s call it &lt;tt&gt;StreamingComponent&lt;/tt&gt;, which just provides a size and channel, and the &lt;tt&gt;ComponentContext&lt;/tt&gt; could be an &lt;tt&gt;Iterable&amp;lt;StreamingComponent&amp;gt;&lt;/tt&gt;. (It seems like this would fit the usage in &lt;tt&gt;CassandraEntireSSTableStreamWriter&lt;/tt&gt;.) Either way, the receiving side of the streaming logic could continue to deal with just a clean &lt;tt&gt;ComponentManifest&lt;/tt&gt;, free of things like the unused &lt;tt&gt;hardLinks&lt;/tt&gt; (which doesn&apos;t need to be transient?).&lt;/p&gt;</comment>
                            <comment id="17170484" author="maedhroz" created="Tue, 4 Aug 2020 00:50:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;if you could guarantee that no more than 1 index resample can happen at once for a given sstable, the only thing you&apos;d need to synchronize in `cloneWithNewSummarySamplingLevel` is `saveSummary`. If you did that, you could just synchronize hard link creation on `tidy.global`, instead of introducing a new lock.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we can guarantee that only one index summary resampling is going on at a time for an SSTable, but not necessarily on the same thread from run to run. What non-final state does the &lt;tt&gt;synchronized (tidy.global)&lt;/tt&gt; block in &lt;tt&gt;recloneWithNewSummarySamplingLevel()&lt;/tt&gt; protect? It&apos;s probably not the metadata, since that&apos;s already a &lt;tt&gt;TableMetadataRef&lt;/tt&gt; (and effectively volatile). That leaves &lt;tt&gt;indexSummary&lt;/tt&gt;, which perhaps we cold make &lt;tt&gt;volatile&lt;/tt&gt;, and all the state used in &lt;tt&gt;cloneAndReplace()&lt;/tt&gt;...but we could just extend the &lt;tt&gt;synchronized (tidy.global)&lt;/tt&gt; block to include the latter. Nothing expensive happens inside &lt;tt&gt;cloneAndReplace()&lt;/tt&gt;, AFAICT.&lt;/p&gt;

&lt;p&gt;I tried this locally, just with a quick and dirty substitution in the current wrapper methods for the read and write lock, and it does seem to pass the newly added tests (and fail with locking removed completely).&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17175412" author="jasonstack" created="Tue, 11 Aug 2020 09:45:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;1) Orphaned hard links need to be cleaned up on startup.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If the hard links end with `.tmp`, they will be cleaned up on startup by &lt;tt&gt;StartupChecks#checkSystemKeyspaceState&lt;/tt&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;2) Using the streaming session id for the hard link name, instead of a time uuid, would make debugging some issues easier.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think the same streaming plan id is used by different peers. It may fail to create hardlink when streaming the same sstables to different peers in the same stream plan. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We could leave ComponentManifest the way it was before this patch and have a separate class, let&apos;s call it ComponentContext, that embeds it.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In this case, if you could guarantee that no more than 1 index resample can happen at once for a given sstable, the only thing you&apos;d need to synchronize in `cloneWithNewSummarySamplingLevel` is `saveSummary`. If you did that, you could just synchronize hard link creation on `tidy.global`, instead of introducing a new lock.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed with caleb, no more than 1 index resample can happen concurrently for a given sstable as sstable is marked as compacting before resampling.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;That leaves indexSummary, which perhaps we cold make volatile, and all the state used in cloneAndReplace()...but we could just extend the synchronized (tidy.global) block to include the latter. Nothing expensive happens inside cloneAndReplace(), AFAICT.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;good idea&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;synchronized (tidy.global)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The old approach was to synchronize entire streaming phase, so I didn&apos;t use &quot;synchronized (tidy.global)&quot; which may block concurrent compactions. &lt;/p&gt;

&lt;p&gt;But now only hard-link creation is synchronized, using &quot;synchronized (tidy.global)&quot; is better than introducing a new lock.&lt;/p&gt;</comment>
                            <comment id="17176463" author="maedhroz" created="Wed, 12 Aug 2020 16:34:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;they will be cleaned up on startup by StartupChecks#checkSystemKeyspaceState&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is it there or in &lt;tt&gt;CassandraDaemon#setup()&lt;/tt&gt;? Either way, it looks like &lt;tt&gt;ColumnFamilyStoreTest&lt;/tt&gt; covers the scrub logic already.&lt;/p&gt;</comment>
                            <comment id="17178123" author="maedhroz" created="Sat, 15 Aug 2020 01:44:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt;&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; I &lt;a href=&quot;https://github.com/maedhroz/cassandra/tree/CASSANDRA-15861-final-summary&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;made a pass&lt;/a&gt; at a builder-based approach (to making more of &lt;tt&gt;SSTableReader&lt;/tt&gt;&apos;s fields &lt;tt&gt;final&lt;/tt&gt;) based on the &lt;a href=&quot;https://github.com/apache/cassandra/pull/642#discussion_r470073171&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;current branch/PR&lt;/a&gt;. There are some loose ends to tie up, but it does at least make progress toward consolidating the logic that builds the components necessary for reader creation. (It also seems to pass the tests in this PR and things like &lt;tt&gt;FailingRepairTest&lt;/tt&gt; and &lt;tt&gt;SSTableReaderTest&lt;/tt&gt; without trouble.)&lt;/p&gt;</comment>
                            <comment id="17181851" author="jasonstack" created="Fri, 21 Aug 2020 12:22:13 +0000"  >&lt;p&gt;updated the patch based on caleb&apos;s builder approach, now dfile/ifile/bf/indexSummary are all final.&lt;/p&gt;</comment>
                            <comment id="17184714" author="bdeggleston" created="Tue, 25 Aug 2020 20:02:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt;&#160;it looks like the original commits and some of the review fixes have been squashed together. Can you un-squash them? Squashing like that makes it much more difficult to review incrementally.&lt;/p&gt;</comment>
                            <comment id="17185031" author="jasonstack" created="Wed, 26 Aug 2020 08:43:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; I have restored previous commits, sorry for the trouble&lt;/p&gt;</comment>
                            <comment id="17186717" author="bdeggleston" created="Fri, 28 Aug 2020 17:12:24 +0000"  >&lt;p&gt;No problem &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt;, this LGTM. I&apos;ve made 1 small change renaming the 2 &lt;tt&gt;SSTableReader#mutateAndReloadStats&lt;/tt&gt; implementations to make what you&apos;re mutating more obvious, and pushed them &lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/CASSANDRA-15861-test&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Assuming a green test run and no objections about the rename, I&apos;ll commit once I get the second committer +1&lt;/p&gt;</comment>
                            <comment id="17188162" author="stefan.miklosovic" created="Tue, 1 Sep 2020 06:11:28 +0000"  >&lt;p&gt;This clashes with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15406&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-15406&lt;/a&gt; I am working on for a very long time and I havent been able to manage to merge it. There seems to be a clash with some functionality related to how size of files is computed because it is broken and it reports wrong numbers in netstats.&lt;/p&gt;

&lt;p&gt;Could somebody verify that this patch is compatible with 15406 and it does not break things? It is pretty frustrating to continuously rewrite already fully prepared and tested code.&lt;/p&gt;

&lt;p&gt;The problem with the original code is nicely summarized in this comment downwards and input from Benjamin Lerer &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15406?focusedCommentId=17181389&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17181389&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-15406?focusedCommentId=17181389&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17181389&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17188166" author="jasonstack" created="Tue, 1 Sep 2020 06:23:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt; I took a brief look at the patch in 15406, I think there are just minor superficial conflicts, no compatibility issue.&lt;/p&gt;</comment>
                            <comment id="17188172" author="stefan.miklosovic" created="Tue, 1 Sep 2020 06:32:21 +0000"  >&lt;p&gt;Could you elaborate on what needs to be changed specifically in mine code so it will be fully ok again? Are you already sure that your changes are computing sizes in both compressed and uncompressed paths right? (with and without entire sstable streaming)&lt;/p&gt;</comment>
                            <comment id="17188178" author="jasonstack" created="Tue, 1 Sep 2020 06:40:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;Could you elaborate on what needs to be changed specifically in mine code so it will be fully ok again?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;hmm.. some moved codes in &lt;tt&gt;CassandraOutgoingFiles&lt;/tt&gt;. What are you worried about?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Are you already sure that your changes are computing sizes in both compressed and uncompressed paths right?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;this patch is for zero-copy-streaming to avoid partial written files, not about how size is calculated.&lt;/p&gt;

&lt;p&gt;The change in &lt;tt&gt;CassandraStreamHeder&lt;/tt&gt; around compressed size is to restore original behavior (reduce GC) before storege-engine refactoring.&lt;/p&gt;</comment>
                            <comment id="17188181" author="stefan.miklosovic" created="Tue, 1 Sep 2020 06:48:05 +0000"  >&lt;p&gt;I understand that this is the most probably just more important patch than my &quot;percentage tracking&quot; where I am just accidentally fixing some size-related bug and thats life ... But I would really like to see the test where we are checking this properly because netstats can again report some weird numbers and we are back in square one. The ideal test would look like - generate some sstables compressed / uncompressed and try to stream it in their entirety / without and check that the total sizes to be streamed are equal to sum of sizes of all individual tables. For all 4 combinations. I have checked your PR and I dont see this kind of test and I am worried that it will be not be matching again.&lt;/p&gt;</comment>
                            <comment id="17188453" author="blerer" created="Tue, 1 Sep 2020 13:27:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15406&quot; title=&quot;Show the progress of data streaming and index build &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15406&quot;&gt;&lt;del&gt;CASSANDRA-15406&lt;/del&gt;&lt;/a&gt; as been going on for so long that I perfectly understand your frustration and the fact that you are worried to go to square one. The good news is that I am reviewer on both patches and I will do my best to ensure that there are no problem between them.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; found an interesting issue with the missing part in the size calculation. I missed that part by not digging deeper enough in the code history. That would have caused us to reintroduce &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10680&quot; title=&quot;Deal with small compression chunk size better during streaming plan setup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10680&quot;&gt;&lt;del&gt;CASSANDRA-10680&lt;/del&gt;&lt;/a&gt;. I need to have a new look at that part for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15406&quot; title=&quot;Show the progress of data streaming and index build &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15406&quot;&gt;&lt;del&gt;CASSANDRA-15406&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17188529" author="stefan.miklosovic" created="Tue, 1 Sep 2020 14:53:56 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;, but anyway, a test as I mentioned would be awesome to see when the code / logic which is touching this has changed little bit and we would be sure it is just computed right. The fact that we found that issue as part of 15406 is telling ... It would also simplify a lot my patch because right now I am literally parsing the output of netstats and I track that these numbers do make sense and the total is eventually equal to that sum. I am not so strong in internals so I am not able to write that &quot;low level&quot; test on my own. But ultimately it is not about me having things easier, but imho we should really test that and this patch seems to be like a good candidate to do it.&lt;/p&gt;</comment>
                            <comment id="17188539" author="blerer" created="Tue, 1 Sep 2020 15:09:35 +0000"  >&lt;p&gt;This part of the code was obviously broken. Having some tests to ensure that it does not happen again makes total sense.&lt;/p&gt;</comment>
                            <comment id="17188976" author="jasonstack" created="Wed, 2 Sep 2020 04:54:27 +0000"  >&lt;p&gt;Pushed a unit test to verify &quot;compressionMetadata&quot; is used to calculate the transferred size for compressed sstable.&lt;/p&gt;</comment>
                            <comment id="17189590" author="dcapwell" created="Wed, 2 Sep 2020 17:57:42 +0000"  >&lt;p&gt;Thanks.  FYI I am testing this patch out by constantly rebuilding (though have to truncate the available range table) while generating load on a cluster, early results looked good but will let you know (streaming doesn&apos;t seem to be the easiest thing to monitor atm).&lt;/p&gt;</comment>
                            <comment id="17189770" author="dcapwell" created="Thu, 3 Sep 2020 00:13:04 +0000"  >&lt;p&gt;Overall LGTM +1.&lt;/p&gt;

&lt;p&gt;I also took this branch and deployed to a 6 node cluster and rebuilt the nodes in a loop to constantly run streaming, everything looked fine on this front.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; not merging as I have not seen your review yet&lt;/p&gt;</comment>
                            <comment id="17189795" author="maedhroz" created="Thu, 3 Sep 2020 02:30:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;Benjamin Lerer not merging as I have not seen your review yet&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We do have 2 committer +1&apos;s (from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt;) and one non-committer +1 (me). Do we strictly need &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;&apos;s +1? (To be clear, I&apos;m fine if he wants to look...)&lt;/p&gt;</comment>
                            <comment id="17189942" author="blerer" created="Thu, 3 Sep 2020 08:24:37 +0000"  >&lt;p&gt;Sorry, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; it took me a bit of time to get to it, I started yesterday to dig into it and I would like to finish it. &lt;/p&gt;</comment>
                            <comment id="17192967" author="blerer" created="Wed, 9 Sep 2020 15:44:57 +0000"  >&lt;p&gt;+1 on my side.&lt;/p&gt;</comment>
                            <comment id="17193243" author="dcapwell" created="Wed, 9 Sep 2020 23:32:21 +0000"  >&lt;p&gt;4 +1s, ill start the commit and redo the tests.&lt;/p&gt;</comment>
                            <comment id="17193319" author="dcapwell" created="Thu, 10 Sep 2020 03:01:34 +0000"  >&lt;p&gt;PR (used source control link, which we use for commit): &lt;a href=&quot;https://github.com/apache/cassandra/pull/642&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/642&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;CI results: &lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-15861-trunk-F185BC93-1063-40DC-ADD2-CE06C061DDB4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-15861-trunk-F185BC93-1063-40DC-ADD2-CE06C061DDB4&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;one of the dtest fails, so reran and got green: &lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/507/workflows/fc1746fd-6568-4f2f-bc84-c7c40c94426c/jobs/2775/parallel-runs/0?filterBy=ALL&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/507/workflows/fc1746fd-6568-4f2f-bc84-c7c40c94426c/jobs/2775/parallel-runs/0?filterBy=ALL&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17193818" author="jasonstack" created="Thu, 10 Sep 2020 19:44:13 +0000"  >&lt;p&gt;Thanks for the review and feedback&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="13267140">CASSANDRA-15406</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13318333">CASSANDRA-15963</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasonstack]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="13161" cascade-level="1"><![CDATA[Unrecoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 9 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0flew:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
        <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
        <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
        <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348285">4.0-beta1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/d7a7c9eabc976b1defe9ec5dc912f75d855ea481&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/d7a7c9eabc976b1defe9ec5dc912f75d855ea481&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jasonstack/cassandra/306/workflows/27e49813-d93b-49df-9722-737b932710b3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jasonstack/cassandra/306/workflows/27e49813-d93b-49df-9722-737b932710b3&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>