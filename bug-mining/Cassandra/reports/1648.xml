<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:33:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4289] Secondary Indexes fail following a system restart</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4289</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Create a new cf with a secondary index, and queries with indexes predicates work fine until the server is restarted, after which they error and the following stacktrace is output to the log:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.ClassCastException: java.math.BigInteger cannot be &lt;span class=&quot;code-keyword&quot;&gt;cast&lt;/span&gt; to java.nio.ByteBuffer
	at org.apache.cassandra.dht.LocalToken.compareTo(LocalToken.java:44)
	at org.apache.cassandra.db.DecoratedKey.compareTo(DecoratedKey.java:88)
	at org.apache.cassandra.db.DecoratedKey.compareTo(DecoratedKey.java:1)
	at org.apache.cassandra.utils.IntervalTree.comparePoints(IntervalTree.java:191)
	at org.apache.cassandra.utils.IntervalTree.contains(IntervalTree.java:203)
	at org.apache.cassandra.utils.IntervalTree.access$3(IntervalTree.java:201)
	at org.apache.cassandra.utils.IntervalTree$IntervalNode.searchInternal(IntervalTree.java:293)
	at org.apache.cassandra.utils.IntervalTree.search(IntervalTree.java:140)
	at org.apache.cassandra.utils.IntervalTree.search(IntervalTree.java:146)
	at org.apache.cassandra.db.ColumnFamilyStore.markReferenced(ColumnFamilyStore.java:1259)
	at org.apache.cassandra.db.CollationController.collectAllData(CollationController.java:229)
	at org.apache.cassandra.db.CollationController.getTopLevelColumns(CollationController.java:65)
	at org.apache.cassandra.db.ColumnFamilyStore.getTopLevelColumns(ColumnFamilyStore.java:1300)
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1174)
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1104)
	at org.apache.cassandra.db.index.keys.KeysSearcher$1.computeNext(KeysSearcher.java:144)
	at org.apache.cassandra.db.index.keys.KeysSearcher$1.computeNext(KeysSearcher.java:1)
	at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:140)
	at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:135)
	at org.apache.cassandra.db.ColumnFamilyStore.filter(ColumnFamilyStore.java:1409)
	at org.apache.cassandra.db.index.keys.KeysSearcher.search(KeysSearcher.java:88)
	at org.apache.cassandra.db.index.SecondaryIndexManager.search(SecondaryIndexManager.java:595)
	at org.apache.cassandra.db.ColumnFamilyStore.search(ColumnFamilyStore.java:1398)
	at org.apache.cassandra.service.RangeSliceVerbHandler.executeLocally(RangeSliceVerbHandler.java:47)
	at org.apache.cassandra.service.StorageProxy.getRangeSlice(StorageProxy.java:870)
	at org.apache.cassandra.cql3.statements.SelectStatement.multiRangeSlice(SelectStatement.java:259)
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:134)
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:108)
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:121)
	at org.apache.cassandra.thrift.CassandraServer.execute_cql_query(CassandraServer.java:1236)
	at org.apache.cassandra.thrift.Cassandra$Processor$execute_cql_query.getResult(Cassandra.java:3542)
	at org.apache.cassandra.thrift.Cassandra$Processor$execute_cql_query.getResult(Cassandra.java:1)
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:32)
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:34)
	at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:184)
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Tested with a single node setup &amp;amp; verified that this behaviour is only present in trunk, cassandra-1.0.10 works as expected.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Single node, trunk&lt;/p&gt;</environment>
        <key id="12558250">CASSANDRA-4289</key>
            <summary>Secondary Indexes fail following a system restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="samt">Sam Tunnicliffe</reporter>
                        <labels>
                    </labels>
                <created>Sat, 26 May 2012 16:56:20 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:33 +0000</updated>
                            <resolved>Fri, 1 Jun 2012 15:57:26 +0000</resolved>
                                        <fixVersion>1.2.0 beta 1</fixVersion>
                                    <component>Feature/2i Index</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13284105" author="dbrosius@apache.org" created="Sun, 27 May 2012 05:02:06 +0000"  >&lt;p&gt;easily reproducable. The index&apos;s column family&apos;s IntervalTree&apos;s head BigIntegerToken compared to the searched against column value.&lt;/p&gt;</comment>
                            <comment id="13286335" author="dbrosius@apache.org" created="Thu, 31 May 2012 05:26:16 +0000"  >&lt;p&gt;It appears this commit introduced this regression&lt;/p&gt;

&lt;p&gt;Save IndexSummary into new SSTable &apos;Summary&apos; component for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2392&quot; title=&quot;Saving IndexSummaries to disk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2392&quot;&gt;&lt;del&gt;CASSANDRA-2392&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commit;h=04874186892c86a20181a2f64c5dc24285021b2c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commit;h=04874186892c86a20181a2f64c5dc24285021b2c&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13286456" author="xedin" created="Thu, 31 May 2012 10:12:29 +0000"  >&lt;p&gt;The commit you mentioned doesn&apos;t touch CFS it merely saves/loads primary index into separate component, but anyway - what do you suggest as work around?&lt;/p&gt;</comment>
                            <comment id="13287108" author="jbellis" created="Fri, 1 Jun 2012 02:48:50 +0000"  >&lt;p&gt;What am I doing wrong?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh&amp;gt; create schema ks with strategy_class =&apos;SimpleStrategy&apos; and strategy_options:replication_factor=1;
cqlsh&amp;gt; use ks;
cqlsh:ks&amp;gt; create table foo(key text primary key, i int);
cqlsh:ks&amp;gt; create index i_idx on foo(i);
cqlsh:ks&amp;gt; insert into foo (key, i) values(&apos;asdf&apos;, 1);
cqlsh:ks&amp;gt; select * from foo where i = 1;
  KEY | i
------+---
 asdf | 1

[restart Cassandra server and cqlsh]

cqlsh&amp;gt; use ks;
cqlsh:ks&amp;gt; select * from foo where i = 1;
 KEY  | i 
------+---
 asdf | 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13287117" author="dbrosius@apache.org" created="Fri, 1 Jun 2012 03:06:15 +0000"  >&lt;p&gt;before stopping the server do&lt;/p&gt;

&lt;p&gt;nodetool flush&lt;/p&gt;</comment>
                            <comment id="13287121" author="jbellis" created="Fri, 1 Jun 2012 03:27:56 +0000"  >&lt;p&gt;Still works for me.&lt;/p&gt;

&lt;p&gt;I did fix a bug in the key cache for index CFs (attached) but I don&apos;t think that&apos;s what you&apos;re seeing.&lt;/p&gt;</comment>
                            <comment id="13287438" author="beobal" created="Fri, 1 Jun 2012 14:21:36 +0000"  >&lt;p&gt;SSTableReader.loadSummary wasn&apos;t taking the specific IPartitioner for the sstable into consideration, so when the IndexSummary for a secondary index cf was loaded from disk, the keys in the summary and the first &amp;amp; last keys of the sstable were decorated incorrectly. &lt;/p&gt;

&lt;p&gt;jbellis: I guess you weren&apos;t seeing this as the IndexSummary wasn&apos;t being written down to disk, but I don&apos;t why that would be&lt;/p&gt;</comment>
                            <comment id="13287491" author="xedin" created="Fri, 1 Jun 2012 15:57:26 +0000"  >&lt;p&gt;Committed combination of Sam&apos;s patch and changes to CacheService so row/key cache serializer methods would use per-CF partitioner instead of global. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12560299">CASSANDRA-4331</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12530503" name="4289-keycache.txt" size="4487" author="jbellis" created="Fri, 1 Jun 2012 03:27:56 +0000"/>
                            <attachment id="12530550" name="ASF.LICENSE.NOT.GRANTED--v1-0001-CASSANDRA-4289-Fix-errors-with-secondary-index-caused-.txt" size="6881" author="samt" created="Fri, 1 Jun 2012 14:18:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256030</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gu7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96323</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>xedin</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[xedin]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>