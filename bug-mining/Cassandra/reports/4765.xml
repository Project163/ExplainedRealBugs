<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:07:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13052] Repair process is violating the start/end token limits for small ranges</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13052</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We tried to do a single token repair by providing 2 consecutive token values for a large column family. We soon notice heavy streaming and according to the logs the number of ranges streamed was in thousands.&lt;br/&gt;
After investigation we found a bug in the two partitioner classes we use (RandomPartitioner and Murmur3Partitioner).&lt;br/&gt;
The midpoint method used by MerkleTree.differenceHelper method to find ranges with differences for streaming returns abnormal values (way out of the initial range requested for repair) if the repair requested range is small (I expect smaller than 2^15).&lt;br/&gt;
Here is the simple code to reproduce the bug for Murmur3Partitioner:&lt;/p&gt;

&lt;p&gt;Token left = new Murmur3Partitioner.LongToken(123456789L);&lt;br/&gt;
Token right = new Murmur3Partitioner.LongToken(123456789L);&lt;br/&gt;
IPartitioner partitioner = new Murmur3Partitioner();&lt;br/&gt;
Token midpoint = partitioner.midpoint(left, right);&lt;br/&gt;
System.out.println(&quot;Murmur3: [ &quot; + left.getToken() + &quot; : &quot; + midpoint.getToken() + &quot; : &quot; + right.getToken() + &quot; ]&quot;);&lt;/p&gt;

&lt;p&gt;The output is:&lt;br/&gt;
Murmur3: [ 123456789 : -9223372036731319019 : 123456789 ]&lt;/p&gt;

&lt;p&gt;Note that the midpoint token is nowhere near the suggested repair range. This will happen if during the parsing of the tree (in MerkleTree.differenceHelper) in search for differences  there isn&apos;t enough tokens for the split and the subrange becomes 0 (left.token=right.token) as in the above test.&lt;/p&gt;</description>
                <environment>&lt;p&gt;We tried this in 2.0.14 and 3.9, same bug.&lt;/p&gt;</environment>
        <key id="13028717">CASSANDRA-13052</key>
            <summary>Repair process is violating the start/end token limits for small ranges</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="spod">Stefan Podkowinski</assignee>
                                    <reporter username="cmposto">Cristian P</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Dec 2016 17:00:37 +0000</created>
                <updated>Fri, 15 May 2020 07:59:52 +0000</updated>
                            <resolved>Wed, 24 May 2017 12:57:01 +0000</resolved>
                                        <fixVersion>3.0.14</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="15761019" author="spodxx@gmail.com" created="Mon, 19 Dec 2016 12:19:12 +0000"  >&lt;p&gt;Cristian, please be aware that token ranges are start-exclusive and end-inclusive. The result of a midpoint calculation is probably undefined, in case an invalid range has been specified.&lt;/p&gt;</comment>
                            <comment id="15761136" author="cmposto" created="Mon, 19 Dec 2016 13:19:12 +0000"  >&lt;p&gt;Stefan, the above code is to highlight the root cause for the problem not the actual range. If you provide a small range the method provided in the above description will try, recursively, to divide the ranges until left and right token have same value. Next recursive iteration will generate a midpoint token way out of the suggested repair range.&lt;/p&gt;

&lt;p&gt;Here is an example (C* 2.0.14):&lt;/p&gt;

&lt;p&gt;See the token range provided for repair: (7792951013348769424,7792951013348769525]. That&apos;s 100 tokens.&lt;br/&gt;
But below you can see the Differencer.java:  &quot;have 119 range(s) out of sync for testCF&quot;. I would say you cannot split 100 tokens in 119 ranges.&lt;/p&gt;

&lt;p&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;AntiEntropySessions:1&amp;#93;&lt;/span&gt; 2016-12-15 14:52:51,951 RepairSession.java (line 246) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repair #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; new session: will sync /127.0.0.1, /127.0.0.2, /127.0.0.3 on range (7792951013348769424,7792951013348769525] for testKS.&lt;span class=&quot;error&quot;&gt;&amp;#91;testCF&amp;#93;&lt;/span&gt;&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;AntiEntropySessions:1&amp;#93;&lt;/span&gt; 2016-12-15 14:52:51,960 RepairJob.java (line 161) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repair #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; requesting merkle trees for testCF (to &lt;span class=&quot;error&quot;&gt;&amp;#91;/127.0.0.2, /127.0.0.3, /127.0.0.1&amp;#93;&lt;/span&gt;)&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;AntiEntropyStage:1&amp;#93;&lt;/span&gt; 2016-12-15 14:52:52,054 RepairSession.java (line 166) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repair #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; Received merkle tree for testCF from /127.0.0.2&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;AntiEntropyStage:1&amp;#93;&lt;/span&gt; 2016-12-15 14:52:52,064 RepairSession.java (line 166) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repair #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; Received merkle tree for testCF from /127.0.0.1&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;AntiEntropyStage:1&amp;#93;&lt;/span&gt; 2016-12-15 14:52:52,065 RepairSession.java (line 166) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repair #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; Received merkle tree for testCF from /127.0.0.3&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;RepairJobTask:1&amp;#93;&lt;/span&gt; 2016-12-15 14:52:52,071 Differencer.java (line 67) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repair #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; Endpoints /127.0.0.2 and /127.0.0.1 are consistent for testCF&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;RepairJobTask:3&amp;#93;&lt;/span&gt; 2016-12-15 14:52:52,105 Differencer.java (line 74) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repair #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; Endpoints /127.0.0.1 and /127.0.0.3 have 119 range(s) out of sync for testCF&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;RepairJobTask:2&amp;#93;&lt;/span&gt; 2016-12-15 14:52:52,108 Differencer.java (line 74) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repair #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; Endpoints /127.0.0.2 and /127.0.0.3 have 119 range(s) out of sync for testCF&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;RepairJobTask:2&amp;#93;&lt;/span&gt; 2016-12-15 14:52:52,110 StreamingRepairTask.java (line 77) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repair #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; Forwarding streaming repair of 119 ranges to /127.0.0.2 (to be streamed with /127.0.0.3)&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;RepairJobTask:3&amp;#93;&lt;/span&gt; 2016-12-15 14:52:52,118 StreamingRepairTask.java (line 64) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;streaming task #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; Performing streaming repair of 119 ranges with /127.0.0.3&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-IN-/127.0.0.3&amp;#93;&lt;/span&gt; 2016-12-15 14:52:53,363 StreamingRepairTask.java (line 92) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repair #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; streaming task succeed, returning response to /127.0.0.1&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;AntiEntropyStage:1&amp;#93;&lt;/span&gt; 2016-12-15 14:52:53,372 RepairSession.java (line 223) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repair #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; testCF is fully synced&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;AntiEntropySessions:1&amp;#93;&lt;/span&gt; 2016-12-15 14:52:53,373 RepairSession.java (line 284) &lt;a href=&quot;#27437120-c2d6-11e6-b49f-8b496c707234&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;repair #27437120-c2d6-11e6-b49f-8b496c707234&lt;/a&gt; session completed successfully&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-13&amp;#93;&lt;/span&gt; 2016-12-15 14:52:53,378 StorageService.java (line 2644) Repair session 27437120-c2d6-11e6-b49f-8b496c707234 for range (7792951013348769424,7792951013348769525] finished&lt;/p&gt;</comment>
                            <comment id="15761524" author="spodxx@gmail.com" created="Mon, 19 Dec 2016 15:53:06 +0000"  >&lt;p&gt;I&apos;ve now reproduced the described situation locally, but I&apos;m not fully sure about the implications. It&apos;s certainly not the intended behavior, so thanks a lot for reporting!&lt;/p&gt;</comment>
                            <comment id="15764262" author="spodxx@gmail.com" created="Tue, 20 Dec 2016 13:53:43 +0000"  >&lt;p&gt;Please find instructions how to locally reproduce this issue attached in &lt;tt&gt;ccm_reproduce-13052.txt&lt;/tt&gt;. I&apos;ve also linked my WIP branch, which includes debug statements for relevant parts of the MerkleTree class that will traverse and hash two trees based on the midpoint calculation. See &lt;tt&gt;system-dev-debug-13052.log&lt;/tt&gt; for example log output.&lt;/p&gt;</comment>
                            <comment id="15766949" author="spodxx@gmail.com" created="Wed, 21 Dec 2016 12:32:16 +0000"  >&lt;p&gt;My &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...spodkowinski:WIP-13052&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;WIP branch&lt;/a&gt; has now been updated with an exit condition that should avoid running into the situation to have the midpoint method called with an invalid range.&lt;/p&gt;

&lt;p&gt;The current MT code recursively looks for the node closest to the leafs by continually dividing the range by it&apos;s midpoint and returning at a point when any child is not contained anymore in the range we&apos;re looking for. Unfortunately this condition will not apply when we have a leaf in the MT that exactly spans the range of a single token we&apos;re searching. See &lt;a href=&quot;https://github.com/apache/cassandra/blob/4a2464192e9e69457f5a5ecf26c094f9298bf069/src/java/org/apache/cassandra/utils/MerkleTree.java#L420&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;MerkleTree.findHelper&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I still want to investigate how likely this going to happen for larger ranges, e.g. complete vnodes.&lt;/p&gt;</comment>
                            <comment id="15795285" author="spodxx@gmail.com" created="Tue, 3 Jan 2017 15:20:48 +0000"  >&lt;blockquote&gt;
&lt;p&gt;We soon notice heavy streaming and according to the logs the number of ranges streamed was in thousands.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cmposto&quot; class=&quot;user-hover&quot; rel=&quot;cmposto&quot;&gt;cmposto&lt;/a&gt;, I&apos;m currently a bit confused while trying to evaluate the actual effect of this behaviour. I was first a bit concerned about either having ranges streamed that shouldn&apos;t be repaired or to send identical ranges thousand of times. But I&apos;ve come to the conclusion that none of this should happen, as &lt;tt&gt;StreamSession.addTransferRanges()&lt;/tt&gt; should normalize all redundant ranges into a singe range, before starting to stream any files. Can you further describe how this bug resulted into &quot;heavy streaming&quot; on your cluster? What was is that you noticed before further looking into this issue?&lt;/p&gt;</comment>
                            <comment id="15798391" author="cmposto" created="Wed, 4 Jan 2017 14:32:24 +0000"  >&lt;p&gt;Hi Stefan,&lt;/p&gt;

&lt;p&gt;In our PROD cluster (version 2.0.14) we saw large amount of data being streamed for a single token range (order of GBs). When we run a repair for a full vnode range we see less data being streamed (order of MBs).&lt;br/&gt;
I would suggest to log the ranges streamed for the above test. Worth doing after the call to normalize.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
Cristian&lt;/p&gt;</comment>
                            <comment id="15798430" author="cmposto" created="Wed, 4 Jan 2017 14:49:00 +0000"  >&lt;p&gt;I&apos;ve just checked your attached log file and if I understood correctly I see you tried to run a repair for a range of 10 tokens only: (2321271983248423860,2321271983248423870].&lt;br/&gt;
But if you see the ranges marked as inconsistent in the logs you will find something like below. The start token in below example (-6902100053606351945) is way out of the suggested range for repair.&lt;/p&gt;

&lt;p&gt;DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RepairJobTask:2&amp;#93;&lt;/span&gt; 2016-12-20 14:24:26,756 MerkleTree.java:298 - (126) Left sub-range fully inconsistent #&amp;lt;TreeRange (-6902100053606351945,2321271983248423863] depth=127&amp;gt;&lt;/p&gt;

&lt;p&gt;DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RepairJobTask:2&amp;#93;&lt;/span&gt; 2016-12-20 14:24:26,757 MerkleTree.java:319 - (126) Right sub-range fully inconsistent #&amp;lt;TreeRange (-6902100053606351945,2321271983248423863] depth=127&amp;gt;&lt;/p&gt;

&lt;p&gt;DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RepairJobTask:2&amp;#93;&lt;/span&gt; 2016-12-20 14:24:26,759 MerkleTree.java:326 - (126) Fully inconsistent range &lt;a href=&quot;#&amp;lt;TreeRange (2321271983248423863,-6902100053606351945&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&amp;lt;TreeRange (2321271983248423863,-6902100053606351945&lt;/a&gt; depth=127&amp;gt;, #&amp;lt;TreeRange (-6902100053606351945,2321271983248423863] depth=127&amp;gt;]&lt;/p&gt;</comment>
                            <comment id="15801182" author="spodxx@gmail.com" created="Thu, 5 Jan 2017 12:01:05 +0000"  >&lt;p&gt;The issue is not that ranges will be added multiple times, but the fact that the added range has an equal start and endpoint and is thus invalid by definition. Things starts to go awry in the normalize method, which will handle the range as a wrap-around value and turns the specified range into another range of (MINIMUM, MINIMUM). This range is handled special in some occassions and seems to cause &lt;tt&gt;DataTracker.sstablesInBounds()&lt;/tt&gt; return basically all sstables. Based on those tables, the SSTable section calculation will return all content from each SSTable as well and so it looks to me that this will cause streaming of all data. &lt;/p&gt;
</comment>
                            <comment id="15801192" author="spodxx@gmail.com" created="Thu, 5 Jan 2017 12:03:40 +0000"  >&lt;p&gt;Which repairs are affected? The tree depth will effectively calculated as &lt;tt&gt;min(log(partitions), 20)&lt;/tt&gt;, ie. the depth will increase logarithmic until capped at 20. In the worst case scenario, the described bug will happen when the repaired token range will be less than 2^20. Using the Murmur3Partitioner, this is still less than individual ranges created by using vnodes in a large cluster &lt;tt&gt;(2^64 / (vnodes * nodes))&lt;/tt&gt;. As vnodes are created based on random values, there&apos;s still a chance that two vnodes are close enough together to get affected by this bug regulary. Although this requires a fairly large amount of partitions and I&apos;m wondering if it would be practically possible to run repairs in this setup anyways. More likely this could be an issue for tools that would work by calculating their own (smaller) ranges instead of running repairs based on (v)nodes.&lt;/p&gt;</comment>
                            <comment id="15801665" author="spodxx@gmail.com" created="Thu, 5 Jan 2017 15:37:16 +0000"  >&lt;p&gt;I&apos;ve started tests for my attached patch.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.x&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-13052-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-13052-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-13052-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-13052-3.x&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-13052-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-13052-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-13052-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-13052-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-13052-3.x-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-13052-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-13052-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-13052-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-13052-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-13052-3.x-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-13052-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Happy to contribute a dtest as well if someone would step up reviewing the patch.&lt;/p&gt;
</comment>
                            <comment id="16002835" author="bdeggleston" created="Tue, 9 May 2017 15:04:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=spodxx%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;spodxx@gmail.com&quot;&gt;spodxx@gmail.com&lt;/a&gt; this LGTM. If you don&apos;t mind, I&apos;ve pushed up 2 changes to my repo &lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/13052-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. I&apos;ve added a unit test, and added a check which prevents using the same start and end tokens for a subrange repair. &lt;/p&gt;

&lt;p&gt;Also, I think we should probably only apply this to 3.0 and up. It&apos;s not really critical enough to apply to 2.x imo.&lt;/p&gt;</comment>
                            <comment id="16003760" author="jjirsa" created="Tue, 9 May 2017 23:35:29 +0000"  >&lt;p&gt;Also vote for 3.0 and newer - it seems straight forward, but it&apos;s been like this a very long time. &lt;/p&gt;</comment>
                            <comment id="16014369" author="bdeggleston" created="Wed, 17 May 2017 16:42:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=spodxx%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;spodxx@gmail.com&quot;&gt;spodxx@gmail.com&lt;/a&gt; any thoughts on this?&lt;/p&gt;</comment>
                            <comment id="16014414" author="spodxx@gmail.com" created="Wed, 17 May 2017 17:05:23 +0000"  >&lt;p&gt;I&apos;ve merged your commits, rebased and fired up tests a couple of hours ago. &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;trunk &lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-13052-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/spodkowinski/cassandra/47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;a href=&quot;https://builds.apache.org/user/spod/my-views/view/Cassandra%20List%20View/job/Cassandra-devbranch-dtest/53/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;3.11 &lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-13052-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/spodkowinski/cassandra/45&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;a href=&quot;https://builds.apache.org/user/spod/my-views/view/Cassandra%20List%20View/job/Cassandra-devbranch-dtest/54/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;3.0 &lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-13052-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/spodkowinski/cassandra/46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;a href=&quot;https://builds.apache.org/user/spod/my-views/view/Cassandra%20List%20View/job/Cassandra-devbranch-dtest/51/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;d be fine to see this committed if tests don&apos;t indicate any other issues.&lt;/p&gt;</comment>
                            <comment id="16014423" author="bdeggleston" created="Wed, 17 May 2017 17:07:48 +0000"  >&lt;p&gt;Cool, +1 then. &lt;del&gt;What about only applying this to trunk?&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;EDIT: never mind the trunk only part, was thinking of another ticket &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16015423" author="spodxx@gmail.com" created="Thu, 18 May 2017 08:24:25 +0000"  >&lt;p&gt;Looks like &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11/test/unit/org/apache/cassandra/repair/messages/RepairOptionTest.java#L154&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;RepairOptionTest.java#L154&lt;/a&gt; uses a range that will now cause an &quot;java.lang.IllegalArgumentException: Start and end tokens must be different.&quot; error. If we define a token range to be start-exclusive and end-inclusive, creating a range based on a single token shouldn&apos;t be possible and we shouldn&apos;t allow &quot;42:42&quot; as &quot;ranges&quot; argument. The correct range for a single token in this case would be &quot;41:42&quot;. &lt;/p&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16016120" author="bdeggleston" created="Thu, 18 May 2017 17:27:59 +0000"  >&lt;p&gt;That makes sense. IIRC, a range with the same start and end token means &apos;the entire token range&apos;, which is unlikely to be what the person doing the repairing wanted. In the case of this test though, it&apos;s only checking that providing a subrange causes isGlobal to return false... so it should be ok to change it to &quot;41:42&quot;&lt;/p&gt;</comment>
                            <comment id="16017179" author="spodxx@gmail.com" created="Fri, 19 May 2017 10:13:28 +0000"  >&lt;p&gt;Mentioned test has been fixed and re-run, along with the aborted dtest. All tests have finished and reported errors look unrelated to the patch.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;trunk &lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-13052-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/spodkowinski/cassandra/47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;a href=&quot;https://builds.apache.org/user/spod/my-views/view/Cassandra%20List%20View/job/Cassandra-devbranch-dtest/53/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;3.11 &lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-13052-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/spodkowinski/cassandra/48&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;a href=&quot;https://builds.apache.org/user/spod/my-views/view/Cassandra%20List%20View/job/Cassandra-devbranch-dtest/57/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;3.0 &lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-13052-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/spodkowinski/cassandra/49&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;a href=&quot;https://builds.apache.org/user/spod/my-views/view/Cassandra%20List%20View/job/Cassandra-devbranch-dtest/51/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16022845" author="spodxx@gmail.com" created="Wed, 24 May 2017 12:57:01 +0000"  >&lt;p&gt;Merged as 38725802456dfcfcc2584cdfd061ac22215c2dfb to 3.0 -&amp;gt; 3.11 -&amp;gt; 4.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12845812" name="13052-2.1.patch" size="8963" author="spod" created="Thu, 5 Jan 2017 15:14:07 +0000"/>
                            <attachment id="12844076" name="ccm_reproduce-13052.txt" size="1435" author="spod" created="Tue, 20 Dec 2016 13:48:22 +0000"/>
                            <attachment id="12845782" name="system-dev-debug-13052.log" size="726028" author="spod" created="Thu, 5 Jan 2017 12:04:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[spod]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 25 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37p5r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>bdeggleston</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>