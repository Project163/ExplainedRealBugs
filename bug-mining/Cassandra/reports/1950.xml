<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:36:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5064] &apos;Alter table&apos; when it includes collections makes cqlsh hang</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5064</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Having just installed 1.2.0-beta3 issue the following CQL into cqlsh:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;drop keyspace test;

create keyspace test with replication = {
          &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;,
          &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;
        };

use test;

create table users (
            user_id text PRIMARY KEY,
            first_name text,
            last_name text,
            email_addresses set&amp;lt;text&amp;gt;
        );

alter table users add mailing_address_lines list&amp;lt;text&amp;gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As soon as you issue the alter table statement cqlsh hangs, and the java process hosting Cassandra consumes 100% of a single core&apos;s CPU.&lt;/p&gt;

&lt;p&gt;If the alter table doesn&apos;t include a collection, it runs fine.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu 12.04 LTS&lt;br/&gt;
3.2.0-23-virtual&lt;/p&gt;</environment>
        <key id="12623780">CASSANDRA-5064</key>
            <summary>&apos;Alter table&apos; when it includes collections makes cqlsh hang</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="enigmacurry">Ryan McGuire</reporter>
                        <labels>
                    </labels>
                <created>Thu, 13 Dec 2012 16:48:41 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:21 +0000</updated>
                            <resolved>Mon, 17 Dec 2012 11:05:52 +0000</resolved>
                                        <fixVersion>1.2.0 rc2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13531224" author="jbellis" created="Thu, 13 Dec 2012 17:34:42 +0000"  >&lt;p&gt;Can you verify against git 1.2.0 branch?&lt;/p&gt;</comment>
                            <comment id="13531251" author="enigmacurry" created="Thu, 13 Dec 2012 18:04:45 +0000"  >&lt;p&gt;Yes, it&apos;s affected in git 1.2.0 as well.&lt;/p&gt;</comment>
                            <comment id="13531260" author="brandon.williams" created="Thu, 13 Dec 2012 18:11:23 +0000"  >&lt;p&gt;Repros on trunk as well.  Jstack indicates the commit log writer and memtable post flusher are consuming most of the cpu. Affects the entire cluster.&lt;/p&gt;</comment>
                            <comment id="13531393" author="slebresne" created="Thu, 13 Dec 2012 19:48:18 +0000"  >&lt;p&gt;Patch attached.&lt;/p&gt;

&lt;p&gt;This is due to the fix of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4786&quot; title=&quot;NPE in migration stage after creating an index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4786&quot;&gt;&lt;del&gt;CASSANDRA-4786&lt;/del&gt;&lt;/a&gt; (and it happens that this example modifies the comparator of the CFS). The code from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4786&quot; title=&quot;NPE in migration stage after creating an index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4786&quot;&gt;&lt;del&gt;CASSANDRA-4786&lt;/del&gt;&lt;/a&gt; is relying on the fact that maybeSwitchMemtable was either returning null or was really switching the memtable. That&apos;s not the case however if the memtable is clean (I could have swear I had checked for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4786&quot; title=&quot;NPE in migration stage after creating an index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4786&quot;&gt;&lt;del&gt;CASSANDRA-4786&lt;/del&gt;&lt;/a&gt; but maybe I missed it, or the code has changed since then). In any case, the attached patch add a &apos;forceSwitch&apos; flag to maybeSwitchMemtable that fixes the issue.&lt;/p&gt;</comment>
                            <comment id="13531591" author="jbellis" created="Thu, 13 Dec 2012 22:39:15 +0000"  >&lt;p&gt;This is starting to feel fragile, and I&apos;ve never been a fan of Table.switchLock/maybeSwitchMemtable in the first place (even though I wrote it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;

&lt;p&gt;Pushed a different approach to &lt;a href=&quot;http://github.com/jbellis/cassandra/branches/5064&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://github.com/jbellis/cassandra/branches/5064&lt;/a&gt;.  The first commit is the important one: we replace Table.switchLock with reference-counted memtables.  We can then merge DataTracker.&lt;span class=&quot;error&quot;&gt;&amp;#91;renew|switch&amp;#93;&lt;/span&gt;Memtable, change maybeSwitchMemtable to unconditionally switch (but only flush if there were updates made), and this problem goes away along with a bunch of other switchLock-related complexity.&lt;/p&gt;

&lt;p&gt;Also suspect that an atomic increment is a performance win over ReentrantReadWriteLock, which is one of the most heavyweight concurrency classes.&lt;/p&gt;</comment>
                            <comment id="13531594" author="jbellis" created="Thu, 13 Dec 2012 22:41:30 +0000"  >&lt;p&gt;NB: there may be a problem with flushing during CL replay since writeCommitLog is never passed as False since 1.0.  I&apos;ve just removed it here for now.&lt;/p&gt;</comment>
                            <comment id="13532196" author="slebresne" created="Fri, 14 Dec 2012 09:48:56 +0000"  >&lt;p&gt;I&apos;m slightly confused by your branch. Do we agree that it doesn&apos;t do the &quot;change maybeSwitchMemtable to unconditionally switch&quot;? Cause I don&apos;t see it.&lt;/p&gt;

&lt;p&gt;Now about the memtable reference counting, I see at least a few problems:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;I see nothing that prevents flushing the same memtable multiple times.&lt;/li&gt;
	&lt;li&gt;getting the commit log context and switching the memtable is not done atomically with respect to writes. So a write can be pushed in the commit log after the context we&apos;re getting but still reach the memtable we&apos;re about to flush. For normal update, this is mostly inefficient in that we&apos;ll kept commit logs around long than necessary and potentially replay some update unnecessarily, but for counter this is a bug.&lt;/li&gt;
	&lt;li&gt;it&apos;s also possible that for postFlush tasks to not be scheduled in the order the commit log context were acquired. So we could discard a commitlog for which the data is not yet fully flushed.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Tbh, it may be possible to fix those problems (though for the 2nd one I don&apos;t have much idea), but I doubt we&apos;ll end up with something simpler than the current implementation. That might still be worth it ultimately for the performance improvement (though I&apos;m not sure it&apos;s one of our bottleneck, so keeping the lock that is easier to reason about may be better), but I&apos;m really doubtful that changing such an important piece of code just before a release is a good idea (again, supposing we even have a solution for the problems above).&lt;/p&gt;

&lt;p&gt;I also don&apos;t think using reference counting really makes this issue simpler.  But I do agree that the looping in CFS.reload is a bit retarded. And more generally, the &quot;maybe&quot; part in maybeSwitchMemtable is probably not justified anymore. It was useful when this was called on the with path, where all we wanted was to avoid OOM and if some other thread was already flushing it was fine. But now that we don&apos;t do that, it probably does more bad than good. What I mean is that if you call forceFlush, you expect that any write that happens-before your call has been flushed. But currently, if some other thread flushes the memtable, you&apos;ll return immediately while some data may be currently under flush (but so not flushed yet). So attaching a v2 that remove the freeze business (thus getting rid of the CFS.reload loop). I&apos;ve kept the forceSwitch flag of the first patch to avoid recreating a memtable object if not needed in the normal flush path, but we can also remove it and make forceSwitch the default if we prefer.&lt;/p&gt;</comment>
                            <comment id="13532335" author="jbellis" created="Fri, 14 Dec 2012 14:31:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;Do we agree that it doesn&apos;t do the &quot;change maybeSwitchMemtable to unconditionally switch&quot;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Here&apos;s the new core of switchMemtable:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;.       &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (ColumnFamilyStore cfs : concatWithIndexes())
        {
            Memtable mt = cfs.data.switchMemtable();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; ((!mt.isClean()))
                memtables.add(mt);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;I see nothing that prevents flushing the same memtable multiple times.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What prevents it is that DataTracker.switchMemtable is atomic and will only return a given memtable once.  (So, if we have a whole bunch of threads calling forceFlush at once, we&apos;ll probably switch out a few empty ones, but that is the end of the extra work we do.)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;for counter this is a bug&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ugh, counters again.  Have to think about this.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I also don&apos;t think using reference counting really makes this issue simpler.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I do. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  We&apos;re net -120 lines of fairly tricky code.  We&apos;ve had multiple bugs from not dealing with switchlock correctly (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3712&quot; title=&quot;Can&amp;#39;t cleanup after I moved a token.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3712&quot;&gt;&lt;del&gt;CASSANDRA-3712&lt;/del&gt;&lt;/a&gt; and the flushing code from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3411&quot; title=&quot;Pre-allocated, Recycled Commitlog Segment Files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3411&quot;&gt;&lt;del&gt;CASSANDRA-3411&lt;/del&gt;&lt;/a&gt;, off the top of my head).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m really doubtful that changing such an important piece of code just before a release is a good idea&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ll buy that.&lt;/p&gt;</comment>
                            <comment id="13532365" author="jbellis" created="Fri, 14 Dec 2012 15:13:04 +0000"  >&lt;p&gt;v2 LGTM.&lt;/p&gt;</comment>
                            <comment id="13532404" author="jbellis" created="Fri, 14 Dec 2012 15:46:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;getting the commit log context and switching the memtable is not done atomically with respect to writes&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Isn&apos;t this easily fixed by moving the context request to after the wait-for-writes-to-finish loop?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;it&apos;s also possible that for postFlush tasks to not be scheduled in the order the commit log context were acquired&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Bunch of ways we could fix this, including moving switchMemtable to its own single-threaded executor.  Or just synchronizing it, which is no worse performance-wise than the old writeLock.lock but much more localized.&lt;/p&gt;</comment>
                            <comment id="13533845" author="slebresne" created="Mon, 17 Dec 2012 11:05:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;v2 LGTM&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Alright. For now I&apos;ve committed v2 to 1.2.0 and closing this ticket.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Ugh, counters again.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree about the counters being annoying once more. That being said, even counters aside, I do like the fact that we don&apos;t ever replay useless things. It gives me the confidence that &quot;we&apos;re doing it right&quot;. Just to say that adding back the possibility to potentially hold commit logs longer than necessary doesn&apos;t feel like progress to me (it&apos;s probably a relatively minor downside compare to the performance benefits, a downside nonetheless).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We&apos;re net -120 lines of fairly tricky code.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I do think it&apos;s just flushing that is tricky, because we have to somehow coordinate on-going writes, switching the memtable and the commit log and all that must be thread-safe. I&apos;m abolutely convinced that our current stop-the-world does make it easier to reason about (granted it&apos;s not efficient and granted it&apos;s possible to forgot taking the read-lock at time, but that&apos;s still easy to understand errors). I do have a harder time convincing myself of the correctness of switchMemtable with the reference counting, because it allows for much more interleaving of events (that&apos;s what make concurrent programming hard after all). So I do buy &quot;more efficient&quot;, I don&apos;t buy &quot;much less tricky&quot; so much, and what I really mean by that is that I would be mildly enthousiastic at committing such change before 2.0 (but I do think it would be a good change for performance overall).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Isn&apos;t this easily fixed by moving the context request to after the wait-for-writes-to-finish loop?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If you do that, the context you&apos;ll get will include writes that went in the new memtable, so you&apos;ll discard commit log that have write not flushed yet, that&apos;s even worst.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Bunch of ways we could fix this.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sure. Just saying it ain&apos;t no child&apos;s play &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13534012" author="enigmacurry" created="Mon, 17 Dec 2012 15:59:00 +0000"  >&lt;p&gt;Verified this is fixed on the 1.2.0 branch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12560939" name="5064-v2.txt" size="12957" author="slebresne" created="Fri, 14 Dec 2012 09:51:03 +0000"/>
                            <attachment id="12560838" name="5064.txt" size="4106" author="slebresne" created="Thu, 13 Dec 2012 19:45:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>297480</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 49 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i14ozj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>235513</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>