<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:28:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18932] Harry-found CorruptSSTableException / RT Closer issue when reading entire partition</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18932</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;While testing some new machinery for Harry, I have encountered a new RT closer / SSTable Corruption issue. I have grounds to believe this was introduced during the last year.&lt;/p&gt;

&lt;p&gt;Issue seems to happen because of intricate interleaving of flushes with writes and deletes.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [ReadStage-2] 2023-10-16 18:47:06,696 JVMStabilityInspector.java:76 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[ReadStage-2,5,SharedPool]
org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: RandomAccessReader:BufferManagingRebufferer.Aligned:CompressedChunkReader.Mmap(/Users/ifesdjeen/foss/java/apache-cassandra-4.0/data/data1/harry/table_1-07c35a606c0a11eeae7a4f6ca489eb0c/nc-5-big-Data.db - LZ4Compressor, chunk length 16384, data length 232569)
&#160; &#160; &#160; &#160; at org.apache.cassandra.io.sstable.AbstractSSTableIterator$AbstractReader.hasNext(AbstractSSTableIterator.java:381)
&#160; &#160; &#160; &#160; at org.apache.cassandra.io.sstable.AbstractSSTableIterator.hasNext(AbstractSSTableIterator.java:242)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:95)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:32)
&#160; &#160; &#160; &#160; at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:133)
&#160; &#160; &#160; &#160; at org.apache.cassandra.utils.MergeIterator$Candidate.advance(MergeIterator.java:376)
&#160; &#160; &#160; &#160; at org.apache.cassandra.utils.MergeIterator$ManyToOne.advance(MergeIterator.java:188)
&#160; &#160; &#160; &#160; at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:157)
&#160; &#160; &#160; &#160; at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:534)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:402)
&#160; &#160; &#160; &#160; at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:95)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:32)
&#160; &#160; &#160; &#160; at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:133)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:133)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:151)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:101)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:86)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:343)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.ReadResponse$LocalDataResponse.build(ReadResponse.java:201)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:186)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.ReadResponse.createDataResponse(ReadResponse.java:48)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:346)
&#160; &#160; &#160; &#160; at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:2186)
&#160; &#160; &#160; &#160; at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2581)
&#160; &#160; &#160; &#160; at org.apache.cassandra.concurrent.ExecutionFailure$2.run(ExecutionFailure.java:163)
&#160; &#160; &#160; &#160; at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:143)
&#160; &#160; &#160; &#160; at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
&#160; &#160; &#160; &#160; at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
&#160; &#160; &#160; &#160; Suppressed: java.lang.IllegalStateException: PROCESSED UnfilteredRowIterator &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; harry.table_1 (key: ZinzDdUuABgDknItABgDknItABgDknItXEFrgBnOmPmPylWrwXHqjBHgeQrGfnZd1124124583:ZinzDdUuABgDknItABgDknItABgDknItABgDknItABgDknItzHqchghqCXLhVYKM22215251:3.2758E-41 omdt: [deletedAt=564416, localDeletion=1697450085]) has an illegal RT bounds sequence: expected all RTs to be closed, but the last one is open
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; at org.apache.cassandra.db.transform.RTBoundValidator$RowsTransformation.ise(RTBoundValidator.java:117)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; at org.apache.cassandra.db.transform.RTBoundValidator$RowsTransformation.onPartitionClose(RTBoundValidator.java:112)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; at org.apache.cassandra.db.transform.BaseRows.runOnClose(BaseRows.java:91)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; at org.apache.cassandra.db.transform.BaseIterator.close(BaseIterator.java:95)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:341)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ... 10 common frames omitted
Caused by: java.io.IOException: Invalid Columns subset bytes; too many bits set:10
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.Columns$Serializer.deserializeSubset(Columns.java:578)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.rows.UnfilteredSerializer.deserializeRowBody(UnfilteredSerializer.java:604)
&#160; &#160; &#160; &#160; at org.apache.cassandra.db.UnfilteredDeserializer.readNext(UnfilteredDeserializer.java:143)
&#160; &#160; &#160; &#160; at org.apache.cassandra.io.sstable.format.big.SSTableIterator$ForwardIndexedReader.computeNext(SSTableIterator.java:175)
&#160; &#160; &#160; &#160; at org.apache.cassandra.io.sstable.AbstractSSTableIterator$ForwardReader.hasNextInternal(AbstractSSTableIterator.java:533)
&#160; &#160; &#160; &#160; at org.apache.cassandra.io.sstable.AbstractSSTableIterator$AbstractReader.hasNext(AbstractSSTableIterator.java:368)
&#160; &#160; &#160; &#160; ... 31 common frames omitted &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Unfortunately, harry branch is not ready for release yet. That said, I have a snapshot pinned for quick repro and can share SSTables that will easily repro the issue if there are any takers.&lt;/p&gt;

&lt;p&gt;To reproduce:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
paging 1; # make sure to set page size to 1 (it breaks with other page sizes, too)
select * from harry.table_1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please also make sure to modify snitch to set rack/dc:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; DATA_CENTER_NAME = &lt;span class=&quot;code-quote&quot;&gt;&quot;datacenter0&quot;&lt;/span&gt;;
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; RACK_NAME = &lt;span class=&quot;code-quote&quot;&gt;&quot;rack0&quot;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And set directories in cassandra.yaml:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+data_file_directories:
+ - /your/path/data/data0
+ - /your/path/data/data1
+ -/your/path/data/data2&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;SHA for repro: 865d7c30e4755e74c4e4d26205a7aed4cfb55710&lt;/p&gt;</description>
                <environment></environment>
        <key id="13554277">CASSANDRA-18932</key>
            <summary>Harry-found CorruptSSTableException / RT Closer issue when reading entire partition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jlewandowski">Jacek Lewandowski</assignee>
                                    <reporter username="ifesdjeen">Alex Petrov</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Oct 2023 16:53:13 +0000</created>
                <updated>Tue, 2 Jan 2024 20:44:43 +0000</updated>
                            <resolved>Thu, 9 Nov 2023 15:16:13 +0000</resolved>
                                        <fixVersion>5.0-beta1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="17775843" author="brandon.williams" created="Mon, 16 Oct 2023 17:01:17 +0000"  >&lt;p&gt;Looks like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18915&quot; title=&quot;CorruptSSTableException due to invalid Columns subset bytes; too many bits set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18915&quot;&gt;CASSANDRA-18915&lt;/a&gt; may have run into this.&lt;/p&gt;</comment>
                            <comment id="17775854" author="mmuzaf" created="Mon, 16 Oct 2023 17:24:29 +0000"  >&lt;p&gt;Yeah, it looks likely the same, but we&apos;ve faced it on the 4.0 release. &lt;/p&gt;</comment>
                            <comment id="17775878" author="ifesdjeen" created="Mon, 16 Oct 2023 18:24:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmuzaf&quot; class=&quot;user-hover&quot; rel=&quot;mmuzaf&quot;&gt;mmuzaf&lt;/a&gt; sounds good; feel free to close this one if you can attach a stable repro. I&apos;ve attached a node state that can help anyone who has cycles to work on this to reproduce this. I also have a Harry script that reproduces if anyone wants to understand a sequence of events that leads to this, but it&apos;s about 16k lines long, so one would need to shrink for a minimal/commitable repro.&lt;/p&gt;</comment>
                            <comment id="17775880" author="mmuzaf" created="Mon, 16 Oct 2023 18:35:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; Thanks, this is my next issue to work on when I finish testing &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18891&quot; title=&quot;Cassandra 4.0 - JNA 5.6.0 does not support macOS M1 arm64&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18891&quot;&gt;CASSANDRA-18891&lt;/a&gt; . I&apos;ll be really grateful for the script that reproduces the issue, as the logging was lost on my side due to the logging service rollover. &lt;/p&gt;</comment>
                            <comment id="17775883" author="brandon.williams" created="Mon, 16 Oct 2023 18:42:44 +0000"  >&lt;p&gt;If we have a reproduction it should be possible to script a bisect to determine when this broke.&lt;/p&gt;</comment>
                            <comment id="17776045" author="ifesdjeen" created="Tue, 17 Oct 2023 07:31:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; sure, the attached sstables can be used to stably reproduce the issue. I did try against &lt;a href=&quot;https://github.com/apache/cassandra/commit/15be17ecef53adf575732fc8aa0f86eb1a774092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/15be17ecef53adf575732fc8aa0f86eb1a774092&lt;/a&gt; and can confirm that at that commit this issue doesn&apos;t repro.&lt;/p&gt;

&lt;p&gt;As soon as I have a Harry branch up, I can also share a dtest that reproduces this in about 17 seconds, and we can try shrinking the commands, since we do know which page/row it breaks on.&lt;/p&gt;</comment>
                            <comment id="17776284" author="mmuzaf" created="Tue, 17 Oct 2023 16:59:21 +0000"  >&lt;p&gt;I&apos;ve assigned this issue to myself and will look at it soon. I&apos;ll close &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18915&quot; title=&quot;CorruptSSTableException due to invalid Columns subset bytes; too many bits set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18915&quot;&gt;CASSANDRA-18915&lt;/a&gt; as a duplicate since the discussion here is more valuable. &lt;/p&gt;</comment>
                            <comment id="17783155" author="jlewandowski" created="Mon, 6 Nov 2023 09:46:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; - I&apos;ve downloaded the attached SSTables and started the server. I could successfully paginate the whole table on the current &lt;tt&gt;cassandra-5.0&lt;/tt&gt; branch - can you think of something else I&apos;d need to change to reproduce the issue?&lt;/p&gt;</comment>
                            <comment id="17783160" author="ifesdjeen" created="Mon, 6 Nov 2023 09:51:32 +0000"  >&lt;p&gt;Talked to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmuzaf&quot; class=&quot;user-hover&quot; rel=&quot;mmuzaf&quot;&gt;mmuzaf&lt;/a&gt; off-jira, looks like pagesize 5 does not repro with this particular set of sstables. It does with 1 though. Modified the description accordingly.&lt;/p&gt;</comment>
                            <comment id="17783171" author="jlewandowski" created="Mon, 6 Nov 2023 10:21:56 +0000"  >&lt;p&gt;Actually you can set paging to 128 and the second page fails immediately.&#160;&lt;/p&gt;</comment>
                            <comment id="17783197" author="jlewandowski" created="Mon, 6 Nov 2023 11:49:36 +0000"  >&lt;p&gt;For the provided sstables this is a single query which reproduces the problem without paging at all:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; harry.table_1 &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; pk0003 = &lt;span class=&quot;code-quote&quot;&gt;&apos;ZinzDdUuABgDknItABgDknItABgDknItXEFrgBnOmPmPylWrwXHqjBHgeQrGfnZd1124124583&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; pk0004 = &lt;span class=&quot;code-quote&quot;&gt;&apos;ZinzDdUuABgDknItABgDknItABgDknItABgDknItABgDknItzHqchghqCXLhVYKM22215251&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; pk0005 = 3.2758E-41 &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; ck0002 = -1110871748 &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; ck0003 = &lt;span class=&quot;code-quote&quot;&gt;&apos;ZYFiYEUkzcKOhdyazcKOhdyazcKOhdyazcKOhdyazcKOhdyaFfLoPrEzlMDvLfXY18918213101196160&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; ck0004 &amp;lt; &lt;span class=&quot;code-quote&quot;&gt;&apos;ZYFiYEUkzcKOhdyazcKOhdyazcKOhdyazcKOhdyazcKOhdyachTAyMjmsZMUPCzi23819065184175&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17783203" author="mmuzaf" created="Mon, 6 Nov 2023 12:07:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt; Thanks for the comments, yeah, I can confirm that I can reproduce the problem with paging 1. I&apos;m trying to write a simple test that will iterates directly through the .db file directly so that we can locate the commit that introduced the problem, but it still won&apos;t be earlier than &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14591&quot; title=&quot;Throw exception if Columns serialized subset encode more columns than possible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14591&quot;&gt;&lt;del&gt;CASSANDRA-14591&lt;/del&gt;&lt;/a&gt; where the constraint was added.&lt;/p&gt;</comment>
                            <comment id="17783214" author="jlewandowski" created="Mon, 6 Nov 2023 13:14:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmuzaf&quot; class=&quot;user-hover&quot; rel=&quot;mmuzaf&quot;&gt;mmuzaf&lt;/a&gt; - you can use that query ^ with the sstable attached to this ticket;&lt;/p&gt;

&lt;p&gt;I can see this difference when reading with the above query (with failure) and without a failure when the last condition is skipped:&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13064212/13064212_screenshot-1.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17783225" author="ifesdjeen" created="Mon, 6 Nov 2023 14:06:51 +0000"  >&lt;p&gt;It looks like the issue might have been introduced in &lt;a href=&quot;https://github.com/apache/cassandra/commit/b7e1e44a90&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/b7e1e44a90&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Or, at least it still reproduces on this SHA and does not on the previous one. I have cross-checked that with Jacek just to make sure it was not some cached artefact issue on my side.&lt;/p&gt;</comment>
                            <comment id="17783334" author="mmuzaf" created="Mon, 6 Nov 2023 18:49:40 +0000"  >&lt;p&gt;I seem to have boiled the reproducer down to 100 lines. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt; explained to me the cause of the problem since it was related to his patch, so I&apos;ll try to take a look at it and figure out how to fix it, but it might take a while since I&apos;m not familiar with that part of the code at all. If this is urgent and you want to fix it anyway I think my investigation might hopefully be useful in the issue review phase &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17783337" author="mmuzaf" created="Mon, 6 Nov 2023 18:55:20 +0000"  >&lt;p&gt;The commit mentioned above is for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17056&quot; title=&quot;CEP-17 &#8211; Pluggable SSTable format (SSTable format API)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17056&quot;&gt;&lt;del&gt;CASSANDRA-17056&lt;/del&gt;&lt;/a&gt; and the issue is only related to 5.0 as it has this fix version, however, the same exception stack trace we&apos;ve got for 4.0.4 for production environement that is mentioned here: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18915&quot; title=&quot;CorruptSSTableException due to invalid Columns subset bytes; too many bits set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18915&quot;&gt;CASSANDRA-18915&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17783350" author="mmuzaf" created="Mon, 6 Nov 2023 19:33:09 +0000"  >&lt;p&gt;The same reproducer doesn&apos;t reproduce the exception for the 4.1 and 4.0 branches, so the problem may be slightly different for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18915&quot; title=&quot;CorruptSSTableException due to invalid Columns subset bytes; too many bits set&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18915&quot;&gt;CASSANDRA-18915&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="17783620" author="ifesdjeen" created="Tue, 7 Nov 2023 13:02:27 +0000"  >&lt;p&gt;Smallest (so far) harry-generated repro:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &#160; @Test
&#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void corruptedSStableDuringReadTest() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
&#160; &#160; {
&#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (Cluster cluster = builder().withNodes(1)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .withConfig((cfg) -&amp;gt; {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; cfg.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;memtable_heap_space&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;512MiB&quot;&lt;/span&gt;)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;column_index_size&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1KiB&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; })
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; .start())
&#160; &#160; &#160; &#160; {
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; pk1 = &lt;span class=&quot;code-quote&quot;&gt;&quot;ZinzDdUuABgDknItABgDknItABgDknItLhDJFhdNPpEzbCrpSdhqYCfuFeXzSfHt528523179230134153120&quot;&lt;/span&gt;;
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; pk2 = 1607590537L;
&#160; &#160; &#160; &#160; &#160; &#160; cluster.schemaChange(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE KEYSPACE IF NOT EXISTS distributed_test_keyspace WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1};&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; cluster.schemaChange(&lt;span class=&quot;code-quote&quot;&gt;&quot; CREATE TABLE IF NOT EXISTS distributed_test_keyspace.table_0 (pk1 ascii,pk2 bigint,ck1 ascii,ck2 ascii,v1 ascii, PRIMARY KEY ((pk1,pk2), ck1, ck2)) WITH &#160;CLUSTERING ORDER BY (ck1 DESC,ck2 DESC);&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; cluster.coordinator(1).execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO distributed_test_keyspace.table_0 (pk1,pk2,ck1,ck2,v1) VALUES (?, ?, ?, ?, ?) USING TIMESTAMP 2796;&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;QUORUM, pk1, pk2, &lt;span class=&quot;code-quote&quot;&gt;&quot;XhzszszswKvvPril160&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;XhzszszsBXILetSZ2440401291411067712222024413922120319382156215212185199207812444823206114747416170251137776288&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;PrqcApcjVlLUPnJu17810922624911817178133246422120325130151891112101812515729917023921424472071312417514176882215010117825115533215&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; cluster.coordinator(1).execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO distributed_test_keyspace.table_0 (pk1,pk2,ck1,ck2) VALUES (?, ?, ?, ?) USING TIMESTAMP 9673;&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;QUORUM, pk1, pk2, &lt;span class=&quot;code-quote&quot;&gt;&quot;XhzszszsvezsgWfS171636154115230246180242212216218139135122313202531842495455392072408614387177166104798029248115180250227&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;XhzszszsPMEZrail5620525123714624177220143195554265108125193170145424203102391711193243114123751720220922122616813119189727170246204240262481152314517235365183217118227135119132104&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; cluster.coordinator(1).execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO distributed_test_keyspace.table_0 (pk1,pk2,ck1,ck2) VALUES (?, ?, ?, ?) USING TIMESTAMP 2253;&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;QUORUM, pk1, pk2, &lt;span class=&quot;code-quote&quot;&gt;&quot;XhzszszsukgWaIRt119213342532141149997211120&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;XhzszszsKYwrbwjS4423671233187241841253408287917304019919636221282271552511886262224501472195223445254234164552508615225511022103174183165108145&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; cluster.coordinator(1).execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;DELETE FROM distributed_test_keyspace.table_0 USING TIMESTAMP 713 WHERE pk1 = ? AND pk2 = ? AND ck1 = ? AND ck2 &amp;gt;= ? AND ck2 &amp;lt; ?;&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;QUORUM, pk1, pk2, &lt;span class=&quot;code-quote&quot;&gt;&quot;XhzszszsvezsgWfS171636154115230246180242212216218139135122313202531842495455392072408614387177166104798029248115180250227&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;XhzszszsPMEZrail5620525123714624177220143195554265108125193170145424203102391711193243114123751720220922122616813119189727170246204240262481152314517235365183217118227135119132104&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;XhzszszsuAPqXhcW651655711811739125249255921633060&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; cluster.get(1).nodetool(&lt;span class=&quot;code-quote&quot;&gt;&quot;flush&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;distributed_test_keyspace&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;table_0&quot;&lt;/span&gt;);
&#160; &#160; &#160; &#160; &#160; &#160; Iterator&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]&amp;gt; iter = cluster.coordinator(1).executeWithPaging(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM distributed_test_keyspace.table_0 WHERE pk1 = ? AND pk2 = ?;&quot;&lt;/span&gt;,
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;QUORUM, 1, pk1, pk2);
&#160; &#160; &#160; &#160; &#160; &#160; &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iter.hasNext())
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; iter.next();
&#160; &#160; &#160; &#160; }
&#160; &#160; } &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17783634" author="jlewandowski" created="Tue, 7 Nov 2023 13:55:20 +0000"  >&lt;p&gt;I think we nailed down the circumstances at which the problems happen. While testing we have seen various effects - inifinite looping during paging, silent data loss, corruption errors while reading. It seems like the repeated pattern for those problems is that:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;there are more than one primary index blocks&lt;/li&gt;
	&lt;li&gt;the last item after non-last index block is created is &lt;tt&gt;INCL_END_EXCL_START_BOUNDARY&lt;/tt&gt; tombstone marker&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The failure is not related to:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;multiple partition key columns&lt;/li&gt;
	&lt;li&gt;multiple clustering key columns&lt;/li&gt;
	&lt;li&gt;paging&lt;/li&gt;
	&lt;li&gt;clustering order&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So far we can see that the bug is in the big table iteration which uses primary index. When the index block is switched, the unfiltered deserializer is unnecessarily reset. This is my fault which I introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17056&quot; title=&quot;CEP-17 &#8211; Pluggable SSTable format (SSTable format API)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17056&quot;&gt;&lt;del&gt;CASSANDRA-17056&lt;/del&gt;&lt;/a&gt; (SSTable format API) and the fix is trivial. However, the problem revealed some holes in our test coverage and we need to address that as well.&lt;/p&gt;</comment>
                            <comment id="17783639" author="ifesdjeen" created="Tue, 7 Nov 2023 14:01:52 +0000"  >&lt;p&gt;While it is probably benefitial to run tests with different column index sizes, I think we can rely on Harry for fuzzing perturbations. I have stumbled upon this issue while testing new Harry subsystem which allows more targeted tests, better API and potentially quicker turnaround, and it has so far caught all mentioned problems: RT corruption, data loss, infinite iteration, corruption in several different places. While minimal repros are useful for reviewers, and should be attached to the patch, they are not likely to be useful for regression testing, since the chance we will re-introduce exactly same issue is relatively small. We should rely on fuzzing more: it finds issues quickly, covers all schemas, and is easy to configure and extend.&lt;/p&gt;</comment>
                            <comment id="17783643" author="jlewandowski" created="Tue, 7 Nov 2023 14:06:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; maybe we can move the discussion around fuzz testing to some other ticket and refer to this one as an example of its usefulness?&lt;/p&gt;</comment>
                            <comment id="17783645" author="ifesdjeen" created="Tue, 7 Nov 2023 14:09:32 +0000"  >&lt;p&gt;Sure, sounds good!&lt;/p&gt;</comment>
                            <comment id="17783706" author="mmuzaf" created="Tue, 7 Nov 2023 17:11:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt; as agreed upon in private messages I&apos;ve assigned it to you.&lt;/p&gt;</comment>
                            <comment id="17783970" author="ifesdjeen" created="Wed, 8 Nov 2023 09:47:11 +0000"  >&lt;p&gt;+1 on the patch.&#160;&lt;/p&gt;

&lt;p&gt;I feel like we need to also add a symptomatic test, ie one that would attempt to cross index boundary, like this one:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void silentDataLossTest() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
    {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; (Cluster cluster = builder().withNodes(1)
                                        .withConfig((cfg) -&amp;gt; cfg.set(&lt;span class=&quot;code-quote&quot;&gt;&quot;column_index_size&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;1KiB&quot;&lt;/span&gt;))
                                        .start())
        {
            cluster.schemaChange(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE KEYSPACE IF NOT EXISTS distributed_test_keyspace WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1};&quot;&lt;/span&gt;);
            cluster.schemaChange(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE IF NOT EXISTS distributed_test_keyspace.sut (pk1 bigint,ck1 bigint,v1 ascii, PRIMARY KEY (pk1, ck1));&quot;&lt;/span&gt;);
            cluster.schemaChange(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE IF NOT EXISTS distributed_test_keyspace.model (pk1 bigint,ck1 bigint,v1 ascii, PRIMARY KEY (pk1, ck1));&quot;&lt;/span&gt;);

            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; size = 0; size &amp;lt; 1000; size += 20)
            {
                &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; pk = size;
                &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; longString = &quot;&quot;;
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; size; i++)
                    longString += &lt;span class=&quot;code-quote&quot;&gt;&quot;a&quot;&lt;/span&gt;;

                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; tbl : &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[]{ &lt;span class=&quot;code-quote&quot;&gt;&quot;model&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;sut&quot;&lt;/span&gt; })
                {
                    cluster.coordinator(1).execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO distributed_test_keyspace.&quot;&lt;/span&gt; + tbl + &lt;span class=&quot;code-quote&quot;&gt;&quot; (pk1,ck1,v1) VALUES (?, ?, ?);&quot;&lt;/span&gt;, QUORUM,
                                                   pk, 0L, longString);
                    cluster.coordinator(1).execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO distributed_test_keyspace.&quot;&lt;/span&gt; + tbl + &lt;span class=&quot;code-quote&quot;&gt;&quot; (pk1,ck1) VALUES (?, ?);&quot;&lt;/span&gt;, QUORUM,
                                                   pk, 1L);
                    cluster.coordinator(1).execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;DELETE FROM distributed_test_keyspace.&quot;&lt;/span&gt; + tbl + &lt;span class=&quot;code-quote&quot;&gt;&quot; WHERE pk1 = ? AND ck1 &amp;gt; ? AND ck1 &amp;lt; ?;&quot;&lt;/span&gt;, QUORUM,
                                                   pk, 1L, 5L);
                    cluster.coordinator(1).execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO distributed_test_keyspace.&quot;&lt;/span&gt; + tbl + &lt;span class=&quot;code-quote&quot;&gt;&quot; (pk1,ck1,v1) VALUES (?, ?, ?);&quot;&lt;/span&gt;, QUORUM,
                                                   pk, 2L, longString);
                    cluster.coordinator(1).execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;DELETE FROM distributed_test_keyspace.&quot;&lt;/span&gt; + tbl + &lt;span class=&quot;code-quote&quot;&gt;&quot; WHERE pk1 = ? AND ck1 &amp;gt; ? AND ck1 &amp;lt; ?;&quot;&lt;/span&gt;, QUORUM,
                                                   pk, 2L, 5L);
                }
                cluster.get(1).nodetool(&lt;span class=&quot;code-quote&quot;&gt;&quot;flush&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;distributed_test_keyspace&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;sut&quot;&lt;/span&gt;);
                Iterator&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]&amp;gt; iterSut = cluster.coordinator(1).executeWithPaging(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM distributed_test_keyspace.sut WHERE pk1 = ?;&quot;&lt;/span&gt;,
                                                                                      QUORUM, 1, pk);
                Iterator&amp;lt;&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;[]&amp;gt; iterModel = cluster.coordinator(1).executeWithPaging(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM distributed_test_keyspace.model WHERE pk1 = ?;&quot;&lt;/span&gt;,
                                                                                        QUORUM, 1, pk);
                &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iterSut.hasNext() &amp;amp;&amp;amp; iterModel.hasNext())
                    Assert.assertArrayEquals(iterModel.next(), iterSut.next());

                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (iterModel.hasNext())
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AssertionError(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Model iterator has a row %s&quot;&lt;/span&gt;, Arrays.asList(iterModel.next())));
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (iterSut.hasNext())
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AssertionError(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;SUT iterator has a row %s&quot;&lt;/span&gt;, Arrays.asList(iterSut.next())));
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The setup is a bit different here, but it also catches a silent data loss issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18993&quot; title=&quot;Harry-found silent data loss issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18993&quot;&gt;&lt;del&gt;CASSANDRA-18993&lt;/del&gt;&lt;/a&gt;), and iterates through different sizes that allows to check more underlying conditions.&lt;/p&gt;</comment>
                            <comment id="17784099" author="jlewandowski" created="Wed, 8 Nov 2023 15:30:30 +0000"  >&lt;p&gt;I&apos;ll try to wrap-up this ticket today&lt;/p&gt;</comment>
                            <comment id="17784469" author="jlewandowski" created="Thu, 9 Nov 2023 14:14:52 +0000"  >&lt;p&gt;test links are in the PRs, are we ok to merge?&lt;/p&gt;</comment>
                            <comment id="17784473" author="ifesdjeen" created="Thu, 9 Nov 2023 14:21:47 +0000"  >&lt;p&gt;Sure, +1&lt;/p&gt;</comment>
                            <comment id="17784475" author="mmuzaf" created="Thu, 9 Nov 2023 14:24:57 +0000"  >&lt;p&gt;+1 as a quick fix, but it looks like we should enforce a contract related to the `seekToPosition&apos; method usage so that we never have to face the same issue again.&lt;/p&gt;</comment>
                            <comment id="17784478" author="jlewandowski" created="Thu, 9 Nov 2023 14:30:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmuzaf&quot; class=&quot;user-hover&quot; rel=&quot;mmuzaf&quot;&gt;mmuzaf&lt;/a&gt; I agree, for now I&apos;ll add an api doc comment&lt;/p&gt;</comment>
                            <comment id="17784480" author="ifesdjeen" created="Thu, 9 Nov 2023 14:32:03 +0000"  >&lt;p&gt;Should we also add a small comment that &#8220;column&#8221; index is in fact not a column but a row index?&lt;/p&gt;</comment>
                            <comment id="17784487" author="michaelsembwever" created="Thu, 9 Nov 2023 14:49:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;it looks like we should enforce a contract related to the `seekToPosition&apos; method usage so that we never have to face the same issue again.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;assertion (or pre-condition) over comment please.  assert and pre-conditions are &lt;em&gt;always&lt;/em&gt; better than comments.  (if possible, i&apos;m not looking at the code&#8230;)&lt;/p&gt;</comment>
                            <comment id="17784495" author="jlewandowski" created="Thu, 9 Nov 2023 14:52:12 +0000"  >&lt;p&gt;It is rather not possible, at least I have no idea how to do that without more changes. In this particular case, the method does not know whether it was called properly or not. &lt;/p&gt;

&lt;p&gt;I&apos;ve added the following comments:&lt;br/&gt;
&lt;a href=&quot;https://github.com/jacek-lewandowski/cassandra/commit/f041c07331aad2e0fa5977aa0fad33ca563c9f9f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jacek-lewandowski/cassandra/commit/f041c07331aad2e0fa5977aa0fad33ca563c9f9f&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17784509" author="jlewandowski" created="Thu, 9 Nov 2023 15:16:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; please let us know when you verify the fix for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18993&quot; title=&quot;Harry-found silent data loss issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18993&quot;&gt;&lt;del&gt;CASSANDRA-18993&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17784518" author="ifesdjeen" created="Thu, 9 Nov 2023 15:39:52 +0000"  >&lt;p&gt;Yup, I can confirm that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18993&quot; title=&quot;Harry-found silent data loss issue&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18993&quot;&gt;&lt;del&gt;CASSANDRA-18993&lt;/del&gt;&lt;/a&gt; is also fixed by this. I have been running Harry with many seeds, and do not see these failures anymore (neither exceptions, nor data masking). Thank you for working on this!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310361">
                    <name>Blocked</name>
                                            <outwardlinks description="Blocked">
                                        <issuelink>
            <issuekey id="13556490">CASSANDRA-18993</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13553379">CASSANDRA-18915</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13407903">CASSANDRA-17056</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13174398">CASSANDRA-14591</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13063584" name="node1_.zip" size="1599251" author="ifesdjeen" created="Mon, 16 Oct 2023 18:24:28 +0000"/>
                            <attachment id="13063585" name="operation.log.zip" size="881193" author="ifesdjeen" created="Mon, 16 Oct 2023 18:29:53 +0000"/>
                            <attachment id="13064212" name="screenshot-1.png" size="36276" author="jlewandowski" created="Mon, 6 Nov 2023 13:13:25 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
        <customfieldvalue><![CDATA[jlewandowski]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12974"><![CDATA[Workload Replay]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1kz48:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12353513">5.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/7a2bfdc56d2441d27b467614c2b25fe915ae34bf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/7a2bfdc56d2441d27b467614c2b25fe915ae34bf&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;regression test, fuzz tests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>