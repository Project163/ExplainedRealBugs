<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:48:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8054] EXECUTE request with skipMetadata=false gets no metadata in response</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8054</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This has been reported independently with the &lt;a href=&quot;https://datastax-oss.atlassian.net/browse/JAVA-482&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java&lt;/a&gt; and &lt;a href=&quot;https://datastax-oss.atlassian.net/browse/CPP-174&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;C++&lt;/a&gt; drivers.&lt;/p&gt;

&lt;p&gt;This happens under heavy load, where multiple client threads prepare and execute statements in parallel. One of them sends an EXECUTE request with skipMetadata=false, but the returned ROWS response has no metadata in it.&lt;/p&gt;

&lt;p&gt;A patch of &lt;tt&gt;Message.Dispatcher.channelRead0&lt;/tt&gt; confirmed that the flag was incorrectly set on the response:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;                logger.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Received: {}, v={}&quot;&lt;/span&gt;, request, connection.getVersion());

                &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; skipMetadataOnRequest = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (request &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ExecuteMessage) {
                    ExecuteMessage execute = (ExecuteMessage)request;
                    skipMetadataOnRequest = execute.options.skipMetadata();
                }
                response = request.execute(qstate);

                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (request &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ExecuteMessage) {
                    Rows rows = (Rows)response;
                    &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; skipMetadataOnResponse = rows.result.metadata.flags.contains(Flag.NO_METADATA);
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (skipMetadataOnResponse != skipMetadataOnRequest) {
                        logger.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Inconsistent skipMetadata on streamId {}, was {} in request but {} in response&quot;&lt;/span&gt;,
                                    request.getStreamId(),
                                    skipMetadataOnRequest,
                                    skipMetadataOnResponse);
                    }
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We observed the warning with (false, true) during our tests.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12745814">CASSANDRA-8054</key>
            <summary>EXECUTE request with skipMetadata=false gets no metadata in response</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="omichallat">Olivier Michallat</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Oct 2014 20:03:14 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:32 +0000</updated>
                            <resolved>Fri, 17 Oct 2014 10:38:55 +0000</resolved>
                                        <fixVersion>2.1.1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14158464" author="mpenick" created="Fri, 3 Oct 2014 20:15:25 +0000"  >&lt;p&gt;The problem is that the &lt;tt&gt;SelectStatment&lt;/tt&gt; cached in &lt;tt&gt;QueryProcessor.preparedStatements&lt;/tt&gt; shares a single instance of &lt;tt&gt;ResultSet.Metadata&lt;/tt&gt; with multiple requests. It is possible for each of those requests to mutate that single instance concurrently. For example, this could happen here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/transport/messages/ExecuteMessage.java#L135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/transport/messages/ExecuteMessage.java#L135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;and here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/cql3/statements/SelectStatement.java#L230&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/cql3/statements/SelectStatement.java#L230&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The attached patch creates a new metadata instance for each request.&lt;/p&gt;</comment>
                            <comment id="14158500" author="mpenick" created="Fri, 3 Oct 2014 20:42:45 +0000"  >&lt;p&gt;This is not an issue in 2.0 because it makes a new instance per request:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.0/src/java/org/apache/cassandra/cql3/statements/Selection.java#L61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-2.0/src/java/org/apache/cassandra/cql3/statements/Selection.java#L61&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14158576" author="jbellis" created="Fri, 3 Oct 2014 21:54:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="14160149" author="slebresne" created="Mon, 6 Oct 2014 10:00:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7120?focusedCommentId=14005790&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14005790&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;This comment&lt;/a&gt; on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7120&quot; title=&quot;Bad paging state returned for prepared statements for last page&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7120&quot;&gt;&lt;del&gt;CASSANDRA-7120&lt;/del&gt;&lt;/a&gt; applies here as well, we have to copy the whole metadata, not just the &lt;tt&gt;names&lt;/tt&gt;. On &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7120&quot; title=&quot;Bad paging state returned for prepared statements for last page&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7120&quot;&gt;&lt;del&gt;CASSANDRA-7120&lt;/del&gt;&lt;/a&gt; I advocated for saving the allocation of a new Metatdata object when there is no paging state, but extending this to this case is probably a bit more dangerous than anything else, so attaching patch that somewhat revert &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7120&quot; title=&quot;Bad paging state returned for prepared statements for last page&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7120&quot;&gt;&lt;del&gt;CASSANDRA-7120&lt;/del&gt;&lt;/a&gt; solution and copy the whole metadata instead.&lt;/p&gt;</comment>
                            <comment id="14163978" author="thobbs" created="Wed, 8 Oct 2014 18:55:39 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14166582" author="slebresne" created="Fri, 10 Oct 2014 09:14:12 +0000"  >&lt;p&gt;Sorry, forgot to close that but that was committed yesterday, thanks.&lt;/p&gt;</comment>
                            <comment id="14167776" author="iamaleksey" created="Fri, 10 Oct 2014 23:29:42 +0000"  >&lt;p&gt;Reopening because &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7923&quot; title=&quot;When preparing a statement, do not parse the provided string if we already have the parsed statement cached&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7923&quot;&gt;&lt;del&gt;CASSANDRA-7923&lt;/del&gt;&lt;/a&gt; exposed another issue. Since the cached Metadata object has the mutable flags EnumSet (and copy() doesn&apos;t clone it), a request with skipMetadata=true will add the flag for any future requests, even without it.&lt;/p&gt;

&lt;p&gt;And for re-prepared statements post &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7923&quot; title=&quot;When preparing a statement, do not parse the provided string if we already have the parsed statement cached&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7923&quot;&gt;&lt;del&gt;CASSANDRA-7923&lt;/del&gt;&lt;/a&gt; this means that for the second prepare after any request with skipMetadata=true, the serializer will skip serializing the columns when returning the PREPARED response to the client.&lt;/p&gt;

&lt;p&gt;One option would be to simply revert &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7923&quot; title=&quot;When preparing a statement, do not parse the provided string if we already have the parsed statement cached&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7923&quot;&gt;&lt;del&gt;CASSANDRA-7923&lt;/del&gt;&lt;/a&gt;, but since it actually affects more than just that, the proper fix, IMO is to copy the flags in Metadata#copy(). Attaching a simple patch that does that.&lt;/p&gt;</comment>
                            <comment id="14167789" author="iamaleksey" created="Fri, 10 Oct 2014 23:39:40 +0000"  >&lt;p&gt;Same is probably true for Flag.HAS_MORE_PAGES - once set, it&apos;ll never be unset, since flags are shared, w/out the patch.&lt;/p&gt;

&lt;p&gt;Not comfortable with sharing pagingState either - would prefer the initial Metadata have everything immutable/null in it, and only the Metadata returned from copy() to use mutable things.&lt;/p&gt;</comment>
                            <comment id="14167896" author="tjake" created="Sat, 11 Oct 2014 01:00:38 +0000"  >&lt;p&gt;+1 fixes the issue for me. can you include the test from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7923&quot; title=&quot;When preparing a statement, do not parse the provided string if we already have the parsed statement cached&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7923&quot;&gt;&lt;del&gt;CASSANDRA-7923&lt;/del&gt;&lt;/a&gt; I added on commit?&lt;/p&gt;</comment>
                            <comment id="14169297" author="slebresne" created="Mon, 13 Oct 2014 13:40:19 +0000"  >&lt;p&gt;I agree that not copying the flags is an overside of the initial patch, though I&apos;d really put the flag copying in the &lt;tt&gt;copy&lt;/tt&gt; method. But aside that, +1.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;would prefer the initial Metadata have everything immutable/null in it, and only the Metadata returned from copy() to use mutable things&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s why my initial idea in went withCASSANDRA-7120 was to make Metadata basically immutable and copy to do changes, but it forces to do more copy than necessary and required a couple other chances. I don&apos;t mind terribly tbh.&lt;/p&gt;</comment>
                            <comment id="14170013" author="iamaleksey" created="Mon, 13 Oct 2014 21:27:40 +0000"  >&lt;p&gt;Pushed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/63cb95e012ae3cc197b42b9aa881f905449437b1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/63cb95e012ae3cc197b42b9aa881f905449437b1&lt;/a&gt; to 2.1 and trunk, because it started to become annoying for some stress users. Same issue still persists in 2.0, so not closing the ticket until that one is fixed as well (I&apos;ll work on a fix).&lt;/p&gt;</comment>
                            <comment id="14174901" author="slebresne" created="Fri, 17 Oct 2014 09:59:23 +0000"  >&lt;p&gt;I don&apos;t think that&apos;s an issue with 2.0 because there we create a new Metadata instance every time we construct a new ResultSet (so there is no sharing of anything except for the names, and those are never modified in 2.0).&lt;/p&gt;</comment>
                            <comment id="14174922" author="iamaleksey" created="Fri, 17 Oct 2014 10:38:55 +0000"  >&lt;p&gt;True. Removing 2.0.11 fixver and resolving, then. A cleaner fix can wait so long as everything works.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12672831" name="8054-2.1.txt" size="826" author="mpenick" created="Fri, 3 Oct 2014 20:15:25 +0000"/>
                            <attachment id="12674300" name="8054-fix.txt" size="640" author="aleksey" created="Fri, 10 Oct 2014 23:30:52 +0000"/>
                            <attachment id="12673073" name="8054-v2.txt" size="5618" author="slebresne" created="Mon, 6 Oct 2014 10:00:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 5 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20s8f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>