<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:02:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11390] Too big MerkleTrees allocated during repair</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11390</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5220&quot; title=&quot;Repair improvements when using vnodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5220&quot;&gt;&lt;del&gt;CASSANDRA-5220&lt;/del&gt;&lt;/a&gt; we create one merkle tree per range, but each of those trees is allocated to hold all the keys on the node, taking up too much memory&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12952053">CASSANDRA-11390</key>
            <summary>Too big MerkleTrees allocated during repair</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Mar 2016 14:43:00 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:39 +0000</updated>
                            <resolved>Wed, 23 Mar 2016 14:02:50 +0000</resolved>
                                        <fixVersion>3.0.5</fixVersion>
                    <fixVersion>3.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15204371" author="krummas" created="Mon, 21 Mar 2016 14:45:39 +0000"  >&lt;p&gt;patch here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/merkletree&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/merkletree&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;tests:&lt;br/&gt;
&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-merkletree-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-merkletree-dtest/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-merkletree-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-merkletree-testall/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Can you review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=molsson&quot; class=&quot;user-hover&quot; rel=&quot;molsson&quot;&gt;molsson&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15206074" author="molsson" created="Tue, 22 Mar 2016 09:39:22 +0000"  >&lt;p&gt;Sure! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;ve taken a glance at the patch and it looks good and should reduce the merkle tree memory usage in most cases. However I&apos;m worried that we still might be able to get into a situation where we allocate too much memory for the merkle trees since we have a max depth of &lt;tt&gt;20&lt;/tt&gt; which was used as max when there was only one merkle tree. Due to the fact that we have a variable number of concurrently repairing ranges it would probably be ineffective to simply lower the max depth since that would reduce the resolution of the merkle trees when we are repairing a fewer number of ranges. Instead we could calculate the max depth each time. The number of nodes in a merkle tree is roughly &lt;tt&gt;2^d&lt;/tt&gt; where &lt;tt&gt;d&lt;/tt&gt; is the depth of the tree and before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5220&quot; title=&quot;Repair improvements when using vnodes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5220&quot;&gt;&lt;del&gt;CASSANDRA-5220&lt;/del&gt;&lt;/a&gt; the max number of nodes were &lt;tt&gt;2^20 = 1048576&lt;/tt&gt;. If we want &lt;tt&gt;2^20&lt;/tt&gt; to be the max total number of nodes then &lt;tt&gt;ranges * 2^d&lt;/tt&gt; would have to be less than &lt;tt&gt;2^20&lt;/tt&gt; which we could calculate as:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2^20 &amp;gt;= ranges * 2^d
&amp;lt;=&amp;gt;
log2(2^20) &amp;gt;= log2(ranges * 2^d)
&amp;lt;=&amp;gt;
20 &amp;gt;= log2(ranges) + d
&amp;lt;=&amp;gt;
d &amp;lt;= 20 - log2(ranges)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In java:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxDepth = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.floor(20 - &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.log(validator.desc.ranges.size()) / &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.log(2));
&lt;span class=&quot;code-comment&quot;&gt;// And then calculate the depth using:
&lt;/span&gt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; depth = numPartitions &amp;gt; 0 ? (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.floor(&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.log(numPartitions)), maxDepth) : 0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;p&gt;Another thing that also could reduce the merkle tree sizes is if we are able to estimate how much overlap there is between sstables for each range, since that could be used to reduce the estimated number of partitions. The effectiveness of this would probably depend on the compaction strategy and how accurately we can calculate the range overlap though.&lt;/p&gt;</comment>
                            <comment id="15206153" author="krummas" created="Tue, 22 Mar 2016 10:45:57 +0000"  >&lt;p&gt;This assumes all ranges contain equally many keys, so this could create too deep trees for small ranges and then not deep enough for the big ranges. Maybe we should factor in how many % of the keys are in a given range?&lt;/p&gt;

&lt;p&gt;Say the current range is responsible for 10% of the total number of partitions, it should then be allowed to allocate at most &lt;tt&gt;0.1 * 2^20&lt;/tt&gt; merkle tree nodes?&lt;/p&gt;</comment>
                            <comment id="15206315" author="molsson" created="Tue, 22 Mar 2016 13:10:51 +0000"  >&lt;p&gt;Good point, the % responsibility should probably be in the calculation. So instead it could be:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2^d &amp;lt; percent * 2^20
&amp;lt;=&amp;gt;
d &amp;lt; log2(percent * 2^20)
&amp;lt;=&amp;gt;
d &amp;lt; log2(percent) + 20
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Where &lt;tt&gt;log2&amp;#40;percent)&lt;/tt&gt; would be negative for each value such as &lt;tt&gt;0.0 &amp;lt; percent &amp;lt; 1.0&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Or in java:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; maxDepth = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.floor(20 + &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.log(percent) / &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.log(2));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using this I&apos;d say there are two options, either we base the percentage on the range sizes or on the estimated partitions for each range. Both would require us to iterate through all ranges once before estimating the depth for each tree, but using the estimated partition count would probably be more effective.&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;p&gt;Another thing we should consider is if the total limit should be &lt;tt&gt;2^20&lt;/tt&gt;. Before vnodes this was used for a single token range and after vnodes it was instead &lt;tt&gt;vnodes * 2^20&lt;/tt&gt; per node. This gave us a much higher resolution in the merkle trees with vnodes. If we divide &lt;tt&gt;2^20&lt;/tt&gt; between all ranges we go back to the pre-vnode merkle tree resolution for each node (possibly lower).&lt;/p&gt;</comment>
                            <comment id="15206413" author="krummas" created="Tue, 22 Mar 2016 14:08:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;Another thing we should consider is if the total limit should be 2^20&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I imagine this is what was always intended - perhaps we should open a new ticket to investigate if we should increase it&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;if we are able to estimate how much overlap there is between sstables for each range&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I pushed 2 new commits, one that calculates maxDepth and one that uses SSTableReader.estimateCompactionGain to calculate how much we expect to gain from a compaction of the given sstables. Note that we don&apos;t care about the ranges when we calculate this, so we have to assume that gain within a range is the same as the total gain. Biggest problem is how to test this, will try to figure something out.&lt;/p&gt;</comment>
                            <comment id="15206714" author="molsson" created="Tue, 22 Mar 2016 16:27:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;I imagine this is what was always intended - perhaps we should open a new ticket to investigate if we should increase it&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It would probably be good to test if it&apos;s a reasonable limit, but it might not have that high priority unless we see lots of over-streaming from the current one.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Note that we don&apos;t care about the ranges when we calculate this, so we have to assume that gain within a range is the same as the total gain. Biggest problem is how to test this, will try to figure something out.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If it gets too complex to the test it might not be worth to have the compaction gain as part of the calculation. It would most probably reduce the MerkleTrees sizes, which is good unless the compaction gain comes from data that is not part of the repair. Capping the MerkleTrees total size might be good enough alone since the only thing the duplicate partitions should bring is unnecessarily large resolution, not the memory problems. It could possibly be a separate ticket to investigate if there would be a gain from using the compaction gain in the calculation.&lt;/p&gt;

&lt;p&gt;&amp;#8212;&lt;/p&gt;

&lt;p&gt;For:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;logger.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Created {} merkle trees, {} partitions, {} bytes&quot;&lt;/span&gt;, tree.size(), allPartitions, MerkleTrees.serializer.serializedSize(tree, 0));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The &lt;tt&gt;MerkleTrees.size()&lt;/tt&gt; method returns the combined value from calling &lt;tt&gt;MerkleTree.size()&lt;/tt&gt; on all MerkleTrees, which returns &lt;tt&gt;2^d&lt;/tt&gt;. To get the number of merkle trees we could either create a new method in &lt;tt&gt;MerkleTrees&lt;/tt&gt; (treeCount()?) or use &lt;tt&gt;MerkleTrees.ranges().size()&lt;/tt&gt;. It could probably be good to have both the number of trees as well as the output from &lt;tt&gt;MerkleTrees.size()&lt;/tt&gt; in the log output.&lt;/p&gt;

&lt;p&gt;Other than that LGTM. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15208022" author="krummas" created="Wed, 23 Mar 2016 07:47:19 +0000"  >&lt;p&gt;agreed, lets create a new ticket where we evaluate if we want to include the compaction gain factor when estimating the trees (and maybe increase the maxDepth)&lt;/p&gt;

&lt;p&gt;pushed a commit with log fixes (moved the logging to debug) and triggered new builds&lt;/p&gt;</comment>
                            <comment id="15208412" author="molsson" created="Wed, 23 Mar 2016 13:43:00 +0000"  >&lt;p&gt;There is a comment in the doValidationCompaction() log message saying&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// MT serialize may take time&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Which should probably be moved to createMerkleTrees() log message instead or removed, whichever you prefer.&lt;/p&gt;

&lt;p&gt;After that +1 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15208439" author="krummas" created="Wed, 23 Mar 2016 14:02:50 +0000"  >&lt;p&gt;committed with comment moved, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 34 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2uykn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>molsson</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[molsson]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>