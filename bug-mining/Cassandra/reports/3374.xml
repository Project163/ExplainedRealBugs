<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8683] Ensure early reopening has no overlap with replaced files</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8683</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When introducing &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6916&quot; title=&quot;Preemptive opening of compaction result&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6916&quot;&gt;&lt;del&gt;CASSANDRA-6916&lt;/del&gt;&lt;/a&gt; we permitted the early opened files to overlap with the files they were replacing by one DecoratedKey, as this permitted a few minor simplifications. Unfortunately this breaks assumptions in LeveledCompactionScanner, that are causing the intermittent unit test failures: &lt;a href=&quot;http://cassci.datastax.com/job/trunk_utest/1330/testReport/junit/org.apache.cassandra.db.compaction/LeveledCompactionStrategyTest/testValidationMultipleSSTablePerLevel/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/trunk_utest/1330/testReport/junit/org.apache.cassandra.db.compaction/LeveledCompactionStrategyTest/testValidationMultipleSSTablePerLevel/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This patch by itself does not fix the bug, but fixes the described aspect of it, by ensuring the replaced and replacing files never overlap. This is achieved first by always selecting the replaced file start as the next key present in the file greater than the last key in the new file(s).  If there is no such key, however, there is no data to return for the reader, but to permit abort and atomic replacement at the end of a macro compaction action, we must keep the file in the DataTracker for replacement purposes, but not return it to consumers (esp. as many assume a non-empty range). For this I have introduced a new OpenReason called SHADOWED, and a DataTracker.View.shadowed collection of sstables, that tracks those we still consider to be in the live set, but from which we no longer answer any queries.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8744&quot; title=&quot;Ensure SSTableReader.first/last are honoured universally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8744&quot;&gt;&lt;del&gt;CASSANDRA-8744&lt;/del&gt;&lt;/a&gt; (and then &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8750&quot; title=&quot;Ensure SSTableReader.last corresponds exactly with the file end&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8750&quot;&gt;&lt;del&gt;CASSANDRA-8750&lt;/del&gt;&lt;/a&gt;) then ensures that these bounds are honoured, so that we never break the assumption that files in LCS never overlap.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12770094">CASSANDRA-8683</key>
            <summary>Ensure early reopening has no overlap with replaced files</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 26 Jan 2015 14:17:56 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:22 +0000</updated>
                            <resolved>Wed, 11 Feb 2015 15:33:14 +0000</resolved>
                                        <fixVersion>2.1.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14291865" author="krummas" created="Mon, 26 Jan 2015 14:18:37 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14291873" author="benedict" created="Mon, 26 Jan 2015 14:25:24 +0000"  >&lt;p&gt;I&apos;m a little confused by the description: if it holds a reference, it shouldn&apos;t delete the file. Is it possible it&apos;s releasing its reference early somehow?&lt;/p&gt;</comment>
                            <comment id="14291895" author="krummas" created="Mon, 26 Jan 2015 14:39:53 +0000"  >&lt;p&gt;from irc:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;15:27 &amp;lt; marcuse&amp;gt; belliottsmith: we create a new sstable reader over the same file, the reference counter is not transfered to the new file, so if i bump the reference count on the file i hold a reference to, it will not affect the latest one
15:27 &amp;lt; marcuse&amp;gt; does it make sense/
15:27 &amp;lt; marcuse&amp;gt; * transfered to the new SSTR instance
15:28 &amp;lt; belliottsmith&amp;gt; but you should have taken a reference against the one you&apos;re using, no?
15:28 &amp;lt; marcuse&amp;gt; belliottsmith: no, we don&apos;t want to hold references during the whole duration of the repair (hours)
15:28 &amp;lt; belliottsmith&amp;gt; each instance is distinct, but so long as you take a reference against the one you&apos;re using, it shouldn&apos;t be a problem...
15:28 &amp;lt; marcuse&amp;gt; so, if a file is gone, we simply remove it from the set and dont anticompact it
15:29 &amp;lt; belliottsmith&amp;gt; ah
15:29 &amp;lt; belliottsmith&amp;gt; hmm. that is tricky, since we need to repeatedly refetch the set of files we want to use, since we could have new data replacing it as well, surely?
15:30 &amp;lt; belliottsmith&amp;gt; i don&apos;t really see a way around holding a reference for the lifetime of the repair. but if we stream oldest files first we can drop references to them as we go, no&amp;gt;?
15:30 &amp;lt; marcuse&amp;gt; no, for incremental repairs we repair best-effort, if a file is gone, it means it has been compacted away and will get repaired next time around
15:31 &amp;lt; belliottsmith&amp;gt; so where/when do we grab our reference to the sstable then?
15:31 &amp;lt; belliottsmith&amp;gt; because in that case it sounds like we should simply be failing to grab our reference count
15:31 &amp;lt; marcuse&amp;gt; https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/ActiveRepairService.java#L409
15:32 &amp;lt; marcuse&amp;gt; and yes, we probably should fail, but we don&apos;t
15:32 &amp;lt; belliottsmith&amp;gt; that code looks a bit odd. why do we check for data component first? shouldn&apos;t an attempt to acquire the ref be sufficient? (clearly it isn&apos;t here though, since it&apos;s not removing it from the set)
15:33 &amp;lt; marcuse&amp;gt; yes, it should, but i don&apos;t think we decrease ref count when we replace an instance?
15:34 &amp;lt; marcuse&amp;gt; ie, when we open early and have a new instance, we should decrease the reference on the old file
15:34 &amp;lt; marcuse&amp;gt; *old instance\
15:34 &amp;lt; belliottsmith&amp;gt; we have to
15:34 &amp;lt; belliottsmith&amp;gt; otherwise it would never get deleted
15:34 &amp;lt; marcuse&amp;gt; but its the same underlying file right? it will get deleted by the new instance
15:34 &amp;lt; belliottsmith&amp;gt; if we don&apos;t that&apos;s definitely a bug, but i&apos;m pretty sure we do
15:34 &amp;lt; belliottsmith&amp;gt; but lifetimes don&apos;t expire in order necessarily
15:35 &amp;lt; belliottsmith&amp;gt; so the older files ref count to zero, then remove themselves from the linked-list of replacements
15:35 &amp;lt; belliottsmith&amp;gt; if there&apos;s nobody left, they delete the file
15:36 &amp;lt; belliottsmith&amp;gt; this all is in dire need of cleaning up in 8568
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14291991" author="aboudreault" created="Mon, 26 Jan 2015 16:02:24 +0000"  >&lt;p&gt;related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8366&quot; title=&quot;Repair grows data on nodes, causes load to become unbalanced&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8366&quot;&gt;&lt;del&gt;CASSANDRA-8366&lt;/del&gt;&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="14293292" author="krummas" created="Tue, 27 Jan 2015 10:19:04 +0000"  >&lt;p&gt;I was wrong, the files do still exist&lt;/p&gt;

&lt;p&gt;problem is in getPositionsForRanges - if last token is the actual last token in the file (with early opening, it might not be), getPositions returns null&lt;/p&gt;

&lt;p&gt;attaching patch to fix&lt;/p&gt;</comment>
                            <comment id="14293296" author="krummas" created="Tue, 27 Jan 2015 10:20:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aboudreault&quot; class=&quot;user-hover&quot; rel=&quot;aboudreault&quot;&gt;aboudreault&lt;/a&gt; it could explain the exceptions you saw, could you rerun with the patch?&lt;/p&gt;</comment>
                            <comment id="14293410" author="benedict" created="Tue, 27 Jan 2015 12:09:21 +0000"  >&lt;p&gt;I think this might still not be quite right, but we&apos;re on the right track. This also highlights another bug (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8691&quot; title=&quot;SSTableReader.getPosition() does not correctly filter out queries that exceed its bounds&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8691&quot;&gt;&lt;del&gt;CASSANDRA-8691&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I suspect it may be the mistake that we are passing in .getToken().maxKeyBound() to getPosition - it could be we are looking up a value beyond that present in the index, because there are multiple adjacent keys with the same token, and we are looking past all of them.&lt;/p&gt;

&lt;p&gt;That said, if we fix &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8691&quot; title=&quot;SSTableReader.getPosition() does not correctly filter out queries that exceed its bounds&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8691&quot;&gt;&lt;del&gt;CASSANDRA-8691&lt;/del&gt;&lt;/a&gt; we will need to do something about the last index position. There are two possibilities: 1) Like suggested a while back, we could simply ignore the last record for purposes of getPositionsForRanges(), since our paired source file will contain the row. Or 2) during index construction we could perhaps retain a lookup of the records immediately following an index boundary, for the past few boundaries only. We could then use this as our last key instead. I&apos;m not sure which I prefer, as 1) creates some risk it will not be accounted for in future; 2) creates some unnecessary complexity.&lt;/p&gt;</comment>
                            <comment id="14293426" author="benedict" created="Tue, 27 Jan 2015 12:24:40 +0000"  >&lt;p&gt;I am struggling to reproduce this test locally, but by spinning on it I have produced:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] Testcase: testValidationMultipleSSTablePerLevel(org.apache.cassandra.db.compaction.LeveledCompactionStrategyTest):  Caused an ERROR
    [junit] java.lang.AssertionError: Memory was freed
    [junit] java.util.concurrent.ExecutionException: java.lang.AssertionError: Memory was freed
    [junit]     at java.util.concurrent.FutureTask.report(FutureTask.java:122)
    [junit]     at java.util.concurrent.FutureTask.get(FutureTask.java:188)
    [junit]     at org.apache.cassandra.db.compaction.LeveledCompactionStrategyTest.testValidationMultipleSSTablePerLevel(LeveledCompactionStrategyTest.java:184)
    [junit] Caused by: java.lang.AssertionError: Memory was freed
    [junit]     at org.apache.cassandra.io.util.Memory.checkPosition(Memory.java:281)
    [junit]     at org.apache.cassandra.io.util.Memory.getInt(Memory.java:233)
    [junit]     at org.apache.cassandra.io.sstable.IndexSummary.getPositionInSummary(IndexSummary.java:118)
    [junit]     at org.apache.cassandra.io.sstable.IndexSummary.getKey(IndexSummary.java:123)
    [junit]     at org.apache.cassandra.io.sstable.format.SSTableReader$9$1.next(SSTableReader.java:1249)
    [junit]     at org.apache.cassandra.io.sstable.format.SSTableReader$9$1.next(SSTableReader.java:1226)
    [junit]     at com.google.common.collect.Iterators$5.next(Iterators.java:553)
    [junit]     at org.apache.cassandra.repair.Validator.prepare(Validator.java:89)
    [junit]     at org.apache.cassandra.db.compaction.CompactionManager.doValidationCompaction(CompactionManager.java:1007)
    [junit]     at org.apache.cassandra.db.compaction.CompactionManager.access$600(CompactionManager.java:95)
    [junit]     at org.apache.cassandra.db.compaction.CompactionManager$9.call(CompactionManager.java:591)
    [junit]     at java.util.concurrent.FutureTask.run(FutureTask.java:262)
    [junit]     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
    [junit]     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
    [junit]     at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which may or may not be related, but is certainly problematic.&lt;/p&gt;</comment>
                            <comment id="14293442" author="benedict" created="Tue, 27 Jan 2015 12:42:31 +0000"  >&lt;p&gt;So I introduced the following code to the end of getPosition:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; op == SSTableReader.Operator.EQ;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (updateCacheAndStats)
            bloomFilterTracker.addFalsePositive();
        Tracing.trace(&lt;span class=&quot;code-quote&quot;&gt;&quot;Partition index lookup complete (bloom filter &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; positive) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sstable {}&quot;&lt;/span&gt;, descriptor.generation);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and this resulted in the following output (after enough runs):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] Testcase: testValidationMultipleSSTablePerLevel(org.apache.cassandra.db.compaction.LeveledCompactionStrategyTest):  Caused an ERROR
    [junit] java.lang.AssertionError
    [junit] java.util.concurrent.ExecutionException: java.lang.AssertionError
    [junit]     at java.util.concurrent.FutureTask.report(FutureTask.java:122)
    [junit]     at java.util.concurrent.FutureTask.get(FutureTask.java:188)
    [junit]     at org.apache.cassandra.db.compaction.LeveledCompactionStrategyTest.testValidationMultipleSSTablePerLevel(LeveledCompactionStrategyTest.java:184)
    [junit] Caused by: java.lang.AssertionError
    [junit]     at org.apache.cassandra.io.sstable.format.big.BigTableReader.getPosition(BigTableReader.java:243)
    [junit]     at org.apache.cassandra.io.sstable.format.SSTableReader.getPosition(SSTableReader.java:1355)
    [junit]     at org.apache.cassandra.io.sstable.format.SSTableReader.getPositionsForRanges(SSTableReader.java:1282)
    [junit]     at org.apache.cassandra.io.sstable.format.big.BigTableScanner.getScanner(BigTableScanner.java:67)
    [junit]     at org.apache.cassandra.io.sstable.format.big.BigTableReader.getScanner(BigTableReader.java:101)
    [junit]     at org.apache.cassandra.io.sstable.format.SSTableReader.getScanner(SSTableReader.java:1538)
    [junit]     at org.apache.cassandra.db.compaction.LeveledCompactionStrategy$LeveledScanner.&amp;lt;init&amp;gt;(LeveledCompactionStrategy.java:318)
    [junit]     at org.apache.cassandra.db.compaction.LeveledCompactionStrategy.getScanners(LeveledCompactionStrategy.java:245)
    [junit]     at org.apache.cassandra.db.compaction.WrappingCompactionStrategy.getScanners(WrappingCompactionStrategy.java:357)
    [junit]     at org.apache.cassandra.db.compaction.CompactionManager.doValidationCompaction(CompactionManager.java:999)
    [junit]     at org.apache.cassandra.db.compaction.CompactionManager.access$600(CompactionManager.java:95)
    [junit]     at org.apache.cassandra.db.compaction.CompactionManager$9.call(CompactionManager.java:591)
    [junit]     at java.util.concurrent.FutureTask.run(FutureTask.java:262)
    [junit]     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
    [junit]     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
    [junit]     at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which suggests that it is indeed that we&apos;re skipping over the entire contents of our index page. However this may have nothing to do with the getToken().maxKeyBound() business, since that would likely be deterministic (although this is likely also a bug). It&apos;s possible that the memory being freed is happening at the right timing interval to give us a bad binary search result, though. This seems a little unlikely, but &lt;em&gt;is&lt;/em&gt; possible, so I suggest we get 7705 finished and running so we can see nail down the early release of memory, and then continue our investigations here.&lt;/p&gt;</comment>
                            <comment id="14293446" author="krummas" created="Tue, 27 Jan 2015 12:46:39 +0000"  >&lt;p&gt;When I debugged this, the reason that we fell through all the way to that &quot;return null&quot; was that the index only contained the last key, then we were at EOF and ended the loop&lt;/p&gt;</comment>
                            <comment id="14293452" author="benedict" created="Tue, 27 Jan 2015 12:55:56 +0000"  >&lt;p&gt;But reaching there is a different bug, especially if opened early. We explicitly leave an entire index summary page (and hence effective interval of index) distance between the &quot;last&quot; token and where we&apos;ve written to, so that we have room to scan past if necessary.&lt;/p&gt;</comment>
                            <comment id="14303307" author="aboudreault" created="Tue, 3 Feb 2015 14:13:04 +0000"  >&lt;p&gt;I tried this patch to see if this issue was affecting &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8316&quot; title=&quot;&amp;quot;Did not get positive replies from all endpoints&amp;quot; error on incremental repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8316&quot;&gt;&lt;del&gt;CASSANDRA-8316&lt;/del&gt;&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8366&quot; title=&quot;Repair grows data on nodes, causes load to become unbalanced&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8366&quot;&gt;&lt;del&gt;CASSANDRA-8366&lt;/del&gt;&lt;/a&gt;, but apparently no. The result of these two issues are the same.&lt;/p&gt;</comment>
                            <comment id="14303309" author="benedict" created="Tue, 3 Feb 2015 14:15:15 +0000"  >&lt;p&gt;That patch is for the prior description of the ticket. I will be posting a new patch this afternoon.&lt;/p&gt;</comment>
                            <comment id="14307797" author="benedict" created="Thu, 5 Feb 2015 19:15:36 +0000"  >&lt;p&gt;Patch available &lt;a href=&quot;https://github.com/belliottsmith/cassandra/commits/8683&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14311929" author="krummas" created="Mon, 9 Feb 2015 08:42:07 +0000"  >&lt;p&gt;could you update the description of the ticket and describe how the patch fixes it?&lt;/p&gt;</comment>
                            <comment id="14312278" author="krummas" created="Mon, 9 Feb 2015 14:32:05 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;small nit, remove unused DataTracker.View#newSSTables()&lt;/p&gt;

&lt;p&gt;This actually creates more overlap in LCS since it tracks the sstables in the manifest, but this works since 1) we use the datatracker sstables when creating the scanners and 2) all the sstables involved are marked compacting. Edit: or, it doesn&apos;t since we don&apos;t notify compaction strategies about early opened files, but that only makes everything more confusing&lt;/p&gt;

&lt;p&gt;The problem (which already exists) is that it makes it a pita to reason about possible future overlaps when creating compaction candidates (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8739&quot; title=&quot;Don&amp;#39;t check for overlap with sstables that have had their start positions moved in LCS&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8739&quot;&gt;&lt;del&gt;CASSANDRA-8739&lt;/del&gt;&lt;/a&gt;). I will create a ticket that simplifies that&lt;/p&gt;</comment>
                            <comment id="14312292" author="aboudreault" created="Mon, 9 Feb 2015 14:43:00 +0000"  >&lt;p&gt;I&apos;m currently running a few tests on this patch. Should be done soon.&lt;/p&gt;</comment>
                            <comment id="14312295" author="benedict" created="Mon, 9 Feb 2015 14:45:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;Edit: or, it doesn&apos;t since we don&apos;t notify compaction strategies about early opened files, but that only makes everything more confusing&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed this is confusing. As part of cleaning up the whole pig we&apos;ve been trying to put lipstick on for a while, we should consider if there&apos;s a better approach in general to keeping compaction strategies up-to-date than these notification listeners, because they are also not kept atomically in sync with the DataTracker.View. It&apos;s difficult to reason about to even determine if this is ever a problem.&lt;/p&gt;</comment>
                            <comment id="14312407" author="aboudreault" created="Mon, 9 Feb 2015 16:24:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; When using your branch, I&apos;m getting this message when running my tests and doing a cleanup:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Aborted cleaning up atleast one column family in keyspace r1, check server logs &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more information.
Aborted cleaning up atleast one column family in keyspace r1, check server logs &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more information.
Aborted cleaning up atleast one column family in keyspace r1, check server logs &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more information.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I can&apos;t get this outside of your branch. I&apos;m not sure if this is an error or something expected with your changes. There are no errors in the logs. I only see this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WARN  [RMI TCP Connection(24)-127.0.0.1] 2015-02-09 10:56:10,282 ColumnFamilyStore.java:2587 - Unable to cancel in-progress compactions &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; standard1.  Perhaps there is an unusually large row in progress somewhere, or the system is simply overloaded.
INFO  [RMI TCP Connection(24)-127.0.0.1] 2015-02-09 10:56:10,282 CompactionManager.java:255 - Aborting operation on r1.standard1 after failing to interrupt other compaction operations
INFO  [RMI TCP Connection(24)-127.0.0.1] 2015-02-09 10:56:10,282 CompactionManager.java:260 - No sstables &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; r1.Counter3
INFO  [RMI TCP Connection(24)-127.0.0.1] 2015-02-09 10:56:10,285 CompactionManager.java:260 - No sstables &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; system_traces.sessions
INFO  [RMI TCP Connection(24)-127.0.0.1] 2015-02-09 10:56:10,285 CompactionManager.java:260 - No sstables &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; system_traces.events
WARN  [RMI TCP Connection(27)-127.0.0.1] 2015-02-09 10:59:13,550 ColumnFamilyStore.java:2587 - Unable to cancel in-progress compactions &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; standard1.  Perhaps there is an unusually large row in progress somewhere, or the system is simply overloaded.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Any hint about this? Should I go further in the issue and produce a minimal test case to reproduce this message?&lt;/p&gt;</comment>
                            <comment id="14312469" author="benedict" created="Mon, 9 Feb 2015 17:01:45 +0000"  >&lt;p&gt;Could you attach the whole of the log file? And the test you&apos;re running?&lt;/p&gt;</comment>
                            <comment id="14312508" author="aboudreault" created="Mon, 9 Feb 2015 17:31:09 +0000"  >&lt;p&gt;The test I am running is testv2.sh from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8366&quot; title=&quot;Repair grows data on nodes, causes load to become unbalanced&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8366&quot;&gt;&lt;del&gt;CASSANDRA-8366&lt;/del&gt;&lt;/a&gt;. Currently running it with DEBUG log enabled. I will attach when finish.&lt;/p&gt;</comment>
                            <comment id="14312847" author="aboudreault" created="Mon, 9 Feb 2015 20:44:10 +0000"  >&lt;p&gt;Here is the last part of the system.log with TRACE enabled.&lt;/p&gt;</comment>
                            <comment id="14314155" author="benedict" created="Tue, 10 Feb 2015 13:14:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aboudrealt&quot; class=&quot;user-hover&quot; rel=&quot;aboudrealt&quot;&gt;aboudrealt&lt;/a&gt; do you have an easier reproduction test by any chance? couldn&apos;t get that test to run on my box, and besides it&apos;s a difficult one to debug. I tried running a basic test to see if there were any obvious screwups and didn&apos;t see it.&lt;/p&gt;</comment>
                            <comment id="14314246" author="aboudreault" created="Tue, 10 Feb 2015 14:42:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Can you try this simple one and let me know if you can reproduce the issue. I do see the message on each run.&lt;/p&gt;</comment>
                            <comment id="14314256" author="aboudreault" created="Tue, 10 Feb 2015 14:52:23 +0000"  >&lt;p&gt;If you can rebase your branch with latest 2.1, I can retry it too. &lt;/p&gt;</comment>
                            <comment id="14315246" author="benedict" created="Wed, 11 Feb 2015 00:17:05 +0000"  >&lt;p&gt;I&apos;ve pushed a version rebased against the new &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8707&quot; title=&quot;Move SegmentedFile, IndexSummary and BloomFilter to utilising RefCounted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8707&quot;&gt;&lt;del&gt;CASSANDRA-8707&lt;/del&gt;&lt;/a&gt; patch that should fix this.&lt;/p&gt;</comment>
                            <comment id="14316487" author="aboudreault" created="Wed, 11 Feb 2015 16:35:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Great, I confirm the change you pushed fix the issue I was seeing. Thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="12770332">CASSANDRA-8691</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12772693">CASSANDRA-8744</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12770332">CASSANDRA-8691</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12703231">CASSANDRA-6916</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12694760" name="0001-avoid-NPE-in-getPositionsForRanges.patch" size="2180" author="marcuse" created="Tue, 27 Jan 2015 10:19:04 +0000"/>
                            <attachment id="12697562" name="system.log" size="7912185" author="aboudreault" created="Mon, 9 Feb 2015 20:44:10 +0000"/>
                            <attachment id="12697790" name="test.sh" size="248" author="aboudreault" created="Tue, 10 Feb 2015 14:42:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i24su7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aboudreault</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>