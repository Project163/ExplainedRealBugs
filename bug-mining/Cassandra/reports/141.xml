<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:11:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-418] SSTable generation clash during compaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-418</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We found that one of our node started getting timeouts for get_slice.  Looking further we found that the CFS.ssTables_ references a SStable doesn&apos;t exist on the file system.&lt;/p&gt;

&lt;p&gt;Walking down the log we see that the sstable in question 6038 is being compacted onto itself (in terms of filename file wise it is written to -tmp):&lt;br/&gt;
system.log.2009-09-01: INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;MINOR-COMPACTION-POOL:1&amp;#93;&lt;/span&gt; 2009-09-01 23:50:07,553 ColumnFamilyStore.java (line 1067) Compacting &lt;br/&gt;
[/mnt/var/cassandra/data/Digg/FriendActions-6037-Data.db,/mnt/var/cassandra/data/Digg/FriendActions-6038-Data.db,/mnt/var/cassandra/data/Digg/&lt;br/&gt;
FriendActions-6040-Data.db,/mnt/var/cassandra/data/Digg/FriendActions-6042-Data.db]&lt;br/&gt;
system.log.2009-09-01: INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;MINOR-COMPACTION-POOL:1&amp;#93;&lt;/span&gt; 2009-09-01 23:51:43,727 ColumnFamilyStore.java (line 1209) Compacted to&lt;br/&gt;
/mnt/var/cassandra/data/Digg/FriendActions-6038-Data.db.  0/1010269806 bytes for 9482/9373 keys read/written.  Time: 96173ms.&lt;/p&gt;

&lt;p&gt;It appears the generation number is generated by looking at the lowest number in the list of files to be compacted and adding 1.  In this scenario it is 6037+1=6038.&lt;br/&gt;
The code in CFS.doFileCompaction will remove the key and add the key back and remove the key again, hence the error we were seeing.&lt;/p&gt;

&lt;p&gt;Should the generation number be generated via another way or should we update doFileCompaction to be smarter?&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12434696">CASSANDRA-418</key>
            <summary>SSTable generation clash during compaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="sammy.yu">Sammy Yu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Sep 2009 01:51:12 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:34 +0000</updated>
                            <resolved>Mon, 7 Sep 2009 14:50:56 +0000</resolved>
                                        <fixVersion>0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12750785" author="jbellis" created="Thu, 3 Sep 2009 02:09:05 +0000"  >&lt;p&gt;the compaction code relies on the bucketizer to keep files of the same compaction-count (a bucket of sstables that have been compacted twice, one of sstables that have been compacted 3 times) so that you are never compacting sstables of consecutive generations &amp;#8211; all will have even numbers, or all odd.  something has broken that invariant.&lt;/p&gt;

&lt;p&gt;rather than try to band-aid the bucketizer i think making the generation-generator more robust is the way to go.  this seems like a flimsy property to try to preserve.&lt;/p&gt;

&lt;p&gt;my vote would be to simplify: just pick the next monotonically increasing int any time we need a new tmp sstable file, whether for flush, compaction, or bootstrap.  I.e. via CFS.getTempSSTableFileName, without the extra increment.&lt;/p&gt;

&lt;p&gt;the reason historically that FB tried to be fancy is, they were trying to optimize away reading older sstables at all if the data being queried was found in a newer one.  the &quot;only new sstables get a number from the atomic int, and the compactions fit in between&quot; was to preserve this.  (then you sort on the generation number and higher ones are always newer.)&lt;/p&gt;

&lt;p&gt;but that can&apos;t work (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-223&quot; title=&quot;time-based slicing does not work correctly w/ &amp;quot;historical&amp;quot; memtables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-223&quot;&gt;&lt;del&gt;CASSANDRA-223&lt;/del&gt;&lt;/a&gt;) so we always do a full merge across all sstables now.  so we can simplify this safely.&lt;/p&gt;</comment>
                            <comment id="12750792" author="sammy.yu" created="Thu, 3 Sep 2009 02:56:34 +0000"  >&lt;p&gt;Use monotonically increase generation number for newly compacted sstable.&lt;/p&gt;</comment>
                            <comment id="12750793" author="lenn0x" created="Thu, 3 Sep 2009 02:57:03 +0000"  >&lt;p&gt;A note on the ML might be needed, with this bug it looks like we are going to have to dump our old data and re-import since we don&apos;t have a 100% way of figuring out what data is missing across the cluster.&lt;/p&gt;</comment>
                            <comment id="12750795" author="sammy.yu" created="Thu, 3 Sep 2009 02:57:57 +0000"  >&lt;p&gt;Should we also change CFS.getTempSSTableFileName to just increment fileIndexGenerator_ once?&lt;/p&gt;</comment>
                            <comment id="12750992" author="jbellis" created="Thu, 3 Sep 2009 12:40:00 +0000"  >&lt;p&gt;&amp;gt; Should we also change CFS.getTempSSTableFileName to just increment fileIndexGenerator_ once? &lt;/p&gt;

&lt;p&gt;right, that&apos;s what i meant by &quot;w/o the extra increment.&quot;&lt;/p&gt;</comment>
                            <comment id="12751028" author="sammy.yu" created="Thu, 3 Sep 2009 13:51:03 +0000"  >&lt;p&gt;Self contained patch that now increment the generation number by one&lt;/p&gt;</comment>
                            <comment id="12751049" author="jbellis" created="Thu, 3 Sep 2009 15:04:33 +0000"  >&lt;p&gt;(also affects version 0.3 for the record)&lt;/p&gt;</comment>
                            <comment id="12751050" author="jbellis" created="Thu, 3 Sep 2009 15:11:17 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="12751479" author="jbellis" created="Fri, 4 Sep 2009 14:44:35 +0000"  >&lt;p&gt;missed some code.  this cleans up inaccurate comments and remaining double-increment code&lt;/p&gt;</comment>
                            <comment id="12751544" author="sammy.yu" created="Fri, 4 Sep 2009 17:57:27 +0000"  >&lt;p&gt;+1 looks good&lt;/p&gt;</comment>
                            <comment id="12752155" author="jbellis" created="Mon, 7 Sep 2009 14:50:56 +0000"  >&lt;p&gt;committed to 0.4 and 0.5&lt;/p&gt;</comment>
                            <comment id="12752475" author="hudson" created="Tue, 8 Sep 2009 12:35:49 +0000"  >&lt;p&gt;Integrated in Cassandra #191 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/191/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/191/&lt;/a&gt;)&lt;br/&gt;
    clean up inaccurate comments; remaining double-increment code.&lt;br/&gt;
patch by jbellis; reviewed by Sammy Yu for &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12418464" name="0001-CASSANDRA-418-Use-monotonically-increasing-generatio.patch" size="2231" author="sammy.yu" created="Thu, 3 Sep 2009 02:56:34 +0000"/>
                            <attachment id="12418515" name="0002-CASSANDRA-418-Use-monotonically-increasing-generatio.patch" size="2595" author="sammy.yu" created="Thu, 3 Sep 2009 13:51:03 +0000"/>
                            <attachment id="12418630" name="418-2.patch" size="1567" author="jbellis" created="Fri, 4 Sep 2009 14:44:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19680</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 12 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fyt3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91237</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>