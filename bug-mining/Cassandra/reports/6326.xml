<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:28:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18737] Test failure: org.apache.cassandra.io.sstable.SSTableLoaderTest (testLoadingIncompleteSSTable-.jdk17)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18737</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: Failed to list files in /tmp/1409486429862512729/SSTableLoaderTest/Standard2-57877ac036d311eea01f83fcb8f6fee5
	at org.apache.cassandra.db.lifecycle.LogAwareFileLister.list(LogAwareFileLister.java:77)
	at org.apache.cassandra.db.lifecycle.LifecycleTransaction.getFiles(LifecycleTransaction.java:626)
	at org.apache.cassandra.io.sstable.SSTableLoader.openSSTables(SSTableLoader.java:103)
	at org.apache.cassandra.io.sstable.SSTableLoader.stream(SSTableLoader.java:202)
	at org.apache.cassandra.io.sstable.SSTableLoaderTest.testLoadingIncompleteSSTable(SSTableLoaderTest.java:213)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
Caused by: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /tmp/1409486429862512729/SSTableLoaderTest/Standard2-57877ac036d311eea01f83fcb8f6fee5/nc-17-big
	at org.apache.cassandra.io.sstable.format.SSTableReaderLoadingBuilder.build(SSTableReaderLoadingBuilder.java:111)
	at org.apache.cassandra.io.sstable.format.SSTableReader.open(SSTableReader.java:397)
	at org.apache.cassandra.io.sstable.format.SSTableReader.openForBatch(SSTableReader.java:373)
	at org.apache.cassandra.io.sstable.SSTableLoader.lambda$openSSTables$0(SSTableLoader.java:152)
	at org.apache.cassandra.db.lifecycle.LogAwareFileLister.lambda$innerList$2(LogAwareFileLister.java:99)
	at java.base/java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:178)
	at java.base/java.util.TreeMap$EntrySpliterator.forEachRemaining(TreeMap.java:3287)
	at java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)
	at java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)
	at java.base/java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:921)
	at java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.base/java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:682)
	at org.apache.cassandra.db.lifecycle.LogAwareFileLister.innerList(LogAwareFileLister.java:101)
	at org.apache.cassandra.db.lifecycle.LogAwareFileLister.list(LogAwareFileLister.java:73)
Caused by: java.lang.NullPointerException
	at com.google.common.base.Preconditions.checkNotNull(Preconditions.java:903)
	at org.apache.cassandra.io.sstable.format.big.BigSSTableReaderLoadingBuilder.buildSummaryAndBloomFilter(BigSSTableReaderLoadingBuilder.java:193)
	at org.apache.cassandra.io.sstable.format.big.BigSSTableReaderLoadingBuilder.openComponents(BigSSTableReaderLoadingBuilder.java:116)
	at org.apache.cassandra.io.sstable.format.big.BigSSTableReaderLoadingBuilder.openComponents(BigSSTableReaderLoadingBuilder.java:58)
	at org.apache.cassandra.io.sstable.format.SSTableReaderLoadingBuilder.build(SSTableReaderLoadingBuilder.java:92)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Seen here: &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1174/workflows/263f1e22-e4d0-48b8-b3e2-496edb30a068/jobs/41924/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/driftx/cassandra/1174/workflows/263f1e22-e4d0-48b8-b3e2-496edb30a068/jobs/41924/tests&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13546707">CASSANDRA-18737</key>
            <summary>Test failure: org.apache.cassandra.io.sstable.SSTableLoaderTest (testLoadingIncompleteSSTable-.jdk17)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jlewandowski">Jacek Lewandowski</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Wed, 9 Aug 2023 18:01:19 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:48 +0000</updated>
                            <resolved>Mon, 25 Sep 2023 17:41:34 +0000</resolved>
                                        <fixVersion>5.0-alpha2</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Tool/bulk load</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7800">2h 10m</timespent>
                                <comments>
                            <comment id="17752521" author="mmuzaf" created="Wed, 9 Aug 2023 21:19:39 +0000"  >&lt;p&gt;I think it might be related to the following commit (but I could be wrong): &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17056&quot; title=&quot;CEP-17 &#8211; Pluggable SSTable format (SSTable format API)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17056&quot;&gt;&lt;del&gt;CASSANDRA-17056&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This return &lt;tt&gt;null&lt;/tt&gt; for some of the cases which leads to the &lt;tt&gt;NullPointerException&lt;/tt&gt;&lt;br/&gt;
StatsComponent#serializationHeader(org.apache.cassandra.schema.TableMetadata)&lt;/p&gt;</comment>
                            <comment id="17752824" author="mmuzaf" created="Thu, 10 Aug 2023 14:42:39 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] ERROR [Reference-Reaper] 2023-08-10 14:33:45,219 Ref.java:240 - LEAK DETECTED: a reference (&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.sstable.format.SSTableReader$InstanceTidier@1954732867:/tmp/10654893319199153835/SSTableLoaderTest/Standard2-e6b6fab0378a11eebf94c5a5ea4e0fa0/nc-14-big) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.sstable.format.SSTableReader$InstanceTidier@1954732867:/tmp/10654893319199153835/SSTableLoaderTest/Standard2-e6b6fab0378a11eebf94c5a5ea4e0fa0/nc-14-big was not released before the reference was garbage collected
[junit-timeout] ERROR [Reference-Reaper] 2023-08-10 14:33:45,220 Ref.java:280 - Allocate trace &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.sstable.format.SSTableReader$InstanceTidier@1954732867:/tmp/10654893319199153835/SSTableLoaderTest/Standard2-e6b6fab0378a11eebf94c5a5ea4e0fa0/nc-14-big:
[junit-timeout] &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[main,5,main]
[junit-timeout]         at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.getStackTrace(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1610)
[junit-timeout]         at org.apache.cassandra.utils.concurrent.Ref$Debug.&amp;lt;init&amp;gt;(Ref.java:270)
[junit-timeout]         at org.apache.cassandra.utils.concurrent.Ref$State.&amp;lt;init&amp;gt;(Ref.java:191)
[junit-timeout]         at org.apache.cassandra.utils.concurrent.Ref.&amp;lt;init&amp;gt;(Ref.java:113)
[junit-timeout]         at org.apache.cassandra.io.sstable.format.SSTableReader.&amp;lt;init&amp;gt;(SSTableReader.java:467)
[junit-timeout]         at org.apache.cassandra.io.sstable.format.SSTableReaderWithFilter.&amp;lt;init&amp;gt;(SSTableReaderWithFilter.java:43)
[junit-timeout]         at org.apache.cassandra.io.sstable.format.big.BigTableReader.&amp;lt;init&amp;gt;(BigTableReader.java:100)
[junit-timeout]         at org.apache.cassandra.io.sstable.format.big.BigTableReader$Builder.buildInternal(BigTableReader.java:742)
[junit-timeout]         at org.apache.cassandra.io.sstable.format.big.BigTableReader$Builder.buildInternal(BigTableReader.java:693)
[junit-timeout]         at org.apache.cassandra.io.sstable.format.SSTableReader$Builder.build(SSTableReader.java:1890)
[junit-timeout]         at org.apache.cassandra.io.sstable.format.SSTableReaderLoadingBuilder.build(SSTableReaderLoadingBuilder.java:97)
[junit-timeout]         at org.apache.cassandra.io.sstable.format.SSTableReader.open(SSTableReader.java:397)
[junit-timeout]         at org.apache.cassandra.io.sstable.format.SSTableReader.openForBatch(SSTableReader.java:373)
[junit-timeout]         at org.apache.cassandra.io.sstable.SSTableLoader.lambda$openSSTables$0(SSTableLoader.java:152)
[junit-timeout]         at org.apache.cassandra.db.lifecycle.LogAwareFileLister.lambda$innerList$2(LogAwareFileLister.java:99)
[junit-timeout]         at java.base/java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:178)
[junit-timeout]         at java.base/java.util.TreeMap$EntrySpliterator.forEachRemaining(TreeMap.java:3287)
[junit-timeout]         at java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)
[junit-timeout]         at java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)
[junit-timeout]         at java.base/java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:921)
[junit-timeout]         at java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
[junit-timeout]         at java.base/java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:682)
[junit-timeout]         at org.apache.cassandra.db.lifecycle.LogAwareFileLister.innerList(LogAwareFileLister.java:101)
[junit-timeout]         at org.apache.cassandra.db.lifecycle.LogAwareFileLister.list(LogAwareFileLister.java:73)
[junit-timeout]         at org.apache.cassandra.db.lifecycle.LifecycleTransaction.getFiles(LifecycleTransaction.java:626)
[junit-timeout]         at org.apache.cassandra.io.sstable.SSTableLoader.openSSTables(SSTableLoader.java:103)
[junit-timeout]         at org.apache.cassandra.io.sstable.SSTableLoader.stream(SSTableLoader.java:202)
[junit-timeout]         at org.apache.cassandra.io.sstable.SSTableLoaderTest.testLoadingIncompleteSSTable(SSTableLoaderTest.java:225)
[junit-timeout]         at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
[junit-timeout]         at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
[junit-timeout]         at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
[junit-timeout]         at java.base/java.lang.reflect.Method.invoke(Method.java:568)
[junit-timeout]         at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
[junit-timeout]         at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
[junit-timeout]         at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
[junit-timeout]         at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
[junit-timeout]         at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
[junit-timeout]         at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
[junit-timeout]         at org.junit.rules.TestWatcher$1.evaluate(TestWatcher.java:55)
[junit-timeout]         at org.junit.rules.RunRules.evaluate(RunRules.java:20)
[junit-timeout]         at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)
[junit-timeout]         at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)
[junit-timeout]         at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)
[junit-timeout]         at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
[junit-timeout]         at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
[junit-timeout]         at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
[junit-timeout]         at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
[junit-timeout]         at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
[junit-timeout]         at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
[junit-timeout]         at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
[junit-timeout]         at junit.framework.JUnit4TestAdapter.run(JUnit4TestAdapter.java:38)
[junit-timeout]         at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.run(JUnitTestRunner.java:534)
[junit-timeout]         at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.launch(JUnitTestRunner.java:1196)
[junit-timeout]         at org.apache.tools.ant.taskdefs.optional.junit.JUnitTestRunner.main(JUnitTestRunner.java:1041)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17752832" author="mmuzaf" created="Thu, 10 Aug 2023 14:54:08 +0000"  >&lt;p&gt;There are a couple of unrelated exceptions in the logs. The first is when the resources are not released properly after the test, so they throw an exception - in other tests the &lt;tt&gt;ColumnFamilyStore#truncateBlocking&lt;/tt&gt; is called to release the resources, but in this particular test it is not. The second one is the exception mentioned in the issue description - the above error appears in the log at the same time as the &lt;tt&gt;NullPointerException&lt;/tt&gt; is thrown.&lt;/p&gt;

&lt;p&gt;Here:&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/Mmuzaf/cassandra/290/workflows/09943d9e-5026-4fbb-8c79-d3208dab87a2/jobs/20389/parallel-runs/5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/Mmuzaf/cassandra/290/workflows/09943d9e-5026-4fbb-8c79-d3208dab87a2/jobs/20389/parallel-runs/5&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;btw:&lt;/p&gt;

&lt;p&gt;{&lt;tt&gt;KEYSPACE1, CF_SNAPSHOTS&lt;/tt&gt;} is missed in the cleanup as well.&lt;/p&gt;</comment>
                            <comment id="17762125" author="edimitrova" created="Tue, 5 Sep 2023 14:55:28 +0000"  >&lt;p&gt;Seen again today:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2493/workflows/59762ffe-b907-42f3-b6c1-558041f737c0/jobs/38779/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2493/workflows/59762ffe-b907-42f3-b6c1-558041f737c0/jobs/38779/tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17764348" author="edimitrova" created="Tue, 12 Sep 2023 19:37:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmuzaf&quot; class=&quot;user-hover&quot; rel=&quot;mmuzaf&quot;&gt;mmuzaf&lt;/a&gt; , I see a PR attached to the ticket. Is this a fix? What is the status of this one? Do we need &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt; to look at it? (I saw &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17056&quot; title=&quot;CEP-17 &#8211; Pluggable SSTable format (SSTable format API)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17056&quot;&gt;&lt;del&gt;CASSANDRA-17056&lt;/del&gt;&lt;/a&gt; mentioned)&lt;/p&gt;</comment>
                            <comment id="17764372" author="mmuzaf" created="Tue, 12 Sep 2023 20:52:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; This was a draft PR to reproduce the issue, I&apos;ve spent a few hours trying to fix it, but didn&apos;t find a good solution. More time needs to be invested into this issue. I&apos;ve removed the PR to avoid any confusion.&lt;/p&gt;</comment>
                            <comment id="17764501" author="jlewandowski" created="Wed, 13 Sep 2023 06:24:21 +0000"  >&lt;p&gt;I&apos;ll take a look on this&lt;/p&gt;</comment>
                            <comment id="17764579" author="jlewandowski" created="Wed, 13 Sep 2023 10:22:30 +0000"  >&lt;p&gt;So far, I don&apos;t understand that test fully, some statements and comments seem misleading to me, in particular:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        ColumnFamilyStore cfs = Keyspace.open(KEYSPACE1).getColumnFamilyStore(CF_STANDARD2);
        Util.flush(cfs); &lt;span class=&quot;code-comment&quot;&gt;// wait &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sstables to be on disk &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; we won&apos;t be able to stream them&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Since we use an external writer, it has nothing to do with flushing; I&apos;ve checked - the number of live sstables before and after flushing is zero. It is expected and contradicts the purpose of flushing (as well as the comment). The writer saves sstables independently and asynchronously in a loop when the buffer gets exhausted. &lt;/p&gt;

&lt;p&gt;Next:&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-comment&quot;&gt;//writer is still open so loader should not load anything
&lt;/span&gt;        SSTableLoader loader = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SSTableLoader(dataDir, &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TestClient(), &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OutputHandler.SystemOutput(&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;));
        loader.stream(Collections.emptySet(), completionStreamListener(latch)).get();

        List&amp;lt;FilteredPartition&amp;gt; partitions = Util.getAll(Util.cmd(cfs).build());

        assertTrue(partitions.size() &amp;gt; 0 &amp;amp;&amp;amp; partitions.size() &amp;lt; NB_PARTITIONS);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The comment actually contradicts the assertion. We expect to load something, but not everything.&lt;/p&gt;

&lt;p&gt;Now, what may be causing the problem? &lt;tt&gt;SSTableLoader&lt;/tt&gt; does not require the &lt;tt&gt;STATS&lt;/tt&gt; component to be present to consider a file to load. This works the same way in pre-17056 as in post-17056. This may be a problem in both versions because we can only load an sstable with &lt;tt&gt;STATS&lt;/tt&gt; component. SSTables are stored asynchronously in a separate thread in &lt;tt&gt;SSTableSimpleUnsortedWriter.DiskWriter&lt;/tt&gt;. &lt;tt&gt;DATA&lt;/tt&gt; and &lt;tt&gt;PRIMARY_INDEX&lt;/tt&gt; components are stored first, then &lt;tt&gt;STATS&lt;/tt&gt; component is stored. The problem looks as is to be caused by trying to load an sstable for which &lt;tt&gt;DATA&lt;/tt&gt; and &lt;tt&gt;PRIMARY_INDEX&lt;/tt&gt; are saved, but &lt;tt&gt;STATS&lt;/tt&gt; still needs to be saved. So, it is a race that explains this failure&apos;s flaky nature. &lt;/p&gt;

&lt;p&gt;I&apos;m planning to investigate the transactions to check if SSTableLoader shall reject the sstables with unfinished components.&lt;/p&gt;</comment>
                            <comment id="17764624" author="jlewandowski" created="Wed, 13 Sep 2023 12:16:33 +0000"  >&lt;p&gt;It is difficult to reproduce when I added some extra logging... &lt;a href=&quot;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra?branch=CASSANDRA-18737,&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra?branch=CASSANDRA-18737,&lt;/a&gt; 1500 iterations total already and nothing...&lt;/p&gt;</comment>
                            <comment id="17764714" author="edimitrova" created="Wed, 13 Sep 2023 14:29:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;This was a draft PR to reproduce the issue&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmuzaf&quot; class=&quot;user-hover&quot; rel=&quot;mmuzaf&quot;&gt;mmuzaf&lt;/a&gt;&#160;, do you mind sharing your code again to reproduce the issue?&lt;/p&gt;</comment>
                            <comment id="17765108" author="jlewandowski" created="Thu, 14 Sep 2023 11:06:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; it is not like that - I was able to reproduce that, it occured to me in some other CI runs. But once I&apos;ve added some extra logging, I cannot reproduce it any longer...&lt;/p&gt;</comment>
                            <comment id="17765208" author="edimitrova" created="Thu, 14 Sep 2023 14:40:45 +0000"  >&lt;p&gt;Oh I see what you mean now, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt;&#160;. So there is some timing component&lt;/p&gt;</comment>
                            <comment id="17765282" author="jlewandowski" created="Thu, 14 Sep 2023 17:11:50 +0000"  >&lt;p&gt;Ahhh.... I think I&apos;ve got it!&lt;/p&gt;

&lt;p&gt;When we build an &lt;tt&gt;SSTableWriter&lt;/tt&gt; using new builders, the empty files for index and data components get create in the constructor, as we create partition writer. It happens even before we start a transaction, so at that moment, we have two sstable files and no transaction log. Whatever scans that directory at that moment will that sstable as completed. I think this is what we are encountering in that test, here is an example - stopped at the constructor of sstable 9:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;jlewandowski@deauville:~/dev/cassandra/wip[CASSANDRA-18737][j11]$ ls /tmp/15704397017644002949/SSTableLoaderTest/Standard2-65d925a0532111eea827adf63f6cb5
be/ -l

total 264

-rw-rw-r-- 1 jlewandowski jlewandowski &#160;&#160;&#160;575 wrz 14 19:11 nc-8-big-CompressionInfo.db

-rw-rw-r-- 1 jlewandowski jlewandowski 231990 wrz 14 19:11 nc-8-big-Data.db

-rw-rw-r-- 1 jlewandowski jlewandowski &#160;&#160;&#160;&#160;&#160;9 wrz 14 19:11 nc-8-big-Digest.crc32

-rw-rw-r-- 1 jlewandowski jlewandowski &#160;&#160;&#160;&#160;16 wrz 14 19:11 nc-8-big-Filter.db

-rw-rw-r-- 1 jlewandowski jlewandowski &#160;&#160;5845 wrz 14 19:11 nc-8-big-Index.db

-rw-rw-r-- 1 jlewandowski jlewandowski &#160;&#160;6327 wrz 14 19:11 nc-8-big-Statistics.db

-rw-rw-r-- 1 jlewandowski jlewandowski &#160;&#160;&#160;111 wrz 14 19:11 nc-8-big-Summary.db

-rw-rw-r-- 1 jlewandowski jlewandowski &#160;&#160;&#160;&#160;92 wrz 14 19:11 nc-8-big-TOC.txt

-rw-rw-r-- 1 jlewandowski jlewandowski &#160;&#160;&#160;&#160;&#160;0 wrz 14 19:11 nc-9-big-Data.db

-rw-rw-r-- 1 jlewandowski jlewandowski &#160;&#160;&#160;&#160;&#160;0 wrz 14 19:11 nc-9-big-Index.db


 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17765287" author="jlewandowski" created="Thu, 14 Sep 2023 17:18:57 +0000"  >&lt;p&gt;That knowledge allowed me to reproduce the issue reliably with each run... it is enough to put a thread into sleep in &lt;tt&gt;SSTableWriter&lt;/tt&gt; constructor, right before &lt;tt&gt;lifecycleNewTracker.trackNew(this);&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17765288" author="jlewandowski" created="Thu, 14 Sep 2023 17:20:41 +0000"  >&lt;p&gt;So my plan is to:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Fix the issue,&lt;/li&gt;
	&lt;li&gt;Add an assertion that no files exists when we are about to create a transaction&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="17765289" author="jlewandowski" created="Thu, 14 Sep 2023 17:21:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mmuzaf&quot; class=&quot;user-hover&quot; rel=&quot;mmuzaf&quot;&gt;mmuzaf&lt;/a&gt;&#160; - we should investigate those leaks in a separate ticket probably - like induce a failure around the same place and make sure that everything collapses properly.&lt;/p&gt;</comment>
                            <comment id="17767832" author="jlewandowski" created="Fri, 22 Sep 2023 05:55:06 +0000"  >&lt;p&gt;Tests on trunk passed, running tests on 5.0&lt;/p&gt;</comment>
                            <comment id="17769285" author="edimitrova" created="Tue, 26 Sep 2023 16:57:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt;&#160;, in the post-commit run, we have all these failures both for 5.0 and trunk.&#160;&lt;/p&gt;

&lt;p&gt;Can you please take a look? I guess they are related to this ticket?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-5.0/46/testReport/org.apache.cassandra.db.compaction/LongCompactionsTest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-5.0/46/testReport/org.apache.cassandra.db.compaction/LongCompactionsTest/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/1722/testReport/junit/org.apache.cassandra.db.compaction/LongCompactionsTest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/1722/testReport/junit/org.apache.cassandra.db.compaction/LongCompactionsTest/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17769458" author="jlewandowski" created="Wed, 27 Sep 2023 07:45:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; has already created a ticket &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18884&quot; title=&quot;Test failure: org.apache.cassandra.db.compaction.LongCompactionsTest &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18884&quot;&gt;&lt;del&gt;CASSANDRA-18884&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13407903">CASSANDRA-17056</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jlewandowski]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1josw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
        <customfieldvalue><![CDATA[mike_tr_adamson]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12353513">5.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/d16e8d3653dce8ed767a040c06dbaabc47a9b474&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/d16e8d3653dce8ed767a040c06dbaabc47a9b474&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;run regression and new tests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>