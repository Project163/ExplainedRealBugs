<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:12:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14958] Counters fail to increment in 2.1/2.2 to 3.X mixed version clusters</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14958</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The upgrade test for this is failing&lt;br/&gt;
&lt;a href=&quot;https://circleci.com/gh/aweisberg/cassandra/2362#tests/containers/1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/aweisberg/cassandra/2362#tests/containers/1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I confirmed that this is occurring manually using cqlsh against the cluster constructed by the dtest.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh&amp;gt; describe schema;

CREATE KEYSPACE ks WITH replication = {&apos;class&apos;: &apos;SimpleStrategy&apos;, &apos;replication_factor&apos;: &apos;1&apos;}  AND durable_writes = true;

CREATE TABLE ks.clicks (
    userid int,
    url text,
    total counter,
    PRIMARY KEY (userid, url)
) WITH COMPACT STORAGE
    AND CLUSTERING ORDER BY (url ASC)
    AND bloom_filter_fp_chance = 0.01
    AND caching = {&apos;keys&apos;: &apos;ALL&apos;, &apos;rows_per_partition&apos;: &apos;NONE&apos;}
    AND comment = &apos;&apos;
    AND compaction = {&apos;class&apos;: &apos;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&apos;, &apos;max_threshold&apos;: &apos;32&apos;, &apos;min_threshold&apos;: &apos;4&apos;}
    AND compression = {&apos;chunk_length_in_kb&apos;: &apos;64&apos;, &apos;class&apos;: &apos;org.apache.cassandra.io.compress.LZ4Compressor&apos;}
    AND crc_check_chance = 1.0
    AND dclocal_read_repair_chance = 0.1
    AND default_time_to_live = 0
    AND gc_grace_seconds = 864000
    AND max_index_interval = 2048
    AND memtable_flush_period_in_ms = 0
    AND min_index_interval = 128
    AND read_repair_chance = 0.0
    AND speculative_retry = &apos;99PERCENTILE&apos;;

cqlsh&amp;gt; use ks;
cqlsh:ks&amp;gt; UPDATE clicks SET total = total + 1 WHERE userid = 1 AND url = &apos;http://foo.com&apos;;
cqlsh:ks&amp;gt; SELECT total FROM clicks WHERE userid = 1 AND url = &apos;http://foo.com&apos;
      ... ;

 total
-------
     0

(1 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13208067">CASSANDRA-14958</key>
            <summary>Counters fail to increment in 2.1/2.2 to 3.X mixed version clusters</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="aweisberg">Ariel Weisberg</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Jan 2019 16:15:24 +0000</created>
                <updated>Fri, 2 Aug 2019 02:40:11 +0000</updated>
                            <resolved>Mon, 14 Jan 2019 18:09:57 +0000</resolved>
                                        <fixVersion>3.0.18</fixVersion>
                    <fixVersion>3.11.4</fixVersion>
                                    <component>Feature/Counters</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16740541" author="iamaleksey" created="Fri, 11 Jan 2019 16:30:29 +0000"  >&lt;p&gt;Unfortunately there is indeed an issue.&lt;/p&gt;

&lt;p&gt;In a mixed-version 2.1 + 3.0 cluster, when 3.0 coordinates a counter update request, and chooses to forward the counter mutation to a different leader, such an update would be lost.&lt;/p&gt;

&lt;p&gt;For that to happen you need to have a mixed mode cluster with 3.0 node both coordinating and opting to &lt;b&gt;not&lt;/b&gt; be a leader itself, which is actually a rather likely scenario. I&apos;m (very) surprised that this upgrade bug hasn&apos;t been noticed before (before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14881&quot; title=&quot;Inconsistent behaviour of counter update during cassandra upgrade 2.1.16 -&amp;gt; 3.11.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14881&quot;&gt;&lt;del&gt;CASSANDRA-14881&lt;/del&gt;&lt;/a&gt; that is).&lt;/p&gt;</comment>
                            <comment id="16740648" author="iamaleksey" created="Fri, 11 Jan 2019 18:40:04 +0000"  >&lt;p&gt;Code: &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/14958-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/14958-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;.&lt;br/&gt;
CI: &lt;a href=&quot;https://circleci.com/workflow-run/ad96e947-dff3-4d63-9c34-3e5220e550e4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/workflow-run/8378d5c3-a517-486f-8df0-b8d36c05bd79&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To fix another compatibility issue, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13691&quot; title=&quot;Fix incorrect [2.1 &amp;lt;&#8212; 3.0] serialization of counter cells with pre-2.1 local shards&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13691&quot;&gt;&lt;del&gt;CASSANDRA-13691&lt;/del&gt;&lt;/a&gt; switched from using local shards to stash counter update values to a special sentinel id. &lt;tt&gt;LegacyLayout&lt;/tt&gt; code was in one place unfortunately not updated to reflect the change, breaking counter update cell serialisation to legacy nodes, always sending 0-increments.&lt;/p&gt;

&lt;p&gt;The linked branches address the issue. There is no new test as this scenario is already covered pretty well by the (now working) upgrade tests.&lt;/p&gt;</comment>
                            <comment id="16742087" author="iamaleksey" created="Mon, 14 Jan 2019 14:04:15 +0000"  >&lt;p&gt;Upgrade test results showing the issue&apos;s now fixed: &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/914&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/915&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16742303" author="benedict" created="Mon, 14 Jan 2019 16:57:15 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16742372" author="iamaleksey" created="Mon, 14 Jan 2019 18:09:37 +0000"  >&lt;p&gt;Cheers. Committed to 3.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/ebfa280fac2f43fb88e2e87d81f35b8017222a12&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ebfa280fac2f43fb88e2e87d81f35b8017222a12&lt;/a&gt; and merged into 3.11, -s ours into trunk.&lt;/p&gt;</comment>
                            <comment id="16742439" author="aweisberg" created="Mon, 14 Jan 2019 19:33:24 +0000"  >&lt;p&gt;Thanks! Don&apos;t forget to remove the skip annotation on upgrade_tests/cql_tests.py test_counters.&lt;/p&gt;</comment>
                            <comment id="16743358" author="iamaleksey" created="Tue, 15 Jan 2019 20:05:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; Would&apos;ve forgotten if not for your comment - thank you. And just to confirm, two proper upgrade test runs with the annotation removed, with counter tests passing: &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/921&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/923&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13197322">CASSANDRA-14881</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13087066">CASSANDRA-13691</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12986" cascade-level="1"><![CDATA[Recoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 44 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|u00l3c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>