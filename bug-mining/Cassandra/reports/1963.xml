<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:36:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5089] get_range_slices does not validate end_token</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5089</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;get_range_slices times out, java log has the following exception:&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1&amp;#93;&lt;/span&gt; 2012-12-22 08:14:30,120 AbstractCassandraDaemon.java (line 135) Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Thrift:1,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError: &lt;span class=&quot;error&quot;&gt;&amp;#91;DecoratedKey(28555413689034504124051437792156504, 6434313866653035643631663962323635323937343337653666636265616162),max(0)&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.dht.Bounds.&amp;lt;init&amp;gt;(Bounds.java:45)&lt;br/&gt;
        at org.apache.cassandra.dht.Bounds.&amp;lt;init&amp;gt;(Bounds.java:38)&lt;br/&gt;
        at org.apache.cassandra.thrift.CassandraServer.get_range_slices(CassandraServer.java:698)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor$get_range_slices.getResult(Cassandra.java:3083)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor$get_range_slices.getResult(Cassandra.java:3071)&lt;br/&gt;
        at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:32)&lt;br/&gt;
        at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:34)&lt;br/&gt;
        at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:186)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;

&lt;p&gt;We see it every time on the SECOND get_range_slices call when we clear start_token and set start_key in the key range.&lt;br/&gt;
We noticed this in 1.1.7 first, 1.1.8 still affected. 1.1.6 is fine.&lt;br/&gt;
Please contact me if you need more information.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12625154">CASSANDRA-5089</key>
            <summary>get_range_slices does not validate end_token</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="apesternikov">Aleksey Pesternikov</reporter>
                        <labels>
                    </labels>
                <created>Sun, 23 Dec 2012 21:04:29 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:20 +0000</updated>
                            <resolved>Wed, 9 Jan 2013 22:29:05 +0000</resolved>
                                        <fixVersion>1.1.9</fixVersion>
                    <fixVersion>1.2.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13539149" author="jbellis" created="Mon, 24 Dec 2012 02:03:52 +0000"  >&lt;p&gt;It looks like you are specifying start_key and end_token, with an invalid end_token.  Don&apos;t do that.  (If you want to specify &quot;the rest of the token range&quot; then use end_key=&quot;&quot; and leave end_token null.)&lt;/p&gt;</comment>
                            <comment id="13539153" author="jbellis" created="Mon, 24 Dec 2012 02:17:50 +0000"  >&lt;p&gt;Prior to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4804&quot; title=&quot;Wrong assumption for KeyRange about range.end_token in get_range_slices().&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4804&quot;&gt;&lt;del&gt;CASSANDRA-4804&lt;/del&gt;&lt;/a&gt; we always ignored end_token which is why this is biting you now.&lt;/p&gt;

&lt;p&gt;Patch attached to add extra validation so we don&apos;t rely on AssertionError to stop this.&lt;/p&gt;</comment>
                            <comment id="13539283" author="apesternikov" created="Mon, 24 Dec 2012 15:44:12 +0000"  >&lt;p&gt;what is the proper format for token? I assumed it is decimal string. I think it is worked in 1.1.6&lt;br/&gt;
re using end_key=&quot;&quot;: start_key + end_token range has its very valid use case, when the whole data set should be processed (think of map/reduce) on multiple distributed workers. We split the ring into N parts, every worker start with (start_token - end_token) range, when first batch is received it switches to (star_key - end_token). ColumnFamilyRecordReader is cheating here by using internals for calculating token:&lt;br/&gt;
startToken = partitioner.getTokenFactory().toString(partitioner.getToken(Iterables.getLast(rows).key));&lt;br/&gt;
unfortunately it is not an option for us, we are using C++&lt;br/&gt;
So, what is the proper format for token and how to do iteration over several ranges?&lt;br/&gt;
Thank you.&lt;/p&gt;</comment>
                            <comment id="13540017" author="jbellis" created="Thu, 27 Dec 2012 16:26:10 +0000"  >&lt;p&gt;simplified v2 attached &lt;/p&gt;</comment>
                            <comment id="13540024" author="dbrosius@apache.org" created="Thu, 27 Dec 2012 16:37:39 +0000"  >&lt;p&gt;v2 lgtm, assuming we don&apos;t allow a crazy combination of range.start_key and range.end_token or such.&lt;/p&gt;

&lt;p&gt;also note, pushing to trunk will not compile cleanly as on trunk throws of IRE needs to be fully qualified... (or an import needs to be added).&lt;/p&gt;</comment>
                            <comment id="13540045" author="apesternikov" created="Thu, 27 Dec 2012 17:10:57 +0000"  >&lt;p&gt;Dave,&lt;br/&gt;
either your statement about craziness of start_key - end_token or first paragraph of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4804&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-4804&lt;/a&gt; description is incorrect.&lt;br/&gt;
I would like to reiterate that start_key - end_token combination let us split ranges and iterate over segments using API only without reaching internals.&lt;br/&gt;
Ok, if you guys decide that you don&apos;t want to support this combination, can you give us another tool for iteration? IMHO something like &lt;br/&gt;
3:  optional string token,&lt;br/&gt;
in KeySlice would be sufficient for proper iteration over token ranges. As a free benefit we would get a better token iterator semantics.&lt;/p&gt;</comment>
                            <comment id="13540049" author="jbellis" created="Thu, 27 Dec 2012 17:13:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;assuming we don&apos;t allow a crazy combination of range.start_key and range.end_token or such&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Heh, that&apos;s what I was trying to validate in v1.  I retract v2. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13540060" author="dbrosius@apache.org" created="Thu, 27 Dec 2012 17:25:59 +0000"  >&lt;p&gt;Sorry Aleksey, ignore my craziness comment &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;V1, needs semi at RowPosition stop = p.getTokenFactory().fromString(range.end_token).maxKeyBound(p)&lt;/p&gt;

&lt;p&gt;also, it seems there is ambiquity if end_key and end_token are specified. (or start_key and start_token for that matter).&lt;/p&gt;</comment>
                            <comment id="13540112" author="dbrosius@apache.org" created="Thu, 27 Dec 2012 19:17:58 +0000"  >&lt;p&gt;ah, there&apos;s a check at the top for this ambiquity, so i was mistaken...&lt;/p&gt;

&lt;p&gt;patch lgtm, except for semi.&lt;/p&gt;</comment>
                            <comment id="13540143" author="jbellis" created="Thu, 27 Dec 2012 20:45:57 +0000"  >&lt;p&gt;committed, thanks&lt;/p&gt;</comment>
                            <comment id="13541289" author="apesternikov" created="Mon, 31 Dec 2012 05:54:21 +0000"  >&lt;p&gt;I applied the 5089-v2.txt to 1.1.8. Unfortunately, I have to report that it does not fix the problem.&lt;br/&gt;
It is not really surprising, because the patch does not change anything for our case of (start_key, end_token) range.&lt;br/&gt;
I have a huge log with debug logging level, please contact me if interested.&lt;/p&gt;</comment>
                            <comment id="13541294" author="dbrosius" created="Mon, 31 Dec 2012 06:18:59 +0000"  >&lt;p&gt;i would have thought this&lt;/p&gt;

&lt;p&gt;+            RowPosition stop = p.getTokenFactory().fromString(range.end_token).maxKeyBound(p)&lt;br/&gt;
+            if (range.start_key != null &amp;amp;&amp;amp; RowPosition.forKey(range.start_key, p).compareTo(stop) &amp;gt; 0)&lt;br/&gt;
+                throw new InvalidRequestException(&quot;Start key&apos;s token sorts after end token&quot;);&lt;/p&gt;


&lt;p&gt;would have addressed the issue. Can you produce a simple test case that shows the problem?&lt;/p&gt;</comment>
                            <comment id="13546033" author="apesternikov" created="Mon, 7 Jan 2013 16:52:35 +0000"  >&lt;p&gt;test attached.&lt;br/&gt;
Please note that you need -ea JVM command line flag to reveal the problem, without -ea it works fine.&lt;br/&gt;
I think the problem is in Bounds.java:45 assert statement:&lt;/p&gt;

&lt;p&gt;        assert left.compareTo(right) &amp;lt;= 0 || right.isMinimum(partitioner) : &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot; + left + &amp;quot;,&amp;quot; + right + &amp;quot;&amp;#93;&lt;/span&gt;&quot;;&lt;/p&gt;

&lt;p&gt; Why left is even compared to right? Why &quot;bounds may not wrap&quot; as it stated in the comment? Logically, &quot;less&quot; and &quot;more&quot; are irrelevant to iterator position as we are talking about RING.&lt;/p&gt;</comment>
                            <comment id="13547309" author="jbellis" created="Tue, 8 Jan 2013 21:40:49 +0000"  >&lt;p&gt;Let&apos;s leave this closed since 1.2.0 is already released with the patch.  &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5106&quot; title=&quot;Stock example for using pig throws InvalidRequestException(why:Start token sorts after end token)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5106&quot;&gt;&lt;del&gt;CASSANDRA-5106&lt;/del&gt;&lt;/a&gt; is open to fix a regression it caused.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12625917">CASSANDRA-5106</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12562485" name="5089-v2.txt" size="1563" author="jbellis" created="Thu, 27 Dec 2012 16:26:10 +0000"/>
                            <attachment id="12562302" name="5089.txt" size="1690" author="jbellis" created="Mon, 24 Dec 2012 02:17:50 +0000"/>
                            <attachment id="12563593" name="5089unittest.diff" size="5728" author="apesternikov" created="Mon, 7 Jan 2013 16:52:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>301694</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 46 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i16vpr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>248270</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>dbrosius</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dbrosius]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>