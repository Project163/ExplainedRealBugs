<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:19:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-1924] Broken keyspace strategy_option with zero replicas</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-1924</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When a keyspace is defined that has strategy options specifying zero replicas should be place in a datacenter (e.g. DCX:0), an assert is violated for any insert and LOCAL_QUORUM reads fail.  I&apos;m not sure if the issue is that there are no nodes in DCX or that I&apos;m saying DCX shouldn&apos;t get any replicas, or a combination of the two.&lt;/p&gt;

&lt;p&gt;The broken keyspace:&lt;/p&gt;

&lt;p&gt;create keyspace KeyspaceDC1 with&lt;br/&gt;
  replication_factor = 1 and&lt;br/&gt;
  placement_strategy = &apos;org.apache.cassandra.locator.NetworkTopologyStrategy&apos; and&lt;br/&gt;
  strategy_options = [&lt;/p&gt;
{DC1:1, DC2:0}
&lt;p&gt;];&lt;/p&gt;

&lt;p&gt;The fixed keyspace:&lt;/p&gt;

&lt;p&gt;create keyspace KeyspaceDC1 with&lt;br/&gt;
  replication_factor = 1 and&lt;br/&gt;
  placement_strategy = &apos;org.apache.cassandra.locator.NetworkTopologyStrategy&apos; and&lt;br/&gt;
  strategy_options = [&lt;/p&gt;
{DC1:1}
&lt;p&gt;];&lt;/p&gt;


&lt;p&gt;To reproduce:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Install the 0.7rc3 rpm on a single node in &quot;DC1&quot;.&lt;/li&gt;
	&lt;li&gt;In cassandra.yaml set initial_token = 1 and specify PropertyFileSnitch.&lt;/li&gt;
	&lt;li&gt;cassandra-topology.properties:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;10.5.64.26=DC1:R1&lt;br/&gt;
default=DC2:R1&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Schema loaded via cassandra-cli:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;create keyspace KeyspaceDC1 with&lt;br/&gt;
  replication_factor = 1 and&lt;br/&gt;
  placement_strategy = &apos;org.apache.cassandra.locator.NetworkTopologyStrategy&apos; and&lt;br/&gt;
  strategy_options = [&lt;/p&gt;
{DC1:1, DC2:0}
&lt;p&gt;];&lt;/p&gt;

&lt;p&gt;use KeyspaceDC1;&lt;/p&gt;

&lt;p&gt;create column family TestCF with&lt;br/&gt;
  column_type = &apos;Standard&apos; and&lt;br/&gt;
  comparator = &apos;BytesType&apos; and&lt;br/&gt;
  keys_cached = 200000 and&lt;br/&gt;
  rows_cached = 2000 and&lt;br/&gt;
  gc_grace = 0 and&lt;br/&gt;
  read_repair_chance = 0.0;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;In cassandra-cli execute the following:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;default@unknown&amp;#93;&lt;/span&gt; use KeyspaceDC1;&lt;br/&gt;
Authenticated to keyspace: KeyspaceDC1&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;default@KeyspaceDC1&amp;#93;&lt;/span&gt; set TestCF&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;some key&amp;#39;&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;some col&amp;#39;&amp;#93;&lt;/span&gt; = &apos;some value&apos;;&lt;br/&gt;
Internal error processing insert&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;If you have asserts enabled, check system.log where you should find the assertion error:&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-3&amp;#93;&lt;/span&gt; 2010-12-29 12:10:38,897 CassandraServer.java (line 362) insert&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-3&amp;#93;&lt;/span&gt; 2010-12-29 12:10:38,906 Cassandra.java (line 2960) Internal error processing insert&lt;br/&gt;
java.lang.AssertionError&lt;br/&gt;
        at org.apache.cassandra.locator.TokenMetadata.firstTokenIndex(TokenMetadata.java:392) &lt;br/&gt;
        at org.apache.cassandra.locator.TokenMetadata.ringIterator(TokenMetadata.java:417)&lt;br/&gt;
        at org.apache.cassandra.locator.NetworkTopologyStrategy.calculateNaturalEndpoints(NetworkTopologyStrategy.java:95)&lt;br/&gt;
        at org.apache.cassandra.locator.AbstractReplicationStrategy.getNaturalEndpoints(AbstractReplicationStrategy.java:99)&lt;br/&gt;
        at org.apache.cassandra.service.StorageService.getNaturalEndpoints(StorageService.java:1411)&lt;br/&gt;
        at org.apache.cassandra.service.StorageService.getNaturalEndpoints(StorageService.java:1394)&lt;br/&gt;
        at org.apache.cassandra.service.StorageProxy.mutate(StorageProxy.java:109)&lt;br/&gt;
        at org.apache.cassandra.thrift.CassandraServer.doInsert(CassandraServer.java:442)&lt;br/&gt;
        at org.apache.cassandra.thrift.CassandraServer.insert(CassandraServer.java:379)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor$insert.process(Cassandra.java:2952)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor.process(Cassandra.java:2555)&lt;br/&gt;
        at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:167)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908) &lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;If you don&apos;t have asserts enabled, you should find that no errors are logged but LOCAL_QUORUM reads cause TimedOutExceptions on the client.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12494336">CASSANDRA-1924</key>
            <summary>Broken keyspace strategy_option with zero replicas</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="thorcarpenter">Thor Carpenter</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Dec 2010 22:59:28 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:10 +0000</updated>
                            <resolved>Fri, 11 Mar 2011 18:18:37 +0000</resolved>
                                        <fixVersion>0.7.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="7200">2h</timeoriginalestimate>
                            <timeestimate seconds="7200">2h</timeestimate>
                                        <comments>
                            <comment id="13005002" author="tommysdk" created="Thu, 10 Mar 2011 09:11:09 +0000"  >&lt;p&gt;So the AssertionError occurs in TokenMetadata.firstTokenIndex where the token ring is expected to have a size greater than 0. A discovery I made is that the TokenMetadata.ringIterator method which makes the call to firstTokenIndex, also expects the ring to be non-empty if the includeMin parameter is true:&lt;br/&gt;
final boolean insertMin = (includeMin &amp;amp;&amp;amp; !ring.get(0).equals(StorageService.getPartitioner().getMinimumToken())) ? true : false;&lt;/p&gt;

&lt;p&gt;If the includeMin parameter is true and the ring is empty, it would raise a java.lang.IndexOutOfBoundsException: Index: 0, Size: 0. However, the method only seems to be called with includeMin == true from StorageProxy.getRestrictedRanges. As in the case of this issue, it is called from NetworkTopologyStrategy with a includeMin == false, thus failing at the assertion in TokenMetadata.firstTokenIndex since there are no TokenMetadata tokens present.&lt;/p&gt;
</comment>
                            <comment id="13005633" author="slebresne" created="Fri, 11 Mar 2011 13:43:56 +0000"  >&lt;p&gt;Indeed ringIterator() shouldn&apos;t fail when the argument token list is empty.&lt;/p&gt;

&lt;p&gt;Attaching patch to fix this with a unit test.&lt;/p&gt;

&lt;p&gt;The second patch attached adds a more high level unit test that tests the problem at the level of NetworkTopologyStrategy (while the first patch has a ringIterator test). It also include a tiny optimisation for NetworkTopologyStrategy that skip unnecessary steps when the number of replicas in the DC is 0. This optimisation would hide the actual problem so that&apos;s why it&apos;s attached separately.&lt;/p&gt;</comment>
                            <comment id="13005648" author="jbellis" created="Fri, 11 Mar 2011 14:18:52 +0000"  >&lt;p&gt;would it be simpler to say something like &quot;if ring.isEmpty() return Iterators.emptyIterator()&quot;?&lt;/p&gt;</comment>
                            <comment id="13005662" author="slebresne" created="Fri, 11 Mar 2011 14:54:50 +0000"  >&lt;p&gt;You are right, it&apos;s a bit cleaner. Attaching new version of first patch using Iterators functions.&lt;/p&gt;</comment>
                            <comment id="13005763" author="jbellis" created="Fri, 11 Mar 2011 18:18:37 +0000"  >&lt;p&gt;committed w/o the NTS optimization.&lt;/p&gt;

&lt;p&gt;(open to being convinced otherwise but my reasoning is that performance is not critical-&lt;del&gt;since the result of calculateNE is cached by ARS.getNE&lt;/del&gt;-so we should not add special cases there that can hide bugs.)&lt;/p&gt;</comment>
                            <comment id="13005889" author="hudson" created="Fri, 11 Mar 2011 23:07:03 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #375 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/375/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/375/&lt;/a&gt;)&lt;br/&gt;
    allow zero replicas in a NTSdatacenter&lt;br/&gt;
patch by slebresne; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1924&quot; title=&quot;Broken keyspace strategy_option with zero replicas&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1924&quot;&gt;&lt;del&gt;CASSANDRA-1924&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12473396" name="0001-Ring-iterator-empty-list-test.patch" size="1939" author="slebresne" created="Fri, 11 Mar 2011 14:54:50 +0000"/>
                            <attachment id="12473392" name="0002-NetworkTopologyStrategy-test-and-small-optim.patch" size="4425" author="slebresne" created="Fri, 11 Mar 2011 13:43:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20372</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 37 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g88v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92766</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>