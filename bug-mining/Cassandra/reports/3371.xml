<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8719] Using thrift HSHA with offheap_objects appears to corrupt data</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8719</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Copying my comment from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6285&quot; title=&quot;2.0 HSHA server introduces corrupt data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6285&quot;&gt;&lt;del&gt;CASSANDRA-6285&lt;/del&gt;&lt;/a&gt; to a new issue since that issue is long closed and I&apos;m not sure if they are related...&lt;/p&gt;

&lt;p&gt;I am getting this exception using Thrift HSHA in 2.1.0:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:8&amp;#93;&lt;/span&gt; 2015-01-26 13:32:51,818 CompactionTask.java (line 138) Compacting &lt;span class=&quot;error&quot;&gt;&amp;#91;SSTableReader(path=&amp;#39;/tmp/cass_test/cassandra/TestCassandra/data/test_ks/test_cf-1c45da40a58911e4826751fbbc77b187/test_ks-test_cf-ka-2-Data.db&amp;#39;), SSTableReader(path=&amp;#39;/tmp/cass_test/cassandra/TestCassandra/data/test_ks/test_cf-1c45da40a58911e4826751fbbc77b187/test_ks-test_cf-ka-1-Data.db&amp;#39;)&amp;#93;&lt;/span&gt;&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:8&amp;#93;&lt;/span&gt; 2015-01-26 13:32:51,890 ColumnFamilyStore.java (line 856) Enqueuing flush of compactions_in_progress: 212 (0%) on-heap, 20 (0%) off-heap&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;MemtableFlushWriter:8&amp;#93;&lt;/span&gt; 2015-01-26 13:32:51,892 Memtable.java (line 326) Writing Memtable-compactions_in_progress@1155018639(0 serialized bytes, 1 ops, 0%/0% of on/off-heap limit)&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;MemtableFlushWriter:8&amp;#93;&lt;/span&gt; 2015-01-26 13:32:51,896 Memtable.java (line 360) Completed flushing /tmp/cass_test/cassandra/TestCassandra/data/system/compactions_in_progress-55080ab05d9c388690a4acb25fe1f77b/system-compactions_in_progress-ka-2-Data.db (42 bytes) for commitlog position ReplayPosition(segmentId=1422296630707, position=430226)&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:8&amp;#93;&lt;/span&gt; 2015-01-26 13:32:51,906 CassandraDaemon.java (line 166) Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:8,1,RMI Runtime&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: Last written key DecoratedKey(131206587314004820534098544948237170809, 800100010000000c62617463685f6d7574617465000000) &amp;gt;= current key DecoratedKey(14775611966645399672119169777260659240, 726f776b65793030385f31343232323937313537353835) writing into /tmp/cass_test/cassandra/TestCassandra/data/test_ks/test_cf-1c45da40a58911e4826751fbbc77b187/test_ks-test_cf-tmp-ka-3-Data.db&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:172) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:196) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableRewriter.append(SSTableRewriter.java:110) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionTask.runWith(CompactionTask.java:177) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:74) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:235) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.7.0_40&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(FutureTask.java:262) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.7.0_40&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.7.0_40&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.7.0_40&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:724) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.7.0_40&amp;#93;&lt;/span&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think it&apos;s caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8211&quot; title=&quot;Overlapping sstables in L1+&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8211&quot;&gt;&lt;del&gt;CASSANDRA-8211&lt;/del&gt;&lt;/a&gt;, because it happens during the first compaction that takes place between the first 2 SSTables to get flushed from an initially empty column family.&lt;/p&gt;

&lt;p&gt;Also, I&apos;ve only been able to reproduce it when using both &lt;b&gt;hsha&lt;/b&gt; for the rpc server and &lt;b&gt;offheap_objects&lt;/b&gt; for memtable allocation. If I switch either to sync or to offheap_buffers or heap_buffers then I cannot reproduce the problem. Also under the same circumstances I&apos;m pretty sure I&apos;ve seen incorrect data being returned to a client multiget_slice request before any SSTables had been flushed yet, so I presume this is corruption that happens before any flush/compaction takes place.&lt;/p&gt;

&lt;p&gt;nodetool scrub yielded these errors:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt; INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:9&amp;#93;&lt;/span&gt; 2015-01-26 13:48:01,512 OutputHandler.java (line 42) Scrubbing SSTableReader(path=&apos;/tmp/cass_test/cassandra/TestCassandra/data/test_ks/test_cf-1c45da40a58911e4826751fbbc77b187/test_ks-test_cf-ka-2-Data.db&apos;) (168780 bytes)&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:10&amp;#93;&lt;/span&gt; 2015-01-26 13:48:01,512 OutputHandler.java (line 42) Scrubbing SSTableReader(path=&apos;/tmp/cass_test/cassandra/TestCassandra/data/test_ks/test_cf-1c45da40a58911e4826751fbbc77b187/test_ks-test_cf-ka-1-Data.db&apos;) (135024 bytes)&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:9&amp;#93;&lt;/span&gt; 2015-01-26 13:48:01,531 OutputHandler.java (line 52) Out of order row detected (DecoratedKey(14775611966645399672119169777260659240, 726f776b65793030385f31343232323937313537353835) found after DecoratedKey(131206587314004820534098544948237170809, 800100010000000c62617463685f6d7574617465000000))&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:9&amp;#93;&lt;/span&gt; 2015-01-26 13:48:01,534 OutputHandler.java (line 57) Error reading row (stacktrace follows):&lt;br/&gt;
java.lang.RuntimeException: Last written key DecoratedKey(131206587314004820534098544948237170809, 800100010000000c62617463685f6d7574617465000000) &amp;gt;= current key DecoratedKey(131206587314004820534098544948237170809, 800100010000000c62617463685f6d7574617465000000) writing into /tmp/cass_test/cassandra/TestCassandra/data/test_ks/test_cf-1c45da40a58911e4826751fbbc77b187/test_ks-test_cf-tmp-ka-4-Data.db&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:172) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:196) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableRewriter.append(SSTableRewriter.java:110) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableRewriter.tryAppend(SSTableRewriter.java:141) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.compaction.Scrubber.scrub(Scrubber.java:186) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager.scrubOne(CompactionManager.java:592) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager.access$300(CompactionManager.java:100) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager$3.execute(CompactionManager.java:315) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager$2.call(CompactionManager.java:270) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.0.jar:2.1.0&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(FutureTask.java:262) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.7.0_40&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.7.0_40&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.7.0_40&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:724) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.7.0_40&amp;#93;&lt;/span&gt;&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:9&amp;#93;&lt;/span&gt; 2015-01-26 13:48:01,534 OutputHandler.java (line 52) Row starting at position 25342 is unreadable; skipping to next&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:10&amp;#93;&lt;/span&gt; 2015-01-26 13:48:01,534 OutputHandler.java (line 52) Out of order row detected (DecoratedKey(29459452031265566667651334397450214244, 726f776b65793030355f31343232323936393033323837) found after DecoratedKey(131206587314004820534098544948237170809, 800100010000000c62617463685f6d7574617465000000))&lt;/p&gt;

&lt;p&gt;etc...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ve able to reliably reproduce by creating a new empty table, writing a few partitions containing a few rows each, forcing a flush using nodetool, writing some more, and flushing again, and letting the first compaction happen (using LCS). If I read before flushing, sometimes I will get zero rows back (with quorum between writes and reads), or corrupt bytes, though sometimes reading would yield the correct results. I haven&apos;t been able to narrow down yet the cases when the data comes back corrupt vs not, though in the same test case (one set of of writes) the results of a read appear to be consistent (successive reads are either all correct or all incorrect).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12771808">CASSANDRA-8719</key>
            <summary>Using thrift HSHA with offheap_objects appears to corrupt data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="rbfblk">Randy Fradin</reporter>
                        <labels>
                    </labels>
                <created>Mon, 2 Feb 2015 19:24:44 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:22 +0000</updated>
                            <resolved>Wed, 11 Feb 2015 14:57:22 +0000</resolved>
                                        <fixVersion>2.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14314304" author="krummas" created="Tue, 10 Feb 2015 15:22:38 +0000"  >&lt;p&gt;could you post your schema etc?&lt;/p&gt;

&lt;p&gt;also, it would be extremely helpful if you could post a small script (or just the inserts you do etc) that reproduces this&lt;/p&gt;</comment>
                            <comment id="14314498" author="rbfblk" created="Tue, 10 Feb 2015 17:32:56 +0000"  >&lt;p&gt;From cassandra-cli on a fresh 1-node cluster running 2.1.0 with offheap_objects and hsha enabled:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;create keyspace ks1 with placement_strategy = &apos;org.apache.cassandra.locator.SimpleStrategy&apos; and strategy_options = {replication_factor:1};
use ks1;
create column family cf1
    with comparator = &apos;AsciiType&apos;
    and key_validation_class = &apos;AsciiType&apos;
    and default_validation_class = &apos;AsciiType&apos;
    and column_type = &apos;Standard&apos;
    and gc_grace = 864000
    and read_repair_chance = 1.0
    and compaction_strategy = &apos;org.apache.cassandra.db.compaction.LeveledCompactionStrategy&apos;
    and compaction_strategy_options = {sstable_size_in_mb:160}
    and compression_options = {sstable_compression:SnappyCompressor, chunk_length_kb:64};
set cf1[&apos;111&apos;][&apos;1&apos;] = 123;
set cf1[&apos;111&apos;][&apos;2&apos;] = 456;
set cf1[&apos;222&apos;][&apos;1&apos;] = 321;
set cf1[&apos;222&apos;][&apos;2&apos;] = 654;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At this point I run nodetool flush. Then back in cassandra-cli:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;set cf1[&apos;333&apos;][&apos;1&apos;] = 789;
set cf1[&apos;333&apos;][&apos;2&apos;] = abc;
set cf1[&apos;444&apos;][&apos;1&apos;] = 987;
set cf1[&apos;444&apos;][&apos;2&apos;] = cba;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then nodetool flush again.&lt;/p&gt;

&lt;p&gt;Here are the files in the ks1/cf1-63901340b13f11e48e36730c68dbc38c directory:&lt;br/&gt;
ks1-cf1-ka-1-CompressionInfo.db&lt;br/&gt;
ks1-cf1-ka-1-Data.db&lt;br/&gt;
ks1-cf1-ka-1-Digest.sha1&lt;br/&gt;
ks1-cf1-ka-1-Filter.db&lt;br/&gt;
ks1-cf1-ka-1-Index.db&lt;br/&gt;
ks1-cf1-ka-1-Statistics.db&lt;br/&gt;
ks1-cf1-ka-1-Summary.db&lt;br/&gt;
ks1-cf1-ka-1-TOC.txt&lt;br/&gt;
ks1-cf1-ka-2-CompressionInfo.db&lt;br/&gt;
ks1-cf1-ka-2-Data.db&lt;br/&gt;
ks1-cf1-ka-2-Digest.sha1&lt;br/&gt;
ks1-cf1-ka-2-Filter.db&lt;br/&gt;
ks1-cf1-ka-2-Index.db&lt;br/&gt;
ks1-cf1-ka-2-Statistics.db&lt;br/&gt;
ks1-cf1-ka-2-Summary.db&lt;br/&gt;
ks1-cf1-ka-2-TOC.txt&lt;/p&gt;

&lt;p&gt;And I see this in the log from the second flush onward:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO [RMI TCP Connection(6)-45.10.96.124] 2015-02-10 11:12:37,596 ColumnFamilyStore.java (line 856) Enqueuing flush of cf1: 584 (0%) on-heap, 166 (0%) off-heap
 INFO [MemtableFlushWriter:9] 2015-02-10 11:12:37,597 Memtable.java (line 326) Writing Memtable-cf1@114791717(72 serialized bytes, 4 ops, 0%/0% of on/off-heap limit)
 INFO [MemtableFlushWriter:9] 2015-02-10 11:12:37,600 Memtable.java (line 360) Completed flushing /tmp/cassandra/data/ks1/cf1-63901340b13f11e48e36730c68dbc38c/ks1-cf1-ka-2-Data.db (67 bytes) for commitlog position ReplayPosition(segmentId=1423583589486, position=4428)
 INFO [RMI TCP Connection(6)-45.10.96.124] 2015-02-10 11:12:37,603 ColumnFamilyStore.java (line 856) Enqueuing flush of compaction_history: 412 (0%) on-heap, 328 (0%) off-heap
 INFO [CompactionExecutor:10] 2015-02-10 11:12:37,605 ColumnFamilyStore.java (line 856) Enqueuing flush of compactions_in_progress: 356 (0%) on-heap, 175 (0%) off-heap
 INFO [MemtableFlushWriter:8] 2015-02-10 11:12:37,605 Memtable.java (line 326) Writing Memtable-compaction_history@1602711153(253 serialized bytes, 9 ops, 0%/0% of on/off-heap limit)
 INFO [MemtableFlushWriter:9] 2015-02-10 11:12:37,606 Memtable.java (line 326) Writing Memtable-compactions_in_progress@468406472(117 serialized bytes, 7 ops, 0%/0% of on/off-heap limit)
 INFO [MemtableFlushWriter:9] 2015-02-10 11:12:37,609 Memtable.java (line 360) Completed flushing /tmp/cassandra/data/system/compactions_in_progress-55080ab05d9c388690a4acb25fe1f77b/system-compactions_in_progress-ka-1-Data.db (145 bytes) for commitlog position ReplayPosition(segmentId=1423583589486, position=4685)
 INFO [MemtableFlushWriter:8] 2015-02-10 11:12:37,611 Memtable.java (line 360) Completed flushing /tmp/cassandra/data/system/compaction_history-b4dbb7b4dc493fb5b3bfce6e434832ca/system-compaction_history-ka-2-Data.db (239 bytes) for commitlog position ReplayPosition(segmentId=1423583589486, position=4428)
 INFO [CompactionExecutor:10] 2015-02-10 11:12:37,612 CompactionTask.java (line 138) Compacting [SSTableReader(path=&apos;/tmp/cassandra/data/ks1/cf1-63901340b13f11e48e36730c68dbc38c/ks1-cf1-ka-1-Data.db&apos;), SSTableReader(path=&apos;/tmp/cassandra/data/ks1/cf1-63901340b13f11e48e36730c68dbc38c/ks1-cf1-ka-2-Data.db&apos;)]
 INFO [CompactionExecutor:10] 2015-02-10 11:12:37,647 ColumnFamilyStore.java (line 856) Enqueuing flush of compactions_in_progress: 212 (0%) on-heap, 20 (0%) off-heap
 INFO [MemtableFlushWriter:9] 2015-02-10 11:12:37,648 Memtable.java (line 326) Writing Memtable-compactions_in_progress@359614352(0 serialized bytes, 1 ops, 0%/0% of on/off-heap limit)
 INFO [MemtableFlushWriter:9] 2015-02-10 11:12:37,650 Memtable.java (line 360) Completed flushing /tmp/cassandra/data/system/compactions_in_progress-55080ab05d9c388690a4acb25fe1f77b/system-compactions_in_progress-ka-2-Data.db (42 bytes) for commitlog position ReplayPosition(segmentId=1423583589486, position=4756)
ERROR [CompactionExecutor:10] 2015-02-10 11:12:37,655 CassandraDaemon.java (line 166) Exception in thread Thread[CompactionExecutor:10,1,RMI Runtime]
java.lang.RuntimeException: Last written key DecoratedKey(135414706852123109601202796181083437879, 800100) &amp;gt;= current key DecoratedKey(135414706852123109601202796181083437879, 800100) writing into /tmp/cassandra/data/ks1/cf1-63901340b13f11e48e36730c68dbc38c/ks1-cf1-tmp-ka-3-Data.db
        at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:172) ~[apache-cassandra-2.1.0.jar:2.1.0]
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:196) ~[apache-cassandra-2.1.0.jar:2.1.0]
        at org.apache.cassandra.io.sstable.SSTableRewriter.append(SSTableRewriter.java:110) ~[apache-cassandra-2.1.0.jar:2.1.0]
        at org.apache.cassandra.db.compaction.CompactionTask.runWith(CompactionTask.java:177) ~[apache-cassandra-2.1.0.jar:2.1.0]
        at org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48) ~[apache-cassandra-2.1.0.jar:2.1.0]
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[apache-cassandra-2.1.0.jar:2.1.0]
        at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:74) ~[apache-cassandra-2.1.0.jar:2.1.0]
        at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59) ~[apache-cassandra-2.1.0.jar:2.1.0]
        at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:235) ~[apache-cassandra-2.1.0.jar:2.1.0]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_40]
        at java.util.concurrent.FutureTask.run(FutureTask.java:262) ~[na:1.7.0_40]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_40]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_40]
        at java.lang.Thread.run(Thread.java:724) [na:1.7.0_40]
 INFO [ScheduledTasks:1] 2015-02-10 12:12:16,529 ColumnFamilyStore.java (line 856) Enqueuing flush of sstable_activity: 900 (0%) on-heap, 4183 (0%) off-heap
 INFO [MemtableFlushWriter:10] 2015-02-10 12:12:16,530 Memtable.java (line 326) Writing Memtable-sstable_activity@2019899836(270 serialized bytes, 108 ops, 0%/0% of on/off-heap limit)
 INFO [MemtableFlushWriter:10] 2015-02-10 12:12:16,534 Memtable.java (line 360) Completed flushing /tmp/cassandra/data/system/sstable_activity-5a1ff267ace03f128563cfae6103c65e/system-sstable_activity-ka-2-Data.db (194 bytes) for commitlog position ReplayPosition(segmentId=1423583589486, position=11832)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I do a list back in cassandra-cli:&lt;br/&gt;
list cf1;&lt;br/&gt;
Using default limit of 100&lt;br/&gt;
Using default cell limit of 100&lt;br/&gt;
Invalid byte for ascii: -128&lt;/p&gt;

&lt;p&gt;(edited for formatting)&lt;/p&gt;</comment>
                            <comment id="14314521" author="krummas" created="Tue, 10 Feb 2015 17:49:49 +0000"  >&lt;p&gt;great, thanks (and it reproduces in 2.1 HEAD)&lt;/p&gt;</comment>
                            <comment id="14314582" author="krummas" created="Tue, 10 Feb 2015 18:21:02 +0000"  >&lt;p&gt;attaching script that repros this&lt;/p&gt;</comment>
                            <comment id="14314587" author="krummas" created="Tue, 10 Feb 2015 18:23:42 +0000"  >&lt;p&gt;I&apos;ll dig some more, but I suspect I will need &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; help here&lt;/p&gt;</comment>
                            <comment id="14314635" author="benedict" created="Tue, 10 Feb 2015 18:46:04 +0000"  >&lt;p&gt;Are we absolutely certain this &lt;b&gt;only&lt;/b&gt; occurs with &lt;b&gt;both&lt;/b&gt; options enabled? Is it possible to elicit the bug with only sync server and offheap_objects? It could be a straight up deterministic bug with comparison implementation in offheap_objects&lt;/p&gt;</comment>
                            <comment id="14314723" author="rbfblk" created="Tue, 10 Feb 2015 19:23:12 +0000"  >&lt;p&gt;The steps used to reproduce definitely do not elicit the bug when sync is used. Purely anecdotal, but I&apos;ve done a lot of testing with sync + offheap_objects for a couple of applications on 2.1.0 and never had this problem until we tried to change the cluster to hsha.&lt;/p&gt;</comment>
                            <comment id="14314727" author="krummas" created="Tue, 10 Feb 2015 19:23:42 +0000"  >&lt;p&gt;yes, hsha/offheap_objects seems to be the only combo this reproduces on (unless it is very non-deterministic with other setups)&lt;/p&gt;</comment>
                            <comment id="14315242" author="benedict" created="Wed, 11 Feb 2015 00:15:00 +0000"  >&lt;p&gt;I suspect this is the bug.&lt;/p&gt;</comment>
                            <comment id="14316023" author="krummas" created="Wed, 11 Feb 2015 10:54:18 +0000"  >&lt;p&gt;+1 on the patch, it does fix the issue&lt;/p&gt;

&lt;p&gt;we should also have a bunch of simple sanity-check dtests that tests the various combinations here&lt;/p&gt;</comment>
                            <comment id="14316026" author="benedict" created="Wed, 11 Feb 2015 10:56:44 +0000"  >&lt;p&gt;It would be nice if the dtests could operate over either transport, and we just ran them against both, alternating. I would quite like to see all of our tests run against a cycling range of configs. &lt;/p&gt;</comment>
                            <comment id="14344007" author="kmueller" created="Mon, 2 Mar 2015 23:33:38 +0000"  >&lt;p&gt;Is it possible to have this issue on 2.0.10? &lt;/p&gt;</comment>
                            <comment id="14344038" author="iamaleksey" created="Mon, 2 Mar 2015 23:52:56 +0000"  >&lt;p&gt;No, offheap_objects are a 2.1 feature. There might be some other source of corruption, but I doubt it&apos;s the case for the 2.0 line.&lt;/p&gt;</comment>
                            <comment id="14344077" author="kmueller" created="Tue, 3 Mar 2015 00:05:16 +0000"  >&lt;p&gt;OK, thanks. I am seeing corruption in 2.0.10, but I&apos;m not sure yet whether it&apos;s in cassandra or outside cassandra yet.&lt;/p&gt;</comment>
                            <comment id="14695267" author="saprykin" created="Thu, 13 Aug 2015 14:06:43 +0000"  >&lt;p&gt;I use Cassandra 2.0.15 and see the same exceptions during compaction&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [CompactionExecutor:682] 2015-08-13 06:01:32,127 CassandraDaemon.java (line 258) Exception in thread Thread[CompactionExecutor:682,1,main]
java.lang.RuntimeException: Last written key DecoratedKey(-2783619087451515733, 011f1683) &amp;gt;= current key DecoratedKey(-4465903128534949899, 028aa6f4) writing into /data/cassandra/test_ks/test_table/test_ks-test_table-tmp
-jb-21634-Data.db
        at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:143)
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:166)
        at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:170)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:60)
        at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59)
        at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:198)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.Thread.run(Thread.java:745)
ERROR [CompactionExecutor:679] 2015-08-13 06:03:02,232 CassandraDaemon.java (line 258) Exception in thread Thread[CompactionExecutor:679,1,main]
java.lang.RuntimeException: Last written key DecoratedKey(-2783619087451515733, 011f1683) &amp;gt;= current key DecoratedKey(-4465903128534949899, 028aa6f4) writing into /data/cassandra/test_ks/test_table/test_ks-test_table-tmp
-jb-21803-Data.db
        at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:143)
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:166)
        at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:170)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:60)
        at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59)
        at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:198)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.Thread.run(Thread.java:745)
ERROR [CompactionExecutor:682] 2015-08-13 06:04:53,801 CassandraDaemon.java (line 258) Exception in thread Thread[CompactionExecutor:682,1,main]
java.lang.RuntimeException: Last written key DecoratedKey(-2783619087451515733, 011f1683) &amp;gt;= current key DecoratedKey(-4465903128534949899, 028aa6f4) writing into /data/cassandra/test_ks/test_table/test_ks-test_table-tmp
-jb-22008-Data.db
        at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:143)
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:166)
        at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:170)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:60)
        at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59)
        at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:198)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12697928" name="8719.txt" size="663" author="benedict" created="Wed, 11 Feb 2015 00:15:00 +0000"/>
                            <attachment id="12697834" name="repro8719.sh" size="707" author="marcuse" created="Tue, 10 Feb 2015 18:21:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 14 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2536v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    <customfieldvalue id="12328951">2.1.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>