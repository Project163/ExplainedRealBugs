<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:12:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14912] LegacyLayout errors on collection tombstones from dropped columns</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14912</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When reading legacy sstables in 3.0, the dropped column records in table metadata are not checked when a collection tombstone is encountered.&#160;This means that if&#160;a collection column was dropped and a new column with the same name but a non-collection type subsequently added prior to upgrading to 3.0, reading any sstables containing the collection data will error. This includes reads done by upgradesstables, which makes recovery from this situation without losing data impossible. Scrub will clean the affected tables, but any valid data will also be discarded.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13200622">CASSANDRA-14912</key>
            <summary>LegacyLayout errors on collection tombstones from dropped columns</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="samt">Sam Tunnicliffe</reporter>
                        <labels>
                    </labels>
                <created>Mon, 26 Nov 2018 17:04:24 +0000</created>
                <updated>Fri, 2 Aug 2019 02:44:04 +0000</updated>
                            <resolved>Wed, 28 Nov 2018 16:15:57 +0000</resolved>
                                        <fixVersion>3.0.18</fixVersion>
                    <fixVersion>3.11.4</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="16700366" author="beobal" created="Tue, 27 Nov 2018 12:43:34 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/14912-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;14912-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/beobal/workflows/cassandra/tree/cci%2F14912-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/14912-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;14912-3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/beobal/workflows/cassandra/tree/cci%2F14912-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16700470" author="benedict" created="Tue, 27 Nov 2018 14:08:49 +0000"  >&lt;p&gt;I think this is related to&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14749&quot; title=&quot;Collection Deletions for Dropped Columns in 2.1/3.0 mixed-mode can delete rows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14749&quot;&gt;&lt;del&gt;CASSANDRA-14749&lt;/del&gt;&lt;/a&gt;; basically I didn&apos;t properly fix it for a drop and re-add of different type.&lt;/p&gt;

&lt;p&gt;Should a&#160;fix also&#160;go &lt;a href=&quot;https://github.com/apache/cassandra/blob/06c55f779ae68de98cce531e0b78be5716849003/src/java/org/apache/cassandra/db/LegacyLayout.java#L217&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;? &#160;We could simply check that the column definition is&#160;a collection, and perhaps also (if we wanted to be super paranoid) that the type is compatible.&lt;/p&gt;

&lt;p&gt;Checking the dropped time is also a great additional check, but&#160;it doesn&apos;t necessarily seem as robust,&#160;given clock drift.&lt;/p&gt;</comment>
                            <comment id="16700637" author="beobal" created="Tue, 27 Nov 2018 16:12:03 +0000"  >&lt;p&gt;Adding the check to &lt;tt&gt;LegacyLayout::decodeBound&lt;/tt&gt; seems reasonable as an extra safety check, but it wouldn&#8217;t make a difference in this case as we&#8217;d then fetch the dropped column definition and proceed as before to construct the bound. We could also check that the dropped column def was a collection and throw if not, but that&#8217;s a slightly different bug IMO.&lt;/p&gt;

&lt;p&gt;The dropped time check is what&apos;s really required otherwise we don&apos;t properly filter data from sstables written before the schema changes happened. Maybe I&apos;m misunderstanding what you mean here about it not being terribly robust, but this is the mechanism by which we filter such atoms (or simple/complex columns) in both the legacy and non-legacy cases. I agree that it&#8217;s not perfect wrt to clock drift btw, just that it&#8217;s the only method we have AFAIK for handling dropped columns.&lt;/p&gt;</comment>
                            <comment id="16700639" author="iamaleksey" created="Tue, 27 Nov 2018 16:13:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; +1&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Sam is about to reply, but I think we are actually good there.&lt;/p&gt;</comment>
                            <comment id="16700661" author="iamaleksey" created="Tue, 27 Nov 2018 16:23:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;Adding the check to LegacyLayout::decodeBound seems reasonable as an extra safety check, but it wouldn&#8217;t make a difference in this case as we&#8217;d then fetch the dropped column definition and proceed as before to construct the bound. We could also check that the dropped column def was a collection and throw if not, but that&#8217;s a slightly different bug IMO.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Additionally, it can easily and legally be &lt;tt&gt;BytesType&lt;/tt&gt;, as we used to not to bother to record dropped types in 2.1, so we cannot really reliably tell. But also we don&apos;t need to, as this should work out just fine either way.&lt;/p&gt;</comment>
                            <comment id="16700705" author="benedict" created="Tue, 27 Nov 2018 16:53:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;this is the mechanism by which we filter such atoms (or simple/complex columns) in both the legacy and non-legacy cases&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;So, I agree that this bug probably also exists for our non-legacy&#160;handling of complex tombstones.&lt;/p&gt;

&lt;p&gt;But our regular atom dropping is only expected to be a &apos;best effort&apos; to prevent dropped data making it to the client. &#160;This bug seems to be&#160;about preventing data being entirely unavailable&#160;because the &lt;tt&gt;ColumnDefinition&lt;/tt&gt;&#160;is incorrect (i.e. not a complex column)?&lt;/p&gt;

&lt;p&gt;So surely specifically checking the condition that causes the failure, i.e. that&#160;we&apos;re building a tombstone with a non-complex column, is the robust solution to preventing this unavailable data?&lt;/p&gt;

&lt;p&gt;I agree that filtering it downstream based on dropped time is also beneficial, but in&#160;preventing this specific failure it seems to be either superfluous or insufficient in some cases?&lt;/p&gt;</comment>
                            <comment id="16700735" author="beobal" created="Tue, 27 Nov 2018 17:13:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;So surely specifically checking the condition that causes the failure, i.e. that we&apos;re building a tombstone with a non-complex column, is the robust solution to preventing this unavailable data?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do you mean changing &lt;tt&gt;decodeBound&lt;/tt&gt; to do something like return null or a special value in such cases and having its callers handle that? It can&apos;t throw in situations like this or else we&apos;re no better off than we are currently as the row containing the collection tombstone would still be unreadable.&lt;/p&gt;</comment>
                            <comment id="16700761" author="benedict" created="Tue, 27 Nov 2018 17:30:52 +0000"  >&lt;p&gt;I &lt;em&gt;think&lt;/em&gt;&#160;the easiest fix for preventing the exception&#160;is to simply return a RT bound where the &lt;tt&gt;ColumnDefinition&lt;/tt&gt;&#160;is definitely complex?&lt;/p&gt;

&lt;p&gt;This might mean we return a RT that covers a non-existent column, but with your change we &lt;b&gt;should&lt;/b&gt; filter that out. &#160;But if we don&apos;t, that&apos;s fine, it&apos;s only a best effort, and it won&apos;t&#160;actually cause us any problems.&lt;/p&gt;

&lt;p&gt;FWIW, I&apos;ve tried this change to confirm it works &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/14912-3.0-suggest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16701897" author="beobal" created="Wed, 28 Nov 2018 13:44:09 +0000"  >&lt;p&gt;Adding the first &lt;tt&gt;isComplex&lt;/tt&gt; check (as per your branch) does help here because the dropped definition is complex. Adding the second &lt;tt&gt;isComplex&lt;/tt&gt; check on that and constructing a fake definition if it isn&apos;t is probably worth it to deal with the rare case where a column has been dropped and re-added multiple times. Pushed a second commit with those additions &amp;amp; the test extended to cover them.&lt;/p&gt;

&lt;p&gt;Although we &lt;b&gt;could&lt;/b&gt; live without the &lt;tt&gt;isDroppedComplexDeletion&lt;/tt&gt; check, I&apos;ve left it in and extended the test to check both when it fails and succeeds. Though this does make the verification of results somewhat finicky, it&apos;s maybe useful in documenting the expected behaviour in these edge cases.&lt;/p&gt;</comment>
                            <comment id="16701910" author="benedict" created="Wed, 28 Nov 2018 13:50:30 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16702085" author="beobal" created="Wed, 28 Nov 2018 16:15:57 +0000"  >&lt;p&gt;Thanks, committed to 3.0 in &lt;tt&gt;0a7fbee43f25b6ad3172825cd29bae455223ab33&lt;/tt&gt; and merged to 3.11 and trunk (with &lt;tt&gt;-s ours&lt;/tt&gt;)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12986" cascade-level="1"><![CDATA[Recoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12977"><![CDATA[Adhoc Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|s00ve0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>