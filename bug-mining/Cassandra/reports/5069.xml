<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14638] Column result order can change in &apos;SELECT *&apos; results when upgrading from 2.1 to 3.0 causing response corruption for queries using prepared statements when static columns are used</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14638</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When performing an upgrade from C* 2.1.20 to 3.0.17 I observed that the order of columns returned from a &apos;SELECT *&apos; query changes, particularly when static columns are involved.&lt;/p&gt;

&lt;p&gt;This may not seem like that much of a problem, however if using Prepared Statements, any clients that remain connected during the upgrade may encounter issues consuming results from these queries, as data is reordered and the client not aware of it.&#160; The result definition is sent in the original prepared statement response, so if order changes the client has no way of knowing (until C* 4.0 via &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10786&quot; title=&quot;Include hash of result set metadata in prepared statement id&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10786&quot;&gt;&lt;del&gt;CASSANDRA-10786&lt;/del&gt;&lt;/a&gt;) without re-preparing, which is non-trivial as most client drivers cache prepared statements.&lt;/p&gt;

&lt;p&gt;This could lead to reading the wrong values for columns, which could result in some kind of deserialization exception or if the data types of the switched columns are compatible, the wrong values.&#160; This happens even if the client attempts to retrieve a column value by name (i.e. row.getInt(&quot;colx&quot;)).&lt;/p&gt;

&lt;p&gt;Unfortunately I don&apos;t think there is an easy fix for this.&#160; If the order was changed back to the previous format, you risk issues for users upgrading from older 3.0 version.&#160; I think it would be nice to add a note in the NEWS file in the 3.0 upgrade section that describes this issue, and how to work around it (specify all column names of interest explicitly in query).&lt;/p&gt;

&lt;p&gt;Example schema and code to reproduce:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;create keyspace ks with replication = {&apos;class&apos;: &apos;SimpleStrategy&apos;, &apos;replication_factor&apos;: 1};

create table ks.tbl (p0 text,
  p1 text,
  m map&amp;lt;text, text&amp;gt; static,
  t text,
  u text static,
  primary key (p0, p1)
);

insert into ks.tbl (p0, p1, m, t, u) values (&apos;p0&apos;, &apos;p1&apos;, { &apos;m0&apos; : &apos;m1&apos; }, &apos;t&apos;, &apos;u&apos;);&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;When querying with 2.1 you&apos;ll observe the following order via cqlsh:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; p0 | p1 | m            | u | t
----+----+--------------+---+---
 p0 | p1 | {&apos;m0&apos;: &apos;m1&apos;} | u | t&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;With 3.0, observe that u and m are transposed:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&#160;p0 | p1 | u | m&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; | t
----+----+---+--------------+---
&#160;p0 | p1 | u | {&apos;m0&apos;: &apos;m1&apos;} | t&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.datastax.driver.core.BoundStatement;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.datastax.driver.core.Cluster;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.datastax.driver.core.ColumnDefinitions;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.datastax.driver.core.PreparedStatement;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.datastax.driver.core.ResultSet;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.datastax.driver.core.Row;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.datastax.driver.core.Session;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.google.common.util.concurrent.Uninterruptibles;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.concurrent.TimeUnit;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LiveUpgradeTest {

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; args[]) {
    Cluster cluster = Cluster.builder().addContactPoints(&lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;).build();
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      Session session = cluster.connect();
      PreparedStatement p = session.prepare(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * from ks.tbl&quot;&lt;/span&gt;);

      BoundStatement bs = p.bind();

      &lt;span class=&quot;code-comment&quot;&gt;// continually query every 30 seconds
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;) {
        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
          ResultSet r = session.execute(bs);
          Row row = r.one();
          &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0;
          &lt;span class=&quot;code-comment&quot;&gt;// iterate over the result metadata in order printing the
&lt;/span&gt;          &lt;span class=&quot;code-comment&quot;&gt;// index, name, type, and length of the first row of data.
&lt;/span&gt;          &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (ColumnDefinitions.Definition d : r.getColumnDefinitions()) {
            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(
                i++
                    + &lt;span class=&quot;code-quote&quot;&gt;&quot;: &quot;&lt;/span&gt;
                    + d.getName()
                    + &lt;span class=&quot;code-quote&quot;&gt;&quot; -&amp;gt; &quot;&lt;/span&gt;
                    + d.getType()
                    + &lt;span class=&quot;code-quote&quot;&gt;&quot; -&amp;gt; val = &quot;&lt;/span&gt;
                    + row.getBytesUnsafe(d.getName()).array().length);
          }
        } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Throwable t) {
          t.printStackTrace();
        } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
          Uninterruptibles.sleepUninterruptibly(30, TimeUnit.SECONDS);
        }
      }
    } &lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt; {
      cluster.close();
    }
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;To reproduce, set up a cluster, the schema, and run this script.&#160; Then upgrade the cluster to 3.0.17 (with ccm, ccm stop; ccm node1 setdir -v 3.0.17; ccm start works) and observe after the client is able to reconnect that the results are in a different order.&#160; i.e.:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;With 2.x:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;0: p0 -&amp;gt; varchar -&amp;gt; val = 2
1: p1 -&amp;gt; varchar -&amp;gt; val = 2
2: m -&amp;gt; map&amp;lt;varchar, varchar&amp;gt; -&amp;gt; val = 16
3: u -&amp;gt; varchar -&amp;gt; val = 1
4: t -&amp;gt; varchar -&amp;gt; val = 1&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;With 3.x:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;0: p0 -&amp;gt; varchar -&amp;gt; val = 2
1: p1 -&amp;gt; varchar -&amp;gt; val = 2
2: m -&amp;gt; map&amp;lt;varchar, varchar&amp;gt; -&amp;gt; val = 1
3: u -&amp;gt; varchar -&amp;gt; val = 16 (&amp;lt;-- the data for &apos;m&apos; is now at index 3)
4: t -&amp;gt; varchar -&amp;gt; val = 1&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Single C* node ccm cluster upgraded from C* 2.1.20 to 3.0.17&lt;/p&gt;</environment>
        <key id="13178327">CASSANDRA-14638</key>
            <summary>Column result order can change in &apos;SELECT *&apos; results when upgrading from 2.1 to 3.0 causing response corruption for queries using prepared statements when static columns are used</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="andrew.tolbert">Andy Tolbert</reporter>
                        <labels>
                    </labels>
                <created>Fri, 10 Aug 2018 17:13:55 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:57 +0000</updated>
                            <resolved>Thu, 16 Aug 2018 14:50:06 +0000</resolved>
                                        <fixVersion>3.0.18</fixVersion>
                    <fixVersion>3.11.4</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>CQL/Interpreter</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="16581293" author="iamaleksey" created="Wed, 15 Aug 2018 16:12:20 +0000"  >&lt;p&gt;Unfortunately this is an accidental, lower level bug in 3.0, that I believe should be fixed in the next minor.&lt;/p&gt;

&lt;p&gt;The internal contract for wildcard order in 2.1, and, really, everywhere since introduction of static columns is the following:&lt;br/&gt;
1. Partition key columns in their positional order&lt;br/&gt;
2. Clustering columns in their positional order&lt;br/&gt;
3. All static columns, ordered alphabetically by name, irregardless of whether they are simple or complex&lt;br/&gt;
4. All regular columns, ordered alphabetically by name, irregardless of whether they are simple or complex&lt;/p&gt;

&lt;p&gt;To illustrate, let&apos;s say we have a table defined as&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE ks.tbl (p0 text, p1 text, a set&amp;lt;text&amp;gt;, b set&amp;lt;text&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, c text, d text &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, e set&amp;lt;text&amp;gt;, f set&amp;lt;text&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, g text, h text &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, i set&amp;lt;text&amp;gt;, j set&amp;lt;text&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, PRIMARY KEY (p0, p1));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And one inserted row:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INSERT INTO ks.tbl (p0, p1, a, b, c, d, e, f, g, h, i, j) VALUES (&lt;span class=&quot;code-quote&quot;&gt;&apos;p0&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;p1&apos;&lt;/span&gt;, {&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;}, {&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;}, &lt;span class=&quot;code-quote&quot;&gt;&apos;c&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;d&apos;&lt;/span&gt;, {&lt;span class=&quot;code-quote&quot;&gt;&apos;e&apos;&lt;/span&gt;}, {&lt;span class=&quot;code-quote&quot;&gt;&apos;f&apos;&lt;/span&gt;}, &lt;span class=&quot;code-quote&quot;&gt;&apos;g&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;h&apos;&lt;/span&gt;, {&lt;span class=&quot;code-quote&quot;&gt;&apos;i&apos;&lt;/span&gt;}, {&lt;span class=&quot;code-quote&quot;&gt;&apos;j&apos;&lt;/span&gt;});
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In 2.1, performing a &lt;tt&gt;SELECT * FROM ks.tbl;&lt;/tt&gt; query would return the following result set:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 p0 | p1 | b     | d | f     | h | j     | a     | c | e     | g | i
----+----+-------+---+-------+---+-------+-------+---+-------+---+-------
 p0 | p1 | {&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;} | d | {&lt;span class=&quot;code-quote&quot;&gt;&apos;f&apos;&lt;/span&gt;} | h | {&lt;span class=&quot;code-quote&quot;&gt;&apos;j&apos;&lt;/span&gt;} | {&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;} | c | {&lt;span class=&quot;code-quote&quot;&gt;&apos;e&apos;&lt;/span&gt;} | g | {&lt;span class=&quot;code-quote&quot;&gt;&apos;i&apos;&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;3.0, in contrast, would return the following result set:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 p0 | p1 | d | h | b     | f     | j     | a     | c | e     | g | i
----+----+---+---+-------+-------+-------+-------+---+-------+---+-------
 p0 | p1 | d | h | {&lt;span class=&quot;code-quote&quot;&gt;&apos;b&apos;&lt;/span&gt;} | {&lt;span class=&quot;code-quote&quot;&gt;&apos;f&apos;&lt;/span&gt;} | {&lt;span class=&quot;code-quote&quot;&gt;&apos;j&apos;&lt;/span&gt;} | {&lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;} | c | {&lt;span class=&quot;code-quote&quot;&gt;&apos;e&apos;&lt;/span&gt;} | g | {&lt;span class=&quot;code-quote&quot;&gt;&apos;i&apos;&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Both correctly return &lt;tt&gt;PRIMARY KEY&lt;/tt&gt; columns in their defined order first, then all the static columns (although 3.0 order for them is all wrong), followed by all regular columns in alphabetic order, correct in both 2.1 and 3.0.&lt;/p&gt;

&lt;p&gt;What 3.0 does incorrectly is ordering the static columns it returns. Instead of merging simple and complex static columns, we are getting all simple static columns first, followed by all complex static columns.&lt;/p&gt;

&lt;p&gt;The bug is deep in &lt;tt&gt;Columns&lt;/tt&gt; class, more specifically in &lt;tt&gt;findFirstComplexIdx()&lt;/tt&gt; method. To find the first complex column index we are using a surrogate &lt;tt&gt;ColumnDefinition&lt;/tt&gt; value &lt;tt&gt;FIRST_COMPLEX&lt;/tt&gt;, which is of kind &lt;tt&gt;REGULAR&lt;/tt&gt; for &lt;tt&gt;Columns&lt;/tt&gt; of both &lt;tt&gt;REGULAR&lt;/tt&gt; and &lt;tt&gt;STATIC&lt;/tt&gt; kinds. This quite clearly breaks &lt;tt&gt;Columns&lt;/tt&gt; of kind &lt;tt&gt;STATIC&lt;/tt&gt;, making the container believe that all of its columns are &lt;tt&gt;COMPLEX&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16581299" author="iamaleksey" created="Wed, 15 Aug 2018 16:14:40 +0000"  >&lt;p&gt;Proposed work-in-progress fix (test coverage pending) that addresses the underlying issue can be found &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/14638-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, with CI upcoming &lt;a href=&quot;https://circleci.com/workflow-run/55195e85-6d1a-4864-8c0f-ca656b843f56&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16581304" author="iamaleksey" created="Wed, 15 Aug 2018 16:22:24 +0000"  >&lt;blockquote&gt;&lt;p&gt;Unfortunately I don&apos;t think there is an easy fix for this.  If the order was changed back to the previous format, you risk issues for users upgrading from older 3.0 version.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is true. That said, there are huge fleets still on 2.1 and 2.2 in the wild, so leaving this unfixed is also a choice that puts some users in potential danger.&lt;/p&gt;

&lt;p&gt;Our internal contract is quite clear, and is quite clearly broken. I would prefer to address it here and now, rather than maintaining broken behaviour just for the sake of it. For the record, here are the relevant bits:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    /**
     * An iterator that returns the columns of &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; object in &lt;span class=&quot;code-quote&quot;&gt;&quot;select&quot;&lt;/span&gt; order (that
     * is in global alphabetical order, where the &lt;span class=&quot;code-quote&quot;&gt;&quot;normal&quot;&lt;/span&gt; iterator returns simple
     * columns first and the complex second).
     *
     * @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; an iterator returning columns in alphabetical order.
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; Iterator&amp;lt;ColumnDefinition&amp;gt; selectOrderIterator()
    {
        &lt;span class=&quot;code-comment&quot;&gt;// In wildcard selection, we want to &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; all columns in alphabetical order,
&lt;/span&gt;        &lt;span class=&quot;code-comment&quot;&gt;// irregarding of whether they are complex or not
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Iterators.mergeSorted(ImmutableList.of(complexColumns(), simpleColumns()),
                                     (s, c) -&amp;gt;
                                     {
                                         &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; !s.kind.isPrimaryKeyKind();
                                         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; s.name.bytes.compareTo(c.name.bytes);
                                     });
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The contact has been defined this way since 2.0, when static columns where introduced, and was broken relatively recently when 3.0 came out. I would argue that the correct thing to do is to fix it in the next 3.0 and 3.11 minors, with a loud NEWS.txt entry and an email to dev@ and users@ warning users who are both on 2.1/2.2 and 3.0+ and up about the current breakage and the upcoming fix.&lt;/p&gt;</comment>
                            <comment id="16581341" author="iamaleksey" created="Wed, 15 Aug 2018 16:51:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; I assume you may have an opinion on this. If so, please share.&lt;/p&gt;</comment>
                            <comment id="16581351" author="JIRAUSER308715" created="Wed, 15 Aug 2018 17:03:34 +0000"  >&lt;p&gt;I would think we should be able to do a protocol version bump or something and know &quot;when talking to X put them in this order, when talking to Y put them in this other order&quot;, such that we do not break things with current 3.0 and 3.11 nodes on upgrade?&lt;/p&gt;</comment>
                            <comment id="16581355" author="andrew.tolbert" created="Wed, 15 Aug 2018 17:05:55 +0000"  >&lt;blockquote&gt;
&lt;p&gt;What 3.0 does incorrectly is ordering the static columns it returns. Instead of merging simple and complex static columns, we are getting all simple static columns first, followed by all complex static columns.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ah, that explains it!  Thanks for looking into this.  I was trying to understand why it was ordering the static columns the way it was, that makes sense.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;This is true. That said, there are huge fleets still on 2.1 and 2.2 in the wild, so leaving this unfixed is also a choice that puts some users in potential danger.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s a great point.  We need to balance the risk between users upgrading from 2.x to those upgrading from previous 3.x versions.  I may not have the best sense of which should win out, but I think I agree that if we can make it consistent and work the way it did pre-3.0, that is probably for the best long term.&lt;/p&gt;</comment>
                            <comment id="16581383" author="benedict" created="Wed, 15 Aug 2018 17:24:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjordan&quot; class=&quot;user-hover&quot; rel=&quot;jjordan&quot;&gt;jjordan&lt;/a&gt;:  there is no well defined behaviour for a client version, only for a C* version, so unless we reject all connections from older client versions (which would be unacceptable) I don&apos;t think this buys us much.  &lt;/p&gt;

&lt;p&gt;The only properly backward compatible solution I can imagine would be extremely costly, i.e. on startup, fetch all prepared statements from other nodes in the cluster, and persist the UUID and the version it was prepared against, and forever more treat this statement as that select order.  Even this would not be perfect, as there&apos;s the possibility of a statement falling out of cache.&lt;/p&gt;

&lt;p&gt;Another option would be to roll the hash of all prepared statements, just once, so that submitting the query to an upgraded node would return NOT_PREPARED, but this would cause a lot of re-prepare traffic during upgrade and I&apos;m not sure all clients would handle this gracefully (they may assume, for instance, that the UUID does not change when the statement is re-prepared).&lt;/p&gt;

&lt;p&gt;I don&apos;t think there&apos;s a neat solution to this, though I&apos;m happy to be proven wrong.&lt;/p&gt;</comment>
                            <comment id="16581386" author="jjirsa" created="Wed, 15 Aug 2018 17:26:32 +0000"  >&lt;p&gt;We&apos;re talking about this in the context of prepared statements, but even if you roll the hash to force a re-prepare, someone who&apos;s fetching by index will still be surprised if we re-order the index, and that&apos;s protocol and driver independent.&lt;/p&gt;</comment>
                            <comment id="16581394" author="benedict" created="Wed, 15 Aug 2018 17:32:36 +0000"  >&lt;p&gt;Very true, and they&apos;re basically a lost cause.  The only way to fix for them would be to cement the column order at the point of upgrade for all queries in perpetuity (i.e., if 2.1-&amp;gt;fixed 3.0, use original; if broken 3.0-&amp;gt;fixed 3.0, use new broken order), and even this wouldn&apos;t fix applications that were running through an upgrade from 2.1 -&amp;gt; broken 3.0.  It would also mean docs couldn&apos;t say what the column order was defined as!&lt;/p&gt;

&lt;p&gt;All in all, I think the best option is to &quot;fix the bug&quot; and leave it at that.  It&apos;s dissatisfying, but it does put a clean end to the problem.&lt;/p&gt;</comment>
                            <comment id="16581411" author="JIRAUSER308715" created="Wed, 15 Aug 2018 17:53:22 +0000"  >&lt;p&gt;I was just thinking for the internode part. Back to clients I can&#8217;t think of a good way either.&lt;/p&gt;</comment>
                            <comment id="16581459" author="iamaleksey" created="Wed, 15 Aug 2018 18:31:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;I was just thinking for the internode part.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Luckily internode messaging is not affected by this bug.&lt;/p&gt;</comment>
                            <comment id="16581500" author="iamaleksey" created="Wed, 15 Aug 2018 19:13:38 +0000"  >&lt;p&gt;Branches with the fix for &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/14638-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/14638-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;, and &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/14638-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;. CI, respectively: &lt;a href=&quot;https://circleci.com/workflow-run/6be0f2b2-292c-4c9e-81fe-a1b90a86421e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/workflow-run/a771039b-aa8f-4eea-a268-822c759a1c8e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;, and &lt;a href=&quot;https://circleci.com/workflow-run/ce2620d7-2317-43ef-8f96-90d4f53ee175&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16582078" author="slebresne" created="Thu, 16 Aug 2018 07:28:23 +0000"  >&lt;p&gt;I agree both that this is unfortunate, and that I don&apos;t see any reasonable backward compatible option. And I&apos;m also in favor or restoring the pre-3.0 order, partly because this is indeed the order we&apos;ve used for the longest, but mainly because it doesn&apos;t make sense to have inconsistent ordering for static and normal columns.&lt;/p&gt;

&lt;p&gt;I would also argue that relying that strongly on the order of columns of a &lt;tt&gt;SELECT *&lt;/tt&gt; is a bad&#160;idea in the first place, and to the best of my knowledge, no official documentation has ever pretended that the order was guaranteed (don&apos;t get me wrong, this is a weak argument in that our documentation are historically bad and if we were to guarantee only what is documented, we wouldn&apos;t be guaranteeing much; still, it would clearly have been worth if we had ever documented the order as guaranteed), so hopefully this won&apos;t break too many users. In fact, on top of the big fat NEWS entry already mentioned, I&apos;d be in favor of updating the documentation to explicitly mention that the order of columns is not specified and not guaranteed to be stable, and should thus not be relied on. &lt;/p&gt;</comment>
                            <comment id="16582322" author="benedict" created="Thu, 16 Aug 2018 10:19:44 +0000"  >&lt;p&gt;The patch looks good to me, so I&apos;d be happy to commit as-is.  &lt;/p&gt;

&lt;p&gt;There is an alternative approach that might be simpler, or at least fewer edits; namely, to modify findFirstComplexId to auto-detect isStatic, and avoid the caller worrying about the distinction.  Since we already get the end ColumnDefinition to avoid a binary search in the case there are no complex cells, we can also extract its Kind for (almost) free.&lt;/p&gt;

&lt;p&gt;There is an argument to be made either way, since we implicitly require that you never mix regular and static columns in one of these collections, but presently never actually impose it either semantically or via assertion.&lt;/p&gt;</comment>
                            <comment id="16582451" author="iamaleksey" created="Thu, 16 Aug 2018 12:37:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; That&apos;s indeed better and less invasive. Force-pushed the new version, updated CI links in-place in the previous comment.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Agreed on all points. Updated documentation in the v2 of the patch.&lt;/p&gt;</comment>
                            <comment id="16582609" author="benedict" created="Thu, 16 Aug 2018 14:40:24 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16582623" author="iamaleksey" created="Thu, 16 Aug 2018 14:49:42 +0000"  >&lt;p&gt;Cheers, committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/236c47e65ce95dcc7c8c75706715b5a2a88fd237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;236c47e65ce95dcc7c8c75706715b5a2a88fd237&lt;/a&gt; to 3.0 and merged up to 3.11 and trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12987" cascade-level="1"><![CDATA[Transient Incorrect Response]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 13 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3wxvj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>