<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:05:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13050] ReadCommand.CheckForAbort not monitoring CQL rows for range queries</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13050</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;del&gt;If I understood the iterator transformations introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9975&quot; title=&quot;Flatten Iterator call hierarchy with a shared Transformer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9975&quot;&gt;&lt;del&gt;CASSANDRA-9975&lt;/del&gt;&lt;/a&gt; correctly,&lt;/del&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11/src/java/org/apache/cassandra/db/ReadCommand.java#L541&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ReadCommand.CheckForAbort&lt;/a&gt; should apply itself before returning a partition. At the moment it is applied to row iterators for single command partitions, but for range queries &lt;del&gt;I think&lt;/del&gt; it only monitors the query progress when a new partition is iterated, not when a new row is iterated. So for large partitions, we may fail to log a query as slow, or fail to abort it if the RPC timeout is exceeded.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13028595">CASSANDRA-13050</key>
            <summary>ReadCommand.CheckForAbort not monitoring CQL rows for range queries</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="stefania">Stefania Alborghetti</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Dec 2016 06:25:24 +0000</created>
                <updated>Tue, 14 May 2019 11:08:38 +0000</updated>
                            <resolved>Fri, 23 Dec 2016 01:46:16 +0000</resolved>
                                        <fixVersion>3.10</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15753865" author="stefania" created="Fri, 16 Dec 2016 08:57:21 +0000"  >&lt;p&gt;Testing this &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...stef1927:13050-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt; with modified &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/compare/master...stef1927:13050&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; with a multiplexed run for slow queries &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/84/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and for aborted queries &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/85/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15763113" author="stefania" created="Tue, 20 Dec 2016 03:44:15 +0000"  >&lt;p&gt;I&apos;ve fixed a few problems with the previous patch and I&apos;ve multiplexed slow and aborted query tests 4 times with no failures:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/90&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/90&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/91&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/91&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/92&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/93&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-dtest-multiplex/93&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Proposed patch (it applies without conflicts to all branches):&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.X&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/tree/13050-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/tree/13050-3.X&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/tree/13050&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-13050-3.11-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-13050-3.X-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-13050-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-13050-3.11-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-13050-3.X-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-13050-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Dtests must run with this modified &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/compare/master...stef1927:13050&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; or some slow or aborted query tests may time out since we are now applying the test delay for every CQL row. Pull request for tests is &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1413&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15766063" author="stefania" created="Wed, 21 Dec 2016 04:15:19 +0000"  >&lt;p&gt;There were some failures in the unit and dtests, for example &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-13050-3.11-testall/1/testReport/junit/org.apache.cassandra.cql3/SimpleQueryTest/restrictionOnRegularColumnWithStaticColumnPresentTest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. They were caused by the fact that we no longer create a new stopping transformation when &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...stef1927:13050-3.11#diff-861bc950c82973fb8f97f179e35be7f3R544&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;applying it to the partition&lt;/a&gt;. If the previous partition is not closed, then this assertion is triggered:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;junit.framework.AssertionFailedError
	at org.apache.cassandra.db.transform.StoppingTransformation.attachTo(StoppingTransformation.java:65)
	at org.apache.cassandra.db.transform.BaseRows.add(BaseRows.java:104)
	at org.apache.cassandra.db.transform.UnfilteredRows.add(UnfilteredRows.java:44)
	at org.apache.cassandra.db.transform.Transformation.add(Transformation.java:174)
	at org.apache.cassandra.db.transform.Transformation.apply(Transformation.java:140)
	at org.apache.cassandra.db.ReadCommand$CheckForAbort.applyToPartition(ReadCommand.java:544)
	at org.apache.cassandra.db.ReadCommand$CheckForAbort.applyToPartition(ReadCommand.java:532)
	at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:96)
	at org.apache.cassandra.cql3.statements.SelectStatement.process(SelectStatement.java:761)
	at org.apache.cassandra.cql3.statements.SelectStatement.processResults(SelectStatement.java:406)
	at org.apache.cassandra.cql3.statements.SelectStatement.executeInternal(SelectStatement.java:428)
	at org.apache.cassandra.cql3.statements.SelectStatement.executeInternal(SelectStatement.java:412)
	at org.apache.cassandra.cql3.statements.SelectStatement.executeInternal(SelectStatement.java:79)
	at org.apache.cassandra.cql3.QueryProcessor.executeInternal(QueryProcessor.java:306)
	at org.apache.cassandra.cql3.CQLTester.executeFormattedQuery(CQLTester.java:768)
	at org.apache.cassandra.cql3.CQLTester.execute(CQLTester.java:756)
	at org.apache.cassandra.cql3.SimpleQueryTest.restrictionOnRegularColumnWithStaticColumnPresentTest(SimpleQueryTest.java:566)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I fixed the failures by ensuring that the previous partition is closed, but the &lt;a href=&quot;https://github.com/stef1927/cassandra/blob/13050-3.11/src/java/org/apache/cassandra/db/transform/StoppingTransformation.java#L65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;assertion&lt;/a&gt; in StoppingTransformation worries me a bit. We should perhaps change it into an error, along with the &lt;a href=&quot;https://github.com/stef1927/cassandra/blob/13050-3.11/src/java/org/apache/cassandra/db/transform/StoppingTransformation.java#L58&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;other one&lt;/a&gt; for partition iterators.&lt;/p&gt;</comment>
                            <comment id="15769607" author="ifesdjeen" created="Thu, 22 Dec 2016 09:40:12 +0000"  >&lt;p&gt;Thank you for the patch!&lt;/p&gt;

&lt;p&gt;LGTM. As regards an error logging instead of assertion, as we have discussed offline, it might be better to still keep assertions, as we may catch some bugs related to accidentally non-closed partition. Also, other instances of &lt;tt&gt;StoppingTransformation&lt;/tt&gt; are double-checked to make sure we do close them.&lt;/p&gt;

&lt;p&gt;There are some (most likely unrelated) dtest failures, so I&apos;ve re-triggered a dtest trunk build just to make sure.&lt;/p&gt;</comment>
                            <comment id="15769974" author="ifesdjeen" created="Thu, 22 Dec 2016 12:46:09 +0000"  >&lt;p&gt;All right, tests look good now (re-triggered unit tests are also all passing now!)&lt;/p&gt;</comment>
                            <comment id="15771597" author="stefania" created="Fri, 23 Dec 2016 01:46:17 +0000"  >&lt;p&gt;Thank you for the review and for following up on the tests.&lt;/p&gt;

&lt;p&gt;Committed to the 3.11 branch as 84b1725fb4c4cba4fdb94f2abdb66656a4c66ae1 and merged into 3.X and trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13233198">CASSANDRA-15126</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 47 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37oen:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>ifesdjeen</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>