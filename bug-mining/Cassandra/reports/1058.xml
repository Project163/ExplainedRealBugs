<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:22:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2950] Data from truncated CF reappears after server restart</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2950</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;ul&gt;
	&lt;li&gt;Configure 3 node cluster&lt;/li&gt;
	&lt;li&gt;Ensure the java stress tool creates Keyspace1 with RF=3&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// Run Stress Tool to generate 10 keys, 1 column
&lt;/span&gt;stress --operation=INSERT -t 2 --num-keys=50 --columns=20 --consistency-level=QUORUM --average-size-values --replication-factor=3 --create-index=KEYS --nodes=cathy1,cathy2

&lt;span class=&quot;code-comment&quot;&gt;// Verify 50 keys in CLI
&lt;/span&gt;use Keyspace1; 
list Standard1; 

&lt;span class=&quot;code-comment&quot;&gt;// TRUNCATE CF in CLI
&lt;/span&gt;use Keyspace1;
truncate counter1;
list counter1;

&lt;span class=&quot;code-comment&quot;&gt;// Run stress tool and verify creation of 1 key with 10 columns
&lt;/span&gt;stress --operation=INSERT -t 2 --num-keys=1 --columns=10 --consistency-level=QUORUM --average-size-values --replication-factor=3 --create-index=KEYS --nodes=cathy1,cathy2

&lt;span class=&quot;code-comment&quot;&gt;// Verify 1 key in CLI
&lt;/span&gt;use Keyspace1; 
list Standard1; 

&lt;span class=&quot;code-comment&quot;&gt;// Restart all three nodes
&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;// You will see 51 keys in CLI
&lt;/span&gt;use Keyspace1; 
list Standard1; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

</description>
                <environment></environment>
        <key id="12515455">CASSANDRA-2950</key>
            <summary>Data from truncated CF reappears after server restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="cdaw">Cathy Daw</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Jul 2011 20:56:33 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:54 +0000</updated>
                            <resolved>Thu, 11 Aug 2011 19:36:15 +0000</resolved>
                                        <fixVersion>0.8.5</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13071475" author="cdaw" created="Wed, 27 Jul 2011 01:37:15 +0000"  >&lt;p&gt;This is a general issue with all CF&apos;s. updating bug.&lt;/p&gt;</comment>
                            <comment id="13071479" author="cdaw" created="Wed, 27 Jul 2011 01:47:16 +0000"  >&lt;p&gt;The other permutation of this bug looked like, assuming write with CL.Q:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Insert 50 (3 nodes up)&lt;/li&gt;
	&lt;li&gt;truncate CF (3 nodes up)&lt;/li&gt;
	&lt;li&gt;Insert 1 (3 nodes up)&lt;/li&gt;
	&lt;li&gt;Bring node3 down&lt;/li&gt;
	&lt;li&gt;Delete 1  (2 nodes up)&lt;/li&gt;
	&lt;li&gt;Bring up node3 and run repair&lt;/li&gt;
	&lt;li&gt;Take down node1 and node2.&lt;/li&gt;
	&lt;li&gt;Query node3 with CL.ONE: list Standard1;  &amp;#8212; 30 rows returned&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Not sure, but this looked suspicious in my logs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; INFO 01:19:45,616 Streaming to /50.57.114.45
 INFO 01:19:45,689 Finished streaming session 698609583499991 from /50.57.107.176
 INFO 01:19:45,690 Finished streaming session 698609609994154 from /50.57.114.45
 INFO 01:19:46,501 Finished streaming repair with /50.57.114.45 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (0,56713727820156410577229101238628035242]: 0 oustanding to complete session
 INFO 01:19:46,531 Compacted to /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/Keyspace1/Standard1-tmp-g-106-Data.db.  16,646,523 to 16,646,352 (~99% of original) bytes &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 30 keys.  Time: 1,509ms.
 INFO 01:19:46,930 Finished streaming repair with /50.57.107.176 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (113427455640312821154458202477256070484,0]: 1 oustanding to complete session
 INFO 01:19:47,619 Finished streaming repair with /50.57.114.45 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (113427455640312821154458202477256070484,0]: 0 oustanding to complete session
 INFO 01:19:48,232 Finished streaming repair with /50.57.107.176 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (56713727820156410577229101238628035242,113427455640312821154458202477256070484]: 1 oustanding to complete session
 INFO 01:19:48,856 Finished streaming repair with /50.57.114.45 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (56713727820156410577229101238628035242,113427455640312821154458202477256070484]: 0 oustanding to complete session
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13081941" author="brandon.williams" created="Tue, 9 Aug 2011 21:31:48 +0000"  >&lt;p&gt;Currently, truncate does:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;force a flush&lt;/li&gt;
	&lt;li&gt;record the time&lt;/li&gt;
	&lt;li&gt;delete any sstables older than the time&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This isn&apos;t quite enough if the machine crashes shortly afterward, however, since there can be mutations present in the commitlog that were previously truncated and are now resurrected by CL replay.&lt;/p&gt;

&lt;p&gt;One thing we could do is record the truncate time for the CF in the system ks and then ignore mutations older than that, however this would require time synchronization between the client and the server to be accurate.&lt;/p&gt;</comment>
                            <comment id="13081966" author="jbellis" created="Tue, 9 Aug 2011 22:12:00 +0000"  >&lt;p&gt;but we record CL &quot;context&quot; at time of flush in the sstable it makes, and we on replay we ignore any mutations from before that position.&lt;/p&gt;

&lt;p&gt;checked and we do wait for flush to complete in truncate.&lt;/p&gt;</comment>
                            <comment id="13081969" author="brandon.williams" created="Tue, 9 Aug 2011 22:19:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;but we record CL &quot;context&quot; at time of flush in the sstable it makes, and we on replay we ignore any mutations from before that position.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think there&apos;s something wrong with that, then:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO 21:25:15,274 Replaying /var/lib/cassandra/commitlog/CommitLog-1312924388053.log
DEBUG 21:25:15,290 Replaying /var/lib/cassandra/commitlog/CommitLog-1312924388053.log starting at 0
DEBUG 21:25:15,291 Reading mutation at 0
DEBUG 21:25:15,295 replaying mutation for system.4c: {ColumnFamily(LocationInfo [47656e65726174696f6e:false:4@1312924388140000,])}
DEBUG 21:25:15,321 Reading mutation at 89
DEBUG 21:25:15,322 replaying mutation for system.426f6f747374726170: {ColumnFamily(LocationInfo [42:false:1@1312924388203,])}
DEBUG 21:25:15,322 Reading mutation at 174
DEBUG 21:25:15,322 replaying mutation for system.4c: {ColumnFamily(LocationInfo [546f6b656e:false:16@1312924388204,])}
DEBUG 21:25:15,322 Reading mutation at 270
DEBUG 21:25:15,324 replaying mutation for Keyspace1.3030: {ColumnFamily(Standard1 [C0:false:34@1312924813259,C1:false:34@1312924813260,C2:false:34@1312924813260,C3:false:34@1312924813260,C4:false:34@1312924813260,])}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The last entry there is the first of many errant mutations.&lt;/p&gt;</comment>
                            <comment id="13082379" author="jbellis" created="Wed, 10 Aug 2011 14:57:14 +0000"  >&lt;p&gt;Ah, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2419&quot; title=&quot;Risk of counter over-count when recovering commit log&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2419&quot;&gt;&lt;del&gt;CASSANDRA-2419&lt;/del&gt;&lt;/a&gt; keeps on giving...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;but we record CL &quot;context&quot; at time of flush in the sstable it makes, and we on replay we ignore any mutations from before that position.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The obvious problem with this is that the point of truncate is to blow away such sstables...  Patch attached.  Comment explains the core fix:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;// Bonus complication: since we store replay position in sstable metadata,
// truncating those sstables means we will replay any CL segments from the
// beginning if we restart before they are discarded for normal reasons
// post-truncate.  So we need to (a) force a new segment so the currently
// active one can be discarded, and (b) flush *all* CFs so that unflushed
// data in others don&apos;t keep any pre-truncate CL segments alive.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Patch also fixes the bug in ReplayManagerTruncateTest that made it miss this.&lt;/p&gt;</comment>
                            <comment id="13082430" author="slebresne" created="Wed, 10 Aug 2011 16:06:36 +0000"  >&lt;p&gt;I think the forceFlush of all the CF is not safe, because if for a given column family the memtable is clean, forceFlush will return immediately, even though there could be a memtable being flush at the same time (or pending flush). So we cannot be sure all the old segment are clean after the waitFutures (I know, it took me some time to figure out some problem with repair for this very reason when the repairs were not properly synchronized).&lt;/p&gt;

&lt;p&gt;What we would need is to add to the future we wait on the futures of all the flush being processed at that time. Sounds annoying though. &lt;/p&gt;</comment>
                            <comment id="13082431" author="brandon.williams" created="Wed, 10 Aug 2011 16:09:03 +0000"  >&lt;p&gt;+1, though this patch is against trunk, not 0.8.  Also mistakenly bumps the log4j level to debug.&lt;/p&gt;</comment>
                            <comment id="13082613" author="jbellis" created="Wed, 10 Aug 2011 19:46:08 +0000"  >&lt;p&gt;v2:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;// Bonus bonus: simply forceFlush of all the CF is not enough, because if
// for a given column family the memtable is clean, forceFlush will return
// immediately, even though there could be a memtable being flush at the same
// time.  So to guarantee that all segments can be cleaned out, we need
// &quot;waitForActiveFlushes&quot; after the new segment has been created.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13083100" author="slebresne" created="Thu, 11 Aug 2011 12:53:17 +0000"  >&lt;p&gt;Attaching a v3 that is rebased against 0.8. I&apos;ve also slightly change the logic in Truncate to submit all the flushes and then call waitForActiveFlushes, as this is slightly simpler and should work equally well as far as I can tell.&lt;br/&gt;
Apart from that, this lgtm.&lt;/p&gt;</comment>
                            <comment id="13083423" author="jbellis" created="Thu, 11 Aug 2011 19:36:15 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13083482" author="hudson" created="Thu, 11 Aug 2011 20:21:40 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #272 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/272/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/272/&lt;/a&gt;)&lt;br/&gt;
    make sure truncate clears out the commitlog&lt;br/&gt;
patch by jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2950&quot; title=&quot;Data from truncated CF reappears after server restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2950&quot;&gt;&lt;del&gt;CASSANDRA-2950&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1156763&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1156763&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/SystemTable.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/test/unit/org/apache/cassandra/db/RecoveryManagerTruncateTest.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/commitlog/CommitLog.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/ColumnFamilyStore.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12490029" name="2950-v2.txt" size="10596" author="jbellis" created="Wed, 10 Aug 2011 19:46:08 +0000"/>
                            <attachment id="12490112" name="2950-v3_0.8.patch" size="9231" author="slebresne" created="Thu, 11 Aug 2011 12:53:17 +0000"/>
                            <attachment id="12489986" name="2950.txt" size="9259" author="jbellis" created="Wed, 10 Aug 2011 14:57:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20907</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gegf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93772</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>