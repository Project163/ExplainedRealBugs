<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:10:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-153] get_key_range timeout and exception</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-153</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;My test code:&lt;/p&gt;

&lt;p&gt;		int max = 5000;		&lt;br/&gt;
		for (int a = 0; a &amp;lt; max; a++) {&lt;br/&gt;
			System.out.println(a);&lt;br/&gt;
			client.insert(&quot;Table1&quot;, &quot;k1:&quot; + a, &quot;Super1:x:x&quot;, new byte[] &lt;/p&gt;
{ (byte) 1 }
&lt;p&gt;, 0, false);&lt;br/&gt;
		}		&lt;/p&gt;

&lt;p&gt;		client.get_key_range(&quot;Table1&quot;, &quot;k1:0&quot;, &quot;k1:1000&quot;, 1000);&lt;/p&gt;

&lt;p&gt;Produces in the logs:&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;ROW-READ-STAGE:9&amp;#93;&lt;/span&gt; 2009-05-07 23:04:56,609 CassandraDaemon.java (line 61) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ROW-READ-STAGE:9,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: corrupt sstable&lt;br/&gt;
	at org.apache.cassandra.db.FileStruct.seekTo(FileStruct.java:107)&lt;br/&gt;
	at org.apache.cassandra.db.Table.getKeyRange(Table.java:905)&lt;br/&gt;
	at org.apache.cassandra.service.RangeVerbHandler.doVerb(RangeVerbHandler.java:23)&lt;br/&gt;
	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:46)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)&lt;br/&gt;
	at java.lang.Thread.run(Unknown Source)&lt;br/&gt;
Caused by: java.io.EOFException&lt;br/&gt;
	at java.io.RandomAccessFile.readUnsignedShort(Unknown Source)&lt;br/&gt;
	at java.io.DataInputStream.readUTF(Unknown Source)&lt;br/&gt;
	at java.io.RandomAccessFile.readUTF(Unknown Source)&lt;br/&gt;
	at org.apache.cassandra.io.SequenceFile$AbstractReader.getPositionFromBlockIndex(SequenceFile.java:562)&lt;br/&gt;
	at org.apache.cassandra.db.FileStruct.seekTo(FileStruct.java:86)&lt;br/&gt;
	... 6 more&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-2&amp;#93;&lt;/span&gt; 2009-05-07 23:05:01,593 Cassandra.java (line 1187) Internal error processing get_key_range&lt;br/&gt;
java.lang.RuntimeException: error reading keyrange RangeCommand(table=&apos;Table1&apos;, startWith=&apos;k1:0&apos;, stopAt=&apos;k1:1000&apos;, maxResults=1000)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy.getKeyRange(StorageProxy.java:682)&lt;br/&gt;
	at org.apache.cassandra.service.CassandraServer.get_key_range(CassandraServer.java:511)&lt;br/&gt;
	at org.apache.cassandra.service.Cassandra$Processor$get_key_range.process(Cassandra.java:1183)&lt;br/&gt;
	at org.apache.cassandra.service.Cassandra$Processor.process(Cassandra.java:805)&lt;br/&gt;
	at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:252)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)&lt;br/&gt;
	at java.lang.Thread.run(Unknown Source)&lt;br/&gt;
Caused by: java.util.concurrent.TimeoutException: Operation timed out.&lt;br/&gt;
	at org.apache.cassandra.net.AsyncResult.get(AsyncResult.java:95)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy.getKeyRange(StorageProxy.java:677)&lt;br/&gt;
	... 7 more&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12424856">CASSANDRA-153</key>
            <summary>get_key_range timeout and exception</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="nk11">nk11</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 May 2009 20:20:32 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:38 +0000</updated>
                            <resolved>Mon, 11 May 2009 23:57:32 +0000</resolved>
                                                            <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12707082" author="nk11" created="Thu, 7 May 2009 20:21:53 +0000"  >&lt;p&gt;1 node&lt;/p&gt;

&lt;p&gt;Default config except:&lt;/p&gt;

&lt;p&gt; &amp;lt;MemtableSizeInMB&amp;gt;1&amp;lt;/MemtableSizeInMB&amp;gt;&lt;br/&gt;
 &amp;lt;MemtableObjectCountInMillions&amp;gt;0.001&amp;lt;/MemtableObjectCountInMillions&amp;gt;&lt;/p&gt;</comment>
                            <comment id="12707150" author="jbellis" created="Thu, 7 May 2009 22:04:43 +0000"  >&lt;p&gt;try it with this patch.  if that doesn&apos;t work, rm -r /var/cassandra/* to reset things and try again; it&apos;s possible that you have corrupt data from a bug that is fixed now.&lt;/p&gt;</comment>
                            <comment id="12707160" author="nk11" created="Thu, 7 May 2009 22:30:24 +0000"  >&lt;p&gt;patched, rebuilded, removed var/cassandra, still failing with the same exception&lt;/p&gt;</comment>
                            <comment id="12707254" author="nk11" created="Fri, 8 May 2009 06:32:33 +0000"  >&lt;p&gt;If it helps:&lt;/p&gt;

&lt;p&gt;The exception is thrown in SequenceFile.java at line 562 in getPositionFromBlockIndex() method.&lt;/p&gt;

&lt;p&gt;     String blockIndexKey = file_.readUTF();&lt;/p&gt;

&lt;p&gt;The key is &quot;k1:0&quot; and blockIndexPosition=102016	&lt;/p&gt;

&lt;p&gt;If I do a file_.read() there I got -1 so the end of the file is reached.&lt;/p&gt;</comment>
                            <comment id="12707398" author="jbellis" created="Fri, 8 May 2009 16:18:07 +0000"  >&lt;p&gt;committed first patch.&lt;/p&gt;

&lt;p&gt;i can reproduce the exception now using a different test after one more patch to fix another bug first (attached).&lt;/p&gt;</comment>
                            <comment id="12707399" author="jbellis" created="Fri, 8 May 2009 16:18:47 +0000"  >&lt;p&gt;fix for CME during getKeyRange&lt;/p&gt;</comment>
                            <comment id="12707429" author="nk11" created="Fri, 8 May 2009 17:22:01 +0000"  >&lt;p&gt;it works&lt;/p&gt;</comment>
                            <comment id="12707528" author="nk11" created="Fri, 8 May 2009 21:02:28 +0000"  >&lt;p&gt;I spoke to soon. For 20000 keys it reproduces again...&lt;/p&gt;</comment>
                            <comment id="12707595" author="jbellis" created="Sat, 9 May 2009 01:41:24 +0000"  >&lt;p&gt;committed second patch.  still working on reading-past-EOF bug.  I think it&apos;s compaction-related.&lt;/p&gt;</comment>
                            <comment id="12708052" author="jbellis" created="Mon, 11 May 2009 14:31:03 +0000"  >&lt;p&gt;fixed two more bugs.  the first is what you were running into; SequenceFile and FileStruct both assume when seeking that the block index exists at the end of the Coordinate computed by SSTable.  But we weren&apos;t always consistent in specifying the index filename and instead of raising an error Coordinate would just return something bogus.  these are both fixed in 02.&lt;/p&gt;

&lt;p&gt;03 fixes a bug in FS iteration when no keys in the range specified exist in a given SSTable.&lt;/p&gt;</comment>
                            <comment id="12708215" author="junrao" created="Mon, 11 May 2009 20:53:29 +0000"  >&lt;p&gt;The fix in patch 0003 seems redundant. The same code is already called in advance(). The correct fix seems to be getting rid of  line&lt;br/&gt;
           saved = key;&lt;br/&gt;
in FileStructIterator().&lt;/p&gt;</comment>
                            <comment id="12708228" author="jbellis" created="Mon, 11 May 2009 21:18:41 +0000"  >&lt;p&gt;no, because then we will always skip the current key, which in the Range context is always going to be a key we are interested in (since seekTo skips all the keys we do not want, stopping when it comes to the first interesting one).&lt;/p&gt;

&lt;p&gt;saved = key&lt;/p&gt;

&lt;p&gt;in the constructor is what allows next() to return that current key.&lt;/p&gt;

&lt;p&gt;but, if seekTo actually skipped &lt;em&gt;everything&lt;/em&gt; (and current key is block index) then we don&apos;t want to include that.  that&apos;s what 0003 fixes.&lt;/p&gt;

&lt;p&gt;(I checked in case my intuition was wrong and the test_range_collation system test fails with your alternative, so they are indeed not equivalent.)&lt;/p&gt;</comment>
                            <comment id="12708252" author="junrao" created="Mon, 11 May 2009 22:39:43 +0000"  >&lt;p&gt;Ok, I understood this now. You are right and the patch looks fine. &lt;/p&gt;

&lt;p&gt;What confused me is that the iterator over FileStruct relies on a seekTo call first, which is not how a typical iterator works.&lt;/p&gt;

&lt;p&gt;I got a CME execption on testCompactions. I guess that&apos;s related to another issue you just opened.&lt;/p&gt;</comment>
                            <comment id="12708263" author="jbellis" created="Mon, 11 May 2009 23:57:32 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="12708856" author="hudson" created="Wed, 13 May 2009 09:26:39 +0000"  >&lt;p&gt;Integrated in Cassandra #73 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/73/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/73/&lt;/a&gt;)&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12407631" name="153-02.patch" size="3105" author="jbellis" created="Fri, 8 May 2009 16:18:47 +0000"/>
                            <attachment id="12407580" name="153.patch" size="2676" author="jbellis" created="Thu, 7 May 2009 22:04:43 +0000"/>
                            <attachment id="12407781" name="ASF.LICENSE.NOT.GRANTED--0001-CASSANDRA-153-unit-test-to-expose-bug-system-test-is-r.txt" size="10571" author="jbellis" created="Mon, 11 May 2009 14:28:20 +0000"/>
                            <attachment id="12407782" name="ASF.LICENSE.NOT.GRANTED--0002-cannonicalize-all-accesses-to-indexMeatdataMap.txt" size="9118" author="jbellis" created="Mon, 11 May 2009 14:28:20 +0000"/>
                            <attachment id="12407783" name="ASF.LICENSE.NOT.GRANTED--0003-check-for-at-end-of-data-in-iterator-init.txt" size="1075" author="jbellis" created="Mon, 11 May 2009 14:28:20 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19571</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fx73:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>90976</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>