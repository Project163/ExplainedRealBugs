<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:01:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10971] Compressed commit log has no backpressure and can OOM</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10971</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I validated this via a unit test that slowed the ability of the log to drain to the filesystem. The compressed commit log will keep allocating buffers pending compression until it OOMs.&lt;/p&gt;

&lt;p&gt;I have a fix that am not very happy with because the whole signal a thread to allocate a segment that depends on a resource that may not be available results in some obtuse usage of &lt;tt&gt;CompleatableFuture&lt;/tt&gt; to rendezvous available buffers with &lt;tt&gt;CommitLogSegmentManager&lt;/tt&gt; thread waiting to finish constructing a new segment. The &lt;tt&gt;CLSM&lt;/tt&gt; thread is in turn signaled by the thread(s) that actually wants to write to the next segment, but aren&apos;t able to do it themselves.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12928069">CASSANDRA-10971</key>
            <summary>Compressed commit log has no backpressure and can OOM</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aweisberg">Ariel Weisberg</assignee>
                                    <reporter username="aweisberg">Ariel Weisberg</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Jan 2016 17:37:22 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:45 +0000</updated>
                            <resolved>Wed, 16 Mar 2016 17:29:17 +0000</resolved>
                                        <fixVersion>3.0.5</fixVersion>
                    <fixVersion>3.5</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15086097" author="aweisberg" created="Wed, 6 Jan 2016 19:16:15 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...aweisberg:CASSANDRA-10971-trunk?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10971-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10971-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...aweisberg:CASSANDRA-10971-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10971-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10971-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15143072" author="jbellis" created="Thu, 11 Feb 2016 17:14:24 +0000"  >&lt;p&gt;(IMO this should be 3.x only since we have not observed it to happen in the wild.)&lt;/p&gt;

&lt;p&gt;Edit: but I&apos;m fine with doing it in 3.0.x as well.&lt;/p&gt;</comment>
                            <comment id="15150187" author="blerer" created="Wed, 17 Feb 2016 09:37:53 +0000"  >&lt;p&gt;My understanding of the problem is that in the case where the commit log cannot flush to the disk fast enough, due to the compression overhead, the &lt;tt&gt;CommitLogSegmentManager&lt;/tt&gt; will keep on creating new &lt;tt&gt;CompressedSegments&lt;/tt&gt;. As each of those segments will use a new buffer (the ones of the pool being all in use), Cassandra can run out of memory. &lt;/p&gt;

&lt;p&gt;Will it not be simpler to add backpressure by limiting the number of active segments?&lt;/p&gt;

&lt;p&gt;What I mean is, if the &lt;tt&gt;CommitLogSegmentManager&lt;/tt&gt; stops allocating new segments once a certain number of active segments has been reached, it will make the &lt;tt&gt;CommitLog.add&lt;/tt&gt; method blocking until some segments have been reclaimed. &lt;/p&gt;

&lt;p&gt;It seems to me that, even in the case of &lt;tt&gt;MemoryMappedSegment&lt;/tt&gt;, we should be able to apply back pressure, if the disk cannot handle the load. Am I wrong on that? &lt;/p&gt;

&lt;p&gt;As I am not a CommitLog expert I might have missed something.&lt;/p&gt;</comment>
                            <comment id="15152981" author="aweisberg" created="Thu, 18 Feb 2016 20:01:27 +0000"  >&lt;p&gt;The memory mapped implementation doesn&apos;t need/want to bound the number of buffers in flight. Backpressure comes from the operating system which will block writer threads when there isn&apos;t enough free memory to buffer writes.&lt;/p&gt;

&lt;p&gt;You are right that this would be simpler if the &lt;tt&gt;CLSM&lt;/tt&gt; maintained the bound. It&apos;s already being woken up every time a segment is discarded. I&apos;ll rewrite it that way. I&apos;ll only have it bound if there is comrpression.&lt;/p&gt;</comment>
                            <comment id="15153110" author="aweisberg" created="Thu, 18 Feb 2016 21:21:36 +0000"  >&lt;p&gt;Pushed an updated and much more succinct version. Tests are running now.&lt;/p&gt;</comment>
                            <comment id="15157651" author="blerer" created="Mon, 22 Feb 2016 20:32:24 +0000"  >&lt;p&gt;If I am not mistaken, a &lt;tt&gt;CompressedSegment&lt;/tt&gt; or &lt;tt&gt;FileDirectSegment&lt;/tt&gt; will release its buffer once it has been fully written to the disk whereas segments will stay active until they are recycled. By consequence, it might be better to use as limit the number of non fully written segments rather than the number of active ones. &lt;br/&gt;
It seems that it could be done by counting the number of available segments which have a non-null buffer. &lt;/p&gt;

&lt;p&gt;As a nit, I think it might be safer to use an &lt;tt&gt;instanceof FileDirectSegment&lt;/tt&gt; for &lt;tt&gt;enforceSegmentLimit&lt;/tt&gt; in trunk. In case somebody decide to add a new sub-class to &lt;tt&gt;FileDirectSegment&lt;/tt&gt; &lt;/p&gt;</comment>
                            <comment id="15157763" author="aweisberg" created="Mon, 22 Feb 2016 21:49:04 +0000"  >&lt;p&gt;I think that brings us back to where we started with the original design that asynchronously supplies the buffer when it becomes available. I think I can do it without all the {{Future}}s nonsense by poking the CLSM thread when the buffer becomes available.&lt;/p&gt;

&lt;p&gt;I need to update that version anyways because of the changes that occurred since this ticket was started.&lt;/p&gt;</comment>
                            <comment id="15158576" author="blerer" created="Tue, 23 Feb 2016 08:54:37 +0000"  >&lt;p&gt;Could we not just keep your latest design but track the number of buffers in use and use it has a limit? Something like &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:10971-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt;.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;As a nit, I think it might be safer to use an instanceof FileDirectSegment for enforceSegmentLimit in trunk. In case somebody decide to add a new sub-class to FileDirectSegment&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Forget about that, I did not read the code properly.&lt;/p&gt;</comment>
                            <comment id="15172127" author="aweisberg" created="Mon, 29 Feb 2016 16:50:05 +0000"  >&lt;p&gt;That would work. You just need to add a poke to the CLSM thread when decrementing the counter otherwise it won&apos;t know it can create the segment now. I&apos;ll get that done.&lt;/p&gt;</comment>
                            <comment id="15172141" author="aweisberg" created="Mon, 29 Feb 2016 16:58:28 +0000"  >&lt;p&gt;Ooops. I guess you don&apos;t need to since the decrement is associated with a wakeup anyways.&lt;/p&gt;</comment>
                            <comment id="15173957" author="aweisberg" created="Tue, 1 Mar 2016 16:09:37 +0000"  >&lt;p&gt;Turns out I did need to poke the CLSM thread, but it&apos;s not a big deal to pass in a handle for poking it.&lt;/p&gt;</comment>
                            <comment id="15195040" author="blerer" created="Tue, 15 Mar 2016 10:10:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; Sorry, I missed the lat ticket updates.&lt;/p&gt;

&lt;p&gt;I am +1 on the patch. I am only having an issue with &lt;tt&gt;org.apache.cassandra.db.commitlog.CommitLogTest.replay_Encrypted&lt;/tt&gt; it always timeout on CI and fail on my machine. I do not think that the patch is the reason for the problem but I will be more confident if the test was passing. Does it work on your machine? &lt;/p&gt;</comment>
                            <comment id="15195790" author="aweisberg" created="Tue, 15 Mar 2016 17:49:36 +0000"  >&lt;p&gt;I&apos;ll take a look at it. It&apos;s not passing on OS X on trunk for me at all. It does pass on Linux.&lt;/p&gt;</comment>
                            <comment id="15196029" author="aweisberg" created="Tue, 15 Mar 2016 19:28:05 +0000"  >&lt;p&gt;Have the tests running again. I think it&apos;s a test specific issue where the commit log isn&apos;t shut down correctly in the tests. Will go patch available if that fixes the issue.&lt;/p&gt;</comment>
                            <comment id="15196317" author="aweisberg" created="Tue, 15 Mar 2016 21:42:37 +0000"  >&lt;p&gt;That seems to have done it. Looks like it matches master now.&lt;/p&gt;</comment>
                            <comment id="15197690" author="blerer" created="Wed, 16 Mar 2016 17:07:24 +0000"  >&lt;p&gt;I ran the tests on CI for 3.5 and they were flapping.&lt;br/&gt;
I add a look at the tests and found 2 problems:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Some tests were using &lt;tt&gt;new CommitLog()&lt;/tt&gt; with the same directory that &lt;tt&gt;CommitLog.INSTANCE&lt;/tt&gt; which was causing 2 commit log instance to run at the same time with 2 differents configurations. This was resulting on some commit log files not being deleted for the &lt;tt&gt;replay_StandardMmapped&lt;/tt&gt; test.&lt;/li&gt;
	&lt;li&gt;As the unit tests are run in random orders the configuration changes made by the compression and encrytion tests were affecting other test when &lt;tt&gt;resetUnsafe&lt;/tt&gt; was used.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I fixed the problems by using only &lt;tt&gt;CommitLog.INSTANCE&lt;/tt&gt; in all the tests and restoring the initial configuration parameters after each test that was modifying them.&lt;/p&gt;

&lt;p&gt;Ran the test on CI and it looks that we are good to go. \o/  &lt;br/&gt;
Thanks for all the work &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15197694" author="blerer" created="Wed, 16 Mar 2016 17:09:38 +0000"  >&lt;p&gt;Attached the latest patches.&lt;/p&gt;</comment>
                            <comment id="15197740" author="blerer" created="Wed, 16 Mar 2016 17:29:17 +0000"  >&lt;p&gt;Committed into 3.0 at 9995521fb9b3f510ee9c7012d75e6970ec7d5fb7 and into 3.5 at ee40e3b4529aa77d4d83fc3e7073902402cb3753.&lt;br/&gt;
Merged into trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12793793" name="10971-3.0.txt" size="13682" author="blerer" created="Wed, 16 Mar 2016 17:09:38 +0000"/>
                            <attachment id="12793794" name="10971-3.5.txt" size="23098" author="blerer" created="Wed, 16 Mar 2016 17:09:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2qxwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>