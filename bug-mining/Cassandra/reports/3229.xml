<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8211] Overlapping sstables in L1+</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8211</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Seems we have a bug that can create overlapping sstables in L1:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WARN [main] 2014-10-28 04:09:42,295 LeveledManifest.java (line 164) At level 2, SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;sstable&amp;gt;&apos;&lt;/span&gt;) [DecoratedKey(2838397575996053472, 00
10000000001111000000000000066059b200001000000000066059b200000000111100000000100000000000004000000000000000000100), DecoratedKey(5516674013223138308, 001000000000111100000000000000ff2d160000100000000000ff2d1600000
000111100000000100000000000004000000000000000000100)] overlaps SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;&amp;lt;sstable&amp;gt;&apos;&lt;/span&gt;) [DecoratedKey(2839992722300822584, 00100000000011110000
0000000000229ad20000100000000000229ad200000000111100000000100000000000004000000000000000000100), DecoratedKey(5532836928694021724, 0010000000001111000000000000034b05a600001000000000034b05a600000000111100000000100
000000000004000000000000000000100)].  This could be caused by a bug in Cassandra 1.1.0 .. 1.1.3 or due to the fact that you have dropped sstables from another node into the data directory. Sending back to L0.  If
 you didn&apos;t drop in sstables, and have not yet run scrub, you should &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; so since you may also have rows out-of-order within an sstable
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which might manifest itself during compaction with this exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [CompactionExecutor:3152] 2014-10-28 00:24:06,134 CassandraDaemon.java (line 199) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:3152,1,main]
java.lang.RuntimeException: Last written key DecoratedKey(5516674013223138308, 001000000000111100000000000000ff2d160000100000000000ff2d1600000000111100000000100000000000004000000000000000000100) &amp;gt;= current key DecoratedKey(2839992722300822584, 001000000000111100000000000000229ad20000100000000000229ad200000000111100000000100000000000004000000000000000000100) writing into &amp;lt;sstable&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;since we use LeveledScanner when compacting (the backing sstable scanner might go beyond the start of the next sstable scanner)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12751400">CASSANDRA-8211</key>
            <summary>Overlapping sstables in L1+</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                            <label>lcs</label>
                    </labels>
                <created>Wed, 29 Oct 2014 15:33:01 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:29 +0000</updated>
                            <resolved>Fri, 7 Nov 2014 12:46:06 +0000</resolved>
                                        <fixVersion>2.0.12</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="14196034" author="krummas" created="Tue, 4 Nov 2014 12:04:55 +0000"  >&lt;p&gt;This was pretty hard to find (and reproduce), but I think i found the reason, see this example;&lt;/p&gt;

&lt;p&gt;sstables after sstablesplit - a bunch of non-intersecting files in L0:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[ a ][ b ][ c ][ d ][ e ][ f ][ g ][ h ][ i ]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;1. pick compaction candidates: a, i, start compacting (we pick the oldest sstables first)&lt;br/&gt;
2. pick compaction candidates: b, c, start compacting (note that none of these sstables intersect the compacting sstables)&lt;/p&gt;

&lt;p&gt;Compaction 1 gives us, say (depending on LCS config), 3 sstables where the &apos;middle&apos; one will cover basically the whole range. Then, when compaction 2 is done, we will end up with overlapping sstables in L1.&lt;/p&gt;

&lt;p&gt;Solution is to make sure we never add an sstable that intersects with the boundaries of the compacting sstables. In the example above we have a compacting range of &quot;the start of a&quot; -&amp;gt; &quot;the end of i&quot; after step 1, meaning we could never start compaction nr2.&lt;/p&gt;

&lt;p&gt;I&apos;ve run this for a bunch of cycles now without seeing the errors.&lt;/p&gt;

&lt;p&gt;The reason for us seeing this now is probably that people have started doing sstablesplit and running with no STCS compactions in L0 (the option from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6621&quot; title=&quot;Add flag to disable STCS in L0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6621&quot;&gt;&lt;del&gt;CASSANDRA-6621&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="14198947" author="yukim" created="Wed, 5 Nov 2014 19:47:27 +0000"  >&lt;p&gt;I see your point.&lt;br/&gt;
For the patch, shouldn&apos;t we use Bounds instead of Range to calculate overlap? Range is left-exclusive.&lt;br/&gt;
Can we use one of overlapping methods available for that?&lt;/p&gt;</comment>
                            <comment id="14199938" author="krummas" created="Thu, 6 Nov 2014 07:20:43 +0000"  >&lt;p&gt;good points, attaching updated version&lt;/p&gt;</comment>
                            <comment id="14200858" author="yukim" created="Thu, 6 Nov 2014 20:32:05 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14202005" author="krummas" created="Fri, 7 Nov 2014 12:46:06 +0000"  >&lt;p&gt;committed, thanks&lt;/p&gt;</comment>
                            <comment id="14204994" author="ngrigoriev@gmail.com" created="Mon, 10 Nov 2014 17:03:58 +0000"  >&lt;p&gt;Could it happen at any level? I did use sstablesplit in my cluster and I have recently spotted a number of messages like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;system.log.1: WARN [main] 2014-11-09 03:32:17,434 LeveledManifest.java (line 164) At level 1, SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/cassandra-data/disk2/myks/mytable1/myks-mytable1-jb-200217-Data.db&apos;&lt;/span&gt;) [DecoratedKey(-1632759770741703333, 001000000000111100000000000001164335000010000000000116433500000000111100000000100000000000004000000000000000000100), DecoratedKey(2116162112767472431, 001000000000111100000000000001432a4c0000100000000001432a4c00000000111100000000100000000000004000000000000000000100)] overlaps SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/cassandra-data/disk3/myks/mytable1/myks-mytable1-jb-200215-Data.db&apos;&lt;/span&gt;) [DecoratedKey(665029536263181199, 0010000000001111000000000000052d6e8d00001000000000052d6e8d00000000111100000000100000000000004000000000000000000100), DecoratedKey(1008355148187355376, 001000000000111100000000000001135f970000100000000001135f9700000000111100000000100000000000004000000000000000000100)].  This could be caused by a bug in Cassandra 1.1.0 .. 1.1.3 or due to the fact that you have dropped sstables from another node into the data directory. Sending back to L0.  If you didn&#8217;t drop in sstables, and have not yet run scrub, you should &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; so since you may also have rows out-of-order within an sstable
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14205007" author="krummas" created="Mon, 10 Nov 2014 17:11:07 +0000"  >&lt;p&gt;i think it could happen if we have overlapping in L1, then pick compaction candidates for L2 with a bit of bad luck&lt;/p&gt;</comment>
                            <comment id="14246132" author="rbfblk" created="Sun, 14 Dec 2014 21:18:33 +0000"  >&lt;p&gt;Does this affect 2.1 as well? Will the patch be in 2.1.3?&lt;/p&gt;</comment>
                            <comment id="14246355" author="krummas" created="Mon, 15 Dec 2014 06:16:57 +0000"  >&lt;p&gt;yes it will be in 2.1.3&lt;/p&gt;</comment>
                            <comment id="14300933" author="imriz" created="Mon, 2 Feb 2015 06:41:43 +0000"  >&lt;p&gt;I am still seeing this/related symptoms (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8191&quot; title=&quot;After sstablesplit all nodes log RuntimeException in CompactionExecutor (Last written key DecoratedKey... &amp;gt;= current key DecoratedKey)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8191&quot;&gt;&lt;del&gt;CASSANDRA-8191&lt;/del&gt;&lt;/a&gt;), after upgrading to 2.0.12:&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:1116&amp;#93;&lt;/span&gt; 2015-02-01 20:47:46,448 CassandraDaemon.java (line 199) Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:1116,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: Last written key DecoratedKey(-9223372036854775808, ) &amp;gt;= current key DecoratedKey(-9223372036854775808, ) writing into /var/lib/cassandra/data/system/compaction_history/system-compaction_history-tmp-jb-12-Data.db&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableWriter.beforeAppend(SSTableWriter.java:143)&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:166)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:167)&lt;br/&gt;
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:60)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:198)&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;


&lt;p&gt;I am also experiencing similar symptoms to those described in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8210&quot; title=&quot;&amp;quot;java.lang.AssertionError: Memory was freed&amp;quot; exception in CompactionExecutor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8210&quot;&gt;&lt;del&gt;CASSANDRA-8210&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14301131" author="krummas" created="Mon, 2 Feb 2015 10:37:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=imriz&quot; class=&quot;user-hover&quot; rel=&quot;imriz&quot;&gt;imriz&lt;/a&gt; that is unrelated (compaction_history is not LCS), if you see this on more that one node, file a new ticket, otherwise i would suspect you have some data corruption and need to run scrub&lt;/p&gt;</comment>
                            <comment id="14301133" author="imriz" created="Mon, 2 Feb 2015 10:41:26 +0000"  >&lt;p&gt;Hi Marcus,&lt;/p&gt;

&lt;p&gt;Thanks. I&apos;ll run the scrub and re verify.&lt;/p&gt;</comment>
                            <comment id="14301143" author="imriz" created="Mon, 2 Feb 2015 10:49:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; The same goes to what I&apos;m seeing in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8210&quot; title=&quot;&amp;quot;java.lang.AssertionError: Memory was freed&amp;quot; exception in CompactionExecutor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8210&quot;&gt;&lt;del&gt;CASSANDRA-8210&lt;/del&gt;&lt;/a&gt;? Also un-related?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12748140">CASSANDRA-8120</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12750640">CASSANDRA-8191</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12751398">CASSANDRA-8210</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12679802" name="0001-Avoid-overlaps-in-L1-v2.patch" size="2205" author="marcuse" created="Thu, 6 Nov 2014 07:20:43 +0000"/>
                            <attachment id="12679205" name="0001-Avoid-overlaps-in-L1.patch" size="2377" author="marcuse" created="Tue, 4 Nov 2014 12:05:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 42 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21pzj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327164">2.0.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>