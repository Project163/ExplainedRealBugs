<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:37:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5244] Compactions don&apos;t work while node is bootstrapping</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5244</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;It seems that there is a race condition in StorageService that prevents compactions from completing while node is in a bootstrap state.&lt;/p&gt;

&lt;p&gt;I have been able to reproduce this multiple times by throttling streaming throughput to extend the bootstrap time while simultaneously inserting data to the cluster.&lt;/p&gt;

&lt;p&gt;The problems lies in the synchronization of initServer(int delay) and reportSeverity(double incr) methods as they both try to acquire the instance lock of StorageService through the use of synchronized keyword. As initServer does not return until the bootstrap has completed, all calls to reportSeverity will block until that. However, reportSeverity is called when starting compactions in CompactionInfo and thus all compactions block until bootstrap completes. &lt;/p&gt;

&lt;p&gt;This might severely degrade node&apos;s performance after bootstrap as it might have lots of compactions pending while simultaneously starting to serve reads.&lt;/p&gt;

&lt;p&gt;I have been able to solve the issue by adding a separate lock for reportSeverity and removing its class level synchronization. This of course is not a valid approach if we must assume that any of Gossiper&apos;s IEndpointStateChangeSubscribers could potentially end up calling back to StorageService&apos;s synchronized methods. However, at least at the moment, that does not seem to be the case.&lt;/p&gt;

&lt;p&gt;Maybe somebody with more experience about the codebase comes up with a better solution?&lt;/p&gt;

&lt;p&gt;(This might affect DynamicEndpointSnitch as well, as it also calls to reportSeverity in its setSeverity method)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12631944">CASSANDRA-5244</key>
            <summary>Compactions don&apos;t work while node is bootstrapping</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="jihartik">Jouni Hartikainen</reporter>
                        <labels>
                            <label>gossip</label>
                    </labels>
                <created>Tue, 12 Feb 2013 13:41:25 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:18 +0000</updated>
                            <resolved>Thu, 14 Feb 2013 04:56:59 +0000</resolved>
                                        <fixVersion>1.2.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13576695" author="jbellis" created="Tue, 12 Feb 2013 15:37:57 +0000"  >&lt;p&gt;Thanks for the detective work, Jouni.  I&apos;ll let Brandon comment on solutions; in the meantime, marking Minor since while inconvenient this does not compromise correctness.&lt;/p&gt;</comment>
                            <comment id="13578128" author="brandon.williams" created="Thu, 14 Feb 2013 03:43:28 +0000"  >&lt;p&gt;This is more severe than we originally thought, and causes &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5129&quot; title=&quot;newly bootstrapping nodes hang indefinitely in STATUS:BOOT while JOINING cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5129&quot;&gt;&lt;del&gt;CASSANDRA-5129&lt;/del&gt;&lt;/a&gt; when there is a secondary index:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;CompactionExecutor:1&quot; daemon prio=10 tid=0x00007effbc03c800 nid=0x7abf waiting for monitor entry [0x00007effc843a000]
   java.lang.Thread.State: BLOCKED (on object monitor)
    at org.apache.cassandra.service.StorageService.reportSeverity(StorageService.java:905)
    - waiting to lock &amp;lt;0x00000000ca576ac8&amp;gt; (a org.apache.cassandra.service.StorageService)
    at org.apache.cassandra.db.compaction.CompactionInfo$Holder.started(CompactionInfo.java:141)
    at org.apache.cassandra.metrics.CompactionMetrics.beginCompaction(CompactionMetrics.java:90)
    at org.apache.cassandra.db.compaction.CompactionManager$9.run(CompactionManager.java:813)
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)
    at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
    at java.util.concurrent.FutureTask.run(FutureTask.java:138)
    at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
    at java.lang.Thread.run(Thread.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13578140" author="brandon.williams" created="Thu, 14 Feb 2013 04:27:43 +0000"  >&lt;p&gt;It seems to me the only reason we&apos;re synchronizing here is for the increment, and we don&apos;t need to get our own severity out of gossip, so we can just track a local AtomicDouble instead.&lt;/p&gt;</comment>
                            <comment id="13578147" author="vijay2win@yahoo.com" created="Thu, 14 Feb 2013 04:36:09 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13578156" author="brandon.williams" created="Thu, 14 Feb 2013 04:56:59 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="13578170" author="mkjellman" created="Thu, 14 Feb 2013 05:47:17 +0000"  >&lt;p&gt;this looks good.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12626499">CASSANDRA-5129</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12569310" name="5244.txt" size="1752" author="brandon.williams" created="Thu, 14 Feb 2013 04:51:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>312440</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 40 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1hx2n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>312786</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>vijay2win@yahoo.com</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[vijay2win@yahoo.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>