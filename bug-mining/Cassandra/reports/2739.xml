<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:44:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4050] Rewrite RandomAccessReader to use FileChannel / nio to address Windows file access violations</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4050</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;On Windows w/older java I/O libraries the files are not opened with FILE_SHARE_DELETE.  This causes problems as hard-links cannot be deleted while the original file is opened - our snapshots are a big problem in particular.  The nio library and FileChannels open with FILE_SHARE_DELETE which should help remedy this problem.&lt;/p&gt;

&lt;p&gt;Original text:&lt;br/&gt;
I&apos;m using Cassandra 1.0.8, on Windows 7.  When I take a snapshot of the database, I find that I am unable to delete the snapshot directory (i.e., dir named &quot;&lt;/p&gt;
{datadir}
&lt;p&gt;{keyspacename}\snapshots{snapshottag}&quot;) while Cassandra is running:  &quot;The action can&apos;t be completed because the folder or a file in it is open in another program.  Close the folder or file and try again&quot; &lt;span class=&quot;error&quot;&gt;&amp;#91;in Windows Explorer&amp;#93;&lt;/span&gt;.  If I terminate Cassandra, then I can delete the directory with no problem.&lt;/p&gt;

&lt;p&gt;I expect to be able to move or delete the snapshotted files while Cassandra is running, as this should not affect the runtime operation of Cassandra.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows 7&lt;/p&gt;</environment>
        <key id="12546471">CASSANDRA-4050</key>
            <summary>Rewrite RandomAccessReader to use FileChannel / nio to address Windows file access violations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jmckenzie">Josh McKenzie</assignee>
                                    <reporter username="jn">Jim Newsham</reporter>
                        <labels>
                            <label>Windows</label>
                    </labels>
                <created>Wed, 14 Mar 2012 20:22:30 +0000</created>
                <updated>Wed, 15 Oct 2025 09:49:07 +0000</updated>
                            <resolved>Mon, 7 Apr 2014 20:52:03 +0000</resolved>
                                        <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13229617" author="jbellis" created="Wed, 14 Mar 2012 21:08:27 +0000"  >&lt;p&gt;Currently we take the snapshot using mklink /H, but I&apos;ve experimented with the Java7 Files.createLink and see the same behavior.  It may simply be normal behavior for Windows that links are considered &quot;open&quot; until their creator is closed.&lt;/p&gt;
</comment>
                            <comment id="13229883" author="jn" created="Thu, 15 Mar 2012 04:31:26 +0000"  >&lt;p&gt;Yeah I&apos;m starting to think that might be true &amp;#8211; unfortunately.  I haven&apos;t found anything definitive, but the following postings imply a hardlink cannot be deleted while another hardlink to the same file is locked:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://superuser.com/questions/387136/is-it-possible-to-delete-a-hardlink-to-a-locked-file&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://superuser.com/questions/387136/is-it-possible-to-delete-a-hardlink-to-a-locked-file&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://superuser.com/questions/301303/one-hardlink-is-locked-how-do-i-remove-the-other&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://superuser.com/questions/301303/one-hardlink-is-locked-how-do-i-remove-the-other&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Perhaps the data structure that records the lock is in the file object and not the hardlink object.&lt;/p&gt;</comment>
                            <comment id="13470759" author="akashirin" created="Fri, 5 Oct 2012 23:00:10 +0000"  >&lt;p&gt;I have the same problem with Cassandra 1.1.5 on Windows 7 and Windows Server 2008 R2:&lt;/p&gt;

&lt;p&gt;The nodetool stably creates snapshots that can&apos;t be deleted by the &quot;clearsnapshot&quot; command later (- IOException: Failed to delete ...). The bare facts are below.&lt;/p&gt;

&lt;p&gt;For some (not for all) snapshot files (= hard links):&lt;/p&gt;

&lt;p&gt;1) WinExplorer-&amp;gt;Delete says &quot;The process cannot access the file because it is being used by another process&quot;.&lt;br/&gt;
2) Command interpreter writes &quot;Access denied&quot; on &quot;del&quot; command.&lt;br/&gt;
3) Troubleshooting tools (- &quot;Process Explorer&quot; and &quot;Unlocker&quot;) do not find open file handles. Moreover, Unlocker is able to delete these files without problems.&lt;br/&gt;
4) The files become deletable by the rest tools just after Cassandra-server has been stopped.&lt;br/&gt;
5) After restart, the same files become locked again.&lt;br/&gt;
6) Everything repeats after computer has been restarted.&lt;/p&gt;

</comment>
                            <comment id="13470901" author="jbellis" created="Sat, 6 Oct 2012 04:06:29 +0000"  >&lt;p&gt;Right, so NTFS is locking the underlying data since the &quot;original&quot; sstable is still open in Cassandra, so the behavior described by Jim applies.  We&apos;d have to add a workaround like the one given on superuser.com &amp;#8211; move the links to a &quot;garbage&quot; location to clean up on restart.&lt;/p&gt;

&lt;p&gt;This is pretty low priority for me but I&apos;d be glad to point someone interested in the right direction.&lt;/p&gt;</comment>
                            <comment id="13912118" author="jmckenzie" created="Tue, 25 Feb 2014 21:51:27 +0000"  >&lt;p&gt;There&apos;s been some discussion on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6283&quot; title=&quot;Windows 7 data files kept open / can&amp;#39;t be deleted after compaction.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6283&quot;&gt;&lt;del&gt;CASSANDRA-6283&lt;/del&gt;&lt;/a&gt; concerning this.  From the comments:&lt;/p&gt;

&lt;p&gt;With our current io implementation on Windows, snapshots won&apos;t be deletable as long as the original sstable is locked. It&apos;s going to take a new FileDataInput based on FileChannel w/jdk7 using the FILE_SHARE_DELETE flag to allow deletion of hard links while the original file is open.&lt;/p&gt;

&lt;p&gt;Bug with behavior: &lt;a href=&quot;http://bugs.java.com/view_bug.do?bug_id=6607535&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bugs.java.com/view_bug.do?bug_id=6607535&lt;/a&gt;&lt;br/&gt;
jdk7 support: &lt;a href=&quot;http://www.docjar.com/html/api/sun/nio/fs/WindowsChannelFactory.java.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.docjar.com/html/api/sun/nio/fs/WindowsChannelFactory.java.html&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13935316" author="jmckenzie" created="Fri, 14 Mar 2014 17:44:31 +0000"  >&lt;p&gt;I did some testing to confirm - nio.2 resolves both deleting hard-links and deleting of files with other handles currently open on Windows.  It should be straightforward to convert to a FileChannel and ByteBuffer in RAR and wrap the FileDataInput interface over to the ByteBuffer&apos;s.&lt;/p&gt;</comment>
                            <comment id="13938446" author="jmckenzie" created="Mon, 17 Mar 2014 21:57:49 +0000"  >&lt;p&gt;After changing RAF over to nio.2-based I&apos;m still seeing snapshot deletion errors.  A little digging turned up:&lt;br/&gt;
&lt;a href=&quot;http://bugs.java.com/view_bug.do?bug_id=4715154&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://bugs.java.com/view_bug.do?bug_id=4715154&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;As this applies to deleting memory mapped files but not necessarily hard-links with memory mapped segments in the original I figured I&apos;d test it.  I&apos;ve confirmed that if the original file has any data that&apos;s in a MappedByteBuffer even if the original RAF it was associated with is closed, Windows refuses to delete the hard-link.&lt;/p&gt;

&lt;p&gt;Some local logging indicates that we have MmappedSegmentedFile Segments open on the original keyspaces in question when deletion is attempted which isn&apos;t surprising.  The following implies that there &lt;b&gt;might&lt;/b&gt; be a way around this but it involves turning off all page caching for these files which isn&apos;t what we want for SSTableReaders on Windows: &lt;a href=&quot;http://www.osronline.com/showThread.cfm?link=64732&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.osronline.com/showThread.cfm?link=64732&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13939404" author="jmckenzie" created="Tue, 18 Mar 2014 15:53:31 +0000"  >&lt;p&gt;Sanity checked - with nio.2 on RAR and bypassing MappedByteBuffers in MmappedSegmentedFile, snapshot-based repairs on Windows work and clean up without issue.  Not a solution long-term obviously but it helps support the hypothesis.&lt;/p&gt;

&lt;p&gt;I think it makes sense to 1) convert RAR to nio.2 and 2) add a SnapshotDeletingTask similar to the SSTableDeletingTask to delete snapshot files once the original sstables are compacted and unmapped.  Alternatively we could allow snapshot files from repair to accrue and flag them for deletion on shutdown of the jvm and/or system reboot.&lt;/p&gt;</comment>
                            <comment id="13939455" author="jbellis" created="Tue, 18 Mar 2014 16:40:48 +0000"  >&lt;p&gt;I&apos;ve said elsewhere that I&apos;m fine with dropping the mapped i/o path in 3.0.  It just isn&apos;t used often enough (and the performance difference isn&apos;t large enough) to justify the extra complexity.&lt;/p&gt;</comment>
                            <comment id="13939555" author="jmckenzie" created="Tue, 18 Mar 2014 18:00:10 +0000"  >&lt;p&gt;I&apos;d like to drop the mapped i/o separately from converting the RAR over to nio.2 (assuming we want to go that route).  You want me to open a new ticket for that and hammer that out as a pre-req to this?&lt;/p&gt;

&lt;p&gt;edit: also - do we have perf #&apos;s from when we added the memory mapped i/o into the code-path?&lt;/p&gt;</comment>
                            <comment id="13939831" author="jbellis" created="Tue, 18 Mar 2014 21:29:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;d like to drop the mapped i/o separately&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;WFM.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;do we have perf #&apos;s from when we added the memory mapped i/o into the code-path&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It was a long time ago (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-408&quot; title=&quot;Pool BufferedRandomAccessFile objects used by sstable reads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-408&quot;&gt;&lt;del&gt;CASSANDRA-408&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-669&quot; title=&quot;Handle mmapping index files greater than 2GB&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-669&quot;&gt;&lt;del&gt;CASSANDRA-669&lt;/del&gt;&lt;/a&gt;).  It was a pretty big win at the time (10%?  20%?) because we were basically doing zero-copy reads from the mapped buffers.  The problem is that we had to give that up when we started manually unmapping obsolete sstables (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2521&quot; title=&quot;Move away from Phantom References for Compaction/Memtable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2521&quot;&gt;&lt;del&gt;CASSANDRA-2521&lt;/del&gt;&lt;/a&gt;) &amp;#8211; too hard to push refcounting all the way up the read path, so we gave up and just copy to a new buffer after all.&lt;/p&gt;</comment>
                            <comment id="13940941" author="jmckenzie" created="Wed, 19 Mar 2014 20:25:20 +0000"  >&lt;p&gt;Makes sense - it would require pushing some things pretty far back in the stack to hold a ref on a memory mapped segment on the read path.&lt;/p&gt;

&lt;p&gt;If we&apos;re thinking 3.X release for removing mmap I can throw a workaround on this ticket to always return a BufferedPoolingSegmentedFile from SegmentedFile&apos;s getBuilder if the platform is Windows.  That + nio.2 should get us working snapshots and less weird file handle behaviors on Windows in 2.0.X without having to wait on clean-up of the old mmap code.&lt;/p&gt;</comment>
                            <comment id="13940981" author="jbellis" created="Wed, 19 Mar 2014 21:01:33 +0000"  >&lt;p&gt;Rewriting to nio2 is the same scope as removing mmap.  Probably riskier actually.  So 3.0 for both.&lt;/p&gt;</comment>
                            <comment id="13941010" author="jmckenzie" created="Wed, 19 Mar 2014 21:19:25 +0000"  >&lt;p&gt;Fair enough.  RAR is only the root of all our file i/o, after all.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  We should probably pursue either making snapshot deletion a quiet failure rather than deleteWithConfirm or disabling snapshot-based repair on Windows in 2.0.x.  I&apos;m inclined to go with the latter since I&apos;d rather not disrupt the *nix ecosystem based on Windows file-system eccentricities in our current stabilization-phase.&lt;/p&gt;</comment>
                            <comment id="13943815" author="jbellis" created="Sat, 22 Mar 2014 01:03:42 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6907&quot; title=&quot;ignore snapshot repair flag on Windows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6907&quot;&gt;&lt;del&gt;CASSANDRA-6907&lt;/del&gt;&lt;/a&gt; for that.&lt;/p&gt;</comment>
                            <comment id="13948359" author="jmckenzie" created="Wed, 26 Mar 2014 19:35:44 +0000"  >&lt;p&gt;Attaching 1st run at converting to nio.2.  Test results on both Windows and linux at blends of 3/1, 50/1, 100/1 write/read ratios and the inverse look to be within margin of error, though we&apos;re not getting any huge gains out of this change.  3/1 sample:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;3/1 w/r test numbers&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;         4050 mmap 3/1 r/w:
                        id, ops       ,    op/s,adj op/s,   key/s,    mean,     med,     .95,     .99,    .999,     max,   time,   stderr
             4 threadCount, 934400    ,   31029,   31030,   31029,     0.1,     0.1,     0.2,     0.2,     0.7,    48.3,   30.1,  0.01072
             8 threadCount, 1259400   ,   41576,   41607,   41576,     0.2,     0.2,     0.2,     0.4,     1.1,    37.9,   30.3,  0.01139
            16 threadCount, 1478350   ,   48565,   48592,   48565,     0.3,     0.3,     0.5,     1.0,     7.0,    73.6,   30.4,  0.01197
            24 threadCount, 1523350   ,   49177,      -0,   49177,     0.5,     0.4,     0.7,     1.5,    19.1,    71.8,   31.0,  0.01668
            36 threadCount, 1518900   ,   48679,   48718,   48679,     0.7,     0.6,     1.1,     2.3,    22.6,    92.7,   31.2,  0.01425
            54 threadCount, 1541050   ,   48020,   48113,   48020,     1.1,     0.9,     1.8,     4.1,    28.6,   212.6,   32.1,  0.03217
         trunk mmap 3/1 r/w:
                        id, ops       ,    op/s,adj op/s,   key/s,    mean,     med,     .95,     .99,    .999,     max,   time,   stderr
             4 threadCount, 926400    ,   30764,   30765,   30764,     0.1,     0.1,     0.2,     0.2,     0.7,    24.3,   30.1,  0.00997
             8 threadCount, 1283250   ,   42495,      -0,   42495,     0.2,     0.2,     0.2,     0.3,     0.9,    44.4,   30.2,  0.01254
            16 threadCount, 1478250   ,   48509,      -0,   48509,     0.3,     0.3,     0.5,     0.9,     4.1,    68.0,   30.5,  0.00912
            24 threadCount, 1507900   ,   48553,   48594,   48553,     0.5,     0.4,     0.8,     1.7,    21.2,   132.1,   31.1,  0.01290
            36 threadCount, 1515150   ,   48079,      -0,   48079,     0.7,     0.6,     1.2,     2.7,    23.3,   103.8,   31.5,  0.01531
            54 threadCount, 1517600   ,   47826,      -0,   47826,     1.1,     0.9,     1.6,     3.2,    25.0,   194.4,   31.7,  0.01819
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I mention mmap in these results as using BufferedPoolingSegmentedFiles on both trunk and on this patch had a noticeable negative impact on throughput, more on nio.2 than on the byte[] raw usage.  On trunk with read-heavy workloads I&apos;m seeing anywhere from a 30-40% hit in stress results on read performance.  1/50 r/w ratio stress w/BufferedPoolingSegmentedFiles was still 16% slower than my testing using MmappedSegmentedFiles.  I&apos;ll be attaching a sample of the perf #&apos;s I&apos;ve been getting to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6890&quot; title=&quot;Standardize on a single read path&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6890&quot;&gt;&lt;del&gt;CASSANDRA-6890&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I put some yammer timers inside the RAR code on both trunk and on this branch and it looks like #&apos;s are comparable up to about the 60th percentile or so across all major read or rebuffer operations - then they balloon.  In the territory of a max timestamp of 100+ms on a simple channel seek vs. .01 on mmap&apos;ed.  GC count during stress is roughly double at a glance - I&apos;ll look into that further on 6890 but heap stress due to more activity on the heap is to be expected.&lt;/p&gt;

&lt;p&gt;As noted earlier - in order to fully resolve this issue, either &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6890&quot; title=&quot;Standardize on a single read path&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6890&quot;&gt;&lt;del&gt;CASSANDRA-6890&lt;/del&gt;&lt;/a&gt; will need to be resolved or some alternative solution for Windows if we keep mmap&apos;ing in.&lt;/p&gt;</comment>
                            <comment id="13949520" author="jbellis" created="Thu, 27 Mar 2014 16:24:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="13955152" author="benedict" created="Mon, 31 Mar 2014 13:00:05 +0000"  >&lt;p&gt;I&apos;ve uploaded a tidied up version &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/4050-nio2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve eliminated some unnecessary variables, simplified a couple of loops/conditions, and unified the AbstractDataInput/Small hierarchy. Also fixed a minor &quot;bug&quot; with getPosition() in RAR after close(), and CRAR now ensures that the current position is restored after rebuffer() - whilst currently this wouldn&apos;t cause any problems, it seems like an oversight.&lt;/p&gt;</comment>
                            <comment id="13955439" author="jmckenzie" created="Mon, 31 Mar 2014 17:50:37 +0000"  >&lt;p&gt;Good catch on getPosition - I accounted for that in current() but that hadn&apos;t triggered on any testing and was an oversight.&lt;/p&gt;

&lt;p&gt;I kept AbstractDataInput and AbstractDataInputSmall separate in the type heirarchy because I didn&apos;t want to push the int -&amp;gt; long signature change down to all the classes that implemented the base.  I&apos;m not sure if the added footprint justifies the added complexity or not - I was trying to minimize changes to unrelated classes due to the loss of RAF code.  I didn&apos;t like it, but I also don&apos;e like the alternative that much.  It looks like we run the risk of Bad Things if someone does a MemoryInputStream.skipBytes that pushes the position past Max Int - this impl has us casting off the remainder on a seek call so you could end up in negative territory.&lt;/p&gt;

&lt;p&gt;As for the tidying up - looks good to me.  Thanks for taking the time to do that - clean idiomatic usage of the nio API&apos;s clearly makes things easier to parse.&lt;/p&gt;

&lt;p&gt;Tests on linux look good, snapshots on Windows behave w/benedict&apos;s revisions and no mmap, and read performance looks comparable so I +1 the changes with the above caveat.&lt;/p&gt;</comment>
                            <comment id="13955451" author="benedict" created="Mon, 31 Mar 2014 17:58:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;It looks like we run the risk of Bad Things if someone does a MemoryInputStream.skipBytes that pushes the position past Max Int - this impl has us casting off the remainder on a seek call so you could end up in negative territory.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;How so? The MemoryInputStream defines what its limit is, and the skipBytes method ensures it never goes above this. So seek() can never be called with a value that is out of range (since it is a protected method). We could put in an assert if we want to be doubly certain, however, and that&apos;s probably not a bad idea for simple declaration of intent.&lt;/p&gt;

&lt;p&gt;I think the reduced code duplication (from readLine and skipBytes now being shared), and cleaner hierarchy is preferable, especially as ADISmall is not a very clear distinction from ADI. Think the overall footprint is reduced rather than increased...?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Thanks for taking the time to do that - clean idiomatic usage of the nio API&apos;s clearly makes things easier to parse.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I find the NIO library tough to parse at the best of times, and wanted to be sure I was reading it right, so it was a freebie to change as I reviewed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13955474" author="jmckenzie" created="Mon, 31 Mar 2014 18:16:45 +0000"  >&lt;blockquote&gt;
&lt;p&gt;the skipBytes method ensures it never goes above this&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;How is skipBytes protecting against blowing past our limit?  (note: me just being dense here is not out of the question)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; 64     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; skipBytes(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; n) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
 65     {
 66         &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (n &amp;lt;= 0)
 67             &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 0;
 68         seek(getPosition() + n);
 69         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; position;
 70     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It looks like this exposes seek() to the outside world with a protection against negative inputs but not much else.  That being said - the old code looks like it has the same potential problem:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; skipBytes(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; n) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
    {
        seekInternal(getPosition() + n);
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; position;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13955480" author="benedict" created="Mon, 31 Mar 2014 18:19:06 +0000"  >&lt;p&gt;Ah, this is my failure to delete the skipBytes method from MIS, as it now occurs in ADI (in a safe manner).&lt;/p&gt;</comment>
                            <comment id="13955483" author="benedict" created="Mon, 31 Mar 2014 18:20:47 +0000"  >&lt;p&gt;In fact, it looks like that is simply a bug that has always been present - the new behaviour is no worse than the old, but deleting it is still the correct fix.&lt;/p&gt;

&lt;p&gt;Good spot.&lt;/p&gt;</comment>
                            <comment id="13955486" author="jmckenzie" created="Mon, 31 Mar 2014 18:23:16 +0000"  >&lt;p&gt;Sure enough.  given the docs for skipBytes are 0-n bytes skipped I think the code in ADI looks good.  I&apos;d much rather we not add more types to the hierarchy in this context.&lt;/p&gt;</comment>
                            <comment id="13955726" author="benedict" created="Mon, 31 Mar 2014 21:12:37 +0000"  >&lt;p&gt;Sounds like we&apos;re in agreement then? Any further changes you want to make after my update?&lt;/p&gt;</comment>
                            <comment id="13955732" author="jmckenzie" created="Mon, 31 Mar 2014 21:18:11 +0000"  >&lt;p&gt;No other changes.  Depending on where we fall on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6890&quot; title=&quot;Standardize on a single read path&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6890&quot;&gt;&lt;del&gt;CASSANDRA-6890&lt;/del&gt;&lt;/a&gt; I may want to expand this ticket to cover using SSTableDeletingTasks on snapshot files to work around deleting memory mapped file segments on Windows in order to fix the issue that caused us to go down this path in the first place.  I don&apos;t like low-level I/O rewrites being under the guise of a Windows snapshot file ticket so I may do some housekeeping here.&lt;/p&gt;</comment>
                            <comment id="13955760" author="benedict" created="Mon, 31 Mar 2014 21:47:13 +0000"  >&lt;p&gt;Rename/describe the ticket? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I had been thinking the same thing.&lt;/p&gt;</comment>
                            <comment id="13960469" author="jmckenzie" created="Fri, 4 Apr 2014 21:53:49 +0000"  >&lt;p&gt;I&apos;ll rebase your branch against trunk and post a revised patch early next week.  I know how much you love rebasing and I figure I owe you one for the house-cleaning on this patch.  &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13962060" author="jmckenzie" created="Mon, 7 Apr 2014 17:52:29 +0000"  >&lt;p&gt;New patch attached.  Passes the same tests trunk does and perf is in line.&lt;/p&gt;</comment>
                            <comment id="13962138" author="benedict" created="Mon, 7 Apr 2014 18:53:00 +0000"  >&lt;p&gt;Might want to delete skipBytes from MIS as we discussed, otherwise LGTM and ready for commit.&lt;/p&gt;</comment>
                            <comment id="13962200" author="jmckenzie" created="Mon, 7 Apr 2014 20:09:59 +0000"  >&lt;p&gt;Odd.  I wonder if I didn&apos;t pull down that &lt;a href=&quot;https://github.com/josh-mckenzie/cassandra/commit/51cf8e74db1d452d99ac554b6666c86829376d91&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt; before I rebased locally.  Odd since I thought I saw that on the difftool run;  I&apos;ll fix it and repost.&lt;/p&gt;</comment>
                            <comment id="13962212" author="jmckenzie" created="Mon, 7 Apr 2014 20:28:06 +0000"  >&lt;p&gt;v3 attached.  I removed the CommitLogTest changes that snuck on on the remove skipBytes from MIS commit from you as they looked unrelated to this ticket.&lt;/p&gt;</comment>
                            <comment id="13962214" author="benedict" created="Mon, 7 Apr 2014 20:30:34 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13962239" author="jbellis" created="Mon, 7 Apr 2014 20:52:03 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12758325">CASSANDRA-8390</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12677050">CASSANDRA-6283</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12636982" name="CASSANDRA-4050_v1.patch" size="28808" author="joshuamckenzie" created="Wed, 26 Mar 2014 19:36:26 +0000"/>
                            <attachment id="12639025" name="CASSANDRA-4050_v2.patch" size="29873" author="joshuamckenzie" created="Mon, 7 Apr 2014 17:51:37 +0000"/>
                            <attachment id="12639053" name="CASSANDRA-4050_v3.patch" size="29804" author="joshuamckenzie" created="Mon, 7 Apr 2014 20:28:24 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jmckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>231629</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 33 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i05h8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>29891</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>