<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:22:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2948] Nodetool move fails to stream out data from moved node to new endpoint.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2948</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When moving a node in the ring with nodetool move, that node streams its data to itself instead of to the new endpoint responsible for its old range.&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Create a cluster (A,B,C,D) with tokens (0,4,8,C) using ByteOrderedPartitioner&lt;/li&gt;
	&lt;li&gt;Create a keyspace and CF with RF=1&lt;/li&gt;
	&lt;li&gt;Insert keys (2,6,A,E). This should put one key on each node.&lt;/li&gt;
	&lt;li&gt;Move node A to token 7. This should cause:&lt;br/&gt;
  + node C streams key 6 to node A&lt;br/&gt;
  + node A streams key E to node B&lt;br/&gt;
  However instead, node A streams key E to itself.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Selected log messages from node A:&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;RMI TCP Connection(6)-10.2.129.41&amp;#93;&lt;/span&gt; 2011-07-26 16:29:17,075 StorageService.java (line 1878) Moving miles/10.2.129.41 from Token(bytes&lt;span class=&quot;error&quot;&gt;&amp;#91;00&amp;#93;&lt;/span&gt;) to Token(bytes&lt;span class=&quot;error&quot;&gt;&amp;#91;07&amp;#93;&lt;/span&gt;).&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RMI TCP Connection(6)-10.2.129.41&amp;#93;&lt;/span&gt; 2011-07-26 16:29:17,080 StorageService.java (line 1941) Table ks: work map &lt;/p&gt;
{/10.2.129.16=[(Token(bytes[04]),Token(bytes[07])]]}
&lt;p&gt;.&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;RMI TCP Connection(6)-10.2.129.41&amp;#93;&lt;/span&gt; 2011-07-26 16:29:17,080 StorageService.java (line 1946) Sleeping 30000 ms before start streaming/fetching ranges.&lt;br/&gt;
...&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;RMI TCP Connection(6)-10.2.129.41&amp;#93;&lt;/span&gt; 2011-07-26 16:29:46,728 StorageService.java (line 522) Moving: fetching new ranges and streaming old ranges&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RMI TCP Connection(6)-10.2.129.41&amp;#93;&lt;/span&gt; 2011-07-26 16:29:46,728 StorageService.java (line 1960) &lt;span class=&quot;error&quot;&gt;&amp;#91;Move-&amp;gt;STREAMING&amp;#93;&lt;/span&gt; Work Map: {ks={(Token(bytes&lt;span class=&quot;error&quot;&gt;&amp;#91;0c&amp;#93;&lt;/span&gt;),Token(bytes&lt;span class=&quot;error&quot;&gt;&amp;#91;00&amp;#93;&lt;/span&gt;)]=&lt;span class=&quot;error&quot;&gt;&amp;#91;miles/10.2.129.41&amp;#93;&lt;/span&gt;}}&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RMI TCP Connection(6)-10.2.129.41&amp;#93;&lt;/span&gt; 2011-07-26 16:29:46,729 StorageService.java (line 1965) &lt;span class=&quot;error&quot;&gt;&amp;#91;Move-&amp;gt;FETCHING&amp;#93;&lt;/span&gt; Work Map: {ks={/10.2.129.16=[(Token(bytes&lt;span class=&quot;error&quot;&gt;&amp;#91;04&amp;#93;&lt;/span&gt;),Token(bytes&lt;span class=&quot;error&quot;&gt;&amp;#91;07&amp;#93;&lt;/span&gt;)]]}}&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;RMI TCP Connection(6)-10.2.129.41&amp;#93;&lt;/span&gt; 2011-07-26 16:29:46,730 StorageService.java (line 2411) Requesting from /10.2.129.16 ranges (Token(bytes&lt;span class=&quot;error&quot;&gt;&amp;#91;04&amp;#93;&lt;/span&gt;),Token(bytes&lt;span class=&quot;error&quot;&gt;&amp;#91;07&amp;#93;&lt;/span&gt;)]&lt;br/&gt;
...&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamStage:1&amp;#93;&lt;/span&gt; 2011-07-26 16:29:46,737 StreamOut.java (line 90) Beginning transfer to miles/10.2.129.41&lt;br/&gt;
DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;StreamStage:1&amp;#93;&lt;/span&gt; 2011-07-26 16:29:46,737 StreamOut.java (line 91) Ranges are (Token(bytes&lt;span class=&quot;error&quot;&gt;&amp;#91;0c&amp;#93;&lt;/span&gt;),Token(bytes&lt;span class=&quot;error&quot;&gt;&amp;#91;00&amp;#93;&lt;/span&gt;)]&lt;/p&gt;

&lt;p&gt;This appears to be caused because in StorageService.move we call&lt;br/&gt;
    Gossiper.instance.addLocalApplicationState(ApplicationState.STATUS, valueFactory.moving(newToken));&lt;br/&gt;
and then get the new token metadata in order to calculate where the new endpoint is that we should stream to&lt;br/&gt;
    TokenMetadata tokenMetaClone = tokenMetadata_.cloneAfterAllSettled();&lt;br/&gt;
however, in addLocalApplicationState there is no notification broadcast for the change in local state, so tokenMetadata_ never updates the list of moving nodes, and the tokenMetaClone is still the state of the ring from before the move.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12515417">CASSANDRA-2948</key>
            <summary>Nodetool move fails to stream out data from moved node to new endpoint.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="soverton">Sam Overton</assignee>
                                    <reporter username="soverton">Sam Overton</reporter>
                        <labels>
                            <label>move</label>
                            <label>streaming</label>
                    </labels>
                <created>Tue, 26 Jul 2011 15:42:49 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:54 +0000</updated>
                            <resolved>Wed, 27 Jul 2011 22:47:15 +0000</resolved>
                                        <fixVersion>0.8.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13071170" author="soverton" created="Tue, 26 Jul 2011 15:48:35 +0000"  >&lt;p&gt;Attached patch which will cause Gossiper to broadcast notifications when the local application state is updated.&lt;/p&gt;

&lt;p&gt;It also fixes the calculation of the endpoints to stream from, which should use the old state of the ring, not the new one.&lt;/p&gt;</comment>
                            <comment id="13072081" author="brandon.williams" created="Wed, 27 Jul 2011 22:47:15 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                            <comment id="13072094" author="hudson" created="Wed, 27 Jul 2011 23:21:20 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #242 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/242/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/242/&lt;/a&gt;)&lt;br/&gt;
    Gossiper notifies of local state changes.&lt;br/&gt;
Patch by Sam Overton, reviewed by brandonwilliams for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2948&quot; title=&quot;Nodetool move fails to stream out data from moved node to new endpoint.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2948&quot;&gt;&lt;del&gt;CASSANDRA-2948&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;brandonwilliams : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1151659&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1151659&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/gms/Gossiper.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/service/StorageService.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12487854" name="2948.patch" size="1361" author="soverton" created="Tue, 26 Jul 2011 15:48:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[soverton]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20905</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 17 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gefz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93770</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>