<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:05:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12582] Removing static column results in ReadFailure due to CorruptSSTableException</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12582</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We ran into an issue on production where reads began to fail for certain queries, depending on the range within the relation for those queries. Cassandra system log showed an unhandled &lt;tt&gt;CorruptSSTableException&lt;/tt&gt; exception.&lt;/p&gt;

&lt;p&gt;CQL read failure:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ReadFailure: code=1300 [Replica(s) failed to execute read] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;Operation failed - received 0 responses and 1 failures&quot;&lt;/span&gt; info={&lt;span class=&quot;code-quote&quot;&gt;&apos;failures&apos;&lt;/span&gt;: 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;received_responses&apos;&lt;/span&gt;: 0, &lt;span class=&quot;code-quote&quot;&gt;&apos;required_responses&apos;&lt;/span&gt;: 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;consistency&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;ONE&apos;&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Cassandra exception:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WARN  [SharedPool-Worker-2] 2016-08-31 12:49:27,979 AbstractLocalAwareExecutorService.java:169 - Uncaught exception on thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[SharedPool-Worker-2,5,main]: {}
java.lang.RuntimeException: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /usr/local/apache-cassandra-3.0.8/data/data/issue309/apples_by_tree-006748a06fa311e6a7f8ef8b642e977b/mb-1-big-Data.db
  at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2453) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_72]
  at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) [apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [apache-cassandra-3.0.8.jar:3.0.8]
  at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_72]
Caused by: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /usr/local/apache-cassandra-3.0.8/data/data/issue309/apples_by_tree-006748a06fa311e6a7f8ef8b642e977b/mb-1-big-Data.db
  at org.apache.cassandra.io.sstable.format.big.BigTableScanner$KeyScanningIterator$1.initializeIterator(BigTableScanner.java:343) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.maybeInit(LazilyInitializedUnfilteredRowIterator.java:48) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.isReverseOrder(LazilyInitializedUnfilteredRowIterator.java:65) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.isReverseOrder(LazilyInitializedUnfilteredRowIterator.java:66) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.partitions.PurgeFunction.applyToPartition(PurgeFunction.java:62) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.partitions.PurgeFunction.applyToPartition(PurgeFunction.java:24) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:96) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:295) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.ReadResponse$LocalDataResponse.build(ReadResponse.java:134) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:127) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:123) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.ReadResponse.createDataResponse(ReadResponse.java:65) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:289) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1796) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2449) ~[apache-cassandra-3.0.8.jar:3.0.8]
  ... 5 common frames omitted
Caused by: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /usr/local/apache-cassandra-3.0.8/data/data/issue309/apples_by_tree-006748a06fa311e6a7f8ef8b642e977b/mb-1-big-Data.db
  at org.apache.cassandra.db.columniterator.AbstractSSTableIterator.&amp;lt;init&amp;gt;(AbstractSSTableIterator.java:130) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.columniterator.SSTableIterator.&amp;lt;init&amp;gt;(SSTableIterator.java:46) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.io.sstable.format.big.BigTableReader.iterator(BigTableReader.java:69) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.io.sstable.format.big.BigTableScanner$KeyScanningIterator$1.initializeIterator(BigTableScanner.java:338) ~[apache-cassandra-3.0.8.jar:3.0.8]
  ... 19 common frames omitted
Caused by: java.io.IOException: Corrupt (negative) value length encountered
  at org.apache.cassandra.db.marshal.AbstractType.readValue(AbstractType.java:399) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.rows.BufferCell$Serializer.deserialize(BufferCell.java:302) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.rows.UnfilteredSerializer.readSimpleColumn(UnfilteredSerializer.java:462) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.rows.UnfilteredSerializer.deserializeRowBody(UnfilteredSerializer.java:440) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.rows.UnfilteredSerializer.deserializeStaticRow(UnfilteredSerializer.java:381) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.columniterator.AbstractSSTableIterator.readStaticRow(AbstractSSTableIterator.java:179) ~[apache-cassandra-3.0.8.jar:3.0.8]
  at org.apache.cassandra.db.columniterator.AbstractSSTableIterator.&amp;lt;init&amp;gt;(AbstractSSTableIterator.java:103) ~[apache-cassandra-3.0.8.jar:3.0.8]
  ... 22 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After debugging, it appears that a previously dropped static column (weeks prior) was the instigator of the issue. As a workaround we added back the column, restarted all cassandra processes within the cluster, and the read error and corruption exception went away.&lt;/p&gt;

&lt;p&gt;Attached is a script to reproduce with a simple schema.&lt;/p&gt;

&lt;p&gt;Also noteworthy (and shown in the script) is that when in this state, compaction silently failed (exit 0) to remove the dropped static columns from the &quot;corrupted&quot; sstable.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Cassandra 3.0.8&lt;/p&gt;</environment>
        <key id="13001795">CASSANDRA-12582</key>
            <summary>Removing static column results in ReadFailure due to CorruptSSTableException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="eprothro">Evan Prothro</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>corruption</label>
                            <label>drop</label>
                            <label>read</label>
                            <label>static</label>
                    </labels>
                <created>Wed, 31 Aug 2016 19:12:10 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:20 +0000</updated>
                            <resolved>Mon, 10 Oct 2016 01:57:00 +0000</resolved>
                                        <fixVersion>3.0.10</fixVersion>
                    <fixVersion>3.10</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15471888" author="eprothro" created="Wed, 7 Sep 2016 21:41:42 +0000"  >&lt;p&gt;If there is anything else needed to reproduce or understand this issue, please let us know. &lt;/p&gt;

&lt;p&gt;We&apos;re eager to help however we can to try to get this fixed for 3.0.9 to complete all the fixes related to issues with static columns in this issue, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11988&quot; title=&quot;NullPointerException when reading/compacting table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11988&quot;&gt;&lt;del&gt;CASSANDRA-11988&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12336&quot; title=&quot;NullPointerException during compaction on table with static columns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12336&quot;&gt;&lt;del&gt;CASSANDRA-12336&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15506606" author="eprothro" created="Tue, 20 Sep 2016 13:54:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; I don&apos;t want to speak out of turn, but it seems to me that this not getting attention in 3.0.9 will leave that build without a complete fix to the known issues dealing with static columns (other related issues linked above). Is there any way this can get attention in 3.0.9?&lt;/p&gt;</comment>
                            <comment id="15506622" author="eprothro" created="Tue, 20 Sep 2016 14:00:51 +0000"  >&lt;p&gt;Just saw that 3.0.9 was released, so i guess ignore that question. Bummer that this didn&apos;t make it in. Is there a way to know when versions are planning on being released? Seems like theres a level of organizational conversation going on that I&apos;m not aware of.&lt;/p&gt;</comment>
                            <comment id="15506660" author="tjake" created="Tue, 20 Sep 2016 14:12:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eprothro&quot; class=&quot;user-hover&quot; rel=&quot;eprothro&quot;&gt;eprothro&lt;/a&gt; The versions get bumped when I do a release.  We periodically do releases and 3.0.9 was long overdue (See changelog).  I&apos;m not sure who would be best to look into this issue but I&apos;ll ask if someone can help. thanks for the repro script! &lt;/p&gt;</comment>
                            <comment id="15512556" author="stefania" created="Thu, 22 Sep 2016 08:09:36 +0000"  >&lt;p&gt; I&apos;ll have a go at reproducing this and see if I can understand what is going on. Thanks for providing such detailed information.&lt;/p&gt;</comment>
                            <comment id="15512573" author="stefania" created="Thu, 22 Sep 2016 08:14:42 +0000"  >&lt;p&gt;Reproduced without problems.&lt;/p&gt;</comment>
                            <comment id="15512745" author="stefania" created="Thu, 22 Sep 2016 09:28:56 +0000"  >&lt;p&gt;The reason of the corruption is that the sstable iterators try to read a static column as a regular column. This is due to the fact that the serialization header is missing the dropped static column.&lt;/p&gt;

&lt;p&gt;When the header is deserialized, it relies on &lt;tt&gt;CFMetadata&lt;/tt&gt; to provide a fake dropped column. The problem is that &lt;tt&gt;CFMetadata&lt;/tt&gt; always assumes that dropped columns are regular, see &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/config/CFMetaData.java#L682&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Then when the iterators read the static column, they rely on the header to make the decision of whether a static column is present or not, &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/columniterator/AbstractSSTableIterator.java#L169&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. As a consequence, they don&apos;t attempt to skip the static column and they try to read it as a regular column later on.&lt;/p&gt;</comment>
                            <comment id="15515526" author="stefania" created="Fri, 23 Sep 2016 06:07:26 +0000"  >&lt;p&gt;This patch should fix the problem:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12582-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12582&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12582-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12582-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12582-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12582-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Luckily the serialization header stores static and regular columns separately, so I was able to pass this information to &lt;tt&gt;CFMetadata&lt;/tt&gt; in order to create a fake static column but I wonder if we may have issues in other parts of the code, where we create a regular column def instead of a static one. Basically all callers of &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/config/CFMetaData.java#L672&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;CFMetadata.getDroppedColumnDefinition&lt;/tt&gt;&lt;/a&gt; are at risk. So I wonder if we should also add &lt;tt&gt;ColumnDefinition.Kind&lt;/tt&gt; to &lt;tt&gt;SystemKeyspace.DroppedColumns&lt;/tt&gt;. Currently only regular or static columns can be dropped, so technically we could also only add a boolean.&lt;/p&gt;

&lt;p&gt;WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15515688" author="slebresne" created="Fri, 23 Sep 2016 07:35:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;I wonder if we should also add &lt;tt&gt;ColumnDefinition.Kind&lt;/tt&gt; to &lt;tt&gt;SystemKeyspace.DroppedColumns&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We definitively should imo. Though that imply a schema change and that&apos;s kind of problematic at the moment until 4.0, so we might have to do so in a separate ticket and rely on work-around like you implemented until then.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Currently only regular or static columns can be dropped, so technically we could also only add a boolean&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I can&apos;t really see us ever allowing the dropping of partition key or clustering columns (it sounds way too painful to support in the storage engine to be worth it), but I don&apos;t think we have much to lose by saving the full kind so it&apos;s probably fine to be overly cautious.&lt;/p&gt;</comment>
                            <comment id="15515762" author="stefania" created="Fri, 23 Sep 2016 08:12:43 +0000"  >&lt;p&gt;It&apos;s worth noting that the exception I reproduced is actually different that the one in the ticket description. It seems the exception in the description is failing to read a static row whilst the exception I reproduced is failing to read a regular row (a clustering to be exact), I hope the workaround in the serialization header covers both, but I cannot reproduce the exact exception in the description. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.RuntimeException: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /home/stefi/git/cstar/cassandra/data/data/issue12582/apples_by_tree-3980ba90809c11e6b62e6be1d44ebd9b/mc-1-big-Data.db
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2470) ~[main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_101]
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) ~[main/:na]
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) [main/:na]
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [main/:na]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_101]
Caused by: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /home/stefi/git/cstar/cassandra/data/data/issue12582/apples_by_tree-3980ba90809c11e6b62e6be1d44ebd9b/mc-1-big-Data.db
        at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$Reader.hasNext(AbstractSSTableIterator.java:353) ~[main/:na]
        at org.apache.cassandra.db.columniterator.AbstractSSTableIterator.hasNext(AbstractSSTableIterator.java:219) ~[main/:na]
        at org.apache.cassandra.db.columniterator.SSTableIterator.hasNext(SSTableIterator.java:32) ~[main/:na]
        at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:95) ~[main/:na]
        at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:32) ~[main/:na]
        at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[main/:na]
        at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:95) ~[main/:na]
        at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:32) ~[main/:na]
        at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[main/:na]
        at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[main/:na]
        at org.apache.cassandra.db.transform.UnfilteredRows.isEmpty(UnfilteredRows.java:58) ~[main/:na]
        at org.apache.cassandra.db.partitions.PurgeFunction.applyToPartition(PurgeFunction.java:65) ~[main/:na]
        at org.apache.cassandra.db.partitions.PurgeFunction.applyToPartition(PurgeFunction.java:24) ~[main/:na]
        at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:96) ~[main/:na]
        at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:295) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.build(ReadResponse.java:145) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:138) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:134) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse.createDataResponse(ReadResponse.java:76) ~[main/:na]
        at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:320) ~[main/:na]
        at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1796) ~[main/:na]
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2466) ~[main/:na]
        ... 5 common frames omitted
Caused by: java.io.IOException: Corrupt flags value &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; clustering prefix (isStatic flag set): 160
        at org.apache.cassandra.db.ClusteringPrefix$Deserializer.prepare(ClusteringPrefix.java:422) ~[main/:na]
        at org.apache.cassandra.db.UnfilteredDeserializer$CurrentDeserializer.prepareNext(UnfilteredDeserializer.java:172) ~[main/:na]
        at org.apache.cassandra.db.UnfilteredDeserializer$CurrentDeserializer.hasNext(UnfilteredDeserializer.java:153) ~[main/:na]
        at org.apache.cassandra.db.columniterator.SSTableIterator$ForwardReader.computeNext(SSTableIterator.java:126) ~[main/:na]
        at org.apache.cassandra.db.columniterator.SSTableIterator$ForwardReader.hasNextInternal(SSTableIterator.java:153) ~[main/:na]
        at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$Reader.hasNext(AbstractSSTableIterator.java:340) ~[main/:na]
        ... 26 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15515835" author="stefania" created="Fri, 23 Sep 2016 08:48:51 +0000"  >&lt;p&gt;Thank you for your comment &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;. Do we need to wait until 4.0? If we add a field to &lt;tt&gt;SystemKeyspace.DroppedColumns&lt;/tt&gt;, and we are careful to read it as an optional field that may be missing, given that the table has local replication, isn&apos;t this enough to cover all columns that will be dropped from this point onwards? For columns that have already been dropped, there&apos;s nothing we can do, even with a full schema migration we have lost the information of whether the column was static or not. Am I missing something?&lt;/p&gt;

&lt;p&gt;Noted regarding storing the full kind, and I agree.&lt;/p&gt;</comment>
                            <comment id="15516024" author="slebresne" created="Fri, 23 Sep 2016 10:06:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;If we add a field to SystemKeyspace.DroppedColumns, and we are careful to read it as an optional field that may be missing, given that the table has local replication&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Don&apos;t get fooled by the keyspace replication strategy, schema tables &lt;b&gt;are&lt;/b&gt; replicated, just by their own manual mechanism (see &lt;tt&gt;MigrationManager&lt;/tt&gt; for the gory details). Adding a column to a schema table exposes us to the same problem than in  &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12236&quot; title=&quot;RTE from new CDC column breaks in flight queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12236&quot;&gt;&lt;del&gt;CASSANDRA-12236&lt;/del&gt;&lt;/a&gt; (and it&apos;s follow-up, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12697&quot; title=&quot;cdc column addition still breaks schema migration tasks&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12697&quot;&gt;&lt;del&gt;CASSANDRA-12697&lt;/del&gt;&lt;/a&gt;). And while for the &lt;tt&gt;cdc&lt;/tt&gt; column we have been able to use the &lt;tt&gt;cdc_enabled&lt;/tt&gt; to &quot;solve&quot; this problem (basically saying, &quot;keep cdc_enabled to false until fully upgraded&quot;), we don&apos;t have such trick here.&lt;/p&gt;

&lt;p&gt;Don&apos;t get me wrong, we could probably come up with something along the line of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12236&quot; title=&quot;RTE from new CDC column breaks in flight queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12236&quot;&gt;&lt;del&gt;CASSANDRA-12236&lt;/del&gt;&lt;/a&gt; if we really wanted to, but there is a fair chance it won&apos;t be very user friendly, and it&apos;s a tad involved anyway. So let&apos;s say that it&apos;s a lot easier to make the change in 4.0, and that even if we think it&apos;s important enough to try it before that, we might still want to defer that change to a follow-up ticket just so we get your work-around in in the meantime.&lt;/p&gt;</comment>
                            <comment id="15516892" author="eprothro" created="Fri, 23 Sep 2016 16:23:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; confirmed that your patch fixes the issue for me in both the reproduction script, as well as for our real-world use case. Thank you!&lt;/p&gt;</comment>
                            <comment id="15521804" author="stefania" created="Mon, 26 Sep 2016 02:10:59 +0000"  >&lt;p&gt;Thanks for the explanation &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;, I created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12705&quot; title=&quot;Add column definition kind to system schema dropped columns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12705&quot;&gt;&lt;del&gt;CASSANDRA-12705&lt;/del&gt;&lt;/a&gt; for adding a field to SystemKeyspace.DroppedColumns. I totally missed that the schema mutations are pushed to other nodes and would therefore cause exceptions during a rolling upgrade.&lt;/p&gt;

&lt;p&gt;I&apos;ve checked the CI results and they are all clean except for testall on trunk, but the failures there also occur on trunk. Do you think you could be the reviewer since you&apos;ve already looked at the change anyway?&lt;/p&gt;

&lt;p&gt;I also converted the reproduction script into a dtest, pull request &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1342&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eprothro&quot; class=&quot;user-hover&quot; rel=&quot;eprothro&quot;&gt;eprothro&lt;/a&gt;: it&apos;s great to hear that the patch fixes your real-world use case as well, thank you so much for this update and, once again, for the reproduction script.&lt;/p&gt;</comment>
                            <comment id="15554114" author="stefania" created="Fri, 7 Oct 2016 04:48:36 +0000"  >&lt;p&gt;Rebased on the latest branches, the 3.0 patch applies cleanly upwards:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.X&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12582-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12582-3.X&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12582&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12582-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12582-3.X-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12582-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12582-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12582-3.X-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12582-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Since there were no conflicts when rebasing, I did not relaunch the CI jobs which were clean.&lt;/p&gt;</comment>
                            <comment id="15555431" author="carlyeks" created="Fri, 7 Oct 2016 15:45:58 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15561020" author="stefania" created="Mon, 10 Oct 2016 01:56:36 +0000"  >&lt;p&gt;Thanks for the review, committed to 3.0 as 2f0e365dc495336332e174b30e2d15e56fc344e2 and merged into 3.X and trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12977459">CASSANDRA-11988</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12993291">CASSANDRA-12336</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12826485" name="12582.cdl" size="1755" author="eprothro" created="Wed, 31 Aug 2016 19:25:31 +0000"/>
                            <attachment id="12826484" name="12582_reproduce.sh" size="2247" author="eprothro" created="Wed, 31 Aug 2016 19:25:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 6 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3339b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335694">3.0.7</customfieldvalue>
    <customfieldvalue id="12336056">3.0.8</customfieldvalue>
    <customfieldvalue id="12337349">3.0.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>carlyeks</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>