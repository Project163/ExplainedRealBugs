<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:32:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12043] Syncing most recent commit in CAS across replicas can cause all CAS queries in the CQL partition to fail</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12043</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We update the most recent commit on requiredParticipant replicas if out of sync during the prepare round in beginAndRepairPaxos method. We keep doing this in a loop till the requiredParticipant replicas have the same most recent commit or we hit timeout. &lt;/p&gt;

&lt;p&gt;Say we have 3 machines A,B and C and gc grace on the table is 10 days. We do a CAS write at time 0 and it went to A and B but not to C.  C will get the hint later but will not update the most recent commit in paxos table. This is how CAS hints work. &lt;br/&gt;
In the paxos table whose gc_grace=0, most_recent_commit in A and B will be inserted with timestamp 0 and with a TTL of 10 days. After 10 days, this insert will become a tombstone at time 0 till it is compacted away since gc_grace=0.&lt;/p&gt;

&lt;p&gt;Do a CAS read after say 1 day on the same CQL partition and this time prepare phase involved A and C. most_recent_commit on C for this CQL partition is empty. A sends the most_recent_commit to C with a timestamp of 0 and with a TTL of 10 days. This most_recent_commit on C will expire on 11th day since it is inserted after 1 day. &lt;/p&gt;

&lt;p&gt;most_recent_commit are now in sync on A,B and C, however A and B most_recent_commit will expire on 10th day whereas for C it will expire on 11th day since it was inserted one day later. &lt;/p&gt;

&lt;p&gt;Do another CAS read after 10days when most_recent_commit on A and B have expired and is treated as tombstones till compacted. In this CAS read, say A and C are involved in prepare phase. most_recent_commit will not match between them since it is expired in A and is still there on C. This will cause most_recent_commit to be applied to A with a timestamp of 0 and TTL of 10 days. If A has not compacted away the original most_recent_commit which has expired, this new write to most_recent_commit wont be visible on reads since there is a tombstone with same timestamp(Delete wins over data with same timestamp). &lt;/p&gt;

&lt;p&gt;Another round of prepare will follow and again A would say it does not know about most_recent_write(covered by original write which is not a tombstone) and C will again try to send the write to A. This can keep going on till the request timeouts or only A and B are involved in the prepare phase. &lt;/p&gt;

&lt;p&gt;When A&#8217;s original most_recent_commit which is now a tombstone is compacted, all the inserts which it was covering will come live. This will in turn again get played to another replica. This ping pong can keep going on for a long time. &lt;/p&gt;

&lt;p&gt;The issue is that most_recent_commit is expiring at different times across replicas. When they get replayed to a replica to make it in sync, we again set the TTL from that point.  &lt;br/&gt;
During the CAS read which timed out, most_recent_commit was being sent to another replica in a loop. Even in successful requests, it will try to loop for a couple of times if involving A and C and then when the replicas which respond are A and B, it will succeed. So this will have impact on latencies as well. &lt;/p&gt;

&lt;p&gt;These timeouts gets worse when a machine is down as no progress can be made as the machine with unexpired commit is always involved in the CAS prepare round. Also with range movements, the new machine gaining range has empty most recent commit and gets the commit at a later time causing same issue. &lt;/p&gt;

&lt;p&gt;Repro steps:&lt;br/&gt;
1. Paxos TTL is max(3 hours, gc_grace) as defined in SystemKeyspace.paxosTtl(). Change this method to not put a minimum TTL of 3 hours. &lt;br/&gt;
Method  SystemKeyspace.paxosTtl() will look like return metadata.getGcGraceSeconds();   instead of return Math.max(3 * 3600, metadata.getGcGraceSeconds());&lt;br/&gt;
We are doing this so that we dont need to wait for 3 hours. &lt;/p&gt;

&lt;p&gt;Create a 3 node cluster with the code change suggested above with machines A,B and C&lt;br/&gt;
CREATE KEYSPACE  test WITH REPLICATION = &lt;/p&gt;
{ &apos;class&apos; : &apos;SimpleStrategy&apos;, &apos;replication_factor&apos; : 3 }
&lt;p&gt;;&lt;br/&gt;
use test;&lt;br/&gt;
CREATE TABLE users (a int PRIMARY KEY,b int);&lt;br/&gt;
alter table users WITH gc_grace_seconds=120;&lt;br/&gt;
consistency QUORUM;&lt;br/&gt;
bring down machine C&lt;br/&gt;
INSERT INTO users (user_name, password ) VALUES ( 1,1) IF NOT EXISTS;&lt;br/&gt;
Nodetool flush on machine A and B&lt;br/&gt;
Bring up the down machine B &lt;br/&gt;
consistency SERIAL;&lt;br/&gt;
tracing on;&lt;br/&gt;
wait 80 seconds&lt;br/&gt;
Bring up machine C&lt;br/&gt;
select * from users where user_name = 1;&lt;br/&gt;
Wait 40 seconds &lt;br/&gt;
select * from users where user_name = 1;  //All queries from this point forward will timeout. &lt;/p&gt;

&lt;p&gt;One of the potential fixes could be to set the TTL based on the remaining time left on another replicas. This will be TTL-timestamp of write. This timestamp is calculated from ballot which uses server time.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12981178">CASSANDRA-12043</key>
            <summary>Syncing most recent commit in CAS across replicas can cause all CAS queries in the CQL partition to fail</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="kohlisankalp">Sankalp Kohli</reporter>
                        <labels>
                            <label>LWT</label>
                    </labels>
                <created>Tue, 21 Jun 2016 03:04:33 +0000</created>
                <updated>Fri, 25 Oct 2019 13:10:57 +0000</updated>
                            <resolved>Tue, 28 Jun 2016 13:26:36 +0000</resolved>
                                        <fixVersion>2.1.15</fixVersion>
                    <fixVersion>2.2.7</fixVersion>
                    <fixVersion>3.0.9</fixVersion>
                    <fixVersion>3.8</fixVersion>
                                    <component>Feature/Lightweight Transactions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="15340972" author="kohlisankalp" created="Tue, 21 Jun 2016 03:05:25 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="15344221" author="slebresne" created="Wed, 22 Jun 2016 12:25:27 +0000"  >&lt;p&gt;Yes, definitively sounds like something that will happen.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;One of the potential fixes could be to set the TTL based on the remaining time left on another replicas&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s an option. Though if I&apos;m not mistaken that means shipping that TTL with the commit message, which can&apos;t be easily done without changing the internode protocol (and I suspect we&apos;d rather not wait for 4.0 to fix that).&lt;/p&gt;

&lt;p&gt;Another option is, in &lt;tt&gt;beginAndRepairPaxos&lt;/tt&gt;, to ignore the most recent commit (and just proceed) if it&apos;s older than the TTL we set on the paxos table, which is pretty simple.&lt;/p&gt;

&lt;p&gt;But this does bring up a related problem: even if you ignore commits being replayed (i.e. even if you have no failures and all nodes gets the commits right away), you still have a potential windows in which new proposal might not be able to make progress due to clock skews (and general lack of perfect think). Indeed, currently every replica uses a local timestamp to decide if something is expired when reading the paxos state, so just after a state expired, if it is read, some node may return a MRC and other won&apos;t, and no amount of committing back that MRC will help (same reason than above, the node for which the MRC is expired still have a tombstone), and this until all nodes consider the MRC expired.&lt;/p&gt;

&lt;p&gt;Granted, assuming a decent NTP, that window shouldn&apos;t be too big, but it would also be nice to remove it, and I don&apos;t think that&apos;s terribly hard. All we need is to make sure all replicas use the same timestamp when deciding if a state is expired during a prepare. And we don&apos;t even have to send anything new with the prepare message since we have the ballot of the new proposal which contains the current time.&lt;/p&gt;

&lt;p&gt;So anyway, I&apos;m attaching below 2 commits that:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;ignore the MRC if it&apos;s older than whatever TTL we set on the paxos table&lt;/li&gt;
	&lt;li&gt;ensure we use the same &quot;stable&quot; timestamp (for expiration sake) across all nodes when reading the paxos state and for the ignoring above.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;The patch is against 2.1 and I need to merge up (it won&apos;t merge cleanly at least in 3.0) but I&apos;ll wait on the initial test results before doing that, and I also want to find some time to write some dtests for those. So not marking patch available just yet, but the general approach can be reviewed/discussed.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/12043-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt; &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-12043-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-12043-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15345619" author="kohlisankalp" created="Thu, 23 Jun 2016 03:04:59 +0000"  >&lt;p&gt;LGTM. I think we should get this reviewed through &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; as well. &lt;/p&gt;</comment>
                            <comment id="15347241" author="jasobrown" created="Thu, 23 Jun 2016 21:32:39 +0000"  >&lt;p&gt;+1. Thanks for the great code comments, as well!&lt;/p&gt;</comment>
                            <comment id="15347327" author="kohlisankalp" created="Thu, 23 Jun 2016 22:30:28 +0000"  >&lt;p&gt;Please commit this in 2.1.15 + &lt;/p&gt;</comment>
                            <comment id="15352028" author="kohlisankalp" created="Mon, 27 Jun 2016 23:18:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Please commit it. Thanks &lt;/p&gt;</comment>
                            <comment id="15352978" author="slebresne" created="Tue, 28 Jun 2016 13:26:36 +0000"  >&lt;p&gt;I still needed to merge the branch upwards and wait on CI results for all branch. This is now done and tests seem &quot;fine&quot; (no failure appears related) so committed. Thanks.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/12043-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-12043-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-12043-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/12043-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-12043-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-12043-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/12043-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-12043-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-12043-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/12043-3.9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.9&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-12043-3.9-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-12043-3.9-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15358348" author="rlow" created="Fri, 1 Jul 2016 04:06:30 +0000"  >&lt;p&gt;Nice detective work &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kohlisankalp&quot; class=&quot;user-hover&quot; rel=&quot;kohlisankalp&quot;&gt;kohlisankalp&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 20 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zs67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>