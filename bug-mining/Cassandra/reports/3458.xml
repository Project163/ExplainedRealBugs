<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8238] NPE in SizeTieredCompactionStrategy.filterColdSSTables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8238</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [CompactionExecutor:15] 2014-10-31 15:28:32,318 CassandraDaemon.java:153 - Exception in thread Thread[CompactionExecutor:15,1,main]
    java.lang.NullPointerException: null
    at org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy.filterColdSSTables(SizeTieredCompactionStrategy.java:181) ~[apache-cassandra-2.1.1.jar:2.1.1]
    at org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy.getNextBackgroundSSTables(SizeTieredCompactionStrategy.java:83) ~[apache-cassandra-2.1.1.jar:2.1.1]
    at org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy.getNextBackgroundTask(SizeTieredCompactionStrategy.java:267) ~[apache-cassandra-2.1.1.jar:2.1.1]
    at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:226) ~[apache-cassandra-2.1.1.jar:2.1.1]
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_72]
    at java.util.concurrent.FutureTask.run(FutureTask.java:262) ~[na:1.7.0_72]
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_72]
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_72]
    at java.lang.Thread.run(Thread.java:745) [na:1.7.0_72]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12752093">CASSANDRA-8238</key>
            <summary>NPE in SizeTieredCompactionStrategy.filterColdSSTables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="thobbs">Tom Hobbs</reporter>
                        <labels>
                    </labels>
                <created>Fri, 31 Oct 2014 22:14:13 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:29 +0000</updated>
                            <resolved>Mon, 16 Mar 2015 08:47:40 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.5</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14192626" author="thobbs" created="Fri, 31 Oct 2014 22:26:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; I&apos;m assigning this to you instead of patching it with a simple non-null check.  If it was dealing with system tables (where every sstable has a null readmeter), it would bail before this on the &lt;tt&gt;totalReads == 0.0&lt;/tt&gt; check.  So, I&apos;m guessing this may have to do with early opening.&lt;/p&gt;</comment>
                            <comment id="14198149" author="krummas" created="Wed, 5 Nov 2014 10:36:00 +0000"  >&lt;p&gt;Hmm, all early opened files should be marked as compacting so they would be filtered out on the line above, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; do you have a way to reproduce?&lt;/p&gt;</comment>
                            <comment id="14198898" author="thobbs" created="Wed, 5 Nov 2014 19:17:09 +0000"  >&lt;p&gt;No, I haven&apos;t attempted to reproduce, it was just reported on IRC.  There was only one instance of this occurring across the entire cluster, so I presume it&apos;s quite rare.&lt;/p&gt;</comment>
                            <comment id="14206198" author="krummas" created="Tue, 11 Nov 2014 09:15:38 +0000"  >&lt;p&gt;attaching patch to output which sstable had a null readMeter to be able to debug this&lt;/p&gt;</comment>
                            <comment id="14206691" author="thobbs" created="Tue, 11 Nov 2014 17:50:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; is the plan to commit this patch and wait for more info? If so, I would make the assertion message include something like &quot;If you&apos;re seeing this exception, please attach your logs to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8238&quot; title=&quot;NPE in SizeTieredCompactionStrategy.filterColdSSTables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8238&quot;&gt;&lt;del&gt;CASSANDRA-8238&lt;/del&gt;&lt;/a&gt; to help us debug.&quot;.&lt;/p&gt;</comment>
                            <comment id="14208085" author="krummas" created="Wed, 12 Nov 2014 14:44:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; yeah that was my intention. If you agree this is a good idea, I&apos;ll add your text on commit&lt;/p&gt;</comment>
                            <comment id="14208161" author="thobbs" created="Wed, 12 Nov 2014 15:53:06 +0000"  >&lt;p&gt;Okay, +1 on committing that for now.&lt;/p&gt;</comment>
                            <comment id="14211944" author="krummas" created="Fri, 14 Nov 2014 07:19:57 +0000"  >&lt;p&gt;ok, committed and closing as Cannot Reproduce - anyone hitting the bug should reopen.&lt;/p&gt;</comment>
                            <comment id="14359370" author="fredrikl74" created="Thu, 12 Mar 2015 20:46:41 +0000"  >&lt;p&gt;Reproduced this in 2.1.3.&lt;br/&gt;
I&apos;m not very familiar with the Cassandra codebase but took me the liberty to do some debugging.&lt;br/&gt;
This occurs when doing bulkloading from JMX. &lt;br/&gt;
The problem is that the SSTableLoader has a static initializer setting &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;
    {
        Config.setClientMode(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 
&lt;p&gt;(I guess going through JMX shouldn&apos;t be considered client mode but only when running SSTableLoader standalone).&lt;br/&gt;
Every SSTableReader created after the clientMode flag is set will have the readMeter set to null according to the SSTableReader constructor. The SSTableReader for SSTables existing at startup will have the readMeter set to some value but when JMX bulkloading is used, there will be a mix of SSTableReader for the same CF both with readMeter with a value and readMeter with null. That in combination with hot and cold SSTables in &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SizeTieredCompactionStrategy.filterColdSSTables(...)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; will trigger the NullPointerException when CompactionExecutor kicks in trying to compact the &quot;hot&quot; SSTables already existing from startup which have a readMeter set and the just streamed cold SSTables from JMX bulkloading which have readMeter set to null.&lt;/p&gt;

&lt;p&gt;Regards&lt;br/&gt;
/Fredrik&lt;/p&gt;</comment>
                            <comment id="14360210" author="krummas" created="Fri, 13 Mar 2015 11:06:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=fredrikl74&quot; class=&quot;user-hover&quot; rel=&quot;fredrikl74&quot;&gt;fredrikl74&lt;/a&gt; thanks for the report, this helps alot&lt;/p&gt;</comment>
                            <comment id="14360217" author="krummas" created="Fri, 13 Mar 2015 11:15:24 +0000"  >&lt;p&gt;note that filterColdSSTables is removed in 2.1.4 so this will not show itself there, still a bug that we set client mode when calling from JMX though&lt;/p&gt;</comment>
                            <comment id="14360395" author="krummas" created="Fri, 13 Mar 2015 14:15:15 +0000"  >&lt;p&gt;attaching patch that sets client mode outside of SSTableLoader&lt;/p&gt;

&lt;p&gt;note that this might break stuff for people who have extended sstable loader and written their own tools, added an error message which tells them what to do, but I dunno if that is enough?&lt;/p&gt;</comment>
                            <comment id="14360397" author="krummas" created="Fri, 13 Mar 2015 14:15:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="14360572" author="yukim" created="Fri, 13 Mar 2015 16:21:44 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14362939" author="krummas" created="Mon, 16 Mar 2015 08:47:40 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="14384825" author="ulises.cervino" created="Fri, 27 Mar 2015 22:39:20 +0000"  >&lt;p&gt;Should this be backported to 2.0 as well?&lt;/p&gt;</comment>
                            <comment id="14386279" author="krummas" created="Mon, 30 Mar 2015 06:41:45 +0000"  >&lt;p&gt;dunno, my thinking was that if anyone has enabled this in 2.0, they probably know what they are doing and removing this would change behavior a bit too much in 2.0&lt;/p&gt;

&lt;p&gt;edit: oops, thought this was another ticket, yes it should probably be backported&lt;/p&gt;</comment>
                            <comment id="14388830" author="thobbs" created="Tue, 31 Mar 2015 16:56:56 +0000"  >&lt;p&gt;I&apos;ve backported this to 2.0 as &lt;tt&gt;ec958f05e49&lt;/tt&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12680768" name="0001-assert-that-readMeter-is-not-null.patch" size="1245" author="marcuse" created="Tue, 11 Nov 2014 09:15:38 +0000"/>
                            <attachment id="12704436" name="0001-dont-always-set-client-mode-for-sstable-loader.patch" size="3197" author="marcuse" created="Fri, 13 Mar 2015 14:15:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21u6v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326774">2.1.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326275">2.1 beta1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>