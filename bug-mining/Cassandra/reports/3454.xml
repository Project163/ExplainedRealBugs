<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9036] &quot;disk full&quot; when running cleanup (on a far from full disk)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9036</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;m trying to run cleanup, but get this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO [CompactionExecutor:18] 2015-03-25 10:29:16,355 CompactionManager.java (line 564) Cleaning up SSTableReader(path=&apos;/cassandra/production/Data_daily/production-Data_daily-jb-4345750-Data.db&apos;)
ERROR [CompactionExecutor:18] 2015-03-25 10:29:16,664 CassandraDaemon.java (line 199) Exception in thread Thread[CompactionExecutor:18,1,main]
java.io.IOException: disk full
        at org.apache.cassandra.db.compaction.CompactionManager.doCleanupCompaction(CompactionManager.java:567)
        at org.apache.cassandra.db.compaction.CompactionManager.access$400(CompactionManager.java:63)
        at org.apache.cassandra.db.compaction.CompactionManager$5.perform(CompactionManager.java:281)
        at org.apache.cassandra.db.compaction.CompactionManager$2.call(CompactionManager.java:225)
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now that&apos;s odd, since:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Disk has some 680G left&lt;/li&gt;
	&lt;li&gt;The sstable it&apos;s trying to cleanup is far less than 680G:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# ls -lh *4345750*
-rw-r--r-- 1 cassandra cassandra  64M Mar 21 04:42 production-Data_daily-jb-4345750-CompressionInfo.db
-rw-r--r-- 1 cassandra cassandra 219G Mar 21 04:42 production-Data_daily-jb-4345750-Data.db
-rw-r--r-- 1 cassandra cassandra 503M Mar 21 04:42 production-Data_daily-jb-4345750-Filter.db
-rw-r--r-- 1 cassandra cassandra  42G Mar 21 04:42 production-Data_daily-jb-4345750-Index.db
-rw-r--r-- 1 cassandra cassandra 5.9K Mar 21 04:42 production-Data_daily-jb-4345750-Statistics.db
-rw-r--r-- 1 cassandra cassandra  81M Mar 21 04:42 production-Data_daily-jb-4345750-Summary.db
-rw-r--r-- 1 cassandra cassandra   79 Mar 21 04:42 production-Data_daily-jb-4345750-TOC.txt
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Sure, it&apos;s large, but it&apos;s not 680G. &lt;/p&gt;

&lt;p&gt;No other compactions are running on that server. I&apos;m getting this on 12 / 56 servers right now. &lt;/p&gt;

&lt;p&gt;Could it be some bug in the calculation of the expected size of the new sstable, perhaps? &lt;/p&gt;</description>
                <environment></environment>
        <key id="12785481">CASSANDRA-9036</key>
            <summary>&quot;disk full&quot; when running cleanup (on a far from full disk)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="snazy">Robert Stupp</assignee>
                                    <reporter username="forsberg">Erik Forsberg</reporter>
                        <labels>
                    </labels>
                <created>Wed, 25 Mar 2015 10:59:50 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:17 +0000</updated>
                            <resolved>Tue, 31 Mar 2015 08:52:00 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14381618" author="krummas" created="Thu, 26 Mar 2015 09:31:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt; could you have a look? I think it could be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7386&quot; title=&quot;JBOD threshold to prevent unbalanced disk utilization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7386&quot;&gt;&lt;del&gt;CASSANDRA-7386&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14382674" author="snazy" created="Thu, 26 Mar 2015 21:07:50 +0000"  >&lt;p&gt;As far as I can see it doesn&apos;t seem to be an issue in the code (neither in cleanup size calculation as far as i can see nor in writable directory picking).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=forsberg&quot; class=&quot;user-hover&quot; rel=&quot;forsberg&quot;&gt;forsberg&lt;/a&gt; can you run a patched build that logs the reason why a directory has been excluded? (&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12707595/9050-2.0.txt&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12707595/9050-2.0.txt&lt;/a&gt; from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9050&quot; title=&quot;Add debug level logging to Directories.getWriteableLocation()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9050&quot;&gt;&lt;del&gt;CASSANDRA-9050&lt;/del&gt;&lt;/a&gt;) It logs at &quot;debug&quot; level. So either add&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;log4j.logger.org.apache.cassandra.db.Directories=DEBUG
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to &lt;tt&gt;log4j-server.properties&lt;/tt&gt; or modify the patch to use &quot;info&quot; level.&lt;/p&gt;

&lt;p&gt;Do you have any special stuff in place? Some quota (don&apos;t think so)? Some special FS or FS settings?&lt;/p&gt;</comment>
                            <comment id="14383628" author="forsberg" created="Fri, 27 Mar 2015 10:27:47 +0000"  >&lt;p&gt;After applying patch:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO [CompactionExecutor:12] 2015-03-27 10:16:38,930 CompactionManager.java (line 564) Cleaning up SSTableReader(path=&apos;/cassandra/production/Data_daily/production-Data_daily-jb-4345750-Data.db&apos;)
DEBUG [CompactionExecutor:12] 2015-03-27 10:16:39,423 Directories.java (line 265) removing candidate /cassandra, usable=732825808896, requested=933404582552
ERROR [CompactionExecutor:12] 2015-03-27 10:16:39,424 CassandraDaemon.java (line 199) Exception in thread Thread[CompactionExecutor:12,1,main]
java.io.IOException: disk full
        at org.apache.cassandra.db.compaction.CompactionManager.doCleanupCompaction(CompactionManager.java:567)
        at org.apache.cassandra.db.compaction.CompactionManager.access$400(CompactionManager.java:63)
        at org.apache.cassandra.db.compaction.CompactionManager$5.perform(CompactionManager.java:281)
        at org.apache.cassandra.db.compaction.CompactionManager$2.call(CompactionManager.java:225)
        at java.util.concurrent.FutureTask.run(FutureTask.java:262)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The number it reports as usable corresponds quite well with output from df:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# df /cassandra
Filesystem      1K-blocks       Used Available Use% Mounted on
/dev/sda7      1893666392 1178016188 715650204  63% /cassandra
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The number it reports as requested doesn&apos;t at all correspond with the actual file size: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# ls -l /cassandra/production/Data_daily/production-Data_daily-jb-4345750-Data.db 
-rw-r--r-- 1 cassandra cassandra 234667877465 Mar 21 04:42 /cassandra/production/Data_daily/production-Data_daily-jb-4345750-Data.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The file is compressed, we&apos;re using DeflateCompressor:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# sstablemetadata /cassandra/production/Data_daily/production-Data_daily-jb-4345750-Data.db|grep Compr
Compression ratio: 0.21589549046598225
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;No quota. Filesystem is XFS. &lt;/p&gt;

&lt;p&gt;Is the estimation of space needed for compaction taking compression into account? &lt;/p&gt;</comment>
                            <comment id="14383648" author="snazy" created="Fri, 27 Mar 2015 10:45:29 +0000"  >&lt;p&gt;OK, thanks for trying the patch.&lt;br/&gt;
Then there&apos;s a bug in calculation of the sstable size for compaction - it requests 870GB, usable is 680GB (&lt;tt&gt;usable=732825808896, requested=933404582552&lt;/tt&gt;). So it is correct to ignore that directory candidate - &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14383665" author="snazy" created="Fri, 27 Mar 2015 11:06:40 +0000"  >&lt;p&gt;Right - the request size is the &lt;em&gt;uncompressed&lt;/em&gt; size. Will provide a patch that multiples that with the (previous) compression ratio soon. (so yes, it is related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7386&quot; title=&quot;JBOD threshold to prevent unbalanced disk utilization&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7386&quot;&gt;&lt;del&gt;CASSANDRA-7386&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="14383819" author="snazy" created="Fri, 27 Mar 2015 13:28:53 +0000"  >&lt;p&gt;Patch(es) are about to fix the issue in &lt;tt&gt;ColumnFamilyStore.getExpectedCompactedFileSize&lt;/tt&gt;, which returned the on-disk size for non-CLEANUP-compactions but the uncompressed size for CLEANUP-compactions.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; can you review?&lt;/p&gt;</comment>
                            <comment id="14383840" author="forsberg" created="Fri, 27 Mar 2015 13:41:02 +0000"  >&lt;p&gt;Applied the 2.0 version and put in production on one of my nodes. Cleanup of my rather-large-file now started without exception. &lt;/p&gt;

&lt;p&gt;So I&apos;m now officially happy! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14387006" author="jbellis" created="Mon, 30 Mar 2015 17:12:50 +0000"  >&lt;p&gt;(Marcus has a lot of reviews on his plate atm so giving this one to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt;.)&lt;/p&gt;</comment>
                            <comment id="14387590" author="yukim" created="Mon, 30 Mar 2015 23:26:30 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14388263" author="snazy" created="Tue, 31 Mar 2015 08:52:00 +0000"  >&lt;p&gt;Committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12707763" name="9036-2.0.txt" size="698" author="snazy" created="Fri, 27 Mar 2015 13:28:53 +0000"/>
                            <attachment id="12707764" name="9036-2.1.txt" size="698" author="snazy" created="Fri, 27 Mar 2015 13:28:53 +0000"/>
                            <attachment id="12707765" name="9036-3.0.txt" size="711" author="snazy" created="Fri, 27 Mar 2015 13:28:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 34 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i27bwv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>