<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:58:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10301] Search for items past end of descending BTreeSearchIterator can fail</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10301</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;A very simple problem, but obvious and with simple fix once it is made apparent.&lt;/p&gt;

&lt;p&gt;The internal &lt;tt&gt;seekTo&lt;/tt&gt; method uses &lt;tt&gt;binarySearch&lt;/tt&gt; semantics for its return value, however when searching backwards &lt;tt&gt;-1&lt;/tt&gt; is a real value that should be returned to the client, as it indicates &quot;past the end&quot; - so basing inexact matches from -1 leads to a conflicting meaning, and so it gets misinterpreted. Rebasing inexact results to -2 fixes the problem.&lt;/p&gt;

&lt;p&gt;This was not caught because the randomized testing apparently did not test for values outside the bounds of the btree. This has been fixed as well, and the tests did easily exhibit the problem without the fix.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12863157">CASSANDRA-10301</key>
            <summary>Search for items past end of descending BTreeSearchIterator can fail</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Sep 2015 18:53:11 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:56 +0000</updated>
                            <resolved>Fri, 18 Sep 2015 21:13:49 +0000</resolved>
                                        <fixVersion>3.0.0 rc1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14739359" author="benedict" created="Thu, 10 Sep 2015 18:55:47 +0000"  >&lt;p&gt;Patch available &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/10301&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s a little worrying this wasn&apos;t caught by any of the tests/dtests, as it&apos;s not a terribly weird scenario. We happened to catch it simply due to a confluence of accidents (some inadequacies in stress, and my choosing to perform descending tests to see how performance bears out)&lt;/p&gt;</comment>
                            <comment id="14743383" author="blambov" created="Mon, 14 Sep 2015 11:25:49 +0000"  >&lt;p&gt;It was not very easy to understand why this is a problem. I think the attempt to achieve &lt;tt&gt;binarySearch&lt;/tt&gt; semantics misled us both. That entails less-than relationship, which in turn makes the &lt;tt&gt;-1 - index&lt;/tt&gt; return sensible. In the reverse case we don&apos;t have that.&lt;/p&gt;

&lt;p&gt;I&apos;m also confused by the use of &apos;proceed&apos; as a verb meaning follow. I don&apos;t think that&apos;s a common meaning of the term, and people can easily interpret it as a misspelling of &apos;precede&apos;, which isn&apos;t what we want. Did you mean &apos;succeed&apos;?&lt;/p&gt;

&lt;p&gt;In the comment to &lt;tt&gt;seekTo&lt;/tt&gt; I&apos;d turn the reference to &lt;tt&gt;binarySearch&lt;/tt&gt; semantics to state more that this does &lt;em&gt;not&lt;/em&gt; follow it, and be even more explicit and state that on inexact match it returns &lt;tt&gt;-2 - index&lt;/tt&gt;, where &lt;tt&gt;index&lt;/tt&gt; is such that&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;tree[index - 1] &amp;lt; key &amp;lt; tree[index]&lt;/tt&gt; in the forward case&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;tree[index] &amp;lt; key &amp;lt; tree[index + 1]&lt;/tt&gt; in the reverse case&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;which would show why &lt;tt&gt;-1 = -2 - (-1)&lt;/tt&gt; is necessary.&lt;/p&gt;

&lt;p&gt;I&apos;m not very happy with this solution as it&apos;s error-prone and confusing. Have you considered &lt;tt&gt;seekTo&lt;/tt&gt; returning just whether it matched or not, and exposing the current index separately?&lt;/p&gt;</comment>
                            <comment id="14743399" author="benedict" created="Mon, 14 Sep 2015 11:41:32 +0000"  >&lt;p&gt;It really does follow binarySearch semantics, only during descent it honours those semantics on the inverted indexes (i.e. if you were to reverse the array, and its indexes (so -1 == size()), before performing binary search, which is in essence what we are doing, just without the reversal)&lt;/p&gt;

&lt;p&gt;I did mean &quot;proceed&quot; as in &quot;proceeding&quot; which is the antonym of &quot;preceding&quot; or &quot;to precede&quot;. I don&apos;t mind changing it to succeed, but in common parlance &quot;to proceed&quot; is more common than &quot;to succeed&quot; for this meaning (succeed is more commonly associated with &lt;em&gt;success&lt;/em&gt; not sequence)&lt;/p&gt;

&lt;p&gt;I&apos;m not remotely as upset with this as you are, but I&apos;m also perfectly happy to move the call out into the BTSI next method, and will formulate a patch to do so. &lt;del&gt;I very much doubt this would have prevented the mistake, but it is at least no worse&lt;/del&gt; Of course, it would have.&lt;/p&gt;</comment>
                            <comment id="14743727" author="benedict" created="Mon, 14 Sep 2015 16:01:52 +0000"  >&lt;p&gt;Pushed an update with that addressed. It is clearer and should result in more compact byte code to boot. Thanks&lt;/p&gt;</comment>
                            <comment id="14743739" author="blambov" created="Mon, 14 Sep 2015 16:06:00 +0000"  >&lt;p&gt;Looks good, +1.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;&quot;proceed&quot; as in &quot;proceeding&quot; which is the antonym of &quot;preceding&quot; or &quot;to precede&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I mentioned it because I did not find this meaning in any of the online dictionaries, including the Oxbridge ones, which made me wary of using it in places where ease of understanding is a top priority. Thank you for changing it.&lt;/p&gt;</comment>
                            <comment id="14743757" author="benedict" created="Mon, 14 Sep 2015 16:14:57 +0000"  >&lt;p&gt;Well, it looks like &quot;common parlance&quot; == &quot;benedict parlance&quot; as I can find only very few uses, non reputable.&lt;/p&gt;</comment>
                            <comment id="14805333" author="slebresne" created="Fri, 18 Sep 2015 09:57:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Are you waiting on something for committing?&lt;/p&gt;</comment>
                            <comment id="14805342" author="benedict" created="Fri, 18 Sep 2015 10:11:04 +0000"  >&lt;p&gt;Yes, I&apos;ve been waiting all week for a CI run that didn&apos;t fail due to environment/CICI/trunk upgrade conflict issues. I forgot to kick another try off yesterday after the driver conflicts were resolved.&lt;/p&gt;</comment>
                            <comment id="14805351" author="slebresne" created="Fri, 18 Sep 2015 10:17:31 +0000"  >&lt;p&gt;Yeah, CI runs are not terribly reliable these days unfortunately, nor very fast to run. That&apos;s a shame.&lt;/p&gt;</comment>
                            <comment id="14876124" author="iamaleksey" created="Fri, 18 Sep 2015 18:38:54 +0000"  >&lt;p&gt;Pushed &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/10301-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, verbatim, on top of latest cassandra-3.0 branch. Will commit once cassci is happy. &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/iamaleksey/job/iamaleksey-10301-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; and &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/iamaleksey/job/iamaleksey-10301-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14876433" author="iamaleksey" created="Fri, 18 Sep 2015 21:13:41 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/aef71696e6f19d2569d310206b287f919da32b4f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;aef71696e6f19d2569d310206b287f919da32b4f&lt;/a&gt; to cassandra-3.0 and merged with trunk, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 9 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2k0iv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blambov</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>