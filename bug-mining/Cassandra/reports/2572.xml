<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6107] CQL3 Batch statement memory leak</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6107</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We are doing large volume insert/update tests on a CASS via CQL3. &lt;/p&gt;


&lt;p&gt;Using 4GB heap, after roughly 750,000 updates create/update 75,000 row keys, we run out of heap, and it never dissipates, and we begin getting this infamous error which many people seem to be encountering:&lt;/p&gt;

&lt;p&gt;WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;ScheduledTasks:1&amp;#93;&lt;/span&gt; 2013-09-26 16:17:10,752 GCInspector.java (line 142) Heap is 0.9383457210434385 full.  You may need to reduce memtable and/or cache sizes.  Cassandra will now flush up to the two largest memtables to free up memory.  Adjust flush_largest_memtables_at threshold in cassandra.yaml if you don&apos;t want Cassandra to do this automatically&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ScheduledTasks:1&amp;#93;&lt;/span&gt; 2013-09-26 16:17:10,753 StorageService.java (line 3614) Unable to reduce heap usage since there are no dirty column families&lt;/p&gt;


&lt;p&gt;8 and 12 GB heaps appear to delay the problem by roughly proportionate amounts of 75,000 - 100,000 rowkeys per 4GB. Each run of 50,000 row key creations sees the heap grow and never shrink again. &lt;/p&gt;

&lt;p&gt;We have attempted to no effect:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;removing all secondary indexes to see if that alleviates overuse of bloom filters&lt;/li&gt;
	&lt;li&gt;adjusted parameters for compaction throughput&lt;/li&gt;
	&lt;li&gt;adjusted memtable flush thresholds and other parameters&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;By examining heapdumps, it seems apparent that the problem is perpetual retention of CQL3 BATCH statements. We have even tried dropping the keyspaces after the updates and the CQL3 statement are still visible in the heapdump, and after many many many CMS GC runs. G1 also showed this issue.&lt;/p&gt;

&lt;p&gt;The 750,000 statements are broken into batches of roughly 200 statements.&lt;/p&gt;</description>
                <environment>&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;CASS version: 1.2.8 or 2.0.1, same issue seen in both&lt;/li&gt;
	&lt;li&gt;Running on OSX MacbookPro&lt;/li&gt;
	&lt;li&gt;Sun JVM 1.7&lt;/li&gt;
	&lt;li&gt;Single local cassandra node&lt;/li&gt;
	&lt;li&gt;both CMS and G1 GC used&lt;/li&gt;
	&lt;li&gt;we are using the cass-JDBC driver to submit our batches&lt;/li&gt;
&lt;/ul&gt;

</environment>
        <key id="12670953">CASSANDRA-6107</key>
            <summary>CQL3 Batch statement memory leak</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="lyubent">Lyuben Todorov</assignee>
                                    <reporter username="cowardlydragon">Constance Eustace</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 Sep 2013 15:18:32 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:04 +0000</updated>
                            <resolved>Sun, 6 Oct 2013 16:29:26 +0000</resolved>
                                        <fixVersion>1.2.11</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13780018" author="cowardlydragon" created="Fri, 27 Sep 2013 15:22:41 +0000"  >&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Further examination of several point-in-time heap dumps show that ALL cql statement batches are retained in the heap. Each statement has multiple collections such as ConcurrentHashMap and other data structures which will obviously consume huge amounts of resources.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;We have run a smaller run that does NOT batch our updates. It is obviously much slower, but the heap dumps show over time objects being garbage collected propertly.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="13780037" author="cowardlydragon" created="Fri, 27 Sep 2013 15:58:27 +0000"  >&lt;p&gt;It appears that since we are sending preparedStatements (this allows us to prep the statement and then set the consistency level), that the preparedStatements are never evicted from the prepared statement cache in org.apache.cassandra.cql3.QueryProcessor&lt;/p&gt;

&lt;p&gt;There are no removes ever done to preparedStatements or thriftPreparedStatements...&lt;/p&gt;

&lt;p&gt;This may technically be our fault for preparing every single batch statement, but shouldn&apos;t there be a limit on stored prep statements with LRU eviction?&lt;/p&gt;</comment>
                            <comment id="13780045" author="slebresne" created="Fri, 27 Sep 2013 16:08:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;but shouldn&apos;t there be a limit on stored prep statements with LRU eviction?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There is (from QueryProcessor.java):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    public static final int MAX_CACHE_PREPARED = 100000; // Enough to keep buggy clients from OOM&apos;ing us
    private static final Map&amp;lt;MD5Digest, CQLStatement&amp;gt; preparedStatements = new ConcurrentLinkedHashMap.Builder&amp;lt;MD5Digest, CQLStatement&amp;gt;()
                                                                               .maximumWeightedCapacity(MAX_CACHE_PREPARED)
                                                                               .build();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;but it&apos;s possible that this limit was too high to prevent you from OOM&apos;ing in that case. And maybe that hard-coded is too high&lt;/p&gt;

&lt;p&gt;But really, you should not prepare every single statement, it is a client error.&lt;/p&gt;</comment>
                            <comment id="13780049" author="cowardlydragon" created="Fri, 27 Sep 2013 16:10:21 +0000"  >&lt;p&gt;It appears you are using a MAX_CACHE_PREPARED of 100,000, and COncurrentLinkedHashMap should use that as an evictor.&lt;/p&gt;

&lt;p&gt;If the individual keys for 200 line batch statements are large (say, 10k, which I think based on the heap dump they consist of 1 map per statement in the batch possibly, so that is easily possible). So 100000 x 100000 bytes per statement = 10 gigabytes... uhoh. &lt;/p&gt;

&lt;p&gt;I think 600,000 updates, which are 3000 batches of 200 statements each popped the heap for a 4GB. I figure 1 GB of that heap is used for filters/sstables/memtables/etc, so 3000 batches popped 3GB of heap, so a megabyte per batch.&lt;/p&gt;

&lt;p&gt;Can we expose the MAX_CACHE_PREPARED as a config parameter?&lt;/p&gt;</comment>
                            <comment id="13780053" author="cowardlydragon" created="Fri, 27 Sep 2013 16:14:48 +0000"  >&lt;p&gt;I agree, there is client dysfunction here... we&apos;re going to stop prepping the statements, if possible (I think the cass jdbc project may have required prepping to set the consistency level, which sucks, but let me verify).&lt;/p&gt;</comment>
                            <comment id="13780066" author="cowardlydragon" created="Fri, 27 Sep 2013 16:22:08 +0000"  >&lt;p&gt;We&apos;re using SpringJDBC on top of the cass-jdbc driver. In order to intercept the update and specify consistency, that is only convenient with a PreparedStatementCreator...&lt;/p&gt;

&lt;p&gt;so we will not use SpringJDBC/PreparedStatementCreator and instead do a more manual JDBC call...&lt;/p&gt;

&lt;p&gt;sorry for the &quot;critical&quot; spam...&lt;/p&gt;</comment>
                            <comment id="13780073" author="jbellis" created="Fri, 27 Sep 2013 16:30:48 +0000"  >&lt;p&gt;Could we fix the OOM by adding a weight to the Map entry instead of assuming all entries are equal?&lt;/p&gt;</comment>
                            <comment id="13780083" author="slebresne" created="Fri, 27 Sep 2013 16:48:20 +0000"  >&lt;p&gt;Given that prepared is not performance sensitive, I suppose we could even use jmeter to get the precise in-memory size, and then cap the prepared statements to some percentage of the heap.&lt;/p&gt;</comment>
                            <comment id="13780090" author="jbellis" created="Fri, 27 Sep 2013 16:53:43 +0000"  >&lt;p&gt;That sounds reasonable.&lt;/p&gt;

&lt;p&gt;I&apos;d actually just pin it as something pretty small like 1MB; with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4693&quot; title=&quot;CQL Protocol should allow multiple PreparedStatements to be atomically executed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4693&quot;&gt;&lt;del&gt;CASSANDRA-4693&lt;/del&gt;&lt;/a&gt; we shouldn&apos;t need to prepare monstrous batches.&lt;/p&gt;</comment>
                            <comment id="13780095" author="cowardlydragon" created="Fri, 27 Sep 2013 17:00:18 +0000"  >&lt;p&gt;Yep, removing statement preparation looks good! Heap is GC&apos;ing, and multiple runs can be done.&lt;/p&gt;</comment>
                            <comment id="13784625" author="lyubent" created="Wed, 2 Oct 2013 23:29:33 +0000"  >&lt;p&gt;Added a MemoryMeter to QueryProcessor#getStatement to track the size of each ParsedStatement that is Prepared. If the statement is more than 1MB (1048576 bytes) than an IllegalArgumentsException is thrown. Also added the size of the prepared statement in the tracing line inside of QueryProcessor#getStatement. &lt;/p&gt;</comment>
                            <comment id="13784635" author="iamaleksey" created="Wed, 2 Oct 2013 23:42:57 +0000"  >&lt;p&gt;I don&apos;t think the issue here is (just) large individual prepared statements. It&apos;s the total size that all the prepared statements are occupying. That&apos;s what should be tracked and limited, not just the individual ones.&lt;/p&gt;</comment>
                            <comment id="13784658" author="jbellis" created="Wed, 2 Oct 2013 23:59:45 +0000"  >&lt;p&gt;Right.  Use the size you&apos;re calculating as the weight in the cache Map.&lt;/p&gt;</comment>
                            <comment id="13785241" author="lyubent" created="Thu, 3 Oct 2013 14:39:00 +0000"  >&lt;p&gt;Changed the MemoryMeter to measure the full map rather than enforcing restrictions on individual prepared statements. The hardcoded maximum is 100MB for the thrift cache and 100MB for the CQL cache. &lt;/p&gt;
</comment>
                            <comment id="13785251" author="jbellis" created="Thu, 3 Oct 2013 15:01:30 +0000"  >&lt;p&gt;Use the cache weigher/weightedCapacity api instead of re-measuring the entire cache each time.  then the cache will take care of evicting old ones to make room as needed.&lt;/p&gt;

&lt;p&gt;suggest making the capacity 1/256 of heap size.&lt;/p&gt;

&lt;p&gt;should probably have a separate setting for maximum single statement size.  if a single statement is under this threshold but larger than the cache, execute it but do not cache it.&lt;/p&gt;

&lt;p&gt;finally, statementid size should be negligible, i&apos;d leave that out.&lt;/p&gt;</comment>
                            <comment id="13785252" author="lyubent" created="Thu, 3 Oct 2013 15:01:54 +0000"  >&lt;p&gt;Memory Usage graph for batches of &apos;insert&apos; statements with varying numbers of columns.  &lt;/p&gt;</comment>
                            <comment id="13786226" author="lyubent" created="Fri, 4 Oct 2013 15:15:50 +0000"  >&lt;p&gt;Set the total cache for the statements to 1/256 of the heap (for thrift and cql), set the individual statement limit to 1MB. If a statement is less than 1MB but too large for the cache, it&apos;s executed but not stored in the cache.&lt;/p&gt;</comment>
                            <comment id="13786522" author="jbellis" created="Fri, 4 Oct 2013 19:18:22 +0000"  >&lt;p&gt;On second thought, rejecting really huge statements should be done at the protocol level.  I&apos;ll follow up with Sylvain to see if we&apos;re already doing that.&lt;/p&gt;

&lt;p&gt;v4 attached that just does the weighing as discussed.  WDYT?&lt;/p&gt;</comment>
                            <comment id="13787552" author="lyubent" created="Sun, 6 Oct 2013 10:18:27 +0000"  >&lt;p&gt;LGTM. But i was able to build some pretty big batch statements ( &amp;gt;4MB ) so I&apos;m not sure about the rejection of large statements at protocol level.&lt;/p&gt;</comment>
                            <comment id="13787649" author="jbellis" created="Sun, 6 Oct 2013 15:32:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure about the rejection of large statements at protocol level.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think that&apos;s what &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5981&quot; title=&quot;Netty frame length exception when storing data to Cassandra using binary protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5981&quot;&gt;&lt;del&gt;CASSANDRA-5981&lt;/del&gt;&lt;/a&gt; is open for, actually.&lt;/p&gt;</comment>
                            <comment id="13787671" author="jbellis" created="Sun, 6 Oct 2013 16:29:26 +0000"  >&lt;p&gt;commented&lt;/p&gt;</comment>
                            <comment id="13787971" author="slebresne" created="Mon, 7 Oct 2013 07:54:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5981&quot; title=&quot;Netty frame length exception when storing data to Cassandra using binary protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5981&quot;&gt;&lt;del&gt;CASSANDRA-5981&lt;/del&gt;&lt;/a&gt; is indeed about limiting the size at the protocol level. However it&apos;s a global frame limitation. In particular this is the hard limit for queries with their values and for that reason the current hard-coded limit is relatively high (256MB). And we can bikeshed on the exact default to user and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5981&quot; title=&quot;Netty frame length exception when storing data to Cassandra using binary protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5981&quot;&gt;&lt;del&gt;CASSANDRA-5981&lt;/del&gt;&lt;/a&gt; will probably allow the user to play with that limit, but in any case, it will definitively have to be higher than the 1MB. The other detail is that the limit done by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5981&quot; title=&quot;Netty frame length exception when storing data to Cassandra using binary protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5981&quot;&gt;&lt;del&gt;CASSANDRA-5981&lt;/del&gt;&lt;/a&gt; is on the sent bytes, not the in-memory size of the query, but that probably don&apos;t matter much.&lt;/p&gt;

&lt;p&gt;Anyway, provided that a prepared statement doesn&apos;t include values, it wouldn&apos;t be absurd to have a specific, lower limit on their size. Though my own preference would be to just leave it to a global limit on the preparedStatements cache map (but it could make sense to reject statements that blow up the entire limit on their own, so as to make sure to respect it). Too many hard-coded limitations make me nervous.&lt;/p&gt;</comment>
                            <comment id="13812415" author="mikeoz" created="Sun, 3 Nov 2013 16:48:02 +0000"  >&lt;p&gt;This change appears to break code that uses EmbeddedCassandraService and PreparedStatements in version 1.2.11.  Please see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6293&quot; title=&quot;CASSANDRA-6107 causes EmbeddedCassandraService to fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6293&quot;&gt;&lt;del&gt;CASSANDRA-6293&lt;/del&gt;&lt;/a&gt; for details.&lt;/p&gt;</comment>
                            <comment id="13886716" author="jbellis" created="Thu, 30 Jan 2014 16:14:44 +0000"  >&lt;p&gt;Note: this was reverted in 1.2.14 because of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6592&quot; title=&quot;IllegalArgumentException when Preparing Statements&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6592&quot;&gt;&lt;del&gt;CASSANDRA-6592&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12677279">CASSANDRA-6293</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12606863" name="6107-v4.txt" size="5622" author="jbellis" created="Fri, 4 Oct 2013 19:18:29 +0000"/>
                            <attachment id="12606480" name="6107.patch" size="2242" author="lyubent" created="Wed, 2 Oct 2013 23:30:11 +0000"/>
                            <attachment id="12606584" name="6107_v2.patch" size="4123" author="lyubent" created="Thu, 3 Oct 2013 14:39:00 +0000"/>
                            <attachment id="12606805" name="6107_v3.patch" size="6933" author="lyubent" created="Fri, 4 Oct 2013 15:15:50 +0000"/>
                            <attachment id="12606586" name="Screen Shot 2013-10-03 at 17.59.37.png" size="78667" author="lyubent" created="Thu, 3 Oct 2013 15:01:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[lyubent]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>350782</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ohcv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>351073</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324948">1.2.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>