<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8346] Paxos operation can use stale data during multiple range movements</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8346</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Paxos operations correctly account for pending ranges for all operation pertaining to the Paxos state, but those pending ranges are not taken into account when reading the data to check for the conditions or during a serial read. It&apos;s thus possible to break the LWT guarantees by reading a stale value.  This require 2 node movements (on the same token range) to be a problem though.&lt;/p&gt;

&lt;p&gt;Basically, we have &lt;tt&gt;RF&lt;/tt&gt; replicas + &lt;tt&gt;P&lt;/tt&gt; pending nodes. For the Paxos prepare/propose phases, the number of required participants (the &quot;Paxos QUORUM&quot;) is &lt;tt&gt;(RF + P + 1) / 2&lt;/tt&gt; (&lt;tt&gt;SP.getPaxosParticipants&lt;/tt&gt;), but the read done to check conditions or for serial reads is done at a &quot;normal&quot; QUORUM (or LOCAL_QUORUM), and so a weaker &lt;tt&gt;(RF + 1) / 2&lt;/tt&gt;. We have a problem if it&apos;s possible that said read can read only from nodes that were not part of the paxos participants, and so we have a problem if:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;normal quorum&quot; == (RF + 1) / 2 &amp;lt;= (RF + P) - ((RF + P + 1) / 2) == &quot;participants considered - blocked for&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We&apos;re good if &lt;tt&gt;P = 0&lt;/tt&gt; or &lt;tt&gt;P = 1&lt;/tt&gt; since this inequality gives us respectively &lt;tt&gt;RF + 1 &amp;lt;= RF - 1&lt;/tt&gt; and &lt;tt&gt;RF + 1 &amp;lt;= RF&lt;/tt&gt;, both of which are impossible. But at &lt;tt&gt;P = 2&lt;/tt&gt; (2 pending nodes), this inequality is equivalent to &lt;tt&gt;RF &amp;lt;= RF&lt;/tt&gt; and so we might read stale data.&lt;/p&gt;
</description>
                <environment></environment>
        <key id="12756673">CASSANDRA-8346</key>
            <summary>Paxos operation can use stale data during multiple range movements</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Thu, 20 Nov 2014 10:34:29 +0000</created>
                <updated>Thu, 31 Oct 2019 17:20:42 +0000</updated>
                            <resolved>Tue, 9 Dec 2014 20:13:33 +0000</resolved>
                                        <fixVersion>2.0.12</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14219211" author="slebresne" created="Thu, 20 Nov 2014 10:38:11 +0000"  >&lt;p&gt;I don&apos;t think there is much fix we can do (reading from the pending endpoints could also return stale data since those aren&apos;t yet up to date), so I think the simplest fix is to throw an UnavailableException if we have more than 2 pending endpoints. Attaching patch to do that.&lt;/p&gt;</comment>
                            <comment id="14223353" author="jbellis" created="Mon, 24 Nov 2014 19:24:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=kohlisankalp&quot; class=&quot;user-hover&quot; rel=&quot;kohlisankalp&quot;&gt;kohlisankalp&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="14234140" author="kohlisankalp" created="Thu, 4 Dec 2014 11:33:31 +0000"  >&lt;p&gt;Let me review it. &lt;/p&gt;</comment>
                            <comment id="14234375" author="kohlisankalp" created="Thu, 4 Dec 2014 17:19:31 +0000"  >&lt;p&gt;You want to pass the msg like this&lt;br/&gt;
super(ExceptionCode.UNAVAILABLE, &quot;Cannot achieve consistency level &quot; + consistency);&lt;br/&gt;
should be&lt;br/&gt;
super(ExceptionCode.UNAVAILABLE, msg); &lt;/p&gt;

&lt;p&gt;Apart from that looks good. &lt;/p&gt;</comment>
                            <comment id="14239216" author="jzeischka" created="Tue, 9 Dec 2014 09:58:42 +0000"  >&lt;p&gt;Could issue 8446 be linked to this? &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8446&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-8446&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Can we try the patch available for this issue (8346)?&lt;/p&gt;</comment>
                            <comment id="14239355" author="kohlisankalp" created="Tue, 9 Dec 2014 12:36:31 +0000"  >&lt;p&gt;I don&apos;t think it is related as this JIRA is used when there is range movements. &lt;/p&gt;</comment>
                            <comment id="14239562" author="beriz" created="Tue, 9 Dec 2014 15:47:49 +0000"  >&lt;p&gt;If I look at the changes in the attachment, I see that the changes made in &quot;getPaxosParticipants&quot; has an impact on method &quot;readWithPaxos&quot; in the StorageProxy. I&apos;m not familiar with the codebase so I could be mistaken, but it would explain why we see problems with lightweight transactions when we use a replication factor of 3 and we don&apos;t see that problem surfacing with a replication factor of 2.&lt;/p&gt;</comment>
                            <comment id="14239980" author="slebresne" created="Tue, 9 Dec 2014 20:13:33 +0000"  >&lt;p&gt;Committed (with the change to the message in UnavailableException), thanks.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beriz&quot; class=&quot;user-hover&quot; rel=&quot;beriz&quot;&gt;beriz&lt;/a&gt; I also don&apos;t think that issue is related to this, but if you still suspect it is, testing the patch on this issue to see if it helps should be easy enough.&lt;/p&gt;</comment>
                            <comment id="16519472" author="githubbot" created="Thu, 21 Jun 2018 15:06:52 +0000"  >&lt;p&gt;Github user ifesdjeen commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/224#discussion_r197133241&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/224#discussion_r197133241&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/org/apache/cassandra/service/StorageProxy.java &amp;#8212;&lt;br/&gt;
    @@ -344,47 +343,43 @@ private static void recordCasContention(int contentions)&lt;br/&gt;
                 casWriteMetrics.contention.update(contentions);&lt;br/&gt;
         }&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static Predicate&amp;lt;InetAddressAndPort&amp;gt; sameDCPredicateFor(final String dc)&lt;br/&gt;
    +    private static Predicate&amp;lt;Replica&amp;gt; sameDCPredicateFor(final String dc)&lt;br/&gt;
         {&lt;br/&gt;
             final IEndpointSnitch snitch = DatabaseDescriptor.getEndpointSnitch();&lt;/li&gt;
	&lt;li&gt;return new Predicate&amp;lt;InetAddressAndPort&amp;gt;()&lt;/li&gt;
	&lt;li&gt;{&lt;/li&gt;
	&lt;li&gt;public boolean apply(InetAddressAndPort host)&lt;/li&gt;
	&lt;li&gt;{
    -                return dc.equals(snitch.getDatacenter(host));
    -            }&lt;/li&gt;
	&lt;li&gt;};&lt;br/&gt;
    +        return replica -&amp;gt; dc.equals(snitch.getDatacenter(replica));&lt;br/&gt;
         }&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;         private static PaxosParticipants getPaxosParticipants(TableMetadata metadata, DecoratedKey key, ConsistencyLevel consistencyForPaxos) throws UnavailableException&lt;br/&gt;
         {&lt;br/&gt;
             Token tk = key.getToken();&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;List&amp;lt;InetAddressAndPort&amp;gt; naturalEndpoints = StorageService.instance.getNaturalEndpoints(metadata.keyspace, tk);&lt;/li&gt;
	&lt;li&gt;Collection&amp;lt;InetAddressAndPort&amp;gt; pendingEndpoints = StorageService.instance.getTokenMetadata().pendingEndpointsFor(tk, metadata.keyspace);&lt;br/&gt;
    +        ReplicaList naturalReplicas = StorageService.instance.getNaturalReplicas(metadata.keyspace, tk);&lt;br/&gt;
    +        ReplicaList pendingReplicas = new ReplicaList(StorageService.instance.getTokenMetadata().pendingEndpointsFor(tk, metadata.keyspace));&lt;br/&gt;
             if (consistencyForPaxos == ConsistencyLevel.LOCAL_SERIAL)
             {
    -            // Restrict naturalEndpoints and pendingEndpoints to node in the local DC only
    +            // Restrict naturalReplicas and pendingReplicas to node in the local DC only
                 String localDc = DatabaseDescriptor.getEndpointSnitch().getDatacenter(FBUtilities.getBroadcastAddressAndPort());
    -            Predicate&amp;lt;InetAddressAndPort&amp;gt; isLocalDc = sameDCPredicateFor(localDc);
    -            naturalEndpoints = ImmutableList.copyOf(Iterables.filter(naturalEndpoints, isLocalDc));
    -            pendingEndpoints = ImmutableList.copyOf(Iterables.filter(pendingEndpoints, isLocalDc));
    +            Predicate&amp;lt;Replica&amp;gt; isLocalDc = sameDCPredicateFor(localDc);
    +            naturalReplicas = ReplicaList.immutableCopyOf(naturalReplicas.filter(isLocalDc));
    +            pendingReplicas = ReplicaList.immutableCopyOf(pendingReplicas.filter(isLocalDc));
             }&lt;/li&gt;
	&lt;li&gt;int participants = pendingEndpoints.size() + naturalEndpoints.size();&lt;br/&gt;
    +        int participants = pendingReplicas.size() + naturalReplicas.size();&lt;br/&gt;
             int requiredParticipants = participants / 2 + 1; // See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8346&quot; title=&quot;Paxos operation can use stale data during multiple range movements&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8346&quot;&gt;&lt;del&gt;CASSANDRA-8346&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-833&quot; title=&quot;fix consistencylevel during bootstrap&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-833&quot;&gt;&lt;del&gt;CASSANDRA-833&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;List&amp;lt;InetAddressAndPort&amp;gt; liveEndpoints = ImmutableList.copyOf(Iterables.filter(Iterables.concat(naturalEndpoints, pendingEndpoints), IAsyncCallback.isAlive));&lt;/li&gt;
	&lt;li&gt;if (liveEndpoints.size() &amp;lt; requiredParticipants)&lt;/li&gt;
	&lt;li&gt;throw new UnavailableException(consistencyForPaxos, requiredParticipants, liveEndpoints.size());&lt;br/&gt;
    +&lt;br/&gt;
    +        Replicas concatenated = Replicas.concatNaturalAndPending(naturalReplicas, pendingReplicas);&lt;br/&gt;
    +        ReplicaList liveReplicas = ReplicaList.immutableCopyOf(Replicas.filter(concatenated, IAsyncCallback.isReplicaAlive));
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    Same here (with Immutable).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13184608">CASSANDRA-14723</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12768165">CASSANDRA-8640</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12682614" name="8346.txt" size="3793" author="slebresne" created="Thu, 20 Nov 2014 10:38:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i22ln3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>kohlisankalp</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[kohlisankalp]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>