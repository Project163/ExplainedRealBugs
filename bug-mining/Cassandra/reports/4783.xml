<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:07:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13004] Corruption while adding/removing a column to/from the table</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13004</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We had the following schema in production. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;CREATE TYPE IF NOT EXISTS discord_channels.channel_recipient (
    nick text
);

CREATE TYPE IF NOT EXISTS discord_channels.channel_permission_overwrite (
    id bigint,
    type int,
    allow_ int,
    deny int
);

CREATE TABLE IF NOT EXISTS discord_channels.channels (
    id bigint,
    guild_id bigint,
    type tinyint,
    name text,
    topic text,
    position int,
    owner_id bigint,
    icon_hash text,
    recipients map&amp;lt;bigint, frozen&amp;lt;channel_recipient&amp;gt;&amp;gt;,
    permission_overwrites map&amp;lt;bigint, frozen&amp;lt;channel_permission_overwrite&amp;gt;&amp;gt;,
    bitrate int,
    user_limit int,
    last_pin_timestamp timestamp,
    last_message_id bigint,
    PRIMARY KEY (id)
);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then we executed the following alter.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;ALTER TABLE discord_channels.channels ADD application_id bigint;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And one row (that we can tell) got corrupted at the same time and could no longer be read from the Python driver. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;[E 161206 01:56:58 geventreactor:141] Error decoding response from Cassandra. ver(4); flags(0000); stream(27); op(8); offset(9); len(887); buffer: &apos;\x84\x00\x00\x1b\x08\x00\x00\x03w\x00\x00\x00\x02\x00\x00\x00\x01\x00\x00\x00\x0f\x00\x10discord_channels\x00\x08channels\x00\x02id\x00\x02\x00\x0eapplication_id\x00\x02\x00\x07bitrate\x00\t\x00\x08guild_id\x00\x02\x00\ticon_hash\x00\r\x00\x0flast_message_id\x00\x02\x00\x12last_pin_timestamp\x00\x0b\x00\x04name\x00\r\x00\x08owner_id\x00\x02\x00\x15permission_overwrites\x00!\x00\x02\x000\x00\x10discord_channels\x00\x1cchannel_permission_overwrite\x00\x04\x00\x02id\x00\x02\x00\x04type\x00\t\x00\x06allow_\x00\t\x00\x04deny\x00\t\x00\x08position\x00\t\x00\nrecipients\x00!\x00\x02\x000\x00\x10discord_channels\x00\x11channel_recipient\x00\x01\x00\x04nick\x00\r\x00\x05topic\x00\r\x00\x04type\x00\x14\x00\nuser_limit\x00\t\x00\x00\x00\x01\x00\x00\x00\x08\x03\x8a\x19\x8e\xf8\x82\x00\x01\xff\xff\xff\xff\x00\x00\x00\x04\x00\x00\xfa\x00\x00\x00\x00\x08\x00\x00\xfa\x00\x00\xf8G\xc5\x00\x00\x00\x00\x00\x00\x00\x08\x03\x8b\xc0\xb5nB\x00\x02\x00\x00\x00\x08G\xc5\xffI\x98\xc4\xb4(\x00\x00\x00\x03\x8b\xc0\xa8\xff\xff\xff\xff\x00\x00\x01&amp;lt;\x00\x00\x00\x06\x00\x00\x00\x08\x03\x81L\xea\xfc\x82\x00\n\x00\x00\x00$\x00\x00\x00\x08\x03\x81L\xea\xfc\x82\x00\n\x00\x00\x00\x04\x00\x00\x00\x01\x00\x00\x00\x04\x00\x00\x08\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x08\x03\x8a\x1e\xe6\x8b\x80\x00\n\x00\x00\x00$\x00\x00\x00\x08\x03\x8a\x1e\xe6\x8b\x80\x00\n\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x040\x07\xf8Q\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x08\x03\x8a\x1f\x1b{\x82\x00\x00\x00\x00\x00$\x00\x00\x00\x08\x03\x8a\x1f\x1b{\x82\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00\x07\xf8Q\x00\x00\x00\x04\x10\x00\x00\x00\x00\x00\x00\x08\x03\x8a\x1fH6\x82\x00\x01\x00\x00\x00$\x00\x00\x00\x08\x03\x8a\x1fH6\x82\x00\x01\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00\x05\xe8A\x00\x00\x00\x04\x10\x02\x00\x00\x00\x00\x00\x08\x03\x8a+=\xca\xc0\x00\n\x00\x00\x00$\x00\x00\x00\x08\x03\x8a+=\xca\xc0\x00\n\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x08\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x08\x03\x8a\x8f\x979\x80\x00\n\x00\x00\x00$\x00\x00\x00\x08\x03\x8a\x8f\x979\x80\x00\n\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00 \x08\x01\x00\x00\x00\x04\xc4\xb4(\x00\xff\xff\xff\xff\x00\x00\x00O[f\x80Q\x07general\x05\xf8G\xc5\xffI\x98\xc4\xb4(\x00\xf8O[f\x80Q\x00\x00\x00\x02\x04\xf8O[f\x80Q\x00\xf8G\xc5\xffI\x98\x01\x00\x00\xf8O[f\x80Q\x00\x00\x00\x00\xf8G\xc5\xffI\x97\xc4\xb4(\x06\x00\xf8O\x7fe\x1fm\x08\x03\x00\x00\x00\x01\x00\x00\x00\x00\x04\x00\x00\x00\x00&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then in cqlsh when trying to read the row we got this. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;/usr/bin/cqlsh.py:632: DateOverFlowWarning: Some timestamps are larger than Python datetime can represent. Timestamps are displayed in milliseconds from epoch.
Traceback (most recent call last):
  File &quot;/usr/bin/cqlsh.py&quot;, line 1301, in perform_simple_statement
    result = future.result()
  File &quot;/usr/share/cassandra/lib/cassandra-driver-internal-only-3.5.0.post0-d8d0456.zip/cassandra-driver-3.5.0.post0-d8d0456/cassandra/cluster.py&quot;, line 3650, in result
    raise self._final_exception
UnicodeDecodeError: &apos;utf8&apos; codec can&apos;t decode byte 0x80 in position 2: invalid start byte
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We tried to read the data and it would refuse to read the name column (the UTF8 error) and the last_pin_timestamp column had an absurdly large value.&lt;/p&gt;

&lt;p&gt;We ended up rewriting the whole row as we had the data in another place and it fixed the problem. However there is clearly a race condition in the schema change sub-system.&lt;/p&gt;

&lt;p&gt;Any ideas?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13025830">CASSANDRA-13004</key>
            <summary>Corruption while adding/removing a column to/from the table</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="stanislav">Stanislav Vishnevskiy</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Dec 2016 02:23:51 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:58 +0000</updated>
                            <resolved>Fri, 16 Jun 2017 15:38:18 +0000</resolved>
                                        <fixVersion>3.0.14</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Distributed Metadata</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>30</watches>
                                                                                                                <comments>
                            <comment id="15724156" author="stanislav" created="Tue, 6 Dec 2016 03:01:01 +0000"  >&lt;p&gt;We found this in the logs at the exact time this happened.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [SharedPool-Worker-11] 2016-12-06 01:44:16,971 Message.java:617 - Unexpected exception during request; channel = [id: 0xbd9a77e9, /10.10.0.48:38317 =&amp;gt; /10.10.0.129:9042]
java.io.IOError: java.io.IOException: Corrupt value length 1485619006 encountered, as it exceeds the maximum of 268435456, which is set via max_value_size_in_mb in cassandra.yaml
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer$1.computeNext(UnfilteredRowIteratorSerializer.java:222) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer$1.computeNext(UnfilteredRowIteratorSerializer.java:210) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.utils.MergeIterator$Candidate.advance(MergeIterator.java:369) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.advance(MergeIterator.java:189) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:158) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:509) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:369) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.transform.FilteredRows.isEmpty(FilteredRows.java:50) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.transform.Filter.closeIfEmpty(Filter.java:73) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.transform.Filter.applyToPartition(Filter.java:43) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.transform.Filter.applyToPartition(Filter.java:26) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:96) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.cql3.statements.SelectStatement.process(SelectStatement.java:707) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.cql3.statements.SelectStatement.processResults(SelectStatement.java:400) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:353) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:227) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:76) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:206) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:487) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:464) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.transport.messages.ExecuteMessage.execute(ExecuteMessage.java:130) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:513) [apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:407) [apache-cassandra-3.0.9.jar:3.0.9]
	at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:333) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.access$700(AbstractChannelHandlerContext.java:32) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext$8.run(AbstractChannelHandlerContext.java:324) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [na:1.8.0_111]
	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) [apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [apache-cassandra-3.0.9.jar:3.0.9]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_111]
Caused by: java.io.IOException: Corrupt value length 1485619006 encountered, as it exceeds the maximum of 268435456, which is set via max_value_size_in_mb in cassandra.yaml
	at org.apache.cassandra.db.marshal.AbstractType.readValue(AbstractType.java:402) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.rows.BufferCell$Serializer.deserialize(BufferCell.java:302) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.readComplexColumn(UnfilteredSerializer.java:502) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.deserializeRowBody(UnfilteredSerializer.java:456) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.deserialize(UnfilteredSerializer.java:377) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer$1.computeNext(UnfilteredRowIteratorSerializer.java:217) ~[apache-cassandra-3.0.9.jar:3.0.9]
	... 35 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15725002" author="stanislav" created="Tue, 6 Dec 2016 10:07:24 +0000"  >&lt;p&gt;On another node we saw this.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-none&quot;&gt;ERROR [MessagingService-Incoming-/10.10.0.129] 2016-12-06 01:44:17,430 CassandraDaemon.java:205 - Exception in thread Thread[MessagingService-Incoming-/10.10.0.129,5,main]
java.lang.RuntimeException: Unknown column application_id during deserialization
	at org.apache.cassandra.db.Columns$Serializer.deserialize(Columns.java:432) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.SerializationHeader$Serializer.deserializeForMessaging(SerializationHeader.java:427) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.deserializeHeader(UnfilteredRowIteratorSerializer.java:190) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize30(PartitionUpdate.java:661) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize(PartitionUpdate.java:635) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:334) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:353) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:290) ~[apache-cassandra-3.0.9.jar:3.0.9]
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:98) ~[apache-cassandra-3.0.9.jar:3.0.9]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15731690" author="stanislav" created="Thu, 8 Dec 2016 09:45:23 +0000"  >&lt;p&gt;We just ran into this issue on an older 3.0.7 cluster with fairly low write velocity (70/sec).&lt;/p&gt;</comment>
                            <comment id="15732587" author="thobbs" created="Thu, 8 Dec 2016 15:57:41 +0000"  >&lt;p&gt;I&apos;m going to try to reproduce this locally.&lt;/p&gt;</comment>
                            <comment id="15732790" author="thobbs" created="Thu, 8 Dec 2016 17:13:24 +0000"  >&lt;p&gt;It&apos;s not too surprising to see that right around the time of an alter.  That basically just means that the node hadn&apos;t received the schema update yet when the mutation came in.&lt;/p&gt;</comment>
                            <comment id="15733064" author="thobbs" created="Thu, 8 Dec 2016 18:54:55 +0000"  >&lt;p&gt;I haven&apos;t had any luck reproducing this locally yet.  I looked into the response that the driver had trouble decoding, and this is the breakdown:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;\x84\x00\x00\x1b\x08\x00\x00\x03w\x00\x00\x00\x02\x00\x00\x00\x01\x00\x00\x00\x0f\x00\x10discord_channels\x00\x08channels  # flags and metadata

\x00\x02id\x00\x02                                 # col 0
\x00\x0eapplication_id\x00\x02                     # col 1
\x00\x07bitrate\x00\t                              # col 2
\x00\x08guild_id\x00\x02                           # col 3
\x00\ticon_hash\x00\r                              # col 4
\x00\x0flast_message_id\x00\x02                    # col 5
\x00\x12last_pin_timestamp\x00\x0b                 # col 6
\x00\x04name\x00\r                                 # col 7
\x00\x08owner_id\x00\x02                           # col 8
\x00\x15permission_overwrites\x00!                 # col 9
  \x00\x02\x000\x00\x10discord_channels\x00\x1c
  channel_permission_overwrite\x00\x04
    \x00\x02id\x00\x02
    \x00\x04type\x00\t
    \x00\x06allow_\x00\t
    \x00\x04deny\x00\t
\x00\x08position\x00\t                             # col 10
\x00\nrecipients\x00!                              # col 11
  \x00\x02\x000\x00\x10discord_channels\x00\x11channel_recipient\x00\x01
  \x00\x04nick\x00\r
\x00\x05topic\x00\r                                # col 12
\x00\x04type\x00\x14                               # col 13
\x00\nuser_limit\x00\t                             # col 14

\x00\x00\x00\x01                                   # row count

\x00\x00\x00\x08 \x03\x8a\x19\x8e\xf8\x82\x00\x01  # value 0, id (255044430745174017)

\xff\xff\xff\xff                                   # value 1, application_id (null)

\x00\x00\x00\x04 \x00\x00\xfa\x00                  # value 2, bitrate (64000)

\x00\x00\x00\x08 \x00\x00\xfa\x00\x00\xf8G\xc5     # value 3, guild_id (274877923215301)

\x00\x00\x00\x00                                   # value 4 icon_hash (empty string)

\x00\x00\x00\x08 \x03\x8b\xc0\xb5nB\x00\x02        # value 5 last_message_id (255509689347997698)

\x00\x00\x00\x08 G\xc5\xffI\x98\xc4\xb4(           # value 6 last_pin_timestamp (5171820438665606184)

\x00\x00\x00\x03 \x8b\xc0\xa8                      # value 7 (non-UTF8 compliant string)

\xff\xff\xff\xff                                   # value 8, owner_id (null)

\x00\x00\x01&amp;lt;                                      # value 9, (length 316 user type)

\x00\x00\x00\x06\x00\x00\x00\x08\x03\x81L\xea\xfc\x82\x00\n\x00\x00\x00$\x00\x00\x00\x08\x03\x81L\xea\xfc\x82\x00\n\x00\x00\x00\x04\x00\x00\x00\x01\x00\x00\x00\x04\x00\x00\x08\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x08\x03\x8a\x1e\xe6\x8b\x80\x00\n\x00\x00\x00$\x00\x00\x00\x08\x03\x8a\x1e\xe6\x8b\x80\x00\n\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x040\x07\xf8Q\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x08\x03\x8a\x1f\x1b{\x82\x00\x00\x00\x00\x00$\x00\x00\x00\x08\x03\x8a\x1f\x1b{\x82\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00\x07\xf8Q\x00\x00\x00\x04\x10\x00\x00\x00\x00\x00\x00\x08\x03\x8a\x1fH6\x82\x00\x01\x00\x00\x00$\x00\x00\x00\x08\x03\x8a\x1fH6\x82\x00\x01\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00\x05\xe8A\x00\x00\x00\x04\x10\x02\x00\x00\x00\x00\x00\x08\x03\x8a+=\xca\xc0\x00\n\x00\x00\x00$\x00\x00\x00\x08\x03\x8a+=\xca\xc0\x00\n\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x08\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x08\x03\x8a\x8f\x979\x80\x00\n\x00\x00\x00$\x00\x00\x00\x08\x03\x8a\x8f\x979\x80\x00\n\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x04\x00 \x08\x01

\x00\x00\x00\x04 \xc4\xb4(\x00                     # value 10, position (3300141056)
\xff\xff\xff\xff                                   # value 11, recipients (null)
\x00\x00\x00O                                      # value 12, topic (79 char string)
[f\x80Q\x07general\x05\xf8G\xc5\xffI\x98\xc4\xb4(\x00\xf8O[f\x80Q\x00\x00\x00\x02\x04\xf8O[f\x80Q\x00\xf8G\xc5\xffI\x98\x01\x00\x00\xf8O[f\x80Q\x00\x00\x00\x00\xf8G\xc5\xffI\x97\xc4\xb4(\x06\x00\xf8O\x7fe\x1fm\x08\x03
\x00\x00\x00\x01 \x00                              # value 13, type (0)
\x00\x00\x00\x04 \x00\x00\x00\x00                  # value 14, user_limit (0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Do any of the other column values look incorrect to you?&lt;/p&gt;</comment>
                            <comment id="15733208" author="thobbs" created="Thu, 8 Dec 2016 19:37:17 +0000"  >&lt;p&gt;I chatted with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stanislav&quot; class=&quot;user-hover&quot; rel=&quot;stanislav&quot;&gt;stanislav&lt;/a&gt; on IRC.  Here are some details:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;This happened on two different clusters with different schemas.  In the cluster with only 70 writes/sec at the time, it appears that 7 rows were affected.  In the cluster with 7000 writes at the time, it appears that hundreds of rows were affected.  So, it seems like there&apos;s a window of time during which the alter causes problems, and the higher the throughput, the more rows are affected.&lt;/li&gt;
	&lt;li&gt;Inserts are done with prepared &lt;tt&gt;INSERT&lt;/tt&gt; statements across many different clients.  Some &lt;tt&gt;UPDATES&lt;/tt&gt; and &lt;tt&gt;DELETES&lt;/tt&gt; also occur.&lt;/li&gt;
	&lt;li&gt;The cluster is three nodes, RF=3&lt;/li&gt;
	&lt;li&gt;No other alters have been run on the tables&lt;/li&gt;
	&lt;li&gt;In the other schema, two specific columns seemed to be affected (sometimes one, sometimes the other).  In the original schema posted here, it seems to affect a specific set of columns as well.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;My guess is that we&apos;re not updating our internal metadata around the schema atomically/isolated somewhere, and we&apos;re writing the data with a mixture of old and new schema info.&lt;/p&gt;</comment>
                            <comment id="15733234" author="thobbs" created="Thu, 8 Dec 2016 19:52:00 +0000"  >&lt;p&gt;This could also be related to the problems described in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9425&quot; title=&quot;Make node-local schema fully immutable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9425&quot;&gt;&lt;del&gt;CASSANDRA-9425&lt;/del&gt;&lt;/a&gt;.  Seems like the changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8099&quot; title=&quot;Refactor and modernize the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8099&quot;&gt;&lt;del&gt;CASSANDRA-8099&lt;/del&gt;&lt;/a&gt; may be exposing those issues.&lt;/p&gt;</comment>
                            <comment id="15733326" author="jhg" created="Thu, 8 Dec 2016 20:30:37 +0000"  >&lt;p&gt;Hey, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; I work with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stanislav&quot; class=&quot;user-hover&quot; rel=&quot;stanislav&quot;&gt;stanislav&lt;/a&gt; - looking at the data above, values 7 10 and 12 look to be wrong.&lt;/p&gt;</comment>
                            <comment id="15838688" author="jjirsa" created="Wed, 25 Jan 2017 22:08:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stanislav&quot; class=&quot;user-hover&quot; rel=&quot;stanislav&quot;&gt;stanislav&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jhg&quot; class=&quot;user-hover&quot; rel=&quot;jhg&quot;&gt;jhg&lt;/a&gt; - can you confirm what CL you used to read and write data? Do you happen to know if your data was corrupt on more than one node?&lt;/p&gt;</comment>
                            <comment id="15838695" author="stanislav" created="Wed, 25 Jan 2017 22:12:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; We read and write at LOCAL_QUORUM. We don&apos;t remember if it corrupted the same way on each node, but we couldn&apos;t read it correctly with LOCAL_ONE when we tried. We have since fixed this data by rewriting it.&lt;/p&gt;</comment>
                            <comment id="15840271" author="jjirsa" created="Thu, 26 Jan 2017 19:28:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stanislav&quot; class=&quot;user-hover&quot; rel=&quot;stanislav&quot;&gt;stanislav&lt;/a&gt;I assume that these were initial writes (straight &lt;tt&gt;INSERT&lt;/tt&gt; s that got corrupted, not &lt;tt&gt;UPDATE&lt;/tt&gt; applied to existing rows)?&lt;/p&gt;

&lt;p&gt;(I understand that you corrected it by overwriting, but the writes that were corrupt - they were only written once?)&lt;/p&gt;</comment>
                            <comment id="15840365" author="jhg" created="Thu, 26 Jan 2017 20:18:41 +0000"  >&lt;p&gt;It was updates that were corrupted. I.e. Updating a few columns out of the row &lt;/p&gt;
</comment>
                            <comment id="15840512" author="jjirsa" created="Thu, 26 Jan 2017 21:43:38 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jhg&quot; class=&quot;user-hover&quot; rel=&quot;jhg&quot;&gt;jhg&lt;/a&gt; - trying my best to repro and not much luck, but I&apos;m going to keep trying.&lt;/p&gt;</comment>
                            <comment id="15855257" author="nimi" created="Tue, 7 Feb 2017 03:46:35 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I think I&apos;m hitting the same issue on 3.5 - for us it prevents us from bootstrapping any new nodes. Oddly we can sometimes do reads just fine (SELECT * FROM table), but other times we get a timeout exception with the &quot;Corrupt length&quot; in our logs. We tried scrub (no effect), and we tried dumping the entire table to JSON, TRUNCATING it, and reinserting all the data - and even the new fresh sstables hit this issue.&lt;/p&gt;

&lt;p&gt;(Node is running 3.5, but we are using 3.10&apos;s sstabledump).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;db@cass2:~/apache-cassandra-3.10/bin$ sudo ../tools/bin/sstabledump /mnt/dsk2/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/cmuser/users-68b04ac07c5011e5a85daf9a47bddf3d/ma-9473-big-Data.db 
WARN  03:41:14,442 Only 30.140GiB free across all data volumes. Consider adding more capacity to your cluster or removing obsolete snapshots
[
  {
    &lt;span class=&quot;code-quote&quot;&gt;&quot;partition&quot;&lt;/span&gt; : {
      &lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt; : [ &lt;span class=&quot;code-quote&quot;&gt;&quot;560c3b78-adf2-11e6-8ef2-f45c89b76d37&quot;&lt;/span&gt; ],
      &lt;span class=&quot;code-quote&quot;&gt;&quot;position&quot;&lt;/span&gt; : 0
    },
    &lt;span class=&quot;code-quote&quot;&gt;&quot;rows&quot;&lt;/span&gt; : [ ]
  }
]Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /mnt/dsk2/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/cmuser/users-68b04ac07c5011e5a85daf9a47bddf3d/ma-9473-big-Data.db
	at org.apache.cassandra.io.sstable.SSTableIdentityIterator.hasNext(SSTableIdentityIterator.java:134)
	at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:100)
	at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:32)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.tools.JsonTransformer.serializePartition(JsonTransformer.java:206)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:184)
	at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:175)
	at java.util.Iterator.forEachRemaining(Iterator.java:116)
	at java.util.Spliterators$IteratorSpliterator.forEachRemaining(Spliterators.java:1801)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:481)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:471)
	at java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)
	at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:418)
	at org.apache.cassandra.tools.JsonTransformer.toJson(JsonTransformer.java:99)
	at org.apache.cassandra.tools.SSTableExport.main(SSTableExport.java:240)
Caused by: java.io.IOException: Corrupt (negative) value length encountered
	at org.apache.cassandra.db.marshal.AbstractType.readValue(AbstractType.java:425)
	at org.apache.cassandra.db.rows.Cell$Serializer.deserialize(Cell.java:245)
	at org.apache.cassandra.db.rows.UnfilteredSerializer.readComplexColumn(UnfilteredSerializer.java:636)
	at org.apache.cassandra.db.rows.UnfilteredSerializer.lambda$deserializeRowBody$1(UnfilteredSerializer.java:577)
	at org.apache.cassandra.utils.btree.BTree.applyForwards(BTree.java:1222)
	at org.apache.cassandra.utils.btree.BTree.applyForwards(BTree.java:1226)
	at org.apache.cassandra.utils.btree.BTree.apply(BTree.java:1177)
	at org.apache.cassandra.db.Columns.apply(Columns.java:377)
	at org.apache.cassandra.db.rows.UnfilteredSerializer.deserializeRowBody(UnfilteredSerializer.java:571)
	at org.apache.cassandra.db.rows.UnfilteredSerializer.deserialize(UnfilteredSerializer.java:440)
	at org.apache.cassandra.io.sstable.SSTableSimpleIterator$CurrentFormatIterator.computeNext(SSTableSimpleIterator.java:95)
	at org.apache.cassandra.io.sstable.SSTableSimpleIterator$CurrentFormatIterator.computeNext(SSTableSimpleIterator.java:73)
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47)
	at org.apache.cassandra.io.sstable.SSTableIdentityIterator.hasNext(SSTableIdentityIterator.java:122)
	... 16 more
db@cass2:~/apache-cassandra-3.10/bin$ 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We have done ALTER TABLE&apos;s on this table, but not for a couple months. Similarly, I notice we both are using collection types with custom types - could that have something to do with the issue?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE cmuser.users (
    id timeuuid PRIMARY KEY,
    account_id text,
    api_key text,
    avatar text,
    channel text,
    city text,
    company text,
    country text,
    created timestamp,
    custom_id text,
    customer text,
    date_of_birth timestamp,
    description text,
    disabled &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,
    email text,
    hidden_from_community &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,
    language text,
    last_action timestamp,
    monitor &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,
    name text,
    notes text,
    objectid text,
    organizationid text,
    orgcontract set&amp;lt;frozen&amp;lt;contract&amp;gt;&amp;gt;,
    orgcontracts2 map&amp;lt;timeuuid, frozen&amp;lt;contract&amp;gt;&amp;gt;,
    orgispaid &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,
    orglevel &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
    orgownership set&amp;lt;frozen&amp;lt;ownership_rule&amp;gt;&amp;gt;,
    orgpayout &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;,
    orgreferrer timeuuid,
    orgrevshare revshare,
    orgsubnetwork timeuuid,
    orgtags set&amp;lt;text&amp;gt;,
    owner_key text,
    parentemail text,
    password blob,
    sh_providerno bigint,
    social map&amp;lt;text, text&amp;gt;,
    state text,
    test_account_id text,
    test_customer text
)

cqlsh:cmuser&amp;gt; describe type revshare

CREATE TYPE cmuser.revshare (
    partner decimal,
    subnetwork decimal,
    commission decimal,
    ugc decimal,
    version &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
    direct decimal,
    fanfunded decimal,
    bonus_partner decimal,
    cpm decimal,
    capcpm decimal
);
cqlsh:cmuser&amp;gt; describe type contract

CREATE TYPE cmuser.contract (
    id timeuuid,
    provider text,
    templateid text,
    templatename text,
    documentid text,
    downloadlink text,
    starts timestamp,
    ends timestamp,
    signed &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,
    signedon timestamp,
    sessionid text,
    sessionexpire timestamp
);
cqlsh:cmuser&amp;gt; describe type ownership_rule

CREATE TYPE cmuser.ownership_rule (
    field text,
    value text,
    readonly &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,
    hiderevenue &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,
    isprimary &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,
    exclude &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,
    skippayout &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;,
    orgpayout &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;,
    revshare frozen&amp;lt;revshare&amp;gt;
);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15856629" author="nimi" created="Tue, 7 Feb 2017 19:35:39 +0000"  >&lt;p&gt;Update on our issue - I tried reproducing this on another fresh cluster and found I couldn&apos;t recreate the original table - it had a UDT that wasn&apos;t frozen. (Not sure when the frozen&amp;lt;udt&amp;gt; restriction was issued - but some time in the past you could create non-frozen UDT columns).&lt;/p&gt;

&lt;p&gt;I then dropped the table and recreated the table from the backup and the error seems to have gone away.&lt;/p&gt;</comment>
                            <comment id="15860307" author="iamaleksey" created="Thu, 9 Feb 2017 22:12:42 +0000"  >&lt;p&gt;I&#8217;ve looked at various code paths that could plausibly introduce corruption wtih &lt;tt&gt;CFMetaData changing during the request cycle&lt;/tt&gt;:&lt;/p&gt;

&lt;p&gt;1. Prepared statement execution (&lt;tt&gt;EXECUTE&lt;/tt&gt; message, positionally matching byte buffers to types)&lt;br/&gt;
2. Write to the memtable, with &lt;tt&gt;CFMetaData&lt;/tt&gt; changing during the update&lt;br/&gt;
3.  &lt;tt&gt;Memtable&lt;/tt&gt; flush into sstable&lt;br/&gt;
4. sstable read&lt;/p&gt;

&lt;p&gt;1. This yielded nothing. Our prepared &lt;tt&gt;ModificationStatement&lt;/tt&gt; -s hold final immutable &lt;tt&gt;PartitionColumns&lt;/tt&gt; in &lt;tt&gt;updatedColumns&lt;/tt&gt;, and &lt;tt&gt;Operations&lt;/tt&gt;. An added column at any point in the process should not trigger corruption - we do not use the consult &lt;tt&gt;CFMetaData&lt;/tt&gt; to build &lt;tt&gt;PartitionUpdate&lt;/tt&gt; objects for insertion.&lt;br/&gt;
2. &lt;tt&gt;AtomicBTreePartition&lt;/tt&gt; constructor has an outdated comment back from 3.0.0 beta days, reading as &lt;tt&gt;involved in potential bug? partition columns may be a subset if we alter columns while it&apos;s in memtable&lt;/tt&gt;. It has, however, been addressed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10220&quot; title=&quot;Memtables do not handle column changes for their PartitionColumns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10220&quot;&gt;&lt;del&gt;CASSANDRA-10220&lt;/del&gt;&lt;/a&gt;. More importantly, it wouldn&#8217;t cause corruption in this case anyway, even if unaddressed. &lt;tt&gt;PartitionColumns&lt;/tt&gt; object in the &lt;tt&gt;Holder&lt;/tt&gt; is not used for sstable serialization.&lt;br/&gt;
3. &lt;tt&gt;UnfilteredSerializer.serialize()&lt;/tt&gt; method has some logic that initially seemed dodgy to me, and that was the check for &lt;tt&gt;hasAllColumns&lt;/tt&gt; merely comparing sizes of the row and of the known column set. I believe that that check is not completely solid, in case of column additions mixed with column removals, and can cause false positives. That said, we &#8216;d still error out later in the process, with an NPE when trying to get the type from &lt;tt&gt;SerializationHeader&lt;/tt&gt; and fail the flush.&lt;br/&gt;
4. Likewise, nothing really relevant here. &lt;/p&gt;

&lt;p&gt;One reason that schema propagation might cause corruption is altering a column type. That is something we already handled, by disabling that capability in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12443&quot; title=&quot;Remove alter type support&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12443&quot;&gt;&lt;del&gt;CASSANDRA-12443&lt;/del&gt;&lt;/a&gt; (in the upcoming 3.0.11 release). Until then, I would advise strongly against using &lt;tt&gt;ALTER TABLE ALTER&lt;/tt&gt; commands. But &lt;tt&gt;ALTER TABLE ADD&lt;/tt&gt; should be safe, even with our rather imperfect schema code.&lt;/p&gt;

&lt;p&gt;I have a feeling I&#8217;m not seeing the full story here. Without any new information, after a couple of us failed to replicate and/or analyse by following the code paths, I don&#8217;t think there is much we can do.&lt;/p&gt;

&lt;p&gt;If you do by any chance have the corrupted sstables remaining from the incident, however, I will have another look.&lt;/p&gt;

&lt;p&gt;Sorry for not being able to help.&lt;/p&gt;</comment>
                            <comment id="16019084" author="b1nzy" created="Mon, 22 May 2017 02:29:33 +0000"  >&lt;p&gt;Hey all, I work with Stan and Jake at Discord and have a few updates for this thread that may help drive us towards a solution.&lt;/p&gt;

&lt;p&gt;First up, we&apos;ve been able to produce a minimal reproduction with two sanitized rows of our production data set. So far this appears to be a 100% consistent reproduction, each time producing corrupted/unreadable data. Through the process of building this reproduction we&apos;ve noticed the following attributes to this bug:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;From what we can tell, this is not reproducible with a single node. We&apos;ve tested both 1 node, 3 node and 6 node clusters, with only the 3/6 combinations producing corruption.&lt;/li&gt;
	&lt;li&gt;The bug does not seem to be related to client driver, we&apos;ve tested both Python and gocql&lt;/li&gt;
	&lt;li&gt;Appears to exhibit itself on all 3.x versions (we&apos;ve mostly been testing on Cassandra 3.10)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I&apos;ve uploaded the reproduction case to github over at (&lt;a href=&quot;https://github.com/b1naryth1ef/cassandra-13004&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/b1naryth1ef/cassandra-13004&lt;/a&gt;). A few notes about this:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Some stuff might have to be tweaked (e.g. the cluster ip, keyspace replication datacenter) depending on your test env.&lt;/li&gt;
	&lt;li&gt;Although we reproduced this in Python too, I&apos;ve only included the Go version (mostly because the Python one was more heavily intertwined with our internal code). If it helps, I&apos;m mor ethan happy to cleanup and provide a Python version too.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;To run the reproduction, you must spin up a Cassandra 3.10 cluster, and then either run the script or the commands within &apos;test.sh&apos;. This creates the keyspace/types/table, and loads two rows in (there is a bug w/ recent versions of cqlsh that break loading of multiple large rows, so the script loads one road at a time). Finally, you can run the Go binary which will connect to the cluster and start reading/writing data. At this point you can run alters (I&apos;ve been using `ALTER TABLE test13004.guilds ADD aaa bigint;` which seems to work every time) and observe the output using cqlsh `SELECT * FROM test13004.guilds`.&lt;/p&gt;

&lt;p&gt;Happy to provide any more details or information as it&apos;s needed.&lt;/p&gt;
</comment>
                            <comment id="16019165" author="jjirsa" created="Mon, 22 May 2017 05:45:42 +0000"  >&lt;p&gt;Thanks for the script! Repro&apos;d for me on the first try on 3.0.13.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;MacBook-Pro:cassandra-13004 jjirsa$ ./stress
2017/05/21 22:34:18 ERROR ON READ 295331734109814785: java.io.IOError: java.io.IOException: Corrupt flags value &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; unfiltered partition (isStatic flag set): 252
2017/05/21 22:34:18 ERROR ON READ 295331720679522316: java.io.IOError: java.io.EOFException: EOF after 23415 bytes out of 262146
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;127.0.0.1:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [MessagingService-Incoming-/127.0.0.3] 2017-05-21 22:34:18,447 CassandraDaemon.java:207 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MessagingService-Incoming-/127.0.0.3,5,main]
java.lang.RuntimeException: Unknown column aaa during deserialization
	at org.apache.cassandra.db.Columns$Serializer.deserialize(Columns.java:432) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.SerializationHeader$Serializer.deserializeForMessaging(SerializationHeader.java:428) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.deserializeHeader(UnfilteredRowIteratorSerializer.java:190) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize30(PartitionUpdate.java:661) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize(PartitionUpdate.java:635) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:327) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:346) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:283) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:98) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:201) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:178) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:92) ~[apache-cassandra-3.0.13.jar:3.0.13]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;127.0.0.3:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [SharedPool-Worker-5] 2017-05-21 22:34:18,460 Message.java:621 - Unexpected exception during request; channel = [id: 0x7b0819ca, L:/127.0.0.3:9042 - R:/127.0.0.3:59709]
java.io.IOError: java.io.EOFException: EOF after 23415 bytes out of 262146
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer$1.computeNext(UnfilteredRowIteratorSerializer.java:222) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer$1.computeNext(UnfilteredRowIteratorSerializer.java:210) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.MergeIterator$Candidate.advance(MergeIterator.java:369) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.advance(MergeIterator.java:189) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:158) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:509) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:369) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.statements.SelectStatement.processPartition(SelectStatement.java:774) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.statements.SelectStatement.process(SelectStatement.java:711) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.statements.SelectStatement.processResults(SelectStatement.java:400) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:353) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:227) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:76) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:206) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:487) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:464) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.transport.messages.ExecuteMessage.execute(ExecuteMessage.java:130) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:513) [apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:407) [apache-cassandra-3.0.13.jar:3.0.13]
	at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) [netty-all-4.0.44.Final.jar:4.0.44.Final]
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:357) [netty-all-4.0.44.Final.jar:4.0.44.Final]
	at io.netty.channel.AbstractChannelHandlerContext.access$600(AbstractChannelHandlerContext.java:35) [netty-all-4.0.44.Final.jar:4.0.44.Final]
	at io.netty.channel.AbstractChannelHandlerContext$7.run(AbstractChannelHandlerContext.java:348) [netty-all-4.0.44.Final.jar:4.0.44.Final]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [na:1.8.0_112]
	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) [apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [apache-cassandra-3.0.13.jar:3.0.13]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_112]
Caused by: java.io.EOFException: EOF after 23415 bytes out of 262146
	at org.apache.cassandra.io.util.RebufferingInputStream.readFully(RebufferingInputStream.java:68) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.io.util.RebufferingInputStream.readFully(RebufferingInputStream.java:60) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.ByteBufferUtil.read(ByteBufferUtil.java:404) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.marshal.AbstractType.readValue(AbstractType.java:406) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.BufferCell$Serializer.deserialize(BufferCell.java:302) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.readComplexColumn(UnfilteredSerializer.java:531) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.deserializeRowBody(UnfilteredSerializer.java:485) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.deserializeOne(UnfilteredSerializer.java:412) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.deserialize(UnfilteredSerializer.java:368) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer$1.computeNext(UnfilteredRowIteratorSerializer.java:217) ~[apache-cassandra-3.0.13.jar:3.0.13]
	... 31 common frames omitted
ERROR [SharedPool-Worker-14] 2017-05-21 22:34:18,460 Message.java:621 - Unexpected exception during request; channel = [id: 0x7b0819ca, L:/127.0.0.3:9042 - R:/127.0.0.3:59709]
java.io.IOError: java.io.IOException: Corrupt flags value &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; unfiltered partition (isStatic flag set): 252
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer$1.computeNext(UnfilteredRowIteratorSerializer.java:222) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer$1.computeNext(UnfilteredRowIteratorSerializer.java:210) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.MergeIterator$Candidate.advance(MergeIterator.java:369) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.advance(MergeIterator.java:189) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:158) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:509) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredRowIterators$UnfilteredRowMergeIterator.computeNext(UnfilteredRowIterators.java:369) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.statements.SelectStatement.processPartition(SelectStatement.java:774) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.statements.SelectStatement.process(SelectStatement.java:711) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.statements.SelectStatement.processResults(SelectStatement.java:400) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:353) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:227) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:76) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:206) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:487) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:464) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.transport.messages.ExecuteMessage.execute(ExecuteMessage.java:130) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:513) [apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:407) [apache-cassandra-3.0.13.jar:3.0.13]
	at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) [netty-all-4.0.44.Final.jar:4.0.44.Final]
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:357) [netty-all-4.0.44.Final.jar:4.0.44.Final]
	at io.netty.channel.AbstractChannelHandlerContext.access$600(AbstractChannelHandlerContext.java:35) [netty-all-4.0.44.Final.jar:4.0.44.Final]
	at io.netty.channel.AbstractChannelHandlerContext$7.run(AbstractChannelHandlerContext.java:348) [netty-all-4.0.44.Final.jar:4.0.44.Final]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) [na:1.8.0_112]
	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) [apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [apache-cassandra-3.0.13.jar:3.0.13]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_112]
Caused by: java.io.IOException: Corrupt flags value &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; unfiltered partition (isStatic flag set): 252
	at org.apache.cassandra.db.rows.UnfilteredSerializer.deserializeOne(UnfilteredSerializer.java:409) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.deserialize(UnfilteredSerializer.java:368) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer$1.computeNext(UnfilteredRowIteratorSerializer.java:217) ~[apache-cassandra-3.0.13.jar:3.0.13]
	... 31 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:test13004&amp;gt; select id,aaa from guilds;

 id                 | aaa
--------------------+---------------------
 295331720679522316 | 2336651670001381731
 295331734109814785 |                &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And obviously we never set &lt;tt&gt;aaa&lt;/tt&gt; to anything in &lt;tt&gt;stress.go&lt;/tt&gt; &lt;/p&gt;

</comment>
                            <comment id="16030026" author="jjirsa" created="Tue, 30 May 2017 19:53:04 +0000"  >&lt;p&gt;So I think two teams are trying to diagnose this in parallel, and I want to make sure we&apos;re communicating more broadly.&lt;/p&gt;

&lt;p&gt;Both of us (myself, and the folks at datastax) believe this is in read repair.&lt;/p&gt;

&lt;p&gt;Both of us believe that the fundamental problem is the subset encoding of columns ( from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9894&quot; title=&quot;Serialize the header only once per message&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9894&quot;&gt;&lt;del&gt;CASSANDRA-9894&lt;/del&gt;&lt;/a&gt; ), where our concept of column filters (&quot;*&quot; = all columns) and read repair interact in unpleasant ways. &lt;/p&gt;

&lt;p&gt;I&apos;m running some tests locally with &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/commit/5206ed2b9c18c03d6edf2682ff8b162e1d2b7486&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; patch, which so far seems to solve it, but let&apos;s not pretend this is a blessing that it&apos;s the only or right fix yet (as you can see, there are no tests, so please don&apos;t run this patch in prod, it&apos;s offered as-is without warranty).&lt;/p&gt;</comment>
                            <comment id="16031813" author="ifesdjeen" created="Wed, 31 May 2017 19:33:42 +0000"  >&lt;p&gt;I&apos;ve been able to narrow it down a little bit and wanted to elaborate on why I&apos;ve decided to take some extra time and caution on the issue to avoid protocol changes. Another problem is that if we fix the problem in &lt;tt&gt;SerializationHeader&lt;/tt&gt; and not &lt;tt&gt;ColumnFilter&lt;/tt&gt; we may potentially end up having other issues with &lt;tt&gt;ColumnFilter&lt;/tt&gt; since it would still have inconsistent view of columns on the replica side. To sum it up, I do agree that the issue is related to the initial exchange of columns, but I think that the problem is hiding within the &lt;tt&gt;ColumnFilter&lt;/tt&gt;. Two problems, in fact.&lt;/p&gt;

&lt;p&gt;It looks like &lt;tt&gt;ColumnFilter&lt;/tt&gt; can be created with one set of metadata and afterwards used with the other. Since &lt;tt&gt;ColumnFilter&lt;/tt&gt; is used for both serialisation and deserialisation, between creating a column filter and deserialising responses from replica, column set may get changed, and &lt;tt&gt;partitionColumns&lt;/tt&gt; of &lt;tt&gt;CfMetadata&lt;/tt&gt; will be a different collection. This will have negative impact on deserialisation: binary data will be validated and processed as a different set of columns. In some cases this results into corrupt flags, in other cases into EOF and the worst case scenario is when the data actually passes all validations and mutation lands the sstable. When trying to read, it will contain the data from the other column. The column itself in turn will just contain less data. In order to solve this problem, it is sufficient to cache the columns during the creation of the column filter.&lt;/p&gt;

&lt;p&gt;The second problem is, as Jeff has noted is hiding in the fact that we can not rely on the output of subset deserialisation in header &lt;a href=&quot;https://github.com/apache/cassandra/blob/8b3a60b9a7dbefeecc06bace617279612ec7092d/src/java/org/apache/cassandra/db/SerializationHeader.java#L401&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, because it is happening on replica an in the case with &lt;tt&gt;fetchesAll&lt;/tt&gt;, it will rely on the local replica metadata. Although I would suggest we resolve it a bit differently: by changing the way we serialise the column filter. Namely, by avoiding relying on the synchronised metadata in case of fetch all, and encoding all the columns. If this is considered to be too big of an overhead (I can imagine large column families holding a lot of columns may cause quite some traffic), we can at least use a hash of concatenated column names. &lt;/p&gt;

&lt;p&gt;On trunk the problem (1) can be fixed simpler, by passing a command cf reference instead of grabbing the base cf reference, which is fetched later. &lt;/p&gt;

&lt;p&gt;I have a preliminary patch that addresses (1) and (2) for 3.0 and 3.11 and a separate different patch for trunk, but since the logic of ColumnFilter kind of gets out of hand with all the excluding cases, I would like to take a bit more time to simplify it a bit. I hope I can submit it tomorrow.&lt;/p&gt;
</comment>
                            <comment id="16032747" author="ifesdjeen" created="Thu, 1 Jun 2017 10:18:32 +0000"  >&lt;p&gt;I&apos;ve prepared a preliminary patch. Unfortunately, because the column filter was changing so much (also, semantically), we all three patches are slightly different. &lt;/p&gt;

&lt;p&gt;To recap, what was the problem and how it is proposed to mitigate it:&lt;/p&gt;

&lt;p&gt;If the coordinator has a different view of schema than the replica, there was a single case when the replica was still relying on it&apos;s own local &lt;tt&gt;metadata.allColumns&lt;/tt&gt;. Problem with that is that is that deserialisation header then relies on that output and, because the bitset encoding is used, can end up grabbing a column with a different index (or even fewer columns). This leads to the problem that replica sends a result for one columnset and the coordinator is trying to parse it for the other columnset. Sometimes, if data is right, this leads to the exceptions: &lt;tt&gt;java.lang.ArrayIndexOutOfBoundsException: 82&lt;/tt&gt;, &lt;tt&gt;java.io.IOError: java.io.IOException: Corrupt (negative) value length encountered&lt;/tt&gt;, &lt;tt&gt;java.io.IOError: java.io.IOException: Corrupt flags value for unfiltered partition (isStatic flag set): 252&lt;/tt&gt;, &lt;tt&gt;java.io.IOError: java.io.EOFException: EOF after 16254 bytes out of 262147&lt;/tt&gt;, &lt;tt&gt;java.lang.AssertionError: deletedAt=-9223372036854775808, localDeletion=2147483647&lt;/tt&gt; (listing them here to simplify the search) to name a few, &lt;em&gt;all depending on the data, timestamps and many other factors&lt;/em&gt;. &lt;/p&gt;

&lt;p&gt;The other problem was on the coordinator itself, since there were cases when &lt;tt&gt;ColumnFilter&lt;/tt&gt; was serialised and sent with one set of columns and then, by the time response came back from replica, 3.x cfmetadata would get updated, and subsequent call to &lt;tt&gt;fetched&lt;/tt&gt; and &lt;tt&gt;queried&lt;/tt&gt; that would be used for deserialisation on coordinator would have a different view of columns from the request that&apos;s been sent. This is the case when the coordinator learns about the schema change quicker than replica. This was fixed by making sure we do not use a reference to metadata in column filter after it&apos;s creation.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...ifesdjeen:13004-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...ifesdjeen:13004-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.11-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.11-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:13004-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16033549" author="jjirsa" created="Thu, 1 Jun 2017 19:38:58 +0000"  >&lt;p&gt;I like this approach.  &lt;/p&gt;

&lt;p&gt;In &lt;tt&gt;ReadResponse&lt;/tt&gt; , we have two asserts that require &lt;tt&gt;assert version == MessagingService.VERSION_30&lt;/tt&gt; - shouldn&apos;t those need to be adjusted (&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/blob/13004-3.0/src/java/org/apache/cassandra/db/ReadResponse.java#L381&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and &lt;a href=&quot;https://github.com/ifesdjeen/cassandra/blob/13004-3.0/src/java/org/apache/cassandra/db/ReadResponse.java#L416-L418&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; ) ; frankly I&apos;m shocked that we didn&apos;t fail more dtests without those changes? &lt;/p&gt;

&lt;p&gt;Stylistically, in the trunk patch, the braces in &lt;tt&gt;ColumnFilter.java&lt;/tt&gt; lines 85-99 should be cleaned up. The style guide says we don&apos;t need braces for single-line if/else clauses, but for safety and readability, we should probably use braces on both the if/else if either have it. Therefore, the nested &lt;tt&gt;if&lt;/tt&gt; on &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:13004-trunk#diff-eb44d25147f999b2ed6580480c60d5b3R88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;L88&lt;/a&gt; could use braces, and the top level else &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:13004-trunk#diff-eb44d25147f999b2ed6580480c60d5b3R98&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; can use braces to match the &lt;tt&gt;if&lt;/tt&gt; . &lt;/p&gt;


&lt;p&gt;Bike-shedding, the last time we bumped messaging version mid-branch was 1.1.7 - at that time, &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-1.2/src/java/org/apache/cassandra/net/MessagingService.java#L76&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;we named the version&lt;/a&gt; &lt;tt&gt;MessagingService.VERSION_117&lt;/tt&gt;. Following that convention, we should probably call this &lt;tt&gt;MessaingService.VERSION_3014&lt;/tt&gt; or similar, because it&apos;s not really &lt;tt&gt;31&lt;/tt&gt; , as &quot;3.1&quot; is a thing with tick/tock. &lt;/p&gt;

&lt;p&gt;I&apos;d definitely like to see a clean test run with the assertions fixed. I can no longer repro the corruption with your branch, so beyond the logical explanation and review, that&apos;s encouraging. &lt;/p&gt;




</comment>
                            <comment id="16033682" author="ifesdjeen" created="Thu, 1 Jun 2017 20:57:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;In ReadResponse , we have two asserts that require assert version == MessagingService.VERSION_30 - shouldn&apos;t those need to be adjusted (here and here ) ; frankly I&apos;m shocked that we didn&apos;t fail more dtests without those changes?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m sorry, my initial patch had a copy/paste typo &lt;tt&gt;VERSION_31 = 30&lt;/tt&gt;. I have corrected and force-pushed it, although that was already after running tests. I didn&apos;t think the change was significant enough. &lt;/p&gt;

&lt;p&gt;When fixing, I&apos;ve copied the message from &lt;a href=&quot;https://github.com/apache/cassandra/blob/8b3a60b9a7dbefeecc06bace617279612ec7092d/src/java/org/apache/cassandra/db/ReadResponse.java#L221-L224&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; for consistency. &lt;/p&gt;

&lt;p&gt;I&apos;ve addressed the brackets and version issues as well. CI is now triggered, too. Links are the same.&lt;/p&gt;</comment>
                            <comment id="16034329" author="ifesdjeen" created="Fri, 2 Jun 2017 08:33:25 +0000"  >&lt;p&gt;Also, it&apos;s a bit unclear what to do with the version name. If we go with the mid-branch naming same as in &lt;tt&gt;1.1.7&lt;/tt&gt;, and name it &lt;tt&gt;VERSION_3014&lt;/tt&gt; its a bit unclear: how do we name this protocol version in &lt;tt&gt;3.11&lt;/tt&gt;? Still &lt;tt&gt;VERSION_3014&lt;/tt&gt; since it&apos;s originating from 3.0?&lt;/p&gt;

&lt;p&gt;Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; have ideas?&lt;/p&gt;</comment>
                            <comment id="16034371" author="slebresne" created="Fri, 2 Jun 2017 09:26:45 +0000"  >&lt;p&gt;Haven&apos;t really looked at the problem and patch in details so some of this comment is based on incomplete information, but bumping the messaging protocol version in a minor is kind of a really big deal, close to a deal breaker, because it currently breaks a lot of things during upgrade (schema propagation and all streaming) that people really don&apos;t expect to break in a minor release. I don&apos;t remember why we decided this was acceptable in &lt;tt&gt;1.1.7&lt;/tt&gt; but that was a long long time ago and we&apos;ve very carefully avoided MS version bump in minors ever since. My point being, we need to make extra sure there is no other possible option and understand the &quot;surface area&quot; of when this bug happen and what it impacts before getting there.&lt;/p&gt;

&lt;p&gt;On that front, my understanding of your comment above and a very quick scan of the patch is that &quot;addding a column to table while it&apos;s queried may break some queries while the ALTER proceeds&quot;. Which is certainly not awesome but sounds work-around-able by either avoid such concurrent alter+reads/writes or doing some retries around such (presumably rare) events. Where this doesn&apos;t fully match the original description of the ticket however is that it mentions &quot;And one row (that we can tell) got corrupted at the same time and could no longer be read from the Python driver&quot;, which imply some writes/on-disk corruption (which, I&apos;d argue, is more serious than &quot;some reads fail temporarily&quot;, even if again the later is obviously not awesome). But &lt;tt&gt;ColumnFilter&lt;/tt&gt; shouldn&apos;t have any impact on writes/on-disk serialization in any way. What I am missing?&lt;/p&gt;</comment>
                            <comment id="16034607" author="JIRAUSER308715" created="Fri, 2 Jun 2017 12:26:25 +0000"  >&lt;p&gt;From my understanding the issue is the case where you get a corrupted read, that doesn&apos;t fail. In which case you will return bad data to a client, and if that triggered a read repair you will write the corrupted value back, corrupting future reads after the schema settles.&lt;/p&gt;</comment>
                            <comment id="16034612" author="JIRAUSER308715" created="Fri, 2 Jun 2017 12:29:00 +0000"  >&lt;p&gt;Also &quot;do not perform any reads ever while a schema change is taking place&quot; is not an acceptable limitation and also not something that can easily be done from a client.&lt;/p&gt;</comment>
                            <comment id="16034668" author="ifesdjeen" created="Fri, 2 Jun 2017 13:18:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; thank you for feedback. You&apos;re right, changing a protocol mid version isn&apos;t a very good idea but in this case to be honest we have little other options. On any node at  any period of time, we cannot be sure whether the replica has the same view of schema as we do.  This means that they read repair can result into record that would corrupt an sstable.&lt;/p&gt;

&lt;p&gt;Simply failing reads on failing validation would be an optimal solution, although we cannot know whether the binary data is exactly what we expect and the replica Schema matches local. &lt;/p&gt;

&lt;p&gt;This particular issue looks like a real blocker, since it leads to data corruption in presence of relatively frequent event (alter table while operating the cluster), in same-version or mixed version cluster across pretty much all versions (having that said, I haven&apos;t checked 2.1).&lt;/p&gt;</comment>
                            <comment id="16038851" author="iamaleksey" created="Tue, 6 Jun 2017 13:08:31 +0000"  >&lt;p&gt;Both issues are indeed a problem. And IMO severe enough to justify a messaging version bump in absence of a way to avoid it. That said, I&apos;m failing to find such a way.&lt;/p&gt;

&lt;p&gt;I&apos;ve got some nits, but overall the patch is fine.&lt;/p&gt;

&lt;p&gt;P.S. &lt;del&gt;It doesn&apos;t really matter - just name of a constant after all - but I would go with &lt;tt&gt;VERSION_314&lt;/tt&gt;. We aren&apos;t going to have a 3.14 now that tick-tock is gone, and by the time we hit 31.4, all of us will probably be long dead.&lt;/del&gt; &lt;tt&gt;VERSION_3014&lt;/tt&gt; is fine, sorry.&lt;/p&gt;</comment>
                            <comment id="16038877" author="jjirsa" created="Tue, 6 Jun 2017 13:25:52 +0000"  >&lt;p&gt;Sylvain is right that people are going to be surprised with schema propagation at the very least - should probably add a news entry on commit&lt;/p&gt;

</comment>
                            <comment id="16038956" author="iamaleksey" created="Tue, 6 Jun 2017 14:17:41 +0000"  >&lt;p&gt;If schema and streaming are the only two concerns, we can special case this particular messaging version and go for a two-step upgrade process option.&lt;/p&gt;

&lt;p&gt;That is, release 3.0.14 that is aware of the new messaging service version, and has code to decode &lt;tt&gt;VERSION_3015&lt;/tt&gt;, encodes as &lt;tt&gt;VERSION_30&lt;/tt&gt;, and supports schema push-pull between 3.0.13- and 3.0.14, but also 3.0.14 and 3.0.15+.&lt;/p&gt;

&lt;p&gt;Then release a 3.0.15 that does bump the version to &lt;tt&gt;VERSION_3015&lt;/tt&gt;, but works with schema and streaming with 3.0.14 flawlessly? It&apos;s not like anything changes in schema ser/deser or for streaming here, we only change encoding of read commands.&lt;/p&gt;

&lt;p&gt;So if you care about schema and streaming going on, you&apos;d go for 3.0.14 first, then do a quick jump to 3.0.15. 3.0.15 would only include this one tiny read command change, so wouldn&apos;t need to be certified according to the full normal procedure.&lt;/p&gt;</comment>
                            <comment id="16039204" author="jjirsa" created="Tue, 6 Jun 2017 16:27:25 +0000"  >&lt;p&gt;Maybe we don&apos;t do the 3.0.14/3.0.15 dance, and use this as an opportunity to protect people who were impacted by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13559&quot; title=&quot;Schema version id mismatch while upgrading to 3.0.13&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13559&quot;&gt;&lt;del&gt;CASSANDRA-13559&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="16039213" author="JIRAUSER308715" created="Tue, 6 Jun 2017 16:34:34 +0000"  >&lt;p&gt;Ok, I get the issue now after talking it out with some people.  The issue is with the nodes that haven&apos;t upgraded yet doing the right thing, so we can&apos;t put any kind of compat code in the new nodes that would fix this.  Hence the need for a 3.0.14 which treats 3.0.15 and 3.0 as the same version.  Then we have 3.0.15 which includes the fix for this issue.&lt;/p&gt;

&lt;p&gt;If someone is on 3.0.13 and would rather avoid schema storm issues over being able to alter schema they could jump directly to 3.0.15 skipping 3.0.14 and get that effect.&lt;/p&gt;</comment>
                            <comment id="16039409" author="jjirsa" created="Tue, 6 Jun 2017 18:26:47 +0000"  >&lt;blockquote&gt;
&lt;p&gt;If someone is on 3.0.13 and would rather avoid schema storm issues over being able to alter schema they could jump directly to 3.0.15 skipping 3.0.14 and get that effect.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s a pretty compelling argument to me - letting the operators decide whether or not they want to deal with the extra upgrade seems like a good idea. Alex / Aleksey - one of you two writing the transitional code - keeping it in this JIRA or a followup?&lt;/p&gt;</comment>
                            <comment id="16039562" author="ifesdjeen" created="Tue, 6 Jun 2017 20:24:10 +0000"  >&lt;p&gt;I also like Aleksey&apos;s idea with 3.0.14/15 versions. I still have a couple of other smaller things to improve in the patch, so I can just work on that as well. Will most likely get to it by ~Thursday.&lt;/p&gt;</comment>
                            <comment id="16048898" author="ifesdjeen" created="Wed, 14 Jun 2017 09:10:09 +0000"  >&lt;p&gt;Prepared patches for 3.0.14 and 3.0.15, in which:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;3.0.14&lt;/tt&gt; supports messaging with both &lt;tt&gt;VERSION_30&lt;/tt&gt; &lt;em&gt;and&lt;/em&gt; &lt;tt&gt;VERSION_3015&lt;/tt&gt; (streaming is supported because it has a version number independent from schema, hints will work because the version is not gated to current, too). This version will contain &lt;em&gt;no fix&lt;/em&gt; for this bug, will only be helpful for gradual upgrade without losing an ability to execute schema statements during upgrade process.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;3.0.15&lt;/tt&gt; contains full fix for this bug, together with a protocol bump.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;tt&gt;NEWS&lt;/tt&gt; section is updated. &lt;tt&gt;3.11&lt;/tt&gt; branch contains &lt;em&gt;only&lt;/em&gt; version with &lt;tt&gt;3015&lt;/tt&gt; protocol, so no two versions there. I&apos;ve also made several cosmetic changes to &lt;tt&gt;ColumnFilter&lt;/tt&gt; (made naming consistent between branches, added a roundtrip serialisation test). &lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...ifesdjeen:13004-3.0.14&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0.14&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.0.14-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.0.14-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...ifesdjeen:13004-3.0.15&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0.15&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.0.15-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.0.15-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...ifesdjeen:13004-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.11-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.11-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:13004-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16049332" author="iamaleksey" created="Wed, 14 Jun 2017 16:07:33 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16049341" author="jjirsa" created="Wed, 14 Jun 2017 16:21:54 +0000"  >&lt;p&gt;Ship it! Once merged we should also schedule a release vote for 3.0.14/3.0.15 at least.&lt;/p&gt;</comment>
                            <comment id="16049345" author="jjirsa" created="Wed, 14 Jun 2017 16:26:49 +0000"  >&lt;p&gt;One nit you can fix on commit - you have an unused import in 3.0.15 &lt;tt&gt;ColumnFilter.java&lt;/tt&gt; - &lt;tt&gt;import org.apache.cassandra.thrift.Column;&lt;/tt&gt;&lt;/p&gt;

</comment>
                            <comment id="16049450" author="mshuler" created="Wed, 14 Jun 2017 18:06:12 +0000"  >&lt;p&gt;I&apos;m not fond of the idea of 2 releases here. This will add a good deal of confusion to users and an ongoing strange upgrade path through a mid-series version, as time goes on and subsequent 3.0.x releases happen. Debian packages for 3.0.14 won&apos;t ever be installable via apt, if they are released at the same time, either, so they would need to be manually fetched with wget.&lt;/p&gt;

&lt;p&gt;All users care about continuity, and I don&apos;t think all users could answer the question of whether they may or may not need schema changes during upgrade, since they may have multiple users or applications that they don&apos;t necessarily control. In that case, the best answer for questions on upgrading will be to always upgrade to &lt;tt&gt;3.0.14&lt;/tt&gt;, then to whatever is the latest &lt;tt&gt;3.0.x&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;On IRC, I proposed a &lt;tt&gt;java -Ddo-the-right-thing=true&lt;/tt&gt; flag of some sort that can be passed in and processed to get the intermediate &lt;tt&gt;3.0.14&lt;/tt&gt; behavior desired. After the upgrade process is complete, then the user would need to remove the flag and restart to get the proper fix in the additional &lt;tt&gt;3.0.15&lt;/tt&gt; changes.&lt;/p&gt;</comment>
                            <comment id="16049487" author="iamaleksey" created="Wed, 14 Jun 2017 18:24:20 +0000"  >&lt;p&gt;+1 on a -D flag to override the messaging version used. The approach is basically same but avoids the hassle of releasing an extra version. As a nice bonus, you&apos;ll be able to do the rolling upgrade in any 3.0.x version for x &amp;gt;= 3.0.14, making it possible for any release to be the interim step rather than just 3.0.14.&lt;/p&gt;

&lt;p&gt;The patches provided would only need a minor change.&lt;/p&gt;</comment>
                            <comment id="16049492" author="ifesdjeen" created="Wed, 14 Jun 2017 18:29:18 +0000"  >&lt;p&gt;We have discussed both flag idea and two versions. It kind of boils down to whether you prefer copying files to modifying them. I will page in &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjordan&quot; class=&quot;user-hover&quot; rel=&quot;jjordan&quot;&gt;jjordan&lt;/a&gt; since he was leaning against flags.&lt;/p&gt;</comment>
                            <comment id="16049529" author="JIRAUSER308715" created="Wed, 14 Jun 2017 19:00:26 +0000"  >&lt;p&gt;I think I came around to a flag being better than two versions.&lt;/p&gt;</comment>
                            <comment id="16049533" author="JIRAUSER308715" created="Wed, 14 Jun 2017 19:03:05 +0000"  >&lt;p&gt;The part about being able to upgrade to any release with the flag being one of the reasons for that.&lt;/p&gt;</comment>
                            <comment id="16049674" author="ifesdjeen" created="Wed, 14 Jun 2017 21:25:50 +0000"  >&lt;p&gt;To summarise. The new flag is called &lt;tt&gt;cassandra.force_3_0_protocol_version&lt;/tt&gt; defaulting to &lt;tt&gt;false&lt;/tt&gt;, which means:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;if we have a flag ON, the node with have &lt;tt&gt;MessagingService#current_version = 30&lt;/tt&gt;, kind of &lt;b&gt;compatibility mode&lt;/b&gt;&lt;/li&gt;
	&lt;li&gt;if we have a flag OFF (which is a default), the node with have &lt;tt&gt;MessagingService#current_version = 3014&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In order to &lt;em&gt;allow&lt;/em&gt; migrations &lt;em&gt;during&lt;/em&gt; the upgrade process, we introduce a &quot;compatibility hack&quot; in 3.0.14, which will be present in all the versions from 3.0.14 upwards. Here we have several settings:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;schema migrations between 3.0.13 (and below) and 3.0.14 with &lt;b&gt;protocol 3014 disabled&lt;/b&gt; are possible because the both nodes have current protocol &lt;tt&gt;30&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;schema migrations between 3.0.14 with &lt;b&gt;protocol 3014 disabled&lt;/b&gt; and &lt;b&gt;protocol 3014 enabled&lt;/b&gt; are possible because we artificially treat them as same&lt;/li&gt;
	&lt;li&gt;the final step of the migration, &lt;b&gt;protocol 3014 enabled&lt;/b&gt; on &lt;b&gt;all nodes&lt;/b&gt;, schema migrations will be possible between all nodes since they all are at same protocol version&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The whole process is required because the schema migrations rely on exact match of the &lt;b&gt;current version&lt;/b&gt;.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...ifesdjeen:13004-3.0.14&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0.14&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.0.14-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.0.14-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...ifesdjeen:13004-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.11-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-3.11-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:13004-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-13004-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I&apos;m re-running tests and would appreciate if anyone took a final look at things. I hope to have incorporated all feedback.&lt;/p&gt;</comment>
                            <comment id="16050397" author="iamaleksey" created="Thu, 15 Jun 2017 12:16:12 +0000"  >&lt;p&gt;Changes look good to me, though,&lt;/p&gt;

&lt;p&gt;1. CHANGES.txt could be a bit more verbose here: &quot;After the whole cluster is upgraded to 3.0.14, do a rolling restart of the cluster&quot; - specify that this rolling restart shouldn&apos;t set the flag.&lt;br/&gt;
2. Boolean.parseBoolean(System.getProperty(&quot;cassandra.force_3_0_protocol_version&quot;, &quot;false&quot;)) can usually be replaced with Boolean.getBoolean(&quot;cassandra.force_3_0_protocol_version&quot;), though you might have a reason not to?&lt;br/&gt;
3. Since we are adapting the flag version, there is no reason not to make MS version conditional on the 3.11 branch as well, to allow for a rolling upgrade with no interruptions for those on 3.X. It&apos;s cheap to do so might as well go for it.&lt;/p&gt;

&lt;p&gt;Everything else LGTM.&lt;/p&gt;</comment>
                            <comment id="16050399" author="iamaleksey" created="Thu, 15 Jun 2017 12:20:53 +0000"  >&lt;p&gt;Oh, also I&apos;m pretty sure that this is a problem not just for adding columns, but for dropping them too. Any change to the columns set.&lt;/p&gt;

&lt;p&gt;So we should rename the ticket, CHANGES.txt entry, and elaborate in NEWS.txt that DROP is also affected.&lt;/p&gt;</comment>
                            <comment id="16050839" author="ifesdjeen" created="Thu, 15 Jun 2017 17:40:54 +0000"  >&lt;p&gt;I&apos;ve incorporated Aleksey&apos;s final comments on commit (CHANGES.TXT, 3.11 flag and getBoolean). &lt;/p&gt;

&lt;p&gt;Committed in 3.0 with &lt;a href=&quot;https://github.com/apache/cassandra/commit/1f54aa424fd8a79089f76951a93560e6bca9d459&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1f54aa424fd8a79089f76951a93560e6bca9d459&lt;/a&gt;, merged up to &lt;a href=&quot;https://github.com/apache/cassandra/commit/2a0890d0fc5eaaf88d0a2d610a5f500fe943fb92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/commit/a07d327be86783137b7ae46a7722ac41cbebdc31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;
</comment>
                            <comment id="16051018" author="ifesdjeen" created="Thu, 15 Jun 2017 20:29:17 +0000"  >&lt;p&gt;Unfortunately, my commit on 3.11 broke serveral tests (which did not show up on my branch, and is not always failing locally). &lt;/p&gt;

&lt;p&gt;It all is an result of static initialisation. When &lt;tt&gt;current_version&lt;/tt&gt; was a constant, it was getting initialised just fine, but loading a boolean from system property introduced a race. &lt;/p&gt;

&lt;p&gt;Once again, this is not a runtime issue, this is only an issue with tests.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...ifesdjeen:13004-3.11-followup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/job/ifesdjeen-13004-3.11-followup-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;UPDATE: More information (and isolated repro) &lt;a href=&quot;https://github.com/ifesdjeen/static-initialisers&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;: accessing a &lt;tt&gt;static final&lt;/tt&gt; field (as it was previously) did not trigger all static initialisers. Bytecode inspection showed that having the code execution (&lt;tt&gt;getProperty&lt;/tt&gt; and ternary operator)  has moved the initialiser to &lt;tt&gt;static&lt;/tt&gt; block, kind of like that: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; {
        FORCE_3_0_PROTOCOL_VERSION = &lt;span class=&quot;code-object&quot;&gt;Boolean&lt;/span&gt;.getBoolean(&lt;span class=&quot;code-quote&quot;&gt;&quot;cassandra.force_3_0_protocol_version&quot;&lt;/span&gt;);
        current_version = (MessagingService.FORCE_3_0_PROTOCOL_VERSION ? 10 : 11);
        ONE_BYTE = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[1];
        verbValues = MessagingService.Verb.values();
        &lt;span class=&quot;code-comment&quot;&gt;/// etc...
&lt;/span&gt;    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16051096" author="ifesdjeen" created="Thu, 15 Jun 2017 21:33:14 +0000"  >&lt;p&gt;Another (minor problem) was with a trunk patch, that was decoding not checking backward compatibility properly:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:13004-trunk-followup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/job/ifesdjeen-13004-trunk-followup-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16052039" author="ifesdjeen" created="Fri, 16 Jun 2017 15:38:10 +0000"  >&lt;p&gt;Ninja-Committed both fixes.&lt;/p&gt;</comment>
                            <comment id="16068834" author="ostefano" created="Thu, 29 Jun 2017 19:34:50 +0000"  >&lt;p&gt;I am trying to understand if I was affected by this bug (I have been issuing quite a number of ALTER DROPs before upgrading to 3.0.14), so I was wondering, does the bug also affect column families without UDTs? I am also unsure whether a SELECT * would be enough for the client to see the corruption; in other words, would the exception be visible client-side or should I keep an eye all nodes logs?&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16068868" author="jjirsa" created="Thu, 29 Jun 2017 19:47:28 +0000"  >&lt;p&gt;Yes, the bug impacts tables without UDTS&lt;/p&gt;

&lt;p&gt;The bug is basically that read repairs in the ~100ms or so surrounding an ALTER that ADDs or DROPs columns could cause cells to bleed into each other. Depending on the type of the cells, sometimes marshaling / validation would throw an EOF or other exception to protect you from the corruption. In cases where the adjacent fields were of the same type, that&apos;s less likely to happen (text/text, int/int, etc).&lt;/p&gt;

&lt;p&gt;The data on disk may be so corrupt that running a &lt;tt&gt;SELECT *&lt;/tt&gt; throws an error, or it could give back entirely real-looking CQL rows with invalid data in it.&lt;/p&gt;

&lt;p&gt;Again, it&apos;s only for data read-repaired while the schema propagation happened (if the schema columns from the read-repairing hosts don&apos;t match while the read repair is ongoing), so only data read during that change can be impacted.&lt;/p&gt;</comment>
                            <comment id="16068906" author="ostefano" created="Thu, 29 Jun 2017 20:08:58 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;That is nasty indeed. &lt;br/&gt;
Would a &lt;tt&gt;nodetool scrub&lt;/tt&gt; fix the error after the &lt;tt&gt;SELECT *&lt;/tt&gt; at least (assume I can live with a number of rows with some invalid data in it)?&lt;/p&gt;</comment>
                            <comment id="16072159" author="ifesdjeen" created="Mon, 3 Jul 2017 09:17:09 +0000"  >&lt;p&gt;Since there&apos;s no real way to distinguish between the broken and non-broken rows if there was no data corruption, there might be incorrect data after scrub still, but there&apos;s no good way to detect it on large userbase scale. &lt;/p&gt;

&lt;p&gt;The impact, however, is limited to the queries that were executed during the schema update operation, so if there was some sort of a log or a timestamp you can still check the items. &lt;/p&gt;</comment>
                            <comment id="16113989" author="jichien" created="Fri, 4 Aug 2017 06:01:13 +0000"  >&lt;p&gt;I am also interested in the impact of this bug. If I alter 1 table by adding 1 column, the worse case is some rows of THAT table might be corrupted. Data on other tables should not be affected, correct? &lt;/p&gt;

&lt;p&gt;Another thought is, if I run a repair on the table that was altered, can I fix or detect the problem? If I see no error after I run a repair. Is it sufficient to say that I am not affected by this bug?&lt;br/&gt;
Thanks.&lt;/p&gt;</comment>
                            <comment id="16114174" author="JIRAUSER308715" created="Fri, 4 Aug 2017 09:40:46 +0000"  >&lt;p&gt;Yes, only rows of that table can be corrupted. Repair will not fix the issue, it will propagate the issue to other nodes, as the problem is the node itself does not know the data was corrupted.&lt;/p&gt;</comment>
                            <comment id="16114186" author="JIRAUSER308715" created="Fri, 4 Aug 2017 09:51:13 +0000"  >&lt;p&gt;For more info see the thread here for a FAQ.&lt;br/&gt;
&lt;a href=&quot;https://lists.apache.org/thread.html/2fd39b24dd4b14870bd43771e3bf8132893e2bc3612abbf66dfb9aec@%3Cuser.cassandra.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread.html/2fd39b24dd4b14870bd43771e3bf8132893e2bc3612abbf66dfb9aec@%3Cuser.cassandra.apache.org%3E&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16155584" author="adarak" created="Wed, 6 Sep 2017 15:59:04 +0000"  >&lt;p&gt;we are on cassandra 3.0.7 and we are hitting an issue related to data corruption but not the one listed in the description i believe but similar to the one commented by Nimi Wariboko jr on Feb 7, 2017 at 03:46.&lt;/p&gt;

&lt;p&gt;Here is the one of the error we got related to data corruption. Any insights when this error arises ? Also upgrading to fix versions would resolve this issue? Please let us know&lt;/p&gt;

&lt;p&gt;AbstractLocalAwareExecutorService.java:169 - Uncaught exception on thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;SharedPool-Worker-4,5,main&amp;#93;&lt;/span&gt;: {} &lt;br/&gt;
&lt;font color=&quot;red&quot;&gt;java.lang.RuntimeException: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /apps/cassandra/data/wfs_edm_locations/location-6c589dd1b73711e6879d497285de6740/mb- 48-big-Data.db&lt;/font&gt; &lt;br/&gt;
at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2449) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-3.0.7.1159.jar:3.0.7.1159&amp;#93;&lt;/span&gt; &lt;br/&gt;
at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_74&amp;#93;&lt;/span&gt; &lt;br/&gt;
at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-3.0.7.1159.jar:3.0.7.1159&amp;#93;&lt;/span&gt; &lt;br/&gt;
at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) &lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-3.0.7.1159.jar:3. 0.7.1159&amp;#93;&lt;/span&gt; &lt;br/&gt;
at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) &lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-3.0.7.1159.jar:3.0.7.1159&amp;#93;&lt;/span&gt; &lt;br/&gt;
at java.lang.Thread.run(Thread.java:745) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_74&amp;#93;&lt;/span&gt; &lt;br/&gt;
Caused by: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /apps/cassandra/data/wfs_edm_locations/location-6c589dd1b73711e6879d497285de6740/mb-48-big-Data.db &lt;br/&gt;
at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$Reader.hasNext(AbstractSSTableIterator.java:353) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-3.0.7.1159.jar:3.0.7.1159&amp;#93;&lt;/span&gt; &lt;br/&gt;
at org.apache.cassandra.db.filter.ClusteringIndexNamesFilter$1.hasNext(ClusteringIndexNamesFilter.java:145) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;cassandra-all-3.0.7.1159.jar:3.0.7.1159&amp;#93;&lt;/span&gt; &lt;br/&gt;
at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator&lt;/p&gt;</comment>
                            <comment id="16155689" author="jjirsa" created="Wed, 6 Sep 2017 17:03:29 +0000"  >&lt;p&gt;There&apos;s no way of knowing if the corrupt sstable you&apos;re seeing is the result of 13004 or some other issue (like bad hardware / RAM / etc). The best explanation to date is &lt;a href=&quot;https://gist.github.com/ifesdjeen/9cacb1ccd934374f707125d78f2fbcb6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/ifesdjeen/9cacb1ccd934374f707125d78f2fbcb6&lt;/a&gt; - you should consult that if you&apos;re unsure of what to do (the short answer is that those sstables may be permanently damaged, upgrading will not fix the already corrupt data on disk).&lt;/p&gt;</comment>
                            <comment id="16155748" author="adarak" created="Wed, 6 Sep 2017 17:30:18 +0000"  >&lt;p&gt;I mean upgrading to the fixed version, will not result in corruption to any new data? not the already existing corrupted data.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13083734">CASSANDRA-13650</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="13161" cascade-level="1"><![CDATA[Unrecoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i377cf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12337349">3.0.9</customfieldvalue>
    <customfieldvalue id="12337348">3.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>