<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:10:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-157] make cassandra not allow itself to run out of memory during sustained inserts</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-157</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Tv on IRC pointed out to me that the issue that I&apos;ve been encountering&lt;br/&gt;
is probably point 2. in this roadmap:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;http://www.mail-archive.com/cassandra-dev@incubator.apache.org/msg00160.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/cassandra-dev@incubator.apache.org/msg00160.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I was unable to find any existing issue for this topic, so I&apos;m creating a new one.&lt;/p&gt;

&lt;p&gt;Since this issue would block our use of Cassandra I&apos;m happy to look into it,&lt;br/&gt;
but if this is a known issue perhaps there&apos;s already a plan for addressing it&lt;br/&gt;
that could be clarified?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12424977">CASSANDRA-157</key>
            <summary>make cassandra not allow itself to run out of memory during sustained inserts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="daishi">daishi</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 May 2009 22:42:50 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:38 +0000</updated>
                            <resolved>Mon, 27 Jul 2009 22:41:17 +0000</resolved>
                                                            <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="12707585" author="jbellis" created="Sat, 9 May 2009 00:44:37 +0000"  >&lt;p&gt;if you&apos;re running out of memory, start by decreasing these settings in conf/storage-conf.  svn up first because objectcount used to default to 0.1 (i.e. 100k objects).&lt;/p&gt;

&lt;p&gt;    &amp;lt;!--&lt;br/&gt;
      The maximum amount of data to store in memory before flushing to&lt;br/&gt;
      disk. Note: There is one memtable per column family, and this threshold&lt;br/&gt;
      is based solely on the amount of data stored, not actual heap memory&lt;br/&gt;
      usage (there is some overhead in indexing the columns).&lt;br/&gt;
    --&amp;gt;&lt;br/&gt;
    &amp;lt;MemtableSizeInMB&amp;gt;32&amp;lt;/MemtableSizeInMB&amp;gt;&lt;/p&gt;

&lt;p&gt;    &amp;lt;!--&lt;br/&gt;
      The maximum number of columns in millions to store in memory&lt;br/&gt;
      before flushing to disk.  This is also a per-memtable setting.&lt;br/&gt;
      Use with MemtableSizeInMB to tune memory usage.&lt;br/&gt;
    --&amp;gt;&lt;br/&gt;
    &amp;lt;MemtableObjectCountInMillions&amp;gt;0.02&amp;lt;/MemtableObjectCountInMillions&amp;gt;&lt;/p&gt;
</comment>
                            <comment id="12707586" author="jbellis" created="Sat, 9 May 2009 00:49:29 +0000"  >&lt;p&gt;Ah, I see you&apos;ve had this discussion with urandom on irc.&lt;/p&gt;

&lt;p&gt;Like he said, play with jconsole, it may be your limits are still not low enough or possibly there is a bug in its internal accounting.&lt;/p&gt;</comment>
                            <comment id="12708121" author="urandom" created="Mon, 11 May 2009 17:32:30 +0000"  >&lt;p&gt;I think we need a wiki page which details what we&apos;ve learned about tuning thresholds (and yes, I suppose I am volunteerin &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="12708515" author="daishi" created="Tue, 12 May 2009 17:15:55 +0000"  >&lt;p&gt;This patch removes the MBean reference to Memtable objects,&lt;br/&gt;
reducing the memory pressure under sustained inserts somewhat.&lt;br/&gt;
(This helps, but I think there are other remaining issues).&lt;/p&gt;</comment>
                            <comment id="12708533" author="jbellis" created="Tue, 12 May 2009 17:56:46 +0000"  >&lt;p&gt;great fix!  committed.&lt;/p&gt;</comment>
                            <comment id="12708853" author="hudson" created="Wed, 13 May 2009 09:26:38 +0000"  >&lt;p&gt;Integrated in Cassandra #73 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/73/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/73/&lt;/a&gt;)&lt;br/&gt;
    unregister mbean on flush.  patch by daishi; reviewed by jbellis for &lt;/p&gt;</comment>
                            <comment id="12709943" author="urandom" created="Fri, 15 May 2009 19:44:52 +0000"  >&lt;p&gt;&lt;a href=&quot;http://wiki.apache.org/cassandra/MemtableThresholds&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/cassandra/MemtableThresholds&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12716437" author="jbellis" created="Thu, 4 Jun 2009 22:41:35 +0000"  >&lt;p&gt;Is this still an issue?&lt;/p&gt;</comment>
                            <comment id="12716474" author="daishi" created="Fri, 5 Jun 2009 01:14:59 +0000"  >&lt;p&gt;Sorry I haven&apos;t had a chance to follow up on this.&lt;/p&gt;

&lt;p&gt;If I remember correctly the main unbounded memory growth&lt;br/&gt;
that caused OOMs did seem to go away, but that the exposed&lt;br/&gt;
properties didn&apos;t control the memory usage in a predictable way.&lt;/p&gt;

&lt;p&gt;In particular I think the objCount property would schedule&lt;br/&gt;
a Memtable.flush(), but ColumnFamilyStore.memtablesPendingFlush&lt;br/&gt;
would be actually flushed according to a different schedule.&lt;br/&gt;
I haven&apos;t read enough of the code to know whether it would&lt;br/&gt;
be possible/make sense to allow user-control of latter schedule,&lt;br/&gt;
but that was the direction I was thinking in when I had to drop&lt;br/&gt;
this for a bit (maybe you can let me know if that makes no&lt;br/&gt;
sense or if there&apos;s a better way to think about things).&lt;/p&gt;</comment>
                            <comment id="12716475" author="jbellis" created="Fri, 5 Jun 2009 01:18:45 +0000"  >&lt;p&gt;&amp;gt; ColumnFamilyStore.memtablesPendingFlush  would be actually flushed according to a different schedule&lt;/p&gt;

&lt;p&gt;flushes are processed one at a time, first come first served, to avoid swamping the system with IO.&lt;/p&gt;

&lt;p&gt;does that jive with what you saw?&lt;/p&gt;</comment>
                            <comment id="12716479" author="daishi" created="Fri, 5 Jun 2009 01:42:36 +0000"  >&lt;p&gt;&amp;gt; flushes are processed one at a time, first come first served, to avoid swamping the system with IO.&lt;br/&gt;
&amp;gt; does that jive with what you saw? &lt;/p&gt;

&lt;p&gt;I guess that depends on what &quot;first come first served&quot; means.&lt;br/&gt;
Basically what I observed was that I could control how&lt;br/&gt;
frequently Memtable.flush() happened, but that only&lt;br/&gt;
after N memtables had been &quot;queued up&quot; to flush&lt;br/&gt;
would they actually be flushed to disk (I presume -&lt;br/&gt;
my view is based only on observing memory usage).&lt;br/&gt;
I think N was 10-20, but I don&apos;t remember exactly right now.&lt;/p&gt;</comment>
                            <comment id="12716482" author="jbellis" created="Fri, 5 Jun 2009 02:04:17 +0000"  >&lt;p&gt;That&apos;s strange.  Let me know if you can reproduce that behavior still with 0.3 or trunk.  It shouldn&apos;t be queueing up unless the flusher is busy with a different memtable.&lt;/p&gt;</comment>
                            <comment id="12735811" author="jbellis" created="Mon, 27 Jul 2009 22:23:13 +0000"  >&lt;p&gt;Found the (a?) problem.&lt;/p&gt;

&lt;p&gt;memtablesPendingFlush used NonBlockingHashSets to store the memtables-to-flush.  But NBHS uses a NBHMap under the hood, which when remove() is called, assigns a tombstone value to the key instead of actually removing it.  (See &lt;a href=&quot;http://sourceforge.net/tracker/?func=detail&amp;amp;aid=2828100&amp;amp;group_id=194172&amp;amp;atid=948362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://sourceforge.net/tracker/?func=detail&amp;amp;aid=2828100&amp;amp;group_id=194172&amp;amp;atid=948362&lt;/a&gt;.)&lt;/p&gt;</comment>
                            <comment id="12735817" author="brandon.williams" created="Mon, 27 Jul 2009 22:34:55 +0000"  >&lt;p&gt;+1  The heap usage is much improved for me with this patch.&lt;/p&gt;</comment>
                            <comment id="12735821" author="jbellis" created="Mon, 27 Jul 2009 22:41:17 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="12736066" author="hudson" created="Tue, 28 Jul 2009 13:29:27 +0000"  >&lt;p&gt;Integrated in Cassandra #151 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/151/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/151/&lt;/a&gt;)&lt;br/&gt;
    use CSLS instead of NBHS for memtablesPendingFlush. See explanation here: &lt;a href=&quot;http://sourceforge.net/tracker/?func=detail&amp;amp;aid=2828100&amp;amp;group_id=194172&amp;amp;atid=948362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://sourceforge.net/tracker/?func=detail&amp;amp;aid=2828100&amp;amp;group_id=194172&amp;amp;atid=948362&lt;/a&gt;&lt;br/&gt;
patch by jbellis; reviewed by Brandon Williams for &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12414671" name="157.patch" size="1526" author="jbellis" created="Mon, 27 Jul 2009 22:23:12 +0000"/>
                            <attachment id="12407898" name="Cassandra-157_Unregister_Memtable_MBean.diff" size="2045" author="daishi" created="Tue, 12 May 2009 17:15:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19574</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fx7z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>90980</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>