<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:30:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19344] Range movements involving transient replicas must safely enact changes to read and write replica sets</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19344</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;(edit) This was originally opened due to a flaky test &lt;tt&gt;org.apache.cassandra.distributed.test.TransientRangeMovementTest.testRemoveNode-_jdk17&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The test can fail in two different ways:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
junit.framework.AssertionFailedError: NOT IN CURRENT: 31 -- [(00,20), (31,50)] at org.apache.cassandra.distributed.test.TransientRangeMovementTest.assertAllContained(TransientRangeMovementTest.java:203) at org.apache.cassandra.distributed.test.TransientRangeMovementTest.testRemoveNode(TransientRangeMovementTest.java:183) at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77) at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;as in here - &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2639/workflows/32b92ce7-5e9d-4efb-8362-d200d2414597/jobs/55139/tests#failed-test-0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2639/workflows/32b92ce7-5e9d-4efb-8362-d200d2414597/jobs/55139/tests#failed-test-0&lt;/a&gt;&lt;br/&gt;
and&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
junit.framework.AssertionFailedError: nodetool command [removenode, 6d194555-f6eb-41d0-c000-000000000003, --force] was not successful stdout: stderr: error: Node /127.0.0.4:7012 is alive and owns &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; ID. Use decommission command to remove it from the ring -- StackTrace -- java.lang.UnsupportedOperationException: Node /127.0.0.4:7012 is alive and owns &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; ID. Use decommission command to remove it from the ring at org.apache.cassandra.tcm.sequences.SingleNodeSequences.removeNode(SingleNodeSequences.java:110) at org.apache.cassandra.service.StorageService.removeNode(StorageService.java:3682) at org.apache.cassandra.tools.NodeProbe.removeNode(NodeProbe.java:1020) at org.apache.cassandra.tools.nodetool.RemoveNode.execute(RemoveNode.java:51) at org.apache.cassandra.tools.NodeTool$NodeToolCmd.runInternal(NodeTool.java:388) at org.apache.cassandra.tools.NodeTool$NodeToolCmd.run(NodeTool.java:373) at org.apache.cassandra.tools.NodeTool.execute(NodeTool.java:272) at org.apache.cassandra.distributed.impl.Instance$DTestNodeTool.execute(Instance.java:1129) at org.apache.cassandra.distributed.impl.Instance.lambda$nodetoolResult$51(Instance.java:1038) at org.apache.cassandra.concurrent.FutureTask.call(FutureTask.java:61) at org.apache.cassandra.concurrent.FutureTask.run(FutureTask.java:71) at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136) at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833) Notifications: Error: java.lang.UnsupportedOperationException: Node /127.0.0.4:7012 is alive and owns &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; ID. Use decommission command to remove it from the ring at org.apache.cassandra.tcm.sequences.SingleNodeSequences.removeNode(SingleNodeSequences.java:110) at org.apache.cassandra.service.StorageService.removeNode(StorageService.java:3682) at org.apache.cassandra.tools.NodeProbe.removeNode(NodeProbe.java:1020) at org.apache.cassandra.tools.nodetool.RemoveNode.execute(RemoveNode.java:51) at org.apache.cassandra.tools.NodeTool$NodeToolCmd.runInternal(NodeTool.java:388) at org.apache.cassandra.tools.NodeTool$NodeToolCmd.run(NodeTool.java:373) at org.apache.cassandra.tools.NodeTool.execute(NodeTool.java:272) at org.apache.cassandra.distributed.impl.Instance$DTestNodeTool.execute(Instance.java:1129) at org.apache.cassandra.distributed.impl.Instance.lambda$nodetoolResult$51(Instance.java:1038) at org.apache.cassandra.concurrent.FutureTask.call(FutureTask.java:61) at org.apache.cassandra.concurrent.FutureTask.run(FutureTask.java:71) at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136) at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635) at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833) at org.apache.cassandra.distributed.api.NodeToolResult$Asserts.fail(NodeToolResult.java:214) at org.apache.cassandra.distributed.api.NodeToolResult$Asserts.success(NodeToolResult.java:97) at org.apache.cassandra.distributed.test.TransientRangeMovementTest.testRemoveNode(TransientRangeMovementTest.java:173) at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77) at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;as in here - &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2634/workflows/24617d26-e297-4857-bc43-b6a04e64a6ea/jobs/54534/tests#failed-test-0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2634/workflows/24617d26-e297-4857-bc43-b6a04e64a6ea/jobs/54534/tests#failed-test-0&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13566788">CASSANDRA-19344</key>
            <summary>Range movements involving transient replicas must safely enact changes to read and write replica sets</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="edimitrova">Ekaterina Dimitrova</reporter>
                        <labels>
                    </labels>
                <created>Tue, 30 Jan 2024 21:20:21 +0000</created>
                <updated>Fri, 10 Oct 2025 08:45:55 +0000</updated>
                            <resolved>Fri, 19 Apr 2024 08:42:21 +0000</resolved>
                                        <fixVersion>5.1</fixVersion>
                                    <component>CI</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6600">1h 50m</timespent>
                                <comments>
                            <comment id="17829784" author="beobal" created="Fri, 22 Mar 2024 08:37:11 +0000"  >&lt;p&gt;When an instance moves from a transient to a full replica for a given range, it must begin acting as a full replica for writes before it does so for reads. Otherwise, consistency can be violated as data streamed to the instance early in the operation can be removed by cleanup if it occurs before the instance assumes responsibility for full writes. Also, coordinators will route read requests to instances which may not have received all preceding writes, causing unnecessary read repair or potentially inconsistent results. &lt;/p&gt;

&lt;p&gt;The root cause of the flaky test failure which originally produced this issue was that in &lt;tt&gt;TransientRangeMovementTest::testRemoveNode&lt;/tt&gt; cleanup happened to run on one instance before it had enacted the final step of the removal operation, leading it to remove more data than it should. &lt;/p&gt;</comment>
                            <comment id="17829794" author="beobal" created="Fri, 22 Mar 2024 08:51:30 +0000"  >&lt;p&gt;The linked PR modifies a number existing tests to make the original failure mode deterministic. It also adds support for transient replication to &#160;&lt;tt&gt;PlacementSimulator&lt;/tt&gt; &#160;&lt;tt&gt;MetadataChangeSimulationTest&lt;/tt&gt; and the associated &lt;tt&gt;TokenPlacementModel&lt;/tt&gt;. Finally, it modifies the way the&#160;&lt;tt&gt;PlacementTransitionPlan&lt;/tt&gt; is prepared for operations involving range movements to ensure that any transition from a transient to full replica happens safely.&lt;/p&gt;</comment>
                            <comment id="17836302" author="beobal" created="Thu, 11 Apr 2024 17:56:56 +0000"  >&lt;p&gt;The actual cause was that the way we construct placement deltas for a PlacementTransitionPlan did not properly consider transientness. Multi-step operations always follow the pattern:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;add new write replicas&lt;/li&gt;
	&lt;li&gt;add new read replicas/remove old read replicas&lt;/li&gt;
	&lt;li&gt;remove old write replicas&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So when an operation causes a replica to transition from TRANSIENT to FULL for the same range (or part of a range), it could become a FULL read replica before becoming a FULL write replica.&lt;br/&gt;
Consider this simplified example where we remove N4 and the effect on N2:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
RF=3/1
At START 
          10        20        30        40         
+---------+---------+---------+---------+---------+
          N1        N2        N3        N4

N2 replicates:
  (10,20]       - FULL (Primary Range)
  (,10] + (40,] - FULL
  (30,40]       - TRANSIENT

After FINISH

          10        20        30        
+---------+---------+---------+-------------------+
          N1        N2        N3        

N2 replicates:
  (10,20]       - FULL (Primary Range)
  (,10] + (30,] - FULL
  (20,30]       - TRANSIENT

In removing N4, N2 gains (20,30] TRANSIENT and (30,40] TRANSIENT -&amp;gt; FULL 
Potential problem -&amp;gt; 
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; READS N2 becomes FULL(30,40] after MID_LEAVE 
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; WRITES N2 only becomes FULL(30,40] after FINISH_LEAVE
    so between the 2 events, coordinators will not send writes to N2 unless one of the other replicas is unresponsive. 
    Coordinators will send reads to N2 during &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; window though. 
    If cleanup is run before N2 becomes a FULL replica &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (30,40], any data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; that range (including that which was 
    just streamed to it) will be purged.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Below is an illustration of the ranges replicated by N2 at each step:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+-----+----------------------------------------------------------------------------------------------------------+
|EPOCH| STATE                  | RANGES REPLICATED BY N2                                                         |
|-----+------------------------+---------------------------------------------------------------------------------|
|0    | START STATE            | WRITES -&amp;gt; FULL: [(40,], (,10], (10,20]] TRANSIENT: [(30,40]]                    |
|     |                        |  READS -&amp;gt; FULL: [(40,], (,10], (10,20]] TRANSIENT: [(30,40]]                    |
|-----+------------------------+---------------------------------------------------------------------------------|
|1    | ENACT START_LEAVE(N4)  | WRITES -&amp;gt; FULL: [(40,], (,10], (10,20]] TRANSIENT: [(20,30], (30,40]]           |
|     |                        |  READS -&amp;gt; FULL: [(40,], (,10], (10,20]] TRANSIENT: [(30,40]]                    |
|-----+------------------------+---------------------------------------------------------------------------------|
|2    | ENACT MID_LEAVE(N4)    | WRITES -&amp;gt; FULL: [(40,], (,10], (10,20]]          TRANSIENT: [(20,30], (30,40]]  |
|     |                        |  READS -&amp;gt; FULL: [(40,], (,10], (10,20], (30,40]] TRANSIENT: [(20,30]]           |
|-----+------------------------+---------------------------------------------------------------------------------|
|3    | ENACT FINISH_LEAVE(N4) | WRITES -&amp;gt; FULL: [(30,], (,10], (10,20]] TRANSIENT: [(20,30]]                    |
|     |                        |  READS -&amp;gt; FULL: [(30,], (,10], (10,20]] TRANSIENT: [(20,30]]                    |
+-----+------------------------+---------------------------------------------------------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After applying the fix here, these are changed so that the &lt;tt&gt;(30,40]&lt;/tt&gt; changing from &lt;tt&gt;TRANSIENT&lt;/tt&gt; to &lt;tt&gt;FULL&lt;/tt&gt; for &lt;br/&gt;
writes is part of enacting the &lt;tt&gt;START_LEAVE(N4)&lt;/tt&gt; in epoch 1, i.e. before N2 becomes a FULL replica for reads of&lt;br/&gt;
&lt;tt&gt;(30,40]&lt;/tt&gt; when &lt;tt&gt;MID_LEAVE(N4)&lt;/tt&gt; is enacted in epoch 2. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
+-----+----------------------------------------------------------------------------------------------------------+
|EPOCH| STATE                  | RANGES REPLICATED BY N2                                                         |
|-----+------------------------+---------------------------------------------------------------------------------|
|0    | START STATE            |  WRITES -&amp;gt; FULL: [(40,], (,10], (10,20]] TRANSIENT: [(30,40]]                   |
|     |                        |   READS -&amp;gt; FULL: [(40,], (,10], (10,20]] TRANSIENT: [(30,40]]                   |
|-----+------------------------+---------------------------------------------------------------------------------|
|1    | ENACT START_LEAVE(N4)  | WRITES -&amp;gt; FULL: [(40,], (,10], (10,20], (30,40]] TRANSIENT: [(20,30]]           |
|     |                        |  READS -&amp;gt; FULL: [(40,], (,10], (10,20]]          TRANSIENT: [(30,40]]           |
|-----+------------------------+---------------------------------------------------------------------------------|
|2    | ENACT MID_LEAVE(N4)    | WRITES -&amp;gt; FULL: [(40,], (,10], (10,20], (30,40]] TRANSIENT: [(20,30]]           |
|     |                        |  READS -&amp;gt; FULL: [(40,], (,10], (10,20], (30,40]] TRANSIENT: [(20,30]]           |
|-----+------------------------+---------------------------------------------------------------------------------|
|3    | ENACT FINISH_LEAVE(N4) | WRITES -&amp;gt; FULL: [(30,], (,10], (10,20]] TRANSIENT: [(20,30]]                    |
|     |                        |  READS -&amp;gt; FULL: [(30,], (,10], (10,20]] TRANSIENT: [(20,30]]                    |
+-----+------------------------+---------------------------------------------------------------------------------+
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;For more detail I&apos;ve also attached details showing the specific placement deltas applied at each of these steps.&lt;/p&gt;</comment>
                            <comment id="17837573" author="ifesdjeen" created="Tue, 16 Apr 2024 08:04:03 +0000"  >&lt;p&gt;Wanted to point out a somewhat unintuitive albeit correct behaviour that involves Transient Replicas. I think it is worth talking through such things because pending ranges with transient replicas work slightly differently from their &quot;normal&quot; counterparts. &lt;/p&gt;

&lt;p&gt;We have a four node cluster with nodes 1,2,3,4 owning tokens 100,200,300,400, and 4 moving from 400 to 350.&lt;/p&gt;

&lt;p&gt;Original/start state (READ/WRITE placements):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    (400,MIN] -&amp;gt; [Full(/127.0.0.1:7012,(400,MIN]), Full(/127.0.0.2:7012,(400,MIN]), Transient(/127.0.0.3:7012,(400,MIN])]}
    (MIN,100] -&amp;gt; [Full(/127.0.0.1:7012,(MIN,100]), Full(/127.0.0.2:7012,(MIN,100]), Transient(/127.0.0.3:7012,(MIN,100])]}
    (100,200] -&amp;gt; [Full(/127.0.0.2:7012,(100,200]), Full(/127.0.0.3:7012,(100,200]), Transient(/127.0.0.4:7012,(100,200])]}
    (200,300] -&amp;gt; [Full(/127.0.0.3:7012,(200,300]), Full(/127.0.0.4:7012,(200,300]), Transient(/127.0.0.1:7012,(200,300])]}
    (300,350] -&amp;gt; [Full(/127.0.0.1:7012,(300,350]), Transient(/127.0.0.2:7012,(300,350]), Full(/127.0.0.4:7012,(300,350])]}
    (350,400] -&amp;gt; [Full(/127.0.0.4:7012,(350,400]), Full(/127.0.0.1:7012,(350,400]), Transient(/127.0.0.2:7012,(350,400])]}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;State after &lt;tt&gt;START_MOVE&lt;/tt&gt; (which is the point at which streaming starts, so think of additional replicas as pending), for WRITE placements:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    (400,MIN] -&amp;gt; [Full(/127.0.0.1:7012,(400,MIN]), Full(/127.0.0.2:7012,(400,MIN]), Full(/127.0.0.3:701a2,(400,MIN])]}
    (MIN,100] -&amp;gt; [Full(/127.0.0.1:7012,(MIN,100]), Full(/127.0.0.2:7012,(MIN,100]), Full(/127.0.0.3:7012,(MIN,100])]}
    (100,200] -&amp;gt; [Full(/127.0.0.2:7012,(100,200]), Full(/127.0.0.3:7012,(100,200]), Transient(/127.0.0.4:7012,(100,200]), Transient(/127.0.0.1:7012,(100,200])]}
    (200,300] -&amp;gt; [Full(/127.0.0.3:7012,(200,300]), Full(/127.0.0.4:7012,(200,300]), Full(/127.0.0.1:7012,(200,300])]}
    (300,350] -&amp;gt; [Full(/127.0.0.1:7012,(300,350]), Transient(/127.0.0.2:7012,(300,350]), Full(/127.0.0.4:7012,(300,350])]}
    (350,400] -&amp;gt; [Full(/127.0.0.4:7012,(350,400]), Full(/127.0.0.1:7012,(350,400]), Full(/127.0.0.2:7012,(350,400]), Transient(/127.0.0.3:7012,(350,400])]}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;READ placements at the same moment:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    (400,MIN] -&amp;gt; [Transient(/127.0.0.1:7012,(400,MIN]), Full(/127.0.0.2:7012,(400,MIN]), Full(/127.0.0.3:7012,(400,MIN])]}
    (MIN,100] -&amp;gt; [Transient(/127.0.0.1:7012,(MIN,100]), Full(/127.0.0.2:7012,(MIN,100]), Full(/127.0.0.3:7012,(MIN,100])]}
    (100,200] -&amp;gt; [Full(/127.0.0.2:7012,(100,200]), Full(/127.0.0.3:7012,(100,200]), Transient(/127.0.0.1:7012,(100,200])]}
    (200,300] -&amp;gt; [Full(/127.0.0.3:7012,(200,300]), Full(/127.0.0.1:7012,(200,300]), Transient(/127.0.0.4:7012,(200,300])]}
    (300,350] -&amp;gt; [Full(/127.0.0.1:7012,(300,350]), Transient(/127.0.0.2:7012,(300,350]), Full(/127.0.0.4:7012,(300,350])]}
    (350,400] -&amp;gt; [Full(/127.0.0.4:7012,(350,400]), Full(/127.0.0.2:7012,(350,400]), Transient(/127.0.0.3:7012,(350,400])]}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;Please note that READ placements are always a subset of WRITE ones (or, well, in a way: we can technically read from full to satisfy a transient read)&lt;br/&gt;
after FINISH_MOVE, we get for both READ and WRITE:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    (400,MIN] -&amp;gt; [Full(/127.0.0.2:7012,(400,MIN]), Full(/127.0.0.3:7012,(400,MIN]), Transient(/127.0.0.1:7012,(400,MIN])]}
    (MIN,200] -&amp;gt; [Full(/127.0.0.2:7012,(MIN,200]), Transient(/127.0.0.1:7012,(MIN,200]), Full(/127.0.0.3:7012,(MIN,200])]}
    (200,300] -&amp;gt; [Full(/127.0.0.3:7012,(200,300]), Full(/127.0.0.1:7012,(200,300]), Transient(/127.0.0.4:7012,(200,300])]}
    (300,350] -&amp;gt; [Full(/127.0.0.1:7012,(300,350]), Transient(/127.0.0.2:7012,(300,350]), Full(/127.0.0.4:7012,(300,350])]}
    (350,400] -&amp;gt; [Full(/127.0.0.4:7012,(350,400]), Full(/127.0.0.2:7012,(350,400]), Transient(/127.0.0.3:7012,(350,400])]} 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After executing START_MOVE, we get 3 full and no transient nodes for &lt;tt&gt;(200,300]&lt;/tt&gt;. If we put transitions together, we see: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    1. (200,300] -&amp;gt; [Full(/127.0.0.3:7012,(200,300]), Full(/127.0.0.4:7012,(200,300]), Transient(/127.0.0.1:7012,(200,300])]}
    2. (200,300] -&amp;gt; [Full(/127.0.0.3:7012,(200,300]), Full(/127.0.0.4:7012,(200,300]), Full(/127.0.0.1:7012,(200,300])]}
    3. (200,300] -&amp;gt; [Full(/127.0.0.3:7012,(200,300]), Full(/127.0.0.1:7012,(200,300]), Transient(/127.0.0.4:7012,(200,300])]}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In &lt;tt&gt;2.&lt;/tt&gt;, you see that &lt;tt&gt;127.0.0.1&lt;/tt&gt; went from transient to full, since it is now gaining a range, and should be a target for pending writes for this range. At the same time, it remains a &lt;em&gt;transient read replica&lt;/em&gt;. In &lt;tt&gt;3.&lt;/tt&gt;, &lt;tt&gt;127.0.0.04&lt;/tt&gt; went from full to transient; it was kept full up till now since it was a streaming source, and to keep consistency levels correct, we &lt;/p&gt;

&lt;p&gt;What is unintuitive here is that usually, with replication factor of 3, we see the &lt;em&gt;fourth&lt;/em&gt; node added as pending. This happens because all ranges are unique. With transient replication, the node can remain an owner of the same range, but because of the new token in the ring, change its transient status (from transient to full or vice versa).  &lt;/p&gt;

&lt;p&gt;At the same time, when the node&apos;s transient status does not change, we can end up with  2 full and 2 transient. See &lt;tt&gt;(100,200&lt;/tt&gt; or &lt;tt&gt;(350,400]&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;All these cases are a consequence of streaming during range handoff.  &lt;/p&gt;</comment>
                            <comment id="17838739" author="beobal" created="Thu, 18 Apr 2024 16:58:19 +0000"  >&lt;p&gt;Rebased and attached an updated &lt;tt&gt;ci_summary-1.html&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17838909" author="krummas" created="Fri, 19 Apr 2024 08:27:24 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17838910" author="ifesdjeen" created="Fri, 19 Apr 2024 08:27:51 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17838913" author="beobal" created="Fri, 19 Apr 2024 08:42:21 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310760">
                    <name>Testing</name>
                                                                <inwardlinks description="Discovered while testing">
                                        <issuelink>
            <issuekey id="13560610">CASSANDRA-19167</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13068303" name="ci_summary-1.html" size="21513" author="samt" created="Thu, 18 Apr 2024 16:57:48 +0000"/>
                            <attachment id="13067597" name="ci_summary.html" size="7078" author="samt" created="Fri, 22 Mar 2024 08:38:11 +0000"/>
                            <attachment id="13068149" name="remove-n4-post-19344.txt" size="3070" author="samt" created="Thu, 11 Apr 2024 17:56:51 +0000"/>
                            <attachment id="13068148" name="remove-n4-pre-19344.txt" size="2969" author="samt" created="Thu, 11 Apr 2024 17:56:51 +0000"/>
                            <attachment id="13067598" name="result_details.tar.gz" size="42137301" author="samt" created="Fri, 22 Mar 2024 08:38:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
        <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>CASSANDRA-19055</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1n3yo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
        <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348835">NA</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/dabcb175527d3c2daef54c6ce029b3c3054b2a77&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/dabcb175527d3c2daef54c6ce029b3c3054b2a77&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;New and existing tests in attached CI results.&lt;br/&gt;
The few failures/errors in the attached results are known (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19343&quot; title=&quot;Test Failure: org.apache.cassandra.fuzz.ring.ConsistentBootstrapTest.coordinatorIsBehindTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19343&quot;&gt;&lt;del&gt;CASSANDRA-19343&lt;/del&gt;&lt;/a&gt;) or look to be infra-related.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>