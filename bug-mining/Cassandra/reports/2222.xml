<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:06 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5692] Race condition in detecting version on a mixed 1.1/1.2 cluster</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5692</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;On a mixed 1.1 / 1.2 cluster, starting 1.2 nodes fires sometimes a race condition in version detection, where the 1.2 node wrongly detects version 6 for a 1.1 node.&lt;/p&gt;

&lt;p&gt;It works as follows:&lt;br/&gt;
1) The just started 1.2 node quickly opens an OutboundTcpConnection toward a 1.1 node before receiving any messages from the latter.&lt;br/&gt;
2) Given the version is correctly detected only when the first message is received, the version is momentarily set at 6.&lt;br/&gt;
3) This opens an OutboundTcpConnection from 1.2 to 1.1 at version 6, which gets stuck in the connect() method.&lt;/p&gt;

&lt;p&gt;Later, the version is correctly fixed, but all outbound connections from 1.2 to 1.1 are stuck at this point.&lt;/p&gt;

&lt;p&gt;Evidence from 1.2 logs:&lt;br/&gt;
TRACE 13:48:31,133 Assuming current protocol version for /127.0.0.2&lt;br/&gt;
DEBUG 13:48:37,837 Setting version 5 for /127.0.0.2&lt;/p&gt;</description>
                <environment></environment>
        <key id="12654375">CASSANDRA-5692</key>
            <summary>Race condition in detecting version on a mixed 1.1/1.2 cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sbtourist">Sergio Bossa</assignee>
                                    <reporter username="sbtourist">Sergio Bossa</reporter>
                        <labels>
                    </labels>
                <created>Sun, 23 Jun 2013 12:57:54 +0000</created>
                <updated>Tue, 14 Oct 2025 12:14:00 +0000</updated>
                            <resolved>Thu, 27 Jun 2013 20:40:19 +0000</resolved>
                                        <fixVersion>1.2.7</fixVersion>
                    <fixVersion>2.0 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13691453" author="sbtourist" created="Sun, 23 Jun 2013 13:01:41 +0000"  >&lt;p&gt;I believe the correct thing to do is to &lt;em&gt;never&lt;/em&gt; assume a version when opening an outbound connection: rather, retrying a few times waiting for the version to be detected, and eventually failing fast.&lt;/p&gt;</comment>
                            <comment id="13691456" author="sbtourist" created="Sun, 23 Jun 2013 13:33:51 +0000"  >&lt;p&gt;Attaching patch with fail fast behaviour if no version is known yet after 30 seconds.&lt;/p&gt;</comment>
                            <comment id="13691489" author="sbtourist" created="Sun, 23 Jun 2013 15:23:23 +0000"  >&lt;p&gt;Attaching a second patch, cleaner and more correct imho.&lt;/p&gt;</comment>
                            <comment id="13691503" author="sbtourist" created="Sun, 23 Jun 2013 16:15:21 +0000"  >&lt;p&gt;Third patch, even better &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13691512" author="sbtourist" created="Sun, 23 Jun 2013 16:34:04 +0000"  >&lt;p&gt;Cleaned up things, left only the two relevant versions.&lt;/p&gt;</comment>
                            <comment id="13691630" author="cdaw" created="Sun, 23 Jun 2013 22:46:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sbtourist&quot; class=&quot;user-hover&quot; rel=&quot;sbtourist&quot;&gt;sbtourist&lt;/a&gt;&lt;br/&gt;
i can apply patch 001 or 004 successfully, but not able to apply 001 + 004.   Do I need both?&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# via git apply
$ git reset --hard HEAD
HEAD is now at 0f7c7dc Merge pull request #15 from riptano/CASSANDRA-5476

$ git apply --whitespace=fix 5692-0001.patch 5692-0004.patch
5692-0001.patch:37: trailing whitespace.

5692-0004.patch:89: trailing whitespace.

5692-0004.patch:133: trailing whitespace.

5692-0004.patch:138: trailing whitespace.

5692-0004.patch:143: trailing whitespace.

error: patch failed: src/java/org/apache/cassandra/net/OutboundTcpConnection.java:278
error: src/java/org/apache/cassandra/net/OutboundTcpConnection.java: patch does not apply

# via unix patch
$ git reset --hard HEAD
HEAD is now at 0f7c7dc Merge pull request #15 from riptano/CASSANDRA-5476

$ patch -l -p1 &amp;lt; 5692-0001.patch
patching file src/java/org/apache/cassandra/net/OutboundTcpConnection.java

$ patch -l -p1 &amp;lt; 5692-0004.patch
patching file src/java/org/apache/cassandra/net/MessagingService.java
patching file src/java/org/apache/cassandra/net/OutboundTcpConnection.java
Hunk #1 FAILED at 278.
1 out of 1 hunk FAILED -- saving rejects to file src/java/org/apache/cassandra/net/OutboundTcpConnection.java.rej

$ cat src/java/org/apache/cassandra/net/OutboundTcpConnection.java.rej
***************
*** 278,284 ****
          if (logger.isDebugEnabled())
              logger.debug(&quot;attempting to connect to &quot; + poolReference.endPoint());

-         targetVersion = MessagingService.instance().getVersion(poolReference.endPoint());

          long start = System.currentTimeMillis();
          while (System.currentTimeMillis() &amp;lt; start + DatabaseDescriptor.getRpcTimeout())
--- 278,284 ----
          if (logger.isDebugEnabled())
              logger.debug(&quot;attempting to connect to &quot; + poolReference.endPoint());

+         targetVersion = MessagingService.instance().getVersion(poolReference.endPoint(), true);

          long start = System.currentTimeMillis();
          while (System.currentTimeMillis() &amp;lt; start + DatabaseDescriptor.getRpcTimeout())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </comment>
                            <comment id="13691634" author="sbtourist" created="Sun, 23 Jun 2013 22:56:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cdaw&quot; class=&quot;user-hover&quot; rel=&quot;cdaw&quot;&gt;cdaw&lt;/a&gt;, those are two different versions of the same patch, you don&apos;t need both: it&apos;s either one or the other, up to the reviewer for discussion, I second the latter.&lt;/p&gt;</comment>
                            <comment id="13691941" author="sbtourist" created="Mon, 24 Jun 2013 12:52:18 +0000"  >&lt;p&gt;Given the first message which should setup the version is sent along the same connection, this patch doesn&apos;t actually work, causing two 1.2 nodes to block each other during bootstrap.&lt;/p&gt;

&lt;p&gt;So I&apos;m attaching a different patch (0005), which implements a simple handshake by assuming version 6 and trying to read the actual version on a different thread, so that it can be interrupted (disconnected) and can retry the handshake until one of the following happens:&lt;br/&gt;
1) The version is confirmed to be &amp;gt;= 6, and the handshake succeeds.&lt;br/&gt;
2) The version is an old one, hence it is expected to be found among the tracked versions when the first gossip message is received.&lt;/p&gt;

&lt;p&gt;Sorry for all the different patches, but the implementation details of all the version exchange machinery turned out to be quite subtle.&lt;/p&gt;</comment>
                            <comment id="13693044" author="jasobrown" created="Tue, 25 Jun 2013 13:49:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tourist&quot; class=&quot;user-hover&quot; rel=&quot;tourist&quot;&gt;tourist&lt;/a&gt;, can you rebase against 1.2? I can&apos;t apply the patch to either 1.2 nor trunk. thanks.&lt;/p&gt;</comment>
                            <comment id="13693176" author="sbtourist" created="Tue, 25 Jun 2013 17:23:55 +0000"  >&lt;p&gt;Rebased patch on top of cassandra-1.2 branch.&lt;/p&gt;</comment>
                            <comment id="13694996" author="jasobrown" created="Thu, 27 Jun 2013 19:47:15 +0000"  >&lt;p&gt;On the whole, lgtm, but I&apos;m not sure about the InterruptedException part. From my reading of the CDL javadoc, the IE is thrown &quot;if the current thread is interrupted while waiting&quot;. This is indicates that the waiting thread, the one calling versionLatch.await in your code, is being interrupted, not the Handshake thread. Everywhere else in OTC where we catch IE, we throw an AssertionError - basically stop execution of the method and bail. I&apos;m not sure we would we do something different in handshakeVersion(), as if we got an interrupt I think we&apos;d want to bail out, as well, and try to to finish connecting to the remote node.&lt;/p&gt;

&lt;p&gt;Also, as a minor nit, I moved the versionLatch.countDown() into a finally block, as we want to unblock the waiting thread regardless of success or failure to read the version from the socket.&lt;/p&gt;</comment>
                            <comment id="13695016" author="sbtourist" created="Thu, 27 Jun 2013 20:06:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;From my reading of the CDL javadoc, the IE is thrown &quot;if the current thread is interrupted while waiting&quot;. This is indicates that the waiting thread, the one calling versionLatch.await in your code, is being interrupted, not the Handshake thread.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Correct. That was to account for spurious interrupts, but I&apos;m fine with adhering to conventions and throwing AE.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Also, as a minor nit, I moved the versionLatch.countDown() into a finally block, as we want to unblock the waiting thread regardless of success or failure to read the version from the socket.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It would have go unblocked after the timeout, but actually better to fail/unblock as fast as possible &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13695041" author="jasobrown" created="Thu, 27 Jun 2013 20:39:36 +0000"  >&lt;p&gt;Cool, thanks for the confirmation.&lt;/p&gt;

&lt;p&gt;Committed to 1.2 and trunk. Thanks!&lt;/p&gt;</comment>
                            <comment id="13794929" author="JIRAUSER308715" created="Tue, 15 Oct 2013 06:26:45 +0000"  >&lt;p&gt;This does not seem to be fixed (or there is another race condition) as of 1.2.10.  Just saw this happen that during an upgrade 10 node cluster, 5 in each DC.  There were 6 nodes, 3 in each DC, seeing 4 nodes, 2 in each DC as the wrong version.  This was causing timeout failures, and describe cluster failures (only from the nodes seen as being on the wrong version).  Restarting the &quot;wrong version&quot; nodes didn&apos;t fix anything.  We had to restart the 6 nodes to get them to re-detect version, and then things started working.&lt;/p&gt;</comment>
                            <comment id="13794960" author="sbtourist" created="Tue, 15 Oct 2013 07:30:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjordan&quot; class=&quot;user-hover&quot; rel=&quot;jjordan&quot;&gt;jjordan&lt;/a&gt;, do we have thread dumps from the timeout failures (prior the timeout)? If that didn&apos;t involve the connect method, we&apos;re probably seeing a different race.&lt;/p&gt;

&lt;p&gt;Anyways, I&apos;ll have a look.&lt;/p&gt;</comment>
                            <comment id="13795253" author="JIRAUSER308715" created="Tue, 15 Oct 2013 14:53:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sbtourist&quot; class=&quot;user-hover&quot; rel=&quot;sbtourist&quot;&gt;sbtourist&lt;/a&gt; no thread dumps.  given nodes e1-e5.  Queries to e1, and &quot;describe cluster&quot; on e1 showed all nodes.  Queries to e5 would usually timeout, and &quot;describe cluster;&quot; on e5 would show e1-e3 as &quot;UNAVAILABLE&quot;.  netstat -tn | grep &amp;lt;e1 ip&amp;gt; on e5 showed:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;e5:7000 &amp;lt;-&amp;gt; e1:&amp;lt;high port&amp;gt;
e5:&amp;lt;high port&amp;gt; &amp;lt;-&amp;gt; e1:7000
e5:&amp;lt;high port 2&amp;gt; &amp;lt;-&amp;gt; e1:7000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Where e5 to a node which responded to the &quot;describe cluster;&quot; showed:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;e5:7000 &amp;lt;-&amp;gt; e4:&amp;lt;high port&amp;gt;
e5:7000 &amp;lt;-&amp;gt; e4:&amp;lt;high port 2&amp;gt;
e5:&amp;lt;high port&amp;gt; &amp;lt;-&amp;gt; e4:7000
e5:&amp;lt;high port 2&amp;gt; &amp;lt;-&amp;gt; e4:7000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And in the TRACE level logs for IncomingTcpConnection.java when restarting e5 I only see one connection come in from e1, but there are two that come in from e4.  When I enabled TRACE level logs for e1, it was just spitting out something about &quot;version 5&quot; over and over really fast.  At that point we restarted e1, and it came up and everything was happy from e1-&amp;gt;e5, so then we did a rolling restart on the cluster and went to bed.&lt;/p&gt;</comment>
                            <comment id="13795371" author="JIRAUSER308715" created="Tue, 15 Oct 2013 16:53:38 +0000"  >&lt;p&gt;Actually, I didn&apos;t read this ticket right, this is something different.  The nodes are all on 1.2 already, but being seen as version 5 (1.1).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12589397" name="5692-0005.patch" size="4824" author="sbtourist" created="Mon, 24 Jun 2013 12:52:46 +0000"/>
                            <attachment id="12589627" name="5692-0006.patch" size="4824" author="sbtourist" created="Tue, 25 Jun 2013 17:23:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[sbtourist]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334652</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 6 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1lq6v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334978</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>