<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10592] IllegalArgumentException in DataOutputBuffer.reallocate</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10592</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;CORRECTION-&lt;br/&gt;
It turns out the exception occurs when running a read using a thrift jdbc driver. Once you have loaded the data with stress below, run &lt;br/&gt;
SELECT * FROM &quot;autogeneratedtest&quot;.&quot;transaction_by_retailer&quot; using this tool - &lt;a href=&quot;http://www.aquafold.com/aquadatastudio_downloads.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.aquafold.com/aquadatastudio_downloads.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;WARN  [SharedPool-Worker-1] 2015-10-22 12:58:20,792 AbstractTracingAwareExecutorService.java:169 - Uncaught exception on thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[SharedPool-Worker-1,5,main]: {}
java.lang.RuntimeException: java.lang.IllegalArgumentException
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2366) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_60]
	at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) ~[main/:na]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [main/:na]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_60]
Caused by: java.lang.IllegalArgumentException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at java.nio.ByteBuffer.allocate(ByteBuffer.java:334) ~[na:1.8.0_60]
	at org.apache.cassandra.io.util.DataOutputBuffer.reallocate(DataOutputBuffer.java:63) ~[main/:na]
	at org.apache.cassandra.io.util.DataOutputBuffer.doFlush(DataOutputBuffer.java:57) ~[main/:na]
	at org.apache.cassandra.io.util.BufferedDataOutputStreamPlus.write(BufferedDataOutputStreamPlus.java:132) ~[main/:na]
	at org.apache.cassandra.io.util.BufferedDataOutputStreamPlus.write(BufferedDataOutputStreamPlus.java:151) ~[main/:na]
	at org.apache.cassandra.utils.ByteBufferUtil.writeWithVIntLength(ByteBufferUtil.java:296) ~[main/:na]
	at org.apache.cassandra.db.marshal.AbstractType.writeValue(AbstractType.java:374) ~[main/:na]
	at org.apache.cassandra.db.rows.BufferCell$Serializer.serialize(BufferCell.java:263) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:183) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:108) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:96) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:132) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:87) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:77) ~[main/:na]
	at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:381) ~[main/:na]
	at org.apache.cassandra.db.ReadResponse$LocalDataResponse.build(ReadResponse.java:136) ~[main/:na]
	at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:128) ~[main/:na]
	at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:123) ~[main/:na]
	at org.apache.cassandra.db.ReadResponse.createDataResponse(ReadResponse.java:65) ~[main/:na]
	at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:289) ~[main/:na]
	at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1697) ~[main/:na]
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2362) ~[main/:na]
	... 4 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I was running this command:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    tools/bin/cassandra-stress user profile=~/Desktop/startup/stress/stress.yaml n=100000 ops\(insert=1\) -rate threads=30
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here&apos;s the stress.yaml UPDATED!&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;### DML ### THIS IS UNDER CONSTRUCTION!!!

# Keyspace Name
keyspace: autogeneratedtest

# The CQL &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; creating a keyspace (optional &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it already exists)
keyspace_definition: |
  CREATE KEYSPACE autogeneratedtest WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1};
# Table name
table: test
# The CQL &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; creating a table you wish to stress (optional &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it already exists)
table_definition:
  CREATE TABLE test (
  a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  d &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  e &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  f timestamp,
  g text,
  h bigint,
  i text,
  j text,
  k bigint,
  l text,
  m text,
  n &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;,
  o &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  p &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;,
  q &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;,
  r text,
  s &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;,
  PRIMARY KEY ((a, c, d, b, e), m, f, g)
  );
### Column Distribution Specifications ###

columnspec:
  - name: a
    size: uniform(4..4)
    population: uniform(1..500)

  - name: b
    size: uniform(4..4)
    population: uniform(2..3000)

  - name: c
    size: uniform(4..4)
    population: uniform(1..100)

  - name: d
    size: uniform(4..4)
    population: uniform(1..120)

  - name: e
    size: uniform(4..4)
    population: uniform(1..100)


  - name: f
    size: fixed(4)
    population: fixed(1)
    cluster: fixed(100)

  - name: g
    size: fixed(40)
    population: fixed(1)
    cluster: fixed(10)

  - name: h
    size: fixed(4)
    population: fixed(1)

  - name: i
    size: fixed(400000)
    population: fixed(10)

  - name: j
    size: uniform(40..40)
    population: fixed(1)

  - name: k
    size: fixed(8)
    population: fixed(1)

  - name: l
    size: fixed(1)
    population: fixed(1)

  - name: m
    size: uniform(40..40)
    population: uniform(1..2000)

  - name: n
    size: gaussian(4..4)
    population: gaussian(1..100)

  - name: o
    size: fixed(4)
    population: fixed(1)

  - name: p
    size: gaussian(8..8)
    population: gaussian(1..100)

  - name: q
    size: gaussian(8..8)
    population: gaussian(1..10000)

  - name: r
    size: fixed(40)
    population: fixed(2)

  - name: s
    size: gaussian(8..8)
    population: gaussian(1..200000)



### Batch Ratio Distribution Specifications ###

insert:
  partitions: fixed(1)            # Our partition key is the domain so only insert one per batch

  select:  fixed(1)/1000        # We have 1000 posts per domain so 1/1000 will allow 1 post per batch

  batchtype: UNLOGGED             # Unlogged batches


#
# A list of queries you wish to run against the schema
#
queries:
   likelyquery0:
    cql: Select * from test where a = ? and c = ? and d = ? and b = ? and e = ?
    fields: samerow
   likelyquery1:
    cql: Select * from test where a = ? and c = ? and d = ? and b = ? and e = ? and m = ?
    fields: samerow
   likelyquery2:
    cql: Select * from test where a = ? and c = ? and d = ? and b = ? and e = ? and m = ? and f = ?
    fields: samerow
   likelyquery3:
    cql: Select * from test where a = ? and c = ? and d = ? and b = ? and e = ? and m = ? and f = ? and g = ?
    fields: samerow
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12907938">CASSANDRA-10592</key>
            <summary>IllegalArgumentException in DataOutputBuffer.reallocate</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aweisberg">Ariel Weisberg</assignee>
                                    <reporter username="sebastian.estevez@datastax.com">Sebastian Estevez</reporter>
                        <labels>
                    </labels>
                <created>Mon, 26 Oct 2015 15:18:18 +0000</created>
                <updated>Wed, 15 Oct 2025 09:49:00 +0000</updated>
                            <resolved>Wed, 2 Dec 2015 03:47:02 +0000</resolved>
                                        <fixVersion>2.2.4</fixVersion>
                    <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                    <component>Legacy/Streaming and Messaging</component>
                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14974720" author="aweisberg" created="Mon, 26 Oct 2015 18:14:56 +0000"  >&lt;p&gt;This looks like Integer overflow in DOB during reallocation. The response to some query is probably slightly larger than 1gb.&lt;/p&gt;

&lt;p&gt;I&apos;ll confirm I can reproduce this, fix it, and look at missing coverage for stuff in the 2 gig range in o.a.c.io.util.*. Integer overflow was not something that was on my mind when we did a lot of that work.&lt;/p&gt;</comment>
                            <comment id="14974894" author="aweisberg" created="Mon, 26 Oct 2015 19:50:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sebastian.estevez%40datastax.com&quot; class=&quot;user-hover&quot; rel=&quot;sebastian.estevez@datastax.com&quot;&gt;sebastian.estevez@datastax.com&lt;/a&gt; I was able to reproduce the problem I found via code inspection in a unit test. I am trying to run the workload you posted. I am cleaning out the data directory and restarting cassandra each time.&lt;/p&gt;

&lt;p&gt;I get this error&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.UnsupportedOperationException: Because of &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; name: i &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you removed it from the yaml and are still seeing &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, make sure to drop table
	at org.apache.cassandra.stress.StressProfile$ColumnInfo.getGenerator(StressProfile.java:563)
	at org.apache.cassandra.stress.StressProfile$ColumnInfo.getGenerator(StressProfile.java:522)
	at org.apache.cassandra.stress.StressProfile$GeneratorFactory.get(StressProfile.java:502)
	at org.apache.cassandra.stress.StressProfile$GeneratorFactory.newGenerator(StressProfile.java:495)
	at org.apache.cassandra.stress.StressProfile.newGenerator(StressProfile.java:471)
	at org.apache.cassandra.stress.settings.SettingsCommandUser$1.newGenerator(SettingsCommandUser.java:90)
	at org.apache.cassandra.stress.operations.SampledOpDistributionFactory$1.get(SampledOpDistributionFactory.java:80)
	at org.apache.cassandra.stress.StressAction$Consumer.&amp;lt;init&amp;gt;(StressAction.java:269)
	at org.apache.cassandra.stress.StressAction.run(StressAction.java:204)
	at org.apache.cassandra.stress.StressAction.warmup(StressAction.java:104)
	at org.apache.cassandra.stress.StressAction.run(StressAction.java:60)
	at org.apache.cassandra.stress.Stress.main(Stress.java:121)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14976569" author="sebastian.estevez@datastax.com" created="Tue, 27 Oct 2015 15:32:38 +0000"  >&lt;p&gt;Right sorry about that, I corrected the file now. You&apos;ll have to drop the table and try again. We don&apos;t support maps in cassandra stress and I must have pasted an old version of the yaml.&lt;/p&gt;</comment>
                            <comment id="14976570" author="sebastian.estevez@datastax.com" created="Tue, 27 Oct 2015 15:32:55 +0000"  >&lt;p&gt;By the way now I&apos;m seeing it on 3.0 RC2 as well.&lt;/p&gt;</comment>
                            <comment id="14976650" author="aweisberg" created="Tue, 27 Oct 2015 16:23:14 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...aweisberg:CASSANDRA-10592?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="14977265" author="aweisberg" created="Tue, 27 Oct 2015 22:13:58 +0000"  >&lt;p&gt;Going to call this patch available even though the dtests are still running. I really do not think my changes will have an impact on the dtests so no reason to not start reviewing.&lt;/p&gt;</comment>
                            <comment id="14979309" author="aweisberg" created="Wed, 28 Oct 2015 21:51:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sebastian.estevez%40datastax.com&quot; class=&quot;user-hover&quot; rel=&quot;sebastian.estevez@datastax.com&quot;&gt;sebastian.estevez@datastax.com&lt;/a&gt; I having a tough time running the query in that tool. I used C* branched off of 2.2 tip. I take it the table is named test not transaction_by_retailer.&lt;/p&gt;

&lt;p&gt;I can&apos;t find where I can just enter the query. The query builder seems kind of broken and can&apos;t see the table schema. It won&apos;t let me add it to the select deck.&lt;/p&gt;</comment>
                            <comment id="14985418" author="benedict" created="Mon, 2 Nov 2015 15:49:58 +0000"  >&lt;p&gt;We should probably switch to a consistent {+ 1/2} growth.&lt;/p&gt;

&lt;p&gt;I&apos;ll also note I&apos;m not super keen on using &lt;tt&gt;Precondition&lt;/tt&gt; to check a post-condition&lt;/p&gt;</comment>
                            <comment id="14985646" author="aweisberg" created="Mon, 2 Nov 2015 18:02:19 +0000"  >&lt;p&gt;Maybe we should use the same strategy that assumes we know how many bytes we are appending for both? Have doFlush() take a count and then we can make sure that when we double there is enough room to store the entire thing we are trying to write?&lt;/p&gt;
</comment>
                            <comment id="14985673" author="benedict" created="Mon, 2 Nov 2015 18:18:58 +0000"  >&lt;p&gt;That sounds pretty reasonable to me, yeah.&lt;/p&gt;</comment>
                            <comment id="14985833" author="aweisberg" created="Mon, 2 Nov 2015 19:19:55 +0000"  >&lt;p&gt;Pushed an update with what I am thinking.&lt;/p&gt;</comment>
                            <comment id="14987717" author="benedict" created="Tue, 3 Nov 2015 17:46:03 +0000"  >&lt;ul&gt;
	&lt;li&gt;Could we keep the testing code isolated from the functional code where possible?
	&lt;ul&gt;
		&lt;li&gt;&lt;tt&gt;checkedArraySizeCast&lt;/tt&gt; is only used by the test case, so could perhaps be migrated there?&lt;/li&gt;
		&lt;li&gt;&lt;tt&gt;testableCapacity&lt;/tt&gt; could just be called &lt;tt&gt;capacity&lt;/tt&gt;?&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;I think increasing by 50% of the current size, rather than doubling, is better practice - especially as we get larger&lt;/li&gt;
	&lt;li&gt;Could we perhaps use &lt;tt&gt;calculateNewSize&lt;/tt&gt; in &lt;tt&gt;SafeMemoryWriter&lt;/tt&gt; (overriding the new &lt;tt&gt;capacity&lt;/tt&gt; method and &lt;tt&gt;validateReallocation&lt;/tt&gt; should make this possible), so that resizing semantics are consistent?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Otherwise LGTM&lt;/p&gt;</comment>
                            <comment id="14987730" author="aweisberg" created="Tue, 3 Nov 2015 17:58:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think increasing by 50% of the current size, rather than doubling, is better practice - especially as we get larger&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Is it? Doesn&apos;t that mean more allocations and more time spent copying in many common cases?&lt;/p&gt;

&lt;p&gt;I don&apos;t see why it being larger makes it any better or worse. You still have no idea how many more times you are going to have to grow.&lt;/p&gt;</comment>
                            <comment id="14987734" author="benedict" created="Tue, 3 Nov 2015 18:03:06 +0000"  >&lt;p&gt;The amount of wasted memory is smaller. With &amp;gt; 1Gb objects (like we&apos;re dealing with here), that is potentially a serious issue. Yes, more work is potentially done (which is why I suggest it may not be better at small sizes, when we don&apos;t care so much), however the extra work is a constant factor. Perhaps we should gradate the size increments, so that when we get to measurable quantities we shift to 50% increments. &lt;/p&gt;

&lt;p&gt;I very much doubt our copying during these reallocations is a performance issue at the moment, however, so I would prefer to bound our worst case memory consumption if choosing between the two.&lt;/p&gt;</comment>
                            <comment id="14987739" author="aweisberg" created="Tue, 3 Nov 2015 18:04:53 +0000"  >&lt;p&gt;At what threshold should we switch to increasing by 50%? 1 gigabyte?&lt;/p&gt;</comment>
                            <comment id="14987816" author="aweisberg" created="Tue, 3 Nov 2015 18:37:23 +0000"  >&lt;p&gt;Just an FYI, switching from doubling to 50% triggered OOM in a test case that was previously passing. I think it&apos;s actually worse in the worst case in terms of impact on a garbage collected heap.&lt;/p&gt;</comment>
                            <comment id="14987874" author="benedict" created="Tue, 3 Nov 2015 19:03:55 +0000"  >&lt;p&gt;Size of data GC&apos;d should not affect OOM. More likely the maximum object size for your test is slightly larger, so the contiguous allocation required crosses the achievable threshold.&lt;/p&gt;

&lt;p&gt;Honestly I don&apos;t mind terribly though. Especially since this isn&apos;t a problem anyone&apos;s encountered in the wild, so feel free to stick with * 2 universally.&lt;/p&gt;</comment>
                            <comment id="14987927" author="aweisberg" created="Tue, 3 Nov 2015 19:27:33 +0000"  >&lt;p&gt;It&apos;s not max object size. The test increases all the way to the max of 2 gigs. It might be that the intermediate sequence of allocations uses more memory. Such as a 2 gig allocation and a 1.5 gig allocation instead of a 1 and 2.&lt;/p&gt;

&lt;p&gt;It works with a larger heap so it is fine with me. It also seems like 1.5x is not unheard of. I pushed an update with this change.&lt;/p&gt;</comment>
                            <comment id="14989414" author="benedict" created="Wed, 4 Nov 2015 11:49:21 +0000"  >&lt;p&gt;Patch LGTM.&lt;/p&gt;</comment>
                            <comment id="14990161" author="aweisberg" created="Wed, 4 Nov 2015 18:50:45 +0000"  >&lt;p&gt;Squashed and a new branch for the merge to 3.0. Tests running now.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...aweisberg:CASSANDRA-10592-2.2-squashed?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 Code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-2.2-squashed-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-2.2-squashed-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...aweisberg:CASSANDRA-10592-3.0-squashed?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 Code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-3.0-squashed-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-3.0-squashed-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="14992388" author="aweisberg" created="Thu, 5 Nov 2015 20:18:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; The utests look good. The dtests I don&apos;t know. I might have to rebase to perform a comparison with tip of trunk.&lt;/p&gt;

&lt;p&gt;I&apos;m going to do that on a new branch and we can make the decision what/when to merge in parallel.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...aweisberg:CASSANDRA-10592-2.2-squashed-v2?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 Code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-2.2-squashed-v2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-2.2-squashed-v2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...aweisberg:CASSANDRA-10592-3.0-squashed-v2?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 Code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-3.0-squashed-v2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-3.0-squashed-v2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15004523" author="jmckenzie" created="Fri, 13 Nov 2015 19:03:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; to review 3.0 branch since Benedict&apos;s on vacation.&lt;/p&gt;</comment>
                            <comment id="15022218" author="tjake" created="Mon, 23 Nov 2015 15:04:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sebastian.estevez%40datastax.com&quot; class=&quot;user-hover&quot; rel=&quot;sebastian.estevez@datastax.com&quot;&gt;sebastian.estevez@datastax.com&lt;/a&gt; can you verify this patch fixes your original stress workload as well?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; The new property seems like something no one will ever know about or use.  Do we need it or is it an over optimization?  &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;DOB.calculateNewSize it would be clearer/safer to mark all constant numbers there as Longs.&lt;/li&gt;
	&lt;li&gt;BDO.doFlush does nothing with count&lt;/li&gt;
	&lt;li&gt;Why does flush call reallocate?  If that&apos;s just a hack to make sure we always reallocate, we&apos;ve now made it worse by passing a param only used&lt;br/&gt;
    by reallocate and not flush &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; see comment above.&lt;/li&gt;
	&lt;li&gt;Why does reallocate always reallocate even if you send in 0&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="15022358" author="aweisberg" created="Mon, 23 Nov 2015 16:08:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;The new property seems like something no one will ever know about or use. Do we need it or is it an over optimization?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It&apos;s not there to allow optimization. It&apos;s there in case we made a bad choice for the constant in some scenario and people in the field need to be able to fix it without changing code. If it was something that people should actually be changing it would be in the YAML as a documented tunable.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;BDO.doFlush does nothing with count&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;BDO doesn&apos;t need the count to flush. BDO flushes to a channel which doesn&apos;t have any use for that information.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Why does flush call reallocate? If that&apos;s just a hack to make sure we always reallocate, we&apos;ve now made it worse by passing a param only used&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;by reallocate and not flush  see comment above.&lt;br/&gt;
I don&apos;t follow how things are made worse. The count is just a hint to make sure that the resize is big enough, but resizing still takes place at 0 the way it used to.&lt;/p&gt;

&lt;p&gt;Users of the class causing reallocation via &lt;tt&gt;flush()&lt;/tt&gt; is yucky and yeah we shouldn&apos;t allow that since I don&apos;t see how people can benefit from it, and they can be hurt by calling it accidentally.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Why does reallocate always reallocate even if you send in 0&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I will use &amp;lt;= 0 to indicate that no resizing should occur in DataOutputBuffer like you are suggesting.&lt;/p&gt;

</comment>
                            <comment id="15022408" author="aweisberg" created="Mon, 23 Nov 2015 16:32:29 +0000"  >&lt;p&gt;Huh, so actually it&apos;s mostly taken care of. &lt;tt&gt;DataOutputBuffer.flush()&lt;/tt&gt; throws UnsupportedOperationException and &lt;tt&gt;DataOutputBuffer.close()&lt;/tt&gt; is overridden and does nothing.&lt;/p&gt;

&lt;p&gt;I added the check to &lt;tt&gt;reallocate(long)&lt;/tt&gt; for &amp;lt;= 0, but I can&apos;t find a way to test it short of subclassing and calling it directly. It&apos;s tempting to let it reallocate anyways because there are two potential bugs here. One bug is reallocating when we didn&apos;t need to and the application continues to run fine. The other bug is that it doesn&apos;t reallocate when it needs to and is stuck in an infinite loop.&lt;/p&gt;

&lt;p&gt;I am comfortable with either. Let me know what you want.&lt;/p&gt;</comment>
                            <comment id="15022435" author="tjake" created="Mon, 23 Nov 2015 16:47:20 +0000"  >&lt;p&gt;You call doFlush(0) in a few places in the patch&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...aweisberg:CASSANDRA-10592-3.0-squashed-v2?expand=1#diff-239be4e5e91ceb06535cf9fedca2c182R159&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/cassandra-3.0...aweisberg:CASSANDRA-10592-3.0-squashed-v2?expand=1#diff-239be4e5e91ceb06535cf9fedca2c182R159&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="15022604" author="aweisberg" created="Mon, 23 Nov 2015 18:01:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;You call doFlush(0) in a few places in the patch&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;OK. Can you articulate what you want done or how it is a problem?&lt;/p&gt;

&lt;p&gt;All the instances of 0 being passed in are instances where no reallocation is desired or required. All the instances I looked at take place outside the DataOutputBuffer hierarchy which is the only place the count hint is used. The two instances in BDOSP are both overridden by DataOutputBuffer.&lt;/p&gt;</comment>
                            <comment id="15022687" author="tjake" created="Mon, 23 Nov 2015 18:37:15 +0000"  >&lt;p&gt;I just want reallocate to not reallocate if it doesn&apos;t need to.&lt;/p&gt;</comment>
                            <comment id="15022709" author="aweisberg" created="Mon, 23 Nov 2015 18:48:04 +0000"  >&lt;p&gt;OK done.&lt;/p&gt;</comment>
                            <comment id="15022730" author="tjake" created="Mon, 23 Nov 2015 18:55:25 +0000"  >&lt;p&gt;Thanks +1, I&apos;ll commit once the tests re-run and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sebastian.estevez%40datastax.com&quot; class=&quot;user-hover&quot; rel=&quot;sebastian.estevez@datastax.com&quot;&gt;sebastian.estevez@datastax.com&lt;/a&gt; confirms his stress workload runs clean.&lt;/p&gt;</comment>
                            <comment id="15031814" author="sebastian.estevez@datastax.com" created="Mon, 30 Nov 2015 14:18:41 +0000"  >&lt;p&gt;I&apos;ll test it today. Thanks!&lt;/p&gt;</comment>
                            <comment id="15032766" author="sebastian.estevez@datastax.com" created="Tue, 1 Dec 2015 00:14:09 +0000"  >&lt;p&gt;Confirmed, the error is gone. The large read now blows the heap though. Not sure why &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7392&quot; title=&quot;Abort in-progress queries that time out&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7392&quot;&gt;&lt;del&gt;CASSANDRA-7392&lt;/del&gt;&lt;/a&gt; didn&apos;t stop the queries before that.&lt;/p&gt;

&lt;p&gt;Here&apos;s the log in case anyone&apos;s curious:&lt;br/&gt;
&lt;a href=&quot;https://gist.github.com/phact/abcb8e473e26ed48fa79&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/phact/abcb8e473e26ed48fa79&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;the query was executed at 7:07:43 per aqua:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;Executed: 11/30/2015 7:07:43 PM&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Execution: 0ms&amp;#93;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="15033840" author="tjake" created="Tue, 1 Dec 2015 15:13:25 +0000"  >&lt;p&gt;Hmm why does this OOM on a read command when you are running an insert?&lt;/p&gt;</comment>
                            <comment id="15034026" author="sebastian.estevez@datastax.com" created="Tue, 1 Dec 2015 16:40:59 +0000"  >&lt;p&gt;The stress insert=1 is just to prepare the data for the huge read that caused this problem.&lt;/p&gt;</comment>
                            <comment id="15034081" author="tjake" created="Tue, 1 Dec 2015 17:06:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; if you could squash and rebase I&apos;ll commit&lt;/p&gt;</comment>
                            <comment id="15034273" author="aweisberg" created="Tue, 1 Dec 2015 18:24:40 +0000"  >&lt;p&gt;Squashed and rebased. Tests are running.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...aweisberg:CASSANDRA-10592-2.2-squashed-v3?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 Code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-2.2-squashed-v3-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-2.2-squashed-v3-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...aweisberg:CASSANDRA-10592-3.0-squashed-v3?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 Code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-3.0-squashed-v3-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10592-3.0-squashed-v3-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15035216" author="tjake" created="Wed, 2 Dec 2015 03:47:02 +0000"  >&lt;p&gt;Committed as &lt;tt&gt;a320737b18c19e3ec59035e5e487f2af1dcd0172&lt;/tt&gt; in 2.2 and &lt;tt&gt;f7aaea013e98178064103d9b4cd39f66bad083f3&lt;/tt&gt; in 3.0&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2niz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>