<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11882] Clustering Key with ByteBuffer size &gt; 64k throws Assertion Error</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11882</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Setup:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE KEYSPACE Blues WITH REPLICATION = { &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt; : &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt; : 2};
CREATE TABLE test (a text, b text, PRIMARY KEY ((a), b))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There currently doesn&apos;t seem to be an existing check for selecting clustering keys that are larger than 64k. So if we proceed to do the following select:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CONSISTENCY ALL;
SELECT * FROM Blues.test WHERE a = &lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt; AND b = &lt;span class=&quot;code-quote&quot;&gt;&apos;something larger than 64k&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;An AssertionError is thrown in `ByteBufferUtil` with just a number and an error message detailing &apos;Coordinator node timed out waiting for replica nodes responses&apos; . Additionally, because an error extends Throwable (it&apos;s not a subclass of Exception), it&apos;s not caught so the connection between the coordinator node and the other nodes which have the replicas seem to be &apos;stuck&apos; until it&apos;s restarted. Any other subsequent queries, even if it&apos;s just SELECT where a = &apos;foo&apos; and b = &apos;bar&apos;, will always return the Coordinator timing out waiting for replica nodes responses&apos;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12972277">CASSANDRA-11882</key>
            <summary>Clustering Key with ByteBuffer size &gt; 64k throws Assertion Error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Lerh Low">Lerh Chuan Low</assignee>
                                    <reporter username="Lerh Low">Lerh Chuan Low</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 May 2016 04:28:38 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:31 +0000</updated>
                            <resolved>Thu, 23 Jun 2016 09:07:41 +0000</resolved>
                                        <fixVersion>2.1.15</fixVersion>
                    <fixVersion>2.2.7</fixVersion>
                    <fixVersion>3.0.8</fixVersion>
                    <fixVersion>3.8</fixVersion>
                                    <component>Legacy/CQL</component>
                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15297673" author="lerh low" created="Tue, 24 May 2016 04:51:30 +0000"  >&lt;p&gt;I can&apos;t find any ways of assigning it to myself, is it a permissions issue?&lt;/p&gt;

&lt;p&gt;I&apos;ve basically made a really simple patch - it just throws an IOException instead of an AssertionError (but it looks like there are many asserts scattered around the code base, any reason why?) with a more helpful message so that the coordinator doesn&apos;t see the other nodes as down forever. I&apos;ve also written a couple of tests and attempted to use the existing logic in QueryProcessor (That looks like the right place to put it) to sanitize the SELECT to begin with. Feel free to leave behind any comments! &lt;/p&gt;</comment>
                            <comment id="15301741" author="blambov" created="Thu, 26 May 2016 08:22:37 +0000"  >&lt;p&gt;The code looks good overall (with small style issue in &lt;tt&gt;overloadBuffer&lt;/tt&gt;)), but I&apos;d prefer to throw an &lt;tt&gt;IllegalArgumentException&lt;/tt&gt; instead of &lt;tt&gt;IOException&lt;/tt&gt; and would use &lt;tt&gt;assertInvalidThrow&lt;/tt&gt; in the test to make sure the right class of exception is thrown.&lt;/p&gt;</comment>
                            <comment id="15301902" author="slebresne" created="Thu, 26 May 2016 10:10:23 +0000"  >&lt;p&gt;I think the proper fix is the added call to &lt;tt&gt;validateComposite&lt;/tt&gt;. With that, we shouldn&apos;t ever reach the assertion in &lt;tt&gt;ByteBufferUtil&lt;/tt&gt;, and so I&apos;d personally just left it as an assertion. &lt;/p&gt;</comment>
                            <comment id="15303420" author="lerh low" created="Fri, 27 May 2016 03:44:27 +0000"  >&lt;p&gt;Hey Branimir and Sylvain, thanks for reviewing. I&apos;ve updated the patch and re-ran the tests. &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;overloadBuffer&lt;/tt&gt;: I re-read the Code style documentation, I&apos;ve made changes to the braces and moved the comment away so the line isn&apos;t overly long, let me know if there are any more format changes required.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;assertInvalidThrow&lt;/tt&gt;: Didn&apos;t realise this method existed, updated the tests. &lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ByteBufferUtil&lt;/tt&gt;: I&apos;ve updated it to throw an IllegalArgumentException. I wasn&apos;t certain if it could be reached via another way (I&apos;m not familiar with the code base, naively I assume no) but I guess the idea was that if it did, at least the node will not see the other node as down forever after that until restart. Let me know if you feel strongly to leave it as assert. &lt;/p&gt;

&lt;p&gt;I also did try this on C* 3.5, it doesn&apos;t suffer from the same problem as 2.1, which I guess is due to the big revamp of the storage engine &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15303715" author="slebresne" created="Fri, 27 May 2016 07:40:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;but I guess the idea was that if it did, at least the node will not see the other node as down forever after that until restart&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But my point is, are you sure that is the case? I mean, is there some place where we catch &lt;tt&gt;IllegalArgumentException&lt;/tt&gt; and not &lt;tt&gt;AssertionError&lt;/tt&gt; so that which exception is thrown makes a difference? If there is, then maybe the right fix is to properly catch all exceptions at that particular place.&lt;/p&gt;</comment>
                            <comment id="15303737" author="lerh low" created="Fri, 27 May 2016 08:11:45 +0000"  >&lt;p&gt;That makes sense. There is indeed a place in &lt;tt&gt;writeConnected&lt;/tt&gt; in &lt;tt&gt;OutboundTCPConnection&lt;/tt&gt; catching Exception. I&apos;ve updated the patch to make that  catch Throwable since an AssertionError extends Error, and the asserts will just have a nicer message. &lt;/p&gt;
</comment>
                            <comment id="15303754" author="blambov" created="Fri, 27 May 2016 08:35:34 +0000"  >&lt;p&gt;Code LGTM. Uploaded for testing:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11882-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1 branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11882-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11882-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Could you make a patch for 2.2 as well (&lt;tt&gt;SelectStatement.java&lt;/tt&gt; has some incompatible changes)? And possibly a test that makes sure this is fine in 3.0+?&lt;/p&gt;</comment>
                            <comment id="15303853" author="slebresne" created="Fri, 27 May 2016 09:59:12 +0000"  >&lt;p&gt;Sorry for being slightly annoying, but catching &lt;tt&gt;Throwable&lt;/tt&gt; in &lt;tt&gt;writeConnected&lt;/tt&gt; is imo right, but it means we can catch stuffs like &lt;tt&gt;OutOfMemoryException&lt;/tt&gt; for which we kind of want to let the JVM die. So basically, we should call &lt;tt&gt;JVMStabilityInspector.inspectThrowable()&lt;/tt&gt; at the beginning of the &lt;tt&gt;catch&lt;/tt&gt; clause. We probably always should have done that in fact really, so 3.0 should probably get that part (and yes, the storage engine revamp is why you can know have larger than 64k values in clustering). &lt;/p&gt;</comment>
                            <comment id="15306355" author="lerh low" created="Mon, 30 May 2016 07:45:13 +0000"  >&lt;p&gt;Sylvain, it&apos;s not annoying, I agree with you on that. I&apos;ve changed it.&lt;/p&gt;

&lt;p&gt;Branimir, I&apos;ve attached the 2 patches again (updated). I&apos;ve put in the check for the JVM and moved the Insert tests in the 2.1 patch to a new &lt;tt&gt;InsertTest&lt;/tt&gt; class because they really aren&apos;t Selects. I&apos;ve also removed the &lt;tt&gt;overloadBuffer&lt;/tt&gt; method and followed the idea of using just a static &lt;tt&gt;TOO_BIG&lt;/tt&gt; variable that were present in 2.2 and 3, that way we don&apos;t need an extra method.&lt;/p&gt;

&lt;p&gt;I did retry this on 3 because the tests I ported over doesn&apos;t work on Inserts into CK with values larger than 64k. Using trunk, if I attempt (cqlsh) to run an insert query that with a CK that is larger than 64k, it actually works. I can even select it afterwards and it returns the inserted record well, so I mistakenly thought it worked fine on 3. But if I restart Cassandra, it will never succeed in starting up:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Caused by: java.lang.AssertionError: 131082
	at org.apache.cassandra.utils.ByteBufferUtil.writeWithShortLength(ByteBufferUtil.java:308) ~[main/:na]
	at org.apache.cassandra.io.sstable.metadata.StatsMetadata$StatsMetadataSerializer.serialize(StatsMetadata.java:286) ~[main/:na]
	at org.apache.cassandra.io.sstable.metadata.StatsMetadata$StatsMetadataSerializer.serialize(StatsMetadata.java:235) ~[main/:na]
	at org.apache.cassandra.io.sstable.metadata.MetadataSerializer.serialize(MetadataSerializer.java:75) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.big.BigTableWriter.writeMetadata(BigTableWriter.java:378) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.big.BigTableWriter.access$300(BigTableWriter.java:51) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.big.BigTableWriter$TransactionalProxy.doPrepare(BigTableWriter.java:342) ~[main/:na]
	at org.apache.cassandra.utils.concurrent.Transactional$AbstractTransactional.prepareToCommit(Transactional.java:173) ~[main/:na]
	at org.apache.cassandra.io.sstable.format.SSTableWriter.prepareToCommit(SSTableWriter.java:280) ~[main/:na]
	at org.apache.cassandra.io.sstable.SimpleSSTableMultiWriter.prepareToCommit(SimpleSSTableMultiWriter.java:101) ~[main/:na]
	at org.apache.cassandra.db.ColumnFamilyStore$Flush.flushMemtable(ColumnFamilyStore.java:1145) ~[main/:na]
	at org.apache.cassandra.db.ColumnFamilyStore$Flush.run(ColumnFamilyStore.java:1095) ~[main/:na]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_40]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[na:1.8.0_40]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) ~[na:1.8.0_40]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It can also be reproduced by doing the INSERT with a CK having a value larger than 64k, and then calling &lt;tt&gt;nodetool flush&lt;/tt&gt;. It looks like because writing &lt;tt&gt;StatsMetadata&lt;/tt&gt; while flushing Memtables it still calls &lt;tt&gt;writeWithShortLength&lt;/tt&gt;. I&apos;ll test with changing it to &lt;tt&gt;writeWithLength&lt;/tt&gt;. &lt;/p&gt;</comment>
                            <comment id="15307368" author="lerh low" created="Tue, 31 May 2016 07:38:16 +0000"  >&lt;p&gt;That is not a good idea - even if I could get it to work in this version by serializing and deserializing with more bytes than before, it will break backwards compatibility - old SSTables that have been serialized with &lt;tt&gt;writeWithShortLength&lt;/tt&gt; will not be able to be deserialized.&lt;/p&gt;

&lt;p&gt;Given that it may just be worthwhile to sanitize the input as before to prevent users from inserting a Clustering Key larger than 64k, also because even if the underlying storage structure allowed for it, it&apos;s still a pretty big size to be using for Clustering key. I&apos;m also thinking that if someone did insert a CK at the moment larger than 64k, it will keep working until the Memtable is flushed (either by it getting full or C* restarting and the CommitLogs replaying) at which point AssertionErrors are thrown. If C* restarts this way, it will never succeed in starting up (I had to delete the commitlogs folder). Any thoughts? &lt;/p&gt;</comment>
                            <comment id="15307401" author="lerh low" created="Tue, 31 May 2016 08:05:43 +0000"  >&lt;p&gt;I&apos;ve just included the patch with the input sanitization for now for 3.X (I based it off trunk). &lt;/p&gt;</comment>
                            <comment id="15307458" author="blambov" created="Tue, 31 May 2016 08:50:02 +0000"  >&lt;p&gt;Uploaded for testing:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11882-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1 branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11882-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11882-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11882-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11882-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11882-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11882-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11882-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11882-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/11882&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11882-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-11882-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15307510" author="slebresne" created="Tue, 31 May 2016 09:46:15 +0000"  >&lt;p&gt;We don&apos;t want to add such limitation in 3.0. The fact that don&apos;t have a 64K limit for the clustering columns value is a feature in 3.0, not a bug, and we don&apos;t want to artificially add it back. The only thing that 3.0 might need is the change to &lt;tt&gt;OutboundTcpConnection&lt;/tt&gt;, but as far as I can tell, that&apos;s about it.&lt;/p&gt;</comment>
                            <comment id="15307615" author="blambov" created="Tue, 31 May 2016 11:52:37 +0000"  >&lt;p&gt;Sylvain, the 64k+ keys currently &lt;em&gt;do not&lt;/em&gt; work in 3.x. They are not always serialized properly. We should find a way to fix the problem and make sure they are properly supported, but not as part of this ticket.&lt;/p&gt;

&lt;p&gt;While they are not working, it&apos;s best to validate and error out early rather than accept the writes and let the node fail badly on flush and commit log recovery, thus I &lt;em&gt;would&lt;/em&gt; include the validation in the 3.x patch.&lt;/p&gt;</comment>
                            <comment id="15309882" author="slebresne" created="Wed, 1 Jun 2016 07:53:26 +0000"  >&lt;p&gt;I&apos;d love more details on why it doesn&apos;t work on 3.0, and in particular what &quot;not always&quot; means. But if it doesn&apos;t, it&apos;s a bug (by opposition to 2.1/2.2 where it&apos;s a genuine limitation of the underlying format) and I&apos;d rather we start by checking if it&apos;s not an easy fix before rejecting queries, because I suspect we&apos;ll just end up forgetting about it and let it exist longer that it has to be. I&apos;m happy to create a separate ticket for that, to be assigned on that ticket and to look at it ASAP. But I&apos;m not happy shoving it under the rug without at least having looked at it.&lt;/p&gt;</comment>
                            <comment id="15310074" author="blambov" created="Wed, 1 Jun 2016 10:10:02 +0000"  >&lt;p&gt;From &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11882?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel&amp;amp;focusedCommentId=15306355#comment-15306355&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;the comments above&lt;/a&gt; I understand the fix will need a change in &lt;tt&gt;StatsMetadata&lt;/tt&gt; format, which could require major version change or would otherwise be involved enough to warrant a separate ticket.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lerh+Low&quot; class=&quot;user-hover&quot; rel=&quot;Lerh Low&quot;&gt;Lerh Low&lt;/a&gt;, could you create a new issue explaining what goes wrong with 64k+ keys in 3.0+ and assign it to Sylvain?&lt;/p&gt;

&lt;p&gt;I restarted the tests as something went wrong with half of them yesterday.&lt;/p&gt;</comment>
                            <comment id="15310106" author="slebresne" created="Wed, 1 Jun 2016 10:41:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;From the comments above I understand the fix will need a change in StatsMetadata format, which could require major version change or would otherwise be involved enough to warrant a separate ticket.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hum, somehow missed that comment, sorry. I guess that make sense, but this only limit each clustering column value to be &amp;lt;= 64k, while the patch currently limit the total size of all clustering values to be &amp;lt;= 64k. I guess if we don&apos;t forget to create a ticket to fix the sstable metadata (which you can indeed feel free to assign to me), then I guess I&apos;m fine refusing larger than 64k values for clustering columns for now, as long as we don&apos;t limit the &lt;tt&gt;Clustering&lt;/tt&gt; as a whole.&lt;/p&gt;</comment>
                            <comment id="15311554" author="lerh low" created="Thu, 2 Jun 2016 01:32:10 +0000"  >&lt;p&gt;Branimir &amp;amp; Sylvian,&lt;/p&gt;

&lt;p&gt;Thanks for the reviews so far. I was under the impression that &lt;tt&gt;Clustering&lt;/tt&gt; itself is already a clustering column, good catch. I&apos;ve retraced through the code path and I&apos;ve updated the patch so that it only refuses larger than 64k values for clustering columns (i.e an INSERT with ckey1 = 32k and ckey2 = 32k will work, and memtable flushing still works in that case too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;). &lt;/p&gt;

&lt;p&gt;I&apos;ve created the other issue here: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11943&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-11943&lt;/a&gt;. I don&apos;t think I have permissions to assign it to Sylvain, feel free to let me know if there is anything unclear with the setup etc. &lt;/p&gt;


</comment>
                            <comment id="15331435" author="blambov" created="Wed, 15 Jun 2016 09:23:05 +0000"  >&lt;p&gt;Updated the branches above with the latest version. Tests are now passing (to the extent that their respective base version are) and I&apos;m happy with the code.&lt;/p&gt;

&lt;p&gt;Marking ready to commit.&lt;/p&gt;</comment>
                            <comment id="15346109" author="slebresne" created="Thu, 23 Jun 2016 09:07:41 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13004584">CASSANDRA-12633</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13004584">CASSANDRA-12633</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12807069" name="11882-2.1.txt" size="9094" author="Lerh Low" created="Tue, 31 May 2016 08:05:00 +0000"/>
                            <attachment id="12807070" name="11882-2.2.txt" size="8320" author="Lerh Low" created="Tue, 31 May 2016 08:05:00 +0000"/>
                            <attachment id="12807586" name="11882-3.X.txt" size="11025" author="Lerh Low" created="Thu, 2 Jun 2016 01:26:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[Lerh Low]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yelz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332167">2.1.x</customfieldvalue>
    <customfieldvalue id="12332360">2.2.x</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blambov</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>