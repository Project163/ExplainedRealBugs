<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:24:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-17619] Expired snapshots of dropped tables are not removed after node restart</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-17619</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Expired TTL snapshots from a dropped table are only removed if the node is not restarted after the table is dropped.&lt;/p&gt;

&lt;p&gt;The reason for this is because &lt;tt&gt;SnapshotManager&lt;/tt&gt; is using the old implementation of &lt;tt&gt;listsnapshots&lt;/tt&gt; to load snapshots in memory during node startup, before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16843&quot; title=&quot;List snapshots of dropped tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16843&quot;&gt;&lt;del&gt;CASSANDRA-16843&lt;/del&gt;&lt;/a&gt; is fixed so it doesn&apos;t keep track of snapshots of dropped tables.&lt;/p&gt;

&lt;p&gt;We should make &lt;tt&gt;SnapshotManager&lt;/tt&gt; use the new implementation to load snapshots of dropped tables in memory, what ensures they will be removed when expired.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13444197">CASSANDRA-17619</key>
            <summary>Expired snapshots of dropped tables are not removed after node restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="paulo">Paulo Motta</assignee>
                                    <reporter username="paulo">Paulo Motta</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 May 2022 15:22:38 +0000</created>
                <updated>Tue, 12 Sep 2023 13:02:45 +0000</updated>
                            <resolved>Sun, 29 May 2022 19:45:43 +0000</resolved>
                                        <fixVersion>4.1-alpha1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                    <fixVersion>5.0-alpha1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                    <component>Local/Snapshots</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7800">2h 10m</timespent>
                                <comments>
                            <comment id="17534412" author="paulo" created="Tue, 10 May 2022 15:32:00 +0000"  >&lt;p&gt;This was working correctly in the initial implementation of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16843&quot; title=&quot;List snapshots of dropped tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16843&quot;&gt;&lt;del&gt;CASSANDRA-16843&lt;/del&gt;&lt;/a&gt;, but ended up getting removed when I simplified the patch in the final review pass.&lt;/p&gt;

&lt;p&gt;I added a few regression tests &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/dd10697ecdd234ddbbbbe032fc076f36787c9197&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;on this commit&lt;/a&gt; reproducing the issue with both auto_snapshots and manual snapshots.&lt;/p&gt;

&lt;p&gt;The fix is straightforward: just use the new &lt;tt&gt;SnapshotLoader&lt;/tt&gt; implementation when doing the initial snapshot load on &lt;tt&gt;SnapshotManager&lt;/tt&gt;, which loads snapshots of dropped tables correctly (&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/6731ee21b79b2345274307e2ba8800f50eb36a98&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="17534420" author="paulo" created="Tue, 10 May 2022 15:39:31 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/1701/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1 CI&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/1702/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk CI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; mind taking a look?&lt;/p&gt;</comment>
                            <comment id="17534557" author="smiklosovic" created="Tue, 10 May 2022 19:48:04 +0000"  >&lt;p&gt;Thanks Paulo, I did the review. Waiting for your feedback.&lt;/p&gt;</comment>
                            <comment id="17536341" author="paulo" created="Thu, 12 May 2022 21:05:26 +0000"  >&lt;p&gt;Addressed review comments on github &lt;a href=&quot;https://github.com/apache/cassandra/pull/1615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt; and fixed two extra nits found during testing:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1615/commits/333f813f6872b87f7e0f79f71a4f9688a9cc3193&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fix log&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1615/commits/c2d7c679c3492b66d41f8c60ce29d38efdf1c88e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Add verbose log to trace&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is what the output of nodetool listsnapshots looks like after doing the following operations:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;global snapshot of all keyspaces&lt;/li&gt;
	&lt;li&gt;drop keyspace ks2 with auto_snapshot_ttl unset&lt;/li&gt;
	&lt;li&gt;drop keyspace ks1 with auto_snapshot_ttl=1 minute&lt;/li&gt;
	&lt;li&gt;nodetool snapshots&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;grep -v &quot;all_keyspaces_snapshot&quot; snapshot.txt
Snapshot Details:
Snapshot name                   Keyspace name      Column family name             True size Size on disk Creation time            Expiration time
dropped-1652386867075-my_table  ks2                my_table                       5.81 KiB  5.81 KiB     2022-05-12T20:21:07.075Z
dropped-1652388565491-my_table  ks                 my_table                       5.83 KiB  5.83 KiB     2022-05-12T20:49:25.491Z 2022-05-12T20:50:25.491Z
dropped-1652388565604-my_table2 ks                 my_table2                      5.83 KiB  5.83 KiB     2022-05-12T20:49:25.604Z 2022-05-12T20:50:25.604Z
dropped-1652386867016-my_table2 ks2                my_table2                      5.81 KiB  5.81 KiB     2022-05-12T20:21:07.016Z

Total TrueDiskSpaceUsed: 0 byte
pmottagomes@C02FD3GTMD6R Documents %
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;After this I restarted the node and verified the snapshot from ks1 was removed after 1 minute:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Snapshot Details:
Snapshot name                   Keyspace name      Column family name             True size Size on disk Creation time            Expiration time
dropped-1652386867075-my_table  ks2                my_table                       5.81 KiB  5.81 KiB     2022-05-12T20:21:07.075Z
dropped-1652386867016-my_table2 ks2                my_table2                      5.81 KiB  5.81 KiB     2022-05-12T20:21:07.016Z

Total TrueDiskSpaceUsed: 0 bytes
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is the debug logs of the manual test above:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [main] 2022-05-12 17:51:07,265 SnapshotManager.java:119 - Adding snapshots: system:peers:37f71aca-7dc2-383b-a706-72528af04d4f:all_keyspaces_snapshot, system:transferred_ranges:6cad20f7-d4f5-3af2-b6e2-0da33c6c1f83:all_keyspaces_snapshot, system_traces:sessions:c5e99f16-8677-3914-b17e-960613512345:all_keyspaces_snapshot, system_schema:dropped_columns:5e7583b5-f3f4-3af1-9a39-b7e1d6f5f11f:all_keyspaces_snapshot, system_auth:role_members:0ecdaa87-f8fb-3e60-88d1-74fb36fe5c0d:all_keyspaces_snapshot, ks:my_table2:74a02c00-d230-11ec-b12d-d9d82874084f:dropped-1652388565604-my_table2, system:repairs:a3d277d1-cfaf-36f5-a2a7-38d5eea9ad6a:all_keyspaces_snapshot, ks2:my_table2:846d1fd0-d230-11ec-b12d-d9d82874084f:all_keyspaces_snapshot, system:IndexInfo:9f5c6374-d485-3229-9a0a-5094af9ad1e3:all_keyspaces_snapshot, system_schema:functions:96489b79-80be-3e14-a701-66a0b9159450:all_keyspaces_snapshot, system:top_partitions:7e5a361c-317c-351f-b15f-ffd8afd3dd4b:all_keyspaces_snapshot, system:peers_v2:c4325fbb-8e5e-3baf-bd07-0f9250ed818e:all_keyspaces_snapshot, system_distributed:partition_denylist:d6123acc-8649-3496-9d4e-f3fe39a6018b:all_keyspaces_snapshot, system_schema:views:9786ac1c-dd58-3201-a7cd-ad556410c985:all_keyspaces_snapshot, system_auth:resource_role_permissons_index:5f2fbdad-91f1-3946-bd25-d5da3a5c35ec:all_keyspaces_snapshot, system_schema:columns:24101c25-a2ae-3af7-87c1-b40ee1aca33f:all_keyspaces_snapshot, system:transferred_ranges_v2:1ff78f1a-7df1-3a2a-a998-6f4932270af5:all_keyspaces_snapshot, system:prepared_statements:18a9c257-6a0c-3841-ba71-8cd529849fef:all_keyspaces_snapshot, system:local:7ad54392-bcdd-35a6-8417-4e047860b377:all_keyspaces_snapshot, system_schema:types:5a8b1ca8-6602-3f77-a045-9273d308917a:all_keyspaces_snapshot, ks2:my_table:8eada2d0-d230-11ec-b12d-d9d82874084f:dropped-1652386867075-my_table, system:size_estimates:618f817b-005f-3678-b8a4-53f3930b8e86:all_keyspaces_snapshot, ks2:my_table:8eada2d0-d230-11ec-b12d-d9d82874084f:all_keyspaces_snapshot, system:peer_events:59dfeaea-8db2-3341-91ef-109974d81484:all_keyspaces_snapshot, system_auth:roles:5bc52802-de25-35ed-aeab-188eecebb090:all_keyspaces_snapshot, system_schema:indexes:0feb57ac-311f-382f-ba6d-9024d305702f:all_keyspaces_snapshot, system_schema:keyspaces:abac5682-dea6-31c5-b535-b3d6cffd0fb6:all_keyspaces_snapshot, system:table_estimates:176c39cd-b93d-33a5-a218-8eb06a56f66e:all_keyspaces_snapshot, system_auth:network_permissions:d46780c2-2f1c-3db9-b4c1-b8d9fbc0cc23:all_keyspaces_snapshot, ks:my_table:704a1850-d230-11ec-b12d-d9d82874084f:dropped-1652388565491-my_table, system:available_ranges:c539fcab-d65a-31d1-8133-d25605643ee3:all_keyspaces_snapshot, ks:my_table:704a1850-d230-11ec-b12d-d9d82874084f:all_keyspaces_snapshot, system_schema:aggregates:924c5587-2e3a-345b-b10c-12f37c1ba895:all_keyspaces_snapshot, system:view_builds_in_progress:6c22df66-c3bd-3df6-b74d-21179c6a9fe9:all_keyspaces_snapshot, system:batches:919a4bc5-7a33-3573-b03e-13fc3f68b465:all_keyspaces_snapshot, system:available_ranges_v2:4224a088-2ac9-3d0c-889d-fbb5f0facda0:all_keyspaces_snapshot, system_distributed:view_build_status:5582b59f-8e4e-35e1-b913-3acada51eb04:all_keyspaces_snapshot, system:peer_events_v2:0e65065f-e401-38ed-9507-b9213fae8d11:all_keyspaces_snapshot, system:paxos:b7b7f0c2-fd0a-3410-8c05-3ef614bb7c2d:all_keyspaces_snapshot, system:paxos_repair_history:ecb86667-40b2-3316-bb91-e612c8047457:all_keyspaces_snapshot, system:built_views:4b3c50a9-ea87-3d76-9101-6dbc9c38494a:all_keyspaces_snapshot, system_traces:events:8826e8e9-e16a-3728-8753-3bc1fc713c25:all_keyspaces_snapshot, system:sstable_activity:5a1ff267-ace0-3f12-8563-cfae6103c65e:all_keyspaces_snapshot, ks2:my_table2:846d1fd0-d230-11ec-b12d-d9d82874084f:dropped-1652386867016-my_table2, system_schema:triggers:4df70b66-6b05-3251-95a1-32b54005fd48:all_keyspaces_snapshot, system_distributed:repair_history:759fffad-624b-3181-80ee-fa9a52d1f627:all_keyspaces_snapshot, system_distributed:parent_repair_history:deabd734-b99d-3b9c-92e5-fd92eb5abf14:all_keyspaces_snapshot, system_schema:tables:afddfb9d-bc1e-3068-8056-eed6c302ba09:all_keyspaces_snapshot, system:compaction_history:b4dbb7b4-dc49-3fb5-b3bf-ce6e434832ca:all_keyspaces_snapshot, system:sstable_activity_v2:62efe31f-3be8-310c-8d29-8963439c1288:all_keyspaces_snapshot, system_auth:role_permissions:3afbe79f-2194-31a7-add7-f5ab90d8ec9c:all_keyspaces_snapshot, ks:my_table2:74a02c00-d230-11ec-b12d-d9d82874084f:all_keyspaces_snapshot.
DEBUG [main] 2022-05-12 17:51:07,266 SnapshotManager.java:104 - Adding expiring snapshot TableSnapshot{keyspaceName=&apos;ks&apos;, tableName=&apos;my_table2&apos;, tableId=74a02c00-d230-11ec-b12d-d9d82874084f, tag=&apos;dropped-1652388565604-my_table2&apos;, createdAt=2022-05-12T20:49:25.604Z, expiresAt=2022-05-12T20:50:25.604Z, snapshotDirs=[/Users/pmottagomes/.ccm/test/node1/data0/ks/my_table2-74a02c00d23011ecb12dd9d82874084f/snapshots/dropped-1652388565604-my_table2]}
DEBUG [main] 2022-05-12 17:51:07,266 SnapshotManager.java:104 - Adding expiring snapshot TableSnapshot{keyspaceName=&apos;ks&apos;, tableName=&apos;my_table&apos;, tableId=704a1850-d230-11ec-b12d-d9d82874084f, tag=&apos;dropped-1652388565491-my_table&apos;, createdAt=2022-05-12T20:49:25.491Z, expiresAt=2022-05-12T20:50:25.491Z, snapshotDirs=[/Users/pmottagomes/.ccm/test/node1/data0/ks/my_table-704a1850d23011ecb12dd9d82874084f/snapshots/dropped-1652388565491-my_table]}
INFO  [main] 2022-05-12 17:51:07,266 SnapshotManager.java:128 - Scheduling expired snapshot cleanup with initialDelaySeconds={} and cleanupPeriodSeconds={}
DEBUG [SnapshotCleanup:1] 2022-05-12 17:51:12,269 SnapshotManager.java:141 - Removing expired snapshot TableSnapshot{keyspaceName=&apos;ks&apos;, tableName=&apos;my_table&apos;, tableId=704a1850-d230-11ec-b12d-d9d82874084f, tag=&apos;dropped-1652388565491-my_table&apos;, createdAt=2022-05-12T20:49:25.491Z, expiresAt=2022-05-12T20:50:25.491Z, snapshotDirs=[/Users/pmottagomes/.ccm/test/node1/data0/ks/my_table-704a1850d23011ecb12dd9d82874084f/snapshots/dropped-1652388565491-my_table]}.
DEBUG [SnapshotCleanup:1] 2022-05-12 17:51:12,274 SnapshotManager.java:141 - Removing expired snapshot TableSnapshot{keyspaceName=&apos;ks&apos;, tableName=&apos;my_table2&apos;, tableId=74a02c00-d230-11ec-b12d-d9d82874084f, tag=&apos;dropped-1652388565604-my_table2&apos;, createdAt=2022-05-12T20:49:25.604Z, expiresAt=2022-05-12T20:50:25.604Z, snapshotDirs=[/Users/pmottagomes/.ccm/test/node1/data0/ks/my_table2-74a02c00d23011ecb12dd9d82874084f/snapshots/dropped-1652388565604-my_table2]}.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I will create another ticket to fix the order items are displayed in nodetool listsnapshots. Also we should probably expose nodetool listsnapshots output via a virtual table.&lt;/p&gt;</comment>
                            <comment id="17536348" author="paulo" created="Thu, 12 May 2022 21:20:25 +0000"  >&lt;p&gt;Previous CI did not complete due to OOM.&lt;/p&gt;

&lt;p&gt;Resubmitted new CI on rebased patch:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/tree/CASSANDRA-17619-4.1-rebased&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-17619-4.1-rebased&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/1704/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1 CI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

</comment>
                            <comment id="17536851" author="smiklosovic" created="Fri, 13 May 2022 19:21:26 +0000"  >&lt;p&gt;&lt;del&gt;I reviewed again, I have one minor issue / question otherwise when addressed / resolved I am +1. Thanks a lot!&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;+1. I overlooked the last component of the logs where snapshot tag is.&lt;/p&gt;</comment>
                            <comment id="17540100" author="paulo" created="Fri, 20 May 2022 12:20:28 +0000"  >&lt;p&gt;Hi&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt;&#160;, do you mind committing this? I don&#8217;t have access to a computer until next week.&lt;/p&gt;

&lt;p&gt;The latest posted branch is squashed and prepared for commit.&lt;/p&gt;

&lt;p&gt;Thanks&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;==&lt;/p&gt;



&lt;p&gt;Sent from Jira Mobile&lt;/p&gt;</comment>
                            <comment id="17540189" author="smiklosovic" created="Fri, 20 May 2022 15:42:28 +0000"  >&lt;p&gt;Yes, I will commit it. No worries.&lt;/p&gt;</comment>
                            <comment id="17540479" author="smiklosovic" created="Sat, 21 May 2022 18:11:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulo&quot; class=&quot;user-hover&quot; rel=&quot;paulo&quot;&gt;paulo&lt;/a&gt; I ve run one more circle job for 4.1 with rebased stuff and this is what I got. Check the first failed test there. It can not load snapshots as there is &quot;no file found exception&quot;. I am not completely sure about the anatomy of that test yet but this is quite weird that we are getting this exception.&lt;/p&gt;

&lt;p&gt;I think it is just flaky as locally it just went fine.&lt;/p&gt;

&lt;p&gt;It seems like we were about to load the snapshots and it was walking the tree but all of sudden these files were deleted under its hands.&lt;/p&gt;

&lt;p&gt;Maybe it is caused by the node starting and compacting some sstables as part of the start (yeah that might happen) and it just clashes with snapshot loader doing its job.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/976/workflows/1fd26858-c5ad-44f3-bab3-2318da3bd729/jobs/4226/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/976/workflows/1fd26858-c5ad-44f3-bab3-2318da3bd729/jobs/4226/tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17540487" author="smiklosovic" created="Sat, 21 May 2022 19:24:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulo&quot; class=&quot;user-hover&quot; rel=&quot;paulo&quot;&gt;paulo&lt;/a&gt;&#160; I tried to fix it here&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/commit/d04390a64b4d4d986804282fb82d60578919cad4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/instaclustr/cassandra/commit/d04390a64b4d4d986804282fb82d60578919cad4&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I run repeated test here: &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/977/workflows/b6399095-7ce6-435c-aeaa-3dac55f287a7/jobs/4231/parallel-runs/0?filterBy=ALL&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/977/workflows/b6399095-7ce6-435c-aeaa-3dac55f287a7/jobs/4231/parallel-runs/0?filterBy=ALL&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17540644" author="paulo" created="Sun, 22 May 2022 17:59:47 +0000"  >&lt;p&gt;Nice catch - it seems this also failed on ASF CI (&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/1704/testReport/junit/org.apache.cassandra.distributed.test/PreviewRepairCoordinatorNeighbourDownTest/validationParticipentCrashesAndComesBack_SEQUENTIAL_true__2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PreviewRepairCoordinatorNeighbourDownTest.validationParticipentCrashesAndComesBack&lt;/a&gt;). &lt;/p&gt;

&lt;p&gt;The fix looks good to me.&lt;/p&gt;

&lt;p&gt;Submitted one full run to check if failures are fixed:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/1729/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/1729/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17540815" author="smiklosovic" created="Mon, 23 May 2022 07:56:09 +0000"  >&lt;p&gt;Seems to be fixed. I will merge it when 4.1-alpha1 is released.&lt;/p&gt;</comment>
                            <comment id="17540873" author="brandon.williams" created="Mon, 23 May 2022 10:08:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;I will merge it when 4.1-alpha1 is released.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Just curious, why does the release gate committing here?&lt;/p&gt;</comment>
                            <comment id="17540879" author="smiklosovic" created="Mon, 23 May 2022 10:20:33 +0000"  >&lt;p&gt;Well ... because it is not fully out yet and Mick just tagged it by -tentative, if he still has some work to do related to releasing, I just do not want to mess with my stuff in the middle. He just tagged it, 4.1-alpha1 is not a branch, right?&lt;/p&gt;</comment>
                            <comment id="17540885" author="brandon.williams" created="Mon, 23 May 2022 10:34:51 +0000"  >&lt;p&gt;You shouldn&apos;t worry about any of that, unless you&apos;re trying to get something &lt;em&gt;into&lt;/em&gt; alpha1.&lt;/p&gt;</comment>
                            <comment id="17540921" author="smiklosovic" created="Mon, 23 May 2022 12:18:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulo&quot; class=&quot;user-hover&quot; rel=&quot;paulo&quot;&gt;paulo&lt;/a&gt; there is still this (1). There is one more case of this faulty comparision later in that method. Do not you have your IDEA set up in such a way that it will automatically hightlight this?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; subdir.getFileName().equals(Directories.BACKUPS_SUBDIR)
               ? FileVisitResult.SKIP_SUBTREE
               : FileVisitResult.CONTINUE;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I will fix it as part of this patch. It is very minor bug which will just scan backup dirs but they should not be.&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/pull/1595#discussion_r861730641&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/1595#discussion_r861730641&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17540922" author="paulo" created="Mon, 23 May 2022 12:21:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;I will fix it as part of this patch. It is very minor bug which will just scan backup dirs but they should not be.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sounds good, nice catch!&lt;/p&gt;</comment>
                            <comment id="17541838" author="smiklosovic" created="Wed, 25 May 2022 06:08:49 +0000"  >&lt;p&gt;I ve changed some tests as well, made it more solid, they were flaky a bit, i saw a circle which failed, I will wrap it following days, just busy.&lt;/p&gt;</comment>
                            <comment id="17543048" author="paulo" created="Fri, 27 May 2022 18:00:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;I ve changed some tests as well, made it more solid, they were flaky a bit, i saw a circle which failed, I will wrap it following days, just busy.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for the heads up. Can you give more details on what tests were flaky and why?&lt;/p&gt;

&lt;p&gt;It may be worth to multiplex the snapshot test suites to verify they&apos;re not flaky before committing.&lt;/p&gt;</comment>
                            <comment id="17543056" author="smiklosovic" created="Fri, 27 May 2022 18:36:18 +0000"  >&lt;p&gt;I run the tests like 50 times, the same one&lt;br/&gt;
&lt;a href=&quot;https://github.com/instaclustr/cassandra/commit/7017450d092f7a111239020fca5d7b76529239ee&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/instaclustr/cassandra/commit/7017450d092f7a111239020fca5d7b76529239ee&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Basically, some snapshot operation was done via nodetool and then it was asserting some state but it was not done yet / it was / was not in the output and it was throwing exceptions. I had to rewrite it like we are waiting for some state to happen.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13472915">CASSANDRA-17769</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[paulo]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 24 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z128fk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/a604c0d4defb50ffdf7f66c3ac372eb14f39ba3b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/a604c0d4defb50ffdf7f66c3ac372eb14f39ba3b&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;unit tests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>