<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:58:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10447] Stop TeeingAppender on shutdown hook</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10447</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Stefania discovered that tests that don&apos;t produce a lot of log output end up producing 0 debug output to files because the data is not flushed as part of the shutdown hook. I traced through and it looks like the shutdown hook doesn&apos;t actually invoke code that does anything useful. It shuts down an executor service in the logging context but doesn&apos;t call stop on any appenders.&lt;/p&gt;

&lt;p&gt;A hackish thing we can do is use a status listener to collect all the appenders and then stop them when the shutdown hook runs. Even adding a small delay to the shutdown hook (no code changes on our part) would in let the async appender flush in 90% of cases.&lt;/p&gt;

&lt;p&gt;We still need to fix it for test which uses a different config file and for which a small delay is not desirable.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12902544">CASSANDRA-10447</key>
            <summary>Stop TeeingAppender on shutdown hook</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aweisberg">Ariel Weisberg</assignee>
                                    <reporter username="aweisberg">Ariel Weisberg</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Oct 2015 23:37:22 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:54 +0000</updated>
                            <resolved>Wed, 14 Oct 2015 15:50:24 +0000</resolved>
                                        <fixVersion>3.0.0 rc2</fixVersion>
                                    <component>Legacy/Observability</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14944265" author="aweisberg" created="Mon, 5 Oct 2015 23:43:10 +0000"  >&lt;p&gt;Alternatively maybe SL4J has a path for this we should be hitting to have it shut things down gracefully?&lt;/p&gt;</comment>
                            <comment id="14945255" author="pauloricardomg" created="Tue, 6 Oct 2015 16:03:15 +0000"  >&lt;p&gt;The shutdown hook seems to be implemented correctly on &lt;a href=&quot;https://github.com/qos-ch/logback/blob/master/logback-core/src/main/java/ch/qos/logback/core/hook/DelayingShutdownHook.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DelayingShutdownHook&lt;/a&gt;, that calls &lt;tt&gt;ContextBase.stop()&lt;/tt&gt;. Even though the &lt;a href=&quot;https://github.com/qos-ch/logback/blob/master/logback-core/src/main/java/ch/qos/logback/core/ContextBase.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ContextBase&lt;/a&gt; &lt;tt&gt;stop()&lt;/tt&gt; implementation only shutdowns an executor service, it seems the &lt;a href=&quot;https://github.com/qos-ch/logback/blob/master/logback-classic/src/main/java/ch/qos/logback/classic/LoggerContext.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;LoggerContext&lt;/a&gt;, which overrides &lt;tt&gt;ContextBase.stop()&lt;/tt&gt;, closes all appenders when invoked by &lt;tt&gt;DelayingShutdownHook&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;In what situations is the problem occurring, is there an easy way to reproduce? Maybe shutdown hooks are never triggered during unit tests? We need first to clarify if this is specific to the test configuration or if it also happens in the production configuration too. I&apos;m happy to review and help with this.&lt;/p&gt;</comment>
                            <comment id="14945348" author="aweisberg" created="Tue, 6 Oct 2015 16:58:22 +0000"  >&lt;p&gt;Oh thanks Paulo, I didn&apos;t have the source for logbook classic loaded so I didn&apos;t see that LoggerContext overrides stop(). I was very confused.&lt;/p&gt;

&lt;p&gt;It&apos;s easy to reproduce. On trunk run &quot;ant test -Dtest.name=RoleOptionsTest&quot; and then look at the log file in build/test/logs. For me the log file is empty.&lt;/p&gt;

&lt;p&gt;It definitely happens in the test config and it&apos;s very obvious. Whether it happens in the production config is harder to suss out since the production config doesn&apos;t buffer heavily like the test config and drains as fast as it can. My suspicion is that it should have the same issue not stopping appenders.&lt;/p&gt;

&lt;p&gt;If you are free you are welcome to look at it. I am doing two code reviews, but I should be able to get to both for 3.0.0rc2.&lt;/p&gt;</comment>
                            <comment id="14953246" author="aweisberg" created="Mon, 12 Oct 2015 16:04:58 +0000"  >&lt;p&gt;Finally tracked this down. It&apos;s a problem specific to TeeingAppender so it only effects test code. TeeingAppender needs to implement stop() and then stop the Appenders it wraps.&lt;/p&gt;</comment>
                            <comment id="14953315" author="aweisberg" created="Mon, 12 Oct 2015 16:42:27 +0000"  >&lt;p&gt;Patch available. Tests are running. Change itself is almost a one liner.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/apache:cassandra-3.0...aweisberg:C-10447?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-C-10447-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-C-10447-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="14955456" author="pauloricardomg" created="Tue, 13 Oct 2015 18:49:29 +0000"  >&lt;p&gt;LGTM, seems there are no more blank logs on test artifacts. Marking as &quot;Ready to Commit&quot;.&lt;/p&gt;</comment>
                            <comment id="14957122" author="iamaleksey" created="Wed, 14 Oct 2015 15:50:17 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/0556fbfa595e07859f74f905779c42ee85575533&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;0556fbfa595e07859f74f905779c42ee85575533&lt;/a&gt; to 3.0 and merged with trunk, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mm2f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>pauloricardomg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>