<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:58:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10289] Fix cqlshlib tests</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10289</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The cqlsh tests in trunk haven&apos;t been running for a while:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/All_Jobs/job/trunk_cqlshlib/423/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/All_Jobs/job/trunk_cqlshlib/423/testReport/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This looks like the driver errors that happened because of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6717&quot; title=&quot;Modernize schema tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6717&quot;&gt;&lt;del&gt;CASSANDRA-6717&lt;/del&gt;&lt;/a&gt;. Not sure why it&apos;s happening now; the driver installation looks normal to me on those jobs. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mshuler&quot; class=&quot;user-hover&quot; rel=&quot;mshuler&quot;&gt;mshuler&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;There were also some changes to cqlsh itself that also broke the test harness, but I believe those are fixed here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/mambocab/cassandra/tree/fix-cqlsh-tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mambocab/cassandra/tree/fix-cqlsh-tests&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Once the tests are running successfully on CassCI, I&apos;ll test my patch and mark as patch available.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12862567">CASSANDRA-10289</key>
            <summary>Fix cqlshlib tests</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mambocab">Jim Witschey</assignee>
                                    <reporter username="mambocab">Jim Witschey</reporter>
                        <labels>
                            <label>cqlsh</label>
                    </labels>
                <created>Tue, 8 Sep 2015 22:03:17 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:57 +0000</updated>
                            <resolved>Fri, 2 Oct 2015 04:27:56 +0000</resolved>
                                        <fixVersion>2.2.3</fixVersion>
                    <fixVersion>3.0.0 rc2</fixVersion>
                                    <component>Legacy/Testing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14804429" author="mambocab" created="Thu, 17 Sep 2015 20:22:54 +0000"  >&lt;p&gt;I&apos;m attaching a patch that fixes the cqlshlib tests on trunk. There is one test that fails and that I&apos;m certain is incorrect behavior; I&apos;ll make another ticket for that and link it here. The changes I made to the test logic makes them pass, but may describe incorrect behavior. I&apos;ll need a reviewer to look through each test and help me differentiate bugs from new behavior.&lt;/p&gt;

&lt;p&gt;My work is on GitHub here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/mambocab/cassandra/tree/fix-cqlsh-tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/mambocab/cassandra/tree/fix-cqlsh-tests&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve been running the tests on CassCI here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/scratch_mambocab-fix_cqlsh/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/scratch_mambocab-fix_cqlsh/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14903184" author="philipthompson" created="Tue, 22 Sep 2015 18:43:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;stefania&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;, can one of you review?&lt;/p&gt;</comment>
                            <comment id="14933466" author="jbellis" created="Mon, 28 Sep 2015 15:43:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="14934745" author="stefania" created="Tue, 29 Sep 2015 06:59:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m attaching a patch that fixes the cqlshlib tests on trunk. There is one test that fails and that I&apos;m certain is incorrect behavior; I&apos;ll make another ticket for that and link it here. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I assume this is &lt;tt&gt;TestCqlshOutput.test_prompt&lt;/tt&gt; since it&apos;s the only one still failing? These tests are quite fast to run, I wonder if we should run them on every developer branch, perhaps by adding them to the dtest suite. We tend to test cqlsh via the dtests but some use cases would be easier to add to these tests, e.g. completion.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;ll need a reviewer to look through each test and help me differentiate bugs from new behavior.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The &apos;plumbing&apos; changes in &lt;em&gt;basecase.py&lt;/em&gt;, &lt;em&gt;cassconnect.py&lt;/em&gt; and &lt;em&gt;run_cqlsh.py&lt;/em&gt; are +1. &lt;/p&gt;

&lt;p&gt;The changes in &lt;em&gt;test_cql_parsing.py&lt;/em&gt; were required because of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9232&quot; title=&quot;&amp;quot;timestamp&amp;quot; is considered as a reserved keyword in cqlsh completion&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9232&quot;&gt;&lt;del&gt;CASSANDRA-9232&lt;/del&gt;&lt;/a&gt;, we had to drop the K_XXX rules because we reached the maximum python limit for regex named groups. So these too are +1.&lt;/p&gt;

&lt;p&gt;For the following tests instead, it looks like we have broken things and you probably need to revert the changes in this patch and either fix cqlsh or open a separate ticket.&lt;/p&gt;

&lt;p&gt;In &lt;em&gt;test_cqlsh_completion.py&lt;/em&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;test_complete_in_delete&lt;/tt&gt;: I don&apos;t think keyspaces are a valid completion after &lt;tt&gt;DELETE a [&lt;/tt&gt; and after &lt;tt&gt;DELETE FROM twenty_rows_composite_table USING TIMESTAMP 0 WHERE TOKEN(a) &amp;gt;=&lt;/tt&gt;. From a quick analysis of &lt;em&gt;cqlhandling.py&lt;/em&gt; I think it comes from &lt;tt&gt;&amp;lt;term&amp;gt;&lt;/tt&gt;, which picks up &lt;tt&gt;&amp;lt;functionName&amp;gt;&lt;/tt&gt;, which was changed to include &lt;tt&gt;ks.&lt;/tt&gt; by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7556&quot; title=&quot;Update cqlsh for UDFs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7556&quot;&gt;&lt;del&gt;CASSANDRA-7556&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;test_complete_in_drop_keyspace&lt;/tt&gt;: the &lt;tt&gt;;&lt;/tt&gt; after &lt;tt&gt;DROP KEYSPACE IF&lt;/tt&gt; is not valid.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;create_columnfamily_table_template&lt;/tt&gt;: the &lt;tt&gt;(&lt;/tt&gt; after &lt;tt&gt;CREATE ... IF&lt;/tt&gt; does not look valid to me.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In &lt;em&gt;test_cqlsh_output.py&lt;/em&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;test_numeric_output&lt;/tt&gt;: it looks weird that we get &lt;tt&gt;99999.99219&lt;/tt&gt; instead of  &lt;tt&gt;1e+05&lt;/tt&gt; but I think it&apos;s correct because of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9224&quot; title=&quot;Figure out a better default float precision rule for cqlsh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9224&quot;&gt;&lt;del&gt;CASSANDRA-9224&lt;/del&gt;&lt;/a&gt;, there are 5 digits to the left and so it tries to print 5 decimals, it&apos;s similar to &lt;tt&gt;test_float_formatting&lt;/tt&gt; in the dtests.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;test_timestamp_output&lt;/tt&gt;: we currently have timezone issues, see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10313&quot; title=&quot;cqlsh_tests.cqlsh_copy_tests.CqlshCopyTest.test_all_datatypes_read fails locally&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10313&quot;&gt;&lt;del&gt;CASSANDRA-10313&lt;/del&gt;&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10397&quot; title=&quot;Add local timezone support to cqlsh&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10397&quot;&gt;&lt;del&gt;CASSANDRA-10397&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;





</comment>
                            <comment id="14935633" author="mambocab" created="Tue, 29 Sep 2015 18:51:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; Thank you, this is exactly the kind of feedback I was hoping for. Yes, the prompt test was the failing one, and it&apos;s been fixed for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10369&quot; title=&quot;cqlsh prompt includes name of keyspace after failed `use` statement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10369&quot;&gt;&lt;del&gt;CASSANDRA-10369&lt;/del&gt;&lt;/a&gt;; my mistake for not linking earlier.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;These tests are quite fast to run, I wonder if we should run them on every developer branch, perhaps by adding them to the dtest suite. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree that running them on every dev branch is a good idea. However, I&apos;m not sure they belong in dtests:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;One reason they&apos;re so fast is because they reuse the same cluster for all the tests. This is possible in dtest but (I don&apos;t think) part it&apos;s of how we currently run them on CassCI. I don&apos;t know if it would be a problem to run the dtests this way on CassCI.&lt;/li&gt;
	&lt;li&gt;They also require access to cqlshlib internals, like the parser. I think this is probably out of scope for the dtests.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We&apos;re talking in TE about the best way to add this to the tests that run when developers push changes.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We tend to test cqlsh via the dtests but some use cases would be easier to add to these tests, e.g. completion.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree, and in general, there&apos;s a lot (for me in particular) to add to these tests.&lt;/p&gt;

&lt;p&gt;I&apos;ll revert the changes you mentioned and file new tickets for them.&lt;/p&gt;</comment>
                            <comment id="14935662" author="mambocab" created="Tue, 29 Sep 2015 19:10:37 +0000"  >&lt;p&gt;The fixed tests are here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...mambocab:fix-cqlsh-tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...mambocab:fix-cqlsh-tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14936091" author="stefania" created="Tue, 29 Sep 2015 23:27:18 +0000"  >&lt;p&gt;Thanks, the patch looks good now. Only one more thing, rather than displaying &lt;tt&gt;99999.99219&lt;/tt&gt; we should try and go back to &lt;tt&gt;1e+05&lt;/tt&gt; by changing the input number from &lt;tt&gt;99999.99&lt;/tt&gt; to &lt;tt&gt;99999.999&lt;/tt&gt; in &lt;em&gt;test_keyspace_init.cql&lt;/em&gt; . The final 219 is a rounding error, the precision of 5 decimal places is too high in this case, so I am worried the test could break in future. I should have thought about this yesterday really, sorry about the delay.&lt;/p&gt;

&lt;p&gt;I&apos;ll obviously leave it up to you guys to decide how to best run these tests on developers&apos; branches, thanks for picking up my suggestion. &lt;/p&gt;</comment>
                            <comment id="14937012" author="mambocab" created="Wed, 30 Sep 2015 15:34:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;I should have thought about this yesterday really, sorry about the delay.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not a problem, that&apos;s what iteration is for. I&apos;ve made the changes you requested (see my git branch) and will submit a patch now. The tests are running on CassCI:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/scratch_mambocab-fix_cqlsh/18/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/scratch_mambocab-fix_cqlsh/18/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14939112" author="stefania" created="Thu, 1 Oct 2015 00:36:55 +0000"  >&lt;p&gt;It looks excellent, +1, thanks!&lt;/p&gt;</comment>
                            <comment id="14939150" author="stefania" created="Thu, 1 Oct 2015 01:35:54 +0000"  >&lt;p&gt;It seems on CASSCI we only run these tests on trunk at the moment. However some of these issues probably also affect 2.1+. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mambocab&quot; class=&quot;user-hover&quot; rel=&quot;mambocab&quot;&gt;mambocab&lt;/a&gt; do you think we should set-up jobs and backport the patch to 2.1+?&lt;/p&gt;</comment>
                            <comment id="14940383" author="mambocab" created="Thu, 1 Oct 2015 20:47:45 +0000"  >&lt;p&gt;The diff I posted applies cleanly to the cassandra-2.2 and cassandra-3.0 branches. cassandra-3.0 fails with the same errors as on trunk, and cassandra-2.2 fails with a couple more because of bug fixes and features that only exist in 3.0+.&lt;/p&gt;

&lt;p&gt;However, the changes don&apos;t apply cleanly to 2.1. I&apos;ve filed another ticket (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10432&quot; title=&quot;backport cqlshlib test fixes to 2.1+&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10432&quot;&gt;&lt;del&gt;CASSANDRA-10432&lt;/del&gt;&lt;/a&gt;) to track fixing them on all supported versions. For the moment, I propose applying the changes as-is to 2.2+ or 3.0+. I don&apos;t think it&apos;s worth blocking merge on fixing the tests all the way back.&lt;/p&gt;</comment>
                            <comment id="14940601" author="iamaleksey" created="Thu, 1 Oct 2015 23:42:12 +0000"  >&lt;p&gt;Ok, wfm.&lt;/p&gt;</comment>
                            <comment id="14940755" author="iamaleksey" created="Fri, 2 Oct 2015 04:23:19 +0000"  >&lt;p&gt;Committed to 2.2 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/f3cd3ed7bba7146c1410bc6b3e15b5cad3311f76&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;f3cd3ed7bba7146c1410bc6b3e15b5cad3311f76&lt;/a&gt; and merged with 3.0 and trunk, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12901989">CASSANDRA-10432</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12901440">CASSANDRA-10415</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12764435" name="trunk-10289.diff" size="61706" author="mambocab" created="Wed, 30 Sep 2015 15:44:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mambocab]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 7 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jwyv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stefania</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>