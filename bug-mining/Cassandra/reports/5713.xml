<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:20:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16634] Garbagecollect should not output all tables to L0 with LeveledCompactionStrategy</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16634</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;nodetool garbagecollect always outputs to L0 with LeveledCompactionStrategy.&lt;/p&gt;

&lt;p&gt;This is awful.&#160; On a large LCS table, this means that at the end of the garbagecollect process, all data is in L0.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This results in an awful sequence of useless temporary space usage and write amplification:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;L0 is repeatedly size-tiered compacted until it doesn&apos;t have too many SSTables.&#160; If the original LCS table had 2000 tables... this takes a long time&lt;/li&gt;
	&lt;li&gt;L0 is compacted to L1 in one to a couple very very large compactions&lt;/li&gt;
	&lt;li&gt;L1 is compacted to L2, L3 to L4, etc.&#160; Write amplification galore&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Due to the above, &apos;nodetool garbagecollect&apos; is close to worthless for large LCS tables.&#160; A full compaction is always less write amplification and similar temp disk space required.&#160; The only exception is if you can use &apos;nodetool garbagecolect&apos; part-way, and then use &apos;nodetool stop&apos; to cancel it before L0 is too large.&#160; In this case if you are lucky, and the order that it chose to process SSTables coincides with tables that have the most&#160; disk space to clear, you might free up enough disk space to succeed in your original goal.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;However, from what I can tell, there is no good reason to move the output to L0.&#160; Leaving the output table in the same SSTableLevel as the source table does not violate any of the LeveledCompactionStrategy placement rules, as the output by definition has a token range equal to or smaller than the source.&lt;/p&gt;

&lt;p&gt;The only drawback is if the size of the output files is significantly smaller than the source, in which case the source level would be under-sized.&#160;&#160; But that seems like a problem that LCS has to handle, not garbagecollect.&lt;/p&gt;

&lt;p&gt;LCS could have a &quot;pull up&quot; operation where it does something like the following.&#160;&#160; Assume a table has L4 as the max level, and L3 and L4 are both &apos;under-sized&apos;.&#160; L3 can attempt to &apos;pull up&apos; any tables from L4 that do not overlap with the token ranges of the L3 tables.&#160; After that, it can choose to do some compactions that mix L3 and L4 to pull up data into L3 if it is still significantly under-sized.&lt;/p&gt;

&lt;p&gt;From what I can tell, garbagecollect should just re-write tables in place, and leave the compaction strategy to deal with any consequences.&lt;/p&gt;

&lt;p&gt;Moving to L0 is a bad idea.&#160; In addition to the extra write amplification and extreme increase in temporary disk space required, I observed the following:&lt;/p&gt;

&lt;p&gt;A &apos;nodetool garbagecollect&apos; was placing a lot of pressure on a L0 of a node.&#160; We stopped it about 20% through the process, and it managed to compact down the top couple levels.&#160; So we tried to run &apos;garbagecollect&apos; again, but the first tables it chose to operate on were in L1, not the &apos;leafs&apos; in L5! &#160; This was because the order of SSTables chosen currently does not consider the level, and instead looks purely at the max timestamp in the&#160; file.&#160; But because we moved&#160;&lt;em&gt;very old&lt;/em&gt; data from L5 into L0 as a result of the prior gabagecollect, manytables in L1 and L2 now had very wide ranges between their min and max timestamps&#160;&#8211; essentially some of the oldest and newest data all in one table.&#160; &#160; This breaks the usual structure of an LCS table where the oldest data is at the high levels.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I hope that others agree that this is a bug, and deserving of a fix.&lt;/p&gt;

&lt;p&gt;I have a very simple patch for this that I will be creating a PR for soon.&#160; 3 lines for the code change, 70 lines for a new unit test.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13375174">CASSANDRA-16634</key>
            <summary>Garbagecollect should not output all tables to L0 with LeveledCompactionStrategy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="scottcarey">Scott Carey</assignee>
                                    <reporter username="scottcarey">Scott Carey</reporter>
                        <labels>
                    </labels>
                <created>Mon, 26 Apr 2021 22:25:21 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:55 +0000</updated>
                            <resolved>Tue, 27 Apr 2021 07:43:14 +0000</resolved>
                                        <fixVersion>3.11.11</fixVersion>
                    <fixVersion>4.0-rc2</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3000">50m</timespent>
                                <comments>
                            <comment id="17332793" author="scottcarey" created="Mon, 26 Apr 2021 22:40:22 +0000"  >&lt;p&gt;I need some minor guidance on the process.&#160; Documentation is all over the place &#8211; some says that we must not use pull requests and must attach a patch, but it looks like PRs are utilized now?&#160;&#160;&#160; I also don&apos;t know what the earliest branch that this should apply to is.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I am an Apache member.&#160; My github account is linked to the apache org.&lt;/p&gt;

&lt;p&gt;For now I will open a PR that can be viewed with my suggested fix.&#160; We can correct whatever errors I&apos;ve made process wise after that.&lt;/p&gt;</comment>
                            <comment id="17332796" author="brandon.williams" created="Mon, 26 Apr 2021 22:43:40 +0000"  >&lt;p&gt;Opening a PR is fine and you can base your work on any branch but I would recommend trunk and then backporting can be figured out later if necessary.&lt;/p&gt;</comment>
                            <comment id="17332803" author="scottcarey" created="Mon, 26 Apr 2021 23:00:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/986&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/986&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Its based on the 3.11 branch, but applies cleanly to trunk as well.&lt;/p&gt;</comment>
                            <comment id="17332805" author="brandon.williams" created="Mon, 26 Apr 2021 23:05:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; can you take a look?&lt;/p&gt;</comment>
                            <comment id="17332814" author="edimitrova" created="Tue, 27 Apr 2021 00:02:06 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=scottcarey&quot; class=&quot;user-hover&quot; rel=&quot;scottcarey&quot;&gt;scottcarey&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thank you for the patch. I was trying to find you on Slack to say hi and help you to clear some misunderstanding from our docs, but I didn&apos;t find you in the ASF Slack. (You might want to check the #cassandra-dev channel and the dev mailing list - &lt;a href=&quot;https://cassandra.apache.org/community/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cassandra.apache.org/community/&lt;/a&gt;). &#160;If you drop a question in the #cassandra-dev channel there are high chances of getting a fast response as we have contributors to the project all over the world and people are willing to help when they have a bit of time.&#160;&lt;/p&gt;

&lt;p&gt;Both patch and pull request submission work but you are right that pull requests are easier to handle and almost everyone use them on the project nowadays. We don&apos;t open pull requests to the Apache/cassandra repo though. Most people just have their fork where they work on things. I would suggest you to check this page (if you haven&apos;t) -&lt;a href=&quot;https://cassandra.apache.org/doc/latest/development/patches.html?highlight=contributing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cassandra.apache.org/doc/latest/development/patches.html?highlight=contributing&lt;/a&gt;. &#160;&lt;/p&gt;

&lt;p&gt;Also, we normally try to run some preliminary tests at least. More information on how to run tests locally or setup CI can be found here - &lt;a href=&quot;https://cassandra.apache.org/doc/latest/development/testing.html?highlight=testing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cassandra.apache.org/doc/latest/development/testing.html?highlight=testing&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Unfortunately, at this point the official Jenkins CI is available only for committers and PMC members but anyone of us will be happy to submit a CI run for you. Circle CI free tier is also an option, just bear in mind that you will see Python dtests failing &#160;due to not enough resources available, that is expected.&#160;&lt;/p&gt;</comment>
                            <comment id="17332946" author="krummas" created="Tue, 27 Apr 2021 05:45:46 +0000"  >&lt;p&gt;+1, running tests here before committing: &lt;a href=&quot;https://app.circleci.com/pipelines/github/krummas/cassandra?branch=bug%2FCASSANDRA-16634&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/krummas/cassandra?branch=bug%2FCASSANDRA-16634&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17332966" author="krummas" created="Tue, 27 Apr 2021 06:11:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;The only drawback is if the size of the output files is significantly smaller than the source, in which case the source level would be under-sized.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;we have &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7414&quot; title=&quot;After cleanup we can end up with non-compacting high level sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7414&quot;&gt;&lt;del&gt;CASSANDRA-7414&lt;/del&gt;&lt;/a&gt; for this case&lt;/p&gt;</comment>
                            <comment id="17333009" author="krummas" created="Tue, 27 Apr 2021 07:43:14 +0000"  >&lt;p&gt;committed, test failures look unrelated&lt;/p&gt;</comment>
                            <comment id="17334450" author="scottcarey" created="Wed, 28 Apr 2021 05:09:44 +0000"  >&lt;p&gt;Excellent.&#160; Thanks!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[scottcarey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 28 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0qh0g:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12337348">3.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/a68a7c5181930053f9b513672391b45088e590c4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/a68a7c5181930053f9b513672391b45088e590c4&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;test included&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>