<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:43:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6837] Batch CAS does not support LOCAL_SERIAL</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6837</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The batch CAS feature introduced in Cassandra 2.0.6 does not support the LOCAL_SERIAL consistency level, and always uses SERIAL.&lt;/p&gt;

&lt;p&gt;Create a cluster with 4 nodes with the following topology:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Datacenter: DC2
===============
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address    Load       Tokens  Owns   Host ID                               Rack
UN  127.0.0.3  269 KB     256     26.3%  ae92d997-6042-42d9-b447-943080569742  RAC1
UN  127.0.0.4  197.81 KB  256     25.1%  3edc92d7-9d1b-472a-8452-24dddbc4502c  RAC1
Datacenter: DC1
===============
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address    Load       Tokens  Owns   Host ID                               Rack
UN  127.0.0.1  226.92 KB  256     24.8%  dbc17bd7-1ede-47a2-9b31-6063752d6eb3  RAC1
UN  127.0.0.2  179.27 KB  256     23.7%  bb0ad285-34d2-4989-a664-b068986ab6fa  RAC1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In cqlsh:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh&amp;gt; CREATE KEYSPACE foo WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;NetworkTopologyStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;DC1&apos;&lt;/span&gt;: 2, &lt;span class=&quot;code-quote&quot;&gt;&apos;DC2&apos;&lt;/span&gt;: 2};
cqlsh&amp;gt; USE foo;
cqlsh:foo&amp;gt; CREATE TABLE bar (x text, y bigint, z bigint, t bigint, PRIMARY KEY(x,y));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Kill nodes 127.0.0.3 and 127.0.0.4:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Datacenter: DC2
===============
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address    Load       Tokens  Owns   Host ID                               Rack
DN  127.0.0.3  262.37 KB  256     26.3%  ae92d997-6042-42d9-b447-943080569742  RAC1
DN  127.0.0.4  208.04 KB  256     25.1%  3edc92d7-9d1b-472a-8452-24dddbc4502c  RAC1
Datacenter: DC1
===============
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address    Load       Tokens  Owns   Host ID                               Rack
UN  127.0.0.1  214.82 KB  256     24.8%  dbc17bd7-1ede-47a2-9b31-6063752d6eb3  RAC1
UN  127.0.0.2  178.23 KB  256     23.7%  bb0ad285-34d2-4989-a664-b068986ab6fa  RAC1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Connect to 127.0.0.1 in DC1 and run a CAS batch at CL.LOCAL_SERIAL+LOCAL_QUORUM:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Cluster cluster = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Cluster.Builder()
                .addContactPoint(&lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;)
                .withLoadBalancingPolicy(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DCAwareRoundRobinPolicy(&lt;span class=&quot;code-quote&quot;&gt;&quot;DC1&quot;&lt;/span&gt;))
                .build();

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Session session = cluster.connect(&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;);

        Batch batch = QueryBuilder.batch();
        batch.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleStatement(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO bar (x,y,z) VALUES (&lt;span class=&quot;code-quote&quot;&gt;&apos;abc&apos;&lt;/span&gt;, 123, 1) IF NOT EXISTS&quot;&lt;/span&gt;));
        batch.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleStatement(&lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE bar SET t=2 WHERE x=&lt;span class=&quot;code-quote&quot;&gt;&apos;abc&apos;&lt;/span&gt; AND y=123&quot;&lt;/span&gt;));

        batch.setConsistencyLevel(ConsistencyLevel.LOCAL_QUORUM);
        batch.setSerialConsistencyLevel(ConsistencyLevel.LOCAL_SERIAL);

        session.execute(batch);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The batch fails with:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Caused by: com.datastax.driver.core.exceptions.UnavailableException: Not enough replica available &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; query at consistency SERIAL (3 required but only 2 alive)
	at com.datastax.driver.core.Responses$Error$1.decode(Responses.java:44)
	at com.datastax.driver.core.Responses$Error$1.decode(Responses.java:33)
	at com.datastax.driver.core.Message$ProtocolDecoder.decode(Message.java:182)
	at org.jboss.netty.handler.codec.oneone.OneToOneDecoder.handleUpstream(OneToOneDecoder.java:66)
	... 21 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12700738">CASSANDRA-6837</key>
            <summary>Batch CAS does not support LOCAL_SERIAL</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="nff">Nicolas Favre-Felix</reporter>
                        <labels>
                            <label>LWT</label>
                    </labels>
                <created>Tue, 11 Mar 2014 16:04:49 +0000</created>
                <updated>Fri, 25 Oct 2019 13:10:58 +0000</updated>
                            <resolved>Mon, 17 Mar 2014 10:17:40 +0000</resolved>
                                        <fixVersion>2.0.7</fixVersion>
                                    <component>Feature/Lightweight Transactions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13935001" author="slebresne" created="Fri, 14 Mar 2014 13:39:48 +0000"  >&lt;p&gt;For batches at the protocol level, unfortunately the serial CL is not shipped by the protocol so this will have to be part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6855&quot; title=&quot;Native protocol V3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6855&quot;&gt;&lt;del&gt;CASSANDRA-6855&lt;/del&gt;&lt;/a&gt; (the fact that the java driver silently send SERIAL is a separate problem, one that concerns the java driver).&lt;/p&gt;

&lt;p&gt;That being said, as it happens, we don&apos;t even pass the right serial CL when you use non-protocol batches, and that can be fixed trivially, so attaching a patch (this will have to do as a work-around until &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6855&quot; title=&quot;Native protocol V3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6855&quot;&gt;&lt;del&gt;CASSANDRA-6855&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="13935493" author="jbellis" created="Fri, 14 Mar 2014 19:24:41 +0000"  >&lt;p&gt;+1, but can we rename to commitCL instead of serialCL?&lt;/p&gt;</comment>
                            <comment id="13937631" author="slebresne" created="Mon, 17 Mar 2014 10:16:09 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;but can we rename to commitCL instead of serialCL?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hum, the thing is that serialCL is the CL for the paxos phase, not the one use during the commit (it corresponds to the consistencyForPaxos argument of SP.cas(), not to consistencyForCommit), so renaming it commitCL is probably a bad idea. I&apos;m fine renaming it to paxosCL or something though, I don&apos;t really care much (though we use serialConsistency in other places already like the native protocol, QueryOptions and in thrift/CassandraServer so if it was just me, I&apos;d leave it be).&lt;/p&gt;</comment>
                            <comment id="13937632" author="slebresne" created="Mon, 17 Mar 2014 10:17:41 +0000"  >&lt;p&gt;Closing but as noted above, this does not solve the issue of LOCAL_SERIAL for protocol batches, that part is left to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6855&quot; title=&quot;Native protocol V3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6855&quot;&gt;&lt;del&gt;CASSANDRA-6855&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13940139" author="jbellis" created="Wed, 19 Mar 2014 04:11:34 +0000"  >&lt;p&gt;can we use paxosCL and commitCL then?&lt;/p&gt;

&lt;p&gt;i don&apos;t like &quot;serialCL&quot; because serial is itself a CL value&lt;/p&gt;</comment>
                            <comment id="13940383" author="slebresne" created="Wed, 19 Mar 2014 10:46:04 +0000"  >&lt;p&gt;At the risk of sounding obtuse, we use &quot;serial_consistency&quot; both in thrift and in the native protocol spec. And truth is, while maybe not perfect, I do think it&apos;s better than paxos_consistency because that would be leaking implementation details and we&apos;ve always said that the use of Paxos was an implementation detail we didn&apos;t wanted to leak. It also happen that I don&apos;t really see the problem with serial_consistency. The comment in cassandra.thrift describe it this way&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The first one, serial_consistency_level, simply indicates the level of serialization required. This can be either ConsistencyLevel.SERIAL or ConsistencyLevel.LOCAL_SERIAL&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;and to me that sounds relatively sensible. Of course, we can call it &quot;serial consistency&quot; externally but &quot;paxos consistency&quot; internally, but that feels a bit inconsistent for no good reason.&lt;/p&gt;

&lt;p&gt;Anyway, all this to say that imo serial_consistency is better than paxos_consistency at least externally because it doesn&apos;t leak implementation details, and that it follows to me that there is no point in making it different internally. Nor do I think that serial_consistency is so bad that we should bother finding something else. Those arguments and opinion being made, if you still think it&apos;s worth renaming, I won&apos;t fight it, and feel free to go ahead. It&apos;s orthogonal to this issue however, the patch here didn&apos;t introduced the serial_consistency naming.&lt;/p&gt;</comment>
                            <comment id="13940435" author="jbellis" created="Wed, 19 Mar 2014 12:30:10 +0000"  >&lt;p&gt;fair enough&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12634715" name="6837.txt" size="2585" author="slebresne" created="Fri, 14 Mar 2014 13:39:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>379081</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tbhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>379373</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>