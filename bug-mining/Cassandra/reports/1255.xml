<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:25:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3116] Compactions can (seriously) delay schema migrations</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3116</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;A compaction lock is acquired when dropping keyspaces or column families which will cause the schema migration to block if a compaction is in progress.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12521007">CASSANDRA-3116</key>
            <summary>Compactions can (seriously) delay schema migrations</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="urandom">Eric Evans</reporter>
                        <labels>
                            <label>compaction</label>
                    </labels>
                <created>Thu, 1 Sep 2011 02:42:09 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:52 +0000</updated>
                            <resolved>Mon, 31 Oct 2011 13:32:39 +0000</resolved>
                                        <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13095087" author="jbellis" created="Thu, 1 Sep 2011 02:51:31 +0000"  >&lt;p&gt;agreed that this sucks.  would like to switch to some kind of test-and-set safety for compaction vs migration instead.  not immediately obvious to me how to do this.&lt;/p&gt;</comment>
                            <comment id="13095416" author="tom.wilkie" created="Thu, 1 Sep 2011 17:00:31 +0000"  >&lt;p&gt;Its worse than this too; a migration tried to get the write lock, which gets blocked on a big compaction (holding the read lock).  This migration waiting on the write lock then blocks all other compactions waiting on the read lock.  So you only get one compaction going on and thousands backing up.&lt;/p&gt;

&lt;p&gt;A really hacky temporary fix would be to use a tryLock(timeout) and short sleep in a loop in the migration.  This would at least not starve the merges, but would starve the migrations quite badly.&lt;/p&gt;</comment>
                            <comment id="13095861" author="slebresne" created="Fri, 2 Sep 2011 08:29:20 +0000"  >&lt;p&gt;I think the &lt;em&gt;raison d&apos;&#234;tre&lt;/em&gt; of the lock is because we need to mark all sstables compacted for them to be removed when dropping, but that cannot be done correctly if some sstable are being compacted. But couldn&apos;t we just &quot;delay&quot; the compacted marking ? For instance, we could have a &apos;isDropped&apos; switch in DataTracker such that when that switch is on the replace() method just remove the &apos;replacements&apos; sstables. So the drop keyspace/cf would set the isDropped flag first, then grab any sstable files that is not being compacted and mark those right away. It may be a bit tricky to do that atomically but &lt;em&gt;&#224; priori&lt;/em&gt; it sounds doable. We&apos;ll probably want to add a call to some checkForDropped() method in case a compaction fails to be sure we don&apos;t leave sstables behind in that case.&lt;/p&gt;

&lt;p&gt;Another option may be to just stop the running compactions (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1740&quot; title=&quot;Nodetool commands to query and stop compaction, repair, cleanup and scrub&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1740&quot;&gt;&lt;del&gt;CASSANDRA-1740&lt;/del&gt;&lt;/a&gt;) so that we can mark everything compacted at once. I may be harder to make that thread safe though, not sure, and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1740&quot; title=&quot;Nodetool commands to query and stop compaction, repair, cleanup and scrub&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1740&quot;&gt;&lt;del&gt;CASSANDRA-1740&lt;/del&gt;&lt;/a&gt; is not in yet. &lt;/p&gt;</comment>
                            <comment id="13129007" author="jbellis" created="Mon, 17 Oct 2011 17:11:23 +0000"  >&lt;p&gt;Patch to replace locking in migrations + valid checks in CompactionManager with isValid checks in DataTracker.&lt;/p&gt;

&lt;p&gt;compactionLock is still used but only for major compaction.  should we get rid of that too and say &quot;if you want to be absolutely sure you&apos;re compacting everything, disable minor compactions before invoking major?&quot;&lt;/p&gt;</comment>
                            <comment id="13129008" author="jbellis" created="Mon, 17 Oct 2011 17:11:52 +0000"  >&lt;p&gt;Note: applies after the Rename migration removal in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3292&quot; title=&quot;creating column family sets durable_writes to true&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3292&quot;&gt;&lt;del&gt;CASSANDRA-3292&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13130688" author="slebresne" created="Wed, 19 Oct 2011 15:19:43 +0000"  >&lt;p&gt;Not sure this work correctly. I believe we first have a problem with DT.removeAllSSTables(), because this is during the drop and really do remove &lt;b&gt;all&lt;/b&gt; sstables, including the ones that are being compacted (and thus it will unreference those while they are being compacted, which is bad). So we should first change that to only remove the one that are not compacting. Then we must make sure that anything that was not removed by that gets removed later. Which involves removing any flushed memtable (though that doesn&apos;t really matter since a dropped CF is flushed before being invalidated) and we must make sure that compacted sstable do are marked compacted but also that replacements are directly marked as compacted too (which mainly involve that we call removeOldSSTablesSize() on them). And I suppose we could make sure no new compaction is automatically triggered on an invalidated CF so we don&apos;t have a race or something.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;compactionLock is still used but only for major compaction. should we get rid of that too and say &quot;if you want to be absolutely sure you&apos;re compacting everything, disable minor compactions before invoking major?&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think there is really no much cost to keeping the lock in there if the write lock is only acquired by events triggered by a user and I would prefer having major compaction do what it pretend by default rather that having a &quot;complicated&quot; procedure. That being said, I would be for replacing the global compactionLock by one lock per CF (which should be easy).&lt;/p&gt;</comment>
                            <comment id="13136136" author="jbellis" created="Wed, 26 Oct 2011 17:37:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;only remove the one that are not compacting&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done.  (renamed removeAllSSTables to unreferenceSSTables, which could still stand improvement...)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;removing any flushed memtable ... also that replacements are directly marked as compacted too &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done (both by ultimately funneling through the replace method)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;we could make sure no new compaction is automatically triggered on an invalidated CF &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;this shouldn&apos;t be a problem, if it happens.  I&apos;d rather not go to extra effort to prevent something harmless.&lt;/p&gt;

&lt;p&gt;v2 also gets rid of CFS.flushlock (we already flush for the drop snapshot) and removes CFS.isDropped in favor of isValid.&lt;/p&gt;</comment>
                            <comment id="13138556" author="slebresne" created="Fri, 28 Oct 2011 17:20:10 +0000"  >&lt;p&gt;The patch already needs rebase, but based on the diff a few comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In unmarkCompacting, calling twice markCompacted is not so harmless has it will trigger an assertion. What we could do is checked the sstableReader isCompacted flag.&lt;/li&gt;
	&lt;li&gt;attemptUpdate breaks atomicity for unreferenceSSTable. We should make sure the compareAndSet is done on the view we used to compute notCompacting, otherwise we could have bug in View.replace (like in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3306&quot; title=&quot;Failed streaming may cause duplicate SSTable reference&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3306&quot;&gt;&lt;del&gt;CASSANDRA-3306&lt;/del&gt;&lt;/a&gt;). It&apos;s probably simpler to move back the compareAndSet in both unreferenceSSTable and replace, and call a &apos;finalizeReplace&apos; for the addNewSSTableSize and following methods.&lt;/li&gt;
	&lt;li&gt;We could rename the unregisterMBean method in KeysIndex to invalidate.&lt;/li&gt;
	&lt;li&gt;We may still want to check for isValid before doing a validation compaction because it doesn&apos;t call markCompacting, so it could still run after it&apos;s invalidated on some sstable that have not yet be removed because are being compacted.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13138676" author="jbellis" created="Fri, 28 Oct 2011 19:30:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;What we could do is checked the sstableReader isCompacted flag&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think I like moving the check into removeOldSSTables instead, since it&apos;s clearly threadsafe (even though there are no existing thread safety issues, why take chances with future complications).  The new version also allows markCompacted to &quot;work&quot; when called multiple times with asserts turned off; before, the file create IOException would blow up anyway.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;attemptUpdate breaks atomicity for unreferenceSSTable&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Damn it, you&apos;re right.  So many CAS loops feels like we&apos;re making this too fragile.  But you&apos;re right, that&apos;s better than passing View references around.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;rename the unregisterMBean method in KeysIndex to invalidate&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We may still want to check for isValid before doing a validation compaction &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done, although I suspect my comment attempting to explain the reason for the check may cause more confusion than it&apos;s worth. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;v3 attached.  &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3409&quot; title=&quot;CFS reloading of the compaction strategy is done for every metadata update and is not thread safe&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3409&quot;&gt;&lt;del&gt;CASSANDRA-3409&lt;/del&gt;&lt;/a&gt; throws a bit of a wrench into things since I don&apos;t see a good way to avoid the lock; still, that&apos;s not a frequently used migration.&lt;/p&gt;</comment>
                            <comment id="13140130" author="slebresne" created="Mon, 31 Oct 2011 13:11:21 +0000"  >&lt;p&gt;+1 on v3. Nit: for the assert in DT.postReplace(), I believe the msg should include the sstable, not &apos;this&apos;.&lt;/p&gt;</comment>
                            <comment id="13140157" author="jbellis" created="Mon, 31 Oct 2011 13:32:39 +0000"  >&lt;p&gt;fixed + committed&lt;/p&gt;</comment>
                            <comment id="13140328" author="hudson" created="Mon, 31 Oct 2011 17:16:49 +0000"  >&lt;p&gt;Integrated in Cassandra #1177 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra/1177/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra/1177/&lt;/a&gt;)&lt;br/&gt;
    replace compactionlock use in schema migration by checking CFS.isInvalidD&lt;br/&gt;
patch by jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3116&quot; title=&quot;Compactions can (seriously) delay schema migrations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3116&quot;&gt;&lt;del&gt;CASSANDRA-3116&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1195542&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1195542&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/ColumnFamilyStore.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/DataTracker.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/Memtable.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/Table.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/compaction/CompactionManager.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/index/SecondaryIndex.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/index/SecondaryIndexManager.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/index/keys/KeysIndex.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/migration/DropColumnFamily.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/migration/DropKeyspace.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/io/sstable/SSTableReader.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/test/unit/org/apache/cassandra/db/KeyCacheTest.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/test/unit/org/apache/cassandra/db/compaction/CompactionsTest.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/test/unit/org/apache/cassandra/streaming/StreamingTransferTest.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12523471">CASSANDRA-3225</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12500916" name="3116-v2.txt" size="26515" author="jbellis" created="Wed, 26 Oct 2011 17:37:54 +0000"/>
                            <attachment id="12501348" name="3116-v3.txt" size="29454" author="jbellis" created="Fri, 28 Oct 2011 19:30:46 +0000"/>
                            <attachment id="12499402" name="3116.txt" size="15397" author="jbellis" created="Mon, 17 Oct 2011 17:11:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1872</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 4 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gfzb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94019</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>