<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:02:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11615] cassandra-stress blocks when connecting to a big cluster</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11615</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I had a &lt;b&gt;100&lt;/b&gt; node cluster and was running &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cassandra-stress read n=100 no-warmup cl=LOCAL_QUORUM -rate &lt;span class=&quot;code-quote&quot;&gt;&apos;threads=20&apos;&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;limit=1000/s&apos;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Based on the thread dump it looks like it&apos;s been blocked at &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/tools/stress/src/org/apache/cassandra/stress/util/JavaDriverClient.java#L96&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.0/tools/stress/src/org/apache/cassandra/stress/util/JavaDriverClient.java#L96&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-20&quot;&lt;/span&gt; #245 prio=5 os_prio=0 tid=0x00007f3781822000 nid=0x46c4 waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; monitor entry [0x00007f36cc788000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: BLOCKED (on object monitor)
        at org.apache.cassandra.stress.util.JavaDriverClient.prepare(JavaDriverClient.java:96)
        - waiting to lock &amp;lt;0x00000005c003d920&amp;gt; (a java.util.concurrent.ConcurrentHashMap)
        at org.apache.cassandra.stress.operations.predefined.CqlOperation$JavaDriverWrapper.createPreparedStatement(CqlOperation.java:314)
        at org.apache.cassandra.stress.operations.predefined.CqlOperation.run(CqlOperation.java:77)
        at org.apache.cassandra.stress.operations.predefined.CqlOperation.run(CqlOperation.java:109)
        at org.apache.cassandra.stress.operations.predefined.CqlOperation.run(CqlOperation.java:261)
        at org.apache.cassandra.stress.StressAction$Consumer.run(StressAction.java:327)
&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-19&quot;&lt;/span&gt; #244 prio=5 os_prio=0 tid=0x00007f3781820000 nid=0x46c3 waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; monitor entry [0x00007f36cc889000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: BLOCKED (on object monitor)
        at org.apache.cassandra.stress.util.JavaDriverClient.prepare(JavaDriverClient.java:96)
        - waiting to lock &amp;lt;0x00000005c003d920&amp;gt; (a java.util.concurrent.ConcurrentHashMap)
        at org.apache.cassandra.stress.operations.predefined.CqlOperation$JavaDriverWrapper.createPreparedStatement(CqlOperation.java:314)
        at org.apache.cassandra.stress.operations.predefined.CqlOperation.run(CqlOperation.java:77)
        at org.apache.cassandra.stress.operations.predefined.CqlOperation.run(CqlOperation.java:109)
        at org.apache.cassandra.stress.operations.predefined.CqlOperation.run(CqlOperation.java:261)
        at org.apache.cassandra.stress.StressAction$Consumer.run(StressAction.java:327)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I was trying the same with with a smaller cluster (50 nodes) and it was working fine.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12960246">CASSANDRA-11615</key>
            <summary>cassandra-stress blocks when connecting to a big cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andrew.tolbert">Andy Tolbert</assignee>
                                    <reporter username="eduard.tudenhoefner">Eduard Tudenhoefner</reporter>
                        <labels>
                    </labels>
                <created>Wed, 20 Apr 2016 06:55:11 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:35 +0000</updated>
                            <resolved>Fri, 6 May 2016 13:13:06 +0000</resolved>
                                        <fixVersion>3.0.7</fixVersion>
                    <fixVersion>3.7</fixVersion>
                                    <component>Legacy/Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15249550" author="eduard.tudenhoefner" created="Wed, 20 Apr 2016 09:24:35 +0000"  >&lt;p&gt;Attached a patch that fixed the issue for me. Now I could use stress without a problem on a cluster with &lt;b&gt;100 nodes&lt;/b&gt;, without seeing any blocked threads.&lt;/p&gt;

&lt;p&gt;Looks like the problem was that the prepares were done on &lt;b&gt;all&lt;/b&gt; nodes within a synchronized block, which would basically take quite long.&lt;/p&gt;

&lt;p&gt;I was talking to Andy Tolbert from the Java Drivers team and he suggested to not prepare &lt;b&gt;all statements on all nodes&lt;/b&gt;. &lt;/p&gt;
</comment>
                            <comment id="15250080" author="tjake" created="Wed, 20 Apr 2016 15:23:09 +0000"  >&lt;p&gt;Was it deadlocked? Or just slow?&lt;/p&gt;

&lt;p&gt;Regarding your fix&lt;br/&gt;
From the driver javadocs:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;On the other hand, if that assumption turns out to be wrong and one host hasn&apos;t prepared a given statement, it needs to be re-prepared on the fly the first time it gets executed; this causes a performance penalty (one extra roundtrip to resend the query to prepare, and another to retry the execution).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Since this is a benchmark tool I&apos;d prefer to not make this the default. Can you make it an option?&lt;/p&gt;</comment>
                            <comment id="15250280" author="eduard.tudenhoefner" created="Wed, 20 Apr 2016 17:11:31 +0000"  >&lt;p&gt;It was deadlocked and eventually failed with &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.RuntimeException: Timed out waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a timer thread - seems one got stuck. Check GC/Heap size
	at org.apache.cassandra.stress.util.Timing.snap(Timing.java:98)
	at org.apache.cassandra.stress.StressMetrics.update(StressMetrics.java:156)
	at org.apache.cassandra.stress.StressMetrics.access$300(StressMetrics.java:37)
	at org.apache.cassandra.stress.StressMetrics$2.run(StressMetrics.java:104)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Yeah ok no problem, I can make it an option.&lt;/p&gt;</comment>
                            <comment id="15251319" author="eduard.tudenhoefner" created="Thu, 21 Apr 2016 05:51:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; just out of curiosity, is it possible that this performance penalty happens &quot;only&quot; during the warmup phase? Or is there also a chance that it happens during the warmup and the main performance run?&lt;/p&gt;</comment>
                            <comment id="15251883" author="tjake" created="Thu, 21 Apr 2016 13:21:33 +0000"  >&lt;p&gt;The latter.  If a node stress is connected to disconnects during the run (due to GC, latency etc) it will reconnect to a new node and have to re-prepare.&lt;/p&gt;

&lt;p&gt;Going back to the original problem though.  If prepare is never completing on clusters &amp;gt; 50 nodes perhaps there is a deeper bug the driver team needs to look into?&lt;/p&gt;</comment>
                            <comment id="15253718" author="eduard.tudenhoefner" created="Fri, 22 Apr 2016 10:33:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; attached a second patch, where it can be controlled with an option. I will also go ahead and talk to the C* Java driver guys about it&lt;/p&gt;</comment>
                            <comment id="15254175" author="andrew.tolbert" created="Fri, 22 Apr 2016 16:33:18 +0000"  >&lt;p&gt;Was digging into this with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eduard.tudenhoefner&quot; class=&quot;user-hover&quot; rel=&quot;eduard.tudenhoefner&quot;&gt;eduard.tudenhoefner&lt;/a&gt;, and I suspect this is being caused by &lt;a href=&quot;https://datastax-oss.atlassian.net/browse/JAVA-1002&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JAVA-1002&lt;/a&gt;, which will be fixed in 3.0.1.  I tried this out with a 100 node simulated cluster (not using stress in this case) a single threaded netty event loop group in the driver (to amplify the impact), and timed how long a session.prepare takes when the keyspace is set on the connection.  It took 203ms with the fix for JAVA-1002, otherwise it takes a very very long time.   I think this is the source of the issue, but we&apos;ll need to confirm again when we get a large cluster up again in the next week or so.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;3.0.0 - 100 nodes, no keyspace set on session - 206ms

42776  [main] INFO  OneHundredNodeSimulation - Done Initing Cluster..Preparing Statement
42982  [main] INFO  OneHundredNodeSimulation - Done Preparing Statement...making query

3.0.0 - 100 nodes, keyspace set on session - too long..ms

46276  [main] INFO  OneHundredNodeSimulation - Done Initing Cluster..Preparing Statement
58429  [cluster1-nio-worker-0] WARN  com.datastax.driver.core.Connection - Timeout while setting keyspace on Connection[/127.0.1.1:9042-3, inFlight=1, closed=false]. This should not happen but is not critical (it will be retried)
70510  [cluster1-nio-worker-0] WARN  com.datastax.driver.core.Connection - Timeout while setting keyspace on Connection[/127.0.1.3:9042-1, inFlight=1, closed=false]. This should not happen but is not critical (it will be retried)
82609  [cluster1-nio-worker-0] WARN  com.datastax.driver.core.Connection - Timeout while setting keyspace on Connection[/127.0.1.4:9042-1, inFlight=1, closed=false]. This should not happen but is not critical (it will be retried)
94725  [cluster1-nio-worker-0] WARN  com.datastax.driver.core.Connection - Timeout while setting keyspace on Connection[/127.0.1.5:9042-1, inFlight=1, closed=false]. This should not happen but is not critical (it will be retried)
106818 [cluster1-nio-worker-0] WARN  com.datastax.driver.core.Connection - Timeout while setting keyspace on Connection[/127.0.1.6:9042-1, inFlight=1, closed=false]. This should not happen but is not critical (it will be retried)
118908 [cluster1-nio-worker-0] WARN  com.datastax.driver.core.Connection - Timeout while setting keyspace on Connection[/127.0.1.7:9042-1, inFlight=1, closed=false]. This should not happen but is not critical (it will be retried)
131008 [cluster1-nio-worker-0] WARN  com.datastax.driver.core.Connection - Timeout while setting keyspace on Connection[/127.0.1.8:9042-1, inFlight=1, closed=false]. This should not happen but is not critical (it will be retried)
143109 [cluster1-nio-worker-0] WARN  com.datastax.driver.core.Connection - Timeout while setting keyspace on Connection[/127.0.1.9:9042-1, inFlight=1, closed=false]. This should not happen but is not critical (it will be retried)
155207 [cluster1-nio-worker-0] WARN  com.datastax.driver.core.Connection - Timeout while setting keyspace on Connection[/127.0.1.10:9042-1, inFlight=1, closed=false]. This should not happen but is not critical (it will be retried)
167308 [cluster1-nio-worker-0] WARN  com.datastax.driver.core.Connection - Timeout while setting keyspace on Connection[/127.0.1.11:9042-1, inFlight=1, closed=false]. This should not happen but is not critical (it will be retried)
...

3.0.1rc (has JAVA-1002 fix) - 100 nodes, keyspace set on session - 203ms

46000  [main] INFO  OneHundredNodeSimulation - Done Initing Cluster..Preparing Statement
46203  [main] INFO  OneHundredNodeSimulation - Done Preparing Statement...making query
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15254220" author="tjake" created="Fri, 22 Apr 2016 17:02:24 +0000"  >&lt;p&gt;I&apos;d prefer the upstream fix to adding this workaround option. Agreed?&lt;/p&gt;</comment>
                            <comment id="15254245" author="andrew.tolbert" created="Fri, 22 Apr 2016 17:17:37 +0000"  >&lt;p&gt;I agree, I proposed using setPrepareOnAllHosts(false) as it is a good work around for testing, but now that I think we understand the issue more and that it is on the driver side, it would be better to incorporate java-driver 3.0.1 when it is released (no definitive date on that yet, but should be in coming weeks).&lt;/p&gt;</comment>
                            <comment id="15256294" author="eduard.tudenhoefner" created="Mon, 25 Apr 2016 12:51:51 +0000"  >&lt;p&gt;I agree &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15256360" author="tjake" created="Mon, 25 Apr 2016 13:42:49 +0000"  >&lt;p&gt;I&apos;ll keep this ticket open.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrew.tolbert&quot; class=&quot;user-hover&quot; rel=&quot;andrew.tolbert&quot;&gt;andrew.tolbert&lt;/a&gt; please let us know when 3.0.1 is out&lt;/p&gt;</comment>
                            <comment id="15256444" author="andrew.tolbert" created="Mon, 25 Apr 2016 15:01:30 +0000"  >&lt;p&gt;Will do &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15267306" author="andrew.tolbert" created="Mon, 2 May 2016 19:16:50 +0000"  >&lt;p&gt;java-driver 3.0.1 has been released with this fix! &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15272600" author="tjake" created="Thu, 5 May 2016 16:43:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/tjake/cassandra/tree/update-driver-3.0.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/tjake-update-driver-3.0.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/tjake-update-driver-3.0.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15274008" author="tjake" created="Fri, 6 May 2016 13:13:07 +0000"  >&lt;p&gt;committed thx&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12800196" name="11615-3.0-2nd.patch" size="5952" author="eduard.tudenhoefner" created="Fri, 22 Apr 2016 10:33:18 +0000"/>
                            <attachment id="12799711" name="11615-3.0.patch" size="1358" author="eduard.tudenhoefner" created="Wed, 20 Apr 2016 09:24:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[andrew.tolbert]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2wd3j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332541">3.0.x</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>