<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6638] SSTableScanner can Skip Rows with vnodes</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6638</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2524&quot; title=&quot;Use SSTableBoundedScanner for cleanup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2524&quot;&gt;&lt;del&gt;CASSANDRA-2524&lt;/del&gt;&lt;/a&gt; added multiple range support to SSTableScanner, but it looks like there is at least one case where keys can be skipped.  This can result in cleanup removing legitimate keys.&lt;/p&gt;

&lt;p&gt;See the attached patch that adds a unit test to reproduce the case.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12692196">CASSANDRA-6638</key>
            <summary>SSTableScanner can Skip Rows with vnodes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="thobbs">Tom Hobbs</reporter>
                        <labels>
                    </labels>
                <created>Thu, 30 Jan 2014 00:31:03 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:55 +0000</updated>
                            <resolved>Thu, 30 Jan 2014 17:22:38 +0000</resolved>
                                        <fixVersion>2.0.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13886141" author="rcoli" created="Thu, 30 Jan 2014 01:30:35 +0000"  >&lt;p&gt;Are there non-cleanup related consequences of this issue?&lt;/p&gt;</comment>
                            <comment id="13886517" author="slebresne" created="Thu, 30 Jan 2014 11:57:48 +0000"  >&lt;p&gt;Attaching simple fix (the patch includes Tyler&apos;s unit test).&lt;/p&gt;

&lt;p&gt;For the records, the original reported of the issue, Ignace Desimpel, provided  the following analysis on the mailing list:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;To see what is wrong, think of having 3 ranges in the list, and both the first and second range will not produce a valid currentKey. The first time in the loop we get the first range, and then call seekToCurrentRangeStart(). That routine doesn&#8217;t do anything in that case, so then the first key is read from the sstable. But this first key does not match the first range, so we loop again. We get the second range and call seekToCurrentRangeStart() again. Again this does not do anything, leaving all file pointers. So then a new currentKey is read from the sstable BUT that should not be the case. We should, in that case, continue to test with the &#8216;old&#8217; currentKey.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;(which is a fair description of what triggers the problem) and proposed a fix. That fix was modifying the logic of KeyScanningIterator.computeNext(), and while the fix itself is probably fine, it complicate the logic a bit and I think it&apos;s simpler and cleaner to just fix seekToCurrentRangeStart to really always seek to the first key greater than the current range start (that was clearly the intent given the comment when indexPosition = -1 in that method, but the method wrongly assumed we were always at the beginning of the sstable). So that&apos;s what the attached patch does. I&apos;ll note that this does mean we might re-read the same key if the sstable have no keys for at least 2 consecutive range, but this really doesn&apos;t matter in practice so we should stick to cleaner code.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Are there non-cleanup related consequences of this issue?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No. This can only ever happen if SSTableScanner is uses with at least 2 ranges and cleanup is the only place we do that (I double-checked). I&apos;ll also note that this could affect non-vnode cases though it&apos;s a lot less likely, at least provided you use a random partitionner, as you need for a sstable to have no keys for a given local range, which is possible but much less likely without vnodes. Lastly, this might skip at most 1 row per-local-range.&lt;/p&gt;</comment>
                            <comment id="13886570" author="ignaced" created="Thu, 30 Jan 2014 13:31:03 +0000"  >&lt;p&gt;Thanks for the simple patch! &lt;br/&gt;
Related to efficiency : &lt;br/&gt;
Suppose we have sstable data in every other range.&lt;br/&gt;
Then the first range gets data matching the range. The second does not, and a &apos;file&apos; seek is &lt;br/&gt;
done to the first key greater than the left of the this second range, thus to the first sample key in the third range.&lt;br/&gt;
And then a loop is started over all the ifile entries until end of ifile file (there is no upper boundary check)! &lt;br/&gt;
That would repeat itself over and over again if we happen to have such a data and range arrangement and depending on the number of vnodes.&lt;br/&gt;
Correct? That means a lot of work for nothing?&lt;/p&gt;</comment>
                            <comment id="13886599" author="slebresne" created="Thu, 30 Jan 2014 14:14:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;And then a loop is started over all the ifile entries until end of ifile file (there is no upper boundary check)!&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There is an upper check, we compare each deserialized index key to the range we&apos;re &quot;seeking to the start&quot; of. If we&apos;ve seek to a key in the third range, that index key will sort after the 2nd range start and we&apos;ll exist the loop right away.&lt;/p&gt;</comment>
                            <comment id="13886624" author="ignaced" created="Thu, 30 Jan 2014 14:48:26 +0000"  >&lt;p&gt;Sorry, my mistake.&lt;/p&gt;</comment>
                            <comment id="13886726" author="thobbs" created="Thu, 30 Jan 2014 16:19:55 +0000"  >&lt;p&gt;+1 on the patch with a minor nit: can you remove the &quot;this will currently fail&quot; comment and mention 6638 in the new test?&lt;/p&gt;</comment>
                            <comment id="13886803" author="slebresne" created="Thu, 30 Jan 2014 17:22:38 +0000"  >&lt;p&gt;Committed with the nit, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12626026" name="6638-repro-test.txt" size="1479" author="thobbs" created="Thu, 30 Jan 2014 00:32:26 +0000"/>
                            <attachment id="12626095" name="6638.txt" size="2753" author="slebresne" created="Thu, 30 Jan 2014 11:57:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>370787</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1rwkf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>371095</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324542">2.0.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>