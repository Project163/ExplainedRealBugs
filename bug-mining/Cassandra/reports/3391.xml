<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8815] Race in sstable ref counting during streaming failures</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8815</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have a seen a machine in Prod whose all read threads are blocked(spinning) on trying to acquire the reference lock on stables. There are also some stream sessions which are doing the same. &lt;br/&gt;
On looking at the heap dump, we could see that a live sstable which is part of the View has a ref count = 0. This sstable is also not compacting or is part of any failed compaction. &lt;/p&gt;

&lt;p&gt;On looking through the code, we could see that if ref goes to zero and the stable is part of the View, all reader threads will spin forever. &lt;/p&gt;

&lt;p&gt;On further looking through the code of streaming, we could see that if StreamTransferTask.complete is called after closeSession has been called due to error in OutgoingMessageHandler, it will double decrement the ref count of an sstable. &lt;/p&gt;

&lt;p&gt;This race can happen and we see through exception in logs that closeSession was triggered by OutgoingMessageHandler. &lt;/p&gt;

&lt;p&gt;The fix for this is very simple i think. In StreamTransferTask.abort, we can remove a file from &quot;files&#8221; before decrementing the ref count. This will avoid this race. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12775475">CASSANDRA-8815</key>
            <summary>Race in sstable ref counting during streaming failures</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="kohlisankalp">Sankalp Kohli</reporter>
                        <labels>
                    </labels>
                <created>Mon, 16 Feb 2015 22:27:57 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:20 +0000</updated>
                            <resolved>Thu, 19 Feb 2015 11:55:14 +0000</resolved>
                                        <fixVersion>2.0.13</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14323401" author="kohlisankalp" created="Mon, 16 Feb 2015 22:28:20 +0000"  >&lt;p&gt;This is similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7704&quot; title=&quot;FileNotFoundException during STREAM-OUT triggers 100% CPU usage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7704&quot;&gt;&lt;del&gt;CASSANDRA-7704&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14323402" author="kohlisankalp" created="Mon, 16 Feb 2015 22:29:36 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14323420" author="kohlisankalp" created="Mon, 16 Feb 2015 22:56:30 +0000"  >&lt;p&gt;This can also be fixed by adding &quot;files.clear()&quot; to the last line of STT.abort(). &lt;br/&gt;
Or adding if(aborted) return to start of complete method.  &lt;/p&gt;</comment>
                            <comment id="14324522" author="benedict" created="Tue, 17 Feb 2015 17:34:13 +0000"  >&lt;p&gt;Yep, nice spot. Attached a patch that calls files.clear() at the end, as well as ensuring it reaches that spot by catching any possible exceptions during cleanup.&lt;/p&gt;</comment>
                            <comment id="14324637" author="kohlisankalp" created="Tue, 17 Feb 2015 18:36:09 +0000"  >&lt;p&gt;+1&lt;br/&gt;
Looks good. &lt;/p&gt;</comment>
                            <comment id="14325007" author="rlow" created="Tue, 17 Feb 2015 22:16:43 +0000"  >&lt;p&gt;I think we should add some assertions that would avoid the bad effect of this. I&apos;ll prepare a patch and put it here.&lt;/p&gt;</comment>
                            <comment id="14325709" author="benedict" created="Wed, 18 Feb 2015 10:52:13 +0000"  >&lt;p&gt;Agreed, although I would prefer a separate ticket for that. If you file the ticket and patch, feel free to mark me as reviewer and I&apos;ll commit alongside this.&lt;/p&gt;</comment>
                            <comment id="14326690" author="kohlisankalp" created="Wed, 18 Feb 2015 22:58:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Can you please commit this or ask someone?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12775933">CASSANDRA-8829</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12699300" name="8815.txt" size="1434" author="benedict" created="Tue, 17 Feb 2015 17:34:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 39 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i25p3z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>kohlisankalp</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[kohlisankalp]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>