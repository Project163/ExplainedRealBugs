<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:14:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15213] DecayingEstimatedHistogramReservoir Inefficiencies</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15213</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;LongAdder&lt;/tt&gt; introduced to trunk consumes 9MiB of heap without user schemas, and this will grow significantly under contention and user schemas with many tables. &#160;This is because &lt;tt&gt;LongAdder&lt;/tt&gt;&#160;is a very heavy class designed for single contended values. &#160;
	&lt;ul&gt;
		&lt;li&gt;This can likely be improved significantly, without significant loss of performance in the contended case, by simply increasing the size of our primitive backing array and providing multiple buckets, with each thread picking a bucket to increment, or simply multiple backing arrays. &#160;Probably a better way still to do this would be to introduce&#160;some competition detection to the update, much like &lt;tt&gt;LongAdder&lt;/tt&gt; utilises, that&#160;increases the number of backing arrays under competition.&lt;/li&gt;
		&lt;li&gt;To save memory this approach could partition the space into chunks that are likely to be updated together, so that we do not need to duplicate the entire array under competition.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Similarly, binary search is costly and a&#160;measurable cost as a share of the new networking work (without filtering it was &amp;gt; 10% of the CPU used overall). &#160;We&#160;can compute an approximation floor(log2 n / log2 1.2) extremely cheaply, to save the random memory access costs.&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="13245154">CASSANDRA-15213</key>
            <summary>DecayingEstimatedHistogramReservoir Inefficiencies</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jwest">Jordan West</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Jul 2019 09:20:09 +0000</created>
                <updated>Mon, 10 Mar 2025 14:33:33 +0000</updated>
                            <resolved>Wed, 19 Feb 2020 11:34:04 +0000</resolved>
                                        <fixVersion>4.0-alpha4</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Observability/Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17010956" author="jrwest" created="Wed, 8 Jan 2020 19:21:38 +0000"  >&lt;p&gt;I&#8217;ve verified the reported &lt;tt&gt;LongAdder&lt;/tt&gt; memory consumption. I&#8217;m seeing 13.5MiB right after startup.&lt;/p&gt;

&lt;p&gt;A few questions about your proposed solutions?&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;By the backing array do you mean the original AtomicLongArray? Two issues I see with increasing the number of buckets: the maximum we can create are 237 (then the offset overflows) and increasing the number of buckets doesn&#8217;t necessarily reduce contention. This is because the resolution of the buckets doesn&#8217;t change except for the last bucket (which for microseconds is over 200 days and for nanoseconds is over 5 hours). Or are you suggesting increasing the bucket resolution by decreasing the factor in &lt;tt&gt;newOffsets&lt;/tt&gt; when adding more buckets?&lt;/li&gt;
	&lt;li&gt;I&#8217;m not sure what you mean by &#8220;providing multiple buckets&#8221; but I suspect it might be what I am missing to better understand the proposal. Do you mean having multiple buckets per offset? Additionally, re: your &lt;tt&gt;LongAdder&lt;/tt&gt;&#160;reference, are you proposing creating new buckets for the same offset under contention (like &lt;tt&gt;LongAdder&lt;/tt&gt;&#160;does w/ &lt;tt&gt;Cell&lt;/tt&gt;)?&lt;/li&gt;
	&lt;li&gt;Regarding the binary search suggestion, are you suggesting using the approximation to replace the maximum index (e.g. binarySearch(offsets, 0, Math.floor(&#8230;.) + 1, value)? Or to outright use that approximation? I wasn&#8217;t sure of your exact proposal but it does seem like using the equation you gave as an upper bound estimate and &lt;tt&gt;Math.floor(Math.log(Math.floor(n / 1.2)) / Math.log(1.2))&lt;/tt&gt; as a lower bound estimate can reduce the space of the array we have to search by 25-60% (I saw up to 75% in one case with DEFAULT_BUCKET_COUNT but haven&#8217;t reproduced that high of a reduction since). I&#8217;ve added a QuickTheories test to show this here: &lt;a href=&quot;https://github.com/jrwest/cassandra/commit/a4795bc651cd0e0bd582a8df2414e312782b5020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jrwest/cassandra/commit/a4795bc651cd0e0bd582a8df2414e312782b5020&lt;/a&gt;. I should note however that this doesn&apos;t translate into a performance improvement in the microbenchmark &amp;#8211; perhaps because it really only reduces the number of accesses slightly at the cost of more calculations.&lt;/li&gt;
	&lt;li&gt;We could also circumvent the search entirely in the lowest buckets by using &lt;tt&gt;if value &amp;lt; bucketCount &amp;amp;&amp;amp; bucketOffsets&lt;span class=&quot;error&quot;&gt;&amp;#91;value - 1&amp;#93;&lt;/span&gt; == value&lt;/tt&gt; although given our use case its unlikely we will see sub 165 ns operations often.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17010990" author="benedict" created="Wed, 8 Jan 2020 20:12:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;Or are you suggesting increasing the bucket resolution&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;Do you mean having multiple buckets per offset? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right.  I meant one option was to essentially inline the striping by introducing, e.g., 4x as many buckets as requested.  Each logical bucket can be represented by the sum of that many buckets.  The buckets would be offset from each other by at least two cache lines, and all buckets would ideally be more uniformly distributed in memory (by e.g. &lt;tt&gt;Integer.reverse(idx)&lt;/tt&gt;), so that adjacent buckets that are most likely to be used together don&apos;t also compete for cache locks.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Additionally, re: your LongAdder&#160;reference, are you proposing creating new buckets for the same offset under contention (like LongAdder&#160;does w/ Cell)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I meant an alternative approach might be to batch a range of buckets together - say 16 or more, to amortise the object overhead - and to perform &lt;tt&gt;LongAdder&lt;/tt&gt;&#8217;s inflation of the number of buckets on the detection of competition, so that we can gradually increase the number of cells needed.  This might have the added benefit of not wasting space for striping of buckets that are rarely used, but at the cost of greater complexity, object overheads and indirection.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Regarding the binary search suggestion, are you suggesting using the approximation to replace the maximum index&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I meant to use it as the floor for a linear search for the correct position, so that it would ordinarily be 1 or 2 comparisons, but typically only one cache miss.&lt;/p&gt;

&lt;p&gt;Specifically, I meant to use an integer approximation, along the lines of...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; TABLE_BITS = 4;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; TABLE_MASK = -1 &amp;gt;&amp;gt;&amp;gt; (32 - TABLE_BITS);
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;[] LOG2_TABLE = computeTable(TABLE_BITS);
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; log2_12 = (&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;) slowLog2(1.2d);
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; log2_12_recp = (&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;) (1d / slowLog2(1.2d));

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;[] computeTable(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; bits)
{
    &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;[] table = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;[1 &amp;lt;&amp;lt; bits];
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 1 ; i &amp;lt; 1&amp;lt;&amp;lt;bits ; ++i)
        table[i] = (&lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt;) slowLog2(ratio(i, bits));
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; table;
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; fastLog12(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; v)
{
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; fastLog2(v) * log2_12_recp;
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; fastLog2(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; v)
{
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (v == 0) &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 0;
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; highestBitPosition = 63 - &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.numberOfLeadingZeros(v);
    v = &lt;span class=&quot;code-object&quot;&gt;Long&lt;/span&gt;.rotateRight(v, highestBitPosition - TABLE_BITS);
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) (v &amp;amp; TABLE_MASK);
    &lt;span class=&quot;code-object&quot;&gt;float&lt;/span&gt; result = LOG2_TABLE[index];
    result += highestBitPosition;
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; result;
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; slowLog2(&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; v)
{
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.log(v) / &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.log(2);
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; slowLog12(&lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; v)
{
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.log(v) / &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.log(2)) * log2_12_recp;
}

&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; ratio(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; bits)
{
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Float&lt;/span&gt;.intBitsToFloat((127 &amp;lt;&amp;lt; 23) | (i &amp;lt;&amp;lt; (23 - bits)));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


</comment>
                            <comment id="17011029" author="benedict" created="Wed, 8 Jan 2020 21:56:17 +0000"  >&lt;p&gt;FWIW, I think when benchmarking something like this you need to create a few hundred MiB worth of backing arrays, and cycle through them for each test.  Or, at least, there are different ways to achieve this but you ideally want tests that include memory latency and this is a simple mechanism to achieve that.&lt;/p&gt;</comment>
                            <comment id="17011493" author="jrwest" created="Thu, 9 Jan 2020 07:05:58 +0000"  >&lt;p&gt;Thanks for the clarification. I will take a stab at something to replace the usage of &lt;tt&gt;LongAdder[]&lt;/tt&gt; along the lines of what you suggested and share when ready. I agree re: benchmarking and will try and come up with a more complete set &amp;#8211; clearly we used the existing benchmarks before without finding this issue. &lt;/p&gt;

&lt;p&gt;Regarding the binary search, I am still a bit confused. If you run: &lt;a href=&quot;https://github.com/jrwest/cassandra/blob/jwest/15213/test/unit/org/apache/cassandra/metrics/DecayingEstimatedHistogramReservoirTest.java#L58&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jrwest/cassandra/blob/jwest/15213/test/unit/org/apache/cassandra/metrics/DecayingEstimatedHistogramReservoirTest.java#L58&lt;/a&gt; you will see that the proposed estimation (using the code provided) would result in several cases where a linear search would lead to over 10-50 accesses (as value grows the approximation gets more inaccurate) and &lt;tt&gt;Arrays.binarySearch(offsets, value) &amp;lt;= fastLog12(value)&lt;/tt&gt; always (even when correctly adjusting the return value of the binary search for negative values). &lt;/p&gt;

&lt;p&gt;Fwiw, the proposed fast log code does improve performance of my local modifications when benchmarked but basically brings it back inline w/ the existing implementation (caveat: benchmarking issues already mentioned). &lt;/p&gt;</comment>
                            <comment id="17011744" author="benedict" created="Thu, 9 Jan 2020 12:04:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;Fwiw, the proposed fast log code does improve performance of my local modifications when benchmarked but basically brings it back inline w/ the existing implementation (caveat: benchmarking issues already mentioned).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Achieving equivalent performance in this synthetic benchmark is pretty much all we need, I think. This should predict a strict performance win once memory latency is taken into account, as our largest such array is ~1.2KiB, with 150 elements, leading to a predicted 5 memory stalls for binary search - although execution will proceed speculatively and may mask one or so of those stalls. If the approximation can achieve an optimal 1 memory stall in the worst case, with similar performance when the entire structure is in cache, it&#8217;s a win in my book.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;would result in several cases where a linear search would lead to over 10-50 accesses&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Interesting, I&#8217;m not sure what&#8217;s happening in that case. For comparison, I ran the code below&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;[] offsets = newOffsets(160, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0 ; i &amp;lt; offsets.length ; ++i)
{
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; start = i == 0 ? 0 : offsets[i - 1] + 1;
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; end = offsets[i];
    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.printf(&lt;span class=&quot;code-quote&quot;&gt;&quot;%d %d %d %d %.1f %.1f %.1f %.1f\n&quot;&lt;/span&gt;, i, end, (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)fastLog12(start) - i, (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)fastLog12(end) - i, fastLog12(start), fastLog12(end), slowLog12(start), slowLog12(end));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Which yields the below results, with columns:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;The index in the offsets array&lt;/li&gt;
	&lt;li&gt;The value associated with the bucket&lt;/li&gt;
	&lt;li&gt;The integer difference between fastLog(lowest) and this offset, where lowest is the smallest value we want to bucket at this offset&lt;/li&gt;
	&lt;li&gt;This integer difference between fastLog(highest)&lt;/li&gt;
	&lt;li&gt;fastLog(lowest)&lt;/li&gt;
	&lt;li&gt;fastLog(highest)&lt;/li&gt;
	&lt;li&gt;slowLog(lowest)&lt;/li&gt;
	&lt;li&gt;slowLog(highest)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;It looks to me like the approximation is always within precisely 2 or 3 of the offset, but &lt;em&gt;ahead&lt;/em&gt; by 2 or 3, because the array doesn&#8217;t follow a strict 1.2 logarithm given the first few buckets must increment by whole integers. So for values &amp;gt; 2, we can subtract 3 before walking forwards at most 1, incurring only a single memory stall. If we wanted to be really clever this could be implemented branchlessly, so that this memory latency wouldn&#8217;t pause further execution, or invalidate the pipeline, only consume some reorder buffer slots and register file entries.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
0 0 0 0 0.0 0.0 -Infinity -Infinity
1 1 -1 -1 0.0 0.0 0.0 0.0
2 2 1 1 3.8 3.8 3.8 3.8
3 3 3 3 6.0 6.0 6.0 6.0
4 4 3 3 7.6 7.6 7.6 7.6
5 5 3 3 8.8 8.8 8.8 8.8
6 6 3 3 9.8 9.8 9.8 9.8
7 7 3 3 10.7 10.7 10.7 10.7
8 8 3 3 11.4 11.4 11.4 11.4
9 10 3 3 12.1 12.6 12.1 12.6
10 12 3 3 13.2 13.6 13.2 13.6
11 14 3 3 14.1 14.5 14.1 14.5
12 17 2 3 14.9 15.5 14.9 15.5
13 20 2 3 15.9 16.4 15.9 16.4
14 24 2 3 16.7 17.4 16.7 17.4
15 29 2 3 17.7 18.5 17.7 18.5
16 35 2 3 18.7 19.3 18.7 19.5
17 42 2 3 19.7 20.5 19.7 20.5
18 50 2 3 20.5 21.5 20.6 21.5
19 60 2 3 21.5 22.5 21.6 22.5
20 72 2 3 22.5 23.5 22.5 23.5
21 86 2 3 23.5 24.3 23.5 24.4
22 103 2 3 24.3 25.3 24.5 25.4
23 124 2 3 25.5 26.4 25.5 26.4
24 149 2 3 26.4 27.3 26.5 27.4
25 179 2 3 27.3 28.4 27.5 28.5
26 215 2 3 28.4 29.3 28.5 29.5
27 258 2 3 29.5 30.4 29.5 30.5
28 310 2 3 30.4 31.4 30.5 31.5
29 372 2 3 31.4 32.4 31.5 32.5
30 446 2 3 32.4 33.3 32.5 33.5
31 535 2 3 33.3 34.2 33.5 34.5
32 642 2 3 34.2 35.4 34.5 35.5
33 770 2 3 35.4 36.4 35.5 36.5
34 924 2 3 36.4 37.3 36.5 37.5
35 1109 2 3 37.3 38.4 37.5 38.5
36 1331 2 3 38.4 39.2 38.5 39.5
37 1597 2 3 39.2 40.2 39.5 40.5
38 1916 2 3 40.2 41.3 40.5 41.5
39 2299 2 3 41.3 42.2 41.5 42.5
40 2759 2 3 42.2 43.3 42.5 43.5
41 3311 2 3 43.3 44.3 43.5 44.5
42 3973 2 3 44.3 45.4 44.5 45.5
43 4768 2 3 45.4 46.3 45.5 46.5
44 5722 2 3 46.3 47.4 46.5 47.5
45 6866 2 3 47.4 48.3 47.5 48.5
46 8239 2 3 48.3 49.4 48.5 49.5
47 9887 2 3 49.4 50.4 49.5 50.5
48 11864 2 3 50.4 51.4 50.5 51.5
49 14237 2 3 51.4 52.3 51.5 52.5
50 17084 2 3 52.3 53.2 52.5 53.5
51 20501 2 3 53.2 54.4 53.5 54.5
52 24601 2 3 54.4 55.4 54.5 55.5
53 29521 2 3 55.4 56.3 55.5 56.5
54 35425 2 3 56.3 57.4 56.5 57.5
55 42510 2 3 57.4 58.3 57.5 58.5
56 51012 2 3 58.3 59.3 58.5 59.5
57 61214 2 3 59.3 60.3 59.5 60.5
58 73457 2 3 60.3 61.2 60.5 61.5
59 88148 2 3 61.2 62.3 61.5 62.5
60 105778 2 3 62.3 63.3 62.5 63.5
61 126934 2 3 63.3 64.3 63.5 64.5
62 152321 2 3 64.3 65.3 64.5 65.5
63 182785 2 3 65.3 66.4 65.5 66.5
64 219342 2 3 66.4 67.3 66.5 67.5
65 263210 2 3 67.3 68.4 67.5 68.5
66 315852 2 3 68.4 69.4 68.5 69.5
67 379022 2 3 69.4 70.4 69.5 70.5
68 454826 2 3 70.4 71.3 70.5 71.5
69 545791 2 3 71.3 72.2 71.5 72.5
70 654949 2 3 72.2 73.2 72.5 73.5
71 785939 2 3 73.2 74.2 73.5 74.5
72 943127 2 3 74.2 75.3 74.5 75.5
73 1131752 2 3 75.3 76.4 75.5 76.5
74 1358102 2 3 76.4 77.3 76.5 77.5
75 1629722 2 3 77.3 78.3 77.5 78.5
76 1955666 2 3 78.3 79.3 78.5 79.5
77 2346799 2 3 79.3 80.2 79.5 80.5
78 2816159 2 3 80.2 81.3 80.5 81.5
79 3379391 2 3 81.3 82.3 81.5 82.5
80 4055269 2 3 82.3 83.3 82.5 83.5
81 4866323 2 3 83.3 84.3 83.5 84.5
82 5839588 2 3 84.3 85.4 84.5 85.5
83 7007506 2 3 85.4 86.3 85.5 86.5
84 8409007 2 3 86.3 87.4 86.5 87.5
85 10090808 2 3 87.4 88.4 87.5 88.5
86 12108970 2 3 88.4 89.4 88.5 89.5
87 14530764 2 3 89.4 90.3 89.5 90.5
88 17436917 2 3 90.3 91.2 90.5 91.5
89 20924300 2 3 91.2 92.2 91.5 92.5
90 25109160 2 3 92.2 93.2 92.5 93.5
91 30130992 2 3 93.2 94.3 93.5 94.5
92 36157190 2 3 94.3 95.4 94.5 95.5
93 43388628 2 3 95.4 96.3 95.5 96.5
94 52066354 2 3 96.3 97.3 96.5 97.5
95 62479625 2 3 97.3 98.3 97.5 98.5
96 74975550 2 3 98.3 99.2 98.5 99.5
97 89970660 2 3 99.2 100.3 99.5 100.5
98 107964792 2 3 100.3 101.3 100.5 101.5
99 129557750 2 3 101.3 102.3 101.5 102.5
100 155469300 2 3 102.3 103.3 102.5 103.5
101 186563160 2 3 103.3 104.4 103.5 104.5
102 223875792 2 3 104.4 105.3 104.5 105.5
103 268650950 2 3 105.3 106.4 105.5 106.5
104 322381140 2 3 106.4 107.4 106.5 107.5
105 386857368 2 3 107.4 108.4 107.5 108.5
106 464228842 2 3 108.4 109.3 108.5 109.5
107 557074610 2 3 109.3 110.3 109.5 110.5
108 668489532 2 3 110.3 111.2 110.5 111.5
109 802187438 2 3 111.2 112.2 111.5 112.5
110 962624926 2 3 112.2 113.3 112.5 113.5
111 1155149911 2 3 113.3 114.4 113.5 114.5
112 1386179893 2 3 114.4 115.3 114.5 115.5
113 1663415872 2 3 115.3 116.3 115.5 116.5
114 1996099046 2 3 116.3 117.3 116.5 117.5
115 2395318855 2 3 117.3 118.2 117.5 118.5
116 2874382626 2 3 118.2 119.3 118.5 119.5
117 3449259151 2 3 119.3 120.3 119.5 120.5
118 4139110981 2 3 120.3 121.3 120.5 121.5
119 4966933177 2 3 121.3 122.3 121.5 122.5
120 5960319812 2 3 122.3 123.4 122.5 123.5
121 7152383774 2 3 123.4 124.3 123.5 124.5
122 8582860529 2 3 124.3 125.3 124.5 125.5
123 10299432635 2 3 125.3 126.4 125.5 126.5
124 12359319162 2 3 126.4 127.4 126.5 127.5
125 14831182994 2 3 127.4 128.3 127.5 128.5
126 17797419593 2 3 128.3 129.3 128.5 129.5
127 21356903512 2 3 129.3 130.2 129.5 130.5
128 25628284214 2 3 130.2 131.3 130.5 131.5
129 30753941057 2 3 131.3 132.3 131.5 132.5
130 36904729268 2 3 132.3 133.4 132.5 133.5
131 44285675122 2 3 133.4 134.3 133.5 134.5
132 53142810146 2 3 134.3 135.3 134.5 135.5
133 63771372175 2 3 135.3 136.3 135.5 136.5
134 76525646610 2 3 136.3 137.2 136.5 137.5
135 91830775932 2 3 137.2 138.4 137.5 138.5
136 110196931118 2 3 138.4 139.3 138.5 139.5
137 132236317342 2 3 139.3 140.3 139.5 140.5
138 158683580810 2 3 140.3 141.3 140.5 141.5
139 190420296972 2 3 141.3 142.4 141.5 142.5
140 228504356366 2 3 142.4 143.3 142.5 143.5
141 274205227639 2 3 143.3 144.3 143.5 144.5
142 329046273167 2 3 144.3 145.4 144.5 145.5
143 394855527800 2 3 145.4 146.2 145.5 146.5
144 473826633360 2 3 146.2 147.3 146.5 147.5
145 568591960032 2 3 147.3 148.3 147.5 148.5
146 682310352038 2 3 148.3 149.2 148.5 149.5
147 818772422446 2 3 149.2 150.3 149.5 150.5
148 982526906935 2 3 150.3 151.3 150.5 151.5
149 1179032288322 2 3 151.3 152.4 151.5 152.5
150 1414838745986 2 3 152.4 153.3 152.5 153.5
151 1697806495183 2 3 153.3 154.3 153.5 154.5
152 2037367794220 2 3 154.3 155.3 154.5 155.5
153 2444841353064 2 3 155.3 156.2 155.5 156.5
154 2933809623677 2 3 156.2 157.4 156.5 157.5
155 3520571548412 2 3 157.4 158.3 157.5 158.5
156 4224685858094 2 3 158.3 159.3 158.5 159.5
157 5069623029713 2 3 159.3 160.3 159.5 160.5
158 6083547635656 2 3 160.3 161.4 160.5 161.5
159 7300257162787 2 3 161.4 162.3 161.5 162.5
160 8760308595344 2 3 162.3 163.3 162.5 163.5
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17011774" author="benedict" created="Thu, 9 Jan 2020 12:38:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;It looks to me like the approximation is always within precisely 2 or 3 of the offset&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;FWIW, this appears to hold just fine up to &lt;tt&gt;long&lt;/tt&gt; overflow&lt;/p&gt;</comment>
                            <comment id="17011952" author="jrwest" created="Thu, 9 Jan 2020 15:31:33 +0000"  >&lt;p&gt;Ok I figured out what was going on. My linked test was generating only large values and the approximation of only the last bucket is very inaccurate as value grows but also easy to account for. Fixing this the test confirms your findings (sometimes I see a distance of 4 indexes but still a huge improvement):&lt;/p&gt;

&lt;p&gt;Sample from 10k test run:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
model = 80, estimate = 83
model = 83, estimate = 86
model = 81, estimate = 84
model = 82, estimate = 85
model = 69, estimate = 72
model = 79, estimate = 82
model = 81, estimate = 84
model = 79, estimate = 82
model = 75, estimate = 79
model = 83, estimate = 86
model = 77, estimate = 81
model = 72, estimate = 75
model = 84, estimate = 88
model = 61, estimate = 64
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17012063" author="benedict" created="Thu, 9 Jan 2020 17:32:44 +0000"  >&lt;p&gt;It might be the difference is whether or not we&apos;re including a zero bucket?  Because the fixed offset we use probably needs to be incremented by one in this case, since there&apos;s no logarithm of zero.&lt;/p&gt;

&lt;p&gt;edit: yep, confirmed that if I pass &lt;tt&gt;false&lt;/tt&gt; I get values of 3 or 4.&lt;/p&gt;</comment>
                            <comment id="17012330" author="jrwest" created="Fri, 10 Jan 2020 00:41:43 +0000"  >&lt;p&gt;My working branch is here:&#160;&lt;a href=&quot;https://github.com/jrwest/cassandra/tree/jwest/15213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jrwest/cassandra/tree/jwest/15213&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve implemented the binary search replacement. Didn&apos;t make an attempt at going branchless but even as implemented its faster than the existing implementation. Working on the striping / replacement of &lt;tt&gt;LongAdder[]&lt;/tt&gt; and will share when ready.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Trunk:


     [java] Benchmark &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Mode&#160; Cnt &#160; &#160; &#160; &#160; Score &#160; &#160; &#160; &#160; Error&#160; Units
     [java] LatencyTrackingBench.benchInsertToDEHR &#160; &#160; &#160; &#160; thrpt&#160; &#160; 5&#160; 21887453.678 &#177; 2108481.285&#160; ops/s
&#160;&#160; &#160; [java] LatencyTrackingBench.benchLatencyMetricsWrite&#160; thrpt&#160; &#160; 5 &#160; 8908817.316 &#177;&#160; 115453.642&#160; ops/s


15213 (linear search changes only):


&#160;&#160; &#160; [java] Benchmark &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Mode&#160; Cnt &#160; &#160; &#160; &#160; Score &#160; &#160; &#160; &#160; Error&#160; Units
&#160;&#160; &#160; [java] LatencyTrackingBench.benchInsertToDEHR &#160; &#160; &#160; &#160; thrpt&#160; &#160; 5&#160; 24646022.304 &#177; 1052105.818&#160; ops/s
&#160;&#160; &#160; [java] LatencyTrackingBench.benchLatencyMetricsWrite&#160; thrpt&#160; &#160; 5 &#160; 9175928.594 &#177;&#160; 269984.204&#160; ops/s
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17012390" author="benedict" created="Fri, 10 Jan 2020 02:02:59 +0000"  >&lt;p&gt;Looking good.  A couple of minor suggestions:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;The &lt;tt&gt;value &amp;lt;= 0&lt;/tt&gt; check can be moved inside of the &lt;tt&gt;value &amp;lt;= 8&lt;/tt&gt; check, since both will rarely be performed&lt;/li&gt;
	&lt;li&gt;Can &lt;tt&gt;(int) value - (bucketOffsets&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt; == 0 ? 0 : 1)&lt;/tt&gt; be simplified to &lt;tt&gt;(int) value - bucketOffsets&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;&lt;/tt&gt; ?&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;value &amp;gt; bucketOffsets&lt;span class=&quot;error&quot;&gt;&amp;#91;bucketOffsets.length - 1&amp;#93;&lt;/span&gt;&lt;/tt&gt; could be replaced by (e.g.) &lt;tt&gt;firstCandidate = min(firstCandidate,bucketOffsets.length-2)&lt;/tt&gt;, which only requires touching the already-used header portion of the array, avoiding one potential cache-miss (though not one measured on the existing benchmarks I expect).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;As it stands, I think in the normal course of execution it&apos;s already reasonable to expect no mispredicted branches in the implementation you&apos;ve put up, and these tweaks should improve the situation a little.  I think it&apos;s fairly likely the final pair of return statements will be implemented as a &lt;tt&gt;cmov&lt;/tt&gt;, but it would be interesting to take a look at the final assembly.  When we have a final product maybe we can take a look.&lt;/p&gt;</comment>
                            <comment id="17012511" author="jrwest" created="Fri, 10 Jan 2020 07:04:02 +0000"  >&lt;p&gt;I&apos;ve updated&#160;&lt;a href=&quot;https://github.com/jrwest/cassandra/tree/jwest/15213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jrwest/cassandra/tree/jwest/15213&lt;/a&gt;&#160;with the changes you suggested. Regarding the extra bucket, I realized that even more simply we could return &lt;tt&gt;bucketOffsets.length&lt;/tt&gt; if the estimate is greater than or equal to it &#8211; saving us an access in this case altogether.&#160;&lt;/p&gt;

&lt;p&gt;Also added a very simple striping approach &amp;#8211; without any attempts at distributed the buckets more uniformly. The performance is about the same (the runs are within each others&apos; margin of error) and still significantly better than before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14281&quot; title=&quot;Improve LatencyMetrics performance by reducing write path processing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14281&quot;&gt;&lt;del&gt;CASSANDRA-14281&lt;/del&gt;&lt;/a&gt;. From the memory consumption perspective, however, 4 stripes ends up allocating more than 12MiB after startup. This isn&apos;t surprising because with a single stripe (or pre &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14281&quot; title=&quot;Improve LatencyMetrics performance by reducing write path processing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14281&quot;&gt;&lt;del&gt;CASSANDRA-14281&lt;/del&gt;&lt;/a&gt;) after startup was a little more than 3MiB and we&apos;re quadrupling the size of each array. &#160;However, these won&apos;t grow under contention like &lt;tt&gt;LongAdder[]&lt;/tt&gt; would: memory consumption is on the order of the number of histograms created not number created and contention as before. I&apos;ve found comparable performance using 2 stripes on my 4 core machine. I have an 8 core available to me I can test with tomorrow. If the memory consumption is still a concern I can investigate on-demand striping but I prefer the simpler approach and think the trade-offs of 2-4 stripes is reasonable.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&#160;3.0 (4 core):
&#160;&#160; &#160; [java] Benchmark &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Mode&#160; Cnt&#160; &#160; &#160; &#160; Score&#160; &#160; &#160; &#160; Error&#160; Units
&#160;&#160; &#160; [java] LatencyTrackingBench.benchInsertToDEHR &#160; &#160; &#160; &#160; thrpt&#160; &#160; 5&#160; 5848504.963 &#177; 147881.511&#160; ops/s
&#160;&#160; &#160; [java] LatencyTrackingBench.benchLatencyMetricsWrite&#160; thrpt&#160; &#160; 5&#160; 1946154.537 &#177; 623185.290&#160; ops/s


Trunk (4 core)


&#160;&#160; &#160; [java] Benchmark &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Mode&#160; Cnt &#160; &#160; &#160; &#160; Score &#160; &#160; &#160; &#160; Error&#160; Units
&#160;&#160; &#160; [java] LatencyTrackingBench.benchInsertToDEHR &#160; &#160; &#160; &#160; thrpt&#160; &#160; 5&#160; 21887453.678 &#177; 2108481.285&#160; ops/s
&#160;&#160; &#160; [java] LatencyTrackingBench.benchLatencyMetricsWrite&#160; thrpt&#160; &#160; 5 &#160; 8908817.316 &#177;&#160; 115453.642&#160; ops/s


15213 (4 core, linear search changes only):


&#160;&#160; &#160; [java] Benchmark &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Mode&#160; Cnt &#160; &#160; &#160; &#160; Score &#160; &#160; &#160; &#160; Error&#160; Units
&#160;&#160; &#160; [java] LatencyTrackingBench.benchInsertToDEHR &#160; &#160; &#160; &#160; thrpt&#160; &#160; 5&#160; 24646022.304 &#177; 1052105.818&#160; ops/s
&#160;&#160; &#160; [java] LatencyTrackingBench.benchLatencyMetricsWrite&#160; thrpt&#160; &#160; 5 &#160; 9175928.594 &#177;&#160; 269984.204&#160; ops/s




15213 (4 core, 4 stripes, striping and linear search):


[java] Benchmark &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Mode&#160; Cnt &#160; &#160; &#160; &#160; Score&#160; &#160; &#160; &#160; Error&#160; Units
&#160;&#160; &#160; [java] LatencyTrackingBench.benchInsertToDEHR &#160; &#160; &#160; &#160; thrpt&#160; &#160; 5&#160; 18818181.576 &#177; 506997.366&#160; ops/s
&#160;&#160; &#160; [java] LatencyTrackingBench.benchLatencyMetricsWrite&#160; thrpt&#160; &#160; 5 &#160; 8895569.814 &#177; 154219.113&#160; ops/s


 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17013139" author="benedict" created="Fri, 10 Jan 2020 18:43:32 +0000"  >&lt;p&gt;I&apos;m inclined to agree that a simple approach is best, and simply offering a tunable parameter to modify the number of stripes on startup might be sufficient.  Here&apos;s some further minor feedback/suggestions:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;It&apos;s faster to use &lt;tt&gt;addAndGet&lt;/tt&gt; than &lt;tt&gt;compareAndSet&lt;/tt&gt; because it&apos;s guaranteed to succeed - the increment occurs whilst holding the cache line in an exclusive state, so it will always execute as quickly as the first failed &lt;tt&gt;compareAndSet&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Combined with this, it probably makes most sense to pick a &quot;random&quot; bucket using e.g. &lt;tt&gt;Thread.currentThread().getId() &amp;amp; (stripes-1)&lt;/tt&gt;, to always increment&lt;/li&gt;
	&lt;li&gt;Finally, it might make sense to &quot;shuffle&quot; the ordinary buckets as well, so that logically adjacent buckets are not spatially adjacent; since a histogram is &lt;em&gt;likely&lt;/em&gt; to receive updates to mostly oscillating around a given median point, this means there won&apos;t be any false-sharing competition between two updates to two logically adjacent buckets&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I think at this point it then makes most sense to improve the benchmarks, in one case to account for memory latency of lookup, and in another to produce more realistic distributions of values.&lt;/p&gt;</comment>
                            <comment id="17014661" author="jrwest" created="Mon, 13 Jan 2020 21:27:15 +0000"  >&lt;p&gt;Using &lt;tt&gt;addAndGet&lt;/tt&gt; I see performance comparable to 3.0 and prior to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14281&quot; title=&quot;Improve LatencyMetrics performance by reducing write path processing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14281&quot;&gt;&lt;del&gt;CASSANDRA-14281&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
15213 (4 core, 4 stripes, striping &amp;amp; linear search, addAndGet):

     [java] Benchmark                                       Mode  Cnt        Score        Error  Units
     [java] LatencyTrackingBench.benchInsertToDEHR         thrpt    5  5742550.865 &#177; 256043.651  ops/s
     [java] LatencyTrackingBench.benchLatencyMetricsWrite  thrpt    5  1979885.731 &#177; 117381.276  ops/s

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is how I implemented update bucket in case I missed something&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void updateBucket(AtomicLongArray buckets, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; value)
    {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; stripe = (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) (&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getId() &amp;amp; (nStripes - 1));
        buckets.addAndGet(stripedIndex(index, stripe), value);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17014686" author="benedict" created="Mon, 13 Jan 2020 21:53:47 +0000"  >&lt;p&gt;Interesting.  I get:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
addAndGet
# Run progress: 0.00% complete, ETA 00:00:13
# Fork: 1 of 1
# Warmup Iteration   1: 39047588.027 ops/s
# Warmup Iteration   2: 42432555.911 ops/s
# Warmup Iteration   3: 42290231.202 ops/s
Iteration   1: 42252484.876 ops/s
Iteration   2: 41715818.895 ops/s
Iteration   3: 40307394.422 ops/s
Iteration   4: 40383945.073 ops/s
Iteration   5: 38825162.703 ops/s


Result &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.cassandra.test.microbench.LatencyTrackingBench.benchInsertToDEHR&quot;&lt;/span&gt;:
  40696961.194 &#177;(99.9%) 5170160.207 ops/s [Average]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
compareAndSet
# Run progress: 0.00% complete, ETA 00:00:13
# Fork: 1 of 1
# Warmup Iteration   1: 18926088.938 ops/s
# Warmup Iteration   2: 19504293.182 ops/s
# Warmup Iteration   3: 19261074.598 ops/s
Iteration   1: 19399456.839 ops/s
Iteration   2: 18979470.788 ops/s
Iteration   3: 18720138.076 ops/s
Iteration   4: 18458839.475 ops/s
Iteration   5: 18776539.883 ops/s


Result &lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.cassandra.test.microbench.LatencyTrackingBench.benchInsertToDEHR&quot;&lt;/span&gt;:
  18866889.012 &#177;(99.9%) 1351167.820 ops/s [Average]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;i.e. twice the throughput with &lt;tt&gt;addAndGet&lt;/tt&gt;. There is no material difference to my version:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void updateBucket(AtomicLongArray buckets, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; index, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; value)
    {
        index = stripedIndex(index, (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getId() &amp;amp; (nStripes - 1));
        buckets.addAndGet(index, value);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It&apos;s possible it&apos;s an issue of JDK?  Perhaps yours is not replacing &lt;tt&gt;addAndGet&lt;/tt&gt; with the relevant &lt;tt&gt;lock xadd&lt;/tt&gt; assembly?  This seems pretty unlikely, I think this has happened for a long time, but you could try looking at the assembly that&apos;s produced.&lt;/p&gt;</comment>
                            <comment id="17014704" author="benedict" created="Mon, 13 Jan 2020 22:31:59 +0000"  >&lt;p&gt;Just to reiterate, though, it&apos;s still not a great test, and it might be worthwhile improving it first.  Ideally we would have tighter control on the amount of competition we&apos;re measuring, since that&apos;s what we&apos;re interested in.  We probably also do not want to visit the same values in the same order for every invocation, as this can lead to increased synchrony in execution lowering overall throughput artificially.  We also probably &lt;em&gt;do&lt;/em&gt; want to use the same random sequence on each run, to improve reproducibility.&lt;/p&gt;</comment>
                            <comment id="17014713" author="jrwest" created="Mon, 13 Jan 2020 22:54:46 +0000"  >&lt;p&gt;PEBKAC. I was rushing to run the bm between meetings and used the wrong branch. I am able to reproduce your numbers: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
     [java] Benchmark                                       Mode  Cnt         Score         Error  Units
     [java] LatencyTrackingBench.benchInsertToDEHR         thrpt    5  39263498.481 &#177; 1809260.330  ops/s
     [java] LatencyTrackingBench.benchLatencyMetricsWrite  thrpt    5  10473724.356 &#177;  137670.100  ops/s

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;EDIT: I agree re: an improved benchmark but its encouraging we are seeing improved performance and memory usage with the test we have and this branch. &lt;/p&gt;</comment>
                            <comment id="17014715" author="benedict" created="Mon, 13 Jan 2020 22:56:45 +0000"  >&lt;p&gt;&amp;gt; but its encouraging we are seeing improved performance and memory usage with the test we have and this branch&lt;/p&gt;

&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Yep, it&apos;s looking really promising.&lt;/p&gt;</comment>
                            <comment id="17014718" author="jrwest" created="Mon, 13 Jan 2020 23:03:15 +0000"  >&lt;p&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_up.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;ll add the configurable stripe count and look more into bucket distribution as well as better benchmarking&lt;/p&gt;</comment>
                            <comment id="17015512" author="benedict" created="Wed, 15 Jan 2020 00:11:36 +0000"  >&lt;p&gt;fwiw, wrt bucket distribution, we should be able to do something as simple as multiplying by the smallest prime larger than two cache-lines (when multiplied by 8), that doesn&apos;t also divide the number of buckets. i.e., 17 (with verification it doesn&apos;t divide a custom number of buckets, and choosing another prime if it does)&lt;/p&gt;

&lt;p&gt;i.e. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
stripedIndex(index, stripe) = ((index * prime) % (bucketOffsets.length + 1)) + ((bucketOffsets.length + 1) * stripe)
or
stripedIndex(index, stripe) = (((index * nStripes + stripe) * prime) % buckets.length())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17016055" author="jrwest" created="Wed, 15 Jan 2020 14:51:37 +0000"  >&lt;p&gt;Thanks. I&apos;ll start exploring that approach. I implemented a version using &lt;tt&gt;Integer.reverse&lt;/tt&gt; (which distributed well) but didn&apos;t find an approach using it that didn&apos;t involve an extra read/load (was looking for something more along the lines of a simple calculation like this). Will report back with my testing results / findings. &lt;/p&gt;
</comment>
                            <comment id="17016070" author="benedict" created="Wed, 15 Jan 2020 15:12:47 +0000"  >&lt;p&gt;Also fwiw, it looks like the primes 17 and 19 are sufficient, so we can literally just try either of those. Proof:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[] primes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;[] { 17, 19 };
        BitSet sizeWithoutConflict = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BitSet();
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; prime : primes)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; size = 1 ; size &amp;lt; 238 ; ++size)
            {
                BitSet conflict = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BitSet();
                &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; hasConflict = &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0 ; i &amp;lt; size ; ++i)
                {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (conflict.get((i * prime) % size))
                        hasConflict = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
                    conflict.set((i * prime) % size);
                }
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!hasConflict)
                    sizeWithoutConflict.set(size);
            }
        }
        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; size = 1 ; size &amp;lt; 238 ; ++size)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!sizeWithoutConflict.get(size))
                &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.println(size);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17016076" author="jrwest" created="Wed, 15 Jan 2020 15:18:59 +0000"  >&lt;p&gt;Sounds good. Thanks for the test / proof. &lt;/p&gt;</comment>
                            <comment id="17016077" author="benedict" created="Wed, 15 Jan 2020 15:19:18 +0000"  >&lt;p&gt;Except if we use the cleaner &lt;tt&gt;stripedIndex&lt;/tt&gt; calculation, we might need to go up to e.g. 8x stripes, in which case we&apos;d need to throw &lt;tt&gt;23&lt;/tt&gt; into the mix.  That seems to take us up to 16x, with &lt;tt&gt;29&lt;/tt&gt; taking us all the way to 64, which is way over provisioning stripes.&lt;/p&gt;</comment>
                            <comment id="17026466" author="jrwest" created="Thu, 30 Jan 2020 06:42:04 +0000"  >&lt;p&gt;Pushed an update to the branch that includes prime distribution&lt;/p&gt;</comment>
                            <comment id="17026615" author="benedict" created="Thu, 30 Jan 2020 11:45:53 +0000"  >&lt;p&gt;Awesome.  I think we&apos;re ready.  I&apos;ve pushed one last set of minor suggestions, that &lt;em&gt;should&lt;/em&gt; permit C2 to produce branchless code for the calculation, at the expense only of values 0 through 8 being slower to compute (since these are likely extremely uncommon, this is probably preferable).  I think it would still be possible to reduce the total work by a few instructions with some time to think, but probably not worth it.&lt;/p&gt;

&lt;p&gt;Entirely up to you if you prefer to use this suggestion, as it&apos;s not particularly important, and it&apos;s very hard to objectively determine the effect (since it will depend on branch predictor pollution).  Once you&apos;ve decided, I&apos;ll get this committed.&lt;/p&gt;</comment>
                            <comment id="17026770" author="jrwest" created="Thu, 30 Jan 2020 15:40:05 +0000"  >&lt;p&gt;Incorporated your change, rebased/squashed, and pushed. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/jrwest/cassandra/tree/jwest/15213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch &lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/jrwest/cassandra/tree/jwest%2F15213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tests &lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17031972" author="jrwest" created="Thu, 6 Feb 2020 21:55:54 +0000"  >&lt;p&gt;Was asked to run tlp-stress against this branch. After several runs I think at the cluster level its pretty much a wash between this branch and trunk (except the memory savings of this branch ofc). Added the output from one of the runs if folks want to look closer. Its worth noting: this was pretty small / limited hardware.&lt;/p&gt;

&lt;p&gt;Workload:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./bin/tlp-stress run KeyValue --populate 500k --partitions 1m --threads 4 \
--replication &lt;span class=&quot;code-quote&quot;&gt;&quot;{&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;NetworkTopologyStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;DC1&apos;&lt;/span&gt;: 3 }&quot;&lt;/span&gt; \
--duration 1h --username $CUSER --password $CPASS \
--host $HOST
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17039092" author="benedict" created="Tue, 18 Feb 2020 13:46:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt; we discussed (somewhere) maybe reducing the default value to 2, at least initially?  I don&apos;t mind using 4, but I think doubling the memory we use here is probably a good first stab at balancing improvement for larger users (who are ordinarily better able to reconfigure) against the cost for users with smaller nodes?&lt;/p&gt;

&lt;p&gt;Also, patch message formatting norms sign off:&lt;/p&gt;

&lt;p&gt;patch by A, B; reviewed by C, D for CASSANDRA-XXXXX&lt;/p&gt;

&lt;p&gt;This is particularly helpful if using awk for analysis, since this is the only standard we&apos;ve ever followed almost consistently, so it&apos;s helpful to retain it.&lt;/p&gt;

&lt;p&gt;Otherwise LGTM&lt;/p&gt;</comment>
                            <comment id="17039297" author="jrwest" created="Tue, 18 Feb 2020 17:59:57 +0000"  >&lt;p&gt;Updated the default and the commit message. &lt;a href=&quot;https://github.com/jrwest/cassandra/commits/jwest/15213&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13608569">CASSANDRA-20333</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13141517">CASSANDRA-14281</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12992809" name="15213-perf-branch" size="214505" author="jwest" created="Thu, 6 Feb 2020 21:54:03 +0000"/>
                            <attachment id="12992810" name="15213-perf-trunk" size="214577" author="jwest" created="Thu, 6 Feb 2020 21:54:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jwest]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12997" cascade-level="1"><![CDATA[Performance Bug/Regression]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12977"><![CDATA[Adhoc Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 39 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04pig:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
        <customfieldvalue><![CDATA[jwest]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12346093">4.0-alpha</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314136" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/adc3cdde2ae2a78f7d2bb66da47a07545d3e06cf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;adc3cdde2ae2a78f7d2bb66da47a07545d3e06cf&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Existing microbenchmarks, new cluster benchmarks, quick theories tests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>