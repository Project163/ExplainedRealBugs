<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:47:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7808] LazilyCompactedRow incorrectly handles row tombstones</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7808</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;LazilyCompactedRow doesn&#8217;t handle row tombstones correctly, leading to an AssertionError (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4206&quot; title=&quot;AssertionError: originally calculated column size of 629444349 but now it is 588008950&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4206&quot;&gt;&lt;del&gt;CASSANDRA-4206&lt;/del&gt;&lt;/a&gt;) in some cases, and the row tombstone being incorrectly dropped in others. It looks like this was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5677&quot; title=&quot;Performance improvements of RangeTombstones/IntervalTree&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5677&quot;&gt;&lt;del&gt;CASSANDRA-5677&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;To reproduce an AssertionError:&lt;/p&gt;

&lt;p&gt;1. Hack a really small return value for DatabaseDescriptor.getInMemoryCompactionLimit() like 10 bytes to force large row compaction&lt;br/&gt;
2. Create a column family with gc_grace = 10&lt;br/&gt;
3. Insert a few columns in one row&lt;br/&gt;
4. Call nodetool flush&lt;br/&gt;
5. Delete the row&lt;br/&gt;
6. Call nodetool flush&lt;br/&gt;
7. Wait 10 seconds&lt;br/&gt;
8. Call nodetool compact and it will fail&lt;/p&gt;

&lt;p&gt;To reproduce the row tombstone being dropped, do the same except, after the delete (in step 5), insert a column that sorts before the ones you inserted in step 3. E.g. if you inserted b, c, d in step 3, insert a now. After the compaction, which now succeeds, the full row will be visible, rather than just a.&lt;/p&gt;

&lt;p&gt;The problem is two fold. Firstly, LazilyCompactedRow.Reducer.reduce() and getReduce() incorrectly call container.clear(). This clears the columns (as intended) but also removes the deletion times from container. This means no further columns are deleted if they are annihilated by the row tombstone.&lt;/p&gt;

&lt;p&gt;Secondly, after the second pass, LazilyCompactedRow.isEmpty() is called which calls&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ColumnFamilyStore.removeDeletedCF(emptyColumnFamily, controller.gcBefore(key.getToken()))&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;which unfortunately removes the last deleted time from emptyColumnFamily if it is earlier than gcBefore. Since this is only called after the second pass, the second pass doesn&#8217;t remove any columns that are removed by the row tombstone whereas the first pass removes just the first one.&lt;/p&gt;

&lt;p&gt;This is pretty serious - no large rows can ever be compacted and row tombstones can go missing.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12735615">CASSANDRA-7808</key>
            <summary>LazilyCompactedRow incorrectly handles row tombstones</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="richardlow">Richard Low</assignee>
                                    <reporter username="rlow">Richard Low</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Aug 2014 00:40:42 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:36 +0000</updated>
                            <resolved>Tue, 26 Aug 2014 14:20:41 +0000</resolved>
                                        <fixVersion>1.2.19</fixVersion>
                    <fixVersion>2.0.11</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="14104877" author="rlow" created="Thu, 21 Aug 2014 00:46:10 +0000"  >&lt;p&gt;I attached a patch which I think fixes this.&lt;/p&gt;</comment>
                            <comment id="14104889" author="jbellis" created="Thu, 21 Aug 2014 00:57:59 +0000"  >&lt;p&gt;If the problem is incorrectly clearing, how did 5677 introduce it?&lt;/p&gt;</comment>
                            <comment id="14104910" author="yukim" created="Thu, 21 Aug 2014 01:25:34 +0000"  >&lt;p&gt;5677 changed behavior of ColumnFamily#clear to reset deletion time.&lt;br/&gt;
Note that this is fixed for version 2.0.4+ by &lt;a href=&quot;https://github.com/apache/cassandra/commit/3edb62bf773617aeb3a348edc5667a6b0bad0ffe#diff-8e8166c7f203deb8f4c5fe0124809837&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this commit&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14105018" author="rlow" created="Thu, 21 Aug 2014 04:18:10 +0000"  >&lt;p&gt;Sorry, I got my scope wrong. The AssertionError is likely caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5677&quot; title=&quot;Performance improvements of RangeTombstones/IntervalTree&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5677&quot;&gt;&lt;del&gt;CASSANDRA-5677&lt;/del&gt;&lt;/a&gt; but the clearing in the Reducer existed a long time before that.&lt;/p&gt;</comment>
                            <comment id="14110638" author="krummas" created="Tue, 26 Aug 2014 12:11:01 +0000"  >&lt;p&gt;this only affects 1.2 and the patch looks good to me, will write up a few unit tests for this and get it committed&lt;/p&gt;</comment>
                            <comment id="14110704" author="krummas" created="Tue, 26 Aug 2014 13:45:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;this only affects 1.2&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;no, we actually clear out the container in later versions as well - just harder to reproduce the error&lt;/p&gt;</comment>
                            <comment id="14110739" author="krummas" created="Tue, 26 Aug 2014 14:20:41 +0000"  >&lt;p&gt;committed, thanks!&lt;/p&gt;</comment>
                            <comment id="14123239" author="mihasya" created="Fri, 5 Sep 2014 17:49:51 +0000"  >&lt;p&gt;Until 1.2.19 is out, is there a workaround for this? Is it safe to just leave it? Getting a very steady trickle on our errors graph from this on one of our nodes in a 1.2.16 cluster:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [CompactionExecutor:68695] 2014-09-05 16:35:17,875 CassandraDaemon.java (line 191) Exception in thread Thread[CompactionExecutor:68695,1,main]
java.lang.AssertionError: originally calculated column size of 92870522 but now it is 92870540
	at org.apache.cassandra.db.compaction.LazilyCompactedRow.write(LazilyCompactedRow.java:135)
	at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:160)
	at org.apache.cassandra.db.compaction.CompactionTask.runWith(CompactionTask.java:162)
	at org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:58)
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:60)
	at org.apache.cassandra.db.compaction.CompactionManager$7.runMayThrow(CompactionManager.java:442)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)
ERROR [BatchlogTasks:1] 2014-09-05 16:35:17,875 CassandraDaemon.java (line 191) Exception in thread Thread[BatchlogTasks:1,5,main]
java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.AssertionError: originally calculated column size of 92870522 but now it is 92870540
	at com.google.common.base.Throwables.propagate(Throwables.java:160)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:32)
	at org.apache.cassandra.concurrent.DebuggableScheduledThreadPoolExecutor$UncomplainingRunnable.run(DebuggableScheduledThreadPoolExecutor.java:75)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:304)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$301(ScheduledThreadPoolExecutor.java:178)
	at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.Thread.run(Thread.java:745)
Caused by: java.util.concurrent.ExecutionException: java.lang.AssertionError: originally calculated column size of 92870522 but now it is 92870540
	at java.util.concurrent.FutureTask.report(FutureTask.java:122)
	at java.util.concurrent.FutureTask.get(FutureTask.java:188)
	at org.apache.cassandra.db.BatchlogManager.cleanup(BatchlogManager.java:353)
	at org.apache.cassandra.db.BatchlogManager.replayAllFailedBatches(BatchlogManager.java:201)
	at org.apache.cassandra.db.BatchlogManager$1.runMayThrow(BatchlogManager.java:98)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	... 8 more
Caused by: java.lang.AssertionError: originally calculated column size of 92870522 but now it is 92870540
	at org.apache.cassandra.db.compaction.LazilyCompactedRow.write(LazilyCompactedRow.java:135)
	at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:160)
	at org.apache.cassandra.db.compaction.CompactionTask.runWith(CompactionTask.java:162)
	at org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:58)
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:60)
	at org.apache.cassandra.db.compaction.CompactionManager$7.runMayThrow(CompactionManager.java:442)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask.run(FutureTask.java:262)
	... 3 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14127642" author="peter-librato" created="Tue, 9 Sep 2014 22:09:21 +0000"  >&lt;p&gt;This is listed in the 2.0 CHANGES.txt as present in 2.0.10 but &quot;Fix Versions&quot; shows 2.0.11.&lt;/p&gt;</comment>
                            <comment id="14259490" author="fahdsiddiqui" created="Sat, 27 Dec 2014 21:13:19 +0000"  >&lt;p&gt;We are on Cassandra 1.2.19, but still seeing this error in Hints column family:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [HintedHandoff:3] 2014-12-27 20:53:16,742 CassandraDaemon.java (line 191) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[HintedHandoff:3,1,main]
java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.AssertionError: originally calculated column size of 5324 but now it is 372186
        at org.apache.cassandra.db.HintedHandOffManager.doDeliverHintsToEndpoint(HintedHandOffManager.java:429)
        at org.apache.cassandra.db.HintedHandOffManager.deliverHintsToEndpoint(HintedHandOffManager.java:280)
        at org.apache.cassandra.db.HintedHandOffManager.access$300(HintedHandOffManager.java:88)
        at org.apache.cassandra.db.HintedHandOffManager$4.run(HintedHandOffManager.java:495)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
Caused by: java.util.concurrent.ExecutionException: java.lang.AssertionError: originally calculated column size of 5324 but now it is 372186
        at java.util.concurrent.FutureTask.report(FutureTask.java:122)
        at java.util.concurrent.FutureTask.get(FutureTask.java:188)
        at org.apache.cassandra.db.HintedHandOffManager.doDeliverHintsToEndpoint(HintedHandOffManager.java:425)
        ... 6 more
Caused by: java.lang.AssertionError: originally calculated column size of 5324 but now it is 372186
        at org.apache.cassandra.db.compaction.LazilyCompactedRow.write(LazilyCompactedRow.java:135)
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:160)
        at org.apache.cassandra.db.compaction.CompactionTask.runWith(CompactionTask.java:162)
        at org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:58)
        at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:60)
        at org.apache.cassandra.db.compaction.CompactionManager$7.runMayThrow(CompactionManager.java:442)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12553475">CASSANDRA-4206</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12663295" name="7808-v1.diff" size="2013" author="rlow" created="Thu, 21 Aug 2014 00:42:13 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[richardlow]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 47 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1z5zj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326707">1.2.17</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324332">1.1.12</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>