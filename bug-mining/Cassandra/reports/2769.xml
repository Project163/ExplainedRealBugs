<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:44:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6476] Assertion error in MessagingService.addCallback</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6476</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Two of the three Cassandra nodes in one of our clusters just started behaving very strange about an hour ago. Within a minute of each other they started logging AssertionErrors (see stack traces here: &lt;a href=&quot;https://gist.github.com/iconara/7917438&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/iconara/7917438&lt;/a&gt;) over and over again. The client lost connection with the nodes at roughly the same time. The nodes were still up, and even if no clients were connected to them they continued logging the same errors over and over.&lt;/p&gt;

&lt;p&gt;The errors are in the native transport (specifically MessagingService.addCallback) which makes me suspect that it has something to do with a test that we started running this afternoon. I&apos;ve just implemented support for frame compression in my CQL driver cql-rb. About two hours before this happened I deployed a version of the application which enabled Snappy compression on all frames larger than 64 bytes. It&apos;s not impossible that there is a bug somewhere in the driver or compression library that caused this &amp;#8211; but at the same time, it feels like it shouldn&apos;t be possible to make C* a zombie with a bad frame.&lt;/p&gt;

&lt;p&gt;Restarting seems to have got them back running again, but I suspect they will go down again sooner or later.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Cassandra 2.0.2 DCE, Cassandra 1.2.15&lt;/p&gt;</environment>
        <key id="12684100">CASSANDRA-6476</key>
            <summary>Assertion error in MessagingService.addCallback</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="iconara">Theo Hultberg</reporter>
                        <labels>
                    </labels>
                <created>Wed, 11 Dec 2013 20:20:55 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:58 +0000</updated>
                            <resolved>Thu, 24 Apr 2014 15:31:46 +0000</resolved>
                                        <fixVersion>1.2.17</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="13846256" author="slebresne" created="Thu, 12 Dec 2013 11:38:49 +0000"  >&lt;p&gt;MessagingService ain&apos;t the native transport (fyi, the native transport code doesn&apos;t leak outside the org.apache.cassandra.transport package), it&apos;s the intra-cluster messaging. In fact the stack trace shows that the write that trigger it don&apos;t even come from the native protocol but from thrift (which means you either use thrift for some things or something is whack).&lt;/p&gt;

&lt;p&gt;But truth is, given the stack trace, where the writes comes from doesn&apos;t matter.  The assertion that fails is the line&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;assert previous == null;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;in MessagingService.addCallback. And that&apos;s where things stop to make sense to me. This means that we tried to add a new message to the callback map but there was one with the same messageId already. Except that messageId is very straighforwardly generated by an &lt;tt&gt;incrementAndGet&lt;/tt&gt; on an static AtomicInteger. And as far as I can tell, no other code inserts in the callback map without grabing a new messageId this way (except setCallbackForTests, but it does is only use in a unit test).&lt;/p&gt;

&lt;p&gt;Therefore, it seems the only way such messageId conflict could happen is that we&apos;ve gone full cycle on the AtomicInteger and hit the same id again. But entries in callbacks expire after the rpc timeout, so that implies &amp;gt; 4 billions requests in about 10 seconds. Sounds pretty unlikely to me.&lt;/p&gt;

&lt;p&gt;But I might be missing something obvious: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt;, I believe you might be more familiar with MessagingService, any idea?&lt;/p&gt;</comment>
                            <comment id="13846262" author="iconara" created="Thu, 12 Dec 2013 12:06:18 +0000"  >&lt;p&gt;Sorry, there was another stack trace I meant to attach to the same gist that said something about the native transport. I&apos;ve added it now: &lt;a href=&quot;https://gist.github.com/iconara/7917438&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/iconara/7917438&lt;/a&gt; (see the second file). Those errors started with &quot;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests:7924&amp;#93;&lt;/span&gt;&quot; which made me make the connection between us changing to compressed requests and the errors (since cql-rb only runs over the CQL protocol).&lt;/p&gt;

&lt;p&gt;I&apos;ve looked at the logs but my untrained eyes don&apos;t find any more hints as to what happened. I can post the full logs if that helps you.&lt;/p&gt;</comment>
                            <comment id="13846377" author="jbellis" created="Thu, 12 Dec 2013 15:41:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;that&apos;s where things stop to make sense to me. This means that we tried to add a new message to the callback map but there was one with the same messageId already. Except that messageId is very straighforwardly generated by an incrementAndGet on an static AtomicInteger&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right.  I&apos;m not sure why that assert even exists TBH; I have some idea that in the super distant past SP used to manually inject callbacks in some cases but if so that code is long dead.&lt;/p&gt;

&lt;p&gt;Is it possible a bug in native compression code is corrupting random crap elsewhere in the JVM?&lt;/p&gt;</comment>
                            <comment id="13846405" author="slebresne" created="Thu, 12 Dec 2013 16:18:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is it possible a bug in native compression code is corrupting random crap elsewhere in the JVM?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I have no clue, that would be a pretty serious JVM bug imo if that was the case. It would also be uncanny for &quot;random corrupted crap&quot; to trigger the same assertion on different nodes (but well, everything is possible). All I can say in that matter is that the native protocol uses the same compression libs than sstable compression and in basically the same way.&lt;/p&gt;</comment>
                            <comment id="13846464" author="jbellis" created="Thu, 12 Dec 2013 17:14:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iconara&quot; class=&quot;user-hover&quot; rel=&quot;iconara&quot;&gt;iconara&lt;/a&gt; did you see the MS asserts on multiple nodes?&lt;/p&gt;</comment>
                            <comment id="13846650" author="iconara" created="Thu, 12 Dec 2013 19:35:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; Yes, two out of three nodes got the same assertion failures within a minute or two.&lt;/p&gt;

&lt;p&gt;I&apos;ve updated the gist (&lt;a href=&quot;https://gist.github.com/iconara/7917438&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/iconara/7917438&lt;/a&gt;) with the full logs (10,000 lines) from the two nodes. The third node has nothing in its logs around the same time (it&apos;s all just INFO and nothing that stands out).&lt;/p&gt;</comment>
                            <comment id="13846709" author="jbellis" created="Thu, 12 Dec 2013 20:31:46 +0000"  >&lt;p&gt;Huh.  Well, I added some extra detail to the assert in c4d3a313885f14e802247b9354aafa4caaae9804.  Maybe that will show a clue.&lt;/p&gt;</comment>
                            <comment id="13973941" author="kohlisankalp" created="Fri, 18 Apr 2014 10:12:04 +0000"  >&lt;p&gt;We saw these asserts on one node for sometime and then it went away. This is 1.2.15. We had some network problem around the same time. Don&apos;t know whether that is related. &lt;br/&gt;
java.lang.AssertionError&lt;br/&gt;
	at org.apache.cassandra.net.MessagingService.addCallback(MessagingService.java:541)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy.sendMessagesToOneDCInternal(StorageProxy.java:638)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy.sendMessagesToOneDC(StorageProxy.java:603)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy.sendToHintedEndpoints(StorageProxy.java:530)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy$2.apply(StorageProxy.java:121)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy.performWrite(StorageProxy.java:384)&lt;br/&gt;
	at org.apache.cassandra.service.StorageProxy.mutate(StorageProxy.java:191)&lt;br/&gt;
	at org.apache.cassandra.thrift.CassandraServer.doInsert(CassandraServer.java:866)&lt;br/&gt;
	at org.apache.cassandra.thrift.CassandraServer.doInsert(CassandraServer.java:849)&lt;br/&gt;
	at org.apache.cassandra.thrift.CassandraServer.internal_remove(CassandraServer.java:813)&lt;br/&gt;
	at org.apache.cassandra.thrift.CassandraServer.remove(CassandraServer.java:834)&lt;br/&gt;
	at org.apache.cassandra.thrift.Cassandra$Processor$remove.getResult(Cassandra.java:3642)&lt;br/&gt;
	at org.apache.cassandra.thrift.Cassandra$Processor$remove.getResult(Cassandra.java:3630)&lt;br/&gt;
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:32)&lt;br/&gt;
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:34)&lt;br/&gt;
	at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:199)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;</comment>
                            <comment id="13976378" author="rlow" created="Tue, 22 Apr 2014 04:41:46 +0000"  >&lt;p&gt;If System.nanoTime() went backwards then it could cause this. Messages won&apos;t be expired from the map and once we&apos;ve sent 2 billion messages we&apos;ll reuse IDs. The instance Sankalp pasted the error from had processed approx 1 billion messages so it&apos;s conceivable it has added 2bn callbacks.&lt;/p&gt;

&lt;p&gt;System.nanoTime() shouldn&apos;t go backwards though. It might on really old kernels but not on ours. But it&apos;s possible a hardware issue or kernel bug could cause this. It would have to be something correlated between nodes to explain Theo&apos;s issue.&lt;/p&gt;</comment>
                            <comment id="13977357" author="benedict" created="Tue, 22 Apr 2014 20:30:49 +0000"  >&lt;p&gt;Isn&apos;t this most likely a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6948&quot; title=&quot;After Bootstrap or Replace node startup, EXPIRING_MAP_REAPER is shutdown and cannot be restarted, causing callbacks to collect indefinitely&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6948&quot;&gt;&lt;del&gt;CASSANDRA-6948&lt;/del&gt;&lt;/a&gt;? Hit by never bouncing your node between bootstrap and hitting 4B+ messages, coupled with some dropped messages along the way, caused by shutting down the expiringmap reaper during bootstrap&lt;/p&gt;</comment>
                            <comment id="13977378" author="rlow" created="Tue, 22 Apr 2014 20:43:49 +0000"  >&lt;p&gt;Yes, most likely it is. We see it correlated across nodes that were bootstrapped at the same time, which makes sense.&lt;/p&gt;</comment>
                            <comment id="13977386" author="benedict" created="Tue, 22 Apr 2014 20:46:01 +0000"  >&lt;p&gt;Want to backport your patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13977397" author="brandon.williams" created="Tue, 22 Apr 2014 20:52:33 +0000"  >&lt;p&gt;Unfortunately, I don&apos;t think your analysis is correct, because in 1.2 we only spin MS up/down for replace, not bootstrap.  The bootstrap shadow round was added in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5571&quot; title=&quot;Reject bootstrapping endpoints that are already in the ring with different gossip data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5571&quot;&gt;&lt;del&gt;CASSANDRA-5571&lt;/del&gt;&lt;/a&gt; which is 2.0-only.&lt;/p&gt;</comment>
                            <comment id="13977408" author="brandon.williams" created="Tue, 22 Apr 2014 20:56:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rlow&quot; class=&quot;user-hover&quot; rel=&quot;rlow&quot;&gt;rlow&lt;/a&gt; are you doing a bootstrap, or are you doing a replace?&lt;/p&gt;</comment>
                            <comment id="13977409" author="rlow" created="Tue, 22 Apr 2014 20:57:55 +0000"  >&lt;p&gt;Sorry, the instances we&apos;ve seen were replaced, not bootstrapped. This is on 1.2.15.&lt;/p&gt;

&lt;p&gt;Theo, had you replaced instances too?&lt;/p&gt;</comment>
                            <comment id="13977421" author="brandon.williams" created="Tue, 22 Apr 2014 21:05:48 +0000"  >&lt;p&gt;Half a backport from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6948&quot; title=&quot;After Bootstrap or Replace node startup, EXPIRING_MAP_REAPER is shutdown and cannot be restarted, causing callbacks to collect indefinitely&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6948&quot;&gt;&lt;del&gt;CASSANDRA-6948&lt;/del&gt;&lt;/a&gt; to only affect replace.&lt;/p&gt;</comment>
                            <comment id="13979483" author="benedict" created="Thu, 24 Apr 2014 09:04:47 +0000"  >&lt;p&gt;LGTM&lt;/p&gt;</comment>
                            <comment id="13979837" author="brandon.williams" created="Thu, 24 Apr 2014 15:31:35 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12641331" name="6476.txt" size="3623" author="brandon.williams" created="Tue, 22 Apr 2014 21:05:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363172</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qlof:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363478</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325022">1.2.11</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>