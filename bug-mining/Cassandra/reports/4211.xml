<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:02:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11525] StaticTokenTreeBuilder should respect posibility of duplicate tokens</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11525</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Bug reproduced in &lt;b&gt;Cassandra 3.5-SNAPSHOT&lt;/b&gt; (after the fix of OOM)&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;create table if not exists test.resource_bench ( 
 dsr_id uuid,
 rel_seq bigint,
 seq bigint,
 dsp_code varchar,
 model_code varchar,
 media_code varchar,
 transfer_code varchar,
 commercial_offer_code varchar,
 territory_code varchar,
 period_end_month_int int,
 authorized_societies_txt text,
 rel_type text,
 status text,
 dsp_release_code text,
 title text,
 contributors_name list&amp;lt;text&amp;gt;,
 unic_work text,
 paying_net_qty bigint,
PRIMARY KEY ((dsr_id, rel_seq), seq)
) WITH CLUSTERING ORDER BY (seq ASC); 

CREATE CUSTOM INDEX resource_period_end_month_int_idx ON test.resource_bench (period_end_month_int) USING &apos;org.apache.cassandra.index.sasi.SASIIndex&apos; WITH OPTIONS = {&apos;mode&apos;: &apos;PREFIX&apos;};
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So the index is a &lt;tt&gt;DENSE&lt;/tt&gt; numerical index.&lt;/p&gt;

&lt;p&gt;When doing the request &lt;tt&gt;SELECT dsp_code, unic_work, paying_net_qty FROM test.resource_bench WHERE period_end_month_int = 201401&lt;/tt&gt; using server-side paging.&lt;/p&gt;

&lt;p&gt;I bumped into this stack trace:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN  [SharedPool-Worker-1] 2016-04-06 00:00:30,825 AbstractLocalAwareExecutorService.java:169 - Uncaught exception on thread Thread[SharedPool-Worker-1,5,main]: {}
java.lang.ArrayIndexOutOfBoundsException: -55
	at org.apache.cassandra.db.ClusteringPrefix$Serializer.deserialize(ClusteringPrefix.java:268) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.db.Serializers$2.deserialize(Serializers.java:128) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.db.Serializers$2.deserialize(Serializers.java:120) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.io.sstable.IndexHelper$IndexInfo$Serializer.deserialize(IndexHelper.java:148) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.db.RowIndexEntry$Serializer.deserialize(RowIndexEntry.java:218) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.io.sstable.format.SSTableReader.keyAt(SSTableReader.java:1823) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.index.sasi.SSTableIndex$DecoratedKeyFetcher.apply(SSTableIndex.java:168) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.index.sasi.SSTableIndex$DecoratedKeyFetcher.apply(SSTableIndex.java:155) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.index.sasi.disk.TokenTree$KeyIterator.computeNext(TokenTree.java:518) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.index.sasi.disk.TokenTree$KeyIterator.computeNext(TokenTree.java:504) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.index.sasi.utils.AbstractIterator.tryToComputeNext(AbstractIterator.java:116) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.index.sasi.utils.AbstractIterator.hasNext(AbstractIterator.java:110) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.utils.MergeIterator$Candidate.advance(MergeIterator.java:374) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.advance(MergeIterator.java:186) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.computeNext(MergeIterator.java:155) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.index.sasi.plan.QueryPlan$ResultIterator.computeNext(QueryPlan.java:106) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.index.sasi.plan.QueryPlan$ResultIterator.computeNext(QueryPlan.java:71) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:72) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
	at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:289) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are 2 possible root cause:&lt;/p&gt;

&lt;p&gt;1. Index corrupted&lt;br/&gt;
2. Raw SSTable is corrupted&lt;/p&gt;

&lt;p&gt;To rule out &lt;b&gt;scenario 1&lt;/b&gt;, I just drop and rebuild the index &lt;b&gt;many times&lt;/b&gt; but the exception was still there, so I modified the method &lt;tt&gt;SSTableReader.keyAt(long indexPosition)&lt;/tt&gt; to log the impacted partition:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;            try
            {
                if (isKeyCacheSetup())
                    cacheKey(key, rowIndexEntrySerializer.deserialize(in));
            } catch (IndexOutOfBoundsException ex)
            {
                logger.error(String.format(
                &quot;Error when reading index entry for token &apos;%s&apos; at indexPosition %s &quot;,
                key.getToken().getTokenValue(), indexPosition));
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Below are the output in the log after code modification:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;system_ns3038406.ip-5-39-72.eu.log:ERROR [SharedPool-Worker-1] 2016-04-07 17:08:28,843 SSTableReader.java:1830 - Error when reading index entry for token &apos;-7005474773654630139&apos; at indexPosition 2147457128
system_ns3038406.ip-5-39-72.eu.log:ERROR [SharedPool-Worker-1] 2016-04-07 17:08:28,917 SSTableReader.java:1830 - Error when reading index entry for token &apos;-5016711186446865616&apos; at indexPosition 2147458268
system_ns3038406.ip-5-39-72.eu.log:ERROR [SharedPool-Worker-1] 2016-04-07 17:08:28,918 SSTableReader.java:1830 - Error when reading index entry for token &apos;1027994831942941747&apos; at indexPosition 2147459218
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I double check the original C* data using &lt;tt&gt;cqlsh&lt;/tt&gt; but it seems that there is no data for those tokens:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SELECT dsr_id,rel_seq FROM resource_bench WHERE token(dsr_id,rel_seq)=-7005474773654630139;

 dsr_id | rel_seq
--------+---------

(0 rows)
 SELECT dsr_id,rel_seq FROM resource_bench WHERE token(dsr_id,rel_seq)=-5016711186446865616;

 dsr_id | rel_seq
--------+---------

(0 rows)
SELECT dsr_id,rel_seq FROM resource_bench WHERE token(dsr_id,rel_seq)=1027994831942941747;

 dsr_id | rel_seq
--------+---------

(0 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Cassandra 3.5-SNAPSHOT&lt;/p&gt;</environment>
        <key id="12956901">CASSANDRA-11525</key>
            <summary>StaticTokenTreeBuilder should respect posibility of duplicate tokens</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jwest">Jordan West</assignee>
                                    <reporter username="doanduyhai">DuyHai Doan</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Apr 2016 15:45:01 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:36 +0000</updated>
                            <resolved>Sat, 9 Apr 2016 04:38:13 +0000</resolved>
                                        <fixVersion>3.5</fixVersion>
                                    <component>Feature/SASI</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="15230453" author="doanduyhai" created="Thu, 7 Apr 2016 15:52:56 +0000"  >&lt;p&gt;If necessary I can upload the base SSTables and corresponding SASI index files&lt;/p&gt;</comment>
                            <comment id="15230687" author="xedin" created="Thu, 7 Apr 2016 17:48:30 +0000"  >&lt;p&gt;I think we just use incorrect serializer in some of the situations e.g. when &lt;tt&gt;clustering order by&lt;/tt&gt; is used, that&apos;s what the problem is because it can&apos;t properly deserialize index entry. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=doanduyhai&quot; class=&quot;user-hover&quot; rel=&quot;doanduyhai&quot;&gt;doanduyhai&lt;/a&gt; It would be great if you could share sstables again so i can reproduce locally.&lt;/p&gt;</comment>
                            <comment id="15230714" author="xedin" created="Thu, 7 Apr 2016 17:59:04 +0000"  >&lt;p&gt;Also it looks like the actual key from the index file might be read successfully, so maybe along side of printing token you can also print actual data from the key that might be helpful to figure out if it&apos;s a real key or just random set of 32k bytes.&lt;/p&gt;</comment>
                            <comment id="15230742" author="xedin" created="Thu, 7 Apr 2016 18:12:47 +0000"  >&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15231212" author="doanduyhai" created="Thu, 7 Apr 2016 22:15:16 +0000"  >&lt;p&gt;Ok your intuition was correct &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt;, I did this code patch :&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;            key = decorateKey(ByteBufferUtil.readWithShortLength(in));

            // hint read path about key location if caching is enabled
            // this saves index summary lookup and index file iteration which whould be pretty costly
            // especially in presence of promoted column indexes
            try
            {

                if (isKeyCacheSetup())
                    cacheKey(key, rowIndexEntrySerializer.deserialize(in));
            } catch (IndexOutOfBoundsException ex)
            {

                try {
                    final String keyValue = keyValidator.getString(key.getKey().duplicate());
                    logger.error(String.format(
                    &quot;Error when reading index entry for token &apos;%s&apos;, partition key &apos;%s&apos; at indexPosition %s &quot;,
                    key.getToken().getTokenValue(), keyValue, indexPosition));
                    throw ex;
                } catch (Exception ex2)
                {
                    logger.error(String.format(
                    &quot;Error when reading index entry for token &apos;%s&apos; at indexPosition %s &quot;,
                    key.getToken().getTokenValue(), indexPosition));
                    throw ex;
                }
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; And it seems that we&apos;re falling into the second exception catch block, which is a hint that the deserialization of the partition key ByteBuffer may have thrown an exception as well so yes, very probable that it&apos;s just a random set of 32k bytes&lt;/p&gt;

&lt;p&gt;I&apos;m going to fetch the SSTables and index structures to upload them.&lt;/p&gt;

&lt;p&gt;By the way, I tested with trunk (3.6-SNAPSHOT) and same error too&lt;/p&gt;
</comment>
                            <comment id="15231220" author="xedin" created="Thu, 7 Apr 2016 22:19:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=doanduyhai&quot; class=&quot;user-hover&quot; rel=&quot;doanduyhai&quot;&gt;doanduyhai&lt;/a&gt; Alright, it&apos;s most likely is related to how the index is stitched together again, we&apos;ll wait for you to upload files.&lt;/p&gt;

&lt;p&gt;Edit: Meanwhile it would be great if you could test it on 3.4 and see if that produces the same error too.&lt;/p&gt;</comment>
                            <comment id="15231340" author="doanduyhai" created="Thu, 7 Apr 2016 23:39:21 +0000"  >&lt;p&gt;Ok I&apos;m uploading to &lt;a href=&quot;https://drive.google.com/folderview?id=0B6wR2aj4Cb6wYWdfcl9Pb05CYW8&amp;amp;usp=sharing&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://drive.google.com/folderview?id=0B6wR2aj4Cb6wYWdfcl9Pb05CYW8&amp;amp;usp=sharing&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;There are 9 SSTables and 9 index files&lt;/p&gt;

&lt;p&gt;The SSTable size sums up to more than 20Gb&lt;/p&gt;

&lt;p&gt;It will take 2h at least for the upload to finish&lt;/p&gt;

&lt;p&gt;I will rebuild the index with 3.4 tomorrow and re-test.&lt;/p&gt;</comment>
                            <comment id="15231348" author="xedin" created="Thu, 7 Apr 2016 23:42:10 +0000"  >&lt;p&gt;Sounds good, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=doanduyhai&quot; class=&quot;user-hover&quot; rel=&quot;doanduyhai&quot;&gt;doanduyhai&lt;/a&gt;! Meanwhile we are trying to reproduce based on what we can figure out theoretically.&lt;/p&gt;</comment>
                            <comment id="15231400" author="xedin" created="Fri, 8 Apr 2016 00:16:41 +0000"  >&lt;p&gt;Ok, as a quick update, I think we know what is going on here, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt; is working on the changes to TokenTree, and it&apos;s most definitely caused by changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11383&quot; title=&quot;Avoid index segment stitching in RAM which lead to OOM on big SSTable files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11383&quot;&gt;&lt;del&gt;CASSANDRA-11383&lt;/del&gt;&lt;/a&gt;. We still going to use your files to validate plus add additional tests to prevent this in the future.&lt;/p&gt;</comment>
                            <comment id="15231597" author="jrwest" created="Fri, 8 Apr 2016 04:08:00 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/xedin/cassandra/tree/CASSANDRA-11525&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-11525&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/xedin-CASSANDRA-11525-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/xedin-CASSANDRA-11525-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=doanduyhai&quot; class=&quot;user-hover&quot; rel=&quot;doanduyhai&quot;&gt;doanduyhai&lt;/a&gt; can you try this branch and see if it  addresses the issue? Also, can you please upload all of the SSTable components (including SSTable index files) so we can test here as well?&lt;/p&gt;

&lt;p&gt;The issue was caused by an invalid assumption when clustering columns are used: when stitching together multiple index parts it was possible that the same term, for the same token was in multiple parts, resulting in the union iterator returning the incorrect count. The new approach counts the number of tokens while performing the first iteration. The complexity of the algorithm has not changed and it should be similar in performance. &lt;/p&gt;</comment>
                            <comment id="15232113" author="doanduyhai" created="Fri, 8 Apr 2016 12:21:57 +0000"  >&lt;p&gt;Rebuilding now the index with the fix from branch &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11525&quot; title=&quot;StaticTokenTreeBuilder should respect posibility of duplicate tokens&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11525&quot;&gt;&lt;del&gt;CASSANDRA-11525&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Also, I&apos;m uploading all the files to Google drive, it will take a while to complete but I guess when you wake up in SF they&apos;ll be ready&lt;/p&gt;</comment>
                            <comment id="15232115" author="doanduyhai" created="Fri, 8 Apr 2016 12:23:00 +0000"  >&lt;p&gt;Ok, all the files are uploaded to Google Drive&lt;/p&gt;

&lt;p&gt;One SSTable (&lt;b&gt;ma-2164&lt;/b&gt;) is too big so that I had to split it into chunks of 1Gb. To merge them, type &lt;tt&gt;cat ma-2164-big-Data.db_split.tgz_* | tar xz&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="15232797" author="doanduyhai" created="Fri, 8 Apr 2016 19:45:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The patch does not solve the issue.&lt;/p&gt;

&lt;p&gt;The exception occurs after fetching 15 260 000 rows using the index.&lt;/p&gt;

&lt;p&gt;Below is my Java test:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        String query = &quot;SELECT dsp_code, unic_work, paying_net_qty FROM test.resource_bench WHERE period_end_month_int = 201401&quot;;
        final PreparedStatement ps = session.prepare(query);
        System.out.println(&quot;************* Execution query : &quot; + ps.getQueryString() + &quot; ************************\n&quot;);
        System.out.println(&quot;Start date = &quot; + new Date() + &quot;\n&quot;);

        long count = 0;
        int fetchSize = 20000;
        int sleepTimeInMs = 20;
        final BoundStatement bs = ps.bind();
        bs.setFetchSize(fetchSize);
        bs.setReadTimeoutMillis(999999999);
        final ResultSet resultSet = session.execute(bs);
        final Iterator&amp;lt;Row&amp;gt; iterator = resultSet.iterator();
        while (iterator.hasNext()) {
            count ++;
            final Row row = iterator.next();
            if (count % fetchSize == 0) {
                System.out.println(count + &quot; : &quot; + row.getString(&quot;dsp_code&quot;) );
                // Give the system some time to breath
                Thread.sleep(sleepTimeInMs);
            }
        }

        System.out.println(&quot;End date = &quot; + new Date());
        System.out.println(&quot;Fetched rows = &quot; + count);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It took a while to hit the 15 million rows but I eventually fall into the same exception.&lt;/p&gt;

&lt;p&gt;You can try to reproduce now that you have all the SSTables&lt;/p&gt;</comment>
                            <comment id="15232809" author="xedin" created="Fri, 8 Apr 2016 19:54:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=doanduyhai&quot; class=&quot;user-hover&quot; rel=&quot;doanduyhai&quot;&gt;doanduyhai&lt;/a&gt; ok. we are working on reproducing locally. In the meantime would you be able to test against 3.4 to help us confirm/deny whether the issue was caused by the changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11383&quot; title=&quot;Avoid index segment stitching in RAM which lead to OOM on big SSTable files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11383&quot;&gt;&lt;del&gt;CASSANDRA-11383&lt;/del&gt;&lt;/a&gt;. Also, can you provide the output of running your script so we can determine specifically where it errored out? Can you please also add Stats component which is currently missing, without it we can&apos;t to do much?&lt;/p&gt;</comment>
                            <comment id="15232848" author="doanduyhai" created="Fri, 8 Apr 2016 20:15:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;Statistics files uploaded&lt;/p&gt;

&lt;p&gt;In the mean time I&apos;m re-testing&lt;/p&gt;</comment>
                            <comment id="15232878" author="xedin" created="Fri, 8 Apr 2016 20:36:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=doanduyhai&quot; class=&quot;user-hover&quot; rel=&quot;doanduyhai&quot;&gt;doanduyhai&lt;/a&gt; Thanks, we got it running now trying to reproduce with the SI files you have included. Also the &lt;tt&gt;CREATE INDEX&lt;/tt&gt; command you added to description creates index with different name, it doesn&apos;t have &quot;&lt;em&gt;int&lt;/em&gt;&quot; which SI files do have.&lt;/p&gt;</comment>
                            <comment id="15233064" author="doanduyhai" created="Fri, 8 Apr 2016 22:21:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Output of my java tester:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;15180000 : youtube
15200000 : vevo
15220000 : vevo
15240000 : youtube
15260000 : spotify
Exception in thread &quot;main&quot; com.datastax.driver.core.exceptions.ReadFailureException: Cassandra failure during read query at consistency LOCAL_ONE (1 responses were required but only 0 replica responded, 1 failed)
        at com.datastax.driver.core.exceptions.ReadFailureException.copy(ReadFailureException.java:85)
        at com.datastax.driver.core.exceptions.ReadFailureException.copy(ReadFailureException.java:27)
        at com.datastax.driver.core.DriverThrowables.propagateCause(DriverThrowables.java:37)
        at com.datastax.driver.core.ArrayBackedResultSet$MultiPage.prepareNextRow(ArrayBackedResultSet.java:308)
        at com.datastax.driver.core.ArrayBackedResultSet$MultiPage.isExhausted(ArrayBackedResultSet.java:265)
        at com.datastax.driver.core.ArrayBackedResultSet$1.hasNext(ArrayBackedResultSet.java:136)
        at fr.sacem.sharon.SASIBench.execute(SASIBench.java:61)
        at fr.sacem.sharon.SASIBench.main(SASIBench.java:86)
Caused by: com.datastax.driver.core.exceptions.ReadFailureException: Cassandra failure during read query at consistency LOCAL_ONE (1 responses were required but only 0 replica responded, 1 failed)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;Root cause in a `system.log`&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN  [SharedPool-Worker-1] 2016-04-09 00:15:05,214 AbstractLocalAwareExecutorService.java:169 - Uncaught exception on thread Thread[SharedPool-Worker-1,5,main]: {}
java.lang.ArrayIndexOutOfBoundsException: 117
        at org.apache.cassandra.db.ClusteringPrefix$Serializer.deserialize(ClusteringPrefix.java:268) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.db.Serializers$2.deserialize(Serializers.java:128) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.db.Serializers$2.deserialize(Serializers.java:120) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.io.sstable.IndexHelper$IndexInfo$Serializer.deserialize(IndexHelper.java:149) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.db.RowIndexEntry$Serializer.deserialize(RowIndexEntry.java:218) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.io.sstable.format.SSTableReader.keyAt(SSTableReader.java:1823) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.index.sasi.SSTableIndex$DecoratedKeyFetcher.apply(SSTableIndex.java:168) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.index.sasi.SSTableIndex$DecoratedKeyFetcher.apply(SSTableIndex.java:155) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.index.sasi.disk.TokenTree$KeyIterator.computeNext(TokenTree.java:518) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.index.sasi.disk.TokenTree$KeyIterator.computeNext(TokenTree.java:504) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.index.sasi.utils.AbstractIterator.tryToComputeNext(AbstractIterator.java:116) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.index.sasi.utils.AbstractIterator.hasNext(AbstractIterator.java:110) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.utils.MergeIterator$TrivialOneToOne.computeNext(MergeIterator.java:484) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.index.sasi.plan.QueryPlan$ResultIterator.computeNext(QueryPlan.java:106) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.index.sasi.plan.QueryPlan$ResultIterator.computeNext(QueryPlan.java:71) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]
        at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:72) ~[apache-cassandra-3.5-SNAPSHOT.jar:3.5-SNAPSHOT]

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15233148" author="xedin" created="Fri, 8 Apr 2016 23:33:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=doanduyhai&quot; class=&quot;user-hover&quot; rel=&quot;doanduyhai&quot;&gt;doanduyhai&lt;/a&gt; Thanks for the information! We can reproduce it now, trying with 3.4 to make sure it&apos;s the bug we introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11383&quot; title=&quot;Avoid index segment stitching in RAM which lead to OOM on big SSTable files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11383&quot;&gt;&lt;del&gt;CASSANDRA-11383&lt;/del&gt;&lt;/a&gt;, will keep you posted.&lt;/p&gt;</comment>
                            <comment id="15233209" author="jrwest" created="Sat, 9 Apr 2016 00:28:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=doanduyhai&quot; class=&quot;user-hover&quot; rel=&quot;doanduyhai&quot;&gt;doanduyhai&lt;/a&gt; we have tracked down the root cause of the bug and it has affected all versions of SASI since its original inclusion in Cassandra. The issue is that when positions in the -Index.db file are &amp;gt; Integer.MAX_VALUE the positions are factored into a 32-bit and 16-bit value. The 16-bit value was being read as a signed short and for certain positions this resulted in reconstructing an incorrect 64-bit offset from the 32-bit and 16-bit parts. Thankfully, this is a quick, one-line fix (reading the short as unsigned), and is entirely independent of the changes in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11383&quot; title=&quot;Avoid index segment stitching in RAM which lead to OOM on big SSTable files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11383&quot;&gt;&lt;del&gt;CASSANDRA-11383&lt;/del&gt;&lt;/a&gt; or this ticket. We will include the fix for this with the merge of the changes in this ticket. We are working on final verification using your SSTables before we merge. &lt;/p&gt;</comment>
                            <comment id="15233284" author="xedin" created="Sat, 9 Apr 2016 01:48:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=doanduyhai&quot; class=&quot;user-hover&quot; rel=&quot;doanduyhai&quot;&gt;doanduyhai&lt;/a&gt; I&apos;ve force pushed updated code/tests to the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11525&quot; title=&quot;StaticTokenTreeBuilder should respect posibility of duplicate tokens&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11525&quot;&gt;&lt;del&gt;CASSANDRA-11525&lt;/del&gt;&lt;/a&gt; branch (testall/dtest are currently running). If you want to verify everything you (unfortunately) will have to rebuild indexes again, but this time you can only do it on the ma-2164 sstable everything else in unaffected. I&apos;m going to wait until testall/dtest completes and merge everything to unblock 3.5 release.&lt;/p&gt;</comment>
                            <comment id="15233353" author="xedin" created="Sat, 9 Apr 2016 04:38:13 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="15233546" author="doanduyhai" created="Sat, 9 Apr 2016 13:28:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt;   &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;OK the fix is confirmed. I have fetched successfully ~36 millions CQL rows using the index without the exception&lt;/p&gt;

&lt;p&gt;Good job and thanks for fixing this tricky bug&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jwest]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 32 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vsgv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>xedin</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[xedin]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>