<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14574] Incomplete handling of exceptions when decoding incoming messages</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14574</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;tt&gt;MessageInHandler.decode()&lt;/tt&gt; occasionally reads the payload incorrectly, passing the full message to &lt;tt&gt;MessageIn.read()&lt;/tt&gt; instead of just the payload bytes.&lt;/p&gt;

&lt;p&gt;You can see the stack trace in the logs from this &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/437#tests/containers/38&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI run&lt;/a&gt;.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.AssertionError: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:351)
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:371)
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:335)
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:158)
	at org.apache.cassandra.net.async.MessageInHandler.decode(MessageInHandler.java:132)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Reconstructed, truncated stream passed to &lt;tt&gt;MessageIn.read()&lt;/tt&gt;:&lt;br/&gt;
&lt;tt&gt;0000000b000743414c5f42414301002a01e1a5c9b089fd11e8b517436ee1243007040000005d10fc50ec&lt;/tt&gt;&lt;br/&gt;
You can clearly see parameters in there encoded before the payload:&lt;br/&gt;
&lt;tt&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;43414c5f424143 - CAL_BAC&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;01 - ONE_BYTE&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;002a - 42, payload size&amp;#93;&lt;/span&gt; 01 e1 a5 c9 b0 89 fd 11 e8 b5 17 43 6e e1 24 30 07 04 00 00 00 1d 10 fc 50 ec&lt;/tt&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13172775">CASSANDRA-14574</key>
            <summary>Incomplete handling of exceptions when decoding incoming messages</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jasobrown">Jason Brown</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Jul 2018 21:14:42 +0000</created>
                <updated>Fri, 15 May 2020 08:02:45 +0000</updated>
                            <resolved>Fri, 17 Aug 2018 12:59:54 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16547115" author="iamaleksey" created="Tue, 17 Jul 2018 21:16:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; ^&lt;/p&gt;</comment>
                            <comment id="16547158" author="jasobrown" created="Tue, 17 Jul 2018 22:17:54 +0000"  >&lt;p&gt;Probably a regression due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14485&quot; title=&quot;Optimize internode messaging protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14485&quot;&gt;&lt;del&gt;CASSANDRA-14485&lt;/del&gt;&lt;/a&gt;. Will investigate&lt;/p&gt;</comment>
                            <comment id="16547441" author="jasobrown" created="Wed, 18 Jul 2018 06:22:05 +0000"  >&lt;p&gt;I can repro both on circleci and my laptop, running the dtest that failed for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;: materialized_views_test.py::TestMaterializedViews::test_populate_mv_after_insert_wide_rows&lt;/p&gt;</comment>
                            <comment id="16547717" author="iamaleksey" created="Wed, 18 Jul 2018 11:53:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;Probably a regression due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14485&quot; title=&quot;Optimize internode messaging protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14485&quot;&gt;&lt;del&gt;CASSANDRA-14485&lt;/del&gt;&lt;/a&gt;. Will investigate&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;FWIW, I think I saw that same issue in CI before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14485&quot; title=&quot;Optimize internode messaging protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14485&quot;&gt;&lt;del&gt;CASSANDRA-14485&lt;/del&gt;&lt;/a&gt; got committed. So I think it&apos;s likelier that it wasn&apos;t caused by it than it was.&lt;/p&gt;</comment>
                            <comment id="16549610" author="jasobrown" created="Thu, 19 Jul 2018 17:38:58 +0000"  >&lt;p&gt;In short, I wasn&apos;t handling all error cases correctly. I was correctly handling the case where there is a single message contained in the &lt;tt&gt;ByteBuf&lt;/tt&gt; that is fully deserialized, and then if some exception happens in the pipeline, we close the channel and everything is fine. However, if there are multiple messages in the buffer, or the buffer is not fully consumed when deserializing, this is where the problems are. In the catch block of &lt;tt&gt;MessageInHandler.decode()&lt;/tt&gt;, I am calling &lt;tt&gt;exceptionHandled()&lt;/tt&gt;, which closes the channel. However, as we derive from &lt;tt&gt;ByteToMessageDecoder&lt;/tt&gt;, as it is responding to the channel close event, it will see there are unconsumed bytes in the buffer (called &lt;tt&gt;cumulator&lt;/tt&gt; in the class), and (re-)invoke &lt;tt&gt;decode()&lt;/tt&gt;. Unfortunately, if you are in a bad state and partway through the stream, you will fail to correctly deserialize any messages and it&apos;s downhill from there (you start looping over the same failure pattern: exception, call close channel, &lt;tt&gt;ByteToMessageDecoder&lt;/tt&gt; calls &lt;tt&gt;decode()&lt;/tt&gt;, repeat ...). The most safe thing to do here is pass the caught exception to &lt;tt&gt;ByteToMessageDecoder&lt;/tt&gt;, and prevent any future processing in the &lt;tt&gt;decode()&lt;/tt&gt; method.&lt;/p&gt;

&lt;p&gt;The patch here resolves the error handling in the inbound pipeline (see below for details on the failing dtest):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;14574&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/14574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jasobrown/workflows/cassandra/tree/14574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests &amp;amp; dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;This patch does several things in the &lt;tt&gt;MessageInHandler.decode()&lt;/tt&gt; method&apos;s exception block (which is where the problems lie):&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;explicitly throws the exception from the handler to the parent &lt;tt&gt;ByteToMessageDecoder&lt;/tt&gt;, where it can properly break out of the while loop in &lt;tt&gt;callDecode()&lt;/tt&gt;, and more properly send the exception to the &lt;tt&gt;exceptionHandled()&lt;/tt&gt; method (which is overridden in &lt;tt&gt;BaseMessageInHandler&lt;/tt&gt;) where we close the channel.&lt;/li&gt;
	&lt;li&gt;moves the &lt;tt&gt;ByteBuf&lt;/tt&gt; &apos;s readIndex to the end of the buffer, to make it appear as though the buffer has been fully &apos;consumed&apos;. This optimizes (and helps with correctness of) &lt;tt&gt;ByteToMessageDecoder&lt;/tt&gt;, because when the channel is closed, &lt;tt&gt;ByteToMessageDecoder.channelInputClosed()&lt;/tt&gt; attempts, several times, to ensure all the bytes from the backing &lt;tt&gt;ByteBuf&lt;/tt&gt; (&lt;tt&gt;cumulator&lt;/tt&gt;) are consumed. Even though the state of the implementing handler is borked, the parent &lt;tt&gt;ByteToMessageDecoder&lt;/tt&gt; will still keep trying to make sure all the bytes in &lt;tt&gt;cumulator&lt;/tt&gt; are consumed before closing the channel. Thus, forcing the readIndex to the end of the buffer avoids that situation.&lt;/li&gt;
	&lt;li&gt;adds an explicit &lt;tt&gt;CLOSED&lt;/tt&gt; state to the &lt;tt&gt;MessageInHandler&lt;/tt&gt;, and the handler&apos;s state is set to &lt;tt&gt;CLOSED&lt;/tt&gt; when a message fails to be deserialized or other error, for example: when the table doesn&apos;t exist (see below). While this is probably not completely necessary for correctness due to the other changes (primarily the one about moving the readIndex to the end of the buffer), it makes the state of the handler much more explicit, depends less on knowledge of the internal details of netty, and more resilient to implementation changes in the netty library itself.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;After this fix, the &lt;tt&gt;materialized_views_test.py::TestMaterializedViews::test_populate_mv_after_insert_wide_rows&lt;/tt&gt; dtest still fails, however, not with the same exception stack trace as reported. Instead, this one:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;io.netty.handler.codec.DecoderException: org.apache.cassandra.exceptions.UnknownTableException: Couldn&apos;t find table with id 3694c0c0-8b6b-11e8-841f-cd3e85e9c250. If a table was just created, this is likely due to the schemanot being fully propagated.  Please wait for schema agreement on table creation.
	at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:459)
	at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:265)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)
	at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1342)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)
	at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:934)
	at io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:979)
	at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:404)
	at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:307)
	at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858)
	at io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run(DefaultThreadFactory.java:138)
	at java.lang.Thread.run(Thread.java:748)
Caused by: org.apache.cassandra.exceptions.UnknownTableException: Couldn&apos;t find table with id 3694c0c0-8b6b-11e8-841f-cd3e85e9c250. If a table was just created, this is likely due to the schemanot being fully propagated.  Please wait for schema agreement on table creation.
	at org.apache.cassandra.schema.Schema.getExistingTableMetadata(Schema.java:438)
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize(PartitionUpdate.java:612)
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:353)
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:371)
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:335)
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:158)
	at org.apache.cassandra.net.async.MessageInHandler.decode(MessageInHandler.java:130)
	at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:489)
	at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:428)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Thus the problem here appears to be request not finding the correct table in the schema. In my test local runs with the above patch applied, that table is id correct and eventually exists (for the MView), but not when the message comes in.&lt;/p&gt;

&lt;p&gt;The reason why I had not seen this dtest failure in the past (and dtest runs were green), is because it was only exposed by the recent commit for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13426&quot; title=&quot;Make all DDL statements idempotent and not dependent on global state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13426&quot;&gt;&lt;del&gt;CASSANDRA-13426&lt;/del&gt;&lt;/a&gt;. I bisected back to a few commits before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14485&quot; title=&quot;Optimize internode messaging protocol&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14485&quot;&gt;&lt;del&gt;CASSANDRA-14485&lt;/del&gt;&lt;/a&gt; (started on sha &lt;tt&gt;2bad5d5b6d2134ecd3db63d02aa2274299d1d748&lt;/tt&gt;), and it identified &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13426&quot; title=&quot;Make all DDL statements idempotent and not dependent on global state&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13426&quot;&gt;&lt;del&gt;CASSANDRA-13426&lt;/del&gt;&lt;/a&gt; as the commit that caused &lt;tt&gt;materialized_views_test.py::TestMaterializedViews::test_populate_mv_after_insert_wide_rows&lt;/tt&gt; to start failing. My fix corrects the nastier part of that failure, but there&apos;s another issue that is outside the scope of the internode messaging.&lt;/p&gt;</comment>
                            <comment id="16549621" author="jasobrown" created="Thu, 19 Jul 2018 17:51:04 +0000"  >&lt;p&gt;UPDATE: looks like &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; had already seen the original dtest failure for that dtest, and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13426?focusedCommentId=16436169&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-16436169&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;commented here&lt;/a&gt;. Thus, I&apos;m gonna ignore the dtest fail, as well.&lt;/p&gt;</comment>
                            <comment id="16549701" author="djoshi3" created="Thu, 19 Jul 2018 19:04:30 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;, I don&apos;t wish to hijack this ticket but I strongly recommend marking this test as an expected failure. See my comment on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14571&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-14571&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16549746" author="iamaleksey" created="Thu, 19 Jul 2018 19:40:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi3&quot; class=&quot;user-hover&quot; rel=&quot;djoshi3&quot;&gt;djoshi3&lt;/a&gt; Nah. The patch for it is incoming (see &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/14571-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="16549784" author="djoshi3" created="Thu, 19 Jul 2018 20:06:43 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16549946" author="iamaleksey" created="Thu, 19 Jul 2018 22:16:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; Thanks for looking into it quickly and coming up with a patch. I&apos;m wondering however if maybe this is a good time to improve handling of errors like this by skipping the remaining payload bytes, to leave the stream in a valid state, without closing down connections.&lt;/p&gt;</comment>
                            <comment id="16549972" author="iamaleksey" created="Thu, 19 Jul 2018 22:52:49 +0000"  >&lt;p&gt;Changed the title to reflect the actual issue versus my initial incorrect/incomplete diagnosis (nothing racy here).&lt;/p&gt;</comment>
                            <comment id="16550058" author="iamaleksey" created="Fri, 20 Jul 2018 00:20:51 +0000"  >&lt;p&gt;No longer important, since the source is now known, but I got a different instance of what I think is the same bug, triggered &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/468#tests/containers/26&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16550234" author="jasobrown" created="Fri, 20 Jul 2018 04:38:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;longer important, since the source is now known, but I got a different instance of what I think is the same bug, triggered here&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yup, looks like the broken behavior of constantly evaluating the buffer even though we&apos;re in a bad (incorrect) spot in the stream.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m wondering however if maybe this is a good time to improve handling of errors like this by skipping the remaining payload bytes, to leave the stream in a valid state, without closing down connections.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree, especially after seeing that we drop the connection when we get a message for a table we don&apos;t know about yet. (I&apos;ll have to spelunk the git log to uncover the original logic for that one). That&apos;s one example, of course. However, I&apos;d like to separate that reevaluation effort from resolving this issue. That way we can unblock this faster.&lt;/p&gt;</comment>
                            <comment id="16550235" author="jasobrown" created="Fri, 20 Jul 2018 04:42:50 +0000"  >&lt;p&gt;created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14575&quot; title=&quot;Reevaluate when to drop an internode connection on message error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14575&quot;&gt;&lt;del&gt;CASSANDRA-14575&lt;/del&gt;&lt;/a&gt; to explore when we can safely ignore a failed internode message&lt;/p&gt;</comment>
                            <comment id="16550634" author="iamaleksey" created="Fri, 20 Jul 2018 10:41:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;I agree, especially after seeing that we drop the connection when we get a message for a table we don&apos;t know about yet. (I&apos;ll have to spelunk the git log to uncover the original logic for that one). &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That would be &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14168&quot; title=&quot;Throw error when attempting to mutate non-existant table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14168&quot;&gt;&lt;del&gt;CASSANDRA-14168&lt;/del&gt;&lt;/a&gt;. As for when it&apos;s safe to ignore a failed to deser message - at least in the case of unknown table id it is, and that&apos;s a common enough scenario. Think someone creates a table and starts writes before waiting for schema to propagate. Or batchlog replays a mutation to a node on which a table is either not yet known, or has been dropped since. Or, occasionally, when we add new tables and use them during mixed mode/upgrade period. I&apos;m pretty sure there is a JIRA somewhere, by Tyler, to address just this, but we never quite came around to it.&lt;/p&gt;</comment>
                            <comment id="16580871" author="djoshi3" created="Wed, 15 Aug 2018 09:13:39 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt;, overall the changes look good. I have a few changes that would eliminate some code duplication, adds annotation for methods exposed for testing. Other than the refactor, I have moved to using &lt;tt&gt;ByteBuf::skipBytes(int)&lt;/tt&gt; instead of explicitly setting the readerIndex. Other decoders in the Netty code prefer that as well. Using &lt;tt&gt;skipBytes&lt;/tt&gt; also goes through Netty&apos;s leak detection mechanism while setting the &lt;tt&gt;readerIndex&lt;/tt&gt; doesn&apos;t seem to trigger it.&lt;/p&gt;

&lt;p&gt;I have mocked up the changes in this branch - &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...dineshjoshi:jasobrown-14574-trunk-review?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...dineshjoshi:jasobrown-14574-trunk-review?expand=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I also think we should add a dtest which simulates a corruption in the byte stream possibly using Byteman.&lt;/p&gt;</comment>
                            <comment id="16581223" author="jasobrown" created="Wed, 15 Aug 2018 15:21:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi3&quot; class=&quot;user-hover&quot; rel=&quot;djoshi3&quot;&gt;djoshi3&lt;/a&gt; Thanks for reviewing. I agree with the changes you&apos;ve proposed (nice find on the &lt;tt&gt;ByteBuf.skipBytes()&lt;/tt&gt;), and have cherry picked the two commits from your branch and rerun the tests:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;14574&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/14574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jasobrown/workflows/cassandra/tree/14574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests &amp;amp; dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Working on a dtest now; not so straight-forward, but can be done.&lt;/p&gt;</comment>
                            <comment id="16582529" author="jasobrown" created="Thu, 16 Aug 2018 13:41:14 +0000"  >&lt;p&gt;dtest branch &lt;a href=&quot;https://github.com/jasobrown/cassandra-dtest/tree/14574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;added here&lt;/a&gt;. Waiting for tests to run.&lt;/p&gt;</comment>
                            <comment id="16583117" author="djoshi3" created="Thu, 16 Aug 2018 22:09:52 +0000"  >&lt;p&gt;The dtest looks good! I&apos;m +1 on the patch.&lt;/p&gt;</comment>
                            <comment id="16583874" author="jasobrown" created="Fri, 17 Aug 2018 12:59:21 +0000"  >&lt;p&gt;Committed to c* as sha &lt;tt&gt;298416a7445aa50874caebc779ca3094b32f3e31&lt;/tt&gt;, committed to dtest as sha &lt;tt&gt;6e80b1846c308bb13d0b700263c89f10caa17d28&lt;/tt&gt;. Thanks, all!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 13 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3vzxj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>djoshi</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[djoshi]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>