<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8900] AssertionError when binding nested collection in a DELETE</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8900</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Running this with the Java driver:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;create table &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; not exists foo2(k &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; primary key, m map&amp;lt;frozen&amp;lt;list&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;);&quot;&lt;/span&gt;);
PreparedStatement pst = session.prepare(&lt;span class=&quot;code-quote&quot;&gt;&quot;delete m[?] from foo2 where k = 1&quot;&lt;/span&gt;);
session.execute(pst.bind(ImmutableList.of(1)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Produces a server error. Server-side stack trace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [SharedPool-Worker-4] 2015-03-03 13:33:24,740 Message.java:538 - Unexpected exception during request; channel = [id: 0xf9e92e61, /127.0.0.1:58163 =&amp;gt; /127.0.0.1:9042]
java.lang.AssertionError: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at org.apache.cassandra.cql3.Maps$DiscarderByKey.execute(Maps.java:381) ~[main/:na]
        at org.apache.cassandra.cql3.statements.DeleteStatement.addUpdateForKey(DeleteStatement.java:85) ~[main/:na]
        at org.apache.cassandra.cql3.statements.ModificationStatement.getMutations(ModificationStatement.java:654) ~[main/:na]
        at org.apache.cassandra.cql3.statements.ModificationStatement.executeWithoutCondition(ModificationStatement.java:487) ~[main/:na]
        at org.apache.cassandra.cql3.statements.ModificationStatement.execute(ModificationStatement.java:473) ~[main/:na]
        at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:238) ~[main/:na]
        at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:493) ~[main/:na]
        at org.apache.cassandra.transport.messages.ExecuteMessage.execute(ExecuteMessage.java:134) ~[main/:na]
        at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:439) [main/:na]
        at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:335) [main/:na]
        at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) [netty-all-4.0.23.Final.jar:4.0.23.Final]
        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:333) [netty-all-4.0.23.Final.jar:4.0.23.Final]
        at io.netty.channel.AbstractChannelHandlerContext.access$700(AbstractChannelHandlerContext.java:32) [netty-all-4.0.23.Final.jar:4.0.23.Final]
        at io.netty.channel.AbstractChannelHandlerContext$8.run(AbstractChannelHandlerContext.java:324) [netty-all-4.0.23.Final.jar:4.0.23.Final]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) [na:1.7.0_60]
        at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) [main/:na]
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [main/:na]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.7.0_60]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;A simple statement (i.e. QUERY message with values) produces the same result:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;delete m[?] from foo2 where k = 1&quot;&lt;/span&gt;, ImmutableList.of(1));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12779187">CASSANDRA-8900</key>
            <summary>AssertionError when binding nested collection in a DELETE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="omichallat">Olivier Michallat</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Mar 2015 21:37:37 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:19 +0000</updated>
                            <resolved>Mon, 23 Mar 2015 16:17:11 +0000</resolved>
                                        <fixVersion>2.1.5</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14356381" author="stefania" created="Wed, 11 Mar 2015 06:25:17 +0000"  >&lt;p&gt;Reproduced with python driver as well, here is the dtest:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    def delete_frozen_map_test(self):
        &quot;&quot;&quot;
        This test used to give an AssertionError, see CASSANDRA-8900
        &quot;&quot;&quot;

        self.cluster.populate(1).start()
        node = self.cluster.nodes.values()[0]

        session = self.patient_cql_connection(node)
        session.execute(&quot;&quot;&quot;
            CREATE KEYSPACE IF NOT EXISTS %s
            WITH replication = { &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; }
            &quot;&quot;&quot; % KEYSPACE)

        session.set_keyspace(KEYSPACE)
        session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;create table &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; not exists foo2(k &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; primary key, m map&amp;lt;frozen&amp;lt;list&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;&amp;gt;, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;)&quot;&lt;/span&gt;)

        statement = session.prepare(&lt;span class=&quot;code-quote&quot;&gt;&quot;delete m[?] from foo2 where k = 1&quot;&lt;/span&gt;)

        session.execute(statement, ([1],))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14356430" author="stefania" created="Wed, 11 Mar 2015 07:30:38 +0000"  >&lt;p&gt;The fix is literally one line, there is no need for the assertion and the downcast&lt;br/&gt;
as there is a method in the base class that does the exact same thing and supports collections:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/tree/8900&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/stef1927/cassandra/tree/8900&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I extended the test to add a row and delete the column, it seems to work fine:&lt;br/&gt;
&lt;a href=&quot;https://github.com/stef1927/cassandra-dtest/tree/8900&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/stef1927/cassandra-dtest/tree/8900&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14356712" author="blerer" created="Wed, 11 Mar 2015 10:53:45 +0000"  >&lt;p&gt;The fix looks good but it seems that the problem has a broader scope. &lt;/p&gt;

&lt;p&gt;I when to look into &lt;tt&gt;FrozenCollectionsTest&lt;/tt&gt; and found out that we do not test the operations  that apply to a non frozen collection containing a frozen one. I also found the same assertion that was in &lt;tt&gt;Maps&lt;/tt&gt; within &lt;tt&gt;Lists&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It would probably be safer to add some unit tests to &lt;tt&gt;FrozenCollectionsTest&lt;/tt&gt; to checks the missing use cases for the different types of collection. Using the different queries of &lt;tt&gt;FrozenCollectionsTest.testInvalidOperations()&lt;/tt&gt; on non frozen collection containing a frozen one should probably do the job.&lt;/p&gt;

&lt;p&gt;The name: &lt;tt&gt;delete_frozen_map_test&lt;/tt&gt; is a bit misleading, you should probably change it to something like: &lt;tt&gt;delete_frozen_collection_from_map&lt;/tt&gt;&lt;/p&gt;
</comment>
                            <comment id="14358068" author="stefania" created="Thu, 12 Mar 2015 04:04:33 +0000"  >&lt;p&gt;Hi Benjamin, thank you for your review.&lt;/p&gt;

&lt;p&gt;I&apos;ve added the unit tests (I hope they are complete let me know if that&apos;s not the case) and removed similar assertions in Lists and Sets:&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/commit/87184750ab410cdfdf5931973cd505aba7ba6d8e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/87184750ab410cdfdf5931973cd505aba7ba6d8e&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;dtest renamed: &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/commit/48388a9bf444779246d83a3e0a9831e49895e9df&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/commit/48388a9bf444779246d83a3e0a9831e49895e9df&lt;/a&gt;, although we could probably do without this test since we have unit tests now.&lt;/p&gt;</comment>
                            <comment id="14360130" author="blerer" created="Fri, 13 Mar 2015 09:11:00 +0000"  >&lt;p&gt;Hi Stefania,&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;@Test&lt;/tt&gt; annotations are missing on your unit test methods.&lt;br/&gt;
When I run them &lt;tt&gt;testFrozenListInMap&lt;/tt&gt;, &lt;tt&gt;testFrozenSetInMap&lt;/tt&gt; and &lt;tt&gt;testFrozenSetInSet&lt;/tt&gt; are failling.&lt;br/&gt;
I had a quick look at the 2 first ones and it looks that it is a problem with the test itself. Be carefull with &lt;tt&gt;UPDATE&lt;/tt&gt; statements they behave in reallity like an &lt;tt&gt;UPSERT&lt;/tt&gt; (e.g. if the row does not exist Cassandra will insert it with the values specified in the statement).&lt;br/&gt;
I did not look at the last failling test.&lt;/p&gt;

&lt;p&gt;Otherwise I agree with you, you can remove the DTest. &lt;/p&gt;</comment>
                            <comment id="14360164" author="stefania" created="Fri, 13 Mar 2015 10:08:51 +0000"  >&lt;p&gt;Thanks for spotting this, I was running the tests one by one in the debugger and I must have missed those problems. The first two like you said are trivial and I fixed the test cases.&lt;/p&gt;

&lt;p&gt;The last one I can make it to pass by replacing &lt;tt&gt;Sets.Discarder&lt;/tt&gt; with &lt;tt&gt;Maps.DiscarderByKey&lt;/tt&gt; in &lt;tt&gt;ElementDeletion&lt;/tt&gt;. I&apos;m pretty sure the problem is there, the Sets discarder cannot distinguish the set subtraction from the deletion by key. &lt;/p&gt;

&lt;p&gt;I committed the code for now but I want to take a bit more time on Monday to review the discarder names for Sets and Maps:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/4371536a6bb1157373b175ef420c446f18dd907a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/4371536a6bb1157373b175ef420c446f18dd907a&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In the meantime if you have any more suggestions let me know.&lt;/p&gt;</comment>
                            <comment id="14362716" author="stefania" created="Mon, 16 Mar 2015 04:23:28 +0000"  >&lt;p&gt;I introduced a new discarder, &lt;tt&gt;ElementDiscarder&lt;/tt&gt; to handle the case of deleting items from sets. If you prefer to call it something else (all other discarders are called Discarder.. something) or wish to reuse &lt;tt&gt;Maps.DiscarderByKey&lt;/tt&gt; let me know. They are identical except for the error message.&lt;/p&gt;

&lt;p&gt;Otherwise, I found all the tests in &lt;tt&gt;CollectionsTest&lt;/tt&gt; commented out and I re-enabled them. Then checked that all unit tests in cql3 pass.&lt;/p&gt;</comment>
                            <comment id="14363127" author="blerer" created="Mon, 16 Mar 2015 12:22:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;Otherwise, I found all the tests in CollectionsTest commented out and I re-enabled them. Then checked that all unit tests in cql3 pass.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sylvain ninja fixed them last week, so you just need to rebase your branch. &lt;/p&gt;</comment>
                            <comment id="14363135" author="stefania" created="Mon, 16 Mar 2015 12:30:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;Sylvain ninja fixed them last week, so you just need to rebase your branch.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Done, thanks!&lt;/p&gt;</comment>
                            <comment id="14376019" author="blerer" created="Mon, 23 Mar 2015 15:05:34 +0000"  >&lt;p&gt;+1&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; can you commit?&lt;/p&gt;</comment>
                            <comment id="14376118" author="iamaleksey" created="Mon, 23 Mar 2015 16:17:11 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                            <comment id="14376152" author="blerer" created="Mon, 23 Mar 2015 16:38:54 +0000"  >&lt;p&gt;The patch made from Stefania branch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12706572" name="CASSANDRA-8900.txt" size="15286" author="blerer" created="Mon, 23 Mar 2015 16:38:54 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 35 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i26b9b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328951">2.1.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328951">2.1.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>