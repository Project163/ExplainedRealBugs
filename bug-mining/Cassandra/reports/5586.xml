<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:18:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16362] SSLFactory should initialize SSLContext before setting protocols</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16362</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Trying to use sstableloader from the latest trunk produced the following Exception:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Exception in thread &quot;main&quot; java.lang.RuntimeException: Could not create SSL Context.&lt;br/&gt;
	at org.apache.cassandra.tools.BulkLoader.buildSSLOptions(BulkLoader.java:261)&lt;br/&gt;
	at org.apache.cassandra.tools.BulkLoader.load(BulkLoader.java:64)&lt;br/&gt;
	at org.apache.cassandra.tools.BulkLoader.main(BulkLoader.java:49)&lt;br/&gt;
Caused by: java.io.IOException: Error creating/initializing the SSL Context&lt;br/&gt;
	at org.apache.cassandra.security.SSLFactory.createSSLContext(SSLFactory.java:184)&lt;br/&gt;
	at org.apache.cassandra.tools.BulkLoader.buildSSLOptions(BulkLoader.java:257)&lt;br/&gt;
	... 2 more&lt;br/&gt;
Caused by: java.lang.IllegalStateException: SSLContext is not initialized&lt;br/&gt;
	at sun.security.ssl.SSLContextImpl.engineGetSocketFactory(SSLContextImpl.java:208)&lt;br/&gt;
	at javax.net.ssl.SSLContextSpi.getDefaultSocket(SSLContextSpi.java:158)&lt;br/&gt;
	at javax.net.ssl.SSLContextSpi.engineGetDefaultSSLParameters(SSLContextSpi.java:184)&lt;br/&gt;
	at javax.net.ssl.SSLContext.getDefaultSSLParameters(SSLContext.java:435)&lt;br/&gt;
	at org.apache.cassandra.security.SSLFactory.createSSLContext(SSLFactory.java:178)&lt;br/&gt;
	... 3 more&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I believe this is because of a change to SSLFactory for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13325&quot; title=&quot;Bring back the accepted encryption protocols list as configurable option&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13325&quot;&gt;&lt;del&gt;CASSANDRA-13325&lt;/del&gt;&lt;/a&gt; here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/919a8964a83511d96766c3e53ba603e77bca626c#diff-0d569398cfd58566fc56bfb80c971a72afe3f392addc2df731a0b44baf29019eR177-R178&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/919a8964a83511d96766c3e53ba603e77bca626c#diff-0d569398cfd58566fc56bfb80c971a72afe3f392addc2df731a0b44baf29019eR177-R178&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I think the solution is to call &lt;tt&gt;ctx.init()&lt;/tt&gt; before trying to call &lt;tt&gt;ctx.getDefaultSSLParameters()&lt;/tt&gt;, essentialy swapping the two lines in the link above.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13346675">CASSANDRA-16362</key>
            <summary>SSLFactory should initialize SSLContext before setting protocols</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jmeredithco">Jon Meredith</assignee>
                                    <reporter username="emerkle826">Erik Merkle</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Dec 2020 22:36:25 +0000</created>
                <updated>Thu, 25 Feb 2021 10:10:33 +0000</updated>
                            <resolved>Wed, 3 Feb 2021 03:16:30 +0000</resolved>
                                        <fixVersion>4.0-rc1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Tool/bulk load</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4200">1h 10m</timespent>
                                <comments>
                            <comment id="17251828" author="jmeredithco" created="Fri, 18 Dec 2020 15:33:45 +0000"  >&lt;p&gt;Sorry for breaking sstableloader with the change. I&apos;ll investigate today.&lt;/p&gt;</comment>
                            <comment id="17252053" author="jmeredithco" created="Sat, 19 Dec 2020 00:29:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/860&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/jonmeredith/cassandra/tree/C16362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Branch&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/jonmeredith/cassandra?branch=C16362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CircleCI&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17252063" author="dcapwell" created="Sat, 19 Dec 2020 00:53:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emerkle826&quot; class=&quot;user-hover&quot; rel=&quot;emerkle826&quot;&gt;emerkle826&lt;/a&gt; are you able to show the steps you did to hit this?&lt;/p&gt;</comment>
                            <comment id="17252065" author="dcapwell" created="Sat, 19 Dec 2020 01:07:04 +0000"  >&lt;p&gt;replicated&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.IllegalStateException: SSLContextImpl is not initialized
	at sun.security.ssl.SSLContextImpl.engineGetSocketFactory(SSLContextImpl.java:177)
	at javax.net.ssl.SSLContextSpi.getDefaultSocket(SSLContextSpi.java:142)
	at javax.net.ssl.SSLContextSpi.engineGetDefaultSSLParameters(SSLContextSpi.java:168)
	at javax.net.ssl.SSLContext.getDefaultSSLParameters(SSLContext.java:419)
	at org.apache.cassandra.security.SSLFactory.createSSLContext(SSLFactory.java:178)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17252068" author="emerkle826" created="Sat, 19 Dec 2020 01:17:54 +0000"  >&lt;p&gt;For reference, I stumbled across this running integration tests in the Medusa project for backup and restore. It was failing when run against trunk and trying to restore a snapshot with sstableloader. The test uses CCM to run Cassandra. If needed I could dig into the test setup and detail exactly what steps are done.&lt;/p&gt;

&lt;p&gt;An easier test for me was to simply try this code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
      SSLContext ctx = SSLContext.getInstance(&lt;span class=&quot;code-quote&quot;&gt;&quot;TLS&quot;&lt;/span&gt;);
      ctx.getDefaultSSLParameters();
      ctx.init(&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, SecureRandom.getInstanceStrong());
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (Exception e) {
      e.printStackTrace();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It fails the same way. Calling &lt;tt&gt;ctx.init()&lt;/tt&gt; before &lt;tt&gt;ctx.getDefaultSSLParameters()&lt;/tt&gt; seems to not produce the &quot;not initialized&quot; error.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17252523" author="jmeredithco" created="Sun, 20 Dec 2020 21:44:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=emerkle826&quot; class=&quot;user-hover&quot; rel=&quot;emerkle826&quot;&gt;emerkle826&lt;/a&gt; Thanks for finding and reporting it. A good reminder that if you don&apos;t have a test you can&apos;t consider it working.&lt;/p&gt;

&lt;p&gt;Setting the default SSL parameters does not work as the returned parameters are copies.&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed up a test as this is the second time I&apos;ve broken the sstableloader with SSL changes and modified the client setup to explicitly set the accepted protocols on the returned SSLEngine until the client can be modified to set it.&lt;/p&gt;</comment>
                            <comment id="17253347" author="adejanovski" created="Tue, 22 Dec 2020 09:04:02 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmeredithco&quot; class=&quot;user-hover&quot; rel=&quot;jmeredithco&quot;&gt;jmeredithco&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;thanks for issuing a patch.&lt;br/&gt;
I tested it with Medusa&apos;s integration tests and now get the following error:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN  09:57:44,993 Failed to initialize a channel. Closing: [id: 0x61e6eef5]
java.lang.IllegalArgumentException: TLSv1.3
	at sun.security.ssl.ProtocolVersion.valueOf(ProtocolVersion.java:187)
	at sun.security.ssl.ProtocolList.convert(ProtocolList.java:84)
	at sun.security.ssl.ProtocolList.&amp;lt;init&amp;gt;(ProtocolList.java:52)
	at sun.security.ssl.SSLEngineImpl.setEnabledProtocols(SSLEngineImpl.java:2081)
	at org.apache.cassandra.tools.BulkLoader$1.newSSLEngine(BulkLoader.java:276)
	at com.datastax.driver.core.RemoteEndpointAwareJdkSSLOptions.newSSLHandler(RemoteEndpointAwareJdkSSLOptions.java:62)
	at com.datastax.driver.core.Connection$Initializer.initChannel(Connection.java:1700)
	at com.datastax.driver.core.Connection$Initializer.initChannel(Connection.java:1644)
	at com.datastax.shaded.netty.channel.ChannelInitializer.initChannel(ChannelInitializer.java:113)
	at com.datastax.shaded.netty.channel.ChannelInitializer.handlerAdded(ChannelInitializer.java:105)
	at com.datastax.shaded.netty.channel.DefaultChannelPipeline.callHandlerAdded0(DefaultChannelPipeline.java:593)
	at com.datastax.shaded.netty.channel.DefaultChannelPipeline.access$000(DefaultChannelPipeline.java:44)
	at com.datastax.shaded.netty.channel.DefaultChannelPipeline$PendingHandlerAddedTask.execute(DefaultChannelPipeline.java:1357)
	at com.datastax.shaded.netty.channel.DefaultChannelPipeline.callHandlerAddedForAllHandlers(DefaultChannelPipeline.java:1092)
	at com.datastax.shaded.netty.channel.DefaultChannelPipeline.invokeHandlerAddedIfNeeded(DefaultChannelPipeline.java:642)
	at com.datastax.shaded.netty.channel.AbstractChannel$AbstractUnsafe.register0(AbstractChannel.java:456)
	at com.datastax.shaded.netty.channel.AbstractChannel$AbstractUnsafe.access$200(AbstractChannel.java:378)
	at com.datastax.shaded.netty.channel.AbstractChannel$AbstractUnsafe$1.run(AbstractChannel.java:428)
	at com.datastax.shaded.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:399)
	at com.datastax.shaded.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:464)
	at com.datastax.shaded.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:131)
	at com.datastax.shaded.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:748)
All host(s) tried for query failed (tried: localhost/127.0.0.1:9042 (com.datastax.driver.core.exceptions.TransportException: [localhost/127.0.0.1:9042] Cannot connect))
com.datastax.driver.core.exceptions.NoHostAvailableException: All host(s) tried for query failed (tried: localhost/127.0.0.1:9042 (com.datastax.driver.core.exceptions.TransportException: [localhost/127.0.0.1:9042] Cannot connect))
	at com.datastax.driver.core.ControlConnection.reconnectInternal(ControlConnection.java:268)
	at com.datastax.driver.core.ControlConnection.connect(ControlConnection.java:107)
	at com.datastax.driver.core.Cluster$Manager.negotiateProtocolVersionAndConnect(Cluster.java:1813)
	at com.datastax.driver.core.Cluster$Manager.init(Cluster.java:1726)
	at com.datastax.driver.core.Cluster.init(Cluster.java:214)
	at com.datastax.driver.core.Cluster.connectAsync(Cluster.java:387)
	at com.datastax.driver.core.Cluster.connectAsync(Cluster.java:366)
	at com.datastax.driver.core.Cluster.connect(Cluster.java:311)
	at org.apache.cassandra.utils.NativeSSTableLoaderClient.init(NativeSSTableLoaderClient.java:75)
	at org.apache.cassandra.io.sstable.SSTableLoader.stream(SSTableLoader.java:183)
	at org.apache.cassandra.tools.BulkLoader.load(BulkLoader.java:79)
	at org.apache.cassandra.tools.BulkLoader.main(BulkLoader.java:51)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here&apos;s the sstableloader command that is being issued:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;subprocess.CalledProcessError: Command &apos;[&apos;/Users/adejanovski/.ccm/repository/githubCOLONjonmeredithSLASHC16362/bin/sstableloader&apos;, &apos;-d&apos;, &apos;127.0.0.1&apos;, &apos;--conf-path&apos;, &apos;/Users/adejanovski/.ccm/scenario11/node1/conf/cassandra.yaml&apos;, &apos;--username&apos;, &apos;cassandra&apos;, &apos;--password&apos;, &apos;cassandra&apos;, &apos;--no-progress&apos;, &apos;/tmp/medusa-restore-97ec3e11-426a-4924-8bc0-379e99ff2205/system_distributed/repair_history-759fffad624b318180eefa9a52d1f627&apos;, &apos;-ts&apos;, &apos;/Users/adejanovski/projets/cassandra/thelastpickle/cassandra-medusa/tests/resources/local_with_ssl/generic-server-truststore.jks&apos;, &apos;-tspw&apos;, &apos;truststorePass1&apos;, &apos;-ks&apos;, &apos;/Users/adejanovski/projets/cassandra/thelastpickle/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks&apos;, &apos;-kspw&apos;, &apos;testdata1&apos;]&apos;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is there a problem with the default SSL protocol version? Should we enforce it when invoking sstableloader?&lt;/p&gt;</comment>
                            <comment id="17253555" author="jmeredithco" created="Tue, 22 Dec 2020 15:07:26 +0000"  >&lt;p&gt;Thanks for testing the patch. Looks like your JVM/configuration doesn&apos;t have TLSv1.3 enabled.&lt;/p&gt;

&lt;p&gt;The problem comes back to SSLContext.getInstance argument is more of a protocol profile than a list of protocols, but Netty OpenSSL support requires an explicit list of accepted protocols, so the original generic &lt;tt&gt;TLS&lt;/tt&gt; was converted to a default list and for backward compatibility and I included TLSv1.3 in there.&lt;/p&gt;

&lt;p&gt;That list needs to be filtered by versions supported by the SSLEngine. I&apos;ll try and update the patch in the next day or so.&lt;/p&gt;</comment>
                            <comment id="17259252" author="jmeredithco" created="Tue, 5 Jan 2021 22:24:09 +0000"  >&lt;p&gt;Apologies a couple of days became a couple of weeks.&lt;/p&gt;

&lt;p&gt;I&apos;ve reworked the patch to remove the hard-coded list of protocols when the legacy &quot;TLS&quot; protocol is selected. Instead the protocol list is created from &lt;tt&gt;SSLContext.getInstance(&quot;TLS&quot;)&lt;/tt&gt; directly during initialization.&lt;/p&gt;

&lt;p&gt;This does have the consequence of including SSLFactory as an import for DatabaseDescriptor, but I don&apos;t think that causes any significant issues.&lt;/p&gt;

&lt;p&gt;The stress tool also has the same issues as BulkLoader so I&apos;ve also updated that to apply protocols correctly.&lt;/p&gt;</comment>
                            <comment id="17259278" author="dcapwell" created="Tue, 5 Jan 2021 23:16:08 +0000"  >&lt;p&gt;+1 from me, only small nits in the PR&lt;/p&gt;</comment>
                            <comment id="17259318" author="djoshi3" created="Wed, 6 Jan 2021 00:41:40 +0000"  >&lt;p&gt;+1 lgtm.&lt;/p&gt;</comment>
                            <comment id="17260832" author="dcapwell" created="Thu, 7 Jan 2021 21:13:03 +0000"  >&lt;p&gt;Starting commit&lt;/p&gt;

&lt;p&gt;CI Results (pending):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-16362-trunk-87BA7E88-24F7-4F84-A26B-3A7B781C9B57&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-16362-trunk-87BA7E88-24F7-4F84-A26B-3A7B781C9B57&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;build|unknown&amp;#93;&lt;/span&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17261430" author="jmeredithco" created="Fri, 8 Jan 2021 16:46:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adejanovski&quot; class=&quot;user-hover&quot; rel=&quot;adejanovski&quot;&gt;adejanovski&lt;/a&gt;&#160;would you be able to rerun the Medusa integration test to verify we&apos;ve resolved the problem?&lt;/p&gt;</comment>
                            <comment id="17261431" author="adejanovski" created="Fri, 8 Jan 2021 16:48:24 +0000"  >&lt;p&gt;Sure thing, I&apos;ll run a test ASAP.&lt;/p&gt;</comment>
                            <comment id="17262634" author="adejanovski" created="Mon, 11 Jan 2021 13:09:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmeredithco&quot; class=&quot;user-hover&quot; rel=&quot;jmeredithco&quot;&gt;jmeredithco&lt;/a&gt;, it&apos;s now failing earlier in the process as I can&apos;t get the Python CQL driver to connect to Cassandra when encryption is turned on. I&apos;ve tried using TLS 1.1 and TLS 1.2 with the same result...&lt;br/&gt;
Previously we were failing later in the process as we could connect using the Python driver but failed at using the sstableloader.&lt;/p&gt;

&lt;p&gt;Any idea of what could be preventing us from connecting with TLS 1.1 and 1.2 when using the python driver?&lt;br/&gt;
Our implementation follows what&apos;s described in &lt;a href=&quot;https://docs.datastax.com/en/developer/python-driver/3.24/security/#ssl-configuration-examples&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this driver documentation page&lt;/a&gt;.&lt;/p&gt;
</comment>
                            <comment id="17262812" author="dcapwell" created="Mon, 11 Jan 2021 17:20:33 +0000"  >&lt;p&gt;If still an issue, reopening&lt;/p&gt;</comment>
                            <comment id="17262993" author="jmeredithco" created="Tue, 12 Jan 2021 00:09:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adejanovski&quot; class=&quot;user-hover&quot; rel=&quot;adejanovski&quot;&gt;adejanovski&lt;/a&gt;&#160;sorry you&apos;re still having issues.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what the issue is with the python driver - as a work around you could try explicitly configuring tls1.1 and tls1.2 in the new accepted_protocols parameter.&lt;/p&gt;

&lt;p&gt;I had a go at getting the medusa integration tests and also the python integration tests but wasn&apos;t able to get things working wit 3.11.7 before trying the 4.0 changes.&lt;/p&gt;

&lt;p&gt;So I can reproduce, how are you running the tests and what OS / java version / python version are you using?&lt;/p&gt;</comment>
                            <comment id="17268700" author="jmeredithco" created="Wed, 20 Jan 2021 17:09:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adejanovski&quot; class=&quot;user-hover&quot; rel=&quot;adejanovski&quot;&gt;adejanovski&lt;/a&gt; I&apos;ve set up Medusa on a CentOS7 box and run the local integration tests and I&apos;m not able to get a clean run before any of the recent SSL changes I&apos;ve made (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13325&quot; title=&quot;Bring back the accepted encryption protocols list as configurable option&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13325&quot;&gt;&lt;del&gt;CASSANDRA-13325&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16144&quot; title=&quot;TLS connections to the storage port on a node without server encryption configured causes java.io.IOException accessing missing keystore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16144&quot;&gt;&lt;del&gt;CASSANDRA-16144&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16362&quot; title=&quot;SSLFactory should initialize SSLContext before setting protocols&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16362&quot;&gt;&lt;del&gt;CASSANDRA-16362&lt;/del&gt;&lt;/a&gt;). &lt;tt&gt;cassandra-4.0-beta3&lt;/tt&gt; is the release before the changes and that fails for me under &lt;tt&gt;scenario11&lt;/tt&gt; as does &lt;tt&gt;cassandra-4.0-beta1&lt;/tt&gt;, or dcabf7e2693534be62f70f9d08345562da2070ba (the commit before the internode messaging refactor &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15066&quot; title=&quot;Improvements to Internode Messaging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15066&quot;&gt;&lt;del&gt;CASSANDRA-15066&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;The last official release I&apos;ve had the test pass on is 3.11.9&lt;/p&gt;</comment>
                            <comment id="17268732" author="adejanovski" created="Wed, 20 Jan 2021 17:55:49 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmeredithco&quot; class=&quot;user-hover&quot; rel=&quot;jmeredithco&quot;&gt;jmeredithco&lt;/a&gt;, &lt;/p&gt;

&lt;p&gt;very sorry for not responding earlier, I&apos;m heads down on 4.0 repair quality testing at the moment.&lt;br/&gt;
A colleague of mine is working on giving you steps to reproduce the issue with ccm and will comment here soon with the instructions.&lt;br/&gt;
For Medusa integration tests, there have been issues with the sstableloader test (scenario 11) which was fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16280&quot; title=&quot;SSTableLoader will fail if encryption parameters are used due to CASSANDRA-16144&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16280&quot;&gt;&lt;del&gt;CASSANDRA-16280&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
I manage to get the scenario 11 passing with beta3:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
(py36) adejanovski@mac-alex-2 cassandra-medusa % ./run_integration_tests.sh -t 11 --cassandra-version=4.0-beta3
...
...
  @11 @local
  Scenario Outline: Perform a backup, and restore it using the sstableloader -- @1.1 Local storage  # integration/features/integration_tests.feature:450
    Given I have a fresh ccm cluster &lt;span class=&quot;code-quote&quot;&gt;&quot;with_client_encryption&quot;&lt;/span&gt; running named &lt;span class=&quot;code-quote&quot;&gt;&quot;scenario11&quot;&lt;/span&gt;            # features/steps/integration_steps.py:125
    Given I have a fresh ccm cluster &lt;span class=&quot;code-quote&quot;&gt;&quot;with_client_encryption&quot;&lt;/span&gt; running named &lt;span class=&quot;code-quote&quot;&gt;&quot;scenario11&quot;&lt;/span&gt;            # features/steps/integration_steps.py:125 22.497s
    Given I am using &lt;span class=&quot;code-quote&quot;&gt;&quot;local&quot;&lt;/span&gt; as storage provider in ccm cluster &lt;span class=&quot;code-quote&quot;&gt;&quot;with_client_encryption&quot;&lt;/span&gt;            # features/steps/integration_steps.py:235 0.052s
    When I create the &lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt; table in keyspace &lt;span class=&quot;code-quote&quot;&gt;&quot;medusa&quot;&lt;/span&gt;                                             # features/steps/integration_steps.py:511 0.122s
    When I load 100 rows in the &lt;span class=&quot;code-quote&quot;&gt;&quot;medusa.test&quot;&lt;/span&gt; table                                                 # features/steps/integration_steps.py:534 0.192s
    When I run a &lt;span class=&quot;code-quote&quot;&gt;&quot;ccm node1 nodetool flush&quot;&lt;/span&gt; command                                                 # features/steps/integration_steps.py:542 1.508s
    When I load 100 rows in the &lt;span class=&quot;code-quote&quot;&gt;&quot;medusa.test&quot;&lt;/span&gt; table                                                 # features/steps/integration_steps.py:534 0.160s
    When I run a &lt;span class=&quot;code-quote&quot;&gt;&quot;ccm node1 nodetool flush&quot;&lt;/span&gt; command                                                 # features/steps/integration_steps.py:542 1.445s
    When I perform a backup in &lt;span class=&quot;code-quote&quot;&gt;&quot;full&quot;&lt;/span&gt; mode of the node named &lt;span class=&quot;code-quote&quot;&gt;&quot;first_backup&quot;&lt;/span&gt;                         # features/steps/integration_steps.py:547 3.208s
    Then I can see the backup named &lt;span class=&quot;code-quote&quot;&gt;&quot;first_backup&quot;&lt;/span&gt; when I list the backups                          # features/steps/integration_steps.py:591 0.014s
    Then I can verify the backup named &lt;span class=&quot;code-quote&quot;&gt;&quot;first_backup&quot;&lt;/span&gt; successfully                                  # features/steps/integration_steps.py:655 0.029s
    When I load 100 rows in the &lt;span class=&quot;code-quote&quot;&gt;&quot;medusa.test&quot;&lt;/span&gt; table                                                 # features/steps/integration_steps.py:534 0.135s
    When I run a &lt;span class=&quot;code-quote&quot;&gt;&quot;ccm node1 nodetool flush&quot;&lt;/span&gt; command                                                 # features/steps/integration_steps.py:542 1.373s
    Then I have 300 rows in the &lt;span class=&quot;code-quote&quot;&gt;&quot;medusa.test&quot;&lt;/span&gt; table in ccm cluster &lt;span class=&quot;code-quote&quot;&gt;&quot;with_client_encryption&quot;&lt;/span&gt;         # features/steps/integration_steps.py:766 0.119s
    When I truncate the &lt;span class=&quot;code-quote&quot;&gt;&quot;medusa.test&quot;&lt;/span&gt; table in ccm cluster &lt;span class=&quot;code-quote&quot;&gt;&quot;with_client_encryption&quot;&lt;/span&gt;                 # features/steps/integration_steps.py:1040 0.167s
    When I restore the backup named &lt;span class=&quot;code-quote&quot;&gt;&quot;first_backup&quot;&lt;/span&gt; with the sstableloader                           # features/steps/integration_steps.py:734 20.214s
    Then I have 200 rows in the &lt;span class=&quot;code-quote&quot;&gt;&quot;medusa.test&quot;&lt;/span&gt; table in ccm cluster &lt;span class=&quot;code-quote&quot;&gt;&quot;with_client_encryption&quot;&lt;/span&gt;         # features/steps/integration_steps.py:766 0.079s
...
...
1 feature passed, 0 failed, 0 skipped
1 scenario passed, 0 failed, 59 skipped
16 steps passed, 0 failed, 1039 skipped, 0 undefined
Took 0m51.312s
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But it fails with beta4 due to the issue reported in this very ticket: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;./run_integration_tests.sh -t 11 --cassandra-version=4.0-beta4
...
...
  @11 @local
  Scenario Outline: Perform a backup, and restore it using the sstableloader -- @1.1 Local storage  # integration/features/integration_tests.feature:450
    Given I have a fresh ccm cluster &quot;with_client_encryption&quot; running named &quot;scenario11&quot;            # features/steps/integration_steps.py:125
    Given I have a fresh ccm cluster &quot;with_client_encryption&quot; running named &quot;scenario11&quot;            # features/steps/integration_steps.py:125 22.836s
    Given I am using &quot;local&quot; as storage provider in ccm cluster &quot;with_client_encryption&quot;            # features/steps/integration_steps.py:235 0.053s
    When I create the &quot;test&quot; table in keyspace &quot;medusa&quot;                                             # features/steps/integration_steps.py:511 0.113s
    When I load 100 rows in the &quot;medusa.test&quot; table                                                 # features/steps/integration_steps.py:534 0.229s
    When I run a &quot;ccm node1 nodetool flush&quot; command                                                 # features/steps/integration_steps.py:542 1.424s
    When I load 100 rows in the &quot;medusa.test&quot; table                                                 # features/steps/integration_steps.py:534 0.149s
    When I run a &quot;ccm node1 nodetool flush&quot; command                                                 # features/steps/integration_steps.py:542 1.208s
    When I perform a backup in &quot;full&quot; mode of the node named &quot;first_backup&quot;                         # features/steps/integration_steps.py:547 2.832s
    Then I can see the backup named &quot;first_backup&quot; when I list the backups                          # features/steps/integration_steps.py:591 0.013s
    Then I can verify the backup named &quot;first_backup&quot; successfully                                  # features/steps/integration_steps.py:655 0.025s
    When I load 100 rows in the &quot;medusa.test&quot; table                                                 # features/steps/integration_steps.py:534 0.109s
    When I run a &quot;ccm node1 nodetool flush&quot; command                                                 # features/steps/integration_steps.py:542 1.213s
    Then I have 300 rows in the &quot;medusa.test&quot; table in ccm cluster &quot;with_client_encryption&quot;         # features/steps/integration_steps.py:766 0.099s
    When I truncate the &quot;medusa.test&quot; table in ccm cluster &quot;with_client_encryption&quot;                 # features/steps/integration_steps.py:1040 0.162s
    When I restore the backup named &quot;first_backup&quot; with the sstableloader                           # features/steps/integration_steps.py:734
Exception in thread &quot;main&quot; java.lang.RuntimeException: Could not create SSL Context.
	at org.apache.cassandra.tools.BulkLoader.buildSSLOptions(BulkLoader.java:261)
	at org.apache.cassandra.tools.BulkLoader.load(BulkLoader.java:64)
	at org.apache.cassandra.tools.BulkLoader.main(BulkLoader.java:49)
Caused by: java.io.IOException: Error creating/initializing the SSL Context
	at org.apache.cassandra.security.SSLFactory.createSSLContext(SSLFactory.java:184)
	at org.apache.cassandra.tools.BulkLoader.buildSSLOptions(BulkLoader.java:257)
	... 2 more
Caused by: java.lang.IllegalStateException: SSLContextImpl is not initialized
	at sun.security.ssl.SSLContextImpl.engineGetSocketFactory(SSLContextImpl.java:172)
	at javax.net.ssl.SSLContextSpi.getDefaultSocket(SSLContextSpi.java:142)
	at javax.net.ssl.SSLContextSpi.engineGetDefaultSSLParameters(SSLContextSpi.java:168)
	at javax.net.ssl.SSLContext.getDefaultSSLParameters(SSLContext.java:419)
	at org.apache.cassandra.security.SSLFactory.createSSLContext(SSLFactory.java:178)
    When I restore the backup named &quot;first_backup&quot; with the sstableloader                           # features/steps/integration_steps.py:734 1.635s
      Traceback (most recent call last):
        File &quot;/Users/adejanovski/projets/cassandra/thelastpickle/py36/lib/python3.6/site-packages/behave/model.py&quot;, line 1329, in run
          match.run(runner.context)
        File &quot;/Users/adejanovski/projets/cassandra/thelastpickle/py36/lib/python3.6/site-packages/behave/matchers.py&quot;, line 98, in run
          self.func(context, *args, **kwargs)
        File &quot;features/steps/integration_steps.py&quot;, line 746, in _i_restore_the_backup_named_with_sstableloader
          use_sstableloader=True,
        File &quot;/Users/adejanovski/projets/cassandra/thelastpickle/cassandra-medusa/medusa/restore_node.py&quot;, line 53, in restore_node
          keyspaces, tables)
        File &quot;/Users/adejanovski/projets/cassandra/thelastpickle/cassandra-medusa/medusa/restore_node.py&quot;, line 172, in restore_node_sstableloader
          invoke_sstableloader(config, download_dir, keep_auth, fqtns_to_restore, cassandra.storage_port)
        File &quot;/Users/adejanovski/projets/cassandra/thelastpickle/cassandra-medusa/medusa/restore_node.py&quot;, line 219, in invoke_sstableloader
          output = subprocess.check_output(sstableloader_args)
        File &quot;/usr/local/Cellar/python/3.6.5/Frameworks/Python.framework/Versions/3.6/lib/python3.6/subprocess.py&quot;, line 336, in check_output
          **kwargs).stdout
        File &quot;/usr/local/Cellar/python/3.6.5/Frameworks/Python.framework/Versions/3.6/lib/python3.6/subprocess.py&quot;, line 418, in run
          output=stdout, stderr=stderr)
      subprocess.CalledProcessError: Command &apos;[&apos;/Users/adejanovski/.ccm/repository/4.0-beta4/bin/sstableloader&apos;, &apos;-d&apos;, &apos;127.0.0.1&apos;, &apos;--conf-path&apos;, &apos;/Users/adejanovski/.ccm/scenario11/node1/conf/cassandra.yaml&apos;, &apos;--username&apos;, &apos;cassandra&apos;, &apos;--password&apos;, &apos;cassandra&apos;, &apos;--no-progress&apos;, &apos;/tmp/medusa-restore-a72a47c8-8776-4de4-9cc1-d5eea23cf434/medusa/test-b9d0a8705b4611eb8be0ede3aec9ec61&apos;, &apos;-ts&apos;, &apos;/Users/adejanovski/projets/cassandra/thelastpickle/cassandra-medusa/tests/resources/local_with_ssl/generic-server-truststore.jks&apos;, &apos;-tspw&apos;, &apos;truststorePass1&apos;, &apos;-ks&apos;, &apos;/Users/adejanovski/projets/cassandra/thelastpickle/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks&apos;, &apos;-kspw&apos;, &apos;testdata1&apos;]&apos; returned non-zero exit status 1.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With trunk now, and since the changes from this ticket were committed, we fail earlier as we cannot connect anymore using the python driver: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;./run_integration_tests.sh -t 1 --cassandra-version=github:apache/trunk
..
..
..
  @11 @local
  Scenario Outline: Perform a backup, and restore it using the sstableloader -- @1.1 Local storage  # integration/features/integration_tests.feature:450
    Given I have a fresh ccm cluster &quot;with_client_encryption&quot; running named &quot;scenario11&quot;            # features/steps/integration_steps.py:125
https://github.com/apache/cassandra.git github:apache/trunk
18:44:54,558 ccm INFO Fetching Cassandra updates...
18:44:55,978 ccm DEBUG Branch up to date, not pulling.
    Given I have a fresh ccm cluster &quot;with_client_encryption&quot; running named &quot;scenario11&quot;            # features/steps/integration_steps.py:125 115.170s
    Given I am using &quot;local&quot; as storage provider in ccm cluster &quot;with_client_encryption&quot;            # features/steps/integration_steps.py:235 0.046s
    When I create the &quot;test&quot; table in keyspace &quot;medusa&quot;                                             # features/steps/integration_steps.py:511 0.001s
      Traceback (most recent call last):
        File &quot;/Users/adejanovski/projets/cassandra/thelastpickle/py36/lib/python3.6/site-packages/behave/model.py&quot;, line 1329, in run
          match.run(runner.context)
        File &quot;/Users/adejanovski/projets/cassandra/thelastpickle/py36/lib/python3.6/site-packages/behave/matchers.py&quot;, line 98, in run
          self.func(context, *args, **kwargs)
        File &quot;features/steps/integration_steps.py&quot;, line 515, in _i_create_the_whatever_table
          context.session.execute(keyspace.format(keyspace_name))
      AttributeError: &apos;NoneType&apos; object has no attribute &apos;execute&apos;
...
...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Using the ccm cluster generated by this last test, we tried to connect to it with the Python driver using both TLS1.1 and 1.2 without success.&lt;/p&gt;</comment>
                            <comment id="17268789" author="jmeredithco" created="Wed, 20 Jan 2021 18:58:23 +0000"  >&lt;p&gt;Thanks for the extra info.  I just spotted a log message I missed about not being able to find sstableloader. When the CCM version is supplied as git:&amp;lt;sha&amp;gt; the &lt;tt&gt;config&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;cassandra&amp;quot;&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;sstableloader_bin&amp;quot;&amp;#93;&lt;/span&gt;&lt;/tt&gt; is set incorrectly and it cannot find it. I&apos;ll keep trying.&lt;/p&gt;</comment>
                            <comment id="17268819" author="adejanovski" created="Wed, 20 Jan 2021 19:37:06 +0000"  >&lt;p&gt;It&apos;s our fault actually. Please use the following branch of Medusa to be able to use forks as Cassandra base for the ccm clusters: &lt;a href=&quot;https://github.com/thelastpickle/cassandra-medusa/tree/alex/CASSANDRA-16362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/thelastpickle/cassandra-medusa/tree/alex/CASSANDRA-16362&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The master branch will only accept &lt;tt&gt;github:apache/...&lt;/tt&gt; versions.&lt;/p&gt;</comment>
                            <comment id="17268858" author="jmeredithco" created="Wed, 20 Jan 2021 20:32:43 +0000"  >&lt;p&gt;Using &lt;tt&gt;github/apache&lt;/tt&gt; did the trick. I&apos;ve been able to reproduce.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN  13:28:18,797 Small commitlog volume detected at &lt;span class=&quot;code-quote&quot;&gt;&apos;/home/jmeredith/.ccm/repository/githubCOLONapacheSLASHcassandra-4.0-beta4/bin/../data/commitlog&apos;&lt;/span&gt;; setting commitlog_total_space_in_mb to 5119.  You can override &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; in cassandra.yaml
WARN  13:28:18,801 Only 13.610GiB free across all data volumes. Consider adding more capacity to your cluster or removing obsolete snapshots
Exception in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt; java.lang.RuntimeException: Could not create SSL Context.
	at org.apache.cassandra.tools.BulkLoader.buildSSLOptions(BulkLoader.java:261)
	at org.apache.cassandra.tools.BulkLoader.load(BulkLoader.java:64)
	at org.apache.cassandra.tools.BulkLoader.main(BulkLoader.java:49)
Caused by: java.io.IOException: Error creating/initializing the SSL Context
	at org.apache.cassandra.security.SSLFactory.createSSLContext(SSLFactory.java:184)
	at org.apache.cassandra.tools.BulkLoader.buildSSLOptions(BulkLoader.java:257)
	... 2 more
Caused by: java.lang.IllegalStateException: SSLContextImpl is not initialized
	at sun.security.ssl.SSLContextImpl.engineGetSocketFactory(SSLContextImpl.java:172)
	at javax.net.ssl.SSLContextSpi.getDefaultSocket(SSLContextSpi.java:142)
	at javax.net.ssl.SSLContextSpi.engineGetDefaultSSLParameters(SSLContextSpi.java:168)
	at javax.net.ssl.SSLContext.getDefaultSSLParameters(SSLContext.java:419)
	at org.apache.cassandra.security.SSLFactory.createSSLContext(SSLFactory.java:178)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17270501" author="jmeredithco" created="Sat, 23 Jan 2021 00:33:19 +0000"  >&lt;p&gt;In the end, it was a simple mistake, replacing the &quot;TLS&quot; with the &lt;tt&gt;getSupportedSSLParameters&lt;/tt&gt; rather than the &lt;tt&gt;getDefaultSSLParameters&lt;/tt&gt; as I had intended.&lt;/p&gt;

&lt;p&gt;I also noticed that Netty always includes the SSLv2Hello pseudo-protocol as Netty claims it is not possible to disable it (&lt;a href=&quot;https://github.com/netty/netty/commit/7a39afd031accea9ee38653afbd58eb1c466deda#diff-d9520f8137242d465d6e625873bfad7b7e27fb10168c144236757d2ec1141b1dR205&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/commit/7a39afd031accea9ee38653afbd58eb1c466deda#diff-d9520f8137242d465d6e625873bfad7b7e27fb10168c144236757d2ec1141b1dR205&lt;/a&gt;).&lt;br/&gt;
 After a bit of reading, it seems like it is was historically used by Java clients to help negotiate the real protocol.&lt;/p&gt;

&lt;p&gt;To avoid unnecessarily scaring people (and auditors) that SSLv2 is enabled when it is not I&apos;ve added a filter for SSLv2Hello in the info level message, and log the full list at debug level.&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed two new commits we can squash on merge that fix the Supported-&amp;gt;Default bug, and filter out SSLv2Hello.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/jonmeredith/cassandra/tree/C16362-switch-to-default-options&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jonmeredith/cassandra/tree/C16362-switch-to-default-options&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;CircleCI &lt;a href=&quot;https://app.circleci.com/pipelines/github/jonmeredith/cassandra?branch=C16362-switch-to-default-options&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jonmeredith/cassandra?branch=C16362-switch-to-default-options&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;br/&gt;
To prove to myself that the protocols served match the configuration, I&apos;ve run a combination of protocol settings and JVM versions and checked the testssl.sh and log output.&lt;br/&gt;
For each cluster name (made up of java version and protocol option configured) this lists the client encryption options, the log lines emitted and the protocol test section of the testssl.sh output.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
=== Cluster /home/jmeredith/.ccm/c16362_11_0_9_11_2_ ===
client_encryption_options:
  algorithm: SunX509
  enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  keystore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks
  optional: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  require_client_auth: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  store_type: JKS
  truststore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;-server-truststore.jks
DEBUG [main] 2021-01-22 15:08:45,259 SSLFactory.java:517 - Native transport supported TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
DEBUG [main] 2021-01-22 15:08:45,259 SSLFactory.java:519 - Native transport unfiltered enabled TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
INFO  [main] 2021-01-22 15:08:45,259 SSLFactory.java:521 - Native transport enabled TLS protocols: TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
 Testing protocols via sockets except NPN+ALPN 

 SSLv2      not offered (OK)
 SSLv3      not offered (OK)
 TLS 1      offered (deprecated)
 TLS 1.1    offered (deprecated)
 TLS 1.2    offered (OK)
 TLS 1.3    offered (OK): &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt;
 NPN/SPDY   not offered
 ALPN/HTTP2 not offered


=== Cluster /home/jmeredith/.ccm/c16362_11_0_9_11_2_TLS ===
client_encryption_options:
  algorithm: SunX509
  enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  keystore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks
  optional: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  protocol: TLS
  require_client_auth: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  store_type: JKS
  truststore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;-server-truststore.jks
DEBUG [main] 2021-01-22 15:13:06,715 SSLFactory.java:517 - Native transport supported TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
DEBUG [main] 2021-01-22 15:13:06,715 SSLFactory.java:519 - Native transport unfiltered enabled TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
INFO  [main] 2021-01-22 15:13:06,715 SSLFactory.java:521 - Native transport enabled TLS protocols: TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
 Testing protocols via sockets except NPN+ALPN 

 SSLv2      not offered (OK)
 SSLv3      not offered (OK)
 TLS 1      offered (deprecated)
 TLS 1.1    offered (deprecated)
 TLS 1.2    offered (OK)
 TLS 1.3    offered (OK): &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt;
 NPN/SPDY   not offered
 ALPN/HTTP2 not offered


=== Cluster /home/jmeredith/.ccm/c16362_11_0_9_11_2_TLSv1_2 ===
client_encryption_options:
  algorithm: SunX509
  enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  keystore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks
  optional: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  protocol: TLSv1.2
  require_client_auth: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  store_type: JKS
  truststore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;-server-truststore.jks
DEBUG [main] 2021-01-22 15:17:32,582 SSLFactory.java:517 - Native transport supported TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
DEBUG [main] 2021-01-22 15:17:32,587 SSLFactory.java:519 - Native transport unfiltered enabled TLS protocols: SSLv2Hello, TLSv1.2
INFO  [main] 2021-01-22 15:17:32,587 SSLFactory.java:521 - Native transport enabled TLS protocols: TLSv1.2
 Testing protocols via sockets except NPN+ALPN 

 SSLv2      not offered (OK)
 SSLv3      not offered (OK)
 TLS 1      not offered
 TLS 1.1    not offered
 TLS 1.2    offered (OK)
 TLS 1.3    not offered and downgraded to a weaker protocol
 NPN/SPDY   not offered
 ALPN/HTTP2 not offered


=== Cluster /home/jmeredith/.ccm/c16362_11_0_9_11_2_TLSv1_3 ===
client_encryption_options:
  algorithm: SunX509
  enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  keystore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks
  optional: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  protocol: TLSv1.3
  require_client_auth: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  store_type: JKS
  truststore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;-server-truststore.jks
DEBUG [main] 2021-01-22 15:21:42,102 SSLFactory.java:517 - Native transport supported TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
DEBUG [main] 2021-01-22 15:21:42,102 SSLFactory.java:519 - Native transport unfiltered enabled TLS protocols: SSLv2Hello, TLSv1.3
INFO  [main] 2021-01-22 15:21:42,102 SSLFactory.java:521 - Native transport enabled TLS protocols: TLSv1.3
 Testing protocols via sockets except NPN+ALPN 

 SSLv2      not offered (OK)
 SSLv3      not offered (OK)
 TLS 1      not offered
 TLS 1.1    not offered
 TLS 1.2    not offered
 TLS 1.3    offered (OK): &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt;
 NPN/SPDY   not offered
 ALPN/HTTP2 not offered


=== Cluster /home/jmeredith/.ccm/c16362_1_8_0_161_2_b14_ ===
client_encryption_options:
  algorithm: SunX509
  enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  keystore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks
  optional: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  require_client_auth: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  store_type: JKS
  truststore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;-server-truststore.jks
DEBUG [main] 2021-01-22 14:31:57,882 SSLFactory.java:517 - Native transport supported TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
DEBUG [main] 2021-01-22 14:31:57,882 SSLFactory.java:519 - Native transport unfiltered enabled TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
INFO  [main] 2021-01-22 14:31:57,882 SSLFactory.java:521 - Native transport enabled TLS protocols: TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
 Testing protocols via sockets except NPN+ALPN 

 SSLv2      not offered (OK)
 SSLv3      not offered (OK)
 TLS 1      offered (deprecated)
 TLS 1.1    offered (deprecated)
 TLS 1.2    offered (OK)
 TLS 1.3    offered (OK): &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt;
 NPN/SPDY   not offered
 ALPN/HTTP2 not offered


=== Cluster /home/jmeredith/.ccm/c16362_1_8_0_161_2_b14_TLS ===
client_encryption_options:
  algorithm: SunX509
  enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  keystore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks
  optional: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  protocol: TLS
  require_client_auth: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  store_type: JKS
  truststore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;-server-truststore.jks
DEBUG [main] 2021-01-22 14:36:27,957 SSLFactory.java:517 - Native transport supported TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
DEBUG [main] 2021-01-22 14:36:27,957 SSLFactory.java:519 - Native transport unfiltered enabled TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2
INFO  [main] 2021-01-22 14:36:27,957 SSLFactory.java:521 - Native transport enabled TLS protocols: TLSv1, TLSv1.1, TLSv1.2
 Testing protocols via sockets except NPN+ALPN 

 SSLv2      not offered (OK)
 SSLv3      not offered (OK)
 TLS 1      offered (deprecated)
 TLS 1.1    offered (deprecated)
 TLS 1.2    offered (OK)
 TLS 1.3    not offered and downgraded to a weaker protocol
 NPN/SPDY   not offered
 ALPN/HTTP2 not offered


=== Cluster /home/jmeredith/.ccm/c16362_1_8_0_161_2_b14_TLSv1_2 ===
client_encryption_options:
  algorithm: SunX509
  enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  keystore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks
  optional: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  protocol: TLSv1.2
  require_client_auth: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  store_type: JKS
  truststore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;-server-truststore.jks
DEBUG [main] 2021-01-22 14:40:51,398 SSLFactory.java:517 - Native transport supported TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
DEBUG [main] 2021-01-22 14:40:51,398 SSLFactory.java:519 - Native transport unfiltered enabled TLS protocols: SSLv2Hello, TLSv1.2
INFO  [main] 2021-01-22 14:40:51,398 SSLFactory.java:521 - Native transport enabled TLS protocols: TLSv1.2
 Testing protocols via sockets except NPN+ALPN 

 SSLv2      not offered (OK)
 SSLv3      not offered (OK)
 TLS 1      not offered
 TLS 1.1    not offered
 TLS 1.2    offered (OK)
 TLS 1.3    not offered and downgraded to a weaker protocol
 NPN/SPDY   not offered
 ALPN/HTTP2 not offered


=== Cluster /home/jmeredith/.ccm/c16362_1_8_0_161_2_b14_TLSv1_3 ===
client_encryption_options:
  algorithm: SunX509
  enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  keystore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks
  optional: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  protocol: TLSv1.3
  require_client_auth: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  store_type: JKS
  truststore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;-server-truststore.jks
DEBUG [main] 2021-01-22 14:45:04,453 SSLFactory.java:517 - Native transport supported TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
DEBUG [main] 2021-01-22 14:45:04,453 SSLFactory.java:519 - Native transport unfiltered enabled TLS protocols: SSLv2Hello, TLSv1.3
INFO  [main] 2021-01-22 14:45:04,454 SSLFactory.java:521 - Native transport enabled TLS protocols: TLSv1.3
 Testing protocols via sockets except NPN+ALPN 

 SSLv2      not offered (OK)
 SSLv3      not offered (OK)
 TLS 1      not offered
 TLS 1.1    not offered
 TLS 1.2    not offered
 TLS 1.3    offered (OK): &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt;
 NPN/SPDY   not offered
 ALPN/HTTP2 not offered


=== Cluster /home/jmeredith/.ccm/c16362_1_8_0_222_b10_ ===
client_encryption_options:
  algorithm: SunX509
  enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  keystore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks
  optional: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  require_client_auth: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  store_type: JKS
  truststore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;-server-truststore.jks
DEBUG [main] 2021-01-22 14:50:21,956 SSLFactory.java:517 - Native transport supported TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
DEBUG [main] 2021-01-22 14:50:21,957 SSLFactory.java:519 - Native transport unfiltered enabled TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
INFO  [main] 2021-01-22 14:50:21,957 SSLFactory.java:521 - Native transport enabled TLS protocols: TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
 Testing protocols via sockets except NPN+ALPN 

 SSLv2      not offered (OK)
 SSLv3      not offered (OK)
 TLS 1      offered (deprecated)
 TLS 1.1    offered (deprecated)
 TLS 1.2    offered (OK)
 TLS 1.3    offered (OK): &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt;
 NPN/SPDY   not offered
 ALPN/HTTP2 not offered


=== Cluster /home/jmeredith/.ccm/c16362_1_8_0_222_b10_TLS ===
client_encryption_options:
  algorithm: SunX509
  enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  keystore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks
  optional: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  protocol: TLS
  require_client_auth: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  store_type: JKS
  truststore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;-server-truststore.jks
DEBUG [main] 2021-01-22 14:54:35,390 SSLFactory.java:517 - Native transport supported TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
DEBUG [main] 2021-01-22 14:54:35,390 SSLFactory.java:519 - Native transport unfiltered enabled TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2
INFO  [main] 2021-01-22 14:54:35,390 SSLFactory.java:521 - Native transport enabled TLS protocols: TLSv1, TLSv1.1, TLSv1.2
 Testing protocols via sockets except NPN+ALPN 

 SSLv2      not offered (OK)
 SSLv3      not offered (OK)
 TLS 1      offered (deprecated)
 TLS 1.1    offered (deprecated)
 TLS 1.2    offered (OK)
 TLS 1.3    not offered and downgraded to a weaker protocol
 NPN/SPDY   not offered
 ALPN/HTTP2 not offered


=== Cluster /home/jmeredith/.ccm/c16362_1_8_0_222_b10_TLSv1_2 ===
client_encryption_options:
  algorithm: SunX509
  enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  keystore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks
  optional: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  protocol: TLSv1.2
  require_client_auth: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  store_type: JKS
  truststore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;-server-truststore.jks
DEBUG [main] 2021-01-22 14:58:48,919 SSLFactory.java:517 - Native transport supported TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
DEBUG [main] 2021-01-22 14:58:48,919 SSLFactory.java:519 - Native transport unfiltered enabled TLS protocols: SSLv2Hello, TLSv1.2
INFO  [main] 2021-01-22 14:58:48,920 SSLFactory.java:521 - Native transport enabled TLS protocols: TLSv1.2
 Testing protocols via sockets except NPN+ALPN 

 SSLv2      not offered (OK)
 SSLv3      not offered (OK)
 TLS 1      not offered
 TLS 1.1    not offered
 TLS 1.2    offered (OK)
 TLS 1.3    not offered and downgraded to a weaker protocol
 NPN/SPDY   not offered
 ALPN/HTTP2 not offered


=== Cluster /home/jmeredith/.ccm/c16362_1_8_0_222_b10_TLSv1_3 ===
client_encryption_options:
  algorithm: SunX509
  enabled: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  keystore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/127.0.0.1.jks
  optional: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
  protocol: TLSv1.3
  require_client_auth: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
  store_type: JKS
  truststore: /home/jmeredith/cassandra-medusa/tests/resources/local_with_ssl/&lt;span class=&quot;code-keyword&quot;&gt;generic&lt;/span&gt;-server-truststore.jks
DEBUG [main] 2021-01-22 15:02:57,010 SSLFactory.java:517 - Native transport supported TLS protocols: SSLv2Hello, TLSv1, TLSv1.1, TLSv1.2, TLSv1.3
DEBUG [main] 2021-01-22 15:02:57,010 SSLFactory.java:519 - Native transport unfiltered enabled TLS protocols: SSLv2Hello, TLSv1.3
INFO  [main] 2021-01-22 15:02:57,010 SSLFactory.java:521 - Native transport enabled TLS protocols: TLSv1.3
 Testing protocols via sockets except NPN+ALPN 

 SSLv2      not offered (OK)
 SSLv3      not offered (OK)
 TLS 1      not offered
 TLS 1.1    not offered
 TLS 1.2    not offered
 TLS 1.3    offered (OK): &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt;
 NPN/SPDY   not offered
 ALPN/HTTP2 not offered

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17271338" author="adejanovski" created="Mon, 25 Jan 2021 14:33:14 +0000"  >&lt;p&gt;Awesome findings &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmeredithco&quot; class=&quot;user-hover&quot; rel=&quot;jmeredithco&quot;&gt;jmeredithco&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;I managed to have the tests pass using your new branch on my laptop but they&apos;re still failing in CI for some odd reason: &lt;a href=&quot;https://github.com/thelastpickle/cassandra-medusa/runs/1762379270?check_suite_focus=true&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/thelastpickle/cassandra-medusa/runs/1762379270?check_suite_focus=true&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ll investigate further to see where the problem lies specifically and update here.&lt;/p&gt;</comment>
                            <comment id="17271368" author="jmeredithco" created="Mon, 25 Jan 2021 15:28:47 +0000"  >&lt;p&gt;Thanks for rechecking. Glad it&apos;s better locally.  Here&apos;s the patch I used on the integration tests to pick up my branch, but it&apos;s probably functionally the same as yours.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
diff --git a/medusa/restore_node.py b/medusa/restore_node.py
index f867ef1..90133d6 100644
--- a/medusa/restore_node.py
+++ b/medusa/restore_node.py
@@ -190,8 +190,7 @@ def invoke_sstableloader(config, download_dir, keep_auth, fqtns_to_restore, stor
                     logging.debug(&lt;span class=&quot;code-quote&quot;&gt;&apos;Restoring table {} with sstableloader...&apos;&lt;/span&gt;.format(table))
                     cql_username = &lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; config.cassandra.cql_username is None &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; config.cassandra.cql_username
                     cql_password = &lt;span class=&quot;code-quote&quot;&gt;&apos;foo&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; config.cassandra.cql_password is None &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; config.cassandra.cql_password
-                    sstableloader_args = [config.cassandra.sstableloader_bin.replace(
-                                          &lt;span class=&quot;code-quote&quot;&gt;&quot;github:apache/&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;githubCOLONapacheSLASH&quot;&lt;/span&gt;),
+                    sstableloader_args = [config.cassandra.sstableloader_bin,
                                           &lt;span class=&quot;code-quote&quot;&gt;&apos;-d&apos;&lt;/span&gt;, hostname_resolver.resolve_fqdn() &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; cassandra_is_ccm == 0
                                           &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&apos;127.0.0.1&apos;&lt;/span&gt;,
                                           &lt;span class=&quot;code-quote&quot;&gt;&apos;--conf-path&apos;&lt;/span&gt;, config.cassandra.config_file,
diff --git a/tests/integration/features/steps/integration_steps.py b/tests/integration/features/steps/integration_steps.py
index 8daf11f..c09628f 100644
--- a/tests/integration/features/steps/integration_steps.py
+++ b/tests/integration/features/steps/integration_steps.py
@@ -316,6 +316,7 @@ def i_am_using_storage_provider(context, storage_provider, client_encryption):
             &lt;span class=&quot;code-quote&quot;&gt;&quot;transfer_max_bandwidth&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;1MB/s&quot;&lt;/span&gt;
         }
 
+    repository_version_path = context.cassandra_version.replace(&lt;span class=&quot;code-quote&quot;&gt;&quot;:&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;COLON&quot;&lt;/span&gt;).replace(&lt;span class=&quot;code-quote&quot;&gt;&quot;/&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;SLASH&quot;&lt;/span&gt;)
     config[&lt;span class=&quot;code-quote&quot;&gt;&quot;cassandra&quot;&lt;/span&gt;] = {
         &lt;span class=&quot;code-quote&quot;&gt;&quot;is_ccm&quot;&lt;/span&gt;: 1,
         &lt;span class=&quot;code-quote&quot;&gt;&quot;stop_cmd&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;ccm stop&quot;&lt;/span&gt;,
@@ -331,7 +332,7 @@ def i_am_using_storage_provider(context, storage_provider, client_encryption):
             os.path.join(
                 &lt;span class=&quot;code-quote&quot;&gt;&quot;~/.ccm&quot;&lt;/span&gt;,
                 &lt;span class=&quot;code-quote&quot;&gt;&quot;repository&quot;&lt;/span&gt;,
-                context.cassandra_version,
+                repository_version_path,
                 &lt;span class=&quot;code-quote&quot;&gt;&quot;bin&quot;&lt;/span&gt;,
                 &lt;span class=&quot;code-quote&quot;&gt;&quot;sstableloader&quot;&lt;/span&gt;,
             )
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17273009" author="jmeredithco" created="Wed, 27 Jan 2021 17:12:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adejanovski&quot; class=&quot;user-hover&quot; rel=&quot;adejanovski&quot;&gt;adejanovski&lt;/a&gt;&#160;did you get a chance to check your CI system?&lt;/p&gt;</comment>
                            <comment id="17273053" author="adejanovski" created="Wed, 27 Jan 2021 17:47:06 +0000"  >&lt;p&gt;It&apos;s still failing in CI and passing locally.&lt;/p&gt;

&lt;p&gt;I don&apos;t have a clue why yet why it doesn&apos;t work there and GHA doesn&apos;t allow to SSH into the CI instances&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;It seems more like a problem with our CI rather than your patch as I get it to pass locally.&lt;br/&gt;
I&apos;ll spend some time on this issue tomorrow and update this ticket.&lt;/p&gt;</comment>
                            <comment id="17273072" author="jmeredithco" created="Wed, 27 Jan 2021 18:23:48 +0000"  >&lt;p&gt;Thanks.  It might be interesting if CI works any better with the &lt;tt&gt;protocol: TLS&lt;/tt&gt; entry omitted, skipping the new logic that tries to be backward compatible with what 3.0 would have done. If that works, then there may be more work to do on the patch.&lt;/p&gt;</comment>
                            <comment id="17274072" author="dcapwell" created="Fri, 29 Jan 2021 00:29:06 +0000"  >&lt;p&gt;+1 from me.  &lt;/p&gt;</comment>
                            <comment id="17274079" author="dcapwell" created="Fri, 29 Jan 2021 01:00:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adejanovski&quot; class=&quot;user-hover&quot; rel=&quot;adejanovski&quot;&gt;adejanovski&lt;/a&gt; let us know what you find out&lt;/p&gt;</comment>
                            <comment id="17274193" author="adejanovski" created="Fri, 29 Jan 2021 07:10:49 +0000"  >&lt;p&gt;Hey folks, sorry it took me a while to get to the bottom of it.&lt;/p&gt;

&lt;p&gt;The issue we were having was due to the &lt;a href=&quot;https://github.com/thelastpickle/cassandra-medusa/blob/master/tests/integration/features/steps/integration_steps.py#L151&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;storage port being changed in our integration tests&lt;/a&gt;&#160;which apparently was not making ccm happy with 4.0 as the nodes wouldn&apos;t find themselves as seeds.&lt;/p&gt;

&lt;p&gt;I&apos;m positive that &lt;a href=&quot;https://github.com/thelastpickle/cassandra-medusa/runs/1449108534?check_suite_focus=true&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this worked in the past&lt;/a&gt;, so I have no clue why it suddenly started failing, nor why it would still pass locally on my laptop. There&apos;s definitely something fishy with the way some versions of ccm (I get lost between which branches do support 4.0 or not) deal with changing the storage port and how that impacts the seed list.&#160;&lt;/p&gt;

&lt;p&gt;But the good news is that as soon as I removed the storage port change, the &lt;a href=&quot;https://github.com/thelastpickle/cassandra-medusa/runs/1789721180?check_suite_focus=true&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;tests went green&lt;/a&gt; using the C16362 branch&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;+1 for merge and I&apos;ll set up CI properly again in Medusa to get tests running on trunk.&lt;/p&gt;

&lt;p&gt;I&apos;ll try to investigate further the issue with CCM and the custom storage port.&#160;&lt;/p&gt;</comment>
                            <comment id="17274439" author="adejanovski" created="Fri, 29 Jan 2021 13:31:29 +0000"  >&lt;p&gt;Here&apos;s a &lt;a href=&quot;https://github.com/thelastpickle/cassandra-medusa/actions/runs/520478863&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;full green CI run&lt;/a&gt; using the branch from this patch for 4.0.&lt;/p&gt;

&lt;p&gt;I&apos;ve tried with different TLS settings (PROTOCOL_TLSv1 and&#160;PROTOCOL_TLSv1_2) and it worked in both cases.&lt;/p&gt;</comment>
                            <comment id="17274498" author="jmeredithco" created="Fri, 29 Jan 2021 15:10:56 +0000"  >&lt;p&gt;Great news.  Thanks for investigating.  I think that clears us to merge.&lt;/p&gt;</comment>
                            <comment id="17275286" author="dcapwell" created="Fri, 29 Jan 2021 19:44:31 +0000"  >&lt;p&gt;Starting commit&lt;/p&gt;

&lt;p&gt;CI Results (pending):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-16362-trunk-3F712F89-75F7-4838-9D4D-DA95B07DC625&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-16362-trunk-3F712F89-75F7-4838-9D4D-DA95B07DC625&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/348/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17277656" author="dcapwell" created="Wed, 3 Feb 2021 03:16:30 +0000"  >&lt;p&gt;Committed &lt;a href=&quot;https://github.com/apache/cassandra/commit/1b04702f351861e6fef8cf64fd26f65ec90e4c70&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/1b04702f351861e6fef8cf64fd26f65ec90e4c70&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jmeredithco]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="13163" cascade-level=""><![CDATA[Code]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0lmjk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
        <customfieldvalue><![CDATA[djoshi]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348745">4.0-beta3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/7637acc3d762047f2a478855eb4d239b4f314cd8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/7637acc3d762047f2a478855eb4d239b4f314cd8&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Run through CircleCI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>