<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:35:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4835] Appending/Prepending items to list using BATCH</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4835</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;As I know, there is no any guarantee that commands that are inside BATCH block will execute in same order, as they are stored in the BATCH block. But...&lt;/p&gt;

&lt;p&gt;I have made two tests:&lt;br/&gt;
First appends some items to the empty list, and the second one, prepends items, also to the empty list. Both of them are using UPDATE commands stored in the BATCH block. &lt;/p&gt;

&lt;p&gt;Results of those tests are as follow:&lt;br/&gt;
First:&lt;br/&gt;
      When appending new items to list, USING commands are executed in the same order as they are stored i BATCH.&lt;/p&gt;

&lt;p&gt;Second:&lt;br/&gt;
      When prepending new items to list, USING commands are executed in random order.  &lt;/p&gt;

&lt;p&gt;So, in other words below code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;BEGIN BATCH
 UPDATE... list_name = list_name + [ &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; ]  
 UPDATE... list_name = list_name + [ &lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt; ]
 UPDATE... list_name = list_name + [ &lt;span class=&quot;code-quote&quot;&gt;&apos;3&apos;&lt;/span&gt; ] 
APPLY BATCH;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; always results in [ &apos;1&apos;, &apos;2&apos;, &apos;3&apos; ],&lt;br/&gt;
 but this code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt;BEGIN BATCH
 UPDATE... list_name = [ &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt; ] + list_name   
 UPDATE... list_name = [ &lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt; ] + list_name
 UPDATE... list_name = [ &lt;span class=&quot;code-quote&quot;&gt;&apos;3&apos;&lt;/span&gt; ] + list_name
APPLY BATCH;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;results in randomly ordered list, like [ &apos;2&apos;, &apos;1&apos;, &apos;3&apos; ]    (expected result is [ &apos;3&apos;, &apos;2&apos;, &apos;1&apos; ])&lt;/p&gt;

&lt;p&gt;So somehow, when appending items to list, commands from BATCH are executed in order as they are stored, but when prepending, the order is random.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12612680">CASSANDRA-4835</key>
            <summary>Appending/Prepending items to list using BATCH</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="krzysztof cieslinski">Krzysztof Cieslinski Cognitum</reporter>
                        <labels>
                    </labels>
                <created>Fri, 19 Oct 2012 14:03:25 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:25 +0000</updated>
                            <resolved>Thu, 25 Oct 2012 06:52:58 +0000</resolved>
                                        <fixVersion>1.2.0 beta 2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13480042" author="jbellis" created="Fri, 19 Oct 2012 14:10:23 +0000"  >&lt;p&gt;You should think of multiple prepends in a batch as guaranteed to be prepended before any existing data, but not ordered among themselves.  Otherwise we could not parallelize within the batch.  (It&apos;s random chance that your appends appear to maintain batch order.)&lt;/p&gt;

&lt;p&gt;If you want to retain order you should combine into one update: &lt;tt&gt;list = &lt;span class=&quot;error&quot;&gt;&amp;#91;3, 2, 1&amp;#93;&lt;/span&gt; + list&lt;/tt&gt;, which will also be more performant.&lt;/p&gt;</comment>
                            <comment id="13480397" author="krzysztof cieslinski" created="Fri, 19 Oct 2012 21:15:07 +0000"  >&lt;p&gt;Ok, thanks, but I&apos;m afraid that the fact, that my appends are in same order as in BATCH is not a result of a random chance, due the fact that i did this test using BATCH that contains 5000 update commands. And all of them(these 5000 values in list) are in same order as update commands in BATCH(i have executed this test ~10 times and result was always same). However prepending new items is totally random even for BATCH that contains 10 or less updates.. So this shows that for sure, order of updates execution is different for BATCH with prependings and BATCH with appendings. &lt;/p&gt;</comment>
                            <comment id="13481449" author="jbellis" created="Mon, 22 Oct 2012 15:57:29 +0000"  >&lt;p&gt;You should consider this an implementation quirk (possibly even a bug), not a guarantee.&lt;/p&gt;</comment>
                            <comment id="13482641" author="jbellis" created="Tue, 23 Oct 2012 20:18:46 +0000"  >&lt;p&gt;Sylvain points out that we actually do expect update order to be preserved &lt;b&gt;within the same row&lt;/b&gt;.  Reopening.&lt;/p&gt;</comment>
                            <comment id="13483085" author="slebresne" created="Wed, 24 Oct 2012 08:49:16 +0000"  >&lt;p&gt;Alright, this is in fact a legit bug in prepend and is not specific to batches (though it&apos;s probably harder to reproduce without them). Basically the logic in prepend to make sure we were always generating a decreasing keys even in the same millisecond was broken. It was working only for the same update, but was broke for successive update in the same millisecond. Patch attached to fix that.&lt;/p&gt;

&lt;p&gt;That being said, I do think that people should be very careful in assuming that statements in a batch are applied in order &lt;b&gt;even within the same row&lt;/b&gt; because that&apos;s just not true in general. Batch applies everything &quot;at the same time&quot;.  So for instance:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;BEGIN BATCH
  UPDATE user SET name = &apos;Goo&apos; WHERE userid = 1;
  UPDATE user SET name = &apos;Foo&apos; WHERE userid = 1;
APPLY BATCH
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;will always (that&apos;s not quite true currently, see below) end up setting &apos;Goo&apos; as the name because the way the reconciliation rules work, the biggest value wins for equal timestamp. Similarly,&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;BEGIN BATCH
  DELETE FROM user WHERE userid = 1;
  UPDATE user SET name = &apos;Foo&apos; WHERE userid = 1;
APPLY BATCH
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;will always (again, see below) end up with the user deleted because on timestamp ties, tombstone wins.&lt;/p&gt;

&lt;p&gt;In other words, there was indeed a bug with prepend, and append/prepend do respect the order in batches within the same partition key because we happen to process the statements of a batch in order and there is no good reason to do otherwise, but I don&apos;t think we should make that a guarantee either (as in, it&apos;s true now, it could change tomorrow, it&apos;s an implementation detail). And so user shouldn&apos;t rely on it, and if the order is important, they should combine into one statement.&lt;/p&gt;

&lt;p&gt;Now, it is unrelated to lists, but when I said that&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;BEGIN BATCH
  UPDATE user SET name = &apos;Goo&apos; WHERE userid = 1;
  UPDATE user SET name = &apos;Foo&apos; WHERE userid = 1;
APPLY BATCH
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;will always end up with &apos;Goo&apos;, it&apos;s not quite true currently, because batches don&apos;t guarantee that all update will use the same timestamp (in other words, the result of the batch above randomly depends of the timing of the operation).  I think that &lt;b&gt;that&lt;/b&gt; is a guarantee we should provide: that unless the timestamp is user provided, all statement of a batch uses the same timestamp. I&apos;m attaching a second patch that implements that.&lt;/p&gt;</comment>
                            <comment id="13483559" author="jbellis" created="Wed, 24 Oct 2012 20:26:48 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13483934" author="slebresne" created="Thu, 25 Oct 2012 06:52:58 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12550605" name="0001-Fix-prepends-within-same-millis.txt" size="2986" author="slebresne" created="Wed, 24 Oct 2012 08:49:16 +0000"/>
                            <attachment id="12550606" name="0002-Ensure-same-timestamp-in-batches.txt" size="8484" author="slebresne" created="Wed, 24 Oct 2012 08:49:16 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>249929</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 4 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0an87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>60036</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>