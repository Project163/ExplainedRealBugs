<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:04:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12420] Duplicated Key in IN clause with a small fetch size will run forever</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12420</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This can be easily reproduced and fetch size is smaller than the correct number of rows.&lt;/p&gt;

&lt;p&gt;A table has 2 partition key, 1 clustering key, 1 column.&lt;/p&gt;

&lt;p&gt;&amp;gt;        Select select = QueryBuilder.select().from(&quot;ks&quot;, &quot;cf&quot;);&lt;br/&gt;
&amp;gt;        select.where().and(QueryBuilder.eq(&quot;a&quot;, 1));&lt;br/&gt;
&amp;gt;        select.where().and(QueryBuilder.in(&quot;b&quot;, Arrays.asList(1, 1, 1)));&lt;br/&gt;
&amp;gt;        select.setFetchSize(5);&lt;/p&gt;

&lt;p&gt;Now we put a distinct method in client side to eliminate the duplicated key, but it&apos;s better to fix inside Cassandra.&lt;/p&gt;</description>
                <environment>&lt;p&gt;cassandra 2.1.14, driver 2.1.7.1&lt;/p&gt;</environment>
        <key id="12996000">CASSANDRA-12420</key>
            <summary>Duplicated Key in IN clause with a small fetch size will run forever</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="jasonstack">Zhao Yang</reporter>
                        <labels>
                            <label>doc-impacting</label>
                    </labels>
                <created>Tue, 9 Aug 2016 17:07:13 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:23 +0000</updated>
                            <resolved>Tue, 27 Sep 2016 16:56:08 +0000</resolved>
                                        <fixVersion>2.1.16</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15415273" author="jasonstack" created="Wed, 10 Aug 2016 13:35:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; Hi, I understood that in order to fix this bug, we need to change QueryState and it maybe breaking change. but this bug may cause application server OOM. we would like this to be fixed in 2.1.x..&lt;/p&gt;

&lt;p&gt;dtest: &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1199&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/pull/1199&lt;/a&gt; &lt;/p&gt;</comment>
                            <comment id="15427108" author="thobbs" created="Thu, 18 Aug 2016 20:42:01 +0000"  >&lt;p&gt;I&apos;ve confirmed this is reproduceable in 2.1 with the following:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh&amp;gt; create keyspace ks1 WITH replication = {&apos;class&apos;: &apos;SimpleStrategy&apos;, &apos;replication_factor&apos;: &apos;1&apos; };
cqlsh&amp;gt; use ks1;
cqlsh:ks1&amp;gt; create table foo (a int, b int, c int, d int, PRIMARY KEY ((a, b), c));
cqlsh:ks1&amp;gt; insert into foo (a, b, c, d) VALUES (1, 1, 0, 0);
cqlsh:ks1&amp;gt; insert into foo (a, b, c, d) VALUES (1, 1, 1, 1);
cqlsh:ks1&amp;gt; insert into foo (a, b, c, d) VALUES (1, 1, 2, 2);
cqlsh:ks1&amp;gt; insert into foo (a, b, c, d) VALUES (1, 1, 3, 3);
cqlsh:ks1&amp;gt; insert into foo (a, b, c, d) VALUES (1, 1, 4, 4);
cqlsh:ks1&amp;gt; insert into foo (a, b, c, d) VALUES (1, 1, 5, 5);
cqlsh:ks1&amp;gt; insert into foo (a, b, c, d) VALUES (1, 1, 6, 6);
cqlsh:ks1&amp;gt; insert into foo (a, b, c, d) VALUES (1, 1, 7, 7);
cqlsh:ks1&amp;gt; insert into foo (a, b, c, d) VALUES (1, 1, 8, 8);
cqlsh:ks1&amp;gt; insert into foo (a, b, c, d) VALUES (1, 1, 9, 9);
cqlsh:ks1&amp;gt; PAGING 5;
cqlsh:ks1&amp;gt; SELECT * FROM foo WHERE a = 1 AND b IN (1, 1, 1);

 a | b | c | d
---+---+---+---
 1 | 1 | 0 | 0
 1 | 1 | 1 | 1
 1 | 1 | 2 | 2
 1 | 1 | 3 | 3
 1 | 1 | 4 | 4
 
---MORE---&#183;
 a | b | c | d
---+---+---+---
 1 | 1 | 5 | 5
 1 | 1 | 6 | 6
 1 | 1 | 7 | 7
 1 | 1 | 8 | 8
 1 | 1 | 9 | 9
 
---MORE---
 a | b | c | d
---+---+---+---
 1 | 1 | 0 | 0
 1 | 1 | 1 | 1
 1 | 1 | 2 | 2
 1 | 1 | 3 | 3
 1 | 1 | 4 | 4
 
---MORE---
 a | b | c | d
---+---+---+---
 1 | 1 | 5 | 5
 1 | 1 | 6 | 6
 1 | 1 | 7 | 7
 1 | 1 | 8 | 8
 1 | 1 | 9 | 9

... (repeats endlessly)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This does not reproduce in 2.2.&lt;/p&gt;

&lt;p&gt;This is somewhat different from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8276&quot; title=&quot;Duplicate values in an IN restriction on the partition key column can break paging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8276&quot;&gt;&lt;del&gt;CASSANDRA-8276&lt;/del&gt;&lt;/a&gt;, which was just complaining about duplicate result rows when duplicate &lt;tt&gt;IN&lt;/tt&gt; values are used.  The real problem here is that the paged results never end.&lt;/p&gt;</comment>
                            <comment id="15427703" author="jasonstack" created="Fri, 19 Aug 2016 06:57:41 +0000"  >&lt;p&gt;The patch is to add current pager index into PagingState. I think the fix won&apos;t break compatibility in 2.1.x&lt;/p&gt;</comment>
                            <comment id="15428621" author="thobbs" created="Fri, 19 Aug 2016 18:46:09 +0000"  >&lt;p&gt;You are correct that this wouldn&apos;t break compatibility with other 2.1.x nodes, but it could cause problems during upgrades to 3.x.  In 3.x, another optional field (remainingInPartition) has already been added to the end of the PagingState serialization format.  Deserialization of the PagingState is only conditional on the native protocol version, not on the Cassandra version of other nodes in the cluster, so we can&apos;t safely introduce this change.&lt;/p&gt;

&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6706&quot; title=&quot;Duplicate rows returned when in clause has repeated values&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6706&quot;&gt;&lt;del&gt;CASSANDRA-6706&lt;/del&gt;&lt;/a&gt;, the decision was made to continue returning duplicate results in 2.1 when there are duplicate &lt;tt&gt;IN&lt;/tt&gt; values in order to not make a (potentially) breaking change in a bugfix release.  However, this ticket represents a pretty big motivation to change that even in 2.1.  So, I&apos;m thinking that we should go ahead and make 2.1 behave like 2.2 and 3.x and not return duplicate results in order to avoid this.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; do you agree with the above?&lt;/p&gt;</comment>
                            <comment id="15430317" author="blerer" created="Mon, 22 Aug 2016 08:42:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; I agree with your analysis and I am +1 on changing the behavior.&lt;/p&gt;</comment>
                            <comment id="15437534" author="thobbs" created="Thu, 25 Aug 2016 19:57:41 +0000"  >&lt;p&gt;Patch and pending CI runs:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-12420-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-12420-2.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-12420-2.1-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-12420-2.1-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I&apos;ve tried to match the 2.2+ behavior by returning partitions in the order of the sorted partition keys instead of the order of the IN values.&lt;/p&gt;</comment>
                            <comment id="15522751" author="blerer" created="Mon, 26 Sep 2016 11:10:19 +0000"  >&lt;p&gt;Two minor nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The &lt;tt&gt;HAS_LOGGED_WARNING_FOR_IN_RESTRICTION_WITH_DUPLICATES&lt;/tt&gt; static variable in &lt;tt&gt;SelectStatement&lt;/tt&gt; is not used anymore and can be removed.&lt;/li&gt;
	&lt;li&gt;The &lt;tt&gt;assertRowsIgnoringOrder&lt;/tt&gt;, &lt;tt&gt;assertRowsIgnoringOrderAndExtra&lt;/tt&gt; and &lt;tt&gt;assertRowsIgnoringOrderInternal&lt;/tt&gt; methods in &lt;tt&gt;CQLTester&lt;/tt&gt; are not used and should be removed from the patch.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15526730" author="thobbs" created="Tue, 27 Sep 2016 16:56:09 +0000"  >&lt;p&gt;Thank you, committed with the nits fixed to 2.1 as &lt;tt&gt;cdd535fcac4ba79bb371e8373c6504d9e3978853&lt;/tt&gt; and merged to 2.2 with &lt;tt&gt;-s ours&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15533182" author="jasonstack" created="Thu, 29 Sep 2016 16:04:46 +0000"  >&lt;p&gt;Thanks for the fix.&lt;/p&gt;</comment>
                            <comment id="15554934" author="jasonstack" created="Fri, 7 Oct 2016 12:15:01 +0000"  >&lt;p&gt;Hi Tyler, I have updated the dtest according to your new specification. do you think it is needed? &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1199&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/pull/1199&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13008278">CASSANDRA-12722</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12753709">CASSANDRA-8276</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12823023" name="CASSANDRA-12420.patch" size="5911" author="jasonstack" created="Wed, 10 Aug 2016 13:30:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 6 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i323iv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334783">2.1.14</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>