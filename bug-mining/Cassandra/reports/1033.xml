<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:22:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2958] Flush memtables on shutdown when durable writes are disabled</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2958</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Memtables need to be flushed on shutdown when durable_writes is set to false, otherwise data loss occurs as the data is not available to be replayed from the commit log. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12515554">CASSANDRA-2958</key>
            <summary>Flush memtables on shutdown when durable writes are disabled</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="electrum">David Phillips</reporter>
                        <labels>
                    </labels>
                <created>Wed, 27 Jul 2011 17:26:39 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:54 +0000</updated>
                            <resolved>Mon, 1 Aug 2011 18:44:58 +0000</resolved>
                                        <fixVersion>0.8.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13071884" author="jbellis" created="Wed, 27 Jul 2011 17:43:38 +0000"  >&lt;p&gt;You&apos;re right.  Here&apos;s a patch to add flushing of non-durable CFs to the shutdown hook.&lt;/p&gt;</comment>
                            <comment id="13071887" author="jbellis" created="Wed, 27 Jul 2011 17:45:18 +0000"  >&lt;p&gt;(Original durable_writes option: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2683&quot; title=&quot;Allow writes to bypass the commit log for certain keyspaces&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2683&quot;&gt;&lt;del&gt;CASSANDRA-2683&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="13071987" author="tjake" created="Wed, 27 Jul 2011 20:38:12 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13073109" author="jbellis" created="Sat, 30 Jul 2011 02:48:52 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13073118" author="hudson" created="Sat, 30 Jul 2011 03:22:39 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #245 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/245/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/245/&lt;/a&gt;)&lt;br/&gt;
    Flush memtables on shutdown when durable writes are disabled&lt;br/&gt;
patch by jbellis; reviewed by tjake for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2958&quot; title=&quot;Flush memtables on shutdown when durable writes are disabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2958&quot;&gt;&lt;del&gt;CASSANDRA-2958&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1152419&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1152419&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/compaction/LazilyCompactedRow.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/db/compaction/CompactionIterator.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/service/StorageService.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13073624" author="electrum" created="Mon, 1 Aug 2011 17:40:16 +0000"  >&lt;p&gt;It looks like waitOnFutures() can return a null pointer exception if forceFlush() returns null?&lt;/p&gt;</comment>
                            <comment id="13073656" author="jbellis" created="Mon, 1 Aug 2011 18:44:58 +0000"  >&lt;p&gt;thanks &amp;#8211; fixed in r1152891&lt;/p&gt;</comment>
                            <comment id="13073671" author="hudson" created="Mon, 1 Aug 2011 19:14:54 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #250 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/250/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/250/&lt;/a&gt;)&lt;br/&gt;
    avoid NPE when flushing in shutdown hook&lt;br/&gt;
patch by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2958&quot; title=&quot;Flush memtables on shutdown when durable writes are disabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2958&quot;&gt;&lt;del&gt;CASSANDRA-2958&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1152891&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1152891&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/service/StorageService.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13441565" author="rcoli" created="Fri, 24 Aug 2012 22:40:10 +0000"  >&lt;p&gt;If I am running with &quot;durable_writes off,&quot; I know this means &quot;Data in a memtable is not shadowed by data in the commitlog and is therefore lost when memory is cleared.&quot;&lt;/p&gt;

&lt;p&gt;As a result, when my node crashes or is shut down, I &lt;b&gt;expect&lt;/b&gt; to lose data that is not flushed. If I want to prevent this from happening, I can run &quot;nodetool drain&quot; to flush my memtables and prevent any new ones from being created.&lt;/p&gt;

&lt;p&gt;This patch violates the principle of least surprise by triggering a flush as a side effect of shutdown, but only in certain cases. Now, instead of knowing that unflushed/drained data is lost with durable_writes off, I have to understand that I lose my data if my node crashes and keep my data if I manually shut it down. &quot;Data in a memtable is not shadowed by data in the commitlog and is therefore lost when memory is cleared&quot; becomes an incorrect heuristic for understanding durable_writes. After this patch, the formerly unambiguous &quot;durable_writes off&quot; setting seems to mean something like &quot;durable_writes sometimes_off&quot;.&lt;/p&gt;

&lt;p&gt;While I laud the goal of not losing peoples data, I assert that when you explicitly tell Cassandra to do something that by design loses data, Cassandra should do what you tell it to do.&lt;/p&gt;</comment>
                            <comment id="13441569" author="jbellis" created="Fri, 24 Aug 2012 22:46:33 +0000"  >&lt;p&gt;if you want data loss from non-durable writes, kill -9 is your friend.  otherwise, our goal is to not lose more than necessary.&lt;/p&gt;</comment>
                            <comment id="13446416" author="rcoli" created="Fri, 31 Aug 2012 21:49:07 +0000"  >&lt;p&gt;What I &quot;want&quot; is to be able to explain Cassandra to customers in simple sentences like &quot;a memtable holds changes until it is full enough to hit a flush condition or you explicitly flush it&quot; without having to pepper these sentences with caveats like &quot;except if you restart your node or if you stop it with durable_writes off, triggering an unexpected flush.&quot; Patches such as this one, where vaguely defined ends appear to justify whatever ad-hoc inconsistent means, do not appear to further this goal.&lt;/p&gt;

&lt;p&gt;Let me phrase my objection to this patch in another way...&lt;/p&gt;

&lt;p&gt;&quot;What does this patch gain us, and at what cost?&quot;&lt;/p&gt;

&lt;p&gt;Your stated goal is to not lose more than &quot;necessary&quot; when stopping a node. It seems your goal can be achieved without patching, by simply advising &quot;durable_writes off&quot; operators to run &quot;nodetool drain&quot; when stopping a node. They are, after all, the ones stopping their node and are perfectly capable of draining it if they do not want to lose the explicitly non-durable non-durable_writes contents of memtables.&lt;/p&gt;

&lt;p&gt;From what I can tell, the only thing this patch gains us is &quot;people who are running with durable_writes off don&apos;t have to run &apos;nodetool drain&apos; before stopping nodes.&quot;&lt;/p&gt;

&lt;p&gt;What we trade for that is the until-now universal expectation that stopping a Cassandra node never triggers a flush.&lt;/p&gt;

&lt;p&gt;Is &quot;the very small group of operators who run with non-durable writes don&apos;t have to run &apos;nodetool drain&apos;&quot; such a compelling win that we should change a fundamental behavior of Cassandra, making it less predictable, in order to obtain it? My answer is no.&lt;/p&gt;</comment>
                            <comment id="13446425" author="brandon.williams" created="Fri, 31 Aug 2012 21:57:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;be able to explain Cassandra to customers in simple sentences like &quot;a memtable holds changes until it is full enough to hit a flush condition or you explicitly flush it&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&quot;a memtable holds changes until it hits a flush condition like being full or graceful shutdown, or you explicitly flush it.&quot;&lt;/p&gt;</comment>
                            <comment id="13447980" author="rcoli" created="Tue, 4 Sep 2012 19:25:53 +0000"  >&lt;p&gt;&amp;gt; &quot;a memtable holds changes until it hits a flush condition like being full or graceful shutdown, or you explicitly flush it.&quot;&lt;/p&gt;

&lt;p&gt;This is not an unambiguous summary of the current behavior. It is true only if durable_writes are off. If durable_writes are on, graceful shutdown does not flush.&lt;/p&gt;

&lt;p&gt;&quot;a memtable holds changes until it hits a flush condition like being full (or, if durable_writes are disabled, on graceful shutdown), or you explicitly flush it&quot;&lt;/p&gt;

&lt;p&gt;Seems to unambiguously describe the current behavior and doesn&apos;t read very well.&lt;/p&gt;

&lt;p&gt;I gather from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3564&quot; title=&quot;flush before shutdown so restart is faster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3564&quot;&gt;&lt;del&gt;CASSANDRA-3564&lt;/del&gt;&lt;/a&gt; that there is interest in extending this flush-on-graceful shutdown behavior to occur in all cases of graceful shutdown. If that happens, your sentence will be a correct summation of Cassandra&apos;s newly predictable behavior. It will also answer my primary objection here, which is that the flush only occurs in &lt;b&gt;some&lt;/b&gt; graceful shutdown cases. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13447985" author="jbellis" created="Tue, 4 Sep 2012 19:31:39 +0000"  >&lt;p&gt;Robert, we use assign-to to track who fixed an issue.  Assigning to yourself at this point is not appropriate.&lt;/p&gt;</comment>
                            <comment id="13467949" author="rcoli" created="Tue, 2 Oct 2012 18:38:17 +0000"  >&lt;p&gt;Jonathan, I had no intent of assigning this ticket to myself or wiping the description body, both of which I apparently accidentally did in the process of clicking on this ticket. I will restore the description body from the history, sorry for the confusion.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12488002" name="2958.txt" size="1448" author="jbellis" created="Wed, 27 Jul 2011 17:43:37 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19339</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 8 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0geif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93781</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>