<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:28:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19000] Test Failure: org.apache.cassandra.tools.BulkLoaderTest.testBulkLoader_WithArgs2</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19000</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;h3&gt;&lt;a name=&quot;%C2%A0&quot;&gt;&lt;/a&gt;&#160;&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/1766/testReport/org.apache.cassandra.tools/BulkLoaderTest/testBulkLoader_WithArgs2_cdc_jdk17_arch_x86_64_python2_7/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/1766/testReport/org.apache.cassandra.tools/BulkLoaderTest/testBulkLoader_WithArgs2_cdc_jdk17_arch_x86_64_python2_7/&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error Message
Wrong thread status, active threads unaccounted &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;: [cluster3-nio-worker-0]

Stacktrace
junit.framework.AssertionFailedError: Wrong thread status, active threads unaccounted &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;: [cluster3-nio-worker-0] at org.apache.cassandra.tools.OfflineToolUtils.assertNoUnexpectedThreadsStarted(OfflineToolUtils.java:120) at org.apache.cassandra.tools.BulkLoaderTest.testBulkLoader_WithArgs2(BulkLoaderTest.java:129) at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77) at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13556762">CASSANDRA-19000</key>
            <summary>Test Failure: org.apache.cassandra.tools.BulkLoaderTest.testBulkLoader_WithArgs2</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="edimitrova">Ekaterina Dimitrova</assignee>
                                    <reporter username="edimitrova">Ekaterina Dimitrova</reporter>
                        <labels>
                    </labels>
                <created>Fri, 3 Nov 2023 22:38:37 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:59 +0000</updated>
                            <resolved>Mon, 20 Nov 2023 21:57:11 +0000</resolved>
                                        <fixVersion>4.0.12</fixVersion>
                    <fixVersion>4.1.4</fixVersion>
                    <fixVersion>5.0-beta1</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>CI</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17782787" author="edimitrova" created="Fri, 3 Nov 2023 22:43:42 +0000"  >&lt;p&gt;This one reminds me of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17283&quot; title=&quot;Failing test: UNIT org.apache.cassandra.tools.BulkLoaderTest.testBulkLoader_WithArgs1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17283&quot;&gt;&lt;del&gt;CASSANDRA-17283&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Might need just an exclusion, to be investigated.&#160;&lt;/p&gt;</comment>
                            <comment id="17782788" author="edimitrova" created="Fri, 3 Nov 2023 22:46:43 +0000"  >&lt;p&gt;Okay, this is suspicious; the last run failed also on trunk... let me see.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/1766/testReport/org.apache.cassandra.tools/BulkLoaderTest/testBulkLoader_WithArgs2_cdc_jdk17_arch_x86_64_python2_7/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/1766/testReport/org.apache.cassandra.tools/BulkLoaderTest/testBulkLoader_WithArgs2_cdc_jdk17_arch_x86_64_python2_7/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;EDIT: I ran successfully locally BulkLoaderTest class on the latest 5.0 and trunk. So, it seems it is just yet another flaky test.&lt;/p&gt;</comment>
                            <comment id="17784230" author="edimitrova" created="Wed, 8 Nov 2023 23:06:33 +0000"  >&lt;p&gt;I cannot reproduce either with &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2557/workflows/be404529-e81a-4504-8ced-aaaedc647902&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;, or on &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/2558/workflows/44a50540-f04a-4459-9353-7d8ee46b8834&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;However, I found the logs in nightlies from the failed test run in Jenkins - &lt;a href=&quot;https://nightlies.apache.org/cassandra/trunk/Cassandra-trunk-test-cdc/1826/Cassandra-trunk-test-cdc/jdk=jdk_17_latest,label=cassandra,split=7/build/test/logs/cdc.jdk17.arch=x86_64.python2.7/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://nightlies.apache.org/cassandra/trunk/Cassandra-trunk-test-cdc/1826/Cassandra-trunk-test-cdc/jdk=jdk_17_latest,label=cassandra,split=7/build/test/logs/cdc.jdk17.arch=x86_64.python2.7/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Cassandra drivers docs point to threads with names: &amp;lt;cluster_name&amp;gt;- nio-worker -&amp;lt;n&amp;gt;&lt;/p&gt;

&lt;p&gt;And the logs - both of passing and the not passing test run contain:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
DEBUG [cluster3-nio-worker-0] 2023-11-02 18:57:49,939 Defuncting Connection[/127.9.9.1:9042-1, inFlight=0, closed=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;] because: [/127.9.9.1:9042] Cannot connect
DEBUG [cluster3-nio-worker-0] 2023-11-02 18:57:49,939 [/127.9.9.1:9042] preventing &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; connections &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the next 1000 ms
DEBUG [cluster3-nio-worker-0] 2023-11-02 18:57:49,939 [/127.9.9.1:9042] Connection[/127.9.9.1:9042-1, inFlight=0, closed=&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;] failed, remaining = 0
DEBUG [cluster3-nio-worker-0] 2023-11-02 18:57:49,939 Connection[/127.9.9.1:9042-1, inFlight=0, closed=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;] closing connection
DEBUG [main] 2023-11-02 18:57:49,940 [Control connection] error on /127.9.9.1:9042 connection, no more host to &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
com.datastax.driver.core.exceptions.TransportException: [/127.9.9.1:9042] Cannot connect
&#160; &#160; at com.datastax.driver.core.Connection$1.operationComplete(Connection.java:226)
&#160; &#160; at com.datastax.driver.core.Connection$1.operationComplete(Connection.java:192)
&#160; &#160; at com.datastax.shaded.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:590)
&#160; &#160; at com.datastax.shaded.netty.util.concurrent.DefaultPromise.notifyListeners0(DefaultPromise.java:583)
&#160; &#160; at com.datastax.shaded.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:559)
&#160; &#160; at com.datastax.shaded.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:492)
&#160; &#160; at com.datastax.shaded.netty.util.concurrent.DefaultPromise.setValue0(DefaultPromise.java:636)
&#160; &#160; at com.datastax.shaded.netty.util.concurrent.DefaultPromise.setFailure0(DefaultPromise.java:629)
&#160; &#160; at com.datastax.shaded.netty.util.concurrent.DefaultPromise.tryFailure(DefaultPromise.java:118)
&#160; &#160; at com.datastax.shaded.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.fulfillConnectPromise(AbstractNioChannel.java:321)
&#160; &#160; at com.datastax.shaded.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.finishConnect(AbstractNioChannel.java:337)
&#160; &#160; at com.datastax.shaded.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:776)
&#160; &#160; at com.datastax.shaded.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)
&#160; &#160; at com.datastax.shaded.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)
&#160; &#160; at com.datastax.shaded.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)
&#160; &#160; at com.datastax.shaded.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)
&#160; &#160; at com.datastax.shaded.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
&#160; &#160; at com.datastax.shaded.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
&#160; &#160; at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833)
Caused by: com.datastax.shaded.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: /127.9.9.1:9042
Caused by: java.net.ConnectException: Connection refused
&#160; &#160; at java.base/sun.nio.ch.Net.pollConnect(Native Method)
&#160; &#160; at java.base/sun.nio.ch.Net.pollConnectNow(Net.java:672)
&#160; &#160; at java.base/sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:946)
&#160; &#160; at com.datastax.shaded.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:337)
&#160; &#160; at com.datastax.shaded.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.finishConnect(AbstractNioChannel.java:334)
&#160; &#160; at com.datastax.shaded.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:776)
&#160; &#160; at com.datastax.shaded.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)
&#160; &#160; at com.datastax.shaded.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)
&#160; &#160; at com.datastax.shaded.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)
&#160; &#160; at com.datastax.shaded.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)
&#160; &#160; at com.datastax.shaded.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
&#160; &#160; at com.datastax.shaded.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
&#160; &#160; at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;So I guess seeing those pop up was a matter of time.&lt;/p&gt;

&lt;p&gt;My understanding of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9054&quot; title=&quot;Let DatabaseDescriptor not implicitly startup services&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9054&quot;&gt;&lt;del&gt;CASSANDRA-9054&lt;/del&gt;&lt;/a&gt; is that tools do not have many of the services initialized during regular startup and the test verifies that we do not do that when using the BulkLoader and nothing new unneeded has popped up.&#160;&lt;/p&gt;

&lt;p&gt;I suggest we add an exclusion as &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/commit/f14c92889eaeb9432e2ec716495b5bd313e969fe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this &lt;/a&gt;. (I also fixed some indentation that was off)&lt;/p&gt;

&lt;p&gt;Tested locally, same patch for 5.0 and trunk.&#160;&lt;/p&gt;</comment>
                            <comment id="17784428" author="michaelsembwever" created="Thu, 9 Nov 2023 12:32:59 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;My understanding, reading the ticket, is that this has not been seen on circleci.  Therefore running the patch on circleci has little value.  On that, I agree with the hypothesis and committing this eagerly.&lt;/p&gt;</comment>
                            <comment id="17784517" author="adelapena" created="Thu, 9 Nov 2023 15:35:09 +0000"  >&lt;p&gt;I have run it on the CircleCI multiplexer, with and without CDC and with all JDK combinations:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;4.1  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3282/workflows/b42a6316-5fcb-45d2-8397-261e6017ebe6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8 &lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3282/workflows/ed23c598-5e48-403b-b07c-0b734a70f7fd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;5.0  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3284/workflows/f888629b-3150-401c-843b-f9e8f00a2ac8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3284/workflows/ffd44fb4-92ec-4c60-89c6-cc1c44bdb02b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3283/workflows/42e9671b-6ab4-45a6-80de-74ee1dc29353&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3283/workflows/82992a46-33e4-4f63-b6f7-4cfedb4211d8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;That&apos;s 3*2*1000 runs on each branch, and no one has reproduced the failure.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17784559" author="edimitrova" created="Thu, 9 Nov 2023 17:30:01 +0000"  >&lt;p&gt;Thank you both!&lt;br/&gt;
The test also exists on previous branches, and I can see those threads coming from the drivers pooling, presented in the logs when running the tests with any jdk, cdc, etc.&lt;/p&gt;

&lt;p&gt;I tested locally the tiny patch with all branches 4.0+. I suggest we commit the exclusion of&#160;&lt;/p&gt;

&lt;p&gt;cluster&lt;span class=&quot;error&quot;&gt;&amp;#91;0-9&amp;#93;&lt;/span&gt;&lt;del&gt;nio-worker&lt;/del&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;0-9&amp;#93;&lt;/span&gt; in the test for all branches. WDYT?&#160;&lt;/p&gt;</comment>
                            <comment id="17784580" author="michaelsembwever" created="Thu, 9 Nov 2023 18:55:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;I suggest we commit the exclusion of cluster&lt;span class=&quot;error&quot;&gt;&amp;#91;0-9&amp;#93;&lt;/span&gt;nio-worker&lt;span class=&quot;error&quot;&gt;&amp;#91;0-9&amp;#93;&lt;/span&gt; in the test for all branches. WDYT? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I agree.  Even if it ends up being but a checkpoint commit, it&apos;s safe.&lt;/p&gt;</comment>
                            <comment id="17784928" author="adelapena" created="Fri, 10 Nov 2023 12:55:06 +0000"  >&lt;p&gt;Agree, the exclusion should work. One might think that the&#160;&lt;tt&gt;close()&lt;/tt&gt; calls for the driver&apos;s cluster and session in the try-with-resources at &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/utils/NativeSSTableLoaderClient.java#L70&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;NativeSSTableLoaderClient#init()&lt;/tt&gt;&lt;/a&gt; should synchronously stop all the driver threads. But that doesn&apos;t seem to be the case according to the Jenkins-only test failure. I guess it&apos;s a driver thing and we can just exclude those threads from the test, maybe adding a comment?&lt;/p&gt;</comment>
                            <comment id="17784971" author="edimitrova" created="Fri, 10 Nov 2023 14:42:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;Agree, the exclusion should work. One might think that the&#160;&lt;tt&gt;close()&lt;/tt&gt;&#160;calls for the driver&apos;s cluster and session in the try-with-resources at&#160;&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/utils/NativeSSTableLoaderClient.java#L70&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;NativeSSTableLoaderClient#init()&lt;/tt&gt;&lt;/a&gt;&#160;should synchronously stop all the driver threads. But that doesn&apos;t seem to be the case according to the Jenkins-only test failure. I guess it&apos;s a driver thing and we can just exclude those threads from the test, maybe adding a comment?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;That is a good point, to be sure I am not just covering a driver bug, I just pinged &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=absurdfarce&quot; class=&quot;user-hover&quot; rel=&quot;absurdfarce&quot;&gt;absurdfarce&lt;/a&gt; in Slack. If it is a driver bug we need a ticket and we do not want to cover it with exclusion. I will update the ticket when I hear from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=absurdfarce&quot; class=&quot;user-hover&quot; rel=&quot;absurdfarce&quot;&gt;absurdfarce&lt;/a&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17785044" author="edimitrova" created="Fri, 10 Nov 2023 18:43:04 +0000"  >&lt;p&gt;I confirmed with Bret McGuire that, in this case, it is expected behavior in driver version 3.11.5 (the current Java driver version is 5.0+).&lt;/p&gt;

&lt;p&gt;Looking into 3.11.0, the same explanation &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; applies there too. The release notes show minor changes unrelated to what we are looking at here - &lt;a href=&quot;https://github.com/apache/cassandra-java-driver/tree/3.11.5/changelog.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-java-driver/tree/3.11.5/changelog.&lt;/a&gt; (looking at the commit log, there are no other changes not mentioned in the official change log)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; From Bret about 3.11.5:&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;ConnectionCloseFuture.force() is the relevant logic and the &lt;a href=&quot;https://github.com/apache/cassandra-java-driver/blob/3.11.5/driver-core/src/main/java/com/datastax/driver/core/Connection.java#L1460C1-L1471&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;use of the listener off of the channel.close() future&lt;/a&gt; suggests that anybody who waits on the future via get() would be guaranteed that cleanup had completed. But Connection.closeAsync() only returns the future (which seems right) and the various methods on HostConnectionPool either &lt;a href=&quot;https://github.com/apache/cassandra-java-driver/blob/3.11.5/driver-core/src/main/java/com/datastax/driver/core/HostConnectionPool.java#L644-L646&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;call closeAsync() without returning anything&lt;/a&gt; or &lt;a href=&quot;https://github.com/apache/cassandra-java-driver/blob/3.11.5/driver-core/src/main/java/com/datastax/driver/core/HostConnectionPool.java#L225-L231&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;just call force() directly&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;HostConnectionPool.closeAsync() does return the future, so there&apos;s at least the possibility somebody could call this and wait. Without a stack trace of the actual shutdown it&apos;s hard to say for sure, but based on everything I&apos;m seeing here I would definitely say this behaviour is expected within the current driver.&lt;/p&gt;

&lt;p&gt;I wouldn&apos;t characterize this as a bug. The intent here is clearly for best efforts work at eventual completion. &lt;a href=&quot;https://github.com/apache/cassandra-java-driver/blob/3.11.5/driver-core/src/main/java/com/datastax/driver/core/CloseFuture.java#L55-L57&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CloseFuture.force()&lt;/a&gt; even explicitly states as much.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If no one has concerns here, I can commit it next week (Andres is already OOO, so I do not expect an answer from him before Monday next week)&lt;/p&gt;</comment>
                            <comment id="17785045" author="edimitrova" created="Fri, 10 Nov 2023 18:49:33 +0000"  >&lt;p&gt;Also, this is confirmed to be test issue and not a 5.0 blocker, I just acknowledged it in the fix versions.&lt;/p&gt;</comment>
                            <comment id="17785050" author="adelapena" created="Fri, 10 Nov 2023 19:21:27 +0000"  >&lt;p&gt;Thanks for the detailed explanation. IMO an exclusion with perhaps a brief comment like &quot;the driver isn&apos;t expected to terminate threads on close synchronously&quot; should do.&lt;/p&gt;</comment>
                            <comment id="17785109" author="edimitrova" created="Sat, 11 Nov 2023 02:34:26 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; , I will commit the patch, together with the suggested comment over the weekend, at latest early next week.&#160;&lt;/p&gt;</comment>
                            <comment id="17788163" author="edimitrova" created="Mon, 20 Nov 2023 21:54:18 +0000"  >&lt;p&gt;Committed&#160;to &lt;a href=&quot;https://github.com/apache/cassandra.git&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra.git&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&#160; 7fdb88d10a..55fecfb65e&#160; cassandra-4.0 -&amp;gt; cassandra-4.0&lt;/p&gt;

&lt;p&gt;&#160;&#160; 6a282b50b9..08d9b70b4d&#160; cassandra-4.1 -&amp;gt; cassandra-4.1&lt;/p&gt;

&lt;p&gt;&#160;&#160; 91a242fe00..a2911c7391&#160; cassandra-5.0 -&amp;gt; cassandra-5.0&lt;/p&gt;

&lt;p&gt;&#160;&#160; 1b7e895f56..316a239c7c&#160; trunk -&amp;gt; trunk&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13562019">CASSANDRA-19205</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[edimitrova]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 51 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1leg0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
        <customfieldvalue><![CDATA[mck]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/55fecfb65e6db9dccc0895e0d30a01f42832f6b8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/55fecfb65e6db9dccc0895e0d30a01f42832f6b8&lt;/a&gt;. &lt;a href=&quot;https://github.com/apache/cassandra/commit/08d9b70b4d5e59eb64081da3e26420f867b3e520&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/08d9b70b4d5e59eb64081da3e26420f867b3e520&lt;/a&gt;.  &lt;a href=&quot;https://github.com/apache/cassandra/commit/a2911c73919c118c763dec788d4a23bbbd2b06d8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/a2911c73919c118c763dec788d4a23bbbd2b06d8&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/commit/f14c92889eaeb9432e2ec716495b5bd313e969fe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ekaterinadimitrova2/cassandra/commit/f14c92889eaeb9432e2ec716495b5bd313e969fe&lt;/a&gt; - same for 5.0 and trunk; test rerun, no new tests needed&#160;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>