<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:21:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2823] NPE during range slices with rowrepairs</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2823</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Doing some heavy testing of relatively fast feeding (5000+ mutations/sec) + repair on all node + range slices.&lt;br/&gt;
Then occasionally killing a node here and there and restarting it.&lt;/p&gt;

&lt;p&gt;Triggers the following NPE&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-2-thread-3&amp;#93;&lt;/span&gt; 2011-06-24 20:56:27,289 Cassandra.java (line 3210) Internal error processing get_range_slices&lt;br/&gt;
java.lang.NullPointerException&lt;br/&gt;
	at org.apache.cassandra.service.RowRepairResolver.maybeScheduleRepairs(RowRepairResolver.java:109)&lt;br/&gt;
	at org.apache.cassandra.service.RangeSliceResponseResolver$2.getReduced(RangeSliceResponseResolver.java:112)&lt;br/&gt;
	at org.apache.cassandra.service.RangeSliceResponseResolver$2.getReduced(RangeSliceResponseResolver.java:83)&lt;br/&gt;
	at org.apache.cassandra.utils.MergeIterator$ManyToOne.consume(MergeIterator.java:161)&lt;br/&gt;
	at org.apache.cassandra.utils.MergeIterator.computeNext(MergeIterator.java:88)&lt;br/&gt;
	at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:140)&lt;br/&gt;
	at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:135)&lt;br/&gt;
	at org.apache.cassandra.service.RangeSliceResponseResolver.resolve(RangeSliceResponseResolver.java:120)&lt;br/&gt;
	at org.apache.cassandra.service.RangeSliceResponseResolver.resolve(RangeSliceResponseResolver.java:43)&lt;/p&gt;

&lt;p&gt;Looking at the code in getReduced:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                ColumnFamily resolved = versions.size() &amp;gt; 1
                                      ? RowRepairResolver.resolveSuperset(versions)
                                      : versions.get(0);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;seems like resolved becomes null when this happens and versions.size is larger than 1.&lt;/p&gt;

&lt;p&gt;RowRepairResolver.resolveSuperset() does actually return null if it cannot resolve anything, so there is definately a case here which can occur and is not handled.&lt;/p&gt;

&lt;p&gt;It may also be an interesting question if it is guaranteed that                &lt;br/&gt;
versions.add(current.left.cf);&lt;br/&gt;
can never return null?&lt;/p&gt;

&lt;p&gt;Jonathan suggested on IRC that maybe &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                ColumnFamily resolved = versions.size() &amp;gt; 1
                                      ? RowRepairResolver.resolveSuperset(versions)
                                      : versions.get(0);
                if (resolved == null)
                      return new Row(key, resolved);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;could be a fix.&lt;/p&gt;</description>
                <environment>&lt;p&gt;This is a trunk build with 2521 and 2433&lt;br/&gt;
I somewhat doubt that is related however.&lt;/p&gt;</environment>
        <key id="12511484">CASSANDRA-2823</key>
            <summary>NPE during range slices with rowrepairs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="terjem">Terje Marthinussen</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Jun 2011 15:39:41 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:56 +0000</updated>
                            <resolved>Tue, 28 Jun 2011 07:55:38 +0000</resolved>
                                        <fixVersion>0.8.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13055555" author="slebresne" created="Mon, 27 Jun 2011 13:54:59 +0000"  >&lt;p&gt;I think the problem is with the call to removeDeleted in resolveSuperset() (which is fairly new). Basically, the code is fine with resolved being null as long as this means that all the versions are null. But the removeDeleted call make it possible to have a null removeDeleted even if the versions are not null, if a row tombstone expires between the time it was returned by the node and the time it is resolved by the coordinator for instance.&lt;/p&gt;

&lt;p&gt;Attaching patch that skips the maybeScheduleRepair() call if resolved == null since even in that case there is nothing to repair since the tombstone are now expired.&lt;/p&gt;</comment>
                            <comment id="13055591" author="jbellis" created="Mon, 27 Jun 2011 15:04:36 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13055593" author="jbellis" created="Mon, 27 Jun 2011 15:06:12 +0000"  >&lt;p&gt;although I slightly prefer the &quot;if == null return&quot; immediately after initializing resolved, to keep those two pieces of logic together.&lt;/p&gt;</comment>
                            <comment id="13055596" author="slebresne" created="Mon, 27 Jun 2011 15:10:33 +0000"  >&lt;p&gt;Yeah, I didn&apos;t do that mostly because there is still a few lines of code (besides maybe scheduling repair) that we need to do even if resolved is null (debugging message in RowRepairResolver and more importantly, the clear of versions and versionSources in RangeSliceResolver). &lt;/p&gt;</comment>
                            <comment id="13055597" author="jbellis" created="Mon, 27 Jun 2011 15:14:40 +0000"  >&lt;p&gt;ah, right &amp;#8211; skipping the clear would be buggy.  +1 again. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13056372" author="slebresne" created="Tue, 28 Jun 2011 07:55:39 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="13056383" author="hudson" created="Tue, 28 Jun 2011 08:23:06 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #195 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/195/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/195/&lt;/a&gt;)&lt;br/&gt;
    Fix potential NPE in range slice read repair&lt;br/&gt;
patch by slebresne; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2823&quot; title=&quot;NPE during range slices with rowrepairs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2823&quot;&gt;&lt;del&gt;CASSANDRA-2823&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;slebresne : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1140470&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1140470&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/service/RowRepairResolver.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/service/RangeSliceResponseResolver.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13056458" author="jbellis" created="Tue, 28 Jun 2011 11:57:42 +0000"  >&lt;p&gt;does 0.7 need this?&lt;/p&gt;</comment>
                            <comment id="13056464" author="slebresne" created="Tue, 28 Jun 2011 12:15:16 +0000"  >&lt;p&gt;You&apos;re right, 0.7 needs that too. I&apos;ve committed it there too.&lt;/p&gt;</comment>
                            <comment id="13056472" author="hudson" created="Tue, 28 Jun 2011 12:43:39 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #514 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.7/514/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.7/514/&lt;/a&gt;)&lt;br/&gt;
    Fix potential NPE during read repair&lt;br/&gt;
patch by slebresne; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2823&quot; title=&quot;NPE during range slices with rowrepairs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2823&quot;&gt;&lt;del&gt;CASSANDRA-2823&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;slebresne : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1140550&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1140550&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/src/java/org/apache/cassandra/service/RangeSliceResponseResolver.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.7/src/java/org/apache/cassandra/service/RowRepairResolver.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12483954" name="2823.patch" size="2280" author="slebresne" created="Mon, 27 Jun 2011 13:54:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20850</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gdof:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93646</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>