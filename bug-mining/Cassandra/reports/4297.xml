<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9669] If sstable flushes complete out of order, on restart we can fail to replay necessary commit log records</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9669</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;While &lt;tt&gt;postFlushExecutor&lt;/tt&gt; ensures it never expires CL entries out-of-order, on restart we simply take the maximum replay position of any sstable on disk, and ignore anything prior. &lt;/p&gt;

&lt;p&gt;It is quite possible for there to be two flushes triggered for a given table, and for the second to finish first by virtue of containing a much smaller quantity of live data (or perhaps the disk is just under less pressure). If we crash before the first sstable has been written, then on restart the data it would have represented will disappear, since we will not replay the CL records.&lt;/p&gt;

&lt;p&gt;This looks to be a bug present since time immemorial, and also seems pretty serious.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12841172">CASSANDRA-9669</key>
            <summary>If sstable flushes complete out of order, on restart we can fail to replay necessary commit log records</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blambov">Branimir Lambov</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                            <label>correctness</label>
                    </labels>
                <created>Sun, 28 Jun 2015 13:11:35 +0000</created>
                <updated>Wed, 15 Oct 2025 09:49:03 +0000</updated>
                            <resolved>Tue, 31 May 2016 08:47:00 +0000</resolved>
                                        <fixVersion>2.2.7</fixVersion>
                    <fixVersion>3.0.7</fixVersion>
                    <fixVersion>3.7</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>20</watches>
                                                                                                                <comments>
                            <comment id="14628109" author="benedict" created="Wed, 15 Jul 2015 14:18:40 +0000"  >&lt;p&gt;So, I&apos;ve been mulling this over and would like to outline the tradeoffs and get agreement before implementation:&lt;/p&gt;

&lt;p&gt;The simplest approach is to &lt;em&gt;delay flush completion&lt;/em&gt; until all prior flushes have succeeded. i.e., all flushes for a given table will complete in the order they are submitted, i.e. in CommitLog order. They will remain as tmp files, and the memtables will continue to service requests for that data, until all earlier flushes for that table have also completed. There is one serious flaw here, though, which is that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7275&quot; title=&quot;Errors in FlushRunnable may leave threads hung&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7275&quot;&gt;&lt;del&gt;CASSANDRA-7275&lt;/del&gt;&lt;/a&gt; becomes even more devastating. In this scenario, the server&apos;s memtable space will rapidly be completely exhausted, and there is simply no escaping it. &lt;/p&gt;

&lt;p&gt;In 2.1+ we can mitigate this by &quot;opening early&quot; (even though it&apos;s a flush) and evicting the memtable immediately, only upgrading it to a permanent file once prior flushes have completed. However 2.0&apos;s stability for some users may be significantly affected.&lt;/p&gt;

&lt;p&gt;Another possibility is to begin saving the start replay position with sstables (on top of end), and on restart ensure we replay anything present in a gap. This would mean a number of small changes with e.g. metadata, but would also introduce some extra compaction complexity, which I&apos;m reticent to introduce: we would have to prevent compaction from being permitted on any sstable that was &quot;ahead&quot; of its prior flushes. Compaction logic is already unpleasantly complex around these kinds of decisions, especially in 2.1, and introduces risks to 2.0 and 2.1 I would like to avoid.&lt;/p&gt;

&lt;p&gt;Any solution is going to be more involved than I would like for 2.0 or 2.1, though.&lt;/p&gt;</comment>
                            <comment id="14628484" author="benedict" created="Wed, 15 Jul 2015 18:15:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt;: your input would be appreciated here, since you&apos;re the only user we know of to have encountered &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7275&quot; title=&quot;Errors in FlushRunnable may leave threads hung&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7275&quot;&gt;&lt;del&gt;CASSANDRA-7275&lt;/del&gt;&lt;/a&gt; (though no doubt there are others).&lt;/p&gt;</comment>
                            <comment id="14629755" author="benedict" created="Thu, 16 Jul 2015 13:51:43 +0000"  >&lt;p&gt;I&apos;ve pushed branches for &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/9669-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.0&lt;/a&gt; &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/9669-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt; and &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/9669-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;All of them are ugly.&lt;/p&gt;</comment>
                            <comment id="14631186" author="benedict" created="Fri, 17 Jul 2015 10:58:40 +0000"  >&lt;p&gt;So, I am liking this approach less and less. It may be the least effort, but it has too many sharp edges, in critical portions of the system. It&apos;s also literally a custom endeavour for 2.0, 2.1, 2.2 &lt;em&gt;and&lt;/em&gt; 3.0.&lt;/p&gt;

&lt;p&gt;I think I will introduce a new commit log expiration ledger, and just write to it whenever we perform a &lt;tt&gt;discardCompletedSegments()&lt;/tt&gt; call. This is then replayed prior to CL replay, to build the state of what records we consider replayable. Initially, I will limit this to a simple statement of &quot;latest replayposition we can be certain to have replayed to&quot; since this is a uniform behaviour for 2.0+. 2.1+ easily supports ranges, which can be implemented when we deliver &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8496&quot; title=&quot;Remove MemtablePostFlusher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8496&quot;&gt;CASSANDRA-8496&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14631236" author="benedict" created="Fri, 17 Jul 2015 11:58:08 +0000"  >&lt;p&gt;Ick. So, thinking about it from a 2.0 perspective, this is even more of a problem for counters. Since CL replay of a counter that is already persisted causes a double-count. &lt;/p&gt;

&lt;p&gt;Question is: do we care? If we do, we should probably stick with the solution I already posted for 2.0. For 2.1+ I think a ledger is a better route.&lt;/p&gt;</comment>
                            <comment id="14631764" author="xedin" created="Fri, 17 Jul 2015 19:14:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; I like min/max replay range tracking per sstable idea from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8496&quot; title=&quot;Remove MemtablePostFlusher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8496&quot;&gt;CASSANDRA-8496&lt;/a&gt; you&apos;ve also mentioned here. I&apos;m pretty sure some extra complexity in the compaction path is worth having safe reply.&lt;/p&gt;</comment>
                            <comment id="14645845" author="benedict" created="Wed, 29 Jul 2015 10:30:45 +0000"  >&lt;p&gt;So, I have a patch available for this &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/9669-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I managed to make it less invasive than I had anticipated, but it still requires an sstable version increment. The patch:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Introduces a commitLogLowerBound to the memtable, which tracks the commit log position at its creation&lt;/li&gt;
	&lt;li&gt;Changes sstable metadata&apos;s &quot;replayPosition&quot; into &quot;commitLogLowerBound&quot; and &quot;commitLogUpperBound&quot; in the new sstable version&lt;/li&gt;
	&lt;li&gt;Delays exposing a new sstable to the compaction strategy until all of its preceding flushes have completed&lt;/li&gt;
	&lt;li&gt;On compaction, extends the new sstable&apos;s lower/upper bounds to the min/max of all sstables we&apos;re replacing. Given (3), we only extend over ranges that are known to already be covered by other sstables.&lt;/li&gt;
	&lt;li&gt;On replay, we take any range covered by an sstable to not need replay (and any range prior to the earliest known safe range is also ignored)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Test Engineering: there are failures on dtests, but I cannot tell if these are new or existing. Mostly the look like flakey tests. The one that looks most worrisome to me is counter upgrade test, but could you take a look and tell me what you think of the test situation in general? Modifying 2.0 makes me uncomfortable&lt;/p&gt;</comment>
                            <comment id="14701436" author="blambov" created="Tue, 18 Aug 2015 15:36:34 +0000"  >&lt;p&gt;First round of review, focussing at the replay logic:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ReplayPosition.add&lt;/tt&gt; is suspect, as &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.0#diff-2b76f3efa4aaa38339ab8f4869c9b7bfR70&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;in extending the end&lt;/a&gt; &lt;tt&gt;extend != null&lt;/tt&gt; implies &lt;tt&gt;extend.getKey().compareTo(end) &amp;gt;= 0&lt;/tt&gt; and this makes the branch reachable only if &lt;tt&gt;end == entend.getKey()&lt;/tt&gt; which I don&apos;t think is what you want.&lt;/p&gt;

&lt;p&gt;The other direction appears correct, but the two can&apos;t be symmetrical as we can only key into starts. This is sufficient as &lt;tt&gt;range[i].key/lower &amp;lt; range[i].value/upper &amp;lt; range[i+1].key/lower&lt;/tt&gt; (which I think you should clarify in a comment) and thus the entry we want to extend us on the right is the one before the first start larger than our end. &lt;tt&gt;end = max(end, floorEntry(end).value)&lt;/tt&gt; should do it.&lt;/p&gt;

&lt;p&gt;There&apos;s no need to recursively rerun, extending in either direction has no effect on the other side so you can do the two in sequence.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;ReplayPosition.min&lt;/tt&gt; should be a bit more descriptively named, e.g. &quot;minUpperBound&quot; or &quot;firstNotCovered&quot;.&lt;/p&gt;

&lt;p&gt;I&apos;d call &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.0#diff-348a1347dacf897385fb0a97116a1b5eR166&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CommitLogReplayer.replay&lt;/a&gt; &quot;shouldReplay&quot;. Consider moving the containment logic (the last two lines) into &lt;tt&gt;ReplayPosition&lt;/tt&gt; to keep the details of the range format within the class. I believe the intervals are start-inclusive, end-exclusive, thus the &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.0#diff-348a1347dacf897385fb0a97116a1b5eR172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;final comparison&lt;/a&gt; should be &lt;tt&gt;&amp;lt;=&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Could you update the JavaDoc, especially returned values (e.g. &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.0#diff-98f5acb96aa6d684781936c141132e2aR2498&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.0#diff-f0a15c3588b56c5ce53ece7c48e325b5R247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;)? The comment &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.0#diff-348a1347dacf897385fb0a97116a1b5eR333&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; is outdated.&lt;/p&gt;

&lt;p&gt;Is &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.0#diff-f0a15c3588b56c5ce53ece7c48e325b5R352&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;FlushRunnable.runMayThrow&lt;/a&gt; still needed? DiskAwareRunnable?&lt;/p&gt;

&lt;p&gt;I&apos;ll continue looking at rest of the code tomorrow.&lt;/p&gt;</comment>
                            <comment id="14701694" author="benedict" created="Tue, 18 Aug 2015 17:55:16 +0000"  >&lt;p&gt;Thanks. Looking at the patch, it&apos;s clear I wrote it in a bit of a rush, as there&apos;s another problem with it: it doesn&apos;t actually delay compaction with STCS. I will need to make STCS rely on the notifyAdded, much as LCS does, or introduce a new collection in &lt;tt&gt;DataTracker&lt;/tt&gt; (this latter being less invasive, but uglier)&lt;/p&gt;

&lt;p&gt;I will look to introduce at least a basic unit test for this problem, as well as fix these problems, tomorrow. However the main thrust of the patch is still good, so it&apos;s up to you if you want to abort review in lieu of this.&lt;/p&gt;</comment>
                            <comment id="14702785" author="blambov" created="Wed, 19 Aug 2015 09:53:54 +0000"  >&lt;p&gt;Should we really ignore the timespan before the first known sstable interval? This can break correct replay for a fresh table, can&apos;t it (if the first two flushes are initiated close together and the node dies after the latter completes early)?&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;CompactionManager.instance.submitBackground(cfstore)&lt;/tt&gt; in &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.0#diff-06edf300ef64021a42929f19d0cfba3bR185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;permitCompactionOfFlush&lt;/a&gt; is new and appears to be a change in behaviour. Could you explain in a comment why it is now necessary?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.0#diff-0c40f7e67fc53dd15d5fe193e55b2b04R494&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SSTableMetadata.deserialize&lt;/a&gt;: is there a reason to pass &lt;tt&gt;hasCommitLogLowerBound&lt;/tt&gt; around separately when it always matches the one in the passed descriptor?&lt;/p&gt;</comment>
                            <comment id="14702841" author="benedict" created="Wed, 19 Aug 2015 10:42:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;Should we really ignore the timespan before the first known sstable interval? This can break correct replay for a fresh table, can&apos;t it (if the first two flushes are initiated close together and the node dies after the latter completes early)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You mean the global position, I assume? I wasn&apos;t really sure the best thing to do here, since it&apos;s a major performance optimisation to skip large chunks of commit log. I&apos;m not so sure about regressing 2.0 replay for a border case during replay of a fresh table, when we&apos;ve been so broken for all tables. I&apos;m also reticent to make more changes than absolutely necessary; tracking the commit log replay position at construction of a table would be the better solution, but I would rather wait until 3.0+ for that.&lt;/p&gt;

&lt;p&gt;I&apos;m working on improving the comments as well as addressing the other issues.&lt;/p&gt;</comment>
                            <comment id="14702860" author="benedict" created="Wed, 19 Aug 2015 11:10:08 +0000"  >&lt;p&gt;I&apos;ve pushed an update that I hope addresses most of your (current) concerns. I&apos;ll now work on introducing some basic unit tests, before giving it another final review of my own.&lt;/p&gt;</comment>
                            <comment id="14703619" author="benedict" created="Wed, 19 Aug 2015 19:36:40 +0000"  >&lt;p&gt;I&apos;ve updated the patch to include a unit test, and to fix two more problems. One typo, and the &lt;tt&gt;shouldReplay&lt;/tt&gt; logic was still incorrect. Whenever I interface with ReplayPosition I have a strong urge to rewrite it. It is terribly counterintuitive, but I guess that&apos;s what we have unit tests for.&lt;/p&gt;

&lt;p&gt;Long story short, the ranges are inclusive-start, exclusive-end, the inverse of what you expected. This confusion stems from the fact we use points to represent ranges (i.e. commit log entries) and points that demarcate ranges (those that have been persisted), which doesn&apos;t really make sense. But during replay, and on a write, the &lt;tt&gt;ReplayPosition&lt;/tt&gt; for a record is the position in the segment &lt;em&gt;directly proceeding&lt;/em&gt; its serialization location, i.e. it is the exclusive upper bound of its bytes. It is, in effect, represented by the one number that falls outside of its on disk representation.&lt;/p&gt;

&lt;p&gt;Anyway, it&apos;s good for a proper review now. I accidentally collapsed the most recent follow up commit with the one I uploaded this morning, but mostly this was just the unit test, plus those two items (one removed &lt;tt&gt;!&lt;/tt&gt;, and the inverted bounds checking)&lt;/p&gt;</comment>
                            <comment id="14704693" author="blambov" created="Thu, 20 Aug 2015 11:21:27 +0000"  >&lt;p&gt;The code looks good now, +1.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;the ranges are inclusive-start, exclusive-end, the inverse of what you expected&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, they are the inverse of what I expected, but that&apos;s actually start-exclusive, end-inclusive, the &lt;a href=&quot;https://github.com/apache/cassandra/commit/459b96333c84837fe757d706c2a6be91b8b27f2e#diff-2b76f3efa4aaa38339ab8f4869c9b7bfR88&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;shouldReplay comment&lt;/a&gt; is correct. I&apos;d also add &quot;as a mutation&apos;s replay position is assigned after it is added to the log&quot; to it.&lt;/p&gt;

&lt;p&gt;Deleting the files at &lt;a href=&quot;https://github.com/apache/cassandra/commit/459b96333c84837fe757d706c2a6be91b8b27f2e#diff-b3802331f8dcba05356ad47ee54fe6dfR321&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the start of the test&lt;/a&gt; may cause problems on Windows, but I don&apos;t know how to this safely in 2.0.&lt;/p&gt;</comment>
                            <comment id="14738563" author="benedict" created="Thu, 10 Sep 2015 10:41:04 +0000"  >&lt;p&gt;There was a consensus that it was too late in 2.0&apos;s lifecycle to fix this there, however the patch is available for anyone that wants to apply it.&lt;/p&gt;

&lt;p&gt;I&apos;ve merged/rebased with 2.1 &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/9669-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, which necessarily changes it not insignificantly. It&apos;s ready for another round of review (although CI is screwy right now, so hard to say with certainty it hasn&apos;t introduced any regressions).&lt;/p&gt;</comment>
                            <comment id="14745367" author="blambov" created="Tue, 15 Sep 2015 12:41:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.1#diff-f0a15c3588b56c5ce53ece7c48e325b5R171&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Memtable.isCleanAfter&lt;/a&gt; doesn&apos;t look right. This guarantees that it does not contain data &lt;em&gt;before&lt;/em&gt; the given position, and thus &lt;tt&gt;CFS.forceFlush(ReplayPosition)&lt;/tt&gt; does not appear to use it correctly.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.1#diff-d1b9592895e36631679f1d5cab0f61f1R97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Descriptor.Version.isCompatible&lt;/a&gt; is suspect in the context of this ticket, &quot;ka&quot; reader says compatible with &quot;kb&quot; data but read will fail. Later readers (e.g. &quot;la&quot;) will also fail to read these tables but say they are compatible. Could this cause trouble?&lt;/p&gt;

&lt;p&gt;The new format needs to be added to &lt;tt&gt;LegacySSTableTest&lt;/tt&gt; and &lt;tt&gt;test/data/legacy-sstables&lt;/tt&gt; and included in 2.2 and 3.0 versions of the patch.&lt;/p&gt;

&lt;p&gt;&lt;br class=&quot;atl-forced-newline&quot; /&gt;
&lt;br class=&quot;atl-forced-newline&quot; /&gt;
Nits:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/belliottsmith/cassandra/blob/d190c29d5e24e0b2a93a844d250695107e8bb942/src/java/org/apache/cassandra/db/Memtable.java#L64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Memtable.approximateCommitLogLowerBound&lt;/a&gt;: This must satisfy &lt;tt&gt;approximateCommitLogLowerBound &amp;lt;= commitLogLowerBound&lt;/tt&gt; (after discarding predecessor), mustn&apos;t it? Could you add a comment to say so?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.1#diff-98f5acb96aa6d684781936c141132e2aR972&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Memtable.forceFlush(ReplayPosition)&lt;/a&gt; no longer loops through index CFSes, can you add a comment to state why this is the right thing to do?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.1#diff-f0a15c3588b56c5ce53ece7c48e325b5R379&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;writeSortedContents&lt;/a&gt;: duplicate log?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.1#diff-d1b9592895e36631679f1d5cab0f61f1R56&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Descriptor.Version version text&lt;/a&gt;: 2.&lt;em&gt;1&lt;/em&gt;.7; j versions are compatible according to &lt;tt&gt;isCompatible&lt;/tt&gt;, shouldn&apos;t comment be retained?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.1#diff-0f1c5b6135b34548f033e5168f6761a5R96&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;LegacyMetadataSerializer.serialize&lt;/a&gt;: No need to declare &lt;tt&gt;commitLogUpperBound&lt;/tt&gt; here. Declare with assignment below to ease reading.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.1#diff-63785fd0e03996f22c0c2c38eb137f7fR71&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;SSTableMetadataViewer&lt;/a&gt;: Could use some text describing what&apos;s being printed.&lt;/p&gt;</comment>
                            <comment id="14745432" author="benedict" created="Tue, 15 Sep 2015 13:10:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;Memtable.isCleanAfter doesn&apos;t look right. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good catch, I have inverted the implementation and meaning, and renamed it to &lt;tt&gt;mayContainDataSince&lt;/tt&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;&quot;ka&quot; reader says compatible with &quot;kb&quot; data but read will fail&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hmm. This is a bit of a problem. I must admit I didn&apos;t look too closely at compatibility, since I assumed the whole point of the major/minor chars was to permit intra- and extra-version sstable version increments. Without that, this seems to be a bit of a mess. I guess we will need to increment all of the sstable versions past the max of the current. We should perhaps rethink accepting all versions &amp;lt;= first char of current, as it doesn&apos;t permit much flexibility.&lt;/p&gt;

&lt;p&gt;Thanks. I&apos;ll address this, your nits, and what looks like a relatively innocuous problem with DTCS shortly.&lt;/p&gt;


</comment>
                            <comment id="14745464" author="benedict" created="Tue, 15 Sep 2015 13:40:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;Hmm. This is a bit of a problem. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I remember now why it is not. We don&apos;t generally permit downgrades, and when upgrading you must upgrade via the latest of any intervening minor version. &lt;/p&gt;

&lt;p&gt;Whether or not this is a problem, I think it&apos;s probably better left for another ticket, but I think we would be best off fixing it so a given c* version knows the maximum sstable version it can read for each prior (and equal) minor cassandra version. So long as the main data format is the same (which is the case here) there shouldn&apos;t be a problem, as we only stream the data contents between nodes, so there&apos;s no reason for an old version to see a new file. However we should probably make that more robust to sstable version changes also.&lt;/p&gt;</comment>
                            <comment id="14745503" author="iamaleksey" created="Tue, 15 Sep 2015 14:03:27 +0000"  >&lt;p&gt;FWIW we do have startup checks that do this - &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StartupChecks.java#L209&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StartupChecks.java#L209&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14745510" author="benedict" created="Tue, 15 Sep 2015 14:08:48 +0000"  >&lt;p&gt;Except that this won&apos;t fail the startup checks if you downgrade patch versions. Or upgrade to a non-latest patch version when upgrading your major/minor.&lt;/p&gt;</comment>
                            <comment id="14877154" author="benedict" created="Sat, 19 Sep 2015 14:44:30 +0000"  >&lt;p&gt;I&apos;ve addressed your nits, but giving the patch another review, I realise that the approach I&apos;ve taken with the new parent compaction strategy isn&apos;t going to cut it in 2.1. This isn&apos;t the complete set of operations that can mark things compacting, and if we e.g. redistribute summaries (or attempt an &quot;all sstable&quot; operation) we may screw up the state badly. &lt;/p&gt;

&lt;p&gt;In 2.1, we can instead safely mark compacting before we make the sstable available in the live set, however this too has problems: any &quot;all sstable&quot; operation will fail if flushes have gotten far behind, or secondary index flushes are taking too long. So we will probably have to introduce a new of sstables into the DataTracker.View that tracks these &lt;em&gt;almost complete&lt;/em&gt; sstables, and filters them from any &quot;all sstable&quot; operation. This is a really rather ugly edge case to behaviour, and in 3.X I&apos;ll see if there&apos;s anything we can do to make it more apparent to consumers of the API.&lt;/p&gt;</comment>
                            <comment id="14976411" author="benedict" created="Tue, 27 Oct 2015 13:49:48 +0000"  >&lt;p&gt;I&apos;ve pushed a new version of this &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/9669-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. This introduces a new &lt;tt&gt;premature&lt;/tt&gt; set into &lt;tt&gt;lifecycle.View&lt;/tt&gt;, which any sstable is maintain in until all preceding (and custom 2i) writes have completed.&lt;/p&gt;

&lt;p&gt;This version is against 2.2, as 2.1 will go EOL soon, and I don&apos;t feel comfortable changing these semantics without any recourse if something isn&apos;t right.&lt;/p&gt;</comment>
                            <comment id="15026925" author="blambov" created="Wed, 25 Nov 2015 15:26:54 +0000"  >&lt;p&gt;The code looks good to me.&lt;/p&gt;

&lt;p&gt;Nit: &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:9669-2.2#diff-f0a15c3588b56c5ce53ece7c48e325b5R96&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Comment to &lt;tt&gt;Memtable&lt;/tt&gt; contructor&lt;/a&gt; appears wrong as it is the one e.g. &lt;tt&gt;CFS.Flush&lt;/tt&gt; uses.&lt;/p&gt;</comment>
                            <comment id="15029053" author="slebresne" created="Thu, 26 Nov 2015 16:15:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; As Benedict is currently out, do you mind pushing the branch with your nit fixed and running CI on it to be sure (as I don&apos;t see a recent CI run for this).&lt;/p&gt;</comment>
                            <comment id="15029168" author="blambov" created="Thu, 26 Nov 2015 18:29:25 +0000"  >&lt;p&gt;Rebased and uploaded &lt;a href=&quot;https://github.com/blambov/cassandra/tree/belliottsmith-9669-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. &lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Testall&lt;/a&gt; is clean, &lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; has a &lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-2.2-dtest/lastCompletedBuild/testReport/thrift_hsha_test/ThriftHSHATest/test_closing_connections/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test_closing_connections failure&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15031619" author="blambov" created="Mon, 30 Nov 2015 10:21:38 +0000"  >&lt;p&gt;The same failure appeared on the &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blambov/job/blambov-belliottsmith-9669-2.2-dtest/2/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;second dtest run&lt;/a&gt;, and isn&apos;t present in any of the &lt;a href=&quot;http://cassci.datastax.com/job/cassandra-2.2_dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;base runs&lt;/a&gt;. Looks like this is a real regression.&lt;/p&gt;</comment>
                            <comment id="15087629" author="blambov" created="Thu, 7 Jan 2016 16:09:05 +0000"  >&lt;p&gt;Rebased and run tests again, they are flaky but doesn&apos;t appear there&apos;s any repeatable problem:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/belliottsmith-9669-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blambov/job/blambov-belliottsmith-9669-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blambov/job/blambov-belliottsmith-9669-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15087701" author="benedict" created="Thu, 7 Jan 2016 17:06:50 +0000"  >&lt;p&gt;There do seem to be some failures not on stock 2.2, but they do not seem to be plausibly related.  The snitch problem appears to literally be a snitch problem, for instance.&lt;/p&gt;

&lt;p&gt;There do appear to be an unpleasantly large number of flaky tests for 2.2, however, so it&apos;s very hard to say much with clarity.&lt;/p&gt;</comment>
                            <comment id="15098801" author="benedict" created="Thu, 14 Jan 2016 20:37:01 +0000"  >&lt;p&gt;According to &lt;a href=&quot;https://wiki.apache.org/cassandra/CompatibilityGuarantees&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://wiki.apache.org/cassandra/CompatibilityGuarantees&lt;/a&gt; this may have to be delayed until 4.0&lt;/p&gt;</comment>
                            <comment id="15101477" author="slebresne" created="Fri, 15 Jan 2016 08:41:41 +0000"  >&lt;blockquote&gt;&lt;p&gt;According to &lt;a href=&quot;https://wiki.apache.org/cassandra/CompatibilityGuarantees&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://wiki.apache.org/cassandra/CompatibilityGuarantees&lt;/a&gt; this may have to be delayed until 4.0&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Can you clarify which rule would be broken by this patch? If that&apos;s the downgrading one due a change to the commit log format, then that&apos;s a good point but I think I&apos;d be personally fine amending that rule slightly to say that you can downgrade but you have to drain before doing so. The other option being to proceed in 2 steps: have an intermediate version that is able to read both the old and new format of the commit log, but still write the old one, and switching to the new one in the following version. Or of course to wait for 4.0.&lt;/p&gt;</comment>
                            <comment id="15101531" author="benedict" created="Fri, 15 Jan 2016 09:22:22 +0000"  >&lt;p&gt;The sstable version is also modified, and that clause seems to prohibit such a change.&lt;/p&gt;</comment>
                            <comment id="15101593" author="slebresne" created="Fri, 15 Jan 2016 10:33:00 +0000"  >&lt;p&gt;That clause doesn&apos;t prevent all sstable version changes. It&apos;s ok to do a &quot;minor&quot; sstable version bump by adding new fields at the end of the sstable metadata since older version will just ignore it. From a quick glance to the patch, it does seem to change the metadata in a way that is not backward compatible, but it looks trivial to change it so that it is. This is listed at the end of the compatibility document btw.&lt;/p&gt;</comment>
                            <comment id="15101603" author="benedict" created="Fri, 15 Jan 2016 10:42:18 +0000"  >&lt;p&gt;The only way to make it backwards compatible is to carry on blithely if the value is not present.  I&apos;m not sure I&apos;m a particular fan of this approach, because this is pretty critical to correctness, and simply ignoring its absence is ripe for future bugs screwing it up.&lt;/p&gt;</comment>
                            <comment id="15101607" author="benedict" created="Fri, 15 Jan 2016 10:45:21 +0000"  >&lt;p&gt;At the very least we should create a 4.0 line where this can be implemented properly&lt;/p&gt;</comment>
                            <comment id="15101631" author="slebresne" created="Fri, 15 Jan 2016 11:01:32 +0000"  >&lt;p&gt;It&apos;s possible I&apos;m missing something here, but say we commit this to 3.4, we can still bump the sstable version to &lt;tt&gt;&quot;mb&quot;&lt;/tt&gt;, writting the new lower bound replay position at the end of the metadata and 3.4 would still &lt;em&gt;always&lt;/em&gt; expect that lower bound to be present when reading &lt;tt&gt;&quot;mb&quot;&lt;/tt&gt; sstables. But if someone decides to use a &lt;tt&gt;&quot;mb&quot;&lt;/tt&gt; sstable with 3.3, this will still work because 1) to the best of my knowledge, 3.3 doesn&apos;t reject (sstable) version in the future (and it&apos;s the same &quot;major&quot; sstable version so streaming and such are not impacted) and 2) it&apos;ll just ignore the additional data it doesn&apos;t know at the end of the metadata file.&lt;/p&gt;

&lt;p&gt;The only ugliness I see is that in the sstable metadata the lower and upper bound are not serialized close from each other, but that&apos;s a very minor and very localized (in the code) ugliness and can be easily fixed later in 4.0.&lt;/p&gt;</comment>
                            <comment id="15101634" author="benedict" created="Fri, 15 Jan 2016 11:05:14 +0000"  >&lt;p&gt;Hmm, I guess I was getting confused with CL versions - I thought we refused to startup if we had a newer version than we know about.  My mistake&lt;/p&gt;</comment>
                            <comment id="15101643" author="benedict" created="Fri, 15 Jan 2016 11:09:37 +0000"  >&lt;p&gt;I would still consider updating the guide to specify clearly that a drain is necessary on downgrade.  In fact - and I realise this is completely off-topic now - I think we need to ensure that after a drain we leave no intact segment.  Even an empty segment would cause a downgrade to fail if it&apos;s the wrong version.&lt;/p&gt;</comment>
                            <comment id="15101648" author="slebresne" created="Fri, 15 Jan 2016 11:13:28 +0000"  >&lt;p&gt;You&apos;re right, I&apos;ll add that.&lt;/p&gt;</comment>
                            <comment id="15112552" author="slebresne" created="Fri, 22 Jan 2016 15:41:31 +0000"  >&lt;p&gt;I believe the patch needs at least the changes discussed above, of making the changes to the sstable metadata only be new appends to the end. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; could you make those changes?&lt;/p&gt;

&lt;p&gt;Also, I&apos;m slightly confused on the versions here: I see the patch for 2.2 with CI results but nothing for 3.0. Surely the patch doesn&apos;t merge up cleanly, does it?&lt;/p&gt;</comment>
                            <comment id="15112566" author="benedict" created="Fri, 22 Jan 2016 15:49:41 +0000"  >&lt;p&gt;I&apos;ve already made the changes and am working on a merge (you assume correctly; it is in fact quite painful).&lt;/p&gt;</comment>
                            <comment id="15117445" author="benedict" created="Tue, 26 Jan 2016 15:57:29 +0000"  >&lt;p&gt;Patch for 3.0 available &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/9669-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15121813" author="slebresne" created="Thu, 28 Jan 2016 16:18:54 +0000"  >&lt;p&gt;Seems we have both the 2.2 and 3.0 version now. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; can you do a last round of review, especially on the 3.0 version, when you have a minute?&lt;/p&gt;</comment>
                            <comment id="15253951" author="blambov" created="Fri, 22 Apr 2016 13:45:51 +0000"  >&lt;p&gt;Rebased patches with a couple of extra tests:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/belliottsmith-9669-2.2-rebased-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-2.2-rebased-2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-2.2-rebased-2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/belliottsmith-9669-3.0-rebased-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-3.0-rebased-2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-3.0-rebased-2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The code looks good to me in both, tests are still running.&lt;/p&gt;</comment>
                            <comment id="15276365" author="blambov" created="Mon, 9 May 2016 13:37:49 +0000"  >&lt;p&gt;The test failures appear to be flakes &amp;#8211; mainly timeouts, and the failing tests pass when I run them locally. Patch is thus ready to commit.&lt;/p&gt;</comment>
                            <comment id="15280027" author="slebresne" created="Wed, 11 May 2016 12:10:51 +0000"  >&lt;p&gt;Wanted to commit, but the 3.0 code doesn&apos;t merge cleanly to 3.7/trunk at all. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; could you attach branches/tests for those version too (there is also a minor conflict on 2.2/3.0 due to a recent commit. I was planning to fix that during commit before seeing that merging up was more complex, but if you could rebase and squahs those branches too, that would make my life easier). &lt;/p&gt;</comment>
                            <comment id="15281336" author="blambov" created="Thu, 12 May 2016 09:00:25 +0000"  >&lt;p&gt;Squashed and rebased again, added CHANGES.txt line and commit message, and made 3.7 and trunk versions:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/belliottsmith-9669-2.2-rebased-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-2.2-rebased-2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-2.2-rebased-2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/belliottsmith-9669-3.0-rebased-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-3.0-rebased-2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-3.0-rebased-2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/belliottsmith-9669-3.7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.7&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-3.7-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-3.7-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/belliottsmith-9669-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-belliottsmith-9669-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Tests look okay.&lt;/p&gt;</comment>
                            <comment id="15281511" author="slebresne" created="Thu, 12 May 2016 13:23:51 +0000"  >&lt;p&gt;Perfect, committed, thanks.&lt;/p&gt;</comment>
                            <comment id="15282844" author="JIRAUSER308715" created="Fri, 13 May 2016 16:09:18 +0000"  >&lt;p&gt;This seems to have broken something.  A bunch of test we have started failing to truncate things with timeouts, and a bunch of threads blocked like so:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;SharedPool-Worker-15&quot;&lt;/span&gt; 
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: BLOCKED
        at org.apache.cassandra.db.ColumnFamilyStore.truncateBlocking(ColumnFamilyStore.java:1973)
        at org.apache.cassandra.db.TruncateVerbHandler.doVerb(TruncateVerbHandler.java:40)
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:67)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164)
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136)
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On cassandra-3.0@78a3d2bba95b9efcda152a157f822f4970f22636&lt;/p&gt;</comment>
                            <comment id="15282848" author="JIRAUSER308715" created="Fri, 13 May 2016 16:15:41 +0000"  >&lt;p&gt;Probably blocked by:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;SharedPool-Worker-1&quot;&lt;/span&gt; 
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: WAITING
        at sun.misc.Unsafe.park(Native Method)
        at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
        at java.util.concurrent.FutureTask.awaitDone(FutureTask.java:429)
        at java.util.concurrent.FutureTask.get(FutureTask.java:191)
        at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:380)
        at org.apache.cassandra.db.ColumnFamilyStore.forceBlockingFlush(ColumnFamilyStore.java:894)
        at org.apache.cassandra.db.ColumnFamilyStore.truncateBlocking(ColumnFamilyStore.java:1975)
        at org.apache.cassandra.db.TruncateVerbHandler.doVerb(TruncateVerbHandler.java:40)
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:67)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164)
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136)
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;MemtablePostFlush:1&quot;&lt;/span&gt; 
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: BLOCKED
        at org.apache.cassandra.index.SecondaryIndexManager.flushIndexesBlocking(SecondaryIndexManager.java:466)
        at org.apache.cassandra.index.SecondaryIndexManager.flushAllNonCFSBackedIndexesBlocking(SecondaryIndexManager.java:484)
        at org.apache.cassandra.db.ColumnFamilyStore$PostFlush.call(ColumnFamilyStore.java:936)
        at org.apache.cassandra.db.ColumnFamilyStore$PostFlush.call(ColumnFamilyStore.java:901)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15283315" author="benedict" created="Fri, 13 May 2016 23:46:42 +0000"  >&lt;p&gt;I&apos;m not sure if the behaviour for locking on the base table when flushing indexes was present when I wrote this patch, but both that sync (in SecondaryIndexManager), and this one (in truncation), are ill advised:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Synchronizing on a base table for an action that is triggered by an acton that itself must synchronize on the base table is asking for trouble&lt;/li&gt;
	&lt;li&gt;Synchronizing in either case over a lengthy operation that may itself synchronize is also asking for trouble&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As it is, I threw the synchronized in there along with some other modifications to make the truncation of views less obviously broken.  I think it&apos;s probably still broken, just less obviously so, so it may as well be taken out to make this right.&lt;/p&gt;</comment>
                            <comment id="15283354" author="maedhroz" created="Sat, 14 May 2016 01:11:45 +0000"  >&lt;p&gt;I&apos;ve been able to reproduce this with a plain custom 2i that doesn&apos;t have a backing CF:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh&amp;gt; CREATE KEYSPACE truncation_test WITH replication = {&apos;class&apos;: &apos;NetworkTopologyStrategy&apos; , &apos;DC1&apos;: &apos;1&apos;};
cqlsh&amp;gt; use truncation_test ;
cqlsh:truncation_test&amp;gt; CREATE TABLE simple_table (id text, value text, PRIMARY KEY (id));
cqlsh:truncation_test&amp;gt; CREATE CUSTOM INDEX value_index ON simple_table (value) USING &apos;c.d.b.util.DummyIndex&apos;;
cqlsh:truncation_test&amp;gt; INSERT INTO simple_table(id,value) VALUES(&apos;1&apos;,&apos;value1&apos;);
cqlsh:truncation_test&amp;gt; TRUNCATE simple_table;
OperationTimedOut: errors={}, last_host=127.0.0.1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15283492" author="blambov" created="Sat, 14 May 2016 08:50:43 +0000"  >&lt;p&gt;Patch to remove the synchronization from &lt;tt&gt;truncateBlocking&lt;/tt&gt; here:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/9669-fix-sync-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9669-fix-sync-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9669-fix-sync-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/9669-fix-sync-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9669-fix-sync-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9669-fix-sync-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;(3.0 patch applies cleanly upwards)&lt;/p&gt;

&lt;p&gt;This is a temporary fix; I will think more seriously about the safety of this as part of &lt;tt&gt;PostFlush&lt;/tt&gt; removal (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8496&quot; title=&quot;Remove MemtablePostFlusher&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8496&quot;&gt;CASSANDRA-8496&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="15284736" author="JIRAUSER308715" created="Mon, 16 May 2016 15:39:08 +0000"  >&lt;p&gt;I don&apos;t know if there are other implications of removing that synchronized, but my tests work again on that branch.&lt;/p&gt;</comment>
                            <comment id="15286250" author="slebresne" created="Tue, 17 May 2016 08:59:14 +0000"  >&lt;p&gt;I assume that there is no 2.2 patch for that removal because 2.2 is not affected?&lt;/p&gt;</comment>
                            <comment id="15286255" author="blambov" created="Tue, 17 May 2016 09:02:51 +0000"  >&lt;p&gt;That&apos;s correct, no sync was added in the 2.2 version.&lt;/p&gt;</comment>
                            <comment id="15286260" author="benedict" created="Tue, 17 May 2016 09:07:34 +0000"  >&lt;p&gt;Actually.... I did move the synchronized out one step to encompass the &lt;tt&gt;forceBlockingFlush&lt;/tt&gt; in 2.2, so it is affected.&lt;/p&gt;</comment>
                            <comment id="15286292" author="blambov" created="Tue, 17 May 2016 09:36:00 +0000"  >&lt;p&gt;Oops, I&apos;ve managed to overlook that. The sync in the index manager that causes the deadlock in combination with it is not present, though.&lt;/p&gt;

&lt;p&gt;Anyway, it is probably best to revert the synchronization change in 2.2 as well. Patch here:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/9669-fix-sync-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9669-fix-sync-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9669-fix-sync-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;(tests still running)&lt;/p&gt;</comment>
                            <comment id="15287332" author="JIRAUSER308715" created="Tue, 17 May 2016 19:17:37 +0000"  >&lt;p&gt;We should probably also add a dtest or unit test to cover this case so we don&apos;t over synchronize in the future.&lt;/p&gt;</comment>
                            <comment id="15289699" author="jmckenzie" created="Wed, 18 May 2016 20:02:22 +0000"  >&lt;p&gt;  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;: Care to take review of these small fix-up patches?&lt;/p&gt;</comment>
                            <comment id="15289709" author="benedict" created="Wed, 18 May 2016 20:06:22 +0000"  >&lt;p&gt;Sure; +1&lt;/p&gt;</comment>
                            <comment id="15289824" author="benedict" created="Wed, 18 May 2016 21:07:36 +0000"  >&lt;p&gt;Committed as 2837ec65b91abd78ec1bb37f1d69565b976e42e6&lt;/p&gt;</comment>
                            <comment id="15290844" author="beobal" created="Thu, 19 May 2016 10:16:08 +0000"  >&lt;p&gt;I&apos;m suspicious that there may still be issues related to the synchronization here as there are regressions in CassandraIndexTest on both trunk and 3.0 since this was committed. &lt;/p&gt;</comment>
                            <comment id="15290931" author="beobal" created="Thu, 19 May 2016 11:30:54 +0000"  >&lt;p&gt;FTR, the extra synchronization in SecondaryIndexManager isn&apos;t necessary in the post flush task because there we&apos;re only concerned with non-CFS backed indexes. It is currently present because &lt;tt&gt;flushAllNonCfsIndexesBlocking&lt;/tt&gt; in 3.0+ reuses the main &lt;tt&gt;flushAllIndexes&lt;/tt&gt; method, which is called from other contexts and so does have to take care to coordinate. &lt;/p&gt;

&lt;p&gt;Removing that sync from SIM can be easily done, so may be better solution to the deadlock. I&apos;ve pushed a commit based on 3.0 &lt;a href=&quot;https://github.com/beobal/cassandra/commit/8404f3bc44bdd3f2b5f636b25e6b2eabe3faa261&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15292991" author="slebresne" created="Fri, 20 May 2016 08:20:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;, would one of you have some time to look at &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; patch above?&lt;/p&gt;</comment>
                            <comment id="15293021" author="beobal" created="Fri, 20 May 2016 08:50:45 +0000"  >&lt;p&gt;To be clear, my patch addresses the deadlock during flush, but it seems that the regressions in &lt;tt&gt;CassandraIndexTest&lt;/tt&gt; started when the initial patch was committed (at least I don&apos;t see any before then and they happen pretty regularly since) - &lt;a href=&quot;http://cassci.datastax.com/view/cassandra-3.0/job/cassandra-3.0_utest/747/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/cassandra-3.0/job/cassandra-3.0_utest/747/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15293760" author="blambov" created="Fri, 20 May 2016 17:21:02 +0000"  >&lt;p&gt;+1 on Sam&apos;s patch&lt;/p&gt;

&lt;p&gt;I will look into the test failures next week.&lt;/p&gt;</comment>
                            <comment id="15301978" author="blambov" created="Thu, 26 May 2016 11:58:54 +0000"  >&lt;p&gt;Test failure patch:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/9669-regression-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9669-regression-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9669-regression-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/9669-regression-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9669-regression-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9669-regression-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/9669-regression&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9669-regression-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/job/blambov-9669-regression-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;p&gt;(2.2 patch applies cleanly upwards)&lt;/p&gt;

&lt;p&gt;Removed synchronization over &lt;tt&gt;forceFlush&lt;/tt&gt; let base table flushes happen while index build was still in progress.&lt;/p&gt;</comment>
                            <comment id="15303953" author="beobal" created="Fri, 27 May 2016 11:32:57 +0000"  >&lt;p&gt;LGTM &amp;amp; haven&apos;t had a &lt;tt&gt;CassandraIndexTest&lt;/tt&gt; failure in &amp;gt; 30 runs. &lt;/p&gt;

&lt;p&gt;Although it isn&apos;t strictly needed after the previous commit, I&apos;ve added my &lt;tt&gt;SIM&lt;/tt&gt; change as the sync when flushing non-CFS indexes is totally unnecessary. I also added a test in that commit, which would&apos;ve caught the deadlock in the first place. If we&apos;re all good with that, I&apos;ll commit once CI finishes.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/9669-follow-up-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;9669-follow-up-2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-9669-follow-up-2.2-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-9669-follow-up-2.2-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/9669-follow-up-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;9669-follow-up-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-9669-follow-up-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-9669-follow-up-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/9669-follow-up-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;9669-follow-up-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-9669-follow-up-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-9669-follow-up-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15306462" author="blambov" created="Mon, 30 May 2016 09:59:25 +0000"  >&lt;p&gt;I&apos;m happy with this version of the fix, CI looks ok. Let&apos;s commit.&lt;/p&gt;</comment>
                            <comment id="15307455" author="beobal" created="Tue, 31 May 2016 08:47:00 +0000"  >&lt;p&gt;ok, committed Branimir&apos;s patch to 2.2 in &lt;tt&gt;66c8f2b7f79fe794cc1e0594d9add260c209a9a2&lt;/tt&gt; and mine to 3.0 in &lt;tt&gt;81ffc4601952ff3a9fec8493cd27fe52544ea115&lt;/tt&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12845060">CASSANDRA-9806</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12845951">CASSANDRA-9840</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 25 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2gljr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327240">1.2.19</customfieldvalue>
    <customfieldvalue id="12332369">2.0.16</customfieldvalue>
    <customfieldvalue id="12332753">2.1.7</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>