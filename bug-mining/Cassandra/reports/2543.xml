<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6373] describe_ring hangs with hsha thrift server</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6373</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There is a strange bug with the thrift hsha server in 2.0 (we switched to lmax disruptor server).&lt;/p&gt;

&lt;p&gt;The bug is that the first call to describe_ring from one connection will hang indefinitely when the client is not connecting from localhost (or it at least looks like the client is not on the same host). Additionally the cluster must be using vnodes. When connecting from localhost the first call will work as expected. And in either case subsequent calls from the same connection will work as expected. According to git bisect the bad commit is the switch to the lmax disruptor server:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/98eec0a223251ecd8fec7ecc9e46b05497d631c6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/98eec0a223251ecd8fec7ecc9e46b05497d631c6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve attached the patch I used to reproduce the error in the unit tests. The command to reproduce is: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;PYTHONPATH=test nosetests --tests=system.test_thrift_server:TestMutations.test_describe_ring
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I reproduced on ec2 and a single machine by having the server bind to the private ip on ec2 and the client connect to the public ip (so it appears as if the client is non local). I&apos;ve also reproduced with two different vms though.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12679842">CASSANDRA-6373</key>
            <summary>describe_ring hangs with hsha thrift server</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xedin">Pavel Yaskevich</assignee>
                                    <reporter username="nickmbailey">Nick Bailey</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 Nov 2013 23:25:49 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:59 +0000</updated>
                            <resolved>Sat, 11 Jan 2014 01:29:13 +0000</resolved>
                                        <fixVersion>2.0.5</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13845690" author="xedin" created="Wed, 11 Dec 2013 20:05:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nickmbailey&quot; class=&quot;user-hover&quot; rel=&quot;nickmbailey&quot;&gt;nickmbailey&lt;/a&gt; Have you tried doing reads/writes with the same setup? I&apos;m just wondering if it&apos;s &lt;b&gt;only&lt;/b&gt; describe_ring or everything else too which displays the same behavior?...&lt;/p&gt;</comment>
                            <comment id="13845848" author="nickmbailey" created="Wed, 11 Dec 2013 23:35:42 +0000"  >&lt;p&gt;I can check tomorrow. I &lt;b&gt;think&lt;/b&gt; i saw it with describe keyspaces as well but I&apos;m not positive. I have the ec2 machine i recreated on as well which I could probably give you access to if you want.&lt;/p&gt;</comment>
                            <comment id="13847650" author="nickmbailey" created="Fri, 13 Dec 2013 16:53:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt; I&apos;ve verified its &lt;b&gt;only&lt;/b&gt; the describe_ring call. Other calls seem to work fine. Let me know if you want access to the machine I used to reproduce.&lt;/p&gt;</comment>
                            <comment id="13852322" author="nickmbailey" created="Wed, 18 Dec 2013 23:43:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt; any insight yet?&lt;/p&gt;</comment>
                            <comment id="13852463" author="xedin" created="Thu, 19 Dec 2013 01:59:32 +0000"  >&lt;p&gt;I had a look at the code to figure out why only that particular command is not working but no success this far, it would be very helpful if you could attach output of jstack of the server side taken in the situation when describe_ring hangs...&lt;/p&gt;</comment>
                            <comment id="13853054" author="nickmbailey" created="Thu, 19 Dec 2013 17:33:44 +0000"  >&lt;p&gt;Attached the output of jstack.&lt;/p&gt;</comment>
                            <comment id="13853254" author="xedin" created="Thu, 19 Dec 2013 20:18:39 +0000"  >&lt;p&gt;So from the thread stacks it looks like server side is just waiting for new packets from the client as both Acceptor and Selector threads are blocked on select() from the socket. Just to clarify, was this taken simultaneously with client being stuck waiting for describe_ring output?&lt;/p&gt;</comment>
                            <comment id="13853277" author="nickmbailey" created="Thu, 19 Dec 2013 20:36:56 +0000"  >&lt;p&gt;Yes, It should have been. Just to be sure I got another one which definitely is. They look about the same though.&lt;/p&gt;</comment>
                            <comment id="13853283" author="xedin" created="Thu, 19 Dec 2013 20:44:25 +0000"  >&lt;p&gt;Those looks the same, selector threads are waiting on the socket and all of the worker threads are waiting on the barrier for a new task... Server implementation could not distinguish between commands it&apos;s being sent so I don&apos;t see any reason why one would hang and another wouldn&apos;t, I think describe_ring itself should be a culprit in this case.&lt;/p&gt;</comment>
                            <comment id="13853297" author="nickmbailey" created="Thu, 19 Dec 2013 20:51:56 +0000"  >&lt;p&gt;Yeah, it&apos;s a very strange bug. Like I said it&apos;s definitely the commit where we changed the hsha server though. And it only happens on the first call to describe ring. For example if you change the patch I attached to do the following in the test function, the test passes fine after catching the first socket timeout.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    def test_describe_ring(self):
+       print &apos;running desc ring&apos;
+       try:
+            list(client.describe_ring(&apos;Keyspace1&apos;))[0].endpoints == [&apos;127.0.0.1&apos;]
+       except Exception, e:
+            print e
+        print &apos;running again&apos;
         assert list(client.describe_ring(&apos;Keyspace1&apos;))[0].endpoints == [&apos;127.0.0.1&apos;]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13853385" author="xedin" created="Thu, 19 Dec 2013 22:17:22 +0000"  >&lt;p&gt;Is the same happening with vnodes turned off? I just don&apos;t get why if you send any other command it works fine but if you send describe_ring it fails, it shouldn&apos;t be any different from the server perspective... Can you also try increasing min number of rpc threads from 2 to 4, wonder if it would make any difference.&lt;/p&gt;</comment>
                            <comment id="13853519" author="nickmbailey" created="Fri, 20 Dec 2013 00:37:29 +0000"  >&lt;p&gt;It doesn&apos;t happen with vnodes off. In fact it doesn&apos;t happen with vnodes set to 128. So that would seem to indicate it has to do with the size of the response as more vnodes will make the describe_ring response much larger.&lt;/p&gt;

&lt;p&gt;rpc_min_threads doesn&apos;t have any effect.&lt;/p&gt;</comment>
                            <comment id="13853557" author="xedin" created="Fri, 20 Dec 2013 01:10:21 +0000"  >&lt;p&gt;Does it have any ERROR messages in the server log starting with &quot;invalid frame size&quot;? I think default frame size should be set to 15 mb which is enough for most of the things, but please check just in case.&lt;/p&gt;</comment>
                            <comment id="13853566" author="nickmbailey" created="Fri, 20 Dec 2013 01:21:28 +0000"  >&lt;p&gt;Nope, no errors in the logs at all.&lt;/p&gt;</comment>
                            <comment id="13867273" author="xedin" created="Thu, 9 Jan 2014 23:24:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nickmbailey&quot; class=&quot;user-hover&quot; rel=&quot;nickmbailey&quot;&gt;nickmbailey&lt;/a&gt; I have attached updated disruptor server jar to the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6407&quot; title=&quot;CQL/Thrift request hangs forever when querying more than certain amount of data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6407&quot;&gt;&lt;del&gt;CASSANDRA-6407&lt;/del&gt;&lt;/a&gt;, can you please try your test with update jar?&lt;/p&gt;</comment>
                            <comment id="13867949" author="nickmbailey" created="Fri, 10 Jan 2014 16:23:21 +0000"  >&lt;p&gt;If I use the patch I attached previously I get the timeout as I described before. When I copy your updated jar over the existing jar I get a different error:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;automaton@ip-10-196-42-161:~/cassandra$ PYTHONPATH=test nosetests --tests=system.test_thrift_server:TestMutations.test_describe_ring
E
======================================================================
ERROR: system.test_thrift_server.TestMutations.test_describe_ring
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/usr/local/lib/python2.7/dist-packages/nose/case.py&quot;, line 381, in setUp
    try_run(self.inst, (&apos;setup&apos;, &apos;setUp&apos;))
  File &quot;/usr/local/lib/python2.7/dist-packages/nose/util.py&quot;, line 469, in try_run
    return func()
  File &quot;/home/automaton/cassandra/test/system/__init__.py&quot;, line 114, in setUp
    self.define_schema()
  File &quot;/home/automaton/cassandra/test/system/__init__.py&quot;, line 183, in define_schema
    self.client.system_add_keyspace(ks)
  File &quot;/home/automaton/cassandra/interface/thrift/gen-py/cassandra/Cassandra.py&quot;, line 1783, in system_add_keyspace
    return self.recv_system_add_keyspace()
  File &quot;/home/automaton/cassandra/interface/thrift/gen-py/cassandra/Cassandra.py&quot;, line 1794, in recv_system_add_keyspace
    (fname, mtype, rseqid) = self._iprot.readMessageBegin()
  File &quot;/usr/lib/python2.7/dist-packages/thrift/protocol/TBinaryProtocol.py&quot;, line 126, in readMessageBegin
    sz = self.readI32()
  File &quot;/usr/lib/python2.7/dist-packages/thrift/protocol/TBinaryProtocol.py&quot;, line 203, in readI32
    buff = self.trans.readAll(4)
  File &quot;/usr/lib/python2.7/dist-packages/thrift/transport/TTransport.py&quot;, line 58, in readAll
    chunk = self.read(sz-have)
  File &quot;/usr/lib/python2.7/dist-packages/thrift/transport/TTransport.py&quot;, line 272, in read
    self.readFrame()
  File &quot;/usr/lib/python2.7/dist-packages/thrift/transport/TTransport.py&quot;, line 276, in readFrame
    buff = self.__trans.readAll(4)
  File &quot;/usr/lib/python2.7/dist-packages/thrift/transport/TTransport.py&quot;, line 58, in readAll
    chunk = self.read(sz-have)
  File &quot;/usr/lib/python2.7/dist-packages/thrift/transport/TSocket.py&quot;, line 94, in read
    buff = self.handle.recv(sz)
error: [Errno 104] Connection reset by peer

----------------------------------------------------------------------
Ran 1 test in 8.528s

FAILED (errors=1)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13868129" author="xedin" created="Fri, 10 Jan 2014 18:56:09 +0000"  >&lt;p&gt;Did you replace old one or just copied it over, does system log say anything? I&apos;m going to try it myself today too.&lt;/p&gt;</comment>
                            <comment id="13868146" author="nickmbailey" created="Fri, 10 Jan 2014 19:08:46 +0000"  >&lt;p&gt;Actually I do see an error in the log:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [main] 2014-01-10 19:06:51,179 CassandraDaemon.java (line 478) Exception encountered during startup
java.lang.NoClassDefFoundError: com/lmax/disruptor/EventTranslator
        at com.thinkaurelius.thrift.TDisruptorServer.&amp;lt;init&amp;gt;(TDisruptorServer.java:192)
        at org.apache.cassandra.thrift.THsHaDisruptorServer.&amp;lt;init&amp;gt;(THsHaDisruptorServer.java:46)
        at org.apache.cassandra.thrift.THsHaDisruptorServer$Factory.buildTServer(THsHaDisruptorServer.java:90)
        at org.apache.cassandra.thrift.TServerCustomFactory.buildTServer(TServerCustomFactory.java:56)
        at org.apache.cassandra.thrift.ThriftServer$ThriftServerThread.&amp;lt;init&amp;gt;(ThriftServer.java:130)
        at org.apache.cassandra.thrift.ThriftServer.start(ThriftServer.java:56)
        at org.apache.cassandra.service.CassandraDaemon.start(CassandraDaemon.java:414)
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:474)
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:504)
Caused by: java.lang.ClassNotFoundException: com.lmax.disruptor.EventTranslator
        at java.net.URLClassLoader$1.run(URLClassLoader.java:366)
        at java.net.URLClassLoader$1.run(URLClassLoader.java:355)
        at java.security.AccessController.doPrivileged(Native Method)
        at java.net.URLClassLoader.findClass(URLClassLoader.java:354)
        at java.lang.ClassLoader.loadClass(ClassLoader.java:425)
        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:308)
        at java.lang.ClassLoader.loadClass(ClassLoader.java:358)
        ... 9 more
 INFO [StorageServiceShutdownHook] 2014-01-10 19:06:51,220 Gossiper.java (line 1238) Announcing shutdown
DEBUG [GossipTasks:1] 2014-01-10 19:06:51,722 DebuggableThreadPoolExecutor.java (line 245) Task cancelled
java.util.concurrent.CancellationException
        at java.util.concurrent.FutureTask.report(FutureTask.java:121)
        at java.util.concurrent.FutureTask.get(FutureTask.java:188)
        at org.apache.cassandra.concurrent.DebuggableThreadPoolExecutor.extractThrowable(DebuggableThreadPoolExecutor.java:237)
        at org.apache.cassandra.concurrent.DebuggableThreadPoolExecutor.logExceptionsAfterExecute(DebuggableThreadPoolExecutor.java:201)
        at org.apache.cassandra.concurrent.DebuggableScheduledThreadPoolExecutor.afterExecute(DebuggableScheduledThreadPoolExecutor.java:46)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1153)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.Thread.run(Thread.java:744)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I copied your new jar over the existing disruptor jar:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cp disruptor-thrift-server-0.3.3-SNAPSHOT.jar lib/disruptor-3.0.1.jar
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13868147" author="nickmbailey" created="Fri, 10 Jan 2014 19:11:08 +0000"  >&lt;p&gt;Perhaps I was supposed to just copy the jar into the lib folder and not replace the old jar? I just tried that and it looks like everything is fixed.&lt;/p&gt;</comment>
                            <comment id="13868241" author="xedin" created="Fri, 10 Jan 2014 20:14:14 +0000"  >&lt;p&gt;You have replaced the wrong jar &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; there are two of them - disruptor and disruptor_thrift_server, can you bring disruptor jar back and replace disruptor_thrift_server instead?&lt;/p&gt;</comment>
                            <comment id="13868328" author="nickmbailey" created="Fri, 10 Jan 2014 21:36:16 +0000"  >&lt;p&gt;Got it:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;mv disruptor-thrift-server-0.3.3-SNAPSHOT.jar lib/thrift-server-0.3.2.jar
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That appears to fix the issue.&lt;/p&gt;</comment>
                            <comment id="13868355" author="xedin" created="Fri, 10 Jan 2014 21:52:50 +0000"  >&lt;p&gt;Thanks! I will release disruptor_thrift_server and close both issues once build.xml is changed.&lt;/p&gt;</comment>
                            <comment id="13868584" author="xedin" created="Sat, 11 Jan 2014 01:29:13 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12614510" name="describe_ring_failure.patch" size="1754" author="nickmbailey" created="Mon, 18 Nov 2013 23:26:16 +0000"/>
                            <attachment id="12619604" name="jstack.txt" size="106762" author="nickmbailey" created="Thu, 19 Dec 2013 17:33:44 +0000"/>
                            <attachment id="12619654" name="jstack2.txt" size="106759" author="nickmbailey" created="Thu, 19 Dec 2013 20:36:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[xedin]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>359200</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 45 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1px8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>359499</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324629">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>