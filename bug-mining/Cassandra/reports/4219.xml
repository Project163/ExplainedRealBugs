<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:02:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11485] ArithmeticException in avgFunctionForDecimal</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11485</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I am running into issues when using avg in queries on decimal values.&lt;br/&gt;
It throws an ArithmeticException in org/apache/cassandra/cql3/functions/AggregateFcts.java (Line 184).&lt;/p&gt;

&lt;p&gt;So whenever an exact representation of the quotient is not possible it will throw that error and it never returns to the querying client.&lt;/p&gt;

&lt;p&gt;I am not so sure if this is intended behavior or a bug, but in my opinion if an exact representation of the value is not possible, it should automatically round the value.&lt;br/&gt;
Specifying a rounding mode when calling the divide function should solve the issue&lt;/p&gt;</description>
                <environment></environment>
        <key id="12955725">CASSANDRA-11485</key>
            <summary>ArithmeticException in avgFunctionForDecimal</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="snazy">Robert Stupp</assignee>
                                    <reporter username="nhaller">Nico Haller</reporter>
                        <labels>
                    </labels>
                <created>Mon, 4 Apr 2016 10:51:34 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:37 +0000</updated>
                            <resolved>Fri, 15 Apr 2016 18:34:40 +0000</resolved>
                                        <fixVersion>3.0.6</fixVersion>
                    <fixVersion>3.6</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15223949" author="snazy" created="Mon, 4 Apr 2016 11:01:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nhaller&quot; class=&quot;user-hover&quot; rel=&quot;nhaller&quot;&gt;nhaller&lt;/a&gt;, can you provide information on how to reproduce it and how the exception exactly looks like? Also, on which version this occurs.&lt;/p&gt;</comment>
                            <comment id="15224135" author="nhaller" created="Mon, 4 Apr 2016 13:40:39 +0000"  >&lt;p&gt;Hi Robert, I am able to reproduce this in 3.3&lt;/p&gt;

&lt;p&gt;Here would be an easy way to reproduce it (this throws the exception but it also returns the exception to the client. I am still looking for an easy way to reproduce the non-returning state):&lt;/p&gt;

&lt;p&gt;create table test (bucket int primary key, val decimal);&lt;br/&gt;
insert into test (bucket, val) values (1, 0.25);&lt;br/&gt;
insert into test (bucket, val) values (2, 0.25);&lt;br/&gt;
insert into test (bucket, val) values (3, 0.5);&lt;/p&gt;

&lt;p&gt;select avg(val) from test where bucket in (1, 2, 3);&lt;br/&gt;
=&amp;gt; ServerError: &amp;lt;ErrorMessage code=0000 &lt;span class=&quot;error&quot;&gt;&amp;#91;Server error&amp;#93;&lt;/span&gt; message=&quot;java.lang.ArithmeticException: Non-terminating decimal expansion; no exact representable decimal result.&quot;&amp;gt;&lt;/p&gt;</comment>
                            <comment id="15224172" author="nhaller" created="Mon, 4 Apr 2016 13:57:26 +0000"  >&lt;p&gt;Sorry, forgot the actual server log:&lt;/p&gt;

&lt;p&gt;java.lang.ArithmeticException: Non-terminating decimal expansion; no exact representable decimal result.&lt;br/&gt;
        at java.math.BigDecimal.divide(BigDecimal.java:1690) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_74&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.cql3.functions.AggregateFcts$3$1.compute(AggregateFcts.java:184) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.cql3.selection.AggregateFunctionSelector.getOutput(AggregateFunctionSelector.java:52) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.cql3.selection.Selection$SelectionWithProcessing$1.getOutputRow(Selection.java:556) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.cql3.selection.Selection$ResultSetBuilder.getOutputRow(Selection.java:369) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.cql3.selection.Selection$ResultSetBuilder.build(Selection.java:357) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.cql3.statements.SelectStatement.pageAggregateQuery(SelectStatement.java:379) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:330) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:214) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:76) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:206) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:237) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:222) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.transport.messages.QueryMessage.execute(QueryMessage.java:115) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:507) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:401) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) &lt;span class=&quot;error&quot;&gt;&amp;#91;netty-all-4.0.23.Final.jar:4.0.23.Final&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:333) &lt;span class=&quot;error&quot;&gt;&amp;#91;netty-all-4.0.23.Final.jar:4.0.23.Final&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at io.netty.channel.AbstractChannelHandlerContext.access$700(AbstractChannelHandlerContext.java:32) &lt;span class=&quot;error&quot;&gt;&amp;#91;netty-all-4.0.23.Final.jar:4.0.23.Final&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at io.netty.channel.AbstractChannelHandlerContext$8.run(AbstractChannelHandlerContext.java:324) &lt;span class=&quot;error&quot;&gt;&amp;#91;netty-all-4.0.23.Final.jar:4.0.23.Final&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_74&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.3.jar:3.3&amp;#93;&lt;/span&gt;&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:745) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_74&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="15241790" author="snazy" created="Thu, 14 Apr 2016 19:46:36 +0000"  >&lt;p&gt;1 divided by 3 - eh, yea.&lt;/p&gt;

&lt;p&gt;I&apos;ve changed the avg() for decimal to use RoundingMode.HALF_EVEN in the patch.&lt;/p&gt;

&lt;p&gt;Since we cannot pass a &quot;parameter&quot; to an aggregation (the API doesn&apos;t support that at the moment), the way to use another rounding mode would be to implement a UDA.&lt;/p&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;3.0&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...snazy:11485-avg-decimal-round-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/snazy/job/snazy-11485-avg-decimal-round-3.0-testall/lastBuild/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/snazy/job/snazy-11485-avg-decimal-round-3.0-dtest/lastBuild/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...snazy:11485-avg-decimal-round-trunk?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/snazy/job/snazy-11485-avg-decimal-round-trunk-testall/lastBuild/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/snazy/job/snazy-11485-avg-decimal-round-trunk-dtest/lastBuild/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15243233" author="thobbs" created="Fri, 15 Apr 2016 17:07:09 +0000"  >&lt;p&gt;+1, patch and tests look good&lt;/p&gt;</comment>
                            <comment id="15243384" author="snazy" created="Fri, 15 Apr 2016 18:34:40 +0000"  >&lt;p&gt;Thanks!&lt;br/&gt;
Committed as ce445991fab05d2ba404f6289796664dd581662a to 3.0 and merged to trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 31 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vl87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334609">3.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>