<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:27:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18739] UDF functions fail to load on rolling restart</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18739</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;UDFs fail to reload properly after a rolling restart.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Symptom%3A&quot;&gt;&lt;/a&gt;&lt;b&gt;Symptom:&lt;/b&gt;&lt;/h3&gt;

&lt;p&gt;NPE thrown when used after restart.&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;Stepstorecreate%3A&quot;&gt;&lt;/a&gt;&lt;b&gt;Steps to recreate:&lt;/b&gt;&lt;/h3&gt;
&lt;ol&gt;
	&lt;li&gt;Create a cluster as per cql file&lt;/li&gt;
	&lt;li&gt;Populate the cluster with data.cql.&lt;/li&gt;
	&lt;li&gt;Execute SELECT city_measurements(city, measurement, 16.5) AS m FROM current&lt;/li&gt;
	&lt;li&gt;expect min and max values for cities.&lt;/li&gt;
	&lt;li&gt;Performing a rolling restart on one server.&lt;/li&gt;
	&lt;li&gt;When the server is back up&lt;/li&gt;
	&lt;li&gt;Execute SELECT city_measurements(city, measurement, 16.5) AS m FROM current&lt;/li&gt;
	&lt;li&gt;expect: error result with NPE message.&lt;/li&gt;
&lt;/ol&gt;



&lt;p&gt;&lt;b&gt;Analysis&lt;/b&gt;:&lt;/p&gt;

&lt;p&gt;During system restart the SchemaKeyspace.fetchNonSystemKeyspaces() is called, when a keyspace with a UDF is loaded the SchemaKeyspace method createUDFFromRow() is called, this in turn calls UDFunction.create() which eventually calls back to UDFunction constructor where the Schema.instance.getKeyspaceMetadata() is called with the keyspace for the UDF name as the argument. However, the keyspace for the UDF name is being constructed and is not yet in the instance so the method returns null for the KeyspaceMetadata. That null KeyspaceMetadata is then used in the udfContext.&lt;/p&gt;

&lt;p&gt;Later when the UDF method is called, if there is a need to call a method on the keyspaceMetadata, such as udfContext.newUDTValue() where the implementation uses keyspaceMetadata.types, a null pointer is thrown.&lt;/p&gt;

&lt;p&gt;I have verified this affects version 4.0, 4.1 and trunk. I have not verified 3.x but I suspect it is the same there.&lt;/p&gt;

&lt;p&gt;I modified UDFunction constructor to assert that the metadata was not null and received the following stack trace&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; 2023-08-09 11:44:46,408 CassandraDaemon.java:911 - Exception encountered during startup&lt;br/&gt;
java.lang.AssertionError: No metadata for temperatures.city_measurements_sfunc&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.cql3.functions.UDFunction.&amp;lt;init&amp;gt;(UDFunction.java:240)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.cql3.functions.JavaBasedUDFunction.&amp;lt;init&amp;gt;(JavaBasedUDFunction.java:195)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.cql3.functions.UDFunction.create(UDFunction.java:276)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.schema.SchemaKeyspace.createUDFFromRow(SchemaKeyspace.java:1182)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.schema.SchemaKeyspace.fetchUDFs(SchemaKeyspace.java:1131)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.schema.SchemaKeyspace.fetchFunctions(SchemaKeyspace.java:1119)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.schema.SchemaKeyspace.fetchKeyspace(SchemaKeyspace.java:859)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.schema.SchemaKeyspace.fetchKeyspacesWithout(SchemaKeyspace.java:848)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.schema.SchemaKeyspace.fetchNonSystemKeyspaces(SchemaKeyspace.java:836)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.schema.Schema.loadFromDisk(Schema.java:132)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.schema.Schema.loadFromDisk(Schema.java:121)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:287)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:765)&lt;br/&gt;
&#160; &#160; at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:889)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;&lt;b&gt;Possible solution:&lt;/b&gt;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Version 4.x&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Create a KeyspaceMetadata.Builder class that uses accepts the types, tables and views but uses a builder for the functions.&lt;/p&gt;

&lt;p&gt;Add a KeyspaceMetadata constructor to accept the KeyspaceMetadata.Builder so that the function builder keyspaceMetadata value can be set correctly during construction of the KeyspaceMetadata.&lt;/p&gt;

&lt;p&gt;Modify SchemaKeyspace.fetchKeyspace(string) so that it uses the KeyspaceMetadata.Builder.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Version 5.x&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Similar to 4.x except that the KeyspaceMetadata.Builder will have to have builders for Views and Tables because the functions necessary to construct those objects will not be available until the KeyspaceMetadata.Builder constructs it.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13546772">CASSANDRA-18739</key>
            <summary>UDF functions fail to load on rolling restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10001" iconUrl="https://issues.apache.org/jira/images/icons/priorities/major.svg">High</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="claude">Claude Warren</assignee>
                                    <reporter username="claude">Claude Warren</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Aug 2023 06:49:41 +0000</created>
                <updated>Tue, 12 Sep 2023 13:02:52 +0000</updated>
                            <resolved>Mon, 21 Aug 2023 14:15:46 +0000</resolved>
                                        <fixVersion>3.11.17</fixVersion>
                    <fixVersion>4.0.12</fixVersion>
                    <fixVersion>4.1.4</fixVersion>
                    <fixVersion>5.0-alpha1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                    <component>Feature/UDF</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="9600">2h 40m</timespent>
                                <comments>
                            <comment id="17752667" author="smiklosovic" created="Thu, 10 Aug 2023 07:34:47 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=claude&quot; class=&quot;user-hover&quot; rel=&quot;claude&quot;&gt;claude&lt;/a&gt;, thanks for this!&lt;/p&gt;

&lt;p&gt;I looked into it and this might be a solution. I restarted a node and it just worked ... &lt;/p&gt;

&lt;p&gt;The approach I took is that we do not need KeyspaceMetadata (which is null) upon function&apos;s creation. That is not necessary. We just need that stuff in runtime when you do queries etc and by that time it is already initialized.&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/pull/2566/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2566/files&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17752669" author="smiklosovic" created="Thu, 10 Aug 2023 07:43:27 +0000"  >&lt;p&gt;I am not sure. Would you mind to check that? &lt;/p&gt;

&lt;p&gt;But, presumably, I think that should work too, we are just passing a name of a keyspace to UDFContextImpl and then udtType resolution is done upon querying a table / view and again, by that time, KeyspaceMetadata is there as schema is fully initialized.&lt;/p&gt;</comment>
                            <comment id="17752679" author="claudenw" created="Thu, 10 Aug 2023 07:58:57 +0000"  >&lt;p&gt;Dang.&#160; I accidentally deleted my earlier question.&lt;/p&gt;

&lt;p&gt;A quick visual review indicates that it probably will.&lt;/p&gt;</comment>
                            <comment id="17753229" author="claudenw" created="Fri, 11 Aug 2023 13:41:45 +0000"  >&lt;p&gt;Fixes and test code for v4.0 in &lt;a href=&quot;https://github.com/claudenw/cassandra/tree/CASSANDRA-18739_v4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/claudenw/cassandra/tree/CASSANDRA-18739_v4.0&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Fixes and test code for v4.1 in &lt;a href=&quot;https://github.com/claudenw/cassandra/tree/CASSANDRA-18739_v4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/claudenw/cassandra/tree/CASSANDRA-18739_v4.1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I will open pull requests next week.&lt;/p&gt;</comment>
                            <comment id="17754734" author="smiklosovic" created="Tue, 15 Aug 2023 18:27:56 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=claude&quot; class=&quot;user-hover&quot; rel=&quot;claude&quot;&gt;claude&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I looked at your 4.0 PR and I reworked it little bit (1).&lt;/p&gt;

&lt;p&gt;I see that you might have quite a hard time to get that assert right, I did it in such a way that we just nicely get that value instead of dealing with raw ByteBuffer.&lt;/p&gt;

&lt;p&gt;Do you think the work I did is something you may incorporate into your patch?&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/Claudenw/cassandra/pull/2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Claudenw/cassandra/pull/2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17754745" author="smiklosovic" created="Tue, 15 Aug 2023 19:33:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2599&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0 PR&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/pull/2598&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1 PR&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/pull/2597&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0 PR&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;trunk is same as 5.0&lt;/p&gt;</comment>
                            <comment id="17754746" author="smiklosovic" created="Tue, 15 Aug 2023 19:35:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; anybody willing to take a look? Quite simple ... &lt;/p&gt;</comment>
                            <comment id="17755520" author="claudenw" created="Thu, 17 Aug 2023 12:11:13 +0000"  >&lt;p&gt;Further analysis shows the issue is in non-system keyspaces, where there is a user defined type (UDT) and a UDF that may create the UDT using the udfContxt.newUTDValue() method.&#160; Alternatively calling as UDF calling udfContext().newTupleValue() method will also trigger the NPE.&#160;&#160;&lt;/p&gt;

&lt;p&gt;The issue is that the keyspace variable in udfContextImpl is set to null because the keyspace is being created when the value is set.&lt;/p&gt;

&lt;p&gt;There is no requirement for more than one server.&lt;/p&gt;</comment>
                            <comment id="17755554" author="smiklosovic" created="Thu, 17 Aug 2023 13:38:49 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=claude&quot; class=&quot;user-hover&quot; rel=&quot;claude&quot;&gt;claude&lt;/a&gt;, I incorporated your test simplification and other refactorings into 5.0 branch.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2584&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0 PR&lt;/a&gt; Claude&apos;s patch&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/pull/2585&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1 PR&lt;/a&gt; Claude&apos;s patch&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/pull/2597&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0 PR&lt;/a&gt; my patch same as Claude&apos;s&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; are you happy with this? I will approach the builds then.&lt;/p&gt;</comment>
                            <comment id="17755983" author="smiklosovic" created="Fri, 18 Aug 2023 13:57:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2947/workflows/fb635abb-33a5-4a21-96a5-412f1b7f66f1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17  5.0&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17756007" author="adelapena" created="Fri, 18 Aug 2023 14:57:17 +0000"  >&lt;p&gt;The new&#160;&lt;tt&gt;UDFTest&lt;/tt&gt; class in the PRs for 4.0 and 4.1 contains some bits that don&apos;t match the code style, and a couple of unused imports that would break CI: &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/43fbc2dd2a2e8ae8b603c4121ab0d75ef783229a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/adelapena/cassandra/commit/43fbc2dd2a2e8ae8b603c4121ab0d75ef783229a&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I see that those are fixed Stefan&apos;s PR for 5.0.&lt;/p&gt;

&lt;p&gt;We are also missing a PR for trunk.&lt;/p&gt;</comment>
                            <comment id="17756009" author="smiklosovic" created="Fri, 18 Aug 2023 15:00:36 +0000"  >&lt;p&gt;Yep I ll do that, I am aware of that. I ll add the builds in next days.&lt;/p&gt;</comment>
                            <comment id="17756447" author="smiklosovic" created="Sun, 20 Aug 2023 06:32:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2599&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0 PR&lt;/a&gt;  &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2970/workflows/b0abb461-40ed-4511-b522-40351046ced3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2970/workflows/f4c8311c-f3d6-4719-b4c7-35118e79d49c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2598&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1 PR&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2972/workflows/d9277b6f-fee0-43d8-8e5c-ada8c2e05f7d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2972/workflows/046f29c4-8de7-4cac-98b3-360beb1c9190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2597&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0 PR&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2973/workflows/6c1a7eb6-583a-4c51-8703-9555fb4e86ff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2973/workflows/1a3e8d51-102f-4252-b4c5-0be4ca05d979&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2611&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk PR&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2971/workflows/af006c12-5eb7-4e68-a161-baeb06fe1b4b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2971/workflows/584dadf0-4770-49bf-a0e5-9ef82b80ebe1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17756796" author="adelapena" created="Mon, 21 Aug 2023 10:24:35 +0000"  >&lt;p&gt;Regarding the CI results:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;testFailingMessage&lt;/tt&gt; in 4.0 is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18366&quot; title=&quot;Test failure: org.apache.cassandra.distributed.test.FailingRepairTest - testFailingMessage[VALIDATION_REQ/parallel/true]&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18366&quot;&gt;&lt;del&gt;CASSANDRA-18366&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;test_decommission&lt;/tt&gt; in 4.1 doesn&apos;t seem to have an associated ticket, but it appears on &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-4.0/621/testReport/dtest-novnode.transient_replication_ring_test/TestTransientReplicationRing/test_decommission_2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Butler for 4.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;testTimeout&lt;/tt&gt; in 4.1 and 5.0 is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18641&quot; title=&quot;Test failure: org.apache.cassandra.net.ConnectionTest.testTimeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18641&quot;&gt;CASSANDRA-18641&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;test_move_backwards_and_cleanup&lt;/tt&gt; in 5.0 is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18686&quot; title=&quot;Test failure: test_move_backwards_and_cleanup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18686&quot;&gt;&lt;del&gt;CASSANDRA-18686&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;ClearSnapshotTest&lt;/tt&gt; in 5.0 looks like an env issue&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;testLoadingIncompleteSSTable&lt;/tt&gt; in 5.0 is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18737&quot; title=&quot;Test failure: org.apache.cassandra.io.sstable.SSTableLoaderTest (testLoadingIncompleteSSTable-.jdk17)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18737&quot;&gt;&lt;del&gt;CASSANDRA-18737&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;test_multi_dc_replace_with_rf1&lt;/tt&gt; in 5.0 doesn&apos;t have an associated ticket nor seems to appear on Butler, can it be an env issue?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The bug seems to be in 3.11, and I guess it will be also in 3.0. Those branches are still supported until we release 5.0, so I think we should add the fix there too.&lt;/p&gt;

&lt;p&gt;Other than that, the patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="17756880" author="smiklosovic" created="Mon, 21 Aug 2023 12:38:10 +0000"  >&lt;p&gt;3.11 build &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2977/workflows/4b077cb3-fd1c-4606-9c9d-62508240c1a6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2977/workflows/4b077cb3-fd1c-4606-9c9d-62508240c1a6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;patch &lt;a href=&quot;https://github.com/apache/cassandra/pull/2615&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2615&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17756903" author="adelapena" created="Mon, 21 Aug 2023 13:08:46 +0000"  >&lt;p&gt;The patch for 3.11 looks good, and 3.0 doesn&apos;t seem to be affected. As for CI results:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;test_dead_sync_initiator&lt;/tt&gt; is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17702&quot; title=&quot;Fix flaky dtest - repair_tests.repair_test.TestRepair.test_dead_sync_initiator&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17702&quot;&gt;CASSANDRA-17702&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;test_multiple_concurrent_repairs&lt;/tt&gt; doesn&apos;t have a ticket but it is &lt;a href=&quot;https://butler.cassandra.apache.org/#/ci/upstream/workflow/Cassandra-3.11/failure/repair_tests.repair_test/TestRepair/test_multiple_concurrent_repairs&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;on Butler&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;test_readrepair&lt;/tt&gt; doesn&apos;t have a ticket but it is &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-3.11/484/testReport/dtest-novnode.consistency_test/TestConsistency/test_readrepair/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;on Butler&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;readWriteDuringBootstrapTest&lt;/tt&gt; is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17139&quot; title=&quot;readWriteDuringBootstrapTest - org.apache.cassandra.distributed.test.ring.BootstrapTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17139&quot;&gt;&lt;del&gt;CASSANDRA-17139&lt;/del&gt;&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;testReprepareMixedVersionWithoutReset&lt;/tt&gt; is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18021&quot; title=&quot;Flaky org.apache.cassandra.distributed.test.ReprepareTestOldBehaviour#testReprepareMixedVersionWithoutReset&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18021&quot;&gt;CASSANDRA-18021&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;test_compactionstats&lt;/tt&gt; might be a timeout?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So I guess the only not-known test failures are &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2973/workflows/6c1a7eb6-583a-4c51-8703-9555fb4e86ff/jobs/103830/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;test_multi_dc_replace_with_rf1&lt;/tt&gt;&lt;/a&gt; in 5.0 and maybe &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2977/workflows/4b077cb3-fd1c-4606-9c9d-62508240c1a6/jobs/104227/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;test_compactionstats&lt;/tt&gt;&lt;/a&gt; in 3.11. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; have you seen those before?&lt;/p&gt;</comment>
                            <comment id="17756920" author="smiklosovic" created="Mon, 21 Aug 2023 13:32:59 +0000"  >&lt;p&gt;I could not reproduce the first one locally. The second one, for 3.11, it fails locally but it fails even before this patch. For me it fails on the current 3.11 too. If there is not a ticket for neither of them I think we might create them.&lt;/p&gt;</comment>
                            <comment id="17756935" author="smiklosovic" created="Mon, 21 Aug 2023 13:45:08 +0000"  >&lt;p&gt;Actually that compactionstats test for 3.11 timeouted for me too, I was just using Java 11 instead of 8 when running tests so it failed straight away. When I use right Java version it just timeouts.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13062021" name="udf_error.cql" size="1333" author="claude" created="Thu, 10 Aug 2023 06:46:27 +0000"/>
                            <attachment id="13062020" name="udf_error_data.cql" size="8874" author="claude" created="Thu, 10 Aug 2023 06:46:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[claude]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12313826" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Change Category</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13005"><![CDATA[Operability]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12977"><![CDATA[Adhoc Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 12 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jp7c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335055">3.6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/998f84a2cbbdde137070911754d1589c1ba5e414&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/998f84a2cbbdde137070911754d1589c1ba5e414&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;CI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>