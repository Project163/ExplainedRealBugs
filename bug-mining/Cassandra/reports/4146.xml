<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:01:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11064] Failed aggregate creation breaks server permanently</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11064</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;While testing edge cases around aggregates, I tried the following to see if custom types were supported:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccm create v321 -v3.2.1 -n3
ccm updateconf enable_user_defined_functions:&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;
ccm start
ccm node1 cqlsh

CREATE FUNCTION id(i &lt;span class=&quot;code-quote&quot;&gt;&apos;DynamicCompositeType(s =&amp;gt; UTF8Type, i =&amp;gt; Int32Type)&apos;&lt;/span&gt;)
RETURNS NULL ON NULL INPUT
RETURNS &lt;span class=&quot;code-quote&quot;&gt;&apos;DynamicCompositeType(s =&amp;gt; UTF8Type, i =&amp;gt; Int32Type)&apos;&lt;/span&gt;
LANGUAGE java
AS &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; i;&apos;&lt;/span&gt;;
&lt;span class=&quot;code-comment&quot;&gt;// function created successfully
&lt;/span&gt;
CREATE AGGREGATE ag()
SFUNC id
STYPE &lt;span class=&quot;code-quote&quot;&gt;&apos;DynamicCompositeType(s =&amp;gt; UTF8Type, i =&amp;gt; Int32Type)&apos;&lt;/span&gt;
INITCOND &lt;span class=&quot;code-quote&quot;&gt;&apos;s@foo:i@32&apos;&lt;/span&gt;;

ServerError: &amp;lt;ErrorMessage code=0000 [Server error] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.RuntimeException: java.util.concurrent.ExecutionException: org.apache.cassandra.exceptions.SyntaxException: Failed parsing CQL term: [s@foo:i@32] reason: SyntaxException line 1:1 no viable alternative at character &lt;span class=&quot;code-quote&quot;&gt;&apos;@&apos;&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Despite the error, the aggregate appears in system tables:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;select * from system_schema.aggregates;
 keyspace_name | aggregate_name | ...
---------------+----------------+ ...
          test |             ag | ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But you can&apos;t drop it, and trying to drop its function produces the server error again:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DROP AGGREGATE ag;
InvalidRequest: code=2200 [Invalid query] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot drop non existing aggregate &lt;span class=&quot;code-quote&quot;&gt;&apos;test.ag&apos;&lt;/span&gt;&quot;&lt;/span&gt;

DROP FUNCTION id;
ServerError: &amp;lt;ErrorMessage code=0000 [Server error] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;java.lang.RuntimeException: java.util.concurrent.ExecutionException: org.apache.cassandra.exceptions.SyntaxException: Failed parsing CQL term: [s@foo:i@32] reason: SyntaxException line 1:1 no viable alternative at character &lt;span class=&quot;code-quote&quot;&gt;&apos;@&apos;&lt;/span&gt;&quot;&lt;/span&gt;&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What&apos;s worse, it&apos;s now impossible to restart the server:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccm stop; ccm start

org.apache.cassandra.exceptions.SyntaxException: Failed parsing CQL term: [s@foo:i@32] reason: SyntaxException line 1:1 no viable alternative at character &lt;span class=&quot;code-quote&quot;&gt;&apos;@&apos;&lt;/span&gt;
	at org.apache.cassandra.cql3.CQLFragmentParser.parseAny(CQLFragmentParser.java:48)
	at org.apache.cassandra.cql3.Terms.asBytes(Terms.java:51)
	at org.apache.cassandra.schema.SchemaKeyspace.createUDAFromRow(SchemaKeyspace.java:1225)
	at org.apache.cassandra.schema.SchemaKeyspace.fetchUDAs(SchemaKeyspace.java:1204)
	at org.apache.cassandra.schema.SchemaKeyspace.fetchFunctions(SchemaKeyspace.java:1129)
	at org.apache.cassandra.schema.SchemaKeyspace.fetchKeyspace(SchemaKeyspace.java:897)
	at org.apache.cassandra.schema.SchemaKeyspace.fetchKeyspacesWithout(SchemaKeyspace.java:872)
	at org.apache.cassandra.schema.SchemaKeyspace.fetchNonSystemKeyspaces(SchemaKeyspace.java:860)
	at org.apache.cassandra.config.Schema.loadFromDisk(Schema.java:125)
	at org.apache.cassandra.config.Schema.loadFromDisk(Schema.java:115)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:229)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:551)
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:680)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12933817">CASSANDRA-11064</key>
            <summary>Failed aggregate creation breaks server permanently</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="snazy">Robert Stupp</assignee>
                                    <reporter username="omichallat">Olivier Michallat</reporter>
                        <labels>
                    </labels>
                <created>Mon, 25 Jan 2016 14:05:11 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:44 +0000</updated>
                            <resolved>Thu, 25 Feb 2016 15:51:36 +0000</resolved>
                                        <fixVersion>3.0.4</fixVersion>
                    <fixVersion>3.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15115243" author="snazy" created="Mon, 25 Jan 2016 14:13:23 +0000"  >&lt;p&gt;Hm - usage of composite types is definitely untested. IMO we should prevent the use of custom-types in UDAs. WDYT?&lt;br/&gt;
Despite that, it&apos;s a bug that invalid &lt;tt&gt;initcond&lt;/tt&gt; values make it into the schema.&lt;/p&gt;</comment>
                            <comment id="15115283" author="slebresne" created="Mon, 25 Jan 2016 14:29:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;IMO we should prevent the use of custom-types in UDAs.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Why? What&apos;s the reasoning? I don&apos;t see a good reason why UDA would have to assume anything about types and hence see no reason to prevent their use. In fact, I&apos;d say that having them not working might hint at some reasonable assumption made by the implementation and we should fix the root cause. In this example in particular, I&apos;m not sure why the code is trying to parse within what is clearly a CQL string (note that I&apos;m not saying the example of the description &lt;em&gt;should&lt;/em&gt; work, I believe it shouldn&apos;t because strings are not valid literals for a custom type (you&apos;d have to pass a blob), only that the error itself seems suspicious).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;it&apos;s a bug that invalid initcond values make it into the schema&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, that&apos;s &lt;em&gt;the&lt;/em&gt; bug.&lt;/p&gt;</comment>
                            <comment id="15115291" author="snazy" created="Mon, 25 Jan 2016 14:36:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;What&apos;s the reasoning?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it&apos;s difficult to handle (Custom)CompositeTypes via the Java driver as you have to deal with byte buffers/arrays. I was also thinking of the idea to get rid of AbstractType at all - still supporting &quot;officially&quot; might prevent that (maybe I got that wrong).&lt;/p&gt;</comment>
                            <comment id="15115306" author="slebresne" created="Mon, 25 Jan 2016 14:44:04 +0000"  >&lt;p&gt;But we&apos;re talking of UDA here right? Custom types are not gonna anywhere anytime soon and there is no plan that I&apos;m aware of removing them (which doesn&apos;t mean we can change how they are defined, so we do have some flexibility regarding AbstractType). This goes for their usability: having to deal with blobs is not more difficult for UDA than for any other place in CQL.&lt;/p&gt;

&lt;p&gt;Don&apos;t get me wrong, I&apos;m not saying their support is the most important thing ever. But they are part of CQL and are supported anywhere else so excluding them from UDA now would be inconsistent. More importantly, it&apos;s not the problem here so let&apos;s focus on the true issue: that validation of &lt;tt&gt;INITCONT&lt;/tt&gt; is broken.&lt;/p&gt;</comment>
                            <comment id="15115337" author="snazy" created="Mon, 25 Jan 2016 15:03:52 +0000"  >&lt;p&gt;Got the bug. In CreateAggregateStatement, the initcond is validated by parsing the &quot;raw&quot; CQL value (in this case &lt;tt&gt;&apos;s@foo:i@32&apos;&lt;/tt&gt;). But during creation of the schema-migration-mutation (which should succeed, as it has passed the validation) we re-construct the CQL term from the binary representation, which simply calls &lt;tt&gt;AbstractType.getString&lt;/tt&gt; for all custom types - and this returns &lt;tt&gt;s@foo:i@32&lt;/tt&gt; (without the single quotes). Will check &amp;amp; fix that.&lt;/p&gt;</comment>
                            <comment id="15118930" author="snazy" created="Wed, 27 Jan 2016 09:36:09 +0000"  >&lt;p&gt;I&apos;ve got a fix ready for the C* side, but the Java driver seems to need some changes to parse (Dynamic)CompositeTypes. It requires a newer Java driver version (included as the first commit, which includes the necessary C* code changes required to include the Java driver 3.0.0 GA release - should be fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11001&quot; title=&quot;Hadoop integration is incompatible with Cassandra Driver 3.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11001&quot;&gt;&lt;del&gt;CASSANDRA-11001&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;The thing is, that (Dynamic)CompositeTypes are represented as strings (not as blobs) in CQL - so the syntax in the description of this ticket is correct. But the driver expects these types to be represented using bytes/blob syntax. It can be reproduced by running the unit test &lt;tt&gt;AggregationTest.testInvalidInitcond()&lt;/tt&gt; from the linked git branch, which logs an exception during metadata refresh - but that&apos;s not an issue for the C* production code - and I think that should not block the driver GA release.&lt;br/&gt;
See &lt;a href=&quot;https://datastax-oss.atlassian.net/browse/JAVA-1046&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JAVA-1046&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15123599" author="slebresne" created="Fri, 29 Jan 2016 15:32:39 +0000"  >&lt;p&gt;I forgot that we do the parsing of custom type literals with &lt;tt&gt;fromString()&lt;/tt&gt; but in hindsight, I think it&apos;s a weakness that custom type values can&apos;t be provided as blob literals so that said value can be understood without knowing the type itself. So I think we should add that: we should support blobs for custom types.&lt;/p&gt;

&lt;p&gt;If we do so, we can use that form when we create our &lt;tt&gt;INITCOND&lt;/tt&gt; term, which will avoid some pain for drivers. It&apos;s also theoretically more efficient than going through strings (that depends a bit on the custom type of course, but for DynamicCompositeType for instance, the string representation is pretty inefficient).&lt;/p&gt;

&lt;p&gt;If we do that, I don&apos;t think we&apos;ll depend on any update of the java driver here (not that upgrading the driver is a bad thing per-se).&lt;/p&gt;</comment>
                            <comment id="15130606" author="snazy" created="Wed, 3 Feb 2016 16:02:10 +0000"  >&lt;p&gt;Yup - allowing &apos;blob syntax&apos; makes sense.&lt;br/&gt;
The change to allow &apos;blob syntax&apos; parsing is in &lt;tt&gt;AbstractCompositeType&lt;/tt&gt; (in addition to &apos;composite syntax&apos;). The &apos;blob&apos; code path validates the provided bytes array.&lt;br/&gt;
The change to produce &apos;blob syntax&apos; CQL literals is in &lt;tt&gt;CQL3Type.Custom.toCQLLiteral&lt;/tt&gt;, which now only produces &apos;blob syntax&apos; literals.&lt;/p&gt;

&lt;p&gt;This patch doesn&apos;t require a change to the Java driver - but having the 3.0.0-GA version would eliminate the ugly stack traces in the unit test. The code changes for 3.0.0-GA Java driver are in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11001&quot; title=&quot;Hadoop integration is incompatible with Cassandra Driver 3.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11001&quot;&gt;&lt;del&gt;CASSANDRA-11001&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Shall we target 2.2 (where UDAs are experimental) or 3.0.x for this ticket?&lt;/p&gt;</comment>
                            <comment id="15132518" author="slebresne" created="Thu, 4 Feb 2016 16:17:08 +0000"  >&lt;p&gt;We don&apos;t want to just change &lt;tt&gt;AbstractCompositeType&lt;/tt&gt;, we want to change it for all custom types since any custom type can have this problem. I&apos;ve pushed a modified commit to do that but also does the following changes compared to Robert&apos;s commit:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;not sure why the added call to &lt;tt&gt;ByteBuffer.duplicate&lt;/tt&gt; in &lt;tt&gt;CQL3Type.asCQLLiteral&lt;/tt&gt;. At least it&apos;s not immediatly clear to me what in the patch required it.&lt;/li&gt;
	&lt;li&gt;I slightly modified the changes to &lt;tt&gt;CreateAggregateStatement&lt;/tt&gt;: if converting back and forth the initcond fails, that&apos;s really a bug in the code so I made it an assert. But I did add a prior call to &lt;tt&gt;AbstractType.validate&lt;/tt&gt; because that&apos;s what we should use for validation.&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/11064-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt; &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11064-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11064-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; &lt;/th&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;blockquote&gt;&lt;p&gt;having the 3.0.0-GA version would eliminate the ugly stack traces in the unit test&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;True, didn&apos;t realized the current driver was crapping on itself even when using a blob. Anyway, didn&apos;t meant we shouldn&apos;t upgrade, but let&apos;s just do that in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11001&quot; title=&quot;Hadoop integration is incompatible with Cassandra Driver 3.0.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11001&quot;&gt;&lt;del&gt;CASSANDRA-11001&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Shall we target 2.2&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Could be wrong, but I don&apos;t think we have a problem in 2.2 since we keep the &lt;tt&gt;INITCOND&lt;/tt&gt; as a blob in the schema.&lt;/p&gt;</comment>
                            <comment id="15132779" author="snazy" created="Thu, 4 Feb 2016 18:55:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;not sure why the added call to ByteBuffer.duplicate in CQL3Type.asCQLLiteral&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Otherwise the &lt;tt&gt;initcond&lt;/tt&gt; BB would have been &quot;consumed&quot; (so effectively empty - that&apos;s why the utests fail). Added the &lt;tt&gt;duplicate()&lt;/tt&gt; call to &lt;tt&gt;asCQLLiteral&lt;/tt&gt; for safety reasons.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;slightly modified the changes to CreateAggregateStatement&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;LGTM&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;target 2.2&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right - 2.2 isn&apos;t affected as such (breaking the schema). It just wouldn&apos;t accept &quot;blob syntax&quot; for composites - but that&apos;s fine IMO.&lt;/p&gt;

&lt;p&gt;So +1 on your changes with that &lt;tt&gt;.duplicate()&lt;/tt&gt; call (pending CI).&lt;/p&gt;</comment>
                            <comment id="15134351" author="slebresne" created="Fri, 5 Feb 2016 15:46:09 +0000"  >&lt;p&gt;I did push the previous patch too quickly and there was actually 3 reasons why the unit tests weren&apos;t passing:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;I had mis-handled &lt;tt&gt;null&lt;/tt&gt; in the assertion of &lt;tt&gt;CreateAggregateStatement&lt;/tt&gt; so I&apos;ve switch to &lt;tt&gt;Objects.equals&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;asCQLLiteral&lt;/tt&gt; was indeed destructive of it&apos;s input which we clearly want to avoid. That said, I think the &lt;tt&gt;duplicate()&lt;/tt&gt; should be pushed where the destruction is (in the Collection, UDT and Tuple cases) so that 1) &lt;tt&gt;toCQLLitera&lt;/tt&gt;, which is public after all, is also non-destructive, 2) it&apos;s immediatly clear why duplication is needed and 3) we save duplication in the common case of simple types which don&apos;t require it (not that performance matters too much here...)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;Terms.asByte(type.asCQLLiteral&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/error.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/tt&gt; was not equal to &lt;tt&gt;x&lt;/tt&gt; for &lt;tt&gt;x == null&lt;/tt&gt; and &lt;tt&gt;type&lt;/tt&gt; being a collection type because &lt;tt&gt;toCQLLiteral&lt;/tt&gt; for collections was converting &lt;tt&gt;null&lt;/tt&gt; to an empty collection. I&apos;m not sure what was the rational behind this but it&apos;s a problem and it&apos;s not immediately clear to me why we would want that in the first place. There was btw a bug in &lt;tt&gt;CQL3TypeLiteralTest.testCollectionNullAndEmpty&lt;/tt&gt; which was using an empty &lt;tt&gt;ByteBuffer&lt;/tt&gt; as an empty collection value but that&apos;s incorrect: an empty collection is a collection with size 0, and an empty &lt;tt&gt;ByteBuffer&lt;/tt&gt; is actually invalid for a collection.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I fixed those on my branch above and restarted CI (hopefully it&apos;s clear now). I did push another commit that is more of a nit, but I wasn&apos;t fan of using &lt;tt&gt;StringBuilder&lt;/tt&gt; all over the place in &lt;tt&gt;toCQLLiteral&lt;/tt&gt; so the commit push the use of them only for more complex literals (collections, UDT and tuples), which imo is slightly cleaner code wise. It could be argued that it&apos;s a little bit less efficient for nested complex values since we&apos;ll end up creating more &lt;tt&gt;StringBuilder&lt;/tt&gt; instances, but none of this is terribly performance sensistive (and very complex value proobably not all that common in &lt;tt&gt;INITCOND&lt;/tt&gt;) so I prefer sticking to cleaner code until we can prove we need to optimize. Anyway, if that change is contentious, I&apos;m not gonna insist on it.&lt;/p&gt;</comment>
                            <comment id="15134504" author="snazy" created="Fri, 5 Feb 2016 17:20:17 +0000"  >&lt;p&gt;From a brief look the changes LGTM.&lt;/p&gt;

&lt;p&gt;But I&apos;m still unsure about the handling of empty collections and I think there was a &lt;em&gt;weak&lt;/em&gt; reason why that handling is that weird. AFAIR there were (are?) situations where we can actually get empty BBs for collections (BBs of size 0) - same reason why the test actually had the empty BB. Let me dig a bit for the reason - maybe it was a pathological reason, maybe not.&lt;/p&gt;

&lt;p&gt;Regarding the 2nd (cleanup) commit: I&apos;m fine with that.&lt;/p&gt;</comment>
                            <comment id="15134514" author="slebresne" created="Fri, 5 Feb 2016 17:25:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;AFAIR there were (are?) situations where we can actually get empty BBs for collections (BBs of size 0)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Please do dig to see if you find it again, but the &lt;tt&gt;validate()&lt;/tt&gt; method for collection types will clearly always throw on an empty BB, so if there is places where we let one slide, it&apos;s a lack of validation (a bug) we should fix.&lt;/p&gt;</comment>
                            <comment id="15144550" author="slebresne" created="Fri, 12 Feb 2016 13:02:18 +0000"  >&lt;p&gt;ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt;: did the potential reason for the handling of empty collections came back to you? It would be nice to get this resolved and as said above, I&apos;m decently confident that empty BBs for collections should be invalid (since they don&apos;t &lt;tt&gt;validate()&lt;/tt&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;). &lt;/p&gt;</comment>
                            <comment id="15153018" author="snazy" created="Thu, 18 Feb 2016 20:22:09 +0000"  >&lt;p&gt;It was probably because it&apos;s difficult to tell whether a non-frozen collection is actually &lt;em&gt;empty&lt;/em&gt; or really &lt;tt&gt;null&lt;/tt&gt;. It&apos;s easy to tell for frozen collections (as these have an &quot;explicit null&quot;). I guess, a non-frozen collection without any cells is actually empty (and not null).&lt;/p&gt;</comment>
                            <comment id="15153022" author="snazy" created="Thu, 18 Feb 2016 20:25:13 +0000"  >&lt;p&gt;(Recalled, that I&apos;ve opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10849&quot; title=&quot;Decide how to handle with null multi-cell collections&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10849&quot;&gt;&lt;del&gt;CASSANDRA-10849&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="15154223" author="slebresne" created="Fri, 19 Feb 2016 13:46:44 +0000"  >&lt;blockquote&gt;&lt;p&gt;it&apos;s difficult to tell whether a non-frozen collection is actually empty or really &lt;tt&gt;null&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Internally, there is no difference between the two (so &lt;tt&gt;empty == null&lt;/tt&gt; for non-frozen collections), and that&apos;s not new. But here we&apos;re dealing with the convertion between CQL literals and their native protocol representation (which is what the &lt;tt&gt;Terms.asByte()&lt;/tt&gt; and &lt;tt&gt;CQL3Type.asCQLLiteral()&lt;/tt&gt; converts to/from), and both cases differenciate btween empty and &lt;tt&gt;null&lt;/tt&gt;, so I really don&apos;t see why we wouldn&apos;t want those methods to preserve the most precise representation (again, it&apos;s not wrong to do so even for non-frozen collections).&lt;/p&gt;</comment>
                            <comment id="15155569" author="snazy" created="Sat, 20 Feb 2016 11:15:39 +0000"  >&lt;p&gt;Fair enough. My intention was more in the direction how an empty non-frozen collection looks like for an aggregate&apos;s initcond. But yea, that might make it&apos;s behavior inconsistent - so I&apos;m fine with handling empty non-frozen ones as null.&lt;/p&gt;

&lt;p&gt;I think we agreed on the remaining stuff, so I took your branch, rebased it and triggered CI for both 3.0 and trunk.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...snazy:11064-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/search/?q=snazy-11064-3.0-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/search/?q=snazy-11064-3.0-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...snazy:11064-trunk?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/search/?q=snazy-11064-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/search/?q=snazy-11064-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15156689" author="slebresne" created="Mon, 22 Feb 2016 09:44:28 +0000"  >&lt;p&gt;It seems the dtests on trunk haven&apos;t run, and there is a few failures on 3.0 that are almost surely not due to this patch but it might be worth re-running the test to hopefully get a cleaner run. Other than that, feel free to commit.&lt;/p&gt;</comment>
                            <comment id="15167338" author="snazy" created="Thu, 25 Feb 2016 15:51:36 +0000"  >&lt;p&gt;Tests look good now.&lt;/p&gt;

&lt;p&gt;Thanks!&lt;br/&gt;
Committed as c6ed2e0bb30b9e96764858b93bd2021d195be510 to 3.0 and merged to trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12921348">CASSANDRA-10849</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 38 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2rxbz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333260">3.2</customfieldvalue>
    <customfieldvalue id="12334660">3.2.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>