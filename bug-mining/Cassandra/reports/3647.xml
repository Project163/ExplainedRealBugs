<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:55:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8413] Bloom filter false positive ratio is not honoured</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8413</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Whilst thinking about &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7438&quot; title=&quot;Serializing Row cache alternative (Fully off heap)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7438&quot;&gt;&lt;del&gt;CASSANDRA-7438&lt;/del&gt;&lt;/a&gt; and hash bits, I realised we have a problem with sabotaging our bloom filters when using the murmur3 partitioner. I have performed a very quick test to confirm this risk is real.&lt;/p&gt;

&lt;p&gt;Since a typical cluster uses the same murmur3 hash for partitioning as we do for bloom filter lookups, and we own a contiguous range, we can guarantee that the top X bits collide for all keys on the node. This translates into poor bloom filter distribution. I quickly hacked LongBloomFilterTest to simulate the problem, and the result in these tests is &lt;em&gt;up to&lt;/em&gt; a doubling of the actual false positive ratio. The actual change will depend on the key distribution, the number of keys, the false positive ratio, the number of nodes, the token distribution, etc. But seems to be a real problem for non-vnode clusters of at least ~128 nodes in size.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12759151">CASSANDRA-8413</key>
            <summary>Bloom filter false positive ratio is not honoured</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="snazy">Robert Stupp</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Dec 2014 11:44:51 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:26 +0000</updated>
                            <resolved>Sun, 5 Jul 2015 15:16:52 +0000</resolved>
                                        <fixVersion>3.0 alpha 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14351543" author="benedict" created="Sat, 7 Mar 2015 12:24:41 +0000"  >&lt;p&gt;It occurs to me that this may be more significant still for LCS, since we explicitly narrow the space over which we operate. Obviously it&apos;s a bounded problem for LCS, but still.... I think we should simply regularize the bits over the known min/max of the sstable we&apos;re writing.&lt;/p&gt;</comment>
                            <comment id="14361944" author="snazy" created="Sat, 14 Mar 2015 18:15:42 +0000"  >&lt;p&gt;(attached Benedict&apos;s hack against current trunk)&lt;/p&gt;</comment>
                            <comment id="14361948" author="snazy" created="Sat, 14 Mar 2015 18:19:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; I&apos;ve &quot;rebased&quot; your hack against current trunk. When I execute &lt;tt&gt;org.apache.cassandra.utils.LongBloomFilterTest#main&lt;/tt&gt;, I constantly get messages like&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR 18:14:07 LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@73febe86) to class org.apache.cassandra.utils.concurrent.WrappedSharedCloseable$1@773173674:[org.apache.cassandra.utils.obs.OpenBitSet@aa6f65cf] was not released before the reference was garbage collected
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14361955" author="snazy" created="Sat, 14 Mar 2015 18:32:43 +0000"  >&lt;p&gt;But for a cheap solution: wouldn&apos;t it be sufficient to just swap the two {{long}}s for bloom filtering?&lt;br/&gt;
Sure, there are other problems to solve with persisted bloom filters for a complete solution.&lt;/p&gt;

&lt;p&gt;Do we really want to target 2.1 for this?&lt;/p&gt;</comment>
                            <comment id="14362378" author="benedict" created="Sun, 15 Mar 2015 13:17:32 +0000"  >&lt;p&gt;This was filed prior to 2.1 being released. I agree that it&apos;s probably better to target 3.0 now. I&apos;ve pushed a minor update &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/8413-bffp&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; so that the modelling of false positives can account both for random distribution over the fixed bits and model flipping the inputs to the bloom filter. This latter should logically be sufficient, and pans out to be so in limited testing. We could also multiply by a fixed constant (say a large prime) as further protection, but this isn&apos;t essential.&lt;/p&gt;</comment>
                            <comment id="14487735" author="snazy" created="Thu, 9 Apr 2015 17:42:27 +0000"  >&lt;p&gt;Attached &lt;tt&gt;8413-patch.txt&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It simply swaps the two &lt;tt&gt;long&lt;/tt&gt; used for &lt;tt&gt;IFilter.add&lt;/tt&gt; and &lt;tt&gt;IFilter.isPresent&lt;/tt&gt;. For old sstables (before 3.0 / version &lt;tt&gt;la&lt;/tt&gt;) the &lt;tt&gt;long&lt;/tt&gt; are not swapped.&lt;/p&gt;

&lt;p&gt;Also added/changed a lot of unit tests.&lt;/p&gt;

&lt;p&gt;Had to ignore one of the existing tests that looks a bit useless.&lt;/p&gt;</comment>
                            <comment id="14487740" author="snazy" created="Thu, 9 Apr 2015 17:43:39 +0000"  >&lt;p&gt;Wanna review, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14599498" author="benedict" created="Wed, 24 Jun 2015 14:37:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt;: sorry for the embarassingly slow review. I think I conflated this with your other bf ticket which requires a bit more thought (on my part).&lt;/p&gt;

&lt;p&gt;I think I would prefer if we settle on the &lt;em&gt;old&lt;/em&gt; way being &quot;inverted&quot; - perhaps even just called &quot;hasOldBfHashOrder&quot;, and we just swap the &lt;tt&gt;indexes&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;&lt;/tt&gt; and &lt;tt&gt;indexes&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;/tt&gt; positions in &lt;tt&gt;getHashBuckets&lt;/tt&gt; - and then flip them iff we have the old layout. It&apos;s a small thing, but I think it is clearer if the expired way of doing things is considered the exceptional and extra work case.&lt;/p&gt;

&lt;p&gt;Otherwise, can we rebase and get cassci vetting? The versioning conditions may need revisiting also.&lt;/p&gt;</comment>
                            <comment id="14599653" author="snazy" created="Wed, 24 Jun 2015 16:15:39 +0000"  >&lt;p&gt;No worries.&lt;/p&gt;

&lt;p&gt;Yes, &lt;em&gt;hasOldBfHashOrder&lt;/em&gt; sounds better so I&apos;ve reversed the meaning of the boolean field during rebase. The branch, which is considered WIP, still has a &lt;em&gt;BloomFilterTest.testBigBloomFilterFpc&lt;/em&gt; methods that compares conventional BF, new BF and guava&apos;s BF implementations WRT FPR.&lt;br/&gt;
Cassci&apos;s currently vetting.&lt;/p&gt;</comment>
                            <comment id="14614257" author="benedict" created="Sun, 5 Jul 2015 13:56:53 +0000"  >&lt;p&gt;LGTM, especially like that you&apos;ve gone to the effort of testing serialization across versions in unit tests. &lt;/p&gt;

&lt;p&gt;Let&apos;s ship it once we get CI approval.&lt;/p&gt;</comment>
                            <comment id="14614284" author="snazy" created="Sun, 5 Jul 2015 15:16:23 +0000"  >&lt;p&gt;Thanks.&lt;br/&gt;
Committed as 23fd75f27c40462636f09920719b5dcbef5b8f36 with a few sentences in NEWS.txt regarding the new SSTable file version.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12724273" name="8413-patch.txt" size="56663" author="snazy" created="Thu, 9 Apr 2015 17:42:27 +0000"/>
                            <attachment id="12704612" name="8413.hack-3.0.txt" size="5833" author="snazy" created="Sat, 14 Mar 2015 18:15:42 +0000"/>
                            <attachment id="12684883" name="8413.hack.txt" size="11529" author="benedict" created="Wed, 3 Dec 2014 12:33:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 20 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i230cv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>