<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6571] Quickly restarted nodes can list others as down indefinitely</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6571</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In a healthy cluster, if a node is restarted quickly, it may list other nodes as down when it comes back up and never list them as up.  I reproduced it on a small cluster running in Docker containers.&lt;/p&gt;

&lt;p&gt;1. Have a healthy 5 node cluster:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;$ nodetool status&lt;br/&gt;
Datacenter: datacenter1&lt;br/&gt;
=======================&lt;br/&gt;
Status=Up/Down&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;/ State=Normal/Leaving/Joining/Moving&lt;br/&gt;
&amp;#8211;  Address          Load       Tokens  Owns (effective)  Host ID                               Rack&lt;br/&gt;
UN  192.168.100.1    40.88 KB   256     38.3%             92930ef6-1b29-49f0-a8cd-f962b55dca1b  rack1&lt;br/&gt;
UN  192.168.100.254  80.63 KB   256     39.6%             ef15a717-9d60-48fb-80a9-e0973abdd55e  rack1&lt;br/&gt;
UN  192.168.100.3    87.78 KB   256     40.8%             4e6765db-97ed-4429-a9f4-8e29de247f18  rack1&lt;br/&gt;
UN  192.168.100.2    75.22 KB   256     40.6%             e89bc581-5345-4abd-88ba-7018371940fc  rack1&lt;br/&gt;
UN  192.168.100.4    80.83 KB   256     40.8%             466a9798-d484-44f0-aae8-bb2b78d80331  rack1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/blockquote&gt;

&lt;p&gt;2. Kill a node and restart it quickly:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;kill -9 &amp;lt;pid&amp;gt; &amp;amp;&amp;amp; start-cassandra&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;3. Wait for the node to come back and more often than not, it lists one or more other nodes as down indefinitely:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;$ nodetool status&lt;br/&gt;
Datacenter: datacenter1&lt;br/&gt;
=======================&lt;br/&gt;
Status=Up/Down&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;/ State=Normal/Leaving/Joining/Moving&lt;br/&gt;
&amp;#8211;  Address          Load       Tokens  Owns (effective)  Host ID                               Rack&lt;br/&gt;
UN  192.168.100.1    40.88 KB   256     38.3%             92930ef6-1b29-49f0-a8cd-f962b55dca1b  rack1&lt;br/&gt;
UN  192.168.100.254  80.63 KB   256     39.6%             ef15a717-9d60-48fb-80a9-e0973abdd55e  rack1&lt;br/&gt;
DN  192.168.100.3    87.78 KB   256     40.8%             4e6765db-97ed-4429-a9f4-8e29de247f18  rack1&lt;br/&gt;
DN  192.168.100.2    75.22 KB   256     40.6%             e89bc581-5345-4abd-88ba-7018371940fc  rack1&lt;br/&gt;
DN  192.168.100.4    80.83 KB   256     40.8%             466a9798-d484-44f0-aae8-bb2b78d80331  rack1&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/blockquote&gt;

&lt;p&gt;From trace logging, here&apos;s what I think is going on:&lt;/p&gt;

&lt;p&gt;1. The nodes are all happy gossiping&lt;br/&gt;
2. Restart node X. When it comes back up it starts gossiping with the other nodes.&lt;br/&gt;
3. Before node X marks node Y as alive, X sends an echo message (introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3533&quot; title=&quot;TimeoutException when there is a firewall issue.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3533&quot;&gt;&lt;del&gt;CASSANDRA-3533&lt;/del&gt;&lt;/a&gt;)&lt;br/&gt;
4. The echo message is received by Y. To reply, Y attempts to reuse a connection to X. The connection is dead, but the message is attempted anyway but fails.&lt;br/&gt;
5. X never receives the echo back, so Y isn&apos;t marked as alive.&lt;br/&gt;
6. X gossips to Y again, but because the endpoint isAlive() returns true, it never calls markAlive() to properly set Y as alive.&lt;/p&gt;

&lt;p&gt;I tried to fix this by defaulting isAlive=false in the constructor of EndpointState. This made it less likely to mark a node as down but it still happens.&lt;/p&gt;

&lt;p&gt;The workaround is to leave a node down for a while so the connections die on the remaining nodes.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12688344">CASSANDRA-6571</key>
            <summary>Quickly restarted nodes can list others as down indefinitely</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="kohlisankalp">Sankalp Kohli</assignee>
                                    <reporter username="rlow">Richard Low</reporter>
                        <labels>
                            <label>gossip</label>
                    </labels>
                <created>Fri, 10 Jan 2014 22:18:59 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:56 +0000</updated>
                            <resolved>Mon, 13 Jan 2014 15:17:49 +0000</resolved>
                                        <fixVersion>2.0.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13868415" author="brandon.williams" created="Fri, 10 Jan 2014 22:35:17 +0000"  >&lt;p&gt;Worth noting we recently had another problem with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3533&quot; title=&quot;TimeoutException when there is a firewall issue.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3533&quot;&gt;&lt;del&gt;CASSANDRA-3533&lt;/del&gt;&lt;/a&gt; in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6554&quot; title=&quot;During upgrade from 1.2 -&amp;gt; 2.0, upgraded node sees other nodes as Down&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6554&quot;&gt;&lt;del&gt;CASSANDRA-6554&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13868502" author="kohlisankalp" created="Sat, 11 Jan 2014 00:08:55 +0000"  >&lt;p&gt;The problem is that we are adding the endpoint state of the newly discovered endpoint to endpointStateMap in handleMajorStateChange method. This endpoint state has isAlive=true because the endpoint is alive. &lt;br/&gt;
So if echo fails, realMarkAlive(new refactored method in trunk) method will never run.&lt;/p&gt;

&lt;p&gt;The fix is to make the isAlive=false before sending the echo message. The reason we should do it is because now we rely on echo message to mark anything alive. So it should be marked false even if we hear about it being alive from another node. &lt;/p&gt;

&lt;p&gt;Fix in code.&lt;br/&gt;
private void markAlive(final InetAddress addr, final EndpointState localState)&lt;br/&gt;
    {&lt;br/&gt;
        if (MessagingService.instance().getVersion(addr) &amp;lt; MessagingService.VERSION_20)&lt;/p&gt;
        {
            realMarkAlive(addr, localState);
            return;
        }
&lt;p&gt;        +  localState.markDead();&lt;br/&gt;
        MessageOut&amp;lt;EchoMessage&amp;gt; echoMessage = new MessageOut&amp;lt;EchoMessage&amp;gt;(MessagingService.Verb.ECHO, new EchoMessage(),   EchoMessage.serializer);&lt;br/&gt;
        logger.trace(&quot;Sending a EchoMessage to {}&quot;, addr);&lt;br/&gt;
        IAsyncCallback echoHandler = new IAsyncCallback()&lt;/p&gt;</comment>
                            <comment id="13868685" author="vijay2win@yahoo.com" created="Sat, 11 Jan 2014 06:44:57 +0000"  >&lt;p&gt;Not sure if this will fix it, because the remote machine has not responded back (echo message response). &lt;br/&gt;
1) I think we need to always mark the nodes as dead and mark it up only after we received the echo response&lt;br/&gt;
2) I think we need to check or reset the socket in the receiving side, may be need to markDead (or retry the message after x seconds?)&lt;/p&gt;

&lt;p&gt;May be because we removed the hibernate during restarts, this issue shows up? (we are not resetting the states) &amp;lt;== &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;&lt;br/&gt;
I think the hang on the echo response (socket.write())&lt;/p&gt;</comment>
                            <comment id="13868829" author="brandon.williams" created="Sat, 11 Jan 2014 16:21:53 +0000"  >&lt;p&gt;Isn&apos;t 1) what Sankalp is proposing?  I&apos;m not sure what you mean about hibernating on restarts.&lt;/p&gt;</comment>
                            <comment id="13868842" author="brandon.williams" created="Sat, 11 Jan 2014 18:17:58 +0000"  >&lt;p&gt;Patchifying Sankalp&apos;s idea for easy testing.&lt;/p&gt;</comment>
                            <comment id="13868848" author="vijay2win@yahoo.com" created="Sat, 11 Jan 2014 18:51:24 +0000"  >&lt;p&gt;We had this discussion in IRC, we need to test this before...&lt;/p&gt;

&lt;p&gt;To clarify, &lt;br/&gt;
(1) is same as in the description &lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;I tried to fix this by defaulting isAlive=false in the constructor of EndpointState.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;(2) we need to recover the receiving node from the hang state (while writing to the socket), by restarting the connections...&lt;/p&gt;</comment>
                            <comment id="13868955" author="kohlisankalp" created="Sun, 12 Jan 2014 06:17:01 +0000"  >&lt;p&gt;&quot;I tried to fix this by defaulting isAlive=false in the constructor of EndpointState.&quot;&lt;br/&gt;
This won&apos;t fix the problem as endpoint can be alive. &lt;br/&gt;
I tried my fix and it seems to work but someone else should also test it. &lt;/p&gt;</comment>
                            <comment id="13869608" author="brandon.williams" created="Mon, 13 Jan 2014 15:17:16 +0000"  >&lt;p&gt;This patch solves the issue outlined in the description for me.  I created a firewall between two nodes and they do mark each other as dead, despite being able to see each other through a third node.  What doesn&apos;t work though, if is the partition is temporary and heals, the nodes never mark each other up, even though the connection has been (re)established as in Vijay&apos;s point 2).  However, that is a separate problem that has always existed, so let&apos;s move that to another ticket.  Committed Sankalp&apos;s patch.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12622507" name="6571.txt" size="682" author="brandon.williams" created="Sat, 11 Jan 2014 18:17:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[kohlisankalp]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>367363</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 45 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1rbm7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>367672</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324629">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12322954">2.0 beta 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>