<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:47:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7499] Unable to update list element by index using CAS condition</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7499</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;While running IT tests for &lt;b&gt;Achilles&lt;/b&gt;, I ran into a strange bug:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;With CQLSH&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;cqlsh:test&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; cas_update(id &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;KEY&lt;/span&gt;,&lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;text&lt;/span&gt;,friends list&amp;lt;&lt;span class=&quot;code-keyword&quot;&gt;text&lt;/span&gt;&amp;gt;);
cqlsh:test&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;INSERT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;INTO&lt;/span&gt; cas_update (id, &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt; , friends ) &lt;span class=&quot;code-keyword&quot;&gt;VALUES&lt;/span&gt; ( 10,&lt;span class=&quot;code-quote&quot;&gt;&apos;John&apos;&lt;/span&gt;,[&lt;span class=&quot;code-quote&quot;&gt;&apos;Paul&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;George&apos;&lt;/span&gt;]);
cqlsh:test&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; cas_update &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; id=10;

 id | friends            | &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;----+--------------------+------
&lt;/span&gt; 10 | [&lt;span class=&quot;code-quote&quot;&gt;&apos;Paul&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;George&apos;&lt;/span&gt;] | John

cqlsh:test&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;UPDATE&lt;/span&gt; cas_update &lt;span class=&quot;code-keyword&quot;&gt;SET&lt;/span&gt; friends[0]=&lt;span class=&quot;code-quote&quot;&gt;&apos;Helen&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; id=10 &lt;span class=&quot;code-keyword&quot;&gt;IF&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;=&lt;span class=&quot;code-quote&quot;&gt;&apos;John&apos;&lt;/span&gt;;
Bad Request: List &lt;span class=&quot;code-keyword&quot;&gt;index&lt;/span&gt; 0 &lt;span class=&quot;code-keyword&quot;&gt;out&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;of&lt;/span&gt; bound, list has &lt;span class=&quot;code-keyword&quot;&gt;size&lt;/span&gt; 0

cqlsh:test&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;UPDATE&lt;/span&gt; cas_update &lt;span class=&quot;code-keyword&quot;&gt;SET&lt;/span&gt; friends[0]=&lt;span class=&quot;code-quote&quot;&gt;&apos;Helen&apos;&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; id=10;
cqlsh:test&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; * &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; cas_update &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; id=10;

 id | friends             | &lt;span class=&quot;code-keyword&quot;&gt;name&lt;/span&gt;
&lt;span class=&quot;code-comment&quot;&gt;----+---------------------+------
&lt;/span&gt; 10 | [&lt;span class=&quot;code-quote&quot;&gt;&apos;Helen&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;George&apos;&lt;/span&gt;] | John
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems that we cannot update list element by index with a CAS condition.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;With Java driver 2.0.2 or 2.0.3&lt;/b&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; ACHILLES_DML_STATEMENT@:writeDMLStatementLog Prepared statement : [INSERT INTO CompleteBean(id,followers,friends,name,preferences) VALUES (:id,:followers,:friends,:name,:preferences) USING TTL :ttl;] with CONSISTENCY LEVEL [ONE] 
 ACHILLES_DML_STATEMENT@:writeDMLStatementLog    bound values : [621309709026375591, [], [Paul, Andrew], John, {}, 0] 
 ACHILLES_DML_STATEMENT@:writeDMLStartBatch  
 ACHILLES_DML_STATEMENT@:writeDMLStartBatch  
 ACHILLES_DML_STATEMENT@:writeDMLStartBatch ****** BATCH UNLOGGED START ****** 
 ACHILLES_DML_STATEMENT@:writeDMLStartBatch  
 ACHILLES_DML_STATEMENT@:writeDMLStatementLog Parameterized statement : [UPDATE CompleteBean USING TTL 100 SET friends[0]=? WHERE id=621309709026375591 IF name=?;] with CONSISTENCY LEVEL [ONE] 
 ACHILLES_DML_STATEMENT@:writeDMLStatementLog    bound values : [100, 0, Helen, 621309709026375591, John] 
 ACHILLES_DML_STATEMENT@:writeDMLStatementLog Parameterized statement : [UPDATE CompleteBean USING TTL 100 SET friends[1]=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; WHERE id=621309709026375591 IF name=?;] with CONSISTENCY LEVEL [ONE] 
 ACHILLES_DML_STATEMENT@:writeDMLStatementLog    bound values : [100, 1, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, 621309709026375591, John] 
 ACHILLES_DML_STATEMENT@:writeDMLEndBatch  
 ACHILLES_DML_STATEMENT@:writeDMLEndBatch   ****** BATCH UNLOGGED END with CONSISTENCY LEVEL [DEFAULT] ****** 
 ACHILLES_DML_STATEMENT@:writeDMLEndBatch  
 ACHILLES_DML_STATEMENT@:writeDMLEndBatch  
 ACHILLES_DML_STATEMENT@:truncateTable   Simple query : [TRUNCATE entity_with_enum] with CONSISTENCY LEVEL [ALL] 
 ACHILLES_DML_STATEMENT@:truncateTable   Simple query : [TRUNCATE CompleteBean] with CONSISTENCY LEVEL [ALL] 

com.datastax.driver.core.exceptions.InvalidQueryException: List index 0 out of bound, list has size 0
        at com.datastax.driver.core.exceptions.InvalidQueryException.copy(InvalidQueryException.java:35)
        at com.datastax.driver.core.DefaultResultSetFuture.extractCauseFromExecutionException(DefaultResultSetFuture.java:256)
        at com.datastax.driver.core.DefaultResultSetFuture.getUninterruptibly(DefaultResultSetFuture.java:172)
        at com.datastax.driver.core.AbstractSession.execute(AbstractSession.java:52)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;With Cassandra &lt;b&gt;2.0.8&lt;/b&gt; and Java Driver 2.0.2 or 2.0.3, &lt;b&gt;the test passed&lt;/b&gt; so it seems that there is a regression somewhere in the CAS update code&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Cassandra &lt;b&gt;2.0.9&lt;/b&gt;, Java Driver &lt;b&gt;2.0.2&lt;/b&gt; &amp;amp; &lt;b&gt;2.0.3&lt;/b&gt;&lt;br/&gt;
Client: cqlsh &lt;b&gt;3.1.8&lt;/b&gt;, CQL spec &lt;b&gt;3.1.0&lt;/b&gt;, Thrift protocol &lt;b&gt;19.39.0&lt;/b&gt;&lt;/p&gt;</environment>
        <key id="12725650">CASSANDRA-7499</key>
            <summary>Unable to update list element by index using CAS condition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="doanduyhai">DuyHai Doan</reporter>
                        <labels>
                            <label>LWT</label>
                    </labels>
                <created>Sun, 6 Jul 2014 22:08:21 +0000</created>
                <updated>Fri, 25 Oct 2019 13:11:29 +0000</updated>
                            <resolved>Mon, 18 Aug 2014 08:24:49 +0000</resolved>
                                        <fixVersion>2.0.10</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                    <component>Feature/Lightweight Transactions</component>
                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14053581" author="slebresne" created="Mon, 7 Jul 2014 12:10:55 +0000"  >&lt;p&gt;Are you &lt;b&gt;sure&lt;/b&gt; that you don&apos;t get the same with Cassandra 2.0.8? Cause I can reproduce on basically any version of 2.0 and reading the code seems to agree that this has always been there (this is not saying we shouldn&apos;t fix it, I&apos;m just trying to assert whether that&apos;s a regression or a bug that has always been there).&lt;/p&gt;</comment>
                            <comment id="14053633" author="doanduyhai" created="Mon, 7 Jul 2014 13:13:47 +0000"  >&lt;p&gt;You&apos;re right, the issue is the same on Cassandra &lt;b&gt;2.0.8&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt; I said that the test passed in 2.0.8, indeed it was not the same test. When the CAS update occurs in a &lt;b&gt;batch statement&lt;/b&gt;, it works. It looks like we have some funny bug here:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;@Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void test_fail() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-comment&quot;&gt;//Given
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Session session = manager.getNativeSession();

        session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE cas_update(id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PRIMARY KEY,name text,friends list&amp;lt;text&amp;gt;)&quot;&lt;/span&gt;);
        session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO cas_update (id, name , friends ) VALUES ( 10,&lt;span class=&quot;code-quote&quot;&gt;&apos;John&apos;&lt;/span&gt;,[&lt;span class=&quot;code-quote&quot;&gt;&apos;Paul&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;George&apos;&lt;/span&gt;])&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-comment&quot;&gt;// When
&lt;/span&gt;        session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE cas_update SET friends[0]=&lt;span class=&quot;code-quote&quot;&gt;&apos;Helen&apos;&lt;/span&gt; WHERE id=10 IF name=&lt;span class=&quot;code-quote&quot;&gt;&apos;John&apos;&lt;/span&gt;&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-comment&quot;&gt;//Then
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Row row = session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM cas_update WHERE id=10&quot;&lt;/span&gt;).one();
        assertThat(row.getList(&lt;span class=&quot;code-quote&quot;&gt;&quot;friends&quot;&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class)).containsExactly(&lt;span class=&quot;code-quote&quot;&gt;&quot;Helen&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;George&quot;&lt;/span&gt;);
    }

    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void test_pass() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Exception {
        &lt;span class=&quot;code-comment&quot;&gt;//Given
&lt;/span&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Session session = manager.getNativeSession();

        session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE cas_update(id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PRIMARY KEY,name text,friends list&amp;lt;text&amp;gt;)&quot;&lt;/span&gt;);
        session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO cas_update (id, name , friends ) VALUES ( 10,&lt;span class=&quot;code-quote&quot;&gt;&apos;John&apos;&lt;/span&gt;,[&lt;span class=&quot;code-quote&quot;&gt;&apos;Paul&apos;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&apos;George&apos;&lt;/span&gt;])&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; BatchStatement batch = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BatchStatement(BatchStatement.Type.UNLOGGED);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SimpleStatement statement1 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleStatement(&lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE cas_update SET friends[0]=&lt;span class=&quot;code-quote&quot;&gt;&apos;Helen&apos;&lt;/span&gt; WHERE id=10 IF name=&lt;span class=&quot;code-quote&quot;&gt;&apos;John&apos;&lt;/span&gt;&quot;&lt;/span&gt;);
        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; SimpleStatement statement2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; SimpleStatement(&lt;span class=&quot;code-quote&quot;&gt;&quot;UPDATE cas_update SET friends[1]=&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; WHERE id=10 IF name=&lt;span class=&quot;code-quote&quot;&gt;&apos;John&apos;&lt;/span&gt;&quot;&lt;/span&gt;);
        batch.add(statement1).add(statement2);
        session.execute(batch);

        &lt;span class=&quot;code-comment&quot;&gt;//When
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Row row = session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM cas_update WHERE id=10&quot;&lt;/span&gt;).one();

        &lt;span class=&quot;code-comment&quot;&gt;//Then
&lt;/span&gt;        assertThat(row.getList(&lt;span class=&quot;code-quote&quot;&gt;&quot;friends&quot;&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.class)).containsExactly(&lt;span class=&quot;code-quote&quot;&gt;&quot;Helen&quot;&lt;/span&gt;);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14053643" author="slebresne" created="Mon, 7 Jul 2014 13:28:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;When the CAS update occurs in a batch statement, it works&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, it doesn&apos;t, it runs into &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7337&quot; title=&quot;Protocol batches wrongly ignores conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7337&quot;&gt;&lt;del&gt;CASSANDRA-7337&lt;/del&gt;&lt;/a&gt;. And that&apos;s because it (wrongly) doesn&apos;t take the CAS path that the query don&apos;t return an IRE. But it returns bogus results, which is arguably worth.&lt;/p&gt;</comment>
                            <comment id="14053650" author="doanduyhai" created="Mon, 7 Jul 2014 13:32:24 +0000"  >&lt;p&gt;Ok I see. It explains  why my IT test passed with &lt;b&gt;2.0.8&lt;/b&gt; (because of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7337&quot; title=&quot;Protocol batches wrongly ignores conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7337&quot;&gt;&lt;del&gt;CASSANDRA-7337&lt;/del&gt;&lt;/a&gt; not fixed yet) and failed with &lt;b&gt;2.0.9&lt;/b&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7337&quot; title=&quot;Protocol batches wrongly ignores conditions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7337&quot;&gt;&lt;del&gt;CASSANDRA-7337&lt;/del&gt;&lt;/a&gt; fixed but then new bug)&lt;/p&gt;</comment>
                            <comment id="14053826" author="slebresne" created="Mon, 7 Jul 2014 16:30:37 +0000"  >&lt;p&gt;So, summing it up, list operations that require a read before write have never worked when there is conditions (we&apos;re just not doing the read at all).&lt;/p&gt;

&lt;p&gt;We should probably not just add an additional read as we do on the normal path as it wouldn&apos;t be &quot;protected&quot; by Paxos and thus would yield to unexpected behaviour (on top of being wasteful). What we should do is read the pre-existing list as part of the Paxos read and use that. That will require a bit of refactoring but hopefully that&apos;s not too bad.&lt;/p&gt;</comment>
                            <comment id="14092630" author="slebresne" created="Mon, 11 Aug 2014 09:52:44 +0000"  >&lt;p&gt;Attaching a patch doing what I suggest above. Basically, instead of passing directly the updates to the &lt;tt&gt;SP.cas()&lt;/tt&gt; call, those are generated by the &lt;tt&gt;CASConditions&lt;/tt&gt; (which are renamed &lt;tt&gt;CASRequest&lt;/tt&gt; by the patch to reflect the fact it&apos;s not just the conditions) and are allow to take the values read by the initial Paxos into account. Which in turns allows us to handle those lists operations that need to know the current value. There is a dtest for this (I had already committed one a while back in fact).&lt;/p&gt;</comment>
                            <comment id="14094844" author="thobbs" created="Tue, 12 Aug 2014 22:53:58 +0000"  >&lt;p&gt;I haven&apos;t completely reviewed this yet, but here are some initial review comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;StorageProxy.cas()&lt;/tt&gt;: docstring needs to be updated&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;UpdateParameters.setPrefectedLists()&lt;/tt&gt;: unused and typo in method name&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;BatchStatement.executeWithConditions()&lt;/tt&gt;: &apos;timestamp&apos; is unused and needs to be passed to the updates.  Test coverage for using the correct timestamps would be good.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;RowUpdate&lt;/tt&gt;: comments explaining what&apos;s going on would be useful&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;RowCondition&lt;/tt&gt; constructor: since we weren&apos;t dividing &lt;tt&gt;now&lt;/tt&gt; by 1000 before, TTL&apos;ed cells were considered expired way too early during CAS reads? If that&apos;s true, can you create dtests for that scenario as well?  Can you add docstrings for &lt;tt&gt;RowCondition.now&lt;/tt&gt; and &lt;tt&gt;Column.isLive()&lt;/tt&gt; (at a minimum) to document when millis and micros are used?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As a side note, what do you think about pushing this fix to 2.1 and throwing an IRE in this situation in 2.0?  I&apos;m a little nervous about making large changes to CAS this late in 2.0, and this hasn&apos;t worked in 2.0 at all so far.&lt;/p&gt;</comment>
                            <comment id="14095458" author="slebresne" created="Wed, 13 Aug 2014 13:20:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;what do you think about pushing this fix to 2.1 and throwing an IRE in this situation in 2.0?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ve been wondering the same thing so let&apos;s stick to 2.1. I&apos;ll update the patch for 2.1 with updates for the other comments and attach a trivial &quot;throw IRE&quot; patch for 2.0 &lt;/p&gt;</comment>
                            <comment id="14095464" author="doanduyhai" created="Wed, 13 Aug 2014 13:24:40 +0000"  >&lt;p&gt;Not urgent bug. Batching with list update by index with CAS is quite rare so yes, it&apos;s safer to move it to 2.1&lt;/p&gt;</comment>
                            <comment id="14095705" author="enigmacurry" created="Wed, 13 Aug 2014 16:54:30 +0000"  >&lt;p&gt;The cas_and_list_index_test is failing on 2.1&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/cassandra-2.1.0_dtest/53/testReport/cql_tests/TestCQL/cas_and_list_index_test/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/cassandra-2.1.0_dtest/53/testReport/cql_tests/TestCQL/cas_and_list_index_test/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14095805" author="slebresne" created="Wed, 13 Aug 2014 17:55:48 +0000"  >&lt;p&gt;Attaching patch rebased for 2.1 that also fix the remarks above.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;&apos;timestamp&apos; is unused and needs to be passed to the updates. Test coverage for using the correct timestamps would be good.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I &quot;fixed it&quot; by preserving the existing behavior, but as it happens, Paxos nukes the timestamp afterwards so the exact timestamps used a the time of &lt;tt&gt;executeWithConditions&lt;/tt&gt; doesn&apos;t matter (we could make that fact more obvious in the code but that&apos;s not related to this ticket) and there is no meaningful possible test coverage.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;since we weren&apos;t dividing now by 1000 before, TTL&apos;ed cells were considered expired way too early during CAS reads?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, we were dividing by 1000 before, it was just done in Cql3Conditions ctor rather than RowCondition. But anyway, I&apos;ve actually changed this slightly and commented. There is a cas_and_ttl test in dtest btw.&lt;/p&gt;</comment>
                            <comment id="14096733" author="slebresne" created="Thu, 14 Aug 2014 08:25:02 +0000"  >&lt;p&gt;Attaching simple &quot;throw IRE&quot; patch for 2.0 too.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The cas_and_list_index_test is failing on 2.1&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, that&apos;s the test for this issue and this hasn&apos;t been committed yet. The test shouldn&apos;t have been run, it&apos;s my fault for commenting out the &apos;@require(7499)&apos; on the test. I&apos;ve re-enabled it (I&apos;ll re-remove it once it&apos;s committed).&lt;/p&gt;</comment>
                            <comment id="14098795" author="thobbs" created="Fri, 15 Aug 2014 17:34:38 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;I also ran this through some fairly thorough dtests I&apos;m working on for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6839&quot; title=&quot;Support non equal conditions (for LWT)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6839&quot;&gt;&lt;del&gt;CASSANDRA-6839&lt;/del&gt;&lt;/a&gt;, and it looks good.&lt;/p&gt;
</comment>
                            <comment id="14100425" author="slebresne" created="Mon, 18 Aug 2014 08:24:49 +0000"  >&lt;p&gt;Committed (I committed the &quot;throw IRE&quot; for 2.0 and 2.1.0 and the &quot;real&quot; fix for 2.1.1), thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12723417">CASSANDRA-7441</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12661675" name="7499-2.0.txt" size="2839" author="slebresne" created="Thu, 14 Aug 2014 08:25:02 +0000"/>
                            <attachment id="12661490" name="7499-2.1.txt" size="39819" author="slebresne" created="Wed, 13 Aug 2014 17:55:48 +0000"/>
                            <attachment id="12660967" name="7499.txt" size="41798" author="slebresne" created="Mon, 11 Aug 2014 09:52:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>403808</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xhyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>403851</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326830">2.0.9</customfieldvalue>
    <customfieldvalue id="12327576">2.1 rc6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324629">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>