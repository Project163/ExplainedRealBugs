<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13929] BTree$Builder / io.netty.util.Recycler$Stack leaking memory</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13929</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Different to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13754&quot; title=&quot;BTree.Builder memory leak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13754&quot;&gt;&lt;del&gt;CASSANDRA-13754&lt;/del&gt;&lt;/a&gt;, there seems to be another memory leak in 3.11.0+ in BTree$Builder / io.netty.util.Recycler$Stack.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;heap utilization increase after upgrading to 3.11.0 =&amp;gt; cassandra_3.11.0_min_memory_utilization.jpg&lt;/li&gt;
	&lt;li&gt;No difference after upgrading to 3.11.1 (snapshot build) =&amp;gt; cassandra_3.11.1_snapshot_heaputilization.png; thus most likely after fixing &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13754&quot; title=&quot;BTree.Builder memory leak&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13754&quot;&gt;&lt;del&gt;CASSANDRA-13754&lt;/del&gt;&lt;/a&gt;, more visible now&lt;/li&gt;
	&lt;li&gt;MAT shows io.netty.util.Recycler$Stack as top contributing class =&amp;gt; cassandra_3.11.1_mat_dominator_classes.png&lt;/li&gt;
	&lt;li&gt;With -Xmx8G (CMS) and our load pattern, we have to do a rolling restart after ~ 72 hours&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Verified the following fix, namely explicitly unreferencing the &lt;em&gt;recycleHandle&lt;/em&gt; member (making it non-final). In &lt;em&gt;org.apache.cassandra.utils.btree.BTree.Builder.recycle()&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void recycle()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (recycleHandle != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
            {
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.cleanup();
                builderRecycler.recycle(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, recycleHandle);
                recycleHandle = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;; &lt;span class=&quot;code-comment&quot;&gt;// ADDED
&lt;/span&gt;            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Patched a single node in our loadtest cluster with this change and after ~ 10 hours uptime, no sign of the previously offending class in MAT anymore =&amp;gt; cassandra_3.11.1_mat_dominator_classes_FIXED.png&lt;/p&gt;

&lt;p&gt;Can&apos; say if this has any other side effects etc., but I doubt.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13106635">CASSANDRA-13929</key>
            <summary>BTree$Builder / io.netty.util.Recycler$Stack leaking memory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jay.zhuang">Jay Zhuang</assignee>
                                    <reporter username="tsteinmaurer">Thomas Steinmaurer</reporter>
                        <labels>
                    </labels>
                <created>Tue, 3 Oct 2017 07:58:04 +0000</created>
                <updated>Tue, 13 Oct 2020 12:34:40 +0000</updated>
                            <resolved>Fri, 8 Jun 2018 19:12:49 +0000</resolved>
                                        <fixVersion>3.11.3</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>22</watches>
                                                                                                                <comments>
                            <comment id="16189587" author="tjake" created="Tue, 3 Oct 2017 11:47:45 +0000"  >&lt;p&gt;The recycler is meant to cache objects for reuse. By nulling the handler you are effectively invalidating the cache every time. &lt;/p&gt;

&lt;p&gt;I don&apos;t think this is a leak but perhaps we should limit this cache to hold less items. (see the recycler constructor)&lt;/p&gt;</comment>
                            <comment id="16189626" author="tsteinmaurer" created="Tue, 3 Oct 2017 12:09:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;: Thanks for the feedback about invalidating the cache. Not sure what actually is cached here, but without nulling the reference, I do see e.g. ~ 770K BTree$Builder instances on the heap. Infinite caching still sounds like a memory leak to me, but that&apos;s nitpicking now. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Thanks again.&lt;/p&gt;</comment>
                            <comment id="16189717" author="tjake" created="Tue, 3 Oct 2017 13:39:37 +0000"  >&lt;p&gt;The default for recycler is 32k instances per thread. So perhaps change this to 8192 per thread and see if that makes a difference.&lt;/p&gt;</comment>
                            <comment id="16189956" author="tsteinmaurer" created="Tue, 3 Oct 2017 16:53:49 +0000"  >&lt;p&gt;I can try a different max value, but what is supposed to be cached here and what area should be suffering without the cache? The reason why I&apos;m asking is, that in our 9 node cluster, a single node is patched with the discussed change. I don&apos;t see any difference in CPU usage, GC, request latency etc., thus potentially looking at the wrong metrics.&lt;/p&gt;</comment>
                            <comment id="16190006" author="tjake" created="Tue, 3 Oct 2017 17:27:24 +0000"  >&lt;p&gt;This was part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9766&quot; title=&quot;Faster Streaming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9766&quot;&gt;&lt;del&gt;CASSANDRA-9766&lt;/del&gt;&lt;/a&gt; and addresses one of the main allocation culprits during streaming.&lt;/p&gt;</comment>
                            <comment id="16190865" author="tsteinmaurer" created="Wed, 4 Oct 2017 06:11:26 +0000"  >&lt;p&gt;Ok, if this sort of caching is entirely only useful during streaming, this somehow explains why I do not see any difference between the nodes here, cause they process regular business and no repair, bootstrapping etc, thus I can&apos;t comment on the performance gain with the cache (possibly this has been tested in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9766&quot; title=&quot;Faster Streaming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9766&quot;&gt;&lt;del&gt;CASSANDRA-9766&lt;/del&gt;&lt;/a&gt; anyway).&lt;/p&gt;

&lt;p&gt;If the cache is useful for streaming, it still would definitely make sense IMHO, to make the max capacity configurable (with a somewhat useful small default value) via a system property, cassandra.yaml or whatever place is preferred here, cause ~ 2,4G+ heap usage for this sort of cache at -XmX8G does not make sense or perhaps the majority of Cassandra users don&apos;t scale out with smaller sized machines anymore.&lt;/p&gt;

&lt;p&gt;As you have mentioned &lt;b&gt;per thread&lt;/b&gt;. I guess we are talking about the number of threads serving client requests, aka e.g. &lt;tt&gt;native_transport_max_threads&lt;/tt&gt;? If so, there should be somewhere a clear pointer in a comment, documentation etc., that heap usage is directly related to number of threads * configurable max size&lt;/p&gt;</comment>
                            <comment id="16192603" author="tsteinmaurer" created="Thu, 5 Oct 2017 08:27:41 +0000"  >&lt;p&gt;Patched our 9 node loadtest cluster with disabled recycling. Flat AVG heap utilization in a time-frame of 24hrs. =&amp;gt; cassandra_3.11.1_NORECYCLE_memory_utilization.jpg&lt;/p&gt;

&lt;p&gt;I don&apos;t see any negative impact for normal operations (haven&apos;t tested streaming) running without this cache, so this is probably a cost vs. benefit discussion, but e.g. in relation to other in-memory data structures for speeding up things (key cache, bloom filter), this kind of cache is questionable, IMHO.&lt;/p&gt;</comment>
                            <comment id="16203473" author="tsteinmaurer" created="Fri, 13 Oct 2017 12:20:51 +0000"  >&lt;p&gt;Stable for a week now in our 9 node (m4.xlarge) loadtest cluster from a heap perspective with entirely disabling the recycler cache.&lt;/p&gt;

&lt;p&gt;Any ideas if we can expect something in context of this ticket for 3.11.2? Thanks!&lt;/p&gt;
</comment>
                            <comment id="16285908" author="tsteinmaurer" created="Mon, 11 Dec 2017 13:36:46 +0000"  >&lt;p&gt;Yet another ping after 2 months of silence and the issue still being unassigned. Is this something which will be handled in the 3.11 series? Thanks!&lt;/p&gt;</comment>
                            <comment id="16286044" author="mshuler" created="Mon, 11 Dec 2017 15:31:32 +0000"  >&lt;p&gt;You may have some better success getting eyes on this JIRA by attaching a proper patch for the 3.11 branch (and a separate trunk patch, if merge up isn&apos;t clean). You can do this with a simple text file attachment of the diff, or linking to a github branch.&lt;/p&gt;

&lt;p&gt;Bonus points for adding a test that reproduces the problem/fix, as well as getting test run through circleci.&lt;/p&gt;

&lt;p&gt;This JIRA can be assigned to yourself as the author and you can set the status to &quot;Patch Available&quot; when there&apos;s an actual patch/branch to review. Then you can possibly seek out a reviewer on the dev@ mailing list, if it&apos;s urgent.&lt;/p&gt;

&lt;p&gt;It looks like there are currently 115 Patch Available tickets, so it may still take some time, but getting this set up for someone else to review would be a great step in getting the process rolling further than just a comment.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/issues/?jql=project%20%3D%20CASSANDRA%20AND%20status%20%3D%20%22Patch%20Available%22&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/issues/?jql=project%20%3D%20CASSANDRA%20AND%20status%20%3D%20%22Patch%20Available%22&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16286047" author="mshuler" created="Mon, 11 Dec 2017 15:33:47 +0000"  >&lt;p&gt;I set the fix version to &lt;tt&gt;3.11.x&lt;/tt&gt; to indicate this is intended for the 3.11 series for you.&lt;/p&gt;</comment>
                            <comment id="16334780" author="tsteinmaurer" created="Mon, 22 Jan 2018 19:32:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mshuler&quot; class=&quot;user-hover&quot; rel=&quot;mshuler&quot;&gt;mshuler&lt;/a&gt;, my patch would look like as mentioned in the description, but I&apos;m pretty sure it will get rejected, cause &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; mentioned that this all has been added to cache something, especially useful for streaming, if I remember correctly. Due to lack of knowledge about the inner workings here, I can&apos;t provide anything more useful. Our loadtest environment is running a locally patched build with the nulling approach.&lt;/p&gt;</comment>
                            <comment id="16339863" author="jjirsa" created="Thu, 25 Jan 2018 20:54:53 +0000"  >&lt;p&gt;I chatted offline with Scott (who is far more familiar with the netty project than I am), and he noted that they&apos;ve fixed a few recent bugs in that area of the code that&#160;COULD resolve leaks. I&apos;m not confident this is actually a leak, vs just the recycler working as intended (but needing to be tuned), but perhaps we can consider bumping netty anyway (at least in trunk this is an easy decision, but it&apos;d be interesting to find if netty 4.1.20 fixes the behavior you see in unpatched 3.11.1 &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tsteinmaurer&quot; class=&quot;user-hover&quot; rel=&quot;tsteinmaurer&quot;&gt;tsteinmaurer&lt;/a&gt; ).&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16340134" author="tsteinmaurer" created="Thu, 25 Jan 2018 21:46:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt;, thanks for the follow-up. Looks like a simple netty jar file replacement works, at least Cassandra starts up without any exceptions. I have now 1 of 9 nodes running with 3.11.1 unpatched + Netty 4.1.20.&lt;/p&gt;</comment>
                            <comment id="16340146" author="jjirsa" created="Thu, 25 Jan 2018 21:51:42 +0000"  >&lt;h3&gt;&lt;a name=&quot;netty4.0.55https%3A%2F%2Fgithub.com%2Fnetty%2Fnetty%2Freleases%2Ftag%2Fnetty4.0.55.Final%C2%A0maybeabettertest%2Csince3.11.1isrunningnetty4.0.44now%2C4.0.55wouldbeonthesamemajorandappearstohavemanyofthesimilarfixestoRecycler.&quot;&gt;&lt;/a&gt;&lt;a href=&quot;https://github.com/netty/netty/releases/tag/netty-4.0.55.Final&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;netty-4.0.55&lt;/a&gt;&#160;may be a better test, since 3.11.1 is running netty 4.0.44 now, 4.0.55 would be on the same major and appears to have many of the similar fixes to Recycler.&lt;/h3&gt;</comment>
                            <comment id="16340152" author="tsteinmaurer" created="Thu, 25 Jan 2018 21:59:33 +0000"  >&lt;p&gt;Makes sense. Restarted the single node with Netty 4.0.55 now.&lt;/p&gt;</comment>
                            <comment id="16346779" author="tsteinmaurer" created="Wed, 31 Jan 2018 13:05:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt;, had 3.11.1 with Netty 4.0.55 on one node in parallel with 3.11.1 incl. &quot;nulling patch&quot; and Netty 4.0.44 on other nodes running over the weekend. Unpatched combo with Netty 4.0.55 unfortunately still shows an AVG heap utilization increase over 72hrs, while the patched show a constant AVG heap usage.&lt;/p&gt;</comment>
                            <comment id="16347629" author="zznate" created="Wed, 31 Jan 2018 21:16:43 +0000"  >&lt;p&gt;If &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=norman&quot; class=&quot;user-hover&quot; rel=&quot;norman&quot;&gt;norman&lt;/a&gt; is around, would be great to get his input on whether this might be a leak or tuning issue with recycler. Thanks for your patience and willingness to test this out &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tsteinmaurer&quot; class=&quot;user-hover&quot; rel=&quot;tsteinmaurer&quot;&gt;tsteinmaurer&lt;/a&gt;.&#160;&lt;/p&gt;</comment>
                            <comment id="16347760" author="jay.zhuang" created="Wed, 31 Jan 2018 23:14:00 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tsteinmaurer&quot; class=&quot;user-hover&quot; rel=&quot;tsteinmaurer&quot;&gt;tsteinmaurer&lt;/a&gt;, as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; suggested, would you please try to reduce the Recycler Capacity Per Thread (&lt;a href=&quot;https://github.com/netty/netty/blob/4.1/common/src/main/java/io/netty/util/Recycler.java#L64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Recycler.java:64&lt;/a&gt;), just restart the node with JVM option:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-Dio.netty.recycler.maxCapacityPerThread=1024
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="16348181" author="norman" created="Thu, 1 Feb 2018 08:23:47 +0000"  >&lt;p&gt;yeah 4.0.55.Final should have the &quot;fix&quot; as well:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/netty/netty/commit/b386ee3eaf35abd5072992d626de6ae2ccadc6d9#diff-23eafd00fcd66829f8cce343b26c236a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/commit/b386ee3eaf35abd5072992d626de6ae2ccadc6d9#diff-23eafd00fcd66829f8cce343b26c236a&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;That said maybe there are other issues. Would it be possible to share a heap-dump ?&lt;/p&gt;</comment>
                            <comment id="16348576" author="tsteinmaurer" created="Thu, 1 Feb 2018 13:30:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt;, will let the node (1 out of 9) - previously, manually upgraded to Netty 4.0.55 - running with your mentioned Netty JVM option over the weekend. Thanks.&lt;/p&gt;</comment>
                            <comment id="16348723" author="norman" created="Thu, 1 Feb 2018 15:18:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tsteinmaurer&quot; class=&quot;user-hover&quot; rel=&quot;tsteinmaurer&quot;&gt;tsteinmaurer&lt;/a&gt; what about a heap dump ? Is this something you could provide ?&lt;/p&gt;</comment>
                            <comment id="16352117" author="tsteinmaurer" created="Mon, 5 Feb 2018 07:57:15 +0000"  >&lt;p&gt;I have attached a new heap utilization chart for our 9 node loadtest environment.&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12909189/12909189_cassandra_3.11.1_vs_3.11.2recyclernullingpatch.png&quot; width=&quot;300&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;The marked node is running with the following configuration:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Cassandra 3.11.1 public release&lt;/li&gt;
	&lt;li&gt;Netty 4.0.55 (manually upgraded from 4.0.44 by simply replacing the jar file in cassandra/lib)&lt;/li&gt;
	&lt;li&gt;-Dio.netty.recycler.maxCapacityPerThread=1024&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This still results in a slow increase in AVG heap utilization&lt;/p&gt;

&lt;p&gt;The other 8 nodes are running with 3.11.2 built from source with my recycleHandle &quot;nulling&quot; patch.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=norman&quot; class=&quot;user-hover&quot; rel=&quot;norman&quot;&gt;norman&lt;/a&gt;, I need to internally check if we need to do that via some sort of NDA then. Will report back. Thanks.&lt;/p&gt;</comment>
                            <comment id="16361873" author="jay.zhuang" created="Tue, 13 Feb 2018 06:20:09 +0000"  >&lt;p&gt;I think it&apos;s just caching the largest tree ever built (&lt;tt&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/utils/btree/BTree.java#L907&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;BTree.java:907&lt;/a&gt;&lt;/tt&gt;) and getting bigger and bigger.&lt;/p&gt;

&lt;p&gt;Here is an example with a large number of &lt;tt&gt;IN&lt;/tt&gt; in a CQL, which causes high heap usage for &lt;tt&gt;$Stack&lt;/tt&gt; :&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;session.execute_async(&quot;select id from test.users where id in (%s)&quot; % &apos;,&apos;.join(map(str, range(100000))))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Here is a dtest to reproduce that: &lt;tt&gt;&lt;a href=&quot;https://github.com/cooldoger/cassandra-dtest/blob/13929/large_in_test.py&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;large_in_test.py&lt;/a&gt;&lt;/tt&gt;&lt;br/&gt;
 &lt;tt&gt;$Stack&lt;/tt&gt; uses 25% 10M heap: &lt;tt&gt;10M = 10 (request num) * 100K (element) * 8 (obj size)&lt;/tt&gt;&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12910320/12910320_dtest_example_heap.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
 We could increase heap size and then increase&#160;request number, element number gradually to make &lt;tt&gt;$Stack&lt;/tt&gt; to 80%+ heap usage. And I&apos;m sure there&apos;re other use cases could build large BTree. Seems the &lt;tt&gt;$Stack&lt;/tt&gt; is unable to release until the &lt;tt&gt;Thread&lt;/tt&gt; is released and by using&#160;&lt;tt&gt;ThreadPoolExecutor&lt;/tt&gt;, the thread is not released.&lt;/p&gt;

&lt;p&gt;I&apos;d like to propose the following patch which cleans large BTree builder (&lt;tt&gt;&amp;gt; 1k elements&lt;/tt&gt;) while recycling:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Branch&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;uTest&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13929-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13929-3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/13929-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/13929-3.11.svg?style=svg&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16361890" author="jay.zhuang" created="Tue, 13 Feb 2018 06:41:52 +0000"  >&lt;p&gt;After increasing the heap size from 1G to 4G, it could support 80 such requests at the same time (&lt;tt&gt;&lt;a href=&quot;https://github.com/cooldoger/cassandra-dtest/blob/13929/large_in_test.py#L12&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;large_in_test.py:12&lt;/a&gt;&lt;/tt&gt;), then the &lt;tt&gt;$Stack&lt;/tt&gt; uses about 70% heap:&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12910331/12910331_dtest_example_80_request.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;Tried the patch, it did fix the problem:&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12910333/12910333_dtest_example_80_request_fix.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="16363596" author="jjirsa" created="Wed, 14 Feb 2018 07:51:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tsteinmaurer&quot; class=&quot;user-hover&quot; rel=&quot;tsteinmaurer&quot;&gt;tsteinmaurer&lt;/a&gt; - available to test?&lt;/p&gt;

&lt;p&gt;Patch looks straight forward to me, but any volunteers to review? Given its impact, probably deserves a more thorough review than I have time for. &lt;/p&gt;

</comment>
                            <comment id="16363597" author="norman" created="Wed, 14 Feb 2018 07:52:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt; I would be interested what is contained in the `Stack` itself&lt;/p&gt;</comment>
                            <comment id="16363884" author="tsteinmaurer" created="Wed, 14 Feb 2018 12:50:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=norman&quot; class=&quot;user-hover&quot; rel=&quot;norman&quot;&gt;norman&lt;/a&gt;, a concrete example for a &lt;b&gt;single&lt;/b&gt; Recycler$Stack instance from our loadtest.&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12910578/12910578_memleak_heapdump_recyclerstack.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Looks like we have a lot of largish 32K object arrays, which seem to be empty as shallow heap = retained heap for this object arrays. So, a quick look on the patch of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt;, this might help. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt;, will re-patch a single node and report back after a considerable uptime.&lt;/p&gt;</comment>
                            <comment id="16363974" author="norman" created="Wed, 14 Feb 2018 13:12:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tsteinmaurer&quot; class=&quot;user-hover&quot; rel=&quot;tsteinmaurer&quot;&gt;tsteinmaurer&lt;/a&gt; yeah thanks I see... So looks more like a misusage for me then a netty bug. Cassandra may also consider to configure the `Recycler` with a more sane default value for this use-case (via the constructor).&lt;/p&gt;</comment>
                            <comment id="16369517" author="jay.zhuang" created="Mon, 19 Feb 2018 20:57:21 +0000"  >&lt;p&gt;Seems like the performance is better without &lt;tt&gt;Recycler&lt;/tt&gt;. Here is microbench test result to build a BTree with and without &lt;tt&gt;Recycler&lt;/tt&gt; (&lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13929-3.11-perf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13929-3.11-perf&lt;/a&gt;) (The score is operation per ms, higher is better)&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;     [java] Benchmark                      (dataSize)          (treeBuilder)   Mode  Cnt      Score       Error   Units
     [java] BTreeBuildBench.buildTreeTest           1  treeBuilderRecycleAdd  thrpt    6  23112.102 ? 17522.471  ops/ms
     [java] BTreeBuildBench.buildTreeTest           1         treeBuilderAdd  thrpt    6  46275.541 ? 60422.458  ops/ms
     [java] BTreeBuildBench.buildTreeTest           2  treeBuilderRecycleAdd  thrpt    6  23588.176 ? 16372.260  ops/ms
     [java] BTreeBuildBench.buildTreeTest           2         treeBuilderAdd  thrpt    6  42838.298 ? 25339.870  ops/ms
     [java] BTreeBuildBench.buildTreeTest           5  treeBuilderRecycleAdd  thrpt    6  24358.111 ? 24339.382  ops/ms
     [java] BTreeBuildBench.buildTreeTest           5         treeBuilderAdd  thrpt    6  60074.551 ? 47329.418  ops/ms
     [java] BTreeBuildBench.buildTreeTest          10  treeBuilderRecycleAdd  thrpt    6  21412.578 ?  6072.160  ops/ms
     [java] BTreeBuildBench.buildTreeTest          10         treeBuilderAdd  thrpt    6  50862.304 ? 30597.546  ops/ms
     [java] BTreeBuildBench.buildTreeTest          20  treeBuilderRecycleAdd  thrpt    6  15871.754 ?  5036.739  ops/ms
     [java] BTreeBuildBench.buildTreeTest          20         treeBuilderAdd  thrpt    6  33699.725 ? 10857.366  ops/ms
     [java] BTreeBuildBench.buildTreeTest          40  treeBuilderRecycleAdd  thrpt    6   5168.225 ?  1212.571  ops/ms
     [java] BTreeBuildBench.buildTreeTest          40         treeBuilderAdd  thrpt    6   8806.838 ?  7736.485  ops/ms
     [java] BTreeBuildBench.buildTreeTest         100  treeBuilderRecycleAdd  thrpt    6   2114.218 ?   639.589  ops/ms
     [java] BTreeBuildBench.buildTreeTest         100         treeBuilderAdd  thrpt    6   3213.333 ?   486.126  ops/ms
     [java] BTreeBuildBench.buildTreeTest        1000  treeBuilderRecycleAdd  thrpt    6    335.523 ?   101.230  ops/ms
     [java] BTreeBuildBench.buildTreeTest        1000         treeBuilderAdd  thrpt    6    386.678 ?   333.534  ops/ms
     [java] BTreeBuildBench.buildTreeTest       10000  treeBuilderRecycleAdd  thrpt    6     35.644 ?    32.171  ops/ms
     [java] BTreeBuildBench.buildTreeTest       10000         treeBuilderAdd  thrpt    6     44.250 ?     8.180  ops/ms
     [java] BTreeBuildBench.buildTreeTest      100000  treeBuilderRecycleAdd  thrpt    6      3.073 ?     2.165  ops/ms
     [java] BTreeBuildBench.buildTreeTest      100000         treeBuilderAdd  thrpt    6      4.651 ?     4.137  ops/ms
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And I think the performance gain for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9766&quot; title=&quot;Faster Streaming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9766&quot;&gt;&lt;del&gt;CASSANDRA-9766&lt;/del&gt;&lt;/a&gt; is not because of the &lt;tt&gt;Recycler&lt;/tt&gt; for BTree builder.&lt;/p&gt;

&lt;p&gt;With &lt;tt&gt;Recycler&lt;/tt&gt;, it does reduce the GC by reserving the memory. But for P95 and sometimes P99, &lt;tt&gt;noRecycler&lt;/tt&gt; is still better. Here is the test result with percentiles (score is time per operation, so smaller is better):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;     [java] Benchmark                                            (dataSize)          (treeBuilder)    Mode       Cnt          Score       Error  Units
     [java] BTreeBuildBench.buildTreeTest                                 1  treeBuilderRecycleAdd  sample   9244739       1435.033 ?   111.857  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00             1  treeBuilderRecycleAdd  sample                   92.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50             1  treeBuilderRecycleAdd  sample                  638.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90             1  treeBuilderRecycleAdd  sample                 1688.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95             1  treeBuilderRecycleAdd  sample                 2292.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99             1  treeBuilderRecycleAdd  sample                 4544.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999            1  treeBuilderRecycleAdd  sample                13792.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999           1  treeBuilderRecycleAdd  sample               124233.984              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00             1  treeBuilderRecycleAdd  sample            104202240.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                                 1         treeBuilderAdd  sample   9334292        880.361 ?    99.171  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00             1         treeBuilderAdd  sample                   74.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50             1         treeBuilderAdd  sample                  177.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90             1         treeBuilderAdd  sample                  557.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95             1         treeBuilderAdd  sample                 2376.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99             1         treeBuilderAdd  sample                 9248.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999            1         treeBuilderAdd  sample                19200.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999           1         treeBuilderAdd  sample                92489.050              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00             1         treeBuilderAdd  sample             66256896.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                                 2  treeBuilderRecycleAdd  sample   9066713       1655.971 ?   127.345  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00             2  treeBuilderRecycleAdd  sample                  101.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50             2  treeBuilderRecycleAdd  sample                  756.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90             2  treeBuilderRecycleAdd  sample                 1952.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95             2  treeBuilderRecycleAdd  sample                 2684.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99             2  treeBuilderRecycleAdd  sample                 5696.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999            2  treeBuilderRecycleAdd  sample                16272.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999           2  treeBuilderRecycleAdd  sample               189176.730              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00             2  treeBuilderRecycleAdd  sample            124387328.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                                 2         treeBuilderAdd  sample   9816463       1264.312 ?   161.134  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00             2         treeBuilderAdd  sample                   91.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50             2         treeBuilderAdd  sample                  209.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90             2         treeBuilderAdd  sample                  579.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95             2         treeBuilderAdd  sample                 2096.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99             2         treeBuilderAdd  sample                 8104.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999            2         treeBuilderAdd  sample                17088.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999           2         treeBuilderAdd  sample               227162.522              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00             2         treeBuilderAdd  sample             96731136.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                                 5  treeBuilderRecycleAdd  sample   8811507       2044.981 ?   142.626  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00             5  treeBuilderRecycleAdd  sample                  126.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50             5  treeBuilderRecycleAdd  sample                  934.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90             5  treeBuilderRecycleAdd  sample                 2384.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95             5  treeBuilderRecycleAdd  sample                 3120.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99             5  treeBuilderRecycleAdd  sample                 5808.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999            5  treeBuilderRecycleAdd  sample                17280.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999           5  treeBuilderRecycleAdd  sample               312320.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00             5  treeBuilderRecycleAdd  sample            117702656.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                                 5         treeBuilderAdd  sample   9992328       1044.948 ?   131.496  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00             5         treeBuilderAdd  sample                   90.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50             5         treeBuilderAdd  sample                  260.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90             5         treeBuilderAdd  sample                  607.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95             5         treeBuilderAdd  sample                 2156.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99             5         treeBuilderAdd  sample                 8384.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999            5         treeBuilderAdd  sample                17856.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999           5         treeBuilderAdd  sample                98048.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00             5         treeBuilderAdd  sample            132382720.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                                10  treeBuilderRecycleAdd  sample   8757941       1896.943 ?   116.106  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00            10  treeBuilderRecycleAdd  sample                  144.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50            10  treeBuilderRecycleAdd  sample                  917.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90            10  treeBuilderRecycleAdd  sample                 2152.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95            10  treeBuilderRecycleAdd  sample                 2980.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99            10  treeBuilderRecycleAdd  sample                 6648.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999           10  treeBuilderRecycleAdd  sample                17056.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999          10  treeBuilderRecycleAdd  sample               260050.739              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00            10  treeBuilderRecycleAdd  sample             60030976.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                                10         treeBuilderAdd  sample   9456081       1066.351 ?   109.690  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00            10         treeBuilderAdd  sample                  127.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50            10         treeBuilderAdd  sample                  333.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90            10         treeBuilderAdd  sample                  534.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95            10         treeBuilderAdd  sample                 1884.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99            10         treeBuilderAdd  sample                 7264.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999           10         treeBuilderAdd  sample                17760.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999          10         treeBuilderAdd  sample               123570.150              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00            10         treeBuilderAdd  sample             92274688.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                                20  treeBuilderRecycleAdd  sample   8754165       2601.277 ?   131.160  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00            20  treeBuilderRecycleAdd  sample                  246.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50            20  treeBuilderRecycleAdd  sample                 1696.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90            20  treeBuilderRecycleAdd  sample                 3680.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95            20  treeBuilderRecycleAdd  sample                 4472.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99            20  treeBuilderRecycleAdd  sample                 6864.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999           20  treeBuilderRecycleAdd  sample                18720.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999          20  treeBuilderRecycleAdd  sample               229269.350              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00            20  treeBuilderRecycleAdd  sample            166461440.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                                20         treeBuilderAdd  sample  10323487       1596.081 ?   150.936  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00            20         treeBuilderAdd  sample                  230.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50            20         treeBuilderAdd  sample                  627.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90            20         treeBuilderAdd  sample                 1019.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95            20         treeBuilderAdd  sample                 2500.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99            20         treeBuilderAdd  sample                 7784.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999           20         treeBuilderAdd  sample                19584.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999          20         treeBuilderAdd  sample               176973.414              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00            20         treeBuilderAdd  sample            103546880.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                                40  treeBuilderRecycleAdd  sample   8413786       6104.243 ?   195.964  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00            40  treeBuilderRecycleAdd  sample                  674.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50            40  treeBuilderRecycleAdd  sample                 4136.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90            40  treeBuilderRecycleAdd  sample                 7528.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95            40  treeBuilderRecycleAdd  sample                 8960.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99            40  treeBuilderRecycleAdd  sample                12976.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999           40  treeBuilderRecycleAdd  sample                31008.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999          40  treeBuilderRecycleAdd  sample              2341360.845              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00            40  treeBuilderRecycleAdd  sample             79560704.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                                40         treeBuilderAdd  sample   8477065       4486.574 ?   230.760  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00            40         treeBuilderAdd  sample                  699.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50            40         treeBuilderAdd  sample                 2156.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90            40         treeBuilderAdd  sample                 4312.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95            40         treeBuilderAdd  sample                 5376.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99            40         treeBuilderAdd  sample                 9520.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999           40         treeBuilderAdd  sample                28032.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999          40         treeBuilderAdd  sample              4583153.664              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00            40         treeBuilderAdd  sample            163840000.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                               100  treeBuilderRecycleAdd  sample   7535010      11631.027 ?   225.736  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00           100  treeBuilderRecycleAdd  sample                 1826.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50           100  treeBuilderRecycleAdd  sample                 7504.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90           100  treeBuilderRecycleAdd  sample                16960.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95           100  treeBuilderRecycleAdd  sample                21408.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99           100  treeBuilderRecycleAdd  sample                31808.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999          100  treeBuilderRecycleAdd  sample                88576.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999         100  treeBuilderRecycleAdd  sample             10534912.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00           100  treeBuilderRecycleAdd  sample            100270080.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                               100         treeBuilderAdd  sample   7564546      10905.697 ?   235.164  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00           100         treeBuilderAdd  sample                 1636.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50           100         treeBuilderAdd  sample                 7280.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90           100         treeBuilderAdd  sample                14416.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95           100         treeBuilderAdd  sample                18976.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99           100         treeBuilderAdd  sample                32512.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999          100         treeBuilderAdd  sample                63040.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999         100         treeBuilderAdd  sample              8708838.195              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00           100         treeBuilderAdd  sample             60293120.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                              1000  treeBuilderRecycleAdd  sample   3117183     101556.600 ?   688.145  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00          1000  treeBuilderRecycleAdd  sample                15136.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50          1000  treeBuilderRecycleAdd  sample                80256.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90          1000  treeBuilderRecycleAdd  sample               169728.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95          1000  treeBuilderRecycleAdd  sample               206848.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99          1000  treeBuilderRecycleAdd  sample               295424.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999         1000  treeBuilderRecycleAdd  sample               573440.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999        1000  treeBuilderRecycleAdd  sample             16580608.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00          1000  treeBuilderRecycleAdd  sample             79953920.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                              1000         treeBuilderAdd  sample   3635046      81844.338 ?   695.009  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00          1000         treeBuilderAdd  sample                17120.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50          1000         treeBuilderAdd  sample                55936.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90          1000         treeBuilderAdd  sample               133120.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95          1000         treeBuilderAdd  sample               168448.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99          1000         treeBuilderAdd  sample               227584.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999         1000         treeBuilderAdd  sample               956367.872              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999        1000         treeBuilderAdd  sample             20004709.990              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00          1000         treeBuilderAdd  sample             75235328.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                             10000  treeBuilderRecycleAdd  sample    396416     806300.548 ?  5006.312  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00         10000  treeBuilderRecycleAdd  sample               178176.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50         10000  treeBuilderRecycleAdd  sample               578560.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90         10000  treeBuilderRecycleAdd  sample              1439744.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95         10000  treeBuilderRecycleAdd  sample              2101248.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99         10000  treeBuilderRecycleAdd  sample              2367488.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999        10000  treeBuilderRecycleAdd  sample             16711680.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999       10000  treeBuilderRecycleAdd  sample             27893461.811              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00         10000  treeBuilderRecycleAdd  sample             69468160.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                             10000         treeBuilderAdd  sample    544398     586738.267 ?  3652.668  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00         10000         treeBuilderAdd  sample               180992.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50         10000         treeBuilderAdd  sample               467456.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90         10000         treeBuilderAdd  sample               898048.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95         10000         treeBuilderAdd  sample              1052672.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99         10000         treeBuilderAdd  sample              1515520.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999        10000         treeBuilderAdd  sample             16334848.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999       10000         treeBuilderAdd  sample             28628756.070              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00         10000         treeBuilderAdd  sample             75759616.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                            100000  treeBuilderRecycleAdd  sample     44146    7258758.048 ? 85405.244  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00        100000  treeBuilderRecycleAdd  sample              1724416.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50        100000  treeBuilderRecycleAdd  sample              5701632.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90        100000  treeBuilderRecycleAdd  sample             11796480.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95        100000  treeBuilderRecycleAdd  sample             15056896.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99        100000  treeBuilderRecycleAdd  sample             28868608.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999       100000  treeBuilderRecycleAdd  sample             61781180.416              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999      100000  treeBuilderRecycleAdd  sample             72159775.949              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00        100000  treeBuilderRecycleAdd  sample            153092096.000              ns/op
     [java] BTreeBuildBench.buildTreeTest                            100000         treeBuilderAdd  sample     50573    6333830.725 ? 79209.874  ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.00        100000         treeBuilderAdd  sample              1839104.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.50        100000         treeBuilderAdd  sample              4587520.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.90        100000         treeBuilderAdd  sample             10764288.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.95        100000         treeBuilderAdd  sample             16629760.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.99        100000         treeBuilderAdd  sample             28737536.000              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.999       100000         treeBuilderAdd  sample             57427755.008              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p0.9999      100000         treeBuilderAdd  sample             92259640.934              ns/op
     [java] BTreeBuildBench.buildTreeTest:buildTreeTest?p1.00        100000         treeBuilderAdd  sample            117833728.000              ns/op
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So I would suggest removing &lt;tt&gt;Recycler&lt;/tt&gt; (similar to &lt;a href=&quot;https://github.com/apache/cassandra/commit/dc9ed463417aa8028e77e91718e4f3d6ea563210#diff-6aa10752b68c93ed354d642f9bdbe814L27&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dc9ed46&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="16373186" author="jay.zhuang" created="Thu, 22 Feb 2018 17:59:12 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;, any suggestion on that? Should we remove &lt;tt&gt;Recycler&lt;/tt&gt; or just reduce the large builder array size?&lt;/p&gt;</comment>
                            <comment id="16373549" author="tjake" created="Thu, 22 Feb 2018 22:10:11 +0000"  >&lt;p&gt;I&apos;d prefer to reduce the array size vs removing but you have been at this for so long I&apos;m starting to think it&apos;s not worth keeping around.&#160; I&apos;d like to re-setup the test I had to check the improvement of&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9766&quot; title=&quot;Faster Streaming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9766&quot;&gt;&lt;del&gt;CASSANDRA-9766&lt;/del&gt;&lt;/a&gt; and see how much of a impact it has.&lt;/p&gt;</comment>
                            <comment id="16373845" author="jay.zhuang" created="Fri, 23 Feb 2018 02:55:54 +0000"  >&lt;p&gt;I tested the change with &lt;tt&gt;LongStreamingTest&lt;/tt&gt;, seems no impact with/without &lt;tt&gt;Recycler&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;With Recycler
    [junit] ERROR [main] 2018-02-22 16:57:56,189 SubstituteLogger.java:250 - Writer finished after 22 seconds....
    [junit] ERROR [main] 2018-02-22 16:58:16,480 SubstituteLogger.java:250 - Finished Streaming in 20.29 seconds: 23.66 Mb/sec
    [junit] ERROR [main] 2018-02-22 16:58:35,921 SubstituteLogger.java:250 - Finished Streaming in 19.44 seconds: 24.69 Mb/sec
    [junit] ERROR [main] 2018-02-22 16:59:25,719 SubstituteLogger.java:250 - Finished Compacting in 49.80 seconds: 19.44 Mb/sec

No Recycler
    [junit] ERROR [main] 2018-02-22 16:50:48,255 SubstituteLogger.java:250 - Writer finished after 22 seconds....
    [junit] ERROR [main] 2018-02-22 16:51:08,209 SubstituteLogger.java:250 - Finished Streaming in 19.95 seconds: 24.06 Mb/sec
    [junit] ERROR [main] 2018-02-22 16:51:27,624 SubstituteLogger.java:250 - Finished Streaming in 19.41 seconds: 24.72 Mb/sec
    [junit] ERROR [main] 2018-02-22 16:52:16,900 SubstituteLogger.java:250 - Finished Compacting in 49.28 seconds: 19.48 Mb/sec
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here is the patch, please review:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Branch &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13929-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13929-3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/13929-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/13929-3.11.svg?style=svg&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/13929-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13929-trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/13929-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/13929-trunk.svg?style=svg&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16374138" author="norman" created="Fri, 23 Feb 2018 09:32:24 +0000"  >&lt;p&gt;Just a general comment.... The recycler only makes sense to use if creating the object is considered very expensive and or if you create / destroy a lot of these very frequently. Which means usually thousands per second. &#160;So if this is not the case here I think it completely reasonable to not use the Recycler at all... As I have no idea really about the use-case I am just leave this here as general comment &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16374200" author="tsteinmaurer" created="Fri, 23 Feb 2018 10:37:23 +0000"  >&lt;p&gt;The following does not include the latest patches from Feb 22, but shows last 30d on a single node (m4.2xlarge, Xmx12G, CMS) out of our 9 node loadtest environment including various tests/patches we have applied.&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12911703/12911703_cassandra_heapcpu_memleak_patching_test_30d.png&quot; width=&quot;1280&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Blue line =&amp;gt; AVG heap utilization&lt;/li&gt;
	&lt;li&gt;Orange line =&amp;gt; AVG CPU utilization (not really related as usually compaction is overlaying anything else most likely)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Following timelines in the chart:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Timeframe&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Deployment&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Comment/Result&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Jan 25 - Feb 1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Cassandra 3.11 public + Netty 4.0.55&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Heap utilization increase&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Feb 1 - Feb 6&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Cassandra 3.11 public + Netty 4.0.55 + limiting Netty capacity per Thread&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/warning.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Heap utilization increase&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Feb 6 - Feb 14&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Cassandra 3.11 public + Netty 4.0.55 + my recycleHandle = null patch&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Heap utilization stable&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Feb 14 - Feb 23&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Cassandra 3.11 public + Netty 4.0.55 + &lt;b&gt;without&lt;/b&gt; recycleHandle = null patch + first &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt; patch from Feb 13&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/check.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Heap utilization stable, but slightly increased to previous&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Very high-level (although from the field) compared to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt; tests and benchmarks, but possibly useful for a decision process, hopefully being included in 3.11.3. Thanks guys!&lt;/p&gt;</comment>
                            <comment id="16385610" author="jay.zhuang" created="Mon, 5 Mar 2018 05:02:00 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;, are you interested in reviewing the patch? The trunk uTest failure is because of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14119&quot; title=&quot;uTest cql3.ViewTest timeout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14119&quot;&gt;CASSANDRA-14119&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16502546" author="cscetbon" created="Tue, 5 Jun 2018 21:45:10 +0000"  >&lt;p&gt;Hey guys, any news on that issue ?&lt;/p&gt;</comment>
                            <comment id="16504704" author="jasobrown" created="Thu, 7 Jun 2018 13:44:39 +0000"  >&lt;p&gt;On the whole, this looks pretty good. I&apos;m running tests locally now, and will run in circleci shortly. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt; There&apos;s one thing I&apos;m wondering: in &lt;tt&gt;#reuse&lt;/tt&gt;, we do not explicitly null out the &lt;tt&gt;values&lt;/tt&gt; array, like we used to do in &lt;tt&gt;#cleanup()&lt;/tt&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    Arrays.fill(values, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;While every access of &lt;tt&gt;values&lt;/tt&gt; seems safe, and uses the &lt;tt&gt;count&lt;/tt&gt; to ensure proper sizing of any built &lt;tt&gt;Object[]&lt;/tt&gt;, I&apos;d like to be over-cautious and null out the array to prevent the possibility of data leak wherein a reuse of Builder erroneously gets extra data from the last use. This error doesn&apos;t seem like it&apos;s possible in the current code, but I&apos;d like to future-proof this - it would be a complete nightmare to debug. &lt;/p&gt;

&lt;p&gt;wdyt?&lt;/p&gt;
</comment>
                            <comment id="16504733" author="jasobrown" created="Thu, 7 Jun 2018 14:07:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tsteinmaurer&quot; class=&quot;user-hover&quot; rel=&quot;tsteinmaurer&quot;&gt;tsteinmaurer&lt;/a&gt; if you&apos;ve been running with some version of this patch (where recycling is not used), do you see any degradation in streaming?&lt;/p&gt;</comment>
                            <comment id="16504842" author="jasobrown" created="Thu, 7 Jun 2018 15:49:11 +0000"  >&lt;p&gt;running &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt;&apos;s patch with a few minor cleanups:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/13929-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/13929-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jasobrown/workflows/cassandra/tree/13929-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests &amp;amp; dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jasobrown/workflows/cassandra/tree/13929-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests &amp;amp; dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16504873" author="tsteinmaurer" created="Thu, 7 Jun 2018 16:17:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt;, sorry I don&apos;t have any streaming benchmarks before/after.&lt;/p&gt;</comment>
                            <comment id="16504890" author="jasobrown" created="Thu, 7 Jun 2018 16:34:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tsteinmaurer&quot; class=&quot;user-hover&quot; rel=&quot;tsteinmaurer&quot;&gt;tsteinmaurer&lt;/a&gt; ok, not a problem. As long as you don&apos;t see streaming getting obviously slower (1 hour -&amp;gt; 2 hours, for example), I&apos;ll take that as a data point.&lt;/p&gt;</comment>
                            <comment id="16505023" author="jay.zhuang" created="Thu, 7 Jun 2018 18:06:37 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; for the review and fix.&lt;/p&gt;

&lt;p&gt;Yes, null out the &lt;tt&gt;values&lt;/tt&gt; array before reusing is a good practice. +1 on that. Seems the dTest is failed for 3.11 branch, but I don&apos;t think it&apos;s caused by this patch. Please let me know if I could commit.&lt;/p&gt;</comment>
                            <comment id="16505984" author="jasobrown" created="Fri, 8 Jun 2018 12:45:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt; +1&lt;/p&gt;</comment>
                            <comment id="16506462" author="jay.zhuang" created="Fri, 8 Jun 2018 19:11:41 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; again for the review. Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/ed5f8347ef0c7175cd96e59bc8bfaf3ed1f4697a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;ed5f834&lt;/tt&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12843761">CASSANDRA-9766</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13268572">CASSANDRA-15430</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12890116" name="cassandra_3.11.0_min_memory_utilization.jpg" size="293905" author="tsteinmaurer" created="Tue, 3 Oct 2017 07:59:37 +0000"/>
                            <attachment id="12890495" name="cassandra_3.11.1_NORECYCLE_memory_utilization.jpg" size="294752" author="tsteinmaurer" created="Thu, 5 Oct 2017 08:24:58 +0000"/>
                            <attachment id="12890120" name="cassandra_3.11.1_mat_dominator_classes.png" size="12936" author="tsteinmaurer" created="Tue, 3 Oct 2017 08:03:44 +0000"/>
                            <attachment id="12890121" name="cassandra_3.11.1_mat_dominator_classes_FIXED.png" size="17413" author="tsteinmaurer" created="Tue, 3 Oct 2017 08:07:20 +0000"/>
                            <attachment id="12890119" name="cassandra_3.11.1_snapshot_heaputilization.png" size="90649" author="tsteinmaurer" created="Tue, 3 Oct 2017 08:02:02 +0000"/>
                            <attachment id="12909189" name="cassandra_3.11.1_vs_3.11.2recyclernullingpatch.png" size="75753" author="tsteinmaurer" created="Mon, 5 Feb 2018 07:53:34 +0000"/>
                            <attachment id="12911703" name="cassandra_heapcpu_memleak_patching_test_30d.png" size="213947" author="tsteinmaurer" created="Fri, 23 Feb 2018 10:27:39 +0000"/>
                            <attachment id="12910331" name="dtest_example_80_request.png" size="126401" author="jay.zhuang" created="Tue, 13 Feb 2018 06:35:16 +0000"/>
                            <attachment id="12910333" name="dtest_example_80_request_fix.png" size="646345" author="jay.zhuang" created="Tue, 13 Feb 2018 06:41:26 +0000"/>
                            <attachment id="12910320" name="dtest_example_heap.png" size="166528" author="jay.zhuang" created="Tue, 13 Feb 2018 05:09:36 +0000"/>
                            <attachment id="12910578" name="memleak_heapdump_recyclerstack.png" size="142856" author="tsteinmaurer" created="Wed, 14 Feb 2018 12:46:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jay.zhuang]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 23 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ktc7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335695">3.8</customfieldvalue>
    <customfieldvalue id="12339157">3.11.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12339157">3.11.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>