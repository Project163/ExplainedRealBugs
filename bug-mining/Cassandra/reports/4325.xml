<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11991] On clock skew, paxos may &quot;corrupt&quot; the node clock</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11991</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;W made a mistake in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9649&quot; title=&quot;Paxos ballot in StorageProxy could clash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9649&quot;&gt;&lt;del&gt;CASSANDRA-9649&lt;/del&gt;&lt;/a&gt; so that a temporal clock skew on one node can &quot;corrupt&quot; other node clocks through Paxos. That wasn&apos;t intended and we should fix that. I&apos;ll attach a patch later.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12977666">CASSANDRA-11991</key>
            <summary>On clock skew, paxos may &quot;corrupt&quot; the node clock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                            <label>LWT</label>
                    </labels>
                <created>Fri, 10 Jun 2016 16:17:15 +0000</created>
                <updated>Fri, 25 Oct 2019 13:11:27 +0000</updated>
                            <resolved>Thu, 23 Jun 2016 07:59:00 +0000</resolved>
                                        <fixVersion>2.1.15</fixVersion>
                    <fixVersion>2.2.7</fixVersion>
                    <fixVersion>3.0.8</fixVersion>
                    <fixVersion>3.8</fixVersion>
                                    <component>Feature/Lightweight Transactions</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15332092" author="kohlisankalp" created="Wed, 15 Jun 2016 16:57:55 +0000"  >&lt;p&gt;I can review the patch. We should try to get it in for 2.1.15 if possible &lt;/p&gt;</comment>
                            <comment id="15334060" author="slebresne" created="Thu, 16 Jun 2016 16:01:54 +0000"  >&lt;p&gt;For context, the problem is basically the one I described in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9649?focusedCommentId=14601016&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14601016&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;my comment&lt;/a&gt; on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9649&quot; title=&quot;Paxos ballot in StorageProxy could clash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9649&quot;&gt;&lt;del&gt;CASSANDRA-9649&lt;/del&gt;&lt;/a&gt; and for which I suggested reverting &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7801&quot; title=&quot;A successful INSERT with CAS does not always store data in the DB after a DELETE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7801&quot;&gt;&lt;del&gt;CASSANDRA-7801&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Now, I was kind of wrong about reverting &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7801&quot; title=&quot;A successful INSERT with CAS does not always store data in the DB after a DELETE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7801&quot;&gt;&lt;del&gt;CASSANDRA-7801&lt;/del&gt;&lt;/a&gt; since since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9649&quot; title=&quot;Paxos ballot in StorageProxy could clash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9649&quot;&gt;&lt;del&gt;CASSANDRA-9649&lt;/del&gt;&lt;/a&gt; we were relying on &lt;tt&gt;ClientState.getTimestamp()&lt;/tt&gt; to give use timestamp that were unique for the running VM, which meant we can&apos;t blindly revert &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7801&quot; title=&quot;A successful INSERT with CAS does not always store data in the DB after a DELETE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7801&quot;&gt;&lt;del&gt;CASSANDRA-7801&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;What I think is the simplest solution however is to stop relying on that property (of &lt;tt&gt;ClientState.getTimestamp()&lt;/tt&gt;) for the uniqueness of our ballots, but instead randomize the non-timestamp parts of the ballot for every new ballot. With that, we don&apos;t have to revert &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7801&quot; title=&quot;A successful INSERT with CAS does not always store data in the DB after a DELETE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7801&quot;&gt;&lt;del&gt;CASSANDRA-7801&lt;/del&gt;&lt;/a&gt;, we just have to ensure that if we use the last known proposal timestamp (i.e. if whomever clock generated that timestamp is &quot;in the future&quot;), we don&apos;t persist it in the local clock (this in turn means the timestamp might not be unique in the VM for 2 concurrent paxos operation and hence the need to randomize the rest of the UUID).&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed a patch for this for 2.1. I&apos;ll attach branches for 2.2+ with tests tomorrow (but was waiting on the 2.1 results before doing that) but I don&apos;t think the modified code has changed since 2.1 so marking ready for review in the meantime.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/11991-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11991-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11991-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15342972" author="jasobrown" created="Tue, 21 Jun 2016 22:53:54 +0000"  >&lt;p&gt;lgtm. The only minor nit I have is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9649&quot; title=&quot;Paxos ballot in StorageProxy could clash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9649&quot;&gt;&lt;del&gt;CASSANDRA-9649&lt;/del&gt;&lt;/a&gt; made &lt;tt&gt;ClientState#lastTimestampMicros&lt;/tt&gt; a static field. I believe this change helped accelerate the cluster get into a bad state wrt the propagation of bad timestamps. wdyt about switching it back to being an instance field (not static)?&lt;/p&gt;</comment>
                            <comment id="15343865" author="slebresne" created="Wed, 22 Jun 2016 07:49:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;The only minor nit I have is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9649&quot; title=&quot;Paxos ballot in StorageProxy could clash&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9649&quot;&gt;&lt;del&gt;CASSANDRA-9649&lt;/del&gt;&lt;/a&gt; made ClientState#lastTimestampMicros a static field.  believe this change helped accelerate the cluster get into a bad state wrt the propagation of bad timestamps. wdyt about switching it back to being an instance field (not static)?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There is really 2 reasons I made it static:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7801&quot; title=&quot;A successful INSERT with CAS does not always store data in the DB after a DELETE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7801&quot;&gt;&lt;del&gt;CASSANDRA-7801&lt;/del&gt;&lt;/a&gt;: it&apos;s not a huge thing, but it helps user being less confused.&lt;/li&gt;
	&lt;li&gt;because I feel that having it not static was a mistake in the first place. That is, even if we completely forget about Paxos, I think having our CQL clock strictly monotonic per-node (rather than per-connection) is cleaner and less surprising to people. So I&apos;m not a fan of getting back to the older behavior, and doing so could be considered a breaking change (easier to give new guarantees than give some away).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I don&apos;t disagree that fact made the consequences of this bug worst, but I don&apos;t think removing the &lt;tt&gt;static&lt;/tt&gt; is minor at all. And that code feel easy enough to convince oneself that we&apos;re not modifying &lt;tt&gt;lastTimestampMicros&lt;/tt&gt; in bad ways anymore, so hopefully we won&apos;t make that mistake anymore.&lt;/p&gt;

&lt;p&gt;Besides, if you&apos;re smart, you should be switching to client generated timestamps anyway &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="15343886" author="slebresne" created="Wed, 22 Jun 2016 08:16:14 +0000"  >&lt;p&gt;Also, I&apos;ve merged the patch up (no conflict whatsoever) and started CI on all branches:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; version &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; utests &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; dtests&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/11991-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11991-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11991-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/11991-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11991-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11991-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/11991-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11991-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11991-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/11991-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11991-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11991-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I also updated the comment on top of &lt;tt&gt;ClientState#lastTimestampMicros&lt;/tt&gt; since it wasn&apos;t complete on the real motivation.&lt;/p&gt;</comment>
                            <comment id="15344227" author="jasobrown" created="Wed, 22 Jun 2016 12:28:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think having our CQL clock strictly monotonic per-node (rather than per-connection) is cleaner and less surprising to people.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;ok, I&apos;ll buy that.&lt;/p&gt;

&lt;p&gt;Otherwise, +1 on all branches. I checked out the test results, and the ones that failed were either 1) unrelated to this CAS change or 2) test timeouts (and still unrelated to CAS).&lt;/p&gt;</comment>
                            <comment id="15345678" author="kohlisankalp" created="Thu, 23 Jun 2016 03:46:03 +0000"  >&lt;p&gt;+1 &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Please commit it. &lt;/p&gt;</comment>
                            <comment id="15346013" author="slebresne" created="Thu, 23 Jun 2016 07:59:01 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2zaqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>