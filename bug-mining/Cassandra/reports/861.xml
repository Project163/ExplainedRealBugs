<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:20:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2457] Batch_mutate is broken for counters</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2457</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2384&quot; title=&quot;Merge Mutation and CounterMutation thrift structure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2384&quot;&gt;&lt;del&gt;CASSANDRA-2384&lt;/del&gt;&lt;/a&gt; allowed for batch_mutate to take counter and non counter operation, but the code was not updated correctly to handle that case. As it is, the code will use the first mutation in the batch list to decide whether to apply the write code path of counter or not, and will thus break if those are mixed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12504037">CASSANDRA-2457</key>
            <summary>Batch_mutate is broken for counters</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Apr 2011 11:29:39 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:02 +0000</updated>
                            <resolved>Wed, 20 Apr 2011 09:22:26 +0000</resolved>
                                        <fixVersion>0.8.0 beta 2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="14400">4h</timeoriginalestimate>
                            <timeestimate seconds="14400">4h</timeestimate>
                                        <comments>
                            <comment id="13019355" author="slebresne" created="Wed, 13 Apr 2011 14:31:46 +0000"  >&lt;p&gt;Attaching patch against 0.8.&lt;/p&gt;

&lt;p&gt;Basically this makes SP.mutate() handle a list of mixed RowMutation and CounterMutation (but then each mutation use the right path). This is needed since a batch_mutate() can now mix those.&lt;/p&gt;

&lt;p&gt;This has an unfortunate consequence however in that I don&apos;t think there is a way to distinguish the writeStats of standard insert of the ones of counter insert anymore, and thus this patch remove the latter ones (and count everything in writeStat).&lt;/p&gt;</comment>
                            <comment id="13020037" author="stuhood" created="Thu, 14 Apr 2011 21:18:26 +0000"  >&lt;ul&gt;
	&lt;li&gt;writeLocallyAndReplicate doesn&apos;t always perform a local mutation, so it should probably be renamed&lt;/li&gt;
	&lt;li&gt;Since mutateCounter and writeLocallyAndReplicate are symmetrical and are called depending on whether an IMutation is an instance of CounterMutation, could we move them onto IMutation, and polymorphically decide the behavior?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&amp;gt; ...and thus this patch remove the latter ones (and count everything in writeStat).&lt;br/&gt;
I&apos;m fine with this, since a counter is as &quot;real&quot; a write as any other. &lt;em&gt;But&lt;/em&gt; I do think we should record the latencies for the replicate-on-write stage like we do for the read and mutation stages on a per column family basis. I can tackle it in a separate ticket if you&apos;d like.&lt;/p&gt;

&lt;p&gt;PS: Thanks for removing this line!&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;mutations.iterator().next().getColumnFamilies().iterator().next().metadata().getDefaultValidator().isCommutative()&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Thanks Sylvain!&lt;/p&gt;</comment>
                            <comment id="13021071" author="slebresne" created="Mon, 18 Apr 2011 15:44:35 +0000"  >&lt;p&gt;Attached rebased version (post-&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2454&quot; title=&quot;Possible deadlock for counter mutations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2454&quot;&gt;&lt;del&gt;CASSANDRA-2454&lt;/del&gt;&lt;/a&gt; in particular)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;writeLocallyAndReplicate doesn&apos;t always perform a local mutation, so it should probably be renamed&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Renamed it to performWrite (since it mostly simply imply a so-called writePerformer).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Since mutateCounter and writeLocallyAndReplicate are symmetrical and are called depending on whether an IMutation is an instance of CounterMutation, could we move them onto IMutation, and polymorphically decide the behavior?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hum, they are not really so symmetrical. In particular writeLocallyAndReplicate (or performWrite as it is called nowadays) really is polymorphic over the IMutation used.&lt;br/&gt;
So the only seem we we could do (at least easily) is moving some of mutateCounter in CounterMutation, but not sure it will look so great. Also, it is probably nice to keep all the code related to the write/read protocol in StorageProxy (doing otherwise would be like moving the query code out of CFStore, nobody wants that &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m fine with this, since a counter is as &quot;real&quot; a write as any other. But I do think we should record the latencies for the replicate-on-write stage like we do for the read and mutation stages on a per column family basis. I can tackle it in a separate ticket if you&apos;d like.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Make sense, but I&apos;m also in favor of moving this to some other ticket. &lt;/p&gt;</comment>
                            <comment id="13021943" author="stuhood" created="Wed, 20 Apr 2011 03:48:17 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13022043" author="slebresne" created="Wed, 20 Apr 2011 09:22:26 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="13022063" author="hudson" created="Wed, 20 Apr 2011 10:21:24 +0000"  >&lt;p&gt;Integrated in Cassandra #859 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra/859/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra/859/&lt;/a&gt;)&lt;br/&gt;
    merge &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2457&quot; title=&quot;Batch_mutate is broken for counters&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2457&quot;&gt;&lt;del&gt;CASSANDRA-2457&lt;/del&gt;&lt;/a&gt; from 0.8&lt;/p&gt;</comment>
                            <comment id="13022316" author="stuhood" created="Wed, 20 Apr 2011 19:16:47 +0000"  >&lt;p&gt;Thanks Sylvain. Opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2522&quot; title=&quot;Record latencies for the replicate-on-write stage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2522&quot;&gt;&lt;del&gt;CASSANDRA-2522&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12476619" name="0001-Fix-batch_mutate-for-counters-v2.patch" size="28656" author="slebresne" created="Mon, 18 Apr 2011 15:37:06 +0000"/>
                            <attachment id="12476243" name="0001-Fix-batch_mutate-for-counters.patch" size="27472" author="slebresne" created="Wed, 13 Apr 2011 14:31:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20634</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 31 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gbhj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93291</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stuhood</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stuhood]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>