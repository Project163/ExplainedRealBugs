<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:43:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6705] ALTER TYPE &lt;type&gt; RENAME &lt;field&gt; fails sometime with java.lang.AssertionError: null</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6705</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Here are the steps w&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh&amp;gt; create KEYSPACE bug WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1};
cqlsh&amp;gt;
cqlsh&amp;gt;
cqlsh&amp;gt; use bug;
cqlsh:bug&amp;gt; create type first_type (first_field &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);
cqlsh:bug&amp;gt; create type second_type (second_field list&amp;lt;first_type &amp;gt;);
cqlsh:bug&amp;gt; alter type first_type RENAME first_field TO first_fieldd;
TSocket read 0 bytes
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And here is from the C* side: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;NFO  05:11:54 Loading org.apache.cassandra.db.marshal.UserType(bug,7365636f6e645f74797065,7365636f6e645f6669656c64:org.apache.cassandra.db.marshal.ListType(org.apache.cassandra.db.marshal.UserType(bug,66697273745f74797065,66697273745f6669656c6464:org.apache.cassandra.db.marshal.Int32Type)))
INFO  05:11:54 Compacted 4 sstables to [/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/system/schema_usertypes-3aa752254f82350b8d5c430fa221fa0a/system-schema_usertypes-ka-5,].  908 bytes to 425 (~46% of original) in 12ms = 0.033776MB/s.  4 total partitions merged to 1.  Partition merge counts were {4:1, }
ERROR 05:11:54 Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MigrationStage:1,5,main]
java.lang.AssertionError: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.config.UTMetaData.addType(UTMetaData.java:145) ~[main/:na]
	at org.apache.cassandra.db.DefsTables.addType(DefsTables.java:412) ~[main/:na]
	at org.apache.cassandra.db.DefsTables.mergeTypes(DefsTables.java:365) ~[main/:na]
	at org.apache.cassandra.db.DefsTables.mergeSchema(DefsTables.java:182) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager$2.runMayThrow(MigrationManager.java:299) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_51]
	at java.util.concurrent.FutureTask.run(FutureTask.java:262) ~[na:1.7.0_51]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_51]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_51]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744) [na:1.7.0_51]
ERROR 05:11:54 Error occurred during processing of message.
java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.AssertionError
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:411) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager.announce(MigrationManager.java:281) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager.announceNewType(MigrationManager.java:216) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager.announceTypeUpdate(MigrationManager.java:247) ~[main/:na]
	at org.apache.cassandra.cql3.statements.AlterTypeStatement.announceMigration(AlterTypeStatement.java:139) ~[main/:na]
	at org.apache.cassandra.cql3.statements.SchemaAlteringStatement.execute(SchemaAlteringStatement.java:71) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:180) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:214) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:204) ~[main/:na]
	at org.apache.cassandra.thrift.CassandraServer.execute_cql3_query(CassandraServer.java:1973) ~[main/:na]
	at org.apache.cassandra.thrift.Cassandra$Processor$execute_cql3_query.getResult(Cassandra.java:4486) ~[thrift/:na]
	at org.apache.cassandra.thrift.Cassandra$Processor$execute_cql3_query.getResult(Cassandra.java:4470) ~[thrift/:na]
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39) ~[libthrift-0.9.1.jar:0.9.1]
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:39) ~[libthrift-0.9.1.jar:0.9.1]
	at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:194) ~[main/:na]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_51]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_51]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744) [na:1.7.0_51]
Caused by: java.util.concurrent.ExecutionException: java.lang.AssertionError
	at java.util.concurrent.FutureTask.report(FutureTask.java:122) ~[na:1.7.0_51]
	at java.util.concurrent.FutureTask.get(FutureTask.java:188) ~[na:1.7.0_51]
	at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:407) ~[main/:na]
	... 17 common frames omitted
Caused by: java.lang.AssertionError: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.config.UTMetaData.addType(UTMetaData.java:145) ~[main/:na]
	at org.apache.cassandra.db.DefsTables.addType(DefsTables.java:412) ~[main/:na]
	at org.apache.cassandra.db.DefsTables.mergeTypes(DefsTables.java:365) ~[main/:na]
	at org.apache.cassandra.db.DefsTables.mergeSchema(DefsTables.java:182) ~[main/:na]
	at org.apache.cassandra.service.MigrationManager$2.runMayThrow(MigrationManager.java:299) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_51]
	at java.util.concurrent.FutureTask.run(FutureTask.java:262) ~[na:1.7.0_51]
	... 3 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;trunk&lt;/p&gt;</environment>
        <key id="12695142">CASSANDRA-6705</key>
            <summary>ALTER TYPE &lt;type&gt; RENAME &lt;field&gt; fails sometime with java.lang.AssertionError: null</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="mishail">Mikhail Stepura</reporter>
                        <labels>
                    </labels>
                <created>Fri, 14 Feb 2014 05:14:07 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:53 +0000</updated>
                            <resolved>Mon, 24 Feb 2014 09:06:15 +0000</resolved>
                                        <fixVersion>2.1 beta2</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13902037" author="mishail" created="Fri, 14 Feb 2014 22:23:46 +0000"  >&lt;p&gt;In the current implementation &lt;tt&gt;org.apache.cassandra.db.marshal.ListType(org.apache.cassandra.db.marshal.UserType(bug,66697273745f74797065,66697273745f6669656c64:org.apache.cassandra.db.marshal.Int32Type))&lt;/tt&gt; in not compatible with &lt;tt&gt;org.apache.cassandra.db.marshal.ListType(org.apache.cassandra.db.marshal.UserType(bug,66697273745f74797065,66697273745f6669656c6464:org.apache.cassandra.db.marshal.Int32Type))&lt;/tt&gt;. Because &lt;tt&gt;ListType&lt;/tt&gt; uses &lt;tt&gt;isCompatibleWith&lt;/tt&gt; impementation from &lt;tt&gt;AbstractType&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;AbstractType.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isCompatibleWith(AbstractType&amp;lt;?&amp;gt; previous)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.equals(previous);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13902045" author="mishail" created="Fri, 14 Feb 2014 22:28:28 +0000"  >&lt;p&gt;What if we&apos;ll override &lt;tt&gt;isCompatibleWith&lt;/tt&gt; for Collections as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;CollectionType.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Override
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isCompatibleWith(AbstractType&amp;lt;?&amp;gt; previous)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; == previous)
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(previous &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; CollectionType))
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;;
        
        CollectionType tprev = (CollectionType) previous;
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.valueComparator().isCompatibleWith(tprev.valueComparator())
                &amp;amp;&amp;amp; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.nameComparator().isCompatibleWith(tprev.nameComparator());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Is it a valid approach?&lt;/p&gt;</comment>
                            <comment id="13903000" author="mishail" created="Mon, 17 Feb 2014 06:41:18 +0000"  >&lt;p&gt;Patch: Change the way how collections check their compatibility&lt;/p&gt;</comment>
                            <comment id="13908267" author="slebresne" created="Fri, 21 Feb 2014 12:59:22 +0000"  >&lt;p&gt;We definitively should add a proper isCompatibleWith method for CollectionType.  If we do so however, it means we&apos;ll allow altering the type of a collection column, which is a good thing, but is not handle properly currently because collection type are aliases in the comparator and so we must make sure we propagate a change to the comparator too. That case (altering a collection and not propagating it to the comparator) is also not handled by AlterTypeStatement currently. This also revealed a bug in ColumnToCollectionType.isCompatibleWith which has arguments inverted when calling isCompatibleWith on the collection it contains (it didn&apos;t matter so far since isCompatibleWith was equality until this patch).&lt;/p&gt;

&lt;p&gt;On the added isCompatibleWith, 2 remarks:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;we shouldn&apos;t consider 2 different collection compatible, so previous should not just be a CollectionType but really of the same class than &lt;tt&gt;this&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;for the valueComparator, we can use isValueCompatibleWith since we know it&apos;s always applied to a cell value and thus preserving the sort order is not required.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Attaching a v2 that handle the remarks above. I&apos;ve pushed &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/commit/b208cd6462b823d400e131339ab10911ab570297&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;some dtests&lt;/a&gt; for this too.&lt;/p&gt;</comment>
                            <comment id="13909545" author="mishail" created="Sat, 22 Feb 2014 21:24:39 +0000"  >&lt;p&gt;LGTM as far as I comprehend&lt;/p&gt;</comment>
                            <comment id="13910115" author="slebresne" created="Mon, 24 Feb 2014 09:06:15 +0000"  >&lt;p&gt;Committed then, thanks&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12649152">CASSANDRA-5590</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12630300" name="6705-2.txt" size="8953" author="slebresne" created="Fri, 21 Feb 2014 12:59:22 +0000"/>
                            <attachment id="12629319" name="trunk-6705.patch" size="1340" author="mishail" created="Mon, 17 Feb 2014 06:41:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>373650</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1se33:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>373950</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326275">2.1 beta1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>mishail</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mishail]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>