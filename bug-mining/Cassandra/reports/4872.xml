<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:09:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13756] StreamingHistogram is not thread safe</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13756</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When we test C*3 in shadow cluster, we notice after a period of time, several data node suddenly run into 100% cpu and stop process query anymore.&lt;/p&gt;

&lt;p&gt;After investigation, we found that threads are stuck on the sum() in streaminghistogram class. Those are jmx threads that working on expose getTombStoneRatio metrics (since jmx is kicked off every 3 seconds, there is a chance that multiple jmx thread is access streaminghistogram at the same time).  &lt;/p&gt;

&lt;p&gt;After further investigation, we find that the optimization in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13038&quot; title=&quot;33% of compaction time spent in StreamingHistogram.update()&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13038&quot;&gt;&lt;del&gt;CASSANDRA-13038&lt;/del&gt;&lt;/a&gt; led to a spool flush every time when we call sum(). Since TreeMap is not thread safe, threads will be stuck when multiple threads visit sum() at the same time.&lt;/p&gt;

&lt;p&gt;There are two approaches to solve this issue. &lt;/p&gt;

&lt;p&gt;The first one is to add a lock to the flush in sum() which will introduce some extra overhead to streaminghistogram.&lt;/p&gt;

&lt;p&gt;The second one is to avoid streaminghistogram to be access by multiple threads. For our specific case, is to remove the metrics we added.  &lt;/p&gt;</description>
                <environment></environment>
        <key id="13093973">CASSANDRA-13756</key>
            <summary>StreamingHistogram is not thread safe</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jjirsa">Jeff Jirsa</assignee>
                                    <reporter username="xiaxiangzhou">xiangzhou xia</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Aug 2017 01:45:34 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:01 +0000</updated>
                            <resolved>Tue, 5 Sep 2017 16:58:15 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>16</watches>
                                                                                                                <comments>
                            <comment id="16131453" author="jjirsa" created="Thu, 17 Aug 2017 23:00:15 +0000"  >&lt;p&gt;Shouldn&apos;t need a version for trunk, but &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; if you can check me there to be sure that&apos;d be nice (I think in the faster rewrite for trunk, we now &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/utils/streamhist/StreamingTombstoneHistogramBuilder.java#L182-L186&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt; a snapshot that is no longer modified on read).&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; branch &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; utest &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; dtest &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/tree/cassandra-3.0-13756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/jeffjirsa/cassandra/tree/cassandra-3.0-13756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 circle&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/221/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/tree/cassandra-3.11-13756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/jeffjirsa/cassandra/tree/cassandra-3.11-13756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11 circle&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/222/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11 dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16131480" author="jasobrown" created="Thu, 17 Aug 2017 23:33:45 +0000"  >&lt;p&gt;+1 on the changes, and please commit if/when the tests pass.&lt;/p&gt;

&lt;p&gt;wrt trunk, yes, I think it should be safe due to the snapshots we create and access from &lt;tt&gt;StatsMetadata&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16131534" author="dikanggu" created="Fri, 18 Aug 2017 00:33:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt;, thanks for fixing it!&lt;/p&gt;</comment>
                            <comment id="16131721" author="jjirsa" created="Fri, 18 Aug 2017 04:55:42 +0000"  >&lt;p&gt;utests are clean, waiting on dtests. Apparently ~8 of the jenkins slaves are offline, so little bit delayed.&lt;/p&gt;</comment>
                            <comment id="16135593" author="hkroger" created="Mon, 21 Aug 2017 18:46:44 +0000"  >&lt;p&gt;Linking to SSTable Corruption ticket which this same bug seems to cause.&lt;/p&gt;</comment>
                            <comment id="16135664" author="hkroger" created="Mon, 21 Aug 2017 19:34:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; Serialization probably needs to be synchronized somehow as well. Seems like sstable statistics can be corrupted at the moment because of this issue and although I am not sure it looks like that this patch probably doesn&apos;t address.&lt;/p&gt;</comment>
                            <comment id="16136625" author="hkroger" created="Tue, 22 Aug 2017 10:45:46 +0000"  >&lt;p&gt;Created a branch in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13752&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-13752&lt;/a&gt; for serialization fix.&lt;/p&gt;</comment>
                            <comment id="16143747" author="hkroger" created="Mon, 28 Aug 2017 12:58:12 +0000"  >&lt;p&gt;Cassandra cleanup is probably also affected by this.&lt;/p&gt;</comment>
                            <comment id="16145903" author="jjirsa" created="Tue, 29 Aug 2017 18:56:08 +0000"  >&lt;p&gt;Pushed new branches up based on what we learned from 13752:&lt;/p&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; branch &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; utest &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; dtest &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/tree/cassandra-3.0-13756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/jeffjirsa/cassandra/tree/cassandra-3.0-13756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 circle&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/224/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/tree/cassandra-3.11-13756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/jeffjirsa/cassandra/tree/cassandra-3.11-13756&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11 circle&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/225/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11 dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


</comment>
                            <comment id="16145944" author="jasobrown" created="Tue, 29 Aug 2017 19:18:14 +0000"  >&lt;p&gt;I&apos;m +1 on the snapshot version of the code. You may want to wait a day to see if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; has any additional feedback.&lt;/p&gt;</comment>
                            <comment id="16146808" author="krummas" created="Wed, 30 Aug 2017 07:27:23 +0000"  >&lt;p&gt;We should probably remove &lt;tt&gt;synchronized&lt;/tt&gt; from &lt;tt&gt;flushHistogram&lt;/tt&gt; and &lt;tt&gt;equals&lt;/tt&gt; in the builder or make it actually thread safe and add it to the &lt;tt&gt;update&lt;/tt&gt; methods as well (but the builder should never be updated by several threads so removing it should be ok)&lt;/p&gt;

&lt;p&gt;Other than that, +1&lt;/p&gt;</comment>
                            <comment id="16153977" author="jjirsa" created="Tue, 5 Sep 2017 16:58:15 +0000"  >&lt;p&gt;Thanks all. Marcus, I&apos;ve addressed your comments on commit. Committed as &lt;tt&gt;ef5ac1a4abe4fb5f407c0a24f4bc808932c5d7a2&lt;/tt&gt; to 3.0 and 3.11, and &lt;tt&gt;merge -s ours&lt;/tt&gt; to trunk (no changes but CHANGES.txt) with Jason and Marcus both listed as reviewers. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13093731">CASSANDRA-13752</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13089054">CASSANDRA-13718</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13027729">CASSANDRA-13038</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13093731">CASSANDRA-13752</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13089054">CASSANDRA-13718</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jjirsa]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 11 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3io8v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12339942">3.0.13</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>