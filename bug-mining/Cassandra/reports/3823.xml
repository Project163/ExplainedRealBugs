<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:57:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10155] 2i key cache load fails</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10155</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9265&quot; title=&quot;Add checksum to saved cache files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9265&quot;&gt;&lt;del&gt;CASSANDRA-9265&lt;/del&gt;&lt;/a&gt; changed how key cache content is serialized to disk. It uses &lt;tt&gt;UUID cfId&lt;/tt&gt; to generate the file path for each &lt;tt&gt;ColumnFamilyStore&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Since &lt;tt&gt;cfId&lt;/tt&gt; of a secondary index is the same as for the base table, the key-cache files for 2i&apos;s and the base are the same. This will/may lead to deserialization failures on restart for tables with at least one 2i.&lt;/p&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danchia&quot; class=&quot;user-hover&quot; rel=&quot;danchia&quot;&gt;danchia&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12858049">CASSANDRA-10155</key>
            <summary>2i key cache load fails</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aweisberg">Ariel Weisberg</assignee>
                                    <reporter username="snazy">Robert Stupp</reporter>
                        <labels>
                    </labels>
                <created>Sat, 22 Aug 2015 10:31:08 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:59 +0000</updated>
                            <resolved>Wed, 16 Sep 2015 20:05:21 +0000</resolved>
                                        <fixVersion>2.1.10</fixVersion>
                    <fixVersion>2.2.2</fixVersion>
                    <fixVersion>3.0.0 rc1</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14708197" author="danchia" created="Sat, 22 Aug 2015 21:43:36 +0000"  >&lt;p&gt;I&apos;m not sure this is a problem - while the cfId is the same, the cfName itself for indexes is different.&lt;/p&gt;</comment>
                            <comment id="14708338" author="snazy" created="Sun, 23 Aug 2015 10:16:48 +0000"  >&lt;p&gt;Right, cfName is different for base table and 2i.&lt;br/&gt;
But the only parameter to &lt;tt&gt;AutoSavingCache#getCacheDataPath&lt;/tt&gt;/&lt;tt&gt;getCacheCrcPath&lt;/tt&gt; is cfId - so &lt;tt&gt;DatabaseDescriptor.getSerializedCachePath&lt;/tt&gt; can only return the file name for the base table. I.e. a &lt;tt&gt;AutoSavingCache#loadSaved&lt;/tt&gt; will access the same file for base table and 2i {{ColumnFamilyStore}}s.&lt;/p&gt;

&lt;p&gt;EDIT: I&apos;m in favor of making cfId (or some other identifier) unique (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10028&quot; title=&quot;Unique ID per ColumnFamilyStore&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10028&quot;&gt;CASSANDRA-10028&lt;/a&gt;) since there&apos;s a lot of special casing for 2i names.&lt;/p&gt;</comment>
                            <comment id="14708617" author="danchia" created="Mon, 24 Aug 2015 01:06:12 +0000"  >&lt;p&gt;Ah good call. That was actually introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7784&quot; title=&quot;DROP table leaves the counter and row cache in a temporarily inconsistent state that, if saved during, will cause an exception to be thrown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7784&quot;&gt;&lt;del&gt;CASSANDRA-7784&lt;/del&gt;&lt;/a&gt;, I&apos;ll investigate further.&lt;/p&gt;</comment>
                            <comment id="14708635" author="danchia" created="Mon, 24 Aug 2015 01:35:08 +0000"  >&lt;p&gt;It looks like switching to use cfId exclusively in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7784&quot; title=&quot;DROP table leaves the counter and row cache in a temporarily inconsistent state that, if saved during, will cause an exception to be thrown&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7784&quot;&gt;&lt;del&gt;CASSANDRA-7784&lt;/del&gt;&lt;/a&gt; introduced this regression, so it will be found 2.1 as well.&lt;/p&gt;

&lt;p&gt;Looks like the right fix is to re-introduce pathInfo - what do people think?&lt;/p&gt;</comment>
                            <comment id="14712644" author="snazy" created="Wed, 26 Aug 2015 07:23:26 +0000"  >&lt;p&gt;Just thinking out: is it possible that this is the cause for some previous cache-load failures / &quot;corrupted&quot; files?&lt;/p&gt;</comment>
                            <comment id="14715396" author="aweisberg" created="Wed, 26 Aug 2015 19:47:42 +0000"  >&lt;p&gt;The fail may go deeper than just filenames.&lt;/p&gt;

&lt;p&gt;I copied KeyCacheCQLTest from Robert&apos;s in progress work to test saving and loading with a 2i.&lt;/p&gt;

&lt;p&gt;I added &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        CacheService.instance.keyCache.submitWrite(&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE).get();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;to the end of KeyCacheCQLTest.test2iKeyCachePaths and got an exception&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.IndexOutOfBoundsException: Index: 3, Size: 3
	at java.util.ArrayList.rangeCheck(ArrayList.java:653) ~[na:1.8.0_51]
	at java.util.ArrayList.get(ArrayList.java:429) ~[na:1.8.0_51]
	at org.apache.cassandra.db.ClusteringPrefix$Serializer.valuesWithoutSizeSerializedSize(ClusteringPrefix.java:327) ~[main/:na]
	at org.apache.cassandra.db.Clustering$Serializer.serializedSize(Clustering.java:143) ~[main/:na]
	at org.apache.cassandra.db.ClusteringPrefix$Serializer.serializedSize(ClusteringPrefix.java:282) ~[main/:na]
	at org.apache.cassandra.db.Serializers$1.serializedSize(Serializers.java:68) ~[main/:na]
	at org.apache.cassandra.db.Serializers$1.serializedSize(Serializers.java:1) ~[main/:na]
	at org.apache.cassandra.io.sstable.IndexHelper$IndexInfo$Serializer.serializedSize(IndexHelper.java:187) ~[main/:na]
	at org.apache.cassandra.db.RowIndexEntry$IndexedEntry.promotedSize(RowIndexEntry.java:235) ~[main/:na]
	at org.apache.cassandra.db.RowIndexEntry$Serializer.serialize(RowIndexEntry.java:125) ~[main/:na]
	at org.apache.cassandra.service.CacheService$KeyCacheSerializer.serialize(CacheService.java:455) ~[main/:na]
	at org.apache.cassandra.service.CacheService$KeyCacheSerializer.serialize(CacheService.java:1) ~[main/:na]
	at org.apache.cassandra.cache.AutoSavingCache$Writer.saveCache(AutoSavingCache.java:292) ~[main/:na]
	at org.apache.cassandra.db.compaction.CompactionManager$12.run(CompactionManager.java:1279) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_51]
	at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_51]
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_51]
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_51]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_51]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Digging into this one now.&lt;/p&gt;</comment>
                            <comment id="14726103" author="aweisberg" created="Tue, 1 Sep 2015 20:18:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...aweisberg:C-10155-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Have a 3.0 change for this.&lt;/a&gt; I need to make sure existing tests run, and then make sure all the new code is tested.&lt;/p&gt;

&lt;p&gt;My code for consuming reads during cache load is probably uncovered and there are dropped table/keyspace cases that need coverage.&lt;/p&gt;

&lt;p&gt;I also need to rebase it to 2.1 and then figure out the right way to merge forward.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;There is now only one saved cache file for each kind of key (row, key, counter)&lt;/li&gt;
	&lt;li&gt;This means that loading of each kind of cache is single threaded. Previous code loaded caches synchronously at startup so it was probably single threaded anyways.&lt;/li&gt;
	&lt;li&gt;Loading is async in its own thread for each cache so key and row cache can load at the same time&lt;/li&gt;
	&lt;li&gt;Caches could load concurrently with other startup activities, but there didn&apos;t seem to be a desire to have that happen so startup blocks until they are loaded&lt;/li&gt;
	&lt;li&gt;Cache keys now contain the keyspace and CF name instead of UUID. There is no footprint change for on heap caches because they are POJOs pointing to a canonical object. Off heap will potentially see an increase in size and time since it will have to store and decode two strings instead of a UUID.&lt;/li&gt;
	&lt;li&gt;Schema now has a function that will look up a CF, even if it is an index, correctly.&lt;/li&gt;
	&lt;li&gt;Cache loading used to collect a future per cache entry in a list! For an off heap cache that is larger than the Java heap this is a problem. Modified to bound the number of pending reads and consume read results by loading them into the cache as they come in.&lt;/li&gt;
	&lt;li&gt;Promoted errors in loading caches to info level that were debug.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14734950" author="aweisberg" created="Tue, 8 Sep 2015 15:02:48 +0000"  >&lt;p&gt;I made a 2.1, 2.2, and 3.0 branch for this. Looks like they all need rebasing again. I&apos;ll get that done now.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...aweisberg:CASSANDRA-10155-2.1?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1 code&lt;/a&gt;, &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10155-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;, &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10155-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...aweisberg:CASSANDRA-10155-2.2?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 code&lt;/a&gt;, &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10155-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;, &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10155-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...aweisberg:CASSANDRA-10155-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 code&lt;/a&gt;, &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10155-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;, &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/aweisberg/job/aweisberg-CASSANDRA-10155-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14739696" author="snazy" created="Thu, 10 Sep 2015 22:02:53 +0000"  >&lt;p&gt;From a very quick view the patches look very good. Have some (mostly minor) comments, though:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;DatabaseDescriptor#getSerializedCachePath&lt;/tt&gt; can you replace the StringBuilder with a simple string concatenation? Feels more readable than a StringBuilder.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;AutoSavingCache.Writer.saveCache()&lt;/tt&gt; can you just remove the &lt;tt&gt;os&lt;/tt&gt; variable and just initialie &lt;tt&gt;writer&lt;/tt&gt; using &lt;tt&gt;writer = new DataOutputStreamPlus(streamFactory.getOutputStream(tempCacheFile));&lt;/tt&gt;?&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;AutoSavingCache.loadSavedImpl()&lt;/tt&gt; can be moved to loadSaved(). Both methods try-catch and call JVMStabilityInspector (in the catch, of course).&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;AutoSavingCache.loadSavedAsync(final String name)&lt;/tt&gt;: can&#8217;t we just derive the name from the &lt;tt&gt;cacheType&lt;/tt&gt;&#160;instance field?&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;AutoSavingCache.loadSavedImpl()&lt;/tt&gt; please add a comment describing where &lt;tt&gt;String ksname = in.readUTF();&lt;/tt&gt; (and cfname) are serialized.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;CassandraDaemon&lt;/tt&gt;: please remove the new, unused imports.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;CassandraDaemon&lt;/tt&gt;: change the error/warn message &lt;tt&gt;&quot;Error loading row and key cache asynchronously&#8221;&lt;/tt&gt; to &lt;tt&gt;&#8220;Error loading key or row cache&#8221;&lt;/tt&gt; (so leaving out asynchronously, as it isn&#8217;t from a user&#8217;s perspective). Similar for &lt;tt&gt;StorageService.initServer()&lt;/tt&gt; where it loads the counter cache.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;CacheService.*CacheSerializer.serializer()&lt;/tt&gt; please add a comment describing why &lt;tt&gt;out.write(cfs.metadata.ksAndCFBytes);&lt;/tt&gt; are not deserialised in the corresponding &lt;tt&gt;deserialize&lt;/tt&gt; but where these are deserialized (AutoSavingCache).&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;CacheKey&lt;/tt&gt;: just thinking whether it&#8217;s better to replace &lt;tt&gt;Pair&amp;lt;String,String&amp;gt; ksAndCFName&lt;/tt&gt;&#160;with a &lt;tt&gt;byte[] ksAndCFName&lt;/tt&gt; as it is cheaper to serialize and deserialize. OTOH you need some object to pass to &lt;tt&gt;getColumnFamilyStoreIncludingIndexes()&lt;/tt&gt;. Or put both &lt;tt&gt;byte[]&lt;/tt&gt; and &lt;tt&gt;Pair&lt;/tt&gt; fields into &lt;tt&gt;CacheKey&lt;/tt&gt; so that serialization can just use the &lt;tt&gt;byte[]&lt;/tt&gt; but we still have the &lt;tt&gt;Pair&lt;/tt&gt; available. WDYT? (Latter applies to 2.2/3.0)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;CacheKey&lt;/tt&gt;: BTW: good catch making this an abstract class. Can you make the derived classes &lt;tt&gt;final&lt;/tt&gt;?&lt;/li&gt;
	&lt;li&gt;Field name &lt;tt&gt;ksAndCFName&lt;/tt&gt; doesn&#8217;t make really clear that it can also contain the name of the secondary index. &lt;tt&gt;ksAndCfAndMaybe2iName&lt;/tt&gt;&#160;doesn&#8217;t feel better though - don&#8217;t even know whether we have a known term for this at all.&lt;/li&gt;
	&lt;li&gt;Regarding your comment in &lt;tt&gt;Schema.getColumnFamilyStoreIncludingIndexes()&lt;/tt&gt; (3.0) &lt;em&gt;&#8221;Shouldn&apos;t ask for a backing table if there is none so just throw?&#8221;&lt;/em&gt; - that&#8217;s actually a good question. How&#8217;s that handled in 2.1/2.2? I think there should be a unit test that tests exactly this behaviour - a C* 2i on one column and a custom, table-less index on another column. Only the 2i should get entries in the key-cache at all - non-table backed indexes must not.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Will continue with some code digging.&lt;/p&gt;</comment>
                            <comment id="14739789" author="aweisberg" created="Thu, 10 Sep 2015 22:52:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;Regarding your comment in Schema.getColumnFamilyStoreIncludingIndexes() (3.0) &#8221;Shouldn&apos;t ask for a backing table if there is none so just throw?&#8221; - that&#8217;s actually a good question. How&#8217;s that handled in 2.1/2.2? I think there should be a unit test that tests exactly this behaviour - a C* 2i on one column and a custom, table-less index on another column. Only the 2i should get entries in the key-cache at all - non-table backed indexes must not.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Hah, well I was just going to let it NPE naively assuming that I haven&apos;t actually made anything worse. I guess I might have since before it would get the base table. That&apos;s not a good assumption so yeah I&apos;ll make a test.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;CacheKey: just thinking whether it&#8217;s better to replace Pair&amp;lt;String,String&amp;gt; ksAndCFName with a byte[] ksAndCFName as it is cheaper to serialize and deserialize. OTOH you need some object to pass to getColumnFamilyStoreIncludingIndexes(). Or put both byte[] and Pair fields into CacheKey so that serialization can just use the byte[] but we still have the Pair available. WDYT? (Latter applies to 2.2/3.0)&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;m not sure we can really win here? &lt;/p&gt;

&lt;p&gt;The problem with byte[] ksAndCFName is that everything else that uses the bimap in Schema is going to have two strings and not the bytes.&lt;/p&gt;

&lt;p&gt;When cache keys deserialize it will have the bytes, but not the Pair.&lt;/p&gt;

&lt;p&gt;Someone has to be the loser if we change it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Field name ksAndCFName doesn&#8217;t make really clear that it can also contain the name of the secondary index. ksAndCfAndMaybe2iName doesn&#8217;t feel better though - don&#8217;t even know whether we have a known term for this at all.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Indexes are CFs that share a UUID with some other CFs. I don&apos;t see it as so ambiguous at that stage. ksAndCFOr2i? Nothing about that makes me feel better &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14740686" author="snazy" created="Fri, 11 Sep 2015 12:17:50 +0000"  >&lt;p&gt;Fair enough - let&apos;s stick with the &lt;tt&gt;Pair&lt;/tt&gt; then. And with &lt;tt&gt;ksAndCFName&lt;/tt&gt; unless someone else has a neat idea.&lt;/p&gt;</comment>
                            <comment id="14790981" author="snazy" created="Wed, 16 Sep 2015 19:16:48 +0000"  >&lt;p&gt;One thing I didn&#8217;t recognize before is that I &lt;b&gt;think&lt;/b&gt; using &lt;em&gt;ksAndCfName&lt;/em&gt; instead of &lt;em&gt;cfId&lt;/em&gt; introduces a possible data race condition. Imagine the following sequence of operations:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;CREATE TABLE foo.bar &#8230;&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;INSERT INTO foo.bar (pk, val) VALUES (1,1)&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;SELECT * FROM foo.bar WHERE pk=1&lt;/tt&gt; returns one row as expected&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;row cache saved to disk&lt;/em&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;DROP TABLE foo.bar&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;CREATE TABLE foo.bar &#8230;&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;SELECT * FROM foo.bar WHERE pk=1&lt;/tt&gt; returns no rows as expected&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;stop node&lt;/em&gt;&lt;/li&gt;
	&lt;li&gt;&lt;em&gt;start node, caches are loaded&lt;/em&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;SELECT * FROM foo.bar WHERE pk=1&lt;/tt&gt; returns one row - as row-cache contains the row&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I think similar problems are possible but not that easily reproducible with key and counter caches. Key cache is probably the worst candidate as bloom filter check is executed before key cache is consulted.&lt;/p&gt;

&lt;p&gt;I think we have to calculate the schema digest before starting to save the cache and serialize that digest with in the saved-cache file. Upon loading the cache file, compare the digest of the current schema against the digest in the saved cache file and prevent loading if the digests don&#8217;t match.&lt;/p&gt;

&lt;p&gt;NITs:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;AutoSavingCache.CacheSerializer&lt;/tt&gt;: remove abstract from interface methods.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;RowCacheKey.compareTo&lt;/tt&gt;: we should remove &lt;tt&gt;Comparable&lt;/tt&gt; from &lt;tt&gt;RowCacheKey&lt;/tt&gt; as it seems unused (at least in 3.0).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Beside that all patches LGTM&lt;/p&gt;</comment>
                            <comment id="14791041" author="snazy" created="Wed, 16 Sep 2015 20:05:21 +0000"  >&lt;p&gt;+1 (race condition addressed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10359&quot; title=&quot;Saved caches use ambigous keyspace and CF name to identify tables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10359&quot;&gt;&lt;del&gt;CASSANDRA-10359&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Committed as e889ee408bec5330c312ff6b72a81a0012fdf2a5&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12826026">CASSANDRA-9265</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 9 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2j8tb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>snazy</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332361">3.0 alpha 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>