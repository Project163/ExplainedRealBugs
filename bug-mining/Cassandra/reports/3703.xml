<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:55:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7757] Possible Atomicity Violations in StreamSession and ThriftSessionManager</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7757</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;m developing a tool for atomicity violation detection and I think it have found two atomicity violations in cassandra.&lt;/p&gt;

&lt;p&gt;In org.apache.cassandra.streaming.StreamSession there might be an atomicity violation in method addTransferFiles(), lines 310-314:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;310:     StreamTransferTask task = transfers.get(cfId);
            if (task == null)
            {
                task = new StreamTransferTask(this, cfId);
314:         transfers.put(cfId, task);
            }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A concurrent thread can insert a transfer with the same uuid creating two StreamTransferTask, and only one get into &quot;transfers&quot;.&lt;/p&gt;

&lt;p&gt;In org.apache.cassandra.thrift.ThriftSessionManager, a simular situation can occur in method currentSession(), lines 57-61:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;57:  ThriftClientState cState = activeSocketSessions.get(socket);
        if (cState == null)
        {
            cState = new ThriftClientState(socket);
51:       activeSocketSessions.put(socket, cState);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12733522">CASSANDRA-7757</key>
            <summary>Possible Atomicity Violations in StreamSession and ThriftSessionManager</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pauloricardomg">Paulo Motta</assignee>
                                    <reporter username="orium">Diogo Sousa</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Aug 2014 15:41:50 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:37 +0000</updated>
                            <resolved>Thu, 30 Jul 2015 01:00:35 +0000</resolved>
                                        <fixVersion>2.1.9</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>3.0 alpha 1</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14249152" author="jbellis" created="Tue, 16 Dec 2014 23:17:03 +0000"  >&lt;p&gt;Is this still relevant to 2.1?&lt;/p&gt;</comment>
                            <comment id="14629112" author="pauloricardomg" created="Thu, 16 Jul 2015 03:08:26 +0000"  >&lt;p&gt;in StreamSession I didn&apos;t find any code path leading to potential atomicity violations during creation of transfer task.&lt;/p&gt;

&lt;p&gt;in the ThriftSessionManager, although unlikely, an atomicity violation can happen if a client initiates multiple simultaneous connections to cassandra thrift server.&lt;/p&gt;

&lt;p&gt;in both cases, I replaced the unsafe ConcurrentHashMap.put with the atomic ConcurrentHashMap.putIfAbsent to prevent violations.&lt;/p&gt;</comment>
                            <comment id="14629113" author="pauloricardomg" created="Thu, 16 Jul 2015 03:09:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; could you please review?&lt;/p&gt;</comment>
                            <comment id="14629979" author="yukim" created="Thu, 16 Jul 2015 16:41:02 +0000"  >&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-7757-2.1-testall/2/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-7757-2.1-testall/2/testReport/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;putIfAbsent&lt;/tt&gt; returns &lt;tt&gt;null&lt;/tt&gt; if there is nothing associated precivously with the key. This is why most of the tests are failing with NPE.&lt;/p&gt;</comment>
                            <comment id="14630638" author="pauloricardomg" created="Fri, 17 Jul 2015 01:23:14 +0000"  >&lt;p&gt;oops, my bad! I updated the 2.1 patch link and added the 2.2 patch (applies cleanly to trunk).&lt;/p&gt;

&lt;p&gt;Here are test results:&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-7757-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1 dtest&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-7757-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1 testall&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-7757-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 dtest&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-7757-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 testall&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14646926" author="yukim" created="Wed, 29 Jul 2015 23:47:24 +0000"  >&lt;p&gt;I think the second use of &lt;tt&gt;get()&lt;/tt&gt; is unnecessary.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/pull/1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pauloricardomg/cassandra/pull/1&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14646938" author="pauloricardomg" created="Wed, 29 Jul 2015 23:57:34 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14647002" author="yukim" created="Thu, 30 Jul 2015 01:00:35 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411550</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 16 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yswv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411541</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>