<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:27:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18710] Test failure: org.apache.cassandra.io.DiskSpaceMetricsTest.testFlushSize-.jdk17 (from org.apache.cassandra.io.DiskSpaceMetricsTest-.jdk17)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18710</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Seen here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/1644/testReport/org.apache.cassandra.io/DiskSpaceMetricsTest/testFlushSize__jdk17/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/1644/testReport/org.apache.cassandra.io/DiskSpaceMetricsTest/testFlushSize__jdk17/&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;%C2%A0&quot;&gt;&lt;/a&gt;&#160;&lt;/h3&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error Message
expected:&amp;lt;7200.0&amp;gt; but was:&amp;lt;1367.83970468544&amp;gt;

Stacktrace
junit.framework.AssertionFailedError: expected:&amp;lt;7200.0&amp;gt; but was:&amp;lt;1367.83970468544&amp;gt; at org.apache.cassandra.io.DiskSpaceMetricsTest.testFlushSize(DiskSpaceMetricsTest.java:119) at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77) at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13545356">CASSANDRA-18710</key>
            <summary>Test failure: org.apache.cassandra.io.DiskSpaceMetricsTest.testFlushSize-.jdk17 (from org.apache.cassandra.io.DiskSpaceMetricsTest-.jdk17)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jlewandowski">Jacek Lewandowski</assignee>
                                    <reporter username="edimitrova">Ekaterina Dimitrova</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Jul 2023 22:23:50 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:53 +0000</updated>
                            <resolved>Fri, 17 Nov 2023 12:10:55 +0000</resolved>
                                        <fixVersion>5.0-beta1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Test/unit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17749897" author="brandon.williams" created="Tue, 1 Aug 2023 15:19:08 +0000"  >&lt;p&gt;I suspect we need to force a flush to avoid races here.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-18710-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1156/workflows/79383b9c-7759-4b21-afc4-7c5098e0ea4c/jobs/40077&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;unit repeat&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17750466" author="edimitrova" created="Wed, 2 Aug 2023 20:11:00 +0000"  >&lt;p&gt;I am not able to reproduce the issue in CircleCI even before the patch.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra?branch=18710-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra?branch=18710-trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;But it seems reasonable to me. Also, I can see how timing in Jenkins could influence it to fail that way. I think the flush was just forgotten when the test was written, +1&lt;/p&gt;</comment>
                            <comment id="17750468" author="brandon.williams" created="Wed, 2 Aug 2023 20:14:04 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="17754103" author="edimitrova" created="Mon, 14 Aug 2023 13:35:57 +0000"  >&lt;p&gt;&#160;I can see again failures in Jenkins:&lt;br/&gt;
&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/1669/testReport/junit/org.apache.cassandra.io/DiskSpaceMetricsTest/testFlushSize_compression_jdk17/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/1669/testReport/junit/org.apache.cassandra.io/DiskSpaceMetricsTest/testFlushSize_compression_jdk17/&lt;/a&gt;&lt;/p&gt;
&lt;h3&gt;&lt;a name=&quot;%C2%A0&quot;&gt;&lt;/a&gt;&#160;&lt;/h3&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Error Message
expected:&amp;lt;7313.0&amp;gt; but was:&amp;lt;2837.567441189888&amp;gt;

Stacktrace
junit.framework.AssertionFailedError: expected:&amp;lt;7313.0&amp;gt; but was:&amp;lt;2837.567441189888&amp;gt; at org.apache.cassandra.io.DiskSpaceMetricsTest.testFlushSize(DiskSpaceMetricsTest.java:120) at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77) at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17755619" author="brandon.williams" created="Thu, 17 Aug 2023 16:32:22 +0000"  >&lt;p&gt;Now I suspect the problem is adding the flush fixed the instance where we need to flush, but also caused a problem when we don&apos;t, making us flush a small value.&lt;/p&gt;</comment>
                            <comment id="17755689" author="brandon.williams" created="Thu, 17 Aug 2023 20:36:40 +0000"  >&lt;p&gt;Actually, adding the flush was probably incorrect since insertN &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/test/unit/org/apache/cassandra/io/DiskSpaceMetricsTest.java#L139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;does that&lt;/a&gt;. Something must be wrong with the metrics, because if I dig into nightlies for the &lt;a href=&quot;https://nightlies.apache.org/cassandra/trunk/Cassandra-trunk-test-compression/1741/Cassandra-trunk-test-compression/jdk=jdk_17_latest,label=cassandra,split=6/build/test/logs/compression.jdk17/TEST-org.apache.cassandra.io.DiskSpaceMetricsTest.log.xz&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;log&lt;/a&gt; from your last failure, the smallest flush is 4.926KiB.&lt;/p&gt;</comment>
                            <comment id="17758650" author="brandon.williams" created="Thu, 24 Aug 2023 16:27:52 +0000"  >&lt;p&gt;I don&apos;t see anything wrong with the metrics so I&apos;m currently out of ideas here.  I did manage to repro once in &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1220/workflows/e0c90c4a-115b-45f7-a798-c5e21dc937f9/jobs/46827/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;, with the mistaken flush commit removed.&lt;/p&gt;</comment>
                            <comment id="17758711" author="edimitrova" created="Thu, 24 Aug 2023 19:20:53 +0000"  >&lt;p&gt;This test was added as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18397&quot; title=&quot;CEP-26: Unified Compaction Strategy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18397&quot;&gt;&lt;del&gt;CASSANDRA-18397&lt;/del&gt;&lt;/a&gt; - &lt;a href=&quot;https://github.com/apache/cassandra/commit/957eca2fb53477d56bdc9a97c612f1fbecfb5d41#diff-af921b889c103e8ba6c4c21566a6b1264b7ebcea8d8c374a9105252418618e6cR99&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/957eca2fb53477d56bdc9a97c612f1fbecfb5d41#diff-af921b889c103e8ba6c4c21566a6b1264b7ebcea8d8c374a9105252418618e6cR99&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;From the PR in that ticket, it seems that there was a try to fix the flakiness there (that explains why it is very hard to reproduce in CircleCI)- &lt;a href=&quot;https://github.com/blambov/cassandra/commit/6b7e755db20bb1b63dd18f3a03830b8dee909672&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/blambov/cassandra/commit/6b7e755db20bb1b63dd18f3a03830b8dee909672&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; will have some hints here?&#160;&lt;/p&gt;</comment>
                            <comment id="17759002" author="blambov" created="Fri, 25 Aug 2023 10:59:22 +0000"  >&lt;p&gt;This kind of flakiness usually comes from truncation of a table from a different concurrently completed test causing a flush of the whole keyspace.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;KEYSPACE_PER_TEST&lt;/tt&gt; changes fix this, and I must have done a repeated run on CircleCI to verify (I don&apos;t remember if I really did at the time).&lt;/p&gt;</comment>
                            <comment id="17759006" author="brandon.williams" created="Fri, 25 Aug 2023 11:07:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;from a different concurrently completed test&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am running this test in isolation, however.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I must have done a repeated run on CircleCI to verify&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It is super hard to repro there, we probably wouldn&apos;t even know about this if it weren&apos;t for Jenkins.&lt;/p&gt;</comment>
                            <comment id="17764676" author="brandon.williams" created="Wed, 13 Sep 2023 13:31:28 +0000"  >&lt;p&gt;Unassigning in case someone else wants to take a shot, I have more tractable tickets to work on but I&apos;ll come back to this if it&apos;s still open later.&lt;/p&gt;</comment>
                            <comment id="17774139" author="brandon.williams" created="Wed, 11 Oct 2023 16:41:29 +0000"  >&lt;p&gt;I&apos;m back with a new plan.  If we run with the idea that &lt;em&gt;something&lt;/em&gt; else is interfering with the flushes and the metrics are accurate, then maybe we can &lt;a href=&quot;https://github.com/driftx/cassandra/commit/6e5ae2150c5ad0973b056d47f9d7e36cdbf7525b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;detect it early&lt;/a&gt; and note which file it is, then trace that back through the logs to figure out what is causing it.  Now I just need to reproduce again.&lt;/p&gt;</comment>
                            <comment id="17774918" author="brandon.williams" created="Fri, 13 Oct 2023 14:05:57 +0000"  >&lt;p&gt;Running with &lt;a href=&quot;https://github.com/driftx/cassandra/commit/286bb5cd7c36c62e541cc79b025931215a982bc3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this patch&lt;/a&gt;, I&apos;ve managed to reproduce, and it indicates the culprit sstable:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; 2023-10-12 21:55:12,181 DiskSpaceMetricsTest.java:125 - smallest sstable is /tmp/cassandra/build/test/cassandra/data/cql_test_keyspace_alt/table_01-03e61210694a11eeb4091bdb4ac3170b/nc-1-big-Data.db at 2329 bytes&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If we grep the log for that sstable:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;PerDiskMemtableFlushWriter_0:2&amp;#93;&lt;/span&gt; 2023-10-12 21:55:11,128 Flushing.java:180 - Completed flushing /tmp/cassandra/build/test/cassandra/data/cql_test_keyspace_alt/table_01-03e61210694a11eeb4091bdb4ac3170b/nc-1-big-Data.db (6.839KiB) for commitlog position CommitLogPosition(segmentId=1697147706890, position=211)&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; DEBUG &lt;span class=&quot;error&quot;&gt;&amp;#91;MemtableFlushWriter:2&amp;#93;&lt;/span&gt; 2023-10-12 21:55:11,177 ColumnFamilyStore.java:1345 - Flushed to &lt;span class=&quot;error&quot;&gt;&amp;#91;BigTableReader:big(path=&amp;#39;/tmp/cassandra/build/test/cassandra/data/cql_test_keyspace_alt/table_01-03e61210694a11eeb4091bdb4ac3170b/nc-1-big-Data.db&amp;#39;)&amp;#93;&lt;/span&gt; (1 sstables, 11.232KiB), biggest 11.232KiB, smallest 11.232KiB&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;junit-timeout&amp;#93;&lt;/span&gt; INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; 2023-10-12 21:55:12,181 DiskSpaceMetricsTest.java:125 - smallest sstable is /tmp/cassandra/build/test/cassandra/data/cql_test_keyspace_alt/table_01-03e61210694a11eeb4091bdb4ac3170b/nc-1-big-Data.db at 2329 bytes&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It looks like SSTR.onDiskLength() and bytesOnDisk() disagree at some point, which seems like a bug.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; can you take a look? I&apos;ve uploaded the full log from the failure.&lt;/p&gt;</comment>
                            <comment id="17777830" author="blambov" created="Fri, 20 Oct 2023 15:18:57 +0000"  >&lt;p&gt;It looks like the reason for the unexpected flush is the commit log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] INFO  [OptionalTasks:1] 2023-10-12 21:55:11,095 ColumnFamilyStore.java:1017 - Enqueuing flush of cql_test_keyspace_alt.table_01, Reason: COMMITLOG_DIRTY, Usage: 74.752KiB (0%) on-heap, 3.777KiB (0%) off-heap
[junit-timeout] INFO  [PerDiskMemtableFlushWriter_0:2] 2023-10-12 21:55:11,103 Flushing.java:154 - Writing Memtable-table_01@1180822937(6.854KiB serialized bytes, 242 ops, 74.916KiB (0%) on-heap, 3.781KiB (0%) off-heap), flushed range = [&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
[junit-timeout] INFO  [PerDiskMemtableFlushWriter_0:2] 2023-10-12 21:55:11,128 Flushing.java:180 - Completed flushing /tmp/cassandra/build/test/cassandra/data/cql_test_keyspace_alt/table_01-03e61210694a11eeb4091bdb4ac3170b/nc-1-big-Data.db (6.839KiB) ... &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which is flushing just 242 out of the 1000 ops that the test needs per table.&lt;/p&gt;

&lt;p&gt;We need to understand what causes these &lt;tt&gt;COMMITLOG_DIRTY&lt;/tt&gt; flushes, because there are quite a few tests that will fail if a flush happens at the wrong time. Or maybe somehow disable commitlog-driven flushing for tests (e.g. by setting a really large commit log space limit).&lt;/p&gt;</comment>
                            <comment id="17777851" author="brandon.williams" created="Fri, 20 Oct 2023 15:57:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;We need to understand what causes these COMMITLOG_DIRTY flushes, because there are quite a few tests that will fail if a flush happens at the wrong time. Or maybe somehow disable commitlog-driven flushing for tests (e.g. by setting a really large commit log space limit).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I remember running into this same situation in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18706&quot; title=&quot;Test failure: org.apache.cassandra.cql3.ViewTest.testIgnoreUpdate-compression.jdk11 (from org.apache.cassandra.cql3.ViewTest-compression.jdk11)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18706&quot;&gt;&lt;del&gt;CASSANDRA-18706&lt;/del&gt;&lt;/a&gt; now, and I think something in 5.0 must have changed to cause this.  I&apos;ll see if I can track that down, but we could also shut the optional tasks executor down since whatever is triggering the flushes is going through it.&lt;/p&gt;</comment>
                            <comment id="17778792" author="brandon.williams" created="Mon, 23 Oct 2023 19:09:13 +0000"  >&lt;p&gt;Dropping a CF eventually leads to CFS.onTableDropped, which then &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/ColumnFamilyStore.java#L3379&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;force recycles&lt;/a&gt; the commit log segments, which leads to our flushes with COMMITLOG_DIRTY.  This was added in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17071&quot; title=&quot;Relax schema synchronization when opening a keyspace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17071&quot;&gt;&lt;del&gt;CASSANDRA-17071&lt;/del&gt;&lt;/a&gt; which is in 4.1, though.&lt;/p&gt;</comment>
                            <comment id="17779468" author="blambov" created="Wed, 25 Oct 2023 11:29:49 +0000"  >&lt;p&gt;So the &lt;tt&gt;KEYSPACE_PER_TEST&lt;/tt&gt; fix for unexpected flushes no longer works after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17071&quot; title=&quot;Relax schema synchronization when opening a keyspace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17071&quot;&gt;&lt;del&gt;CASSANDRA-17071&lt;/del&gt;&lt;/a&gt;? All of the tests that use it will be having intermittent failures unless we find a way to block this.&lt;/p&gt;</comment>
                            <comment id="17779928" author="brandon.williams" created="Thu, 26 Oct 2023 14:42:22 +0000"  >&lt;p&gt;Before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17071&quot; title=&quot;Relax schema synchronization when opening a keyspace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17071&quot;&gt;&lt;del&gt;CASSANDRA-17071&lt;/del&gt;&lt;/a&gt; (and currently in 4.0) we also force recycled the commitlog, but sooner in &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0/src/java/org/apache/cassandra/schema/Schema.java#L803&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Schema.dropTable&lt;/a&gt;, and it didn&apos;t cause small flushes of the active CF.  After &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17071&quot; title=&quot;Relax schema synchronization when opening a keyspace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17071&quot;&gt;&lt;del&gt;CASSANDRA-17071&lt;/del&gt;&lt;/a&gt; that has moved to CFS.onTableDropped and it seems the timing of this now does cause the small flushes.  I&apos;m not super strong in this area of the code but it seems like maybe this could be massaged again to prevent this from happening as before?&lt;/p&gt;

&lt;p&gt;Here&apos;s a reproduction with additional logging at ERROR showing the drop of table_00 causing the small flush of table_01 shortly after creation:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit-timeout] INFO  [main] 2023-10-25 20:12:32,442 ColumnFamilyStore.java:493 - Initializing cql_test_keyspace_alt.table_01
[junit-timeout] DEBUG [main] 2023-10-25 20:12:32,443 DiskBoundaryManager.java:54 - Refreshing disk boundary cache for cql_test_keyspace_alt.table_01
[junit-timeout] DEBUG [main] 2023-10-25 20:12:32,443 DiskBoundaryManager.java:93 - Got local ranges [] (ringVersion = 0)
[junit-timeout] DEBUG [main] 2023-10-25 20:12:32,447 DiskBoundaryManager.java:57 - Updating boundaries from null to DiskBoundaries{directories=[DataDirectory{location=build/test/cassandra/data}], positions=null, ringVersion=0, directoriesVersion=0} for cql_test_keyspace_alt.table_01
[junit-timeout] INFO  [main] 2023-10-25 20:12:32,453 ViewManager.java:127 - Not submitting build tasks for views in keyspace cql_test_keyspace_alt as storage service is not initialized
[junit-timeout] DEBUG [OptionalTasks:1] 2023-10-25 20:12:32,459 DefaultSchemaUpdateHandler.java:259 - Schema updated: SchemaTransformationResult{e9de990e-f2fd-3f3e-97fb-e351f5dae8d3 --&amp;gt; 111d2c16-fe3d-3fcf-9dc1-9cafe8d9b926, diff=KeyspacesDiff{created=[], dropped=[], altered=[KeyspaceDiff{before=KeyspaceMetadata{name=cql_test_keyspace, kind=REGULAR, params=KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.SimpleStrategy, replication_factor=1}}, tables=[cql_test_keyspace.table_00], views=[], functions=[], types=[]}, after=KeyspaceMetadata{name=cql_test_keyspace, kind=REGULAR, params=KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.SimpleStrategy, replication_factor=1}}, tables=[], views=[], functions=[], types=[]}, tables=Diff{created=[], dropped=[cql_test_keyspace.table_00], altered=[]}, views=Diff{created=[], dropped=[], altered=[]}, types=Diff{created=[], dropped=[], altered=[]}, udfs=Diff{created=[], dropped=[], altered=[]}, udas=Diff{created=[], dropped=[], altered=[]}}]}}
[junit-timeout] ERROR [OptionalTasks:1] 2023-10-25 20:12:32,571 ColumnFamilyStore.java:1013 - Bad flush reason: COMMITLOG_DIRTY
[junit-timeout] ERROR [OptionalTasks:1] 2023-10-25 20:12:32,571 ColumnFamilyStore.java:1014 - [org.apache.cassandra.db.ColumnFamilyStore.logFlush(ColumnFamilyStore.java:1012)
[junit-timeout]  org.apache.cassandra.db.ColumnFamilyStore.switchMemtable(ColumnFamilyStore.java:999)
[junit-timeout]  org.apache.cassandra.db.ColumnFamilyStore.switchMemtableIfCurrent(ColumnFamilyStore.java:981)
[junit-timeout]  org.apache.cassandra.db.ColumnFamilyStore.flushMemtable(ColumnFamilyStore.java:1065)
[junit-timeout]  org.apache.cassandra.db.ColumnFamilyStore.forceFlush(ColumnFamilyStore.java:1040)
[junit-timeout]  org.apache.cassandra.db.commitlog.AbstractCommitLogSegmentManager.flushDataFrom(AbstractCommitLogSegmentManager.java:457)
[junit-timeout]  org.apache.cassandra.db.commitlog.AbstractCommitLogSegmentManager.forceRecycleAll(AbstractCommitLogSegmentManager.java:334)
[junit-timeout]  org.apache.cassandra.db.commitlog.CommitLog.forceRecycleAllSegments(CommitLog.java:261)
[junit-timeout]  org.apache.cassandra.db.ColumnFamilyStore.onTableDropped(ColumnFamilyStore.java:3382)
[junit-timeout]  org.apache.cassandra.db.Keyspace.dropCf(Keyspace.java:383)
[junit-timeout]  org.apache.cassandra.schema.Schema.dropTable(Schema.java:756)
[junit-timeout]  org.apache.cassandra.schema.Schema.lambda$alterKeyspace$14(Schema.java:672)
[junit-timeout]  java.base/java.lang.Iterable.forEach(Iterable.java:75)
[junit-timeout]  org.apache.cassandra.schema.Schema.alterKeyspace(Schema.java:672)
[junit-timeout]  org.apache.cassandra.schema.Schema.lambda$merge$12(Schema.java:655)
[junit-timeout]  com.google.common.collect.ImmutableList.forEach(ImmutableList.java:422)
[junit-timeout]  org.apache.cassandra.schema.Schema.merge(Schema.java:655)
[junit-timeout]  org.apache.cassandra.schema.Schema.mergeAndUpdateVersion(Schema.java:607)
[junit-timeout]  org.apache.cassandra.schema.DefaultSchemaUpdateHandler.updateSchema(DefaultSchemaUpdateHandler.java:260)
[junit-timeout]  org.apache.cassandra.schema.DefaultSchemaUpdateHandler.apply(DefaultSchemaUpdateHandler.java:242)
[junit-timeout]  org.apache.cassandra.schema.Schema.transform(Schema.java:620)
[junit-timeout]  org.apache.cassandra.cql3.statements.schema.AlterSchemaStatement.execute(AlterSchemaStatement.java:114)
[junit-timeout]  org.apache.cassandra.cql3.statements.schema.AlterSchemaStatement.executeLocally(AlterSchemaStatement.java:71)
[junit-timeout]  org.apache.cassandra.cql3.CQLTester.schemaChange(CQLTester.java:1460)
[junit-timeout]  org.apache.cassandra.cql3.CQLTester$2.run(CQLTester.java:471)
[junit-timeout]  org.apache.cassandra.concurrent.ExecutionFailure$1.run(ExecutionFailure.java:133)
[junit-timeout]  org.apache.cassandra.concurrent.ExecutionFailure$1.run(ExecutionFailure.java:133)
[junit-timeout]  java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:539)
[junit-timeout]  java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)
[junit-timeout]  java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17782331" author="edimitrova" created="Thu, 2 Nov 2023 21:20:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;After&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17071&quot; title=&quot;Relax schema synchronization when opening a keyspace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17071&quot;&gt;&lt;del&gt;CASSANDRA-17071&lt;/del&gt;&lt;/a&gt;&#160;that has moved to CFS.onTableDropped and it seems the timing of this now does cause the small flushes. I&apos;m not super strong in this area of the code but it seems like maybe this could be massaged again to prevent this from happening as before?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;So if I read correctly, this &lt;em&gt;may be&lt;/em&gt;&#160;a 4.1+ regression?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt; , &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; , do you mind to take a look and advise, please?&#160;&lt;/p&gt;</comment>
                            <comment id="17782610" author="blambov" created="Fri, 3 Nov 2023 15:12:56 +0000"  >&lt;p&gt;Yes, this looks like a 4.1 regression that is affecting all tests that are sensitive to the number of sstables. Such tests usually run in a separate keyspace (using &lt;tt&gt;KEYSPACE_PER_TEST&lt;/tt&gt;) to avoid the keyspace flush that dropping a table triggers, but this new commit log recycling is triggering another flush that is not restricted to the affected keyspace.&lt;/p&gt;</comment>
                            <comment id="17782695" author="brandon.williams" created="Fri, 3 Nov 2023 18:21:30 +0000"  >&lt;p&gt;I tried to reproduce this on 4.1 by backporting the test but iterating the sstables again instead of using the metric, since that part was non-trivial to add, &lt;a href=&quot;https://github.com/driftx/cassandra/commit/1ac64e63de7b0d0f7c63dd953e81fbeb66ff77d9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.  Indeed, this fails on 4.1 in the same way, as seen here: &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1353/workflows/621a816d-9309-4e7c-910c-f56d36281bd0/jobs/60078/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/driftx/cassandra/1353/workflows/621a816d-9309-4e7c-910c-f56d36281bd0/jobs/60078/tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17784223" author="brandon.williams" created="Wed, 8 Nov 2023 22:16:48 +0000"  >&lt;p&gt;I noticed that the refactoring around this in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17071&quot; title=&quot;Relax schema synchronization when opening a keyspace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17071&quot;&gt;&lt;del&gt;CASSANDRA-17071&lt;/del&gt;&lt;/a&gt; kept the general order of events but slightly changed the behavior, which I&apos;ve restored &lt;a href=&quot;https://github.com/driftx/cassandra/commit/b25d1819faf3a963e6e40a2afe6b9e648c4d2aee&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.  &lt;del&gt;As one might expect, I haven&apos;t been able to reproduce in 5.0 with that patch (&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1362/workflows/ccc0dc0b-7342-4637-a983-160b3f3a6ea5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; or &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1362/workflows/c35b0923-d293-4197-a58d-7498ab499e09&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;).  If this looks good and will still work for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17071&quot; title=&quot;Relax schema synchronization when opening a keyspace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17071&quot;&gt;&lt;del&gt;CASSANDRA-17071&lt;/del&gt;&lt;/a&gt;&apos;s goals, I can prepare the branches and run full CI.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;This did reproduce after I wrote that, &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1362/workflows/ccc0dc0b-7342-4637-a983-160b3f3a6ea5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.  I&apos;ll have to dig into that.&lt;/p&gt;</comment>
                            <comment id="17785564" author="brandon.williams" created="Mon, 13 Nov 2023 16:27:50 +0000"  >&lt;p&gt;I think I&apos;ve done what I can here, I&apos;m too far out of my wheelhouse if making the execution order the same after the refactoring doesn&apos;t fix it.  Something else from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17071&quot; title=&quot;Relax schema synchronization when opening a keyspace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17071&quot;&gt;&lt;del&gt;CASSANDRA-17071&lt;/del&gt;&lt;/a&gt; is causing this interaction with commitlog recycling forcing small flushes, I will defer to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17785915" author="jlewandowski" created="Tue, 14 Nov 2023 14:33:06 +0000"  >&lt;p&gt;I&apos;ve managed to reproduce it locally with IntelliJ repeated test runs... &lt;/p&gt;

&lt;p&gt;a full fresh log&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [main] 2023-11-14 15:39:38,817 CQLTester.java:1004 - CREATE TABLE cql_test_keyspace_alt.table_26 (pk bigint, PRIMARY KEY (pk))
DEBUG [main] 2023-11-14 15:39:38,818 DefaultSchemaUpdateHandler.java:259 - Schema updated: SchemaTransformationResult{16db0888-1bd6-360e-a84c-fff0101449fa --&amp;gt; 6ec911f6-0117-3684-ab6b-1366e985c0fe, diff=KeyspacesDiff{created=[], dropped=[], altered=[KeyspaceDiff{before=KeyspaceMetadata{name=cql_test_keyspace_alt, kind=REGULAR, params=KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.SimpleStrategy, replication_factor=1}}, tables=[], views=[], functions=[], types=[]}, after=KeyspaceMetadata{name=cql_test_keyspace_alt, kind=REGULAR, params=KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.SimpleStrategy, replication_factor=1}}, tables=[cql_test_keyspace_alt.table_26], views=[], functions=[], types=[]}, tables=Diff{created=[cql_test_keyspace_alt.table_26], dropped=[], altered=[]}, views=Diff{created=[], dropped=[], altered=[]}, types=Diff{created=[], dropped=[], altered=[]}, udfs=Diff{created=[], dropped=[], altered=[]}, udas=Diff{created=[], dropped=[], altered=[]}}]}}
INFO  [main] 2023-11-14 15:39:38,819 Keyspace.java:366 - Creating replication strategy cql_test_keyspace_alt params KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.SimpleStrategy, replication_factor=1}}
INFO  [main] 2023-11-14 15:39:38,819 ColumnFamilyStore.java:495 - Initializing cql_test_keyspace_alt.table_26
DEBUG [main] 2023-11-14 15:39:38,819 DiskBoundaryManager.java:54 - Refreshing disk boundary cache for cql_test_keyspace_alt.table_26
DEBUG [main] 2023-11-14 15:39:38,819 DiskBoundaryManager.java:93 - Got local ranges [] (ringVersion = 0)
DEBUG [main] 2023-11-14 15:39:38,819 DiskBoundaryManager.java:57 - Updating boundaries from null to DiskBoundaries{directories=[DataDirectory{location=build/test/cassandra/data}], positions=null, ringVersion=0, directoriesVersion=0} for cql_test_keyspace_alt.table_26
INFO  [main] 2023-11-14 15:39:38,821 ViewManager.java:127 - Not submitting build tasks for views in keyspace cql_test_keyspace_alt as storage service is not initialized
INFO  [main] 2023-11-14 15:39:38,845 ColumnFamilyStore.java:1021 - Enqueuing flush of cql_test_keyspace_alt.table_26, Reason: UNIT_TESTS, Usage: 309.570KiB (0%) on-heap, 15.625KiB (0%) off-heap
INFO  [PerDiskMemtableFlushWriter_0:2] 2023-11-14 15:39:38,854 Flushing.java:154 - Writing Memtable-table_26@1116421524(28.320KiB serialized bytes, 1000 ops, 309.570KiB (0%) on-heap, 15.625KiB (0%) off-heap), flushed range = [null, null)
INFO  [PerDiskMemtableFlushWriter_0:2] 2023-11-14 15:39:38,855 Flushing.java:180 - Completed flushing /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_26-a398db1082fb11eeb194e5f4789e9eaa/nc-1-big-Data.db (27.743KiB) for commitlog position CommitLogPosition(segmentId=1699972753906, position=65263)
INFO  [MemtableFlushWriter:2] 2023-11-14 15:39:38,888 LogTransaction.java:249 - Unfinished transaction log, deleting /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_26-a398db1082fb11eeb194e5f4789e9eaa/nc_txn_flush_a39d20d0-82fb-11ee-b194-e5f4789e9eaa.log 
DEBUG [MemtableFlushWriter:2] 2023-11-14 15:39:38,895 ColumnFamilyStore.java:1349 - Flushed to [BigTableReader:big(path=&apos;/home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_26-a398db1082fb11eeb194e5f4789e9eaa/nc-1-big-Data.db&apos;)] (1 sstables, 31.852KiB), biggest 31.852KiB, smallest 31.852KiB
INFO  [main] 2023-11-14 15:39:38,913 ColumnFamilyStore.java:1021 - Enqueuing flush of cql_test_keyspace_alt.table_26, Reason: UNIT_TESTS, Usage: 309.570KiB (0%) on-heap, 15.625KiB (0%) off-heap
INFO  [PerDiskMemtableFlushWriter_0:1] 2023-11-14 15:39:38,921 Flushing.java:154 - Writing Memtable-table_26@1957761258(28.320KiB serialized bytes, 1000 ops, 309.570KiB (0%) on-heap, 15.625KiB (0%) off-heap), flushed range = [null, null)
INFO  [PerDiskMemtableFlushWriter_0:1] 2023-11-14 15:39:38,923 Flushing.java:180 - Completed flushing /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_26-a398db1082fb11eeb194e5f4789e9eaa/nc-2-big-Data.db (27.427KiB) for commitlog position CommitLogPosition(segmentId=1699972753906, position=126263)
INFO  [MemtableFlushWriter:1] 2023-11-14 15:39:38,952 LogTransaction.java:249 - Unfinished transaction log, deleting /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_26-a398db1082fb11eeb194e5f4789e9eaa/nc_txn_flush_a3a78110-82fb-11ee-b194-e5f4789e9eaa.log 
DEBUG [MemtableFlushWriter:1] 2023-11-14 15:39:38,958 ColumnFamilyStore.java:1349 - Flushed to [BigTableReader:big(path=&apos;/home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_26-a398db1082fb11eeb194e5f4789e9eaa/nc-2-big-Data.db&apos;)] (1 sstables, 30.995KiB), biggest 30.995KiB, smallest 30.995KiB
INFO  [main] 2023-11-14 15:39:38,976 ColumnFamilyStore.java:1021 - Enqueuing flush of cql_test_keyspace_alt.table_26, Reason: UNIT_TESTS, Usage: 309.570KiB (0%) on-heap, 15.625KiB (0%) off-heap
INFO  [PerDiskMemtableFlushWriter_0:2] 2023-11-14 15:39:38,983 Flushing.java:154 - Writing Memtable-table_26@242024199(28.320KiB serialized bytes, 1000 ops, 309.570KiB (0%) on-heap, 15.625KiB (0%) off-heap), flushed range = [null, null)
INFO  [PerDiskMemtableFlushWriter_0:2] 2023-11-14 15:39:38,984 Flushing.java:180 - Completed flushing /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_26-a398db1082fb11eeb194e5f4789e9eaa/nc-3-big-Data.db (27.435KiB) for commitlog position CommitLogPosition(segmentId=1699972753906, position=187263)
INFO  [MemtableFlushWriter:2] 2023-11-14 15:39:39,014 LogTransaction.java:249 - Unfinished transaction log, deleting /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_26-a398db1082fb11eeb194e5f4789e9eaa/nc_txn_flush_a3b11e00-82fb-11ee-b194-e5f4789e9eaa.log 
DEBUG [MemtableFlushWriter:2] 2023-11-14 15:39:39,020 ColumnFamilyStore.java:1349 - Flushed to [BigTableReader:big(path=&apos;/home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_26-a398db1082fb11eeb194e5f4789e9eaa/nc-3-big-Data.db&apos;)] (1 sstables, 31.011KiB), biggest 31.011KiB, smallest 31.011KiB

java.lang.AssertionError:
Expected :9435.0
Actual   :10002.088009199999
&amp;lt;Click to see difference&amp;gt;


	at org.junit.Assert.fail(Assert.java:88)
	at org.junit.Assert.failNotEquals(Assert.java:834)
	at org.junit.Assert.assertEquals(Assert.java:553)
	at org.junit.Assert.assertEquals(Assert.java:683)
	at org.apache.cassandra.io.DiskSpaceMetricsTest.testFlushSize(DiskSpaceMetricsTest.java:123)
	at jdk.internal.reflect.GeneratedMethodAccessor7.invoke(Unknown Source)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:566)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)
	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
	at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)
	at org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
	at org.junit.runner.JUnitCore.run(JUnitCore.java:137)
	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:69)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater$1.execute(IdeaTestRunner.java:38)
	at com.intellij.rt.execution.junit.TestsRepeater.repeat(TestsRepeater.java:30)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:35)
	at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:232)
	at com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:55)


&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Updated: includes just the test case, without beforeTest/afterTest&lt;/p&gt;</comment>
                            <comment id="17785923" author="jlewandowski" created="Tue, 14 Nov 2023 14:44:03 +0000"  >&lt;p&gt;and this is a good run, without a failure:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [main] 2023-11-14 15:39:30,254 CQLTester.java:1004 - CREATE TABLE cql_test_keyspace_alt.table_16 (pk bigint, PRIMARY KEY (pk))
DEBUG [main] 2023-11-14 15:39:30,256 DefaultSchemaUpdateHandler.java:259 - Schema updated: SchemaTransformationResult{83424b78-ee1a-38f8-acb8-73e354fbca5b --&amp;gt; 8323ff58-4946-3c75-bedb-b4cfb7108a11, diff=KeyspacesDiff{created=[], dropped=[], altered=[KeyspaceDiff{before=KeyspaceMetadata{name=cql_test_keyspace_alt, kind=REGULAR, params=KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.SimpleStrategy, replication_factor=1}}, tables=[], views=[], functions=[], types=[]}, after=KeyspaceMetadata{name=cql_test_keyspace_alt, kind=REGULAR, params=KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.SimpleStrategy, replication_factor=1}}, tables=[cql_test_keyspace_alt.table_16], views=[], functions=[], types=[]}, tables=Diff{created=[cql_test_keyspace_alt.table_16], dropped=[], altered=[]}, views=Diff{created=[], dropped=[], altered=[]}, types=Diff{created=[], dropped=[], altered=[]}, udfs=Diff{created=[], dropped=[], altered=[]}, udas=Diff{created=[], dropped=[], altered=[]}}]}}
INFO  [main] 2023-11-14 15:39:30,256 Keyspace.java:366 - Creating replication strategy cql_test_keyspace_alt params KeyspaceParams{durable_writes=true, replication=ReplicationParams{class=org.apache.cassandra.locator.SimpleStrategy, replication_factor=1}}
INFO  [main] 2023-11-14 15:39:30,256 ColumnFamilyStore.java:495 - Initializing cql_test_keyspace_alt.table_16
DEBUG [main] 2023-11-14 15:39:30,257 DiskBoundaryManager.java:54 - Refreshing disk boundary cache for cql_test_keyspace_alt.table_16
DEBUG [main] 2023-11-14 15:39:30,257 DiskBoundaryManager.java:93 - Got local ranges [] (ringVersion = 0)
DEBUG [main] 2023-11-14 15:39:30,257 DiskBoundaryManager.java:57 - Updating boundaries from null to DiskBoundaries{directories=[DataDirectory{location=build/test/cassandra/data}], positions=null, ringVersion=0, directoriesVersion=0} for cql_test_keyspace_alt.table_16
INFO  [main] 2023-11-14 15:39:30,259 ViewManager.java:127 - Not submitting build tasks for views in keyspace cql_test_keyspace_alt as storage service is not initialized
INFO  [NonPeriodicTasks:1] 2023-11-14 15:39:30,260 LogTransaction.java:249 - Unfinished transaction log, deleting /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/system_schema/aggregates-924c55872e3a345bb10c12f37c1ba895/nc_txn_compaction_9e72cd30-82fb-11ee-b194-e5f4789e9eaa.log
INFO  [main] 2023-11-14 15:39:30,278 ColumnFamilyStore.java:1021 - Enqueuing flush of cql_test_keyspace_alt.table_16, Reason: UNIT_TESTS, Usage: 309.570KiB (0%) on-heap, 15.625KiB (0%) off-heap
INFO  [PerDiskMemtableFlushWriter_0:2] 2023-11-14 15:39:30,286 Flushing.java:154 - Writing Memtable-table_16@70866609(28.320KiB serialized bytes, 1000 ops, 309.570KiB (0%) on-heap, 15.625KiB (0%) off-heap), flushed range = [null, null)
INFO  [PerDiskMemtableFlushWriter_0:2] 2023-11-14 15:39:30,288 Flushing.java:180 - Completed flushing /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_16-9e7e65f082fb11eeb194e5f4789e9eaa/nc-1-big-Data.db (27.456KiB) for commitlog position CommitLogPosition(segmentId=1699972753896, position=77015)
INFO  [MemtableFlushWriter:2] 2023-11-14 15:39:30,320 LogTransaction.java:249 - Unfinished transaction log, deleting /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_16-9e7e65f082fb11eeb194e5f4789e9eaa/nc_txn_flush_9e81e860-82fb-11ee-b194-e5f4789e9eaa.log
DEBUG [MemtableFlushWriter:2] 2023-11-14 15:39:30,326 ColumnFamilyStore.java:1349 - Flushed to [BigTableReader:big(path=&apos;/home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_16-9e7e65f082fb11eeb194e5f4789e9eaa/nc-1-big-Data.db&apos;)] (1 sstables, 31.116KiB), biggest 31.116KiB, smallest 31.116KiB
INFO  [main] 2023-11-14 15:39:30,344 ColumnFamilyStore.java:1021 - Enqueuing flush of cql_test_keyspace_alt.table_16, Reason: UNIT_TESTS, Usage: 309.570KiB (0%) on-heap, 15.625KiB (0%) off-heap
INFO  [PerDiskMemtableFlushWriter_0:1] 2023-11-14 15:39:30,351 Flushing.java:154 - Writing Memtable-table_16@1253443750(28.320KiB serialized bytes, 1000 ops, 309.570KiB (0%) on-heap, 15.625KiB (0%) off-heap), flushed range = [null, null)
INFO  [PerDiskMemtableFlushWriter_0:1] 2023-11-14 15:39:30,353 Flushing.java:180 - Completed flushing /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_16-9e7e65f082fb11eeb194e5f4789e9eaa/nc-2-big-Data.db (27.350KiB) for commitlog position CommitLogPosition(segmentId=1699972753896, position=138015)
INFO  [MemtableFlushWriter:1] 2023-11-14 15:39:30,384 LogTransaction.java:249 - Unfinished transaction log, deleting /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_16-9e7e65f082fb11eeb194e5f4789e9eaa/nc_txn_flush_9e8bfa80-82fb-11ee-b194-e5f4789e9eaa.log
DEBUG [MemtableFlushWriter:1] 2023-11-14 15:39:30,391 ColumnFamilyStore.java:1349 - Flushed to [BigTableReader:big(path=&apos;/home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_16-9e7e65f082fb11eeb194e5f4789e9eaa/nc-2-big-Data.db&apos;)] (1 sstables, 30.804KiB), biggest 30.804KiB, smallest 30.804KiB
INFO  [main] 2023-11-14 15:39:30,410 ColumnFamilyStore.java:1021 - Enqueuing flush of cql_test_keyspace_alt.table_16, Reason: UNIT_TESTS, Usage: 309.570KiB (0%) on-heap, 15.625KiB (0%) off-heap
INFO  [PerDiskMemtableFlushWriter_0:2] 2023-11-14 15:39:30,421 Flushing.java:154 - Writing Memtable-table_16@75630209(28.320KiB serialized bytes, 1000 ops, 309.570KiB (0%) on-heap, 15.625KiB (0%) off-heap), flushed range = [null, null)
INFO  [PerDiskMemtableFlushWriter_0:2] 2023-11-14 15:39:30,422 Flushing.java:180 - Completed flushing /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_16-9e7e65f082fb11eeb194e5f4789e9eaa/nc-3-big-Data.db (27.478KiB) for commitlog position CommitLogPosition(segmentId=1699972753896, position=199015)
INFO  [MemtableFlushWriter:2] 2023-11-14 15:39:30,453 LogTransaction.java:249 - Unfinished transaction log, deleting /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_16-9e7e65f082fb11eeb194e5f4789e9eaa/nc_txn_flush_9e960ca0-82fb-11ee-b194-e5f4789e9eaa.log
DEBUG [MemtableFlushWriter:2] 2023-11-14 15:39:30,461 ColumnFamilyStore.java:1349 - Flushed to [BigTableReader:big(path=&apos;/home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/cql_test_keyspace_alt/table_16-9e7e65f082fb11eeb194e5f4789e9eaa/nc-3-big-Data.db&apos;)] (1 sstables, 31.175KiB), biggest 31.175KiB, smallest 31.175KiB
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Comparing to the bad run, I can see only one extra log line in the good run:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [NonPeriodicTasks:1] 2023-11-14 15:39:30,260 LogTransaction.java:249 - Unfinished transaction log, deleting /home/jlewandowski/dev/cassandra/cassandra-5.0/build/test/cassandra/data/system_schema/aggregates-924c55872e3a345bb10c12f37c1ba895/nc_txn_compaction_9e72cd30-82fb-11ee-b194-e5f4789e9eaa.log
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17786265" author="jlewandowski" created="Wed, 15 Nov 2023 09:37:33 +0000"  >&lt;p&gt;I&apos;ve tried to follow what are the updates applied to the metrics so that it leads to the assertion failure. It seems that in the failed case there are no problems at all - I can see 3 updates as expected: 9670, 8787, 8885, which give the moving average with alpha=0.0046 = 9662, and avg=9114, so at least there is no problem there.&lt;/p&gt;

&lt;p&gt;Another question is whether values like 9670, 8787, 8885 are correct, and what is the sources of such randomness.&lt;/p&gt;</comment>
                            <comment id="17786284" author="jlewandowski" created="Wed, 15 Nov 2023 10:03:13 +0000"  >&lt;p&gt;ah.... so compression is used regardless we use compression config or not.... &lt;/p&gt;</comment>
                            <comment id="17786286" author="jlewandowski" created="Wed, 15 Nov 2023 10:05:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; the test seems to run ok with increased delta, but I don&apos;t think this is the point - I assume you do not want to test the correctness of the &lt;tt&gt;MovingAverage&lt;/tt&gt; implementation there. So perhaps the expected value should be calculated as a moving average by updating it with subsequent table sizes.&lt;/p&gt;

&lt;p&gt;I didn&apos;t manage to reproduce the case with extra flush so far&lt;/p&gt;</comment>
                            <comment id="17786290" author="blambov" created="Wed, 15 Nov 2023 10:14:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;So perhaps the expected value should be calculated as a moving average by updating it with subsequent table sizes.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This makes sense. Sorting the sstable files by name should give them in the correct order, so we can easily calculate the moving average from them.&lt;/p&gt;

&lt;p&gt;Actually, that would solve the extra flush problem as well, wouldn&apos;t it?&lt;/p&gt;</comment>
                            <comment id="17786291" author="jlewandowski" created="Wed, 15 Nov 2023 10:18:09 +0000"  >&lt;p&gt;I&apos;m not sure, it seems like a value of &quot;0&quot; might be registered in the metrics while there is no such sstable so you would not iterate over it to calculate the expected average, right?&lt;/p&gt;</comment>
                            <comment id="17786295" author="jlewandowski" created="Wed, 15 Nov 2023 10:27:49 +0000"  >&lt;p&gt;ok, disregard my comment&lt;/p&gt;</comment>
                            <comment id="17786300" author="jlewandowski" created="Wed, 15 Nov 2023 10:37:37 +0000"  >&lt;p&gt;Now I&apos;m able to reproduce the extra flush consistently. Dropping tables after test is executed asynchronously, so in some rare cases it may get executed while we are adding rows to our test table, thus causing extra flush (or even flushes).&lt;/p&gt;

&lt;p&gt;I think that regardless whether it is correct to flush everything on each schema change or not, I think that changing schema and dropping sstables asynchronously after each test can cause flakiness. Also I don&apos;t see much justification for doing that async as it take usually less than a second per test case.&lt;/p&gt;

&lt;p&gt;So, summing up, I propose to fix this by calculating moving average as an expected value and create another ticket to convert that async processing (which should be applied to other branches as well) - I suppose that we do not need to remove tables - only KEYSPACE_PER_TEST is expected to be empty&lt;/p&gt;</comment>
                            <comment id="17786313" author="jlewandowski" created="Wed, 15 Nov 2023 11:06:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2900&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2900&lt;/a&gt; - &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; could you review?&lt;/p&gt;</comment>
                            <comment id="17786316" author="jlewandowski" created="Wed, 15 Nov 2023 11:13:01 +0000"  >&lt;p&gt;Also created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19026&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-19026&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17786333" author="brandon.williams" created="Wed, 15 Nov 2023 12:21:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;in some rare cases it may get executed while we are adding rows to our test table, thus causing extra flush (or even flushes)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is this being solved, or just worked around by avoidance?&lt;/p&gt;</comment>
                            <comment id="17786334" author="jlewandowski" created="Wed, 15 Nov 2023 12:24:01 +0000"  >&lt;p&gt;this fix should make the test agnostic to this kind of events, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19026&quot; title=&quot;Do not drop CQLTester.KEYSPACE content in @After asynchronously&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19026&quot;&gt;CASSANDRA-19026&lt;/a&gt; should eliminate unexpected async processing  at all&lt;/p&gt;</comment>
                            <comment id="17786335" author="jlewandowski" created="Wed, 15 Nov 2023 12:24:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/1080/workflows/59cc5d3b-de09-4c43-9bd9-be9b94f3c8df&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jacek-lewandowski/cassandra/1080/workflows/59cc5d3b-de09-4c43-9bd9-be9b94f3c8df&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17786378" author="brandon.williams" created="Wed, 15 Nov 2023 14:31:59 +0000"  >&lt;p&gt;I guess my question is, independent of these tests, will it still be possible to create the small flush scenario?  If not and this solves it, we can revert my fix in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18706&quot; title=&quot;Test failure: org.apache.cassandra.cql3.ViewTest.testIgnoreUpdate-compression.jdk11 (from org.apache.cassandra.cql3.ViewTest-compression.jdk11)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18706&quot;&gt;&lt;del&gt;CASSANDRA-18706&lt;/del&gt;&lt;/a&gt; which suffered the same problem but without any drops.  There may be other tests that are also affected.&lt;/p&gt;</comment>
                            <comment id="17786385" author="jlewandowski" created="Wed, 15 Nov 2023 14:41:51 +0000"  >&lt;p&gt;fix for this ticket does not prevent small flush scenario - this is addressed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19026&quot; title=&quot;Do not drop CQLTester.KEYSPACE content in @After asynchronously&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19026&quot;&gt;CASSANDRA-19026&lt;/a&gt; in general for all tests&lt;/p&gt;

&lt;p&gt;fix for this ticket makes this particular test resilient to small flush problem but also to other scenarios where it was failing (when there was no such small flush)&lt;/p&gt;</comment>
                            <comment id="17786409" author="brandon.williams" created="Wed, 15 Nov 2023 15:32:49 +0000"  >&lt;p&gt;My understanding then is that we are not fixing the small flush scenario, and we will live with it and just workaround it like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18706&quot; title=&quot;Test failure: org.apache.cassandra.cql3.ViewTest.testIgnoreUpdate-compression.jdk11 (from org.apache.cassandra.cql3.ViewTest-compression.jdk11)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18706&quot;&gt;&lt;del&gt;CASSANDRA-18706&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17786443" author="jlewandowski" created="Wed, 15 Nov 2023 17:42:27 +0000"  >&lt;p&gt;This small test shows that small flushes during schema changes are not caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17071&quot; title=&quot;Relax schema synchronization when opening a keyspace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17071&quot;&gt;&lt;del&gt;CASSANDRA-17071&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void test() {
        SchemaLoader.prepareServer();

        QueryProcessor.executeInternal(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE KEYSPACE ks WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1};&quot;&lt;/span&gt;);

        QueryProcessor.executeInternal(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE ks.tab1 (key &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PRIMARY KEY, value &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);&quot;&lt;/span&gt;);
        QueryProcessor.executeInternal(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO ks.tab1 (key, value) VALUES (1, 1);&quot;&lt;/span&gt;);

        QueryProcessor.executeInternal(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE ks.tab2 (key &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PRIMARY KEY, value &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;);&quot;&lt;/span&gt;);
        QueryProcessor.executeInternal(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO ks.tab2 (key, value) VALUES (1, 1);&quot;&lt;/span&gt;);

        QueryProcessor.executeInternal(&lt;span class=&quot;code-quote&quot;&gt;&quot;DROP TABLE ks.tab1;&quot;&lt;/span&gt;);

        Set&amp;lt;SSTableReader&amp;gt; sstables = ColumnFamilyStore.getIfExists(&lt;span class=&quot;code-quote&quot;&gt;&quot;ks&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;tab2&quot;&lt;/span&gt;).getLiveSSTables();
        Assertions.assertThat(sstables.size()).isEqualTo(0);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It fails the same way on 4.0 and 4.1 (which means that the tab2 was flushed when tab1 was dropped)&lt;/p&gt;</comment>
                            <comment id="17786446" author="jlewandowski" created="Wed, 15 Nov 2023 17:44:49 +0000"  >&lt;p&gt;The problem with small flush affecting the test case in question can be easily reliably reproduced by adding the following delays:&lt;/p&gt;

&lt;p&gt;in DiskSizeMetricsTest:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void insertN(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; keyspace, ColumnFamilyStore cfs, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; n, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; base) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
{
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; n; i++)
    {
        &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(1);  &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;------------ HERE
&lt;/span&gt;        executeFormattedQuery(formatQuery(keyspace, &lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (pk) VALUES (?)&quot;&lt;/span&gt;), base + i);
    }

    &lt;span class=&quot;code-comment&quot;&gt;// flush to write the sstable
&lt;/span&gt;    cfs.forceBlockingFlush();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;in CQLTester:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@After
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void afterTest() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
{
    dropPerTestKeyspace();
...
    &lt;span class=&quot;code-comment&quot;&gt;// We want to clean up after the test, but dropping a table is rather &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; so just &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; that asynchronously
&lt;/span&gt;    ScheduledExecutors.optionalTasks.execute(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Runnable&lt;/span&gt;()
    {
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
            {
                &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.sleep(500); &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;----------------- HERE
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = tablesToDrop.size() - 1; i &amp;gt;= 0; i--)
                    schemaChange(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;DROP TABLE IF EXISTS %s.%s&quot;&lt;/span&gt;, KEYSPACE, tablesToDrop.get(i)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then run the whole test class (not just the test case)&lt;/p&gt;</comment>
                            <comment id="17786448" author="jlewandowski" created="Wed, 15 Nov 2023 17:47:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17071&quot; title=&quot;Relax schema synchronization when opening a keyspace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17071&quot;&gt;&lt;del&gt;CASSANDRA-17071&lt;/del&gt;&lt;/a&gt; relaxes some synchronization requirements for schema changes, in particular some changes against one ks does not block some changes against other ks. This might have changed some timings and made that race more apparent. But adding those delays shows that the race is a problem on all versions.&lt;/p&gt;</comment>
                            <comment id="17786469" author="brandon.williams" created="Wed, 15 Nov 2023 18:51:48 +0000"  >&lt;p&gt;Thanks for the explanation, my worry that this was a performance regression has been put to rest.&lt;/p&gt;</comment>
                            <comment id="17787151" author="jlewandowski" created="Fri, 17 Nov 2023 11:47:45 +0000"  >&lt;p&gt;I&apos;ve run repeated tests in a couple of configurations (links in the PRs), all passed, and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; approved the PR. Merging&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13063543" name="org.apache.cassandra.io.DiskSpaceMetricsTest.txt" size="468707" author="brandon.williams" created="Fri, 13 Oct 2023 14:06:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jlewandowski]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 51 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1jggo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
        <customfieldvalue><![CDATA[jlewandowski]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348835">NA</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/3ed723b8700c47026849d11fe599d4e7b48ff65e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/3ed723b8700c47026849d11fe599d4e7b48ff65e&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra/commit/b7b2aa5de57a6433f3f861bcaefe467d64784d1b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/b7b2aa5de57a6433f3f861bcaefe467d64784d1b&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;run CI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>