<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10485] Missing host ID on hinted handoff write</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10485</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;when I restart one of them I receive the error &quot;Missing host ID&quot;:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN  [SharedPool-Worker-1] 2015-10-08 13:15:33,882 AbstractTracingAwareExecutorService.java:169 - Uncaught exception on thread Thread[SharedPool-Worker-1,5,main]: {}
java.lang.AssertionError: Missing host ID for 63.251.156.141
        at org.apache.cassandra.service.StorageProxy.writeHintForMutation(StorageProxy.java:978) ~[apache-cassandra-2.1.3.jar:2.1.3]
        at org.apache.cassandra.service.StorageProxy$6.runMayThrow(StorageProxy.java:950) ~[apache-cassandra-2.1.3.jar:2.1.3]
        at org.apache.cassandra.service.StorageProxy$HintRunnable.run(StorageProxy.java:2235) ~[apache-cassandra-2.1.3.jar:2.1.3]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_60]
        at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) ~[apache-cassandra-2.1.3.jar:2.1.3]
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [apache-cassandra-2.1.3.jar:2.1.3]
        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_60]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;



&lt;p&gt;If I made nodetool status, the problematic node has ID:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;UN  10.10.10.12  1.3 TB     1       ?       4d5c8fd2-a909-4f09-a23c-4cd6040f338a  rack3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12903439">CASSANDRA-10485</key>
            <summary>Missing host ID on hinted handoff write</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pauloricardomg">Paulo Motta</assignee>
                                    <reporter username="pauloricardomg">Paulo Motta</reporter>
                        <labels>
                    </labels>
                <created>Thu, 8 Oct 2015 18:31:29 +0000</created>
                <updated>Wed, 15 Oct 2025 09:48:57 +0000</updated>
                            <resolved>Fri, 13 Nov 2015 14:52:10 +0000</resolved>
                                        <fixVersion>2.1.12</fixVersion>
                    <fixVersion>2.2.4</fixVersion>
                    <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1</fixVersion>
                                    <component>Legacy/Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14975122" author="pauloricardomg" created="Mon, 26 Oct 2015 21:27:21 +0000"  >&lt;p&gt;It seems pending endpoints are removed from the &lt;tt&gt;TokenMetadata&lt;/tt&gt; before the new pending ranges are calculated asynchronously by &lt;tt&gt;PendingRangeCalculatorService&lt;/tt&gt;. For example, when &lt;tt&gt;StorageService&lt;/tt&gt; receives a notification that a node was removed:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;StorageService.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void onRemove(InetAddress endpoint)
{
    tokenMetadata.removeEndpoint(endpoint);
    PendingRangeCalculatorService.instance.update();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, there&apos;s a window before the new pending ranges are calculated where removed pending endpoints are returned to write operations by &lt;tt&gt;TokenMetadata.pendingEndpointsFor()&lt;/tt&gt;, but since the endpoint was already removed from the &lt;tt&gt;TokenMetadata&lt;/tt&gt;, it&apos;s not possible to fetch the endpoint&apos;s ID.&lt;/p&gt;

&lt;p&gt;This seems to be confirmed by reports of this bug during node replacements or failed bootstraps on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6335&quot; title=&quot;Hints broken for nodes that change broadcast address&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6335&quot;&gt;&lt;del&gt;CASSANDRA-6335&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10233&quot; title=&quot;IndexOutOfBoundsException in HintedHandOffManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10233&quot;&gt;&lt;del&gt;CASSANDRA-10233&lt;/del&gt;&lt;/a&gt;. I also created a &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/blob/9a4bb94f4a92ed20dba4b0c04e173c641d45251a/test/unit/org/apache/cassandra/locator/SimpleStrategyTest.java#L168&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;simple test&lt;/a&gt; confirming the issue.&lt;/p&gt;

&lt;p&gt;The simple solution is to iterate over all pending ranges on &lt;tt&gt;TokenMetadata.removeEndpoint()&lt;/tt&gt;, and remove the entries containing the removed endpoint. I assumed it&apos;s thread-safe to update the &lt;tt&gt;pendingRanges&lt;/tt&gt; backing &lt;tt&gt;HashMultiMap&lt;/tt&gt; within the &lt;tt&gt;TokenMetadata&lt;/tt&gt; write lock while it&apos;s read by other threads due to this note on &lt;tt&gt;HashMultiMap&lt;/tt&gt; &lt;a href=&quot;https://google-collections.googlecode.com/svn/trunk/javadoc/com/google/common/collect/HashMultimap.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;documentation&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;This class is not threadsafe when any concurrent operations update the multimap. Concurrent read operations will work correctly. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Code and tests below:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-10485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-10485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-10485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-10485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-10485-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-10485-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-10485-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-10485-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-10485-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-10485-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-10485-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-10485-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;For the record: while investigating the issue I created an &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-10485-v3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;alternative solution&lt;/a&gt;, where endpoint removal is performed only after the new pending ranges are calculated, but I think it&apos;s not an ideal solution because it will mean hints will be stored for a node that is already known to be removed. Furthermore it may also break other places relying on the assumption that the endpoint was immediately removed from &lt;tt&gt;TokenMetadata&lt;/tt&gt; after the &lt;tt&gt;Gossiper&lt;/tt&gt; removal notification.&lt;/p&gt;</comment>
                            <comment id="14983701" author="aweisberg" created="Sat, 31 Oct 2015 00:45:41 +0000"  >&lt;p&gt;HashMultiMap uses good old HashMap internally. So it&apos;s not safe to update it and read at the same time. I think they meant that if the map is immutable it is safe to have multiple concurrent readers.&lt;/p&gt;

&lt;p&gt;I&apos;m still getting situated on how users of TMD work with this state. Will have more later.&lt;/p&gt;

</comment>
                            <comment id="14985401" author="aweisberg" created="Mon, 2 Nov 2015 15:36:17 +0000"  >&lt;p&gt;Having reviewed this further the entire approach of presenting a mutable TMD to readers is a little iffy.&lt;/p&gt;

&lt;p&gt;pendingRangesFor() is not isolated from removeEndpoint() so remove endpoint is tearing apart the datastructure while readers of TMD are viewing an inconsistent state.&lt;/p&gt;

&lt;p&gt;So you could call pendingEndpointsFor() and think you are supposed to submit a hint, but when the time comes to submit the hint the endpoint is already removed from the TMD.&lt;/p&gt;

&lt;p&gt;I think you either need to make the entire thing atomic and make TMD COW and propagate the TMD the entire way. Or alternatively optimistic and if the data isn&apos;t there just abort dropping the hint instead of asserting that it is an error. You could assert instead that pendingEndpointsFor() doesn&apos;t include the missing endpoint.&lt;/p&gt;</comment>
                            <comment id="14988450" author="pauloricardomg" created="Tue, 3 Nov 2015 23:25:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;HashMultiMap uses good old HashMap internally. So it&apos;s not safe to update it and read at the same time. I think they meant that if the map is immutable it is safe to have multiple concurrent readers.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for clarifying this. Updated patch to perform removal of pending endpoint by working on a copy and then replacing the reference atomically.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think you either need to make the entire thing atomic and make TMD COW and propagate the TMD the entire way. Or alternatively optimistic and if the data isn&apos;t there just abort dropping the hint instead of asserting that it is an error. You could assert instead that pendingEndpointsFor() doesn&apos;t include the missing endpoint.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Implemented the optimistic approach of discarding hints to endpoints with null ID and log a debug message (this should happen seldom with immediate removal of the endpoint from pending ranges). Also moved assertion to &lt;tt&gt;TokenMetadata.getHostId()&lt;/tt&gt;, so we guarantee that a host id can only be null if the endpoint is not part of the ring (or is not bootstrapping).&lt;/p&gt;

&lt;p&gt;I needed to do an slight adaptation to the patch on 3.0 on &lt;tt&gt;StorageProxy.submitHint&lt;/tt&gt; due to the new hints implementation. Tests with new implementation available below:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-10485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-10485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-10485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-10485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-10485-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-10485-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-10485-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-10485-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-10485-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-10485-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-10485-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-10485-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="14988473" author="aweisberg" created="Tue, 3 Nov 2015 23:33:46 +0000"  >&lt;p&gt;That fixes this bug, but the design of TMD is still error prone IMO. It presents a materialized view of a state of the world and it would be easiest to reason about if it moved from one consistent state to another from the perspective of readers.&lt;/p&gt;

&lt;p&gt;I am lacking in knowledge of the ways in which TMD is used so I can&apos;t say if everyone uses it safely. We know hints didn&apos;t use it safely which makes me wonder how many others also aren&apos;t going to handle it being in an inconsistent state. Even if we get it internally consistent if things make decisions based on a stale version those need to be harmless or they need to eventually check and make sure they didn&apos;t do something that was invalidated.&lt;/p&gt;

&lt;p&gt;I&apos;ll dig deeper into it tomorrow. If there is someone else who can chime in as to whether this is a valid concern that would be great.&lt;/p&gt;</comment>
                            <comment id="14988539" author="pauloricardomg" created="Wed, 4 Nov 2015 00:15:40 +0000"  >&lt;p&gt;Yeah, definitely &lt;tt&gt;TokenMetadata&lt;/tt&gt; needs some love. Perhaps this is a good time to provide some input/requirements for a &lt;tt&gt;TokenMetadata&lt;/tt&gt; rewrite on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6061&quot; title=&quot;Rewrite TokenMetadata&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6061&quot;&gt;&lt;del&gt;CASSANDRA-6061&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14990471" author="aweisberg" created="Wed, 4 Nov 2015 21:31:39 +0000"  >&lt;p&gt;Can you update the comment HintedHandoffManager.hintFor so that it says that getEndpointForHostId can return null in regular operation and not just test? Wouldn&apos;t want that check to get removed.&lt;/p&gt;

&lt;p&gt;Another thing that is weird is that we convert from InetAddr to host id and then HintedHandoffManager converts that back into an InetAddr (although maybe not the same one?).&lt;/p&gt;

&lt;p&gt;I am not sure how big these things are or how often we rebuild them, but constructing a copy of every map as we iterate even when we aren&apos;t going to modify it is more work. If it&apos;s not too much churn it&apos;s fine I just want to make sure it doesn&apos;t end up biting us.&lt;/p&gt;

&lt;p&gt;I looked at the 3.0 code and it looks good.&lt;/p&gt;</comment>
                            <comment id="14994779" author="pauloricardomg" created="Sat, 7 Nov 2015 00:37:07 +0000"  >&lt;p&gt;I implemented an alternative approach which is a bit cleaner and more deterministic. The basic idea is to have a new method &lt;tt&gt;TokenMetadata.isMemberOrPending()&lt;/tt&gt;, and only submit hints to endpoints that are ring members or pending membership, thus, avoiding fetching null host IDs for removed pending endpoints while the new pending ranges are being calculated.&lt;/p&gt;

&lt;p&gt;In order to support the &lt;tt&gt;TokenMetadata.isMemberOrPending()&lt;/tt&gt; method, the &lt;tt&gt;TokenMetadata&lt;/tt&gt; maintains a new &lt;tt&gt;livePendingEndpoints&lt;/tt&gt; set which is populated every time new pending ranges are set. When endpoints are removed from &lt;tt&gt;TokenMetadata&lt;/tt&gt; via the &lt;tt&gt;removeEndpoint&lt;/tt&gt; method, they&apos;re also removed from the &lt;tt&gt;livePendingEndpoints&lt;/tt&gt; set, so &lt;tt&gt;TokenMetadata.isMemberOrPending()&lt;/tt&gt; returns false if the endpoint is evicted from the ring. Since both &lt;tt&gt;removeEndpoint&lt;/tt&gt; and &lt;tt&gt;setPendingRanges&lt;/tt&gt; update this set, they share a write lock. &lt;tt&gt;TokenMetadata.isMemberOrPending()&lt;/tt&gt; also uses a read lock, similar to other methods &lt;tt&gt;isMember()&lt;/tt&gt; or &lt;tt&gt;getHostId()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Merging the solution from 2.1 to 2.2/3.0 was a bit tricky because the pending ranges calculation was extracted from the &lt;tt&gt;PendingRangeCalculatorService&lt;/tt&gt; to &lt;tt&gt;TokenMetadata&lt;/tt&gt; within a read lock, so I had to separate the actual calculation (within a read lock) to the actual  assignment of the &lt;tt&gt;pendingRanges&lt;/tt&gt; via the &lt;tt&gt;setPendingRanges&lt;/tt&gt; method, which uses a write lock. On 3.0, the hints submission part is slightly different (even simpler) due to the new hints implementation.&lt;/p&gt;

&lt;p&gt;It&apos;s still not ideal but I guess better than the previous approach. I will add a link from this ticket to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6061&quot; title=&quot;Rewrite TokenMetadata&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6061&quot;&gt;&lt;del&gt;CASSANDRA-6061&lt;/del&gt;&lt;/a&gt; so we can take this ticket into account when refactoring the &lt;tt&gt;TokenMetadata&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Below are the new branches and test results:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-10485-v3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-10485-v3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-10485-v3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-10485-v3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-10485-v3-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-10485-v3-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-10485-v3-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-10485-v3-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-10485-v3-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-10485-v3-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-10485-v3-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-10485-v3-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="14997633" author="pauloricardomg" created="Mon, 9 Nov 2015 23:23:13 +0000"  >&lt;p&gt;I just found a bug on the previous version, where a node can be removed from TMD just before setting the new pending ranges, so the problem will persist. &lt;/p&gt;

&lt;p&gt;After thinking this through with a fresh mind, the solution is rather simple, I think I was over-complicating. Pending ranges are basically composed of &quot;normal&quot; endpoints, moving endpoints and bootstrapping endpoints. Moving endpoints are also &quot;normal&quot; endpoints. So, what we actually want to check before submitting a hint, is if the node is a normal endpoint or bootstrapping endpoint. If the node is neither a normal/moving or bootstrapping endpoint, we don&apos;t want to submit hints to it, simple as that. So, I added a new method &lt;tt&gt;TokenMetadata.isMemberOrJoining&lt;/tt&gt; to check that before submitting a hint, thus avoiding getting a null host id on hint submission.&lt;/p&gt;

&lt;p&gt;The two reports of this bug on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6335&quot; title=&quot;Hints broken for nodes that change broadcast address&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6335&quot;&gt;&lt;del&gt;CASSANDRA-6335&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10233&quot; title=&quot;IndexOutOfBoundsException in HintedHandOffManager&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10233&quot;&gt;&lt;del&gt;CASSANDRA-10233&lt;/del&gt;&lt;/a&gt;, are when a node is replaced or when bootstrapping fails. When a node is replaced, it was a &quot;normal&quot; endpoint, but then it was replaced and it was removed from the ring, so we shouldn&apos;t submit a hint to it. When a new node is down after a failed bootstrap, it is removed from the ring, so we shouldn&apos;t submit a hint to it. Actually, with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8838&quot; title=&quot;Resumable bootstrap streaming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8838&quot;&gt;&lt;del&gt;CASSANDRA-8838&lt;/del&gt;&lt;/a&gt;, there&apos;s a possibility of resuming a failed bootstrap, so we should not remove the bootstrapping node from the ring for a quarantine period, but we should handle this in a separate ticket.&lt;/p&gt;

&lt;p&gt;Submitted a new branch with the proposed solution. Sorry for the confusion on this.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-10485-final&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-10485-final&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-10485-final&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-10485-final&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-10485-final-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-10485-final-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-10485-final-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-10485-final-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-10485-final-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-10485-final-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-10485-final-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-10485-final-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="14998915" author="aweisberg" created="Tue, 10 Nov 2015 17:10:08 +0000"  >&lt;p&gt;How is the isMemberJoining() check atomic with getHostId() &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-10485-final#diff-71f06c193f5b5e270cf8ac695164f43aR1015&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;? It&apos;s also doing endpointForHostId a little bit later.&lt;/p&gt;

&lt;p&gt;I get why this works in 3.0+. 3.0+ only checks once to see if it is going to write the hint and doesn&apos;t do the dance resolving stuff from TMD multiple times thus risking seeing an inconsistent version.&lt;/p&gt;</comment>
                            <comment id="14999531" author="pauloricardomg" created="Tue, 10 Nov 2015 22:59:15 +0000"  >&lt;p&gt;Thanks for the review. Addressed issues in new (simpler) implementation:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Discard hints for endpoints with null host ids (logging debug message), avoiding races between multiple &lt;tt&gt;TokenMetadata&lt;/tt&gt; accesses.&lt;/li&gt;
	&lt;li&gt;Moved improved version of null host id assertion to &lt;tt&gt;TokenMetadata.getHostId&lt;/tt&gt;: &lt;tt&gt;assert hostId != null || !isMemberOrJoining(endpoint)&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;On 2.2-, changed signature of &lt;tt&gt;HintedHandOffManager.hintFor&lt;/tt&gt; to accept a &lt;tt&gt;Pair&amp;lt;InetAddress, UUID&amp;gt;&lt;/tt&gt;, avoiding an extra possibly racy access to &lt;tt&gt;TokenMetadata&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Applied similar logic to new hints implementation on 3.0+&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-10485-ultimate&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-10485-ultimate&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-10485-ultimate&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-10485-ultimate&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-10485-ultimate-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-10485-ultimate-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-10485-ultimate-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-10485-ultimate-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-10485-ultimate-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-10485-ultimate-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-10485-ultimate-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-10485-ultimate-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15000710" author="aweisberg" created="Wed, 11 Nov 2015 17:17:22 +0000"  >&lt;p&gt;If we submit a hint to an endpoint that left, when will the hint be cleaned up and discarded? Is there a race there?&lt;/p&gt;</comment>
                            <comment id="15000754" author="aweisberg" created="Wed, 11 Nov 2015 17:38:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-10485-ultimate#diff-71f06c193f5b5e270cf8ac695164f43aR2492&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;There is an extra &apos;)&apos; in this trace statement&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Test look good near as I can tell.&lt;/p&gt;

&lt;p&gt;Why is isMemberJoining better than just using getHostID being null as an indicator of whether the hint should be written?&lt;/p&gt;</comment>
                            <comment id="15001310" author="pauloricardomg" created="Wed, 11 Nov 2015 23:13:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;If we submit a hint to an endpoint that left, when will the hint be cleaned up and discarded? Is there a race there?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The race window is very small, the node needs to be removed exactly between getting the ID from TokenMetadata and the hint being actually written by the HintsManager. If that happens, on 2.1 and 2.2 the hint will expire by ttl after gc_grace_seconds. On 3.0+, a hint file might be created for the removed node, and needs to be removed manually or via nodetool truncatehints.&lt;/p&gt;

&lt;p&gt;Fixed minor nit and removed &lt;tt&gt;isMemberJoining&lt;/tt&gt; assertion. Tests were resubmitted and seem OK.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-10485-ultimate&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-10485-ultimate&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-10485-ultimate&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-10485-ultimate&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-10485-ultimate-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-10485-ultimate-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-10485-ultimate-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-10485-ultimate-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-10485-ultimate-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-10485-ultimate-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-10485-ultimate-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-10485-ultimate-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15002757" author="aweisberg" created="Thu, 12 Nov 2015 19:44:25 +0000"  >&lt;p&gt;+1 LGTM&lt;/p&gt;</comment>
                            <comment id="15004062" author="jmckenzie" created="Fri, 13 Nov 2015 14:52:10 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commit;h=e291382fd00e4c7fc9258116885267515da3c49c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;e291382fd00e4c7fc9258116885267515da3c49c&lt;/a&gt; to 2.1 and merged up (applying &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commit;h=ed424bdd65ccf11742f2016ae5bc0b3ad5a99571&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; patch on the way).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12678861">CASSANDRA-6335</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12860774">CASSANDRA-10233</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 1 week, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mrkv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325022">1.2.11</customfieldvalue>
    <customfieldvalue id="12328951">2.1.3</customfieldvalue>
    <customfieldvalue id="12332829">2.1.8</customfieldvalue>
    <customfieldvalue id="12333059">2.2.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aweisberg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>