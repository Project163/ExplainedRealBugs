<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:07:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13549] Cqlsh throws and error when querying a duration data type</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13549</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;h3&gt;&lt;a name=&quot;Overview&quot;&gt;&lt;/a&gt;Overview&lt;/h3&gt;

&lt;p&gt;Querying duration related data from the cqlsh prompt results in an error.&lt;/p&gt;

&lt;p&gt;Consider the following create table and insert statement.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Table and insert statement with duration data type&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE duration_test (
  primary_key text,
  col20 duration,
  PRIMARY KEY (primary_key)
);
INSERT INTO duration_test (primary_key, col20) VALUES (&lt;span class=&quot;code-quote&quot;&gt;&apos;primary_key_example&apos;&lt;/span&gt;, 1y5mo89h4m48s);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;On executing a select query on col20 in cqlsh I get an error &quot;Failed to format value &apos;&quot;\x00\xfe\x02GS\xfc\xa5\xc0\x00&apos; : &apos;ascii&apos; codec can&apos;t decode byte 0xfe in position 2: ordinal not in range(128)&quot;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;Duration Query&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Select  col20 from duration_test;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h3&gt;&lt;a name=&quot;Investigation&quot;&gt;&lt;/a&gt;Investigation&lt;/h3&gt;

&lt;p&gt;On investigating this further I found that the current python Cassandra driver used found in lib/cassandra-driver-internal-only-3.7.0.post0-2481531.zip does not seem to support duration data type. This was added in Jan this year &lt;a href=&quot;https://github.com/datastax/python-driver/pull/689&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/datastax/python-driver/pull/689&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;So I downloaded the latest driver release &lt;a href=&quot;https://github.com/datastax/python-driver/releases/tag/3.9.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/datastax/python-driver/releases/tag/3.9.0&lt;/a&gt;. I embedded the latest driver into cassandra-driver-internal-only-3.7.0.post0-2481531.zip. This fixed the driver related issue but there was still a formatting issue. &lt;/p&gt;

&lt;p&gt;I then went on to modify the format_value_duration methos in the pylib/cqlshlib/formatting.py. Diff posted below&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; @formatter_for(&lt;span class=&quot;code-quote&quot;&gt;&apos;Duration&apos;&lt;/span&gt;)
 def format_value_duration(val, colormap, **_):
-    buf = six.iterbytes(val)
-    months = decode_vint(buf)
-    days = decode_vint(buf)
-    nanoseconds = decode_vint(buf)
-    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; format_python_formatted_type(duration_as_str(months, days, nanoseconds), colormap, &lt;span class=&quot;code-quote&quot;&gt;&apos;duration&apos;&lt;/span&gt;)
+    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; format_python_formatted_type(duration_as_str(val.months, val.days, val.nanoseconds), colormap, &lt;span class=&quot;code-quote&quot;&gt;&apos;duration&apos;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This resulted in fixing the issue and duration types are now correctly displayed.&lt;/p&gt;

&lt;p&gt;Happy to fix the issue if I can get some guidance on:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;If this is a valid issue. Tried searching JIRA but did not find anything reported.&lt;/li&gt;
	&lt;li&gt;If my assumptions are correct i.e. this is actually a bug&lt;/li&gt;
	&lt;li&gt;how to package the new driver into the source code.&lt;/li&gt;
&lt;/ol&gt;







</description>
                <environment>&lt;p&gt;Cassandra 3.10 dev environment running on a MacOS Sierra&lt;/p&gt;</environment>
        <key id="13074352">CASSANDRA-13549</key>
            <summary>Cqlsh throws and error when querying a duration data type</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="akhilm">Akhil Mehra</assignee>
                                    <reporter username="akhilm">Akhil Mehra</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 May 2017 23:00:49 +0000</created>
                <updated>Fri, 15 May 2020 08:05:14 +0000</updated>
                            <resolved>Mon, 29 May 2017 15:46:07 +0000</resolved>
                                        <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16022465" author="blerer" created="Wed, 24 May 2017 07:47:08 +0000"  >&lt;p&gt;I need to have a look into it because, it should have worked with the &lt;tt&gt;3.10&lt;/tt&gt; internal driver even if it was not supporting natively durations. &lt;/p&gt;</comment>
                            <comment id="16022902" author="blerer" created="Wed, 24 May 2017 13:39:06 +0000"  >&lt;p&gt;I am not fully sure of what changed at the driver level since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11873&quot; title=&quot;Add duration type&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11873&quot;&gt;&lt;del&gt;CASSANDRA-11873&lt;/del&gt;&lt;/a&gt; was committed.&lt;/p&gt;

&lt;p&gt;With the current internal driver (&lt;tt&gt;cassandra-driver-internal-only-3.7.0.post0-2481531.zip&lt;/tt&gt;) the CQL type being returned is a custom type.&lt;br/&gt;
Which makes sense as it is the type returned by Cassandra for &lt;tt&gt;Duration&lt;/tt&gt; when the protocol version is &lt;tt&gt;4&lt;/tt&gt;.&lt;br/&gt;
Due to that the proper formatter is not found correctly and the &lt;tt&gt;ascii&lt;/tt&gt; one is used.&lt;br/&gt;
With the latest driver. Even if C* return a custom type the driver map it to a &lt;tt&gt;duration&lt;/tt&gt; and return a &lt;tt&gt;Duration&lt;/tt&gt; object that cannot be processed by the current formatter.&lt;/p&gt;

&lt;p&gt;The proper fix is in my opinion to provide 2 formatters in the 3.11 version one for the custom type and one for the duration type.&lt;/p&gt;

&lt;p&gt;I have pushed a patch for it &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:13549-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aholmber&quot; class=&quot;user-hover&quot; rel=&quot;aholmber&quot;&gt;aholmber&lt;/a&gt; does my approach make sense to you?&lt;/p&gt;

</comment>
                            <comment id="16023342" author="aholmber" created="Wed, 24 May 2017 17:57:43 +0000"  >&lt;p&gt;Historically we would only have one formatter because it is assumed that the combination of bundled driver, and protocol version in use is fixed for a given version of cqlsh. I could see making the case for two if you don&apos;t want to upgrade now, but want to be defensive about changes in driver version, or possibly to maintain parity in `cqlshlib.formatting` across branches. I don&apos;t know of anything that would preclude updating the bundled driver at this point.&lt;/p&gt;

&lt;p&gt;I&apos;m still a little perplexed by what changed if there was no driver upgrade, but I haven&apos;t gone looking.&lt;/p&gt;

&lt;p&gt;To answer the earlier question:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;how to package the new driver into the source code.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;See &lt;a href=&quot;https://wiki.apache.org/cassandra/HowToContribute#Bundled_Drivers&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://wiki.apache.org/cassandra/HowToContribute#Bundled_Drivers&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16023599" author="blerer" created="Wed, 24 May 2017 20:11:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m still a little perplexed by what changed if there was no driver upgrade, but I haven&apos;t gone looking.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We updated the driver since  &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11873&quot; title=&quot;Add duration type&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11873&quot;&gt;&lt;del&gt;CASSANDRA-11873&lt;/del&gt;&lt;/a&gt; but I am not convinced that the problem was coming from there. I suspect that it was caused by some change I did but I could not find which change was the guilty one &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;My concern was that the &lt;tt&gt;duration&lt;/tt&gt; is not required for the protocol &lt;tt&gt;V4&lt;/tt&gt; but only for &lt;tt&gt;V5&lt;/tt&gt;. Nevertheless, updating the driver is what make the most sense.&lt;/p&gt;

&lt;p&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=akhilm&quot; class=&quot;user-hover&quot; rel=&quot;akhilm&quot;&gt;akhilm&lt;/a&gt; The fix that you suggested is the good one &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; If you want to finish the work that you started feel free to asign the ticket to yourself and put me as reviewer.&lt;/p&gt;</comment>
                            <comment id="16024534" author="akhilm" created="Thu, 25 May 2017 10:53:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; Thanks for the feedback. Will complete the fix. I do not have permissions to assign the ticket to myself. Can you please assign the ticket to me or give me permission to assign the ticket to myself. Thanks&lt;/p&gt;
</comment>
                            <comment id="16025638" author="akhilm" created="Fri, 26 May 2017 01:18:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; I just noticed that version 3.10.0 of the python driver was released yesterday (&lt;a href=&quot;https://github.com/datastax/python-driver/releases/tag/3.10.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/datastax/python-driver/releases/tag/3.10.0&lt;/a&gt;). Tested my changes against 3.10.0 and everything worked as expected.&lt;/p&gt;

&lt;p&gt;Do you want me to stick with the 3.9.0 driver or switch to the 3.10.0 driver as it is the latest?&lt;/p&gt;

&lt;p&gt;Thanks for your input. &lt;/p&gt;
</comment>
                            <comment id="16025706" author="akhilm" created="Fri, 26 May 2017 02:23:58 +0000"  >&lt;p&gt;I have committed the changes to the following two branches.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/amehra/cassandra/tree/13549-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13549-trunk&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/amehra/cassandra/tree/13549-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;13549-3.11&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Both branches have 3.10.0 driver in them and the required changes in formatting.py. If you want me to drop it back to 3.9.0 python driver please let me know. &lt;/p&gt;

&lt;p&gt;Is there any way I can run the dtests on these two branches on &lt;a href=&quot;http://cassci.datastax.com/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/&lt;/a&gt; ?&lt;/p&gt;

&lt;p&gt;Thanks &lt;/p&gt;</comment>
                            <comment id="16028135" author="blerer" created="Mon, 29 May 2017 08:23:54 +0000"  >&lt;p&gt;Thanks for the patches &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;If you want me to drop it back to 3.9.0 python driver please let me know. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;According to the driver &lt;a href=&quot;https://github.com/datastax/python-driver/blob/master/CHANGELOG.rst&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CHANGELOGS&lt;/a&gt; the support for the &lt;tt&gt;Duration&lt;/tt&gt; type has been added to the &lt;tt&gt;3.10&lt;/tt&gt; version so we should use that one. It also not make a lot of sense to build a pre-release of &lt;tt&gt;3.11&lt;/tt&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Is there any way I can run the dtests on these two branches on &lt;a href=&quot;http://cassci.datastax.com/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/&lt;/a&gt; ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;tt&gt;cassci&lt;/tt&gt; will soon be shutdown so we should not run build there anymore. I will run the tests for the 2 branches on our internal CI.&lt;/p&gt;

</comment>
                            <comment id="16028456" author="blerer" created="Mon, 29 May 2017 15:20:09 +0000"  >&lt;p&gt;I ran the test for 3.11 and trunk. There are few failling CQLSH tests but they were failing before the patch so I am +1 for the patch.&lt;/p&gt;

&lt;p&gt;Thanks for the work.&lt;/p&gt;</comment>
                            <comment id="16028481" author="blerer" created="Mon, 29 May 2017 15:46:08 +0000"  >&lt;p&gt;Committed into 3.11 at 5a860a70f28b7756e0073d2d5d239b5e748a0b73 and merged into trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[akhilm]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 25 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3fdpj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12337348">3.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>