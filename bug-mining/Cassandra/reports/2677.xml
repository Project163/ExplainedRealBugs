<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:43:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6557] CommitLogSegment may be duplicated in unlikely race scenario</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6557</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In the unlikely event that the thread that switched to a new CLS has not finished executing the cleanup of its switch by the time the CLS has finished being used, it is possible for the same segment to be &apos;switched&apos; in again. This would be benign except that it is added to the activeSegments queue a second time also, which would permit it to be recycled twice, creating two different CLS objects in memory pointing to the same CLS on disk, after which all bets are off.&lt;/p&gt;

&lt;p&gt;The issue is highly unlikely to occur, but highly unlikely means it will probably happen eventually. I&apos;ve fixed this based on my patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5549&quot; title=&quot;Remove Table.switchLock&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5549&quot;&gt;&lt;del&gt;CASSANDRA-5549&lt;/del&gt;&lt;/a&gt;, using the NonBlockingQueue I introduce there to simplify the logic and make it more obviously correct.&lt;/p&gt;</description>
                <environment>&lt;p&gt;2.1&lt;/p&gt;</environment>
        <key id="12687677">CASSANDRA-6557</key>
            <summary>CommitLogSegment may be duplicated in unlikely race scenario</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Jan 2014 16:32:24 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:56 +0000</updated>
                            <resolved>Fri, 14 Mar 2014 17:40:31 +0000</resolved>
                                        <fixVersion>2.1 beta2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13864376" author="benedict" created="Tue, 7 Jan 2014 16:43:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/iss-6557&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/belliottsmith/cassandra/tree/iss-6557&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13874376" author="jbellis" created="Fri, 17 Jan 2014 03:14:31 +0000"  >&lt;p&gt;Can you give an overview of the fix?&lt;/p&gt;</comment>
                            <comment id="13874380" author="benedict" created="Fri, 17 Jan 2014 03:20:32 +0000"  >&lt;p&gt;Basically I&apos;ve merged allocateFrom (the &quot;current&quot; segment) with availableSegments (the next segments we will use), eliminating the interval between setting the new segment in allocateFrom and removing it from availableSegments. i.e. allocateFrom is now just the head of the queue, and to move to the next segment you just (approximately) call advanceHeadIf(oldSegment)&lt;/p&gt;</comment>
                            <comment id="13874432" author="jbellis" created="Fri, 17 Jan 2014 04:52:26 +0000"  >&lt;p&gt;Just to make sure we&apos;re talking about the same problem:&lt;/p&gt;

&lt;p&gt;Say I have allocatingFrom=X, active = &lt;span class=&quot;error&quot;&gt;&amp;#91;X, Y&amp;#93;&lt;/span&gt;, and available=&lt;span class=&quot;error&quot;&gt;&amp;#91;Z&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;Someone calls advanceAllocatingFrom.  We iterate over available, and try to swap the first element into allocatingFrom.&lt;/p&gt;

&lt;p&gt;So now we have &lt;br/&gt;
old = X&lt;br/&gt;
aF = Z&lt;br/&gt;
active = &lt;span class=&quot;error&quot;&gt;&amp;#91;X, Y&amp;#93;&lt;/span&gt;&lt;br/&gt;
available = &lt;span class=&quot;error&quot;&gt;&amp;#91;Z&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Our next step is to remove Z from available and add it to active, but if another thread calls advanceAllocatingFrom before that happens, the initial thread running aAF and the other will both add Z to active, so we&apos;ll have &lt;span class=&quot;error&quot;&gt;&amp;#91;X, Y, Z, Z&amp;#93;&lt;/span&gt; which is a violation of our design.&lt;/p&gt;

&lt;p&gt;It seems to me that we can fix this much more easily by simply dequeuing the element from available before trying to CAS.  If we fail, we can add it back.  This is a relatively rare operation, and a race even more rare, so it doesn&apos;t have to be super optimized.&lt;/p&gt;</comment>
                            <comment id="13874625" author="benedict" created="Fri, 17 Jan 2014 10:23:20 +0000"  >&lt;p&gt;I agree it doesn&apos;t need to be super-optimised, and we could use the design you suggest, &lt;em&gt;if&lt;/em&gt; we were to modify CLS so that we can create it in the aAF method with the correct segment id. As it stands, the segment ids are assigned in the CLSM thread, so they need to be added to active/allocatingFrom in the order they are added to available. I don&apos;t think this is a very neat solution, though, as the CLSM thread needs to at least assign the first segment id, and we&apos;d need an intermediate object.&lt;/p&gt;

&lt;p&gt;The alternative, of course, is to lock when we want to aAF. As you say, it&apos;s a rare operation, and it would be fine to lock for it. I thought it was a bit ugly in the original MT CL patch, but it doesn&apos;t absolutely &lt;b&gt;need&lt;/b&gt; NBQ, so if we want to avoid adding it for now, we can. &lt;/p&gt;

&lt;p&gt;I had planned to move active and available to a single NBQ, with active a NBQV on the available NBQ, at some point in the near future, as it more accurately models what we&apos;re doing (it&apos;s just a single queue we have, in three parts, and we just treat the parts slightly differently), but that is also not strictly necessary. I think it simplifies the algorithm, though.&lt;/p&gt;</comment>
                            <comment id="13874631" author="benedict" created="Fri, 17 Jan 2014 10:30:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;active a NBQV on the available NBQ&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Just to clarify how this would work: a NBQ can create views on their data that retain references to any items polled from the original after the view was created. A view created on available at startup would basically have the option of polling/iterating over all items added to available, just on its own schedule. So we would do nothing to maintain allocatingFrom or active, we would just poll/remove items from their queue as necessary, based on their own criteria.&lt;/p&gt;</comment>
                            <comment id="13874724" author="jbellis" created="Fri, 17 Jan 2014 12:39:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;The alternative, of course, is to lock when we want to aAF. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Let&apos;s do that for now then.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;it doesn&apos;t absolutely need NBQ, so if we want to avoid adding it for now, we can&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You have correctly divined my motivation. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13874732" author="benedict" created="Fri, 17 Jan 2014 12:50:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;Let&apos;s do that for now then.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Okay. I&apos;ll hold off until we decide if the off-heap memtables are going to make it into 2.1, as they really &lt;b&gt;need&lt;/b&gt; need the NBQ. There are at least two spots where without atomic swapping of head/tail pointers the algorithm will be either unsafe, have unreasonable consequences, or unreasonable performance tradeoffs. Or, at least, we can decide that when we come to it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;


</comment>
                            <comment id="13931672" author="benedict" created="Wed, 12 Mar 2014 11:51:19 +0000"  >&lt;p&gt;Updated version that uses synchronized block for the swap, instead of CAS&lt;/p&gt;</comment>
                            <comment id="13935308" author="jbellis" created="Fri, 14 Mar 2014 17:40:32 +0000"  >&lt;p&gt;LGTM, committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12634141" name="6557.2.txt" size="3087" author="benedict" created="Wed, 12 Mar 2014 11:51:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366677</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 36 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1r7ef:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>366988</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>