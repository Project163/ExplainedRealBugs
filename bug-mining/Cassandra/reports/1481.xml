<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:29:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3821] Counters in super columns don&apos;t preserve correct values after cluster restart</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3821</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Set up a 3-node cluster with rf=3. Create a counter super column family and increment a bunch of subcolumns 100 times each, with cf=QUORUM. Then wait a few second, restart the cluster, and read the values back. They almost all come back different (and higher) then they are supposed to be.&lt;/p&gt;

&lt;p&gt;Here are some extra things I&apos;ve noticed:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Reading back the values before the restart always produces correct results.&lt;/li&gt;
	&lt;li&gt;Doing a nodetool flush before killing the cluster greatly improves the results, though sometimes a value will still be incorrect. You might have to run the test several times to see an incorrect value after a flush.&lt;/li&gt;
	&lt;li&gt;This problem doesn&apos;t happen on C* 1.0.7, unless you don&apos;t sleep between doing the increments and killing the cluster. Then it sometimes happens to a lesser degree.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;A dtest has been added to demonstrate this issue. It is called &quot;super_counter_test.py&quot;.&lt;/p&gt;</description>
                <environment>&lt;p&gt;ubuntu, &apos;trunk&apos; branch, used ccm to create a 3 node cluster with rf=3. A dtest was created to demonstrate.&lt;/p&gt;</environment>
        <key id="12540677">CASSANDRA-3821</key>
            <summary>Counters in super columns don&apos;t preserve correct values after cluster restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="tpatterson">Tyler Patterson</reporter>
                        <labels>
                    </labels>
                <created>Wed, 1 Feb 2012 05:37:24 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:41 +0000</updated>
                            <resolved>Wed, 22 Feb 2012 08:42:33 +0000</resolved>
                                        <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13201768" author="yukim" created="Mon, 6 Feb 2012 23:23:56 +0000"  >&lt;p&gt;Here is my initial look at the issue (might be wrong):&lt;/p&gt;

&lt;p&gt;Concurrent counter mutation replay from commitlog and AtomicSortedColumns inside Memtable seem to be the cause of over count.&lt;br/&gt;
There is a race condition when adding column to memtable, and when it happens AtomicSortedColumns calls {{&lt;/p&gt;
{IColumn#reconcile}
&lt;p&gt;}} multiple times until column is stored. It causes over count since counter column&apos;s &lt;tt&gt;reconcile&lt;/tt&gt; is not idempotent operation.&lt;/p&gt;</comment>
                            <comment id="13202167" author="slebresne" created="Tue, 7 Feb 2012 08:36:31 +0000"  >&lt;p&gt;Damn you super columns, there is nothing super about you!&lt;/p&gt;

&lt;p&gt;Yuki is right that super columns are a problem for AtomicSortedColumns. Columns are immutable, so for them the multiple reconcile of ASC is not a problem since it&apos;s done on a cloned underlying map. But SuperColumns are not immutable. So even though the ASC (potential) mutliple attempts are made on a cloned map, the super columns structure themselves are not cloned, and so all these attempts modify the original SC. This does mean that SC are not isolated (I did knew about that, but somehow forget about it and certainly didn&apos;t realize the consequence on counters).&lt;/p&gt;

&lt;p&gt;Anyway, I don&apos;t see an easy one line fix, so I would suggest to rather add back the ThreadSafeSortedColumns backing map and to use that for super column family, since super column family are not really isolated anyway. Then I guess, I&apos;ll make &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3237&quot; title=&quot;refactor super column implmentation to use composite column names instead&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3237&quot;&gt;&lt;del&gt;CASSANDRA-3237&lt;/del&gt;&lt;/a&gt; a higher priority on my todo list.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This problem doesn&apos;t happen on C* 1.0.7, unless you don&apos;t sleep between doing the increments and killing the cluster. Then it sometimes happens to a lesser degree.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The explanation above doesn&apos;t explain that. It would be worth investigating that separately (maybe a separate ticket).&lt;/p&gt;</comment>
                            <comment id="13212807" author="slebresne" created="Tue, 21 Feb 2012 19:09:30 +0000"  >&lt;p&gt;Attached patch that as said in previous comment reintroduce ConcurrentSkipListMap backed CF and use them for super column family. It fixes the distributed test.&lt;/p&gt;</comment>
                            <comment id="13213036" author="yukim" created="Tue, 21 Feb 2012 22:31:59 +0000"  >&lt;p&gt;I also ran dtest and confirmed the issue was fixed. so +1.&lt;/p&gt;</comment>
                            <comment id="13213460" author="slebresne" created="Wed, 22 Feb 2012 08:42:34 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12515467" name="3821.txt" size="9097" author="slebresne" created="Tue, 21 Feb 2012 19:09:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>226072</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 39 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gomf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95419</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>