<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:09:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12014] IndexSummary &gt; 2G causes an assertion error</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12014</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [CompactionExecutor:1546280] 2016-06-01 13:21:00,444  CassandraDaemon.java:229 - Exception in thread Thread[CompactionExecutor:1546280,1,main]
java.lang.AssertionError: null
    at org.apache.cassandra.io.sstable.IndexSummaryBuilder.maybeAddEntry(IndexSummaryBuilder.java:171) ~[cassandra-all-2.1.12.1046.jar:2.1.12.1046]
    at org.apache.cassandra.io.sstable.SSTableWriter$IndexWriter.append(SSTableWriter.java:634) ~[cassandra-all-2.1.12.1046.jar:2.1.12.1046]
    at org.apache.cassandra.io.sstable.SSTableWriter.afterAppend(SSTableWriter.java:179) ~[cassandra-all-2.1.12.1046.jar:2.1.12.1046]
    at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:205) ~[cassandra-all-2.1.12.1046.jar:2.1.12.1046]
    at org.apache.cassandra.io.sstable.SSTableRewriter.append(SSTableRewriter.java:126) ~[cassandra-all-2.1.12.1046.jar:2.1.12.1046]
    at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:197) ~[cassandra-all-2.1.12.1046.jar:2.1.12.1046]
    at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[cassandra-all-2.1.12.1046.jar:2.1.12.1046]
    at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:73) ~[cassandra-all-2.1.12.1046.jar:2.1.12.1046]
    at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59) ~[cassandra-all-2.1.12.1046.jar:2.1.12.1046]
    at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionCandidate.run(CompactionManager.java:263) ~[cassandra-all-2.1.12.1046.jar:2.1.12.1046]
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_51]
    at java.util.concurrent.FutureTask.run(FutureTask.java:262) ~[na:1.7.0_51]
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_51]
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_51]
    at java.lang.Thread.run(Thread.java:744) [na:1.7.0_51]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I believe this can be fixed by raising the min_index_interval, but we should have a better method of coping with this than throwing the AE.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12979527">CASSANDRA-12014</key>
            <summary>IndexSummary &gt; 2G causes an assertion error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Wed, 15 Jun 2016 20:53:23 +0000</created>
                <updated>Wed, 15 Oct 2025 09:48:59 +0000</updated>
                            <resolved>Wed, 13 Sep 2017 08:52:12 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="15389938" author="jbellis" created="Fri, 22 Jul 2016 18:03:31 +0000"  >&lt;p&gt;Still an issue on 3.0.x.&lt;/p&gt;</comment>
                            <comment id="15409693" author="estevezsebastian@gmail.com" created="Fri, 5 Aug 2016 16:43:33 +0000"  >&lt;p&gt;And 2.1 &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12394&quot; title=&quot;Node crashes during compaction with assertion error checking length of entries for IndexSummaryBuilder&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12394&quot;&gt;&lt;del&gt;CASSANDRA-12394&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15409703" author="brandon.williams" created="Fri, 5 Aug 2016 16:49:03 +0000"  >&lt;p&gt;I had the fixver set to 2.1.x, but Jonathan changed it.  Updated the repro version to reflect this is a problem in 2.1.&lt;/p&gt;</comment>
                            <comment id="15502777" author="stefania" created="Mon, 19 Sep 2016 09:01:28 +0000"  >&lt;p&gt;Currently running the 3.0 tests for the following patch, based on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; original code &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/commit/f086575751be3e69e4b68ce232e9cb85d222cc04&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12014-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12014&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12014-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12014-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12014-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-12014-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The idea is to avoid hitting the assertion by estimating an average key size (by looking at either the primary index or the index summaries of existing sstables), and to automatically increase min_index_interval if the total estimated size of the index summary is more than 2G. &lt;/p&gt;

&lt;p&gt;If we still hit the 2GB limit despite our best efforts to avoid this, we basically give up on the summary for the final part of the sstable. We could re-sample on the fly by dropping half the entries or extend the summary with multiple memory regions but I thought this would be an overkill, and early opening complicates matters further. I think we can live with a linear scan of the primary index if we hit 2G in the summary, as far as I understood the code the only down-side is a linear scan of the primary index for the final part of the sstable.&lt;/p&gt;</comment>
                            <comment id="15511961" author="jjirsa" created="Thu, 22 Sep 2016 03:14:13 +0000"  >&lt;p&gt;At &lt;a href=&quot;https://github.com/stef1927/cassandra/commit/4e3ca613ab17bca7c9c64b1b001abdb65d25ad04#diff-f0a15c3588b56c5ce53ece7c48e325b5R275&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/stef1927/cassandra/commit/4e3ca613ab17bca7c9c64b1b001abdb65d25ad04#diff-f0a15c3588b56c5ce53ece7c48e325b5R275&lt;/a&gt; - Any idea of the cost of averaging all partition keys in the memtable? &lt;/p&gt;
</comment>
                            <comment id="15512038" author="stefania" created="Thu, 22 Sep 2016 04:00:33 +0000"  >&lt;p&gt;Right, we don&apos;t need to scan the entire memtable, the first 50 keys should be enough for an estimate. The alternative is to keep track of the total size of keys with an atomic long but I thought that was a bit of an overkill. &lt;/p&gt;</comment>
                            <comment id="15515108" author="stefania" created="Fri, 23 Sep 2016 02:04:38 +0000"  >&lt;p&gt;The test results are clean now, the failures for testall on trunk happen on the unpatched branch as well. There were a couple of failing dtests for 3.0 that I could not trace to known failures, but they look unrelated and they passed locally and in the following builds on Jenkins. &lt;/p&gt;

&lt;p&gt;Therefore, this is ready for review.&lt;/p&gt;

&lt;p&gt;This is a relatively large patch for what it is trying to achieve, and consideration should be given on whether we want the patch in 3.0, at least in its full form. The reason is that in order to estimate the key size, we need to modify the call chain to create sstable writers, which not only involves adding a new parameter to a very long chain but also changing the vast number of callers. We should have a valid estimated key size when opening sstables, downsampling them, flushing memtables or compacting existing sstables. For other cases, mostly offline tools that don&apos;t use the summary, we use a default constant value that can be changed with a system property.&lt;/p&gt;

&lt;p&gt;There is also an extra commit in trunk for refactoring the large number of parameters in the call chain to create sstable writers. I tried to add the additional parameter introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10678&quot; title=&quot;add SSTable flush observer&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10678&quot;&gt;&lt;del&gt;CASSANDRA-10678&lt;/del&gt;&lt;/a&gt; to the new class that I introduced to group the parameters that should be known by the callers and that are optional, the new class also allows setting the parameters via a builder pattern. It should arguably be the same as the writer factory, but at the moment the factory is static. I don&apos;t think the creation of a new instance of this class is a performance concern, since we do this per sstable so I don&apos;t understand why so far we&apos;ve relied on a static factory with a large number of parameters in a very long call chain, which is good for performance but leaves very little flexibility.&lt;/p&gt;

&lt;p&gt;I did not use the builder pattern for 3.0, I was trying to avoid refactoring 3.0 code and, as mentioned already above, perhaps in 3.0 we should stick to using a default constant value for the key size.&lt;/p&gt;</comment>
                            <comment id="15553070" author="jmckenzie" created="Thu, 6 Oct 2016 20:19:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; - Care to take review on this one?&lt;/p&gt;</comment>
                            <comment id="15878612" author="stefania" created="Wed, 22 Feb 2017 16:19:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; I think this fell off the radar for both of us. Are you still OK being the reviewer? &lt;/p&gt;

&lt;p&gt;I strongly suggest we consider this &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...stef1927:12014-simplified-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;simplified patch&lt;/a&gt; for 3.0, and possibly for 3.11 and trunk as well. I don&apos;t think the size of the original patch is justified just to remove this assertion. The simplified patch is basically what you suggested initially, using a configurable default key size. Instead of failing with an assertion, it will log an error and use an incomplete index summary. WDYT?&lt;/p&gt;</comment>
                            <comment id="16001726" author="jjirsa" created="Mon, 8 May 2017 22:57:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; - this isn&apos;t on my radar at all (I knew about it, but it&apos;s not anywhere near the top of my list of things I need to do/review). I agree with the simplified patch, but if you have someone else who will review, I encourage you to find a new victim/volunteer. Otherwise, I suspect it&apos;ll be in a month or more (which doesn&apos;t feel long, when I see how long this ticket&apos;s been open).&lt;/p&gt;</comment>
                            <comment id="16156565" author="krummas" created="Thu, 7 Sep 2017 06:39:34 +0000"  >&lt;p&gt;the simplified patch looks good to me (rebased and pushed &lt;a href=&quot;https://github.com/krummas/cassandra/commits/stefania/12014&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;) &lt;br/&gt;
dtests: &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/288/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/288/&lt;/a&gt;&lt;br/&gt;
unit tests: &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/106&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/krummas/cassandra/106&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16157995" author="stefania" created="Fri, 8 Sep 2017 01:41:10 +0000"  >&lt;p&gt;Thanks for the review and the rebase. I&apos;ve updated my 3.0 &lt;a href=&quot;https://github.com/stef1927/cassandra/commits/12014-simplified-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; with the rebased code. The CI results don&apos;t look too good, there are several dtest failures and the unit tests did not run. I&apos;ve launched CI on our servers for 3.0. I&apos;ll merge to 3.0, 3.11 and trunk once I have the results. I don&apos;t expect any problems but just in case.&lt;/p&gt;
</comment>
                            <comment id="16158121" author="stefania" created="Fri, 8 Sep 2017 04:47:28 +0000"  >&lt;p&gt;Committed to 3.0 as ae88fd6c79b066f12ad76c2c1bfc1620d86bdbc5 and merged upwards.&lt;/p&gt;</comment>
                            <comment id="16163632" author="jjirsa" created="Tue, 12 Sep 2017 20:46:53 +0000"  >&lt;p&gt;FWIW, I think this unit test breaks circleCI, where the free plan runs tests on 4GB containers, and the new tests aren&apos;t ok with that. I realize there are &quot;other&quot; options besides circleCI, but it&apos;s the only free place where non-committers can easily run tests. &lt;/p&gt;

&lt;p&gt;Maybe we can alter it such that it skips the test if there&apos;s not enough RAM to run it?&lt;/p&gt;

&lt;p&gt;Perhaps something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/test/unit/org/apache/cassandra/io/sstable/IndexSummaryTest.java b/test/unit/org/apache/cassandra/io/sstable/IndexSummaryTest.java
index acac719..662d36a 100644
--- a/test/unit/org/apache/cassandra/io/sstable/IndexSummaryTest.java
+++ b/test/unit/org/apache/cassandra/io/sstable/IndexSummaryTest.java
@@ -26,6 +26,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.*;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; com.google.common.collect.Lists;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.BeforeClass;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Test;
+&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.junit.Assume;

 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.Util;
 &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; org.apache.cassandra.config.DatabaseDescriptor;
@@ -70,6 +71,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;IndexSummaryTest
     @Test
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testIndexSummaryKeySizes() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
     {
+        Assume.assumeTrue(&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.getRuntime().maxMemory() &amp;gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
         testIndexSummaryProperties(32, 100);
         testIndexSummaryProperties(64, 100);
         testIndexSummaryProperties(100, 100);
@@ -79,6 +81,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;IndexSummaryTest

     &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void testIndexSummaryProperties(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; keySize, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numKeys) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
     {
+        Assume.assumeTrue(&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.getRuntime().maxMemory() &amp;gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
         &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; minIndexInterval = 1;
         &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;DecoratedKey&amp;gt; keys = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;(numKeys);

@@ -114,6 +117,7 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;IndexSummaryTest
     @Test
     &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void tesLargeIndexSummary() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
     {
+        Assume.assumeTrue(&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.getRuntime().maxMemory() &amp;gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
         &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numKeys = 1000000;
         &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; keySize = 3000;
         &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; minIndexInterval = 1;
@@ -143,8 +147,9 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;IndexSummaryTest
      * the index summary should be downsampled automatically.
      */
     @Test
-    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void tesLargeIndexSummaryWithExpectedSizeMatching() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
+    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testLargeIndexSummaryWithExpectedSizeMatching() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
     {
+        Assume.assumeTrue(&lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;.getRuntime().maxMemory() &amp;gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
         &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; numKeys = 1000000;
         &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; keySize = 3000;
         &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; minIndexInterval = 1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16164093" author="stefania" created="Wed, 13 Sep 2017 03:20:31 +0000"  >&lt;p&gt;Testing this &lt;a href=&quot;https://github.com/stef1927/cassandra/commit/980b529cd8c1ecb44fb4c0ba88c4d023e302fda9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/stef1927/cassandra/2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. It should print out &lt;tt&gt;Runtime.getRuntime().maxMemory()&lt;/tt&gt; but I don&apos;t think it&apos;ll work.&lt;/p&gt;

&lt;p&gt;The problem is that on my laptop or on a Circle container, &lt;tt&gt;Runtime.getRuntime().maxMemory()&lt;/tt&gt; only returns about 900 MB when running the test from ant. This comes from &lt;tt&gt;-Xmx1024m&lt;/tt&gt;. The test passes (both locally and and on the container) because the memory is off-heap. &lt;/p&gt;

&lt;p&gt;So, if indeed this test causes the builds to fail when run in parallel, we need a different way to work out that we are on Circle. One suggestion would be to look at the environment variable &lt;tt&gt;CIRCLECI=true&lt;/tt&gt; as done in this &lt;a href=&quot;https://github.com/stef1927/cassandra/commit/77f9101117038f144d553b94980e8992de2d8d66&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt;. I tested it manually on Circle by ssh-ing into the build above and the test is skipped. I&apos;ve also queued a new &lt;a href=&quot;https://circleci.com/gh/stef1927/cassandra/3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; WDYT?&lt;/p&gt;
</comment>
                            <comment id="16164181" author="stefania" created="Wed, 13 Sep 2017 05:53:44 +0000"  >&lt;p&gt;So, both builds were fine and in both cases the tests were skipped (although I don&apos;t understand why I got a different result by ssh-ing into the container). I would still prefer to rely on the environment variable though, since the memory limit was arbitrary and not related to what the test actually uses (for that we&apos;d need a way to calculate the off-heap memory available).&lt;/p&gt;</comment>
                            <comment id="16164225" author="krummas" created="Wed, 13 Sep 2017 06:52:50 +0000"  >&lt;p&gt;Sure, lets rely on the env variable for now, if we get bigger containers in the future, we should remember to remove the check&lt;/p&gt;</comment>
                            <comment id="16164338" author="stefania" created="Wed, 13 Sep 2017 08:51:57 +0000"  >&lt;p&gt;Thanks. Committed fix relying on env. variable to 3.0 as 9882cd825ff95c88264c78dfcdc481aad6fc3522 and merged upwards.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12995238">CASSANDRA-12394</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13096831">CASSANDRA-13785</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 9 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ziw7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332167">2.1.x</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>