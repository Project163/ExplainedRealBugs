<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10837] Cluster/session should be closed in Cassandra Hadoop Input/Output classes</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10837</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;See a lot of following warnings during Hadoop job running&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR 11:37:45 LEAK: You are creating too many HashedWheelTimer instances.  HashedWheelTimer is a shared resource that must be reused across the JVM,so that only a few instances are created.

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Each cluster/session needs be closed and a shared HashedWheelTimer may reduce the resource leakage.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12920635">CASSANDRA-10837</key>
            <summary>Cluster/session should be closed in Cassandra Hadoop Input/Output classes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="alexliu68">Alex Liu</assignee>
                                    <reporter username="alexliu68">Alex Liu</reporter>
                        <labels>
                    </labels>
                <created>Thu, 10 Dec 2015 01:44:09 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:48 +0000</updated>
                            <resolved>Thu, 17 Dec 2015 13:53:55 +0000</resolved>
                                        <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.2</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15058713" author="blerer" created="Tue, 15 Dec 2015 20:14:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexliu68&quot; class=&quot;user-hover&quot; rel=&quot;alexliu68&quot;&gt;alexliu68&lt;/a&gt; Thanks for the patch.&lt;/p&gt;

&lt;p&gt;If I am not mistaken Netty is using &lt;tt&gt;HashedWheelTimer&lt;/tt&gt; to schedule task within the &lt;tt&gt;EventLoop&lt;/tt&gt; and a new &lt;tt&gt;EventLoop&lt;/tt&gt; will be created for each new &lt;tt&gt;Cluster&lt;/tt&gt; instance.&lt;/p&gt;

&lt;p&gt;I ran some simple tests using only the java driver. They confirmed that the ERROR is logged only when too many &lt;tt&gt;Cluster&lt;/tt&gt; instances are created.&lt;/p&gt;

&lt;p&gt;Regarding the patch I have the following comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The changes to &lt;tt&gt;CqlRecordWriter&lt;/tt&gt; seems wrong to me.
	&lt;ol&gt;
		&lt;li&gt;The &lt;tt&gt;Cluster&lt;/tt&gt; and the &lt;tt&gt;Session&lt;/tt&gt; instances were both properly managed by the &lt;a href=&quot;https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;try-with-resources&lt;/a&gt; statement. In the patch version only the &lt;tt&gt;Cluster&lt;/tt&gt; instance is closed.&lt;/li&gt;
		&lt;li&gt;Making the &lt;tt&gt;Cluster&lt;/tt&gt; an instance variable in &lt;tt&gt;NativeRingCache&lt;/tt&gt; will trigger an error when the &lt;tt&gt;write&lt;/tt&gt; method will be called, as the &lt;tt&gt;Cluster&lt;/tt&gt; has been closed at the end of the constructor.&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;CqlInputFormat&lt;/tt&gt; could you use &lt;tt&gt;try-with-resources&lt;/tt&gt; for both &lt;tt&gt;Cluster&lt;/tt&gt; and &lt;tt&gt;Session&lt;/tt&gt; instances. I think it is best to do things properly by closing both of them.&lt;/li&gt;
&lt;/ul&gt;


</comment>
                            <comment id="15058870" author="alexliu68" created="Tue, 15 Dec 2015 21:31:45 +0000"  >&lt;p&gt;The changes to CqlRecordWriter seems wrong to me.&lt;br/&gt;
The Cluster and the Session instances were both properly managed by the try-with-resources statement. In the patch version only the Cluster instance is closed.&lt;br/&gt;
================&lt;br/&gt;
&lt;a href=&quot;https://github.com/datastax/java-driver/blob/2.1/driver-core/src/main/java/com/datastax/driver/core/Cluster.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/datastax/java-driver/blob/2.1/driver-core/src/main/java/com/datastax/driver/core/Cluster.java&lt;/a&gt;&lt;br/&gt;
Cluster doesn&apos;t implement AutoClosable interface, so it has to be closed manually. Closing cluster will close all session objects associated with it. &lt;/p&gt;

&lt;p&gt;Making the Cluster an instance variable in NativeRingCache will trigger an error when the write method will be called, as the Cluster has been closed at the end of the constructor.&lt;br/&gt;
=================&lt;br/&gt;
NativeRingCache uses the cluster to get the metadata in the constructor when cluster object is still open. once the initialization of constructor is done, the cluster object is not used by NativeRingCache anymore.&lt;/p&gt;

&lt;p&gt;In CqlInputFormat could you use try-with-resources for both Cluster and Session instances. I think it is best to do things properly by closing both of them.&lt;br/&gt;
================&lt;br/&gt;
Similarly closing cluster object auto-close all sessions objects.&lt;/p&gt;</comment>
                            <comment id="15058991" author="blerer" created="Tue, 15 Dec 2015 22:30:22 +0000"  >&lt;blockquote&gt;&lt;p&gt; Cluster doesn&apos;t implement AutoClosable interface, so it has to be closed manually. Closing cluster will close all session objects associated with it. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;tt&gt;Closeable&lt;/tt&gt; extends &lt;tt&gt;AutoCloseable&lt;/tt&gt; so you can use &lt;tt&gt;close-with-resources&lt;/tt&gt; &lt;br/&gt;
We have no guaranties on the &lt;tt&gt;Cluster.close()&lt;/tt&gt; implementation. So let&apos;s do things properly: first closing the &lt;tt&gt;Sessions&lt;/tt&gt; then closing the &lt;tt&gt;Cluster&lt;/tt&gt;. It is the best way to avoid bad surprises.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;NativeRingCache uses the cluster to get the metadata in the constructor when cluster object is still open. once the initialization of constructor is done, the cluster object is not used by NativeRingCache anymore.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If the cluster is only used in the constructor there is not need to store it as an instance variable. Sooner or later somebody will try to use it and burn his/her fingers. &lt;br/&gt;
The &lt;tt&gt;Cluster&lt;/tt&gt;, or even better the &lt;tt&gt;Metadata&lt;/tt&gt;, should be passed as an argument to the &lt;tt&gt;refreshEndpointMap&lt;/tt&gt; method.&lt;br/&gt;
There is also no need to open a &lt;tt&gt;Session&lt;/tt&gt; to get the &lt;tt&gt;Metadata&lt;/tt&gt; &lt;/p&gt;</comment>
                            <comment id="15059162" author="alexliu68" created="Wed, 16 Dec 2015 00:09:59 +0000"  >&lt;p&gt;Summary the change for next patch.&lt;/p&gt;

&lt;p&gt;1. keep use close-with-resources for cluster and session (Don&apos;t need manually close them)&lt;br/&gt;
2. pass cluster to NativeRingCache (Don&apos;t create too many new cluster objects)&lt;/p&gt;</comment>
                            <comment id="15059195" author="alexliu68" created="Wed, 16 Dec 2015 00:29:05 +0000"  >&lt;p&gt;Attach v3 path to use close-with-resources and pass cluster to NativeRingCache to minimize creating new cluster objects&lt;/p&gt;</comment>
                            <comment id="15059851" author="blerer" created="Wed, 16 Dec 2015 11:27:05 +0000"  >&lt;p&gt;I slightly modified the V3 patch to fix some nits that I found during the review:&lt;br/&gt;
In &lt;tt&gt;CqlRecordWriter&lt;/tt&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the patch inlines &lt;tt&gt;refreshEndPoint&lt;/tt&gt;: the name was not making sense anymore and it removes the need to store the &lt;tt&gt;Configuration&lt;/tt&gt; as an instance variable.&lt;/li&gt;
	&lt;li&gt;The &lt;tt&gt;NativeRingCache&lt;/tt&gt; constructor now takes &lt;tt&gt;Metadata&lt;/tt&gt; as argument instead of the &lt;tt&gt;Cluster&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;The patch makes sure that the &lt;tt&gt;metadata&lt;/tt&gt; field is set. It was not, which would have caused a &lt;tt&gt;NPE&lt;/tt&gt; if somebody had called the &lt;tt&gt;getRange&lt;/tt&gt; method.&lt;/li&gt;
	&lt;li&gt;The patch moves the call to &lt;tt&gt;closeInternal&lt;/tt&gt; inside the finally block to make sure that the &lt;tt&gt;Cluster&lt;/tt&gt; is closed even if an Exception is thrown.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In &lt;tt&gt;CqlInputFormat&lt;/tt&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The patch modify the &lt;tt&gt;getRangeMap&lt;/tt&gt; method to avoid the unnecessary creation of a new &lt;tt&gt;Cluster&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexliu68&quot; class=&quot;user-hover&quot; rel=&quot;alexliu68&quot;&gt;alexliu68&lt;/a&gt; could you review the changes and verify that everything is working fine in your environment?&lt;/p&gt;</comment>
                            <comment id="15060238" author="alexliu68" created="Wed, 16 Dec 2015 16:25:12 +0000"  >&lt;p&gt;+1, The patch can&apos;t be applied to my testing environment for it&apos;s used in a slightly different branch. The patches looks good to me, some simple testing should be enough to verify it.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12776932" name="10837-3.0-branch.txt" size="13068" author="alexliu68" created="Fri, 11 Dec 2015 00:47:16 +0000"/>
                            <attachment id="12777974" name="10837-3.0-v4.txt" size="13698" author="blerer" created="Wed, 16 Dec 2015 11:27:05 +0000"/>
                            <attachment id="12776940" name="10837-v2-3.0-branch.txt" size="11137" author="alexliu68" created="Fri, 11 Dec 2015 01:29:16 +0000"/>
                            <attachment id="12777870" name="10837-v3-3.0-branch.txt" size="11467" author="alexliu68" created="Wed, 16 Dec 2015 00:25:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[alexliu68]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2pp27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>