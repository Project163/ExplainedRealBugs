<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:31:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-20251] Flaky test - org.apache.cassandra.distributed.test.ReadSpeculationTest</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-20251</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/5285/workflows/20d3f23b-d9e5-4130-8c28-d87682f919de/jobs/329400/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/5285/workflows/20d3f23b-d9e5-4130-8c28-d87682f919de/jobs/329400/tests&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
junit.framework.AssertionFailedError: 
Expecting actual:
  6434477L
to be greater than:
  2000000000L

	at org.apache.cassandra.distributed.test.ReadSpeculationTest$TestScenario.assertWillSpeculate(ReadSpeculationTest.java:172)
	at org.apache.cassandra.distributed.test.ReadSpeculationTest.lambda$speculateTest$81c80a4a$2(ReadSpeculationTest.java:74)
	at org.apache.cassandra.concurrent.FutureTask$2.call(FutureTask.java:124)
	at org.apache.cassandra.concurrent.FutureTask.call(FutureTask.java:61)
	at org.apache.cassandra.concurrent.FutureTask.run(FutureTask.java:71)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Present in Butler as well: &lt;a href=&quot;https://butler.cassandra.apache.org/#/ci/upstream/workflow/Cassandra-trunk/failure/org.apache.cassandra.distributed.test/ReadSpeculationTest/speculateTest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://butler.cassandra.apache.org/#/ci/upstream/workflow/Cassandra-trunk/failure/org.apache.cassandra.distributed.test/ReadSpeculationTest/speculateTest&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13606354">CASSANDRA-20251</key>
            <summary>Flaky test - org.apache.cassandra.distributed.test.ReadSpeculationTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dnk">Dmitry Konstantinov</assignee>
                                    <reporter username="dnk">Dmitry Konstantinov</reporter>
                        <labels>
                    </labels>
                <created>Mon, 27 Jan 2025 11:22:14 +0000</created>
                <updated>Sun, 23 Feb 2025 16:29:00 +0000</updated>
                            <resolved>Sun, 23 Feb 2025 07:39:43 +0000</resolved>
                                        <fixVersion>5.1</fixVersion>
                                    <component>Test/dtest/java</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17923779" author="smiklosovic" created="Tue, 4 Feb 2025 16:56:04 +0000"  >&lt;p&gt;I see this often too. &lt;/p&gt;</comment>
                            <comment id="17923782" author="dcapwell" created="Tue, 4 Feb 2025 17:17:36 +0000"  >&lt;p&gt;I wouldn&apos;t say often but its popped up a few times, I just reported this as we are trying to get to 0 failures in accord and this wasn&apos;t on our previous list; thanks for posting this!&lt;/p&gt;</comment>
                            <comment id="17927420" author="dnk" created="Sat, 15 Feb 2025 16:56:23 +0000"  >&lt;p&gt;I have analyzed the logs for the failed run and think that the root cause is the following: an implicit assumption made in ReadSpeculationTest is not always true for TCM. The test expects that we always try to send a read request from 1st node to 2nd and then (because we drop messages between 1s and 2nd nodes) we will do a speculative retry to 3rd node.&lt;/p&gt;

&lt;p&gt;The order is defined by&#160;ReplicaPlan constructed based on Snitch information in pre-5.1 versions and using TCM information in 5.1 (if it is enabled).&lt;/p&gt;

&lt;p&gt;It looks like with TCM we may get a different order sometimes, below is an extract from node system logs for the failed test run, here we have NodeId with a different order compared to test instances num/IPs:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO &#160;[node1_isolatedExecutor:1] node1 2025-01-27 10:44:56,612 Register.java:128 - Registered with endpoint /127.0.0.1:7012, node id: NodeId{id=1}
INFO &#160;[node2_isolatedExecutor:2] node2 2025-01-27 10:45:01,899 Register.java:128 - Registered with endpoint /127.0.0.2:7012, node id: NodeId{id=3}
INFO &#160;[node3_isolatedExecutor:2] node3 2025-01-27 10:45:01,683 Register.java:128 - Registered with endpoint /127.0.0.3:7012, node id: NodeId{id=2} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17927490" author="dnk" created="Sun, 16 Feb 2025 11:52:16 +0000"  >&lt;p&gt;MR with a possible option to fix the issue: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3901&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3901&lt;/a&gt; by checking what is the second actual replica in the read plan and using this information to drop messages between right nodes.&lt;/p&gt;</comment>
                            <comment id="17927494" author="dnk" created="Sun, 16 Feb 2025 11:57:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt;&#160; could you please help with running a repeated test for the change?&lt;/p&gt;</comment>
                            <comment id="17928049" author="dnk" created="Tue, 18 Feb 2025 11:37:38 +0000"  >&lt;p&gt;Updated MR: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3901&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3901&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;the repeated test is passing now: &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/5461/workflows/a9e3bf40-6563-4a59-8f00-3c90936492df/jobs/344706&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/5461/workflows/a9e3bf40-6563-4a59-8f00-3c90936492df/jobs/344706&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The root cause is a combination of 2 factors:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Java dest starts 2nd and 3rd nodes in parallel and they can be added to TCM in a different order, so when a read plan is created we may get 2nd or 3rd node as the second replica. The test expects 2nd node to be the initial remote read replica and emulates a network connectivity failure between 1st node and it. To fix the non-deterministic behaviour NetworkTopologyProximity implementation is adjusted using ByteBuddy to make the expected order of nodes returned by it (the same idea as in python read repair dtests is used).&lt;/li&gt;
	&lt;li&gt;Dynamic snitch was enabled and it may shuffle the nodes returned by NetworkTopologyProximity breaking the test assumption as well. To fix it dynamic snitch is disabled.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Note: To simplify troubleshooting of java dtests I have added a logging of actual configuration in java dtests (the default server logic does not print it because logging itself is initialized in tests later + the config is overridden)&lt;/p&gt;</comment>
                            <comment id="17928132" author="brandon.williams" created="Tue, 18 Feb 2025 15:46:06 +0000"  >&lt;p&gt;This looks good to me and thanks for the explanation!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Note: To simplify troubleshooting of java dtests I have added a logging of actual configuration in java dtests&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s trivial but let&apos;s smoke test it anyway since that will affect all dtests:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1838/workflows/373dd0f1-55e4-45fb-940b-a12786536037&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/driftx/cassandra/1838/workflows/373dd0f1-55e4-45fb-940b-a12786536037&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17928133" author="dnk" created="Tue, 18 Feb 2025 15:48:05 +0000"  >&lt;p&gt;agree, thank you!&lt;/p&gt;</comment>
                            <comment id="17928149" author="dnk" created="Tue, 18 Feb 2025 16:40:01 +0000"  >&lt;ul&gt;
	&lt;li&gt;j17_dtests job:
	&lt;ul&gt;
		&lt;li&gt;pushed_notifications_test.TestPushedNotifications::test_move_single_node_localhost - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19226&quot; title=&quot;Test Failure: pushed_notifications_test.TestPushedNotifications.test_move_single_node_localhost&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19226&quot;&gt;CASSANDRA-19226&lt;/a&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;j17_jvm_dtests_latest_vnode and j17_jvm_dtests jobs:
	&lt;ul&gt;
		&lt;li&gt;org.apache.cassandra.fuzz.sai.MultiNodeSAITest::indexOnlySaiTest-cassandra.testtag_IS_UNDEFINED - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20307&quot; title=&quot;Timeouting org.apache.cassandra.fuzz.sai.MultiNodeSAITest indexOnlySaiTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20307&quot;&gt;CASSANDRA-20307&lt;/a&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17928155" author="brandon.williams" created="Tue, 18 Feb 2025 16:44:00 +0000"  >&lt;p&gt;Nothing of concern there, +1.&lt;/p&gt;</comment>
                            <comment id="17928307" author="smiklosovic" created="Wed, 19 Feb 2025 07:31:12 +0000"  >&lt;p&gt;+1 thanks&lt;/p&gt;</comment>
                            <comment id="17928454" author="smiklosovic" created="Wed, 19 Feb 2025 15:10:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dnk&quot; class=&quot;user-hover&quot; rel=&quot;dnk&quot;&gt;dnk&lt;/a&gt; you should be able to merge this on your own by now.&lt;/p&gt;</comment>
                            <comment id="17929433" author="dnk" created="Sun, 23 Feb 2025 07:39:43 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/2daa0f0ba0647ee76a2b3ffc349407751031d0dd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/2daa0f0ba0647ee76a2b3ffc349407751031d0dd&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13074279" name="TEST-org.apache.cassandra.distributed.test.ReadSpeculationTest.xml" size="536010" author="dnk" created="Mon, 27 Jan 2025 11:21:44 +0000"/>
                            <attachment id="13074282" name="system_node1.log" size="174635" author="dnk" created="Mon, 27 Jan 2025 11:21:43 +0000"/>
                            <attachment id="13074281" name="system_node2.log" size="151089" author="dnk" created="Mon, 27 Jan 2025 11:21:43 +0000"/>
                            <attachment id="13074280" name="system_node3.log" size="156583" author="dnk" created="Mon, 27 Jan 2025 11:21:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dnk]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            37 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1tulk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12353509">5.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/2daa0f0ba0647ee76a2b3ffc349407751031d0dd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/2daa0f0ba0647ee76a2b3ffc349407751031d0dd&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;test itself if fixed&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>