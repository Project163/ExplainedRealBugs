<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:31:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-20298] Test failure CommitLogCQLTest.testSwitchMemtable</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-20298</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Seen here: &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1831/workflows/0de1611d-d409-4d15-8171-dcf7183a8c61/jobs/112290/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/driftx/cassandra/1831/workflows/0de1611d-d409-4d15-8171-dcf7183a8c61/jobs/112290/tests&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;unit.framework.AssertionFailedError: Forked Java VM exited abnormally. Please note the time in the report does not reflect the time until the VM exit.
	at jdk.internal.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.util.Vector.forEach(Vector.java:1365)
	at jdk.internal.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at jdk.internal.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.util.Vector.forEach(Vector.java:1365)
	at jdk.internal.reflect.GeneratedMethodAccessor4.invoke(Unknown Source)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13607621">CASSANDRA-20298</key>
            <summary>Test failure CommitLogCQLTest.testSwitchMemtable</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dnk">Dmitry Konstantinov</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Feb 2025 18:12:01 +0000</created>
                <updated>Mon, 31 Mar 2025 18:11:41 +0000</updated>
                            <resolved>Fri, 7 Feb 2025 21:41:39 +0000</resolved>
                                        <fixVersion>5.0.4</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Local/Commit Log</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17924690" author="dnk" created="Thu, 6 Feb 2025 20:32:09 +0000"  >&lt;p&gt;The interesting part from &quot;STEPS&quot; tab logs - it is OOM:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] Testsuite: org.apache.cassandra.db.commitlog.CommitLogCQLTest-_jdk17
[junit-timeout] WARNING: A terminally deprecated method in java.lang.&lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt; has been called
[junit-timeout] WARNING: &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;::setSecurityManager has been called by org.apache.cassandra.security.ThreadAwareSecurityManager (file:/tmp/cassandra/build/apache-cassandra-5.0.4-SNAPSHOT.jar)
[junit-timeout] WARNING: Please consider reporting &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; to the maintainers of org.apache.cassandra.security.ThreadAwareSecurityManager
[junit-timeout] WARNING: &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;::setSecurityManager will be removed in a &lt;span class=&quot;code-keyword&quot;&gt;future&lt;/span&gt; release
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;6&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;5&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;4&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;ScheduledTasks:1&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;8&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;1&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;9&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;ScheduledFastTasks:1&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;PERIODIC-COMMIT-LOG-SYNCER&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;MemtableFlushWriter:1&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;3&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;Callback-Map-Reaper:1&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;7&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;MemtableFlushWriter:2&quot;&lt;/span&gt;
[junit-timeout]&#160;
[junit-timeout] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread &lt;span class=&quot;code-quote&quot;&gt;&quot;main&quot;&lt;/span&gt;
[junit-timeout] Testsuite: org.apache.cassandra.db.commitlog.CommitLogCQLTest-cassandra.testtag_IS_UNDEFINED
[junit-timeout] Testsuite: org.apache.cassandra.db.commitlog.CommitLogCQLTest-cassandra.testtag_IS_UNDEFINED Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0 sec
[junit-timeout]&#160; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17924695" author="dnk" created="Thu, 6 Feb 2025 20:54:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; is it reproducing if we run the repeated test separately?&lt;/p&gt;</comment>
                            <comment id="17924696" author="brandon.williams" created="Thu, 6 Feb 2025 20:56:51 +0000"  >&lt;p&gt;I suspect this was just a flake in circle&apos;s infra and won&apos;t repeat.  We can close and reopen if it happens again.&lt;/p&gt;</comment>
                            <comment id="17924698" author="dnk" created="Thu, 6 Feb 2025 20:59:25 +0000"  >&lt;p&gt;I did a search: &lt;a href=&quot;https://issues.apache.org/jira/issues/?jql=text%20~%20%22testSwitchMemtable%22&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/issues/?jql=text%20~%20%22testSwitchMemtable%22&lt;/a&gt; and noticed that it is mentioned 3 more times additionally to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20097&quot; title=&quot;When resetting bootstrap progress, all the streamed data should be deleted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20097&quot;&gt;CASSANDRA-20097&lt;/a&gt; , so it looks suspicious..&lt;/p&gt;</comment>
                            <comment id="17924701" author="brandon.williams" created="Thu, 6 Feb 2025 21:04:20 +0000"  >&lt;p&gt;You&apos;re right, it looks like it just missed getting ticketed in the others, I guess we should leave it open. Let me see if it repeats in circle.&lt;/p&gt;</comment>
                            <comment id="17924702" author="dnk" created="Thu, 6 Feb 2025 21:08:03 +0000"  >&lt;p&gt;if it repeats (even if not &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;) I think I can add more helpful logging to the test in case of OOM to throw some light on..&lt;/p&gt;</comment>
                            <comment id="17924709" author="brandon.williams" created="Thu, 6 Feb 2025 21:56:40 +0000"  >&lt;p&gt;Well it &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1834/workflows/c58995a8-b209-4c28-b867-755fcb4c61a9/jobs/112597/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;definitely reproduces&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17924710" author="dnk" created="Thu, 6 Feb 2025 22:13:28 +0000"  >&lt;p&gt;Excellent, then it is much easier to troubleshoot it, I will prepare a branch with an improved test logging&lt;/p&gt;</comment>
                            <comment id="17924907" author="dnk" created="Fri, 7 Feb 2025 14:19:20 +0000"  >&lt;p&gt;I have added the error logging + histogram printing here: &lt;a href=&quot;https://github.com/netudima/cassandra/tree/20298-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netudima/cassandra/tree/20298-5.0&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17924962" author="dnk" created="Fri, 7 Feb 2025 17:12:27 +0000"  >&lt;p&gt;I am going to add also a thread dump printing.&lt;/p&gt;

&lt;p&gt;Based on the test source code the most suspicious place is this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
cfs.dumpMemtable(); &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It is actually async method which returns Future and highly probably we do not have a backpressure here. &lt;br/&gt;
But it is better to see it from the diagnostic printing.&lt;/p&gt;</comment>
                            <comment id="17924966" author="brandon.williams" created="Fri, 7 Feb 2025 17:22:52 +0000"  >&lt;p&gt;Maybe we should just block on the future?  10 threads just dropping a memtable with 50 inserts a piece isn&apos;t all that much though.&lt;/p&gt;</comment>
                            <comment id="17924967" author="dnk" created="Fri, 7 Feb 2025 17:29:21 +0000"  >&lt;p&gt;yes, future.get() is the most straightforward option to add a backressure but I want to collect a bit more info before doing it to understand the dynamics better + to read the dump code (maybe there are some more real dragons there)&lt;/p&gt;</comment>
                            <comment id="17924970" author="dnk" created="Fri, 7 Feb 2025 17:44:50 +0000"  >&lt;p&gt;I have added thread dump printing too to &lt;a href=&quot;https://github.com/netudima/cassandra/tree/20298-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netudima/cassandra/tree/20298-5.0&lt;/a&gt;&lt;br/&gt;
Could you please run the repeated test from this branch?&lt;/p&gt;</comment>
                            <comment id="17924975" author="dnk" created="Fri, 7 Feb 2025 17:58:27 +0000"  >&lt;p&gt;in non-test code we have the following places in 5.0 which invokes ColumnFamilyStore#dumpMemtable:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;org.apache.cassandra.db.ColumnFamilyStore#truncateBlocking(boolean) - here we have FBUtilities.waitOnFuture&lt;/li&gt;
	&lt;li&gt;org.apache.cassandra.db.view.TableViews#dumpMemtables - here we do not have FBUtilities.waitOnFuture but the only place which invokes TableViews#dumpMemtables is ColumnFamilyStore#truncateBlocking and we use FBUtilities.waitOnFuture on the main table dump just after it (+ postFlushExecutor is sequential)&lt;/li&gt;
	&lt;li&gt;org.apache.cassandra.db.ColumnFamilyStore#unloadCf - here we have FBUtilities.waitOnFuture&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So, such massive future creation does not look like a common scenario to test intentionally =&amp;gt; one more reason to use FBUtilities.waitOnFuture(cfs.dumpMemtable());&lt;/p&gt;</comment>
                            <comment id="17924979" author="brandon.williams" created="Fri, 7 Feb 2025 18:11:00 +0000"  >&lt;p&gt;I&apos;ve got the repeats started &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1835/workflows/ae2db061-6ead-4624-8fa1-8c310d9149a3/jobs/112705&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;


&lt;blockquote&gt;&lt;p&gt;one more reason to use FBUtilities.waitOnFuture(cfs.dumpMemtable());&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I did this earlier and it survived looping on my machine.  Like I said though, it doesn&apos;t seem like 10 threads throwing memtables away with only 50 inserts in them is all that much.&lt;/p&gt;</comment>
                            <comment id="17925017" author="dnk" created="Fri, 7 Feb 2025 20:30:55 +0000"  >&lt;p&gt;So, the heap is occupied with memtables actually, we have 849 of them:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] INFO  [7] 2025-02-07 18:15:03,590 CommitLogCQLTest.java:164 - === Histogram ===
[junit-timeout]  num     #instances         #bytes  &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;name (module)
[junit-timeout] -------------------------------------------------------
[junit-timeout]    1:         71277      904901920  [B (java.base@17.0.7)
[junit-timeout]    2:          5030        7141800  [J (java.base@17.0.7)
[junit-timeout]    3:         50749        2841944  java.nio.HeapByteBuffer (java.base@17.0.7)
[junit-timeout]    4:         57510        2010088  [Ljava.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;; (java.base@17.0.7)
[junit-timeout]    5:         68356        1640544  java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; (java.base@17.0.7)
[junit-timeout]    6:          3937        1273808  [I (java.base@17.0.7)
[junit-timeout]    7:          9204        1111584  java.lang.&lt;span class=&quot;code-object&quot;&gt;Class&lt;/span&gt; (java.base@17.0.7)
[junit-timeout]    8:         24877         995080  org.apache.cassandra.db.rows.BufferCell
[junit-timeout]    9:         24852         994080  org.apache.cassandra.db.rows.BTreeRow
[junit-timeout]   10:         28336         906752  java.util.concurrent.ConcurrentHashMap$Node (java.base@17.0.7)
[junit-timeout]   11:         25673         821536  org.apache.cassandra.db.rows.EncodingStats
[junit-timeout]   12:         24850         795200  org.apache.cassandra.db.partitions.BTreePartitionData
[junit-timeout]   13:         24842         794944  org.apache.cassandra.db.partitions.AtomicBTreePartition
[junit-timeout]   14:         32259         774216  javax.management.ObjectName$Property (java.management@17.0.7)
[junit-timeout]   15:         22531         720992  java.util.HashMap$Node (java.base@17.0.7)
[junit-timeout]   16:         25663         615912  java.util.concurrent.ConcurrentSkipListMap$Node (java.base@17.0.7)
[junit-timeout]   17:         24851         596424  org.apache.cassandra.dht.Murmur3Partitioner$LongToken
[junit-timeout]   18:         24848         596352  org.apache.cassandra.db.LivenessInfo
[junit-timeout]   19:         24846         596304  org.apache.cassandra.db.BufferDecoratedKey
[junit-timeout]   20:         16925         535040  [Ljavax.management.ObjectName$Property; (java.management@17.0.7)
[junit-timeout]   21:          2091         396976  [S (java.base@17.0.7)
[junit-timeout]   22:          2858         375776  [Ljava.util.HashMap$Node; (java.base@17.0.7)
[junit-timeout]   23:         13084         314016  java.util.concurrent.ConcurrentSkipListMap$Index (java.base@17.0.7)
[junit-timeout]   24:          9453         302496  java.util.concurrent.atomic.LongAdder (java.base@17.0.7)
[junit-timeout]   25:          8463         270816  javax.management.ObjectName (java.management@17.0.7)
[junit-timeout]   26:           369         232112  [Ljava.util.concurrent.ConcurrentHashMap$Node; (java.base@17.0.7)
[junit-timeout]   27:          4656         223488  com.codahale.metrics.EWMA
[junit-timeout]   28:          8458         202992  com.sun.jmx.mbeanserver.NamedObject (java.management@17.0.7)
[junit-timeout]   29:          8418         202032  com.sun.jmx.mbeanserver.StandardMBeanSupport (java.management@17.0.7)
[junit-timeout]   30:           355         168064  [C (java.base@17.0.7)
[junit-timeout]   31:          9870         157920  java.lang.&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt; (java.base@17.0.7)
[junit-timeout]   32:          1703         149864  java.lang.reflect.Method (java.base@17.0.7)
[junit-timeout]   33:          5840         140160  java.util.concurrent.atomic.AtomicLong (java.base@17.0.7)
[junit-timeout]   34:          2633         126384  java.lang.invoke.MemberName (java.base@17.0.7)
[junit-timeout]   35:          2928         117120  java.lang.ref.SoftReference (java.base@17.0.7)
[junit-timeout]   36:          3465         110880  org.apache.cassandra.metrics.TableMetrics$$Lambda$870/0x0000000801459e48
[junit-timeout]   37:           366         102480  java.util.concurrent.atomic.Striped64$Cell (java.base@17.0.7)
[junit-timeout]   38:          2124         101952  java.util.HashMap (java.base@17.0.7)
[junit-timeout]   39:          1701          81648  java.util.concurrent.ConcurrentSkipListMap (java.base@17.0.7)
[junit-timeout]   40:          1986          79440  sun.util.locale.LocaleObjectCache$CacheEntry (java.base@17.0.7)
[junit-timeout]   41:          3213          77112  org.apache.cassandra.metrics.CassandraMetricsRegistry$JmxGauge
[junit-timeout]   42:           849          74712  org.apache.cassandra.db.memtable.SkipListMemtable
[junit-timeout]   43:          1865          74600  java.lang.invoke.MethodType (java.base@17.0.7)
[junit-timeout]   44:          1696          67840  org.apache.cassandra.utils.memory.MemtableAllocator$SubAllocator &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We have OOM thrown from MemtableFlushWriter thread pool:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] ERROR [MemtableFlushWriter:1] 2025-02-07 18:15:03,445 JVMStabilityInspector.java:70 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MemtableFlushWriter:1,5,MemtableFlushWriter]
[junit-timeout] java.lang.OutOfMemoryError: Java heap space
[junit-timeout] 	at java.base/java.util.Arrays.copyOf(Arrays.java:3481)
[junit-timeout] 	at com.google.common.collect.ImmutableList$Builder.getReadyToExpandTo(ImmutableList.java:797)
[junit-timeout] 	at com.google.common.collect.ImmutableList$Builder.add(ImmutableList.java:816)
[junit-timeout] 	at com.google.common.collect.ImmutableList$Builder.add(ImmutableList.java:776)
[junit-timeout] 	at com.google.common.collect.ImmutableCollection$Builder.addAll(ImmutableCollection.java:493)
[junit-timeout] 	at com.google.common.collect.ImmutableList$Builder.addAll(ImmutableList.java:884)
[junit-timeout] 	at com.google.common.collect.ImmutableList.copyOf(ImmutableList.java:282)
[junit-timeout] 	at com.google.common.collect.ImmutableList.copyOf(ImmutableList.java:239)
[junit-timeout] 	at org.apache.cassandra.db.lifecycle.View$6.apply(View.java:336)
[junit-timeout] 	at org.apache.cassandra.db.lifecycle.View$6.apply(View.java:332)
[junit-timeout] 	at org.apache.cassandra.db.lifecycle.Tracker.apply(Tracker.java:162)
[junit-timeout] 	at org.apache.cassandra.db.lifecycle.Tracker.apply(Tracker.java:135)
[junit-timeout] 	at org.apache.cassandra.db.lifecycle.Tracker.markFlushing(Tracker.java:391)
[junit-timeout] 	at org.apache.cassandra.db.ColumnFamilyStore$Flush.run(ColumnFamilyStore.java:1243)
[junit-timeout] 	at org.apache.cassandra.concurrent.ExecutionFailure$1.run(ExecutionFailure.java:133)
[junit-timeout] 	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)
[junit-timeout] 	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)
[junit-timeout] 	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
[junit-timeout] 	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The mutation threads are mostly in two places: looking for a memtable and writing a commit log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[junit-timeout] INFO  [7] 2025-02-07 18:15:03,600 CommitLogCQLTest.java:212 - &lt;span class=&quot;code-quote&quot;&gt;&quot;MemtableFlushWriter:1&quot;&lt;/span&gt; 
[junit-timeout]    java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE, waiting time: -1
[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.Iterators.forArray(Iterators.java:1074)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.RegularImmutableList.listIterator(RegularImmutableList.java:85)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.ImmutableList.listIterator(ImmutableList.java:404)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.ImmutableList.iterator(ImmutableList.java:399)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.ImmutableList.iterator(ImmutableList.java:63)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.Iterables$4.iterator(Iterables.java:583)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.ImmutableList.copyOf(ImmutableList.java:239)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.View$6.apply(View.java:336)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.View$6.apply(View.java:332)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.Tracker.apply(Tracker.java:162)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.Tracker.apply(Tracker.java:135)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.Tracker.markFlushing(Tracker.java:391)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.ColumnFamilyStore$Flush.run(ColumnFamilyStore.java:1243)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.concurrent.ExecutionFailure$1.run(ExecutionFailure.java:133)
&lt;/span&gt;[junit-timeout]         at java.base@17.0.7/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)
[junit-timeout]         at java.base@17.0.7/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)
[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
&lt;/span&gt;[junit-timeout]         at java.base@17.0.7/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833)

[junit-timeout] INFO  [7] 2025-02-07 18:15:03,600 CommitLogCQLTest.java:212 - &lt;span class=&quot;code-quote&quot;&gt;&quot;MemtableFlushWriter:2&quot;&lt;/span&gt; 
[junit-timeout]    java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE, waiting time: -1
[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.base.Predicates$IsEqualToPredicate.apply(Predicates.java:461)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.base.Predicates$NotPredicate.apply(Predicates.java:327)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.Iterators$5.computeNext(Iterators.java:672)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:145)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:140)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.ImmutableCollection$Builder.addAll(ImmutableCollection.java:492)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.ImmutableList$Builder.addAll(ImmutableList.java:884)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.ImmutableList.copyOf(ImmutableList.java:282)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//com.google.common.collect.ImmutableList.copyOf(ImmutableList.java:239)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.View$6.apply(View.java:336)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.View$6.apply(View.java:332)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.Tracker.apply(Tracker.java:162)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.Tracker.apply(Tracker.java:135)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.Tracker.markFlushing(Tracker.java:391)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.ColumnFamilyStore$Flush.run(ColumnFamilyStore.java:1243)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.concurrent.ExecutionFailure$1.run(ExecutionFailure.java:133)
&lt;/span&gt;[junit-timeout]         at java.base@17.0.7/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)
[junit-timeout]         at java.base@17.0.7/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)
[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
&lt;/span&gt;[junit-timeout]         at java.base@17.0.7/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:833)


[junit-timeout] INFO  [7] 2025-02-07 18:15:03,600 CommitLogCQLTest.java:212 - &lt;span class=&quot;code-quote&quot;&gt;&quot;0&quot;&lt;/span&gt; 
[junit-timeout]    java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE, waiting time: -1
[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.commitlog.CommitLog.add(CommitLog.java:318)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.CassandraKeyspaceWriteHandler.addToCommitLog(CassandraKeyspaceWriteHandler.java:99)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.CassandraKeyspaceWriteHandler.beginWrite(CassandraKeyspaceWriteHandler.java:53)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Keyspace.applyInternal(Keyspace.java:625)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Keyspace.apply(Keyspace.java:510)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Mutation.apply(Mutation.java:249)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Mutation.apply(Mutation.java:269)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.statements.ModificationStatement.executeInternalWithoutCondition(ModificationStatement.java:692)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.statements.ModificationStatement.executeLocally(ModificationStatement.java:683)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.QueryProcessor.executeInternal(QueryProcessor.java:452)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.commitlog.CommitLogCQLTest$1.run(CommitLogCQLTest.java:99)
&lt;/span&gt;

[junit-timeout] INFO  [7] 2025-02-07 18:15:03,601 CommitLogCQLTest.java:212 - &lt;span class=&quot;code-quote&quot;&gt;&quot;2&quot;&lt;/span&gt; 
[junit-timeout]    java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE, waiting time: -1
[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.Tracker.getMemtableFor(Tracker.java:366)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.ColumnFamilyStore.apply(ColumnFamilyStore.java:1472)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.CassandraTableWriteHandler.write(CassandraTableWriteHandler.java:38)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Keyspace.applyInternal(Keyspace.java:653)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Keyspace.apply(Keyspace.java:510)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Mutation.apply(Mutation.java:249)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Mutation.apply(Mutation.java:269)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.statements.ModificationStatement.executeInternalWithoutCondition(ModificationStatement.java:692)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.statements.ModificationStatement.executeLocally(ModificationStatement.java:683)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.QueryProcessor.executeInternal(QueryProcessor.java:452)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.commitlog.CommitLogCQLTest$1.run(CommitLogCQLTest.java:99)
&lt;/span&gt;

[junit-timeout] INFO  [7] 2025-02-07 18:15:03,601 CommitLogCQLTest.java:212 - &lt;span class=&quot;code-quote&quot;&gt;&quot;3&quot;&lt;/span&gt; 
[junit-timeout]    java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE, waiting time: -1
[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.Tracker.getMemtableFor(Tracker.java:366)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.ColumnFamilyStore.apply(ColumnFamilyStore.java:1472)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.CassandraTableWriteHandler.write(CassandraTableWriteHandler.java:38)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Keyspace.applyInternal(Keyspace.java:653)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Keyspace.apply(Keyspace.java:510)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Mutation.apply(Mutation.java:249)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Mutation.apply(Mutation.java:269)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.statements.ModificationStatement.executeInternalWithoutCondition(ModificationStatement.java:692)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.statements.ModificationStatement.executeLocally(ModificationStatement.java:683)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.QueryProcessor.executeInternal(QueryProcessor.java:452)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.commitlog.CommitLogCQLTest$1.run(CommitLogCQLTest.java:99)
&lt;/span&gt;
[junit-timeout] INFO  [7] 2025-02-07 18:15:03,601 CommitLogCQLTest.java:212 - &lt;span class=&quot;code-quote&quot;&gt;&quot;4&quot;&lt;/span&gt; 
[junit-timeout]    java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE, waiting time: -1
[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.commitlog.CommitLog.add(CommitLog.java:318)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.CassandraKeyspaceWriteHandler.addToCommitLog(CassandraKeyspaceWriteHandler.java:99)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.CassandraKeyspaceWriteHandler.beginWrite(CassandraKeyspaceWriteHandler.java:53)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Keyspace.applyInternal(Keyspace.java:625)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Keyspace.apply(Keyspace.java:510)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Mutation.apply(Mutation.java:249)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Mutation.apply(Mutation.java:269)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.statements.ModificationStatement.executeInternalWithoutCondition(ModificationStatement.java:692)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.statements.ModificationStatement.executeLocally(ModificationStatement.java:683)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.QueryProcessor.executeInternal(QueryProcessor.java:452)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.commitlog.CommitLogCQLTest$1.run(CommitLogCQLTest.java:99)
&lt;/span&gt;
[junit-timeout] INFO  [7] 2025-02-07 18:15:03,601 CommitLogCQLTest.java:212 - &lt;span class=&quot;code-quote&quot;&gt;&quot;5&quot;&lt;/span&gt; 
[junit-timeout]    java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE, waiting time: -1
[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.lifecycle.Tracker.getMemtableFor(Tracker.java:366)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.ColumnFamilyStore.apply(ColumnFamilyStore.java:1472)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.CassandraTableWriteHandler.write(CassandraTableWriteHandler.java:38)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Keyspace.applyInternal(Keyspace.java:653)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Keyspace.apply(Keyspace.java:510)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Mutation.apply(Mutation.java:249)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.Mutation.apply(Mutation.java:269)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.statements.ModificationStatement.executeInternalWithoutCondition(ModificationStatement.java:692)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.statements.ModificationStatement.executeLocally(ModificationStatement.java:683)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.cql3.QueryProcessor.executeInternal(QueryProcessor.java:452)
&lt;/span&gt;[junit-timeout]         at app&lt;span class=&quot;code-comment&quot;&gt;//org.apache.cassandra.db.commitlog.CommitLogCQLTest$1.run(CommitLogCQLTest.java:99)
&lt;/span&gt;[junit-timeout] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17925018" author="dnk" created="Fri, 7 Feb 2025 20:32:01 +0000"  >&lt;p&gt;It looks like we have a kind of livelock here: org.apache.cassandra.db.lifecycle.Tracker#markFlushing&lt;/p&gt;

&lt;p&gt;We have an optimistic locking logic when we take the current set of memtables and evaluate new one. If the current view state is still the same we replace it with a new one. In our case we flush memtables very frequently in several threads + async -&amp;gt; the current view is changing very frequently, so we fail a lot in this loop.&lt;/p&gt;

&lt;p&gt;While we are failing in optimistic locking - more and more memtables are flushed and added into the view, so the iteration over them in Tracker.apply becomes longer and longer =&amp;gt; we spend more time to calculate a new state and our chances to fail with replacing a view because the current is changed are increasing. So, we have a negative feedback loop when we degrade more and more until we do not consume all space with memtables.&lt;/p&gt;</comment>
                            <comment id="17925021" author="dnk" created="Fri, 7 Feb 2025 20:42:29 +0000"  >&lt;p&gt;and the second part of the puzzle - why our mutation threads are NOT rate limited by memory allocator logic which should block to await for a free space and protect from OOM.&lt;/p&gt;

&lt;p&gt;We insert just few rows and flush our memtable, we use slab allocator for our memtables, so we allocate a region, consume a bit from it and switch to a new one when we switch to a new memtable during a flush. From memory allocator accounting point of view we consumed a bit but in reality we have a lot of memory used by slabs. Here we have a kind of internal memory fragmentation issue, when for our pathological case the majority of memory is wasted in the unused recycling slabs.&lt;/p&gt;

&lt;p&gt;In total, we have a combination of livelock issue in tracker view update logic + slab memory fragmentation untracked by memtable memory allocator. Both are very interesting and educative and we can make the logic more safe but I doubt if we can face them in real workloads (the second one probably can be observed when we have a lot of tables but it is a different story) to spend time on it...&lt;/p&gt;</comment>
                            <comment id="17925024" author="dnk" created="Fri, 7 Feb 2025 20:57:18 +0000"  >&lt;p&gt;So, finally, yes, I think it is enough to wait for memtable dump completion in the test to fix it but the journey was interesting: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3880&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3880&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17925058" author="brandon.williams" created="Fri, 7 Feb 2025 21:20:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;From memory allocator accounting point of view we consumed a bit but in reality we have a lot of memory used by slabs.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ah, that explains it and makes perfect sense, thanks.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-20298-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1836/workflows/225189fa-94df-46f7-8355-6fc0fb1e294d/jobs/112921&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;repeat&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-20298-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/1837/workflows/b94b8c06-904c-42b5-9c7e-4165a5abcf8d/jobs/112920&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;repeat&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

</comment>
                            <comment id="17925059" author="brandon.williams" created="Fri, 7 Feb 2025 21:25:05 +0000"  >&lt;p&gt;Everything passed, +1 from me.&lt;/p&gt;</comment>
                            <comment id="17925062" author="smiklosovic" created="Fri, 7 Feb 2025 21:33:18 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17925065" author="brandon.williams" created="Fri, 7 Feb 2025 21:41:39 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                            <comment id="17939772" author="dnk" created="Mon, 31 Mar 2025 18:11:41 +0000"  >&lt;p&gt;it looks like we need to backport the fix to 4.1 too: &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-4.1/570/testReport/junit/org.apache.cassandra.db.commitlog/CommitLogCQLTest/testSwitchMemtable/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-4.1/570/testReport/junit/org.apache.cassandra.db.commitlog/CommitLogCQLTest/testSwitchMemtable/&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Got error during memtable switching:
Java heap space
java.lang.OutOfMemoryError: Java heap space
Got error during memtable switching:
Java heap space
java.lang.OutOfMemoryError: Java heap space
	at java.nio.HeapByteBuffer.&amp;lt;init&amp;gt;(HeapByteBuffer.java:57)
	at java.nio.ByteBuffer.allocate(ByteBuffer.java:335)
	at org.apache.cassandra.utils.memory.SlabAllocator.getRegion(SlabAllocator.java:139)
	at org.apache.cassandra.utils.memory.SlabAllocator.allocate(SlabAllocator.java:104)
	at org.apache.cassandra.utils.memory.MemtableBufferAllocator$1.allocate(MemtableBufferAllocator.java:40)
	at org.apache.cassandra.utils.memory.ByteBufferCloner.clone(ByteBufferCloner.java:77)
	at org.apache.cassandra.utils.memory.ByteBufferCloner.clone(ByteBufferCloner.java:63)
	at org.apache.cassandra.utils.memory.ByteBufferCloner.clone(ByteBufferCloner.java:46)
	at org.apache.cassandra.db.memtable.SkipListMemtable.put(SkipListMemtable.java:120)
	at org.apache.cassandra.db.ColumnFamilyStore.apply(ColumnFamilyStore.java:1424)
	at org.apache.cassandra.db.CassandraTableWriteHandler.write(CassandraTableWriteHandler.java:40)
	at org.apache.cassandra.db.Keyspace.applyInternal(Keyspace.java:672)
	at org.apache.cassandra.db.Keyspace.apply(Keyspace.java:525)
	at org.apache.cassandra.db.Mutation.apply(Mutation.java:233)
	at org.apache.cassandra.db.Mutation.apply(Mutation.java:253)
	at org.apache.cassandra.cql3.statements.ModificationStatement.executeInternalWithoutCondition(ModificationStatement.java:675)
	at org.apache.cassandra.cql3.statements.ModificationStatement.executeLocally(ModificationStatement.java:666)
	at org.apache.cassandra.cql3.QueryProcessor.executeInternal(QueryProcessor.java:453)
	at org.apache.cassandra.db.commitlog.CommitLogCQLTest$1.run(CommitLogCQLTest.java:90)
Got error during memtable switching: &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13074536" name="TEST-org.apache.cassandra.db.commitlog.CommitLogCQLTest.log" size="95755" author="dnk" created="Thu, 6 Feb 2025 20:18:51 +0000"/>
                            <attachment id="13074537" name="TEST-org.apache.cassandra.db.commitlog.CommitLogCQLTest.xml" size="37581" author="dnk" created="Thu, 6 Feb 2025 20:18:50 +0000"/>
                            <attachment id="13074538" name="steps.log" size="43579" author="dnk" created="Thu, 6 Feb 2025 20:30:27 +0000"/>
                            <attachment id="13074572" name="test_log_with_heap_histo_and_thread_dump.txt" size="2006715" author="dnk" created="Fri, 7 Feb 2025 20:09:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dnk]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            32 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1u2ew:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12353513">5.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3880/commits/474491df1133ed0b13e9b6b9f5c642fed6ae4df7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3880/commits/474491df1133ed0b13e9b6b9f5c642fed6ae4df7&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;an existing test is fixed&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>