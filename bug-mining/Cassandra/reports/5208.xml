<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:13:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15259] Selecting Index by Lowest Mean Column Count Selects Random Index</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15259</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;tt&gt;CassandraIndex&lt;/tt&gt; uses&#160;&lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/index/internal/CassandraIndex.java#L273&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;ColumnFamilyStore#getMeanColumns&lt;/tt&gt;&lt;/a&gt;, average columns per partition,&#160;which always returns the same answer for index CFs because they contain no regular columns and clustering columns aren&apos;t included in the count&#160;in Cassandra 3.0+.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13248920">CASSANDRA-15259</key>
            <summary>Selecting Index by Lowest Mean Column Count Selects Random Index</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jwest">Jordan West</assignee>
                                    <reporter username="jwest">Jordan West</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Aug 2019 16:39:43 +0000</created>
                <updated>Sun, 1 Aug 2021 11:17:59 +0000</updated>
                            <resolved>Tue, 6 Aug 2019 17:27:48 +0000</resolved>
                                        <fixVersion>3.0.19</fixVersion>
                    <fixVersion>3.11.7</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Feature/2i Index</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16900311" author="jrwest" created="Mon, 5 Aug 2019 18:50:40 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Tests&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...jrwest:jwest/15259-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/fd4a72ce-d1fd-4c15-8b2a-a20544b658c8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cci&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...jrwest:jwest/15259-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/69faf98e-7cc8-4f68-9af9-d6317e29923d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cci&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...jrwest:jwest/15259-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/b958fc7e-91f1-4b30-a7df-89ea7941ee60&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cci&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16900407" author="bdeggleston" created="Mon, 5 Aug 2019 20:54:58 +0000"  >&lt;p&gt;The &lt;tt&gt;totalRows&lt;/tt&gt; metadata element was added to the sstable format in 3.0, so we&#8217;ll still need to use the old method for 2.x sstables. Looks good otherwise.&lt;/p&gt;</comment>
                            <comment id="16900575" author="jrwest" created="Tue, 6 Aug 2019 03:26:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; good catch re: 2.x sstables. I see two ways to handle that off the top of my head &#8211; besides not including the legacy sstables in the calculation which is broken.&lt;/p&gt;

&lt;p&gt;I think I prefer &lt;tt&gt;getMeanRowCount2&lt;/tt&gt; (average of the row count and column count) because in the case of 100% legacy sstables or 100% new sstables it degrades to &lt;tt&gt;getMeanColumns&lt;/tt&gt; or the original&#160;&lt;tt&gt;getMeanRowCount.&lt;/tt&gt;&#160;Neither implementation is ideal since we have to handle it at the per sstable level and what that means for an average is ambiguous.&#160;&lt;/p&gt;

&lt;p&gt;Also, I wonder if the method name should change and/or if the logic should be moved to somewhere index specific like &lt;tt&gt;CassandraIndex&lt;/tt&gt;, now that what its doing is a bit more specialized and less clear. WDYT?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getMeanRowCount()
{
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; totalRows = 0;
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; totalPartitions = 0;
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (SSTableReader sstable : getSSTables(SSTableSet.CANONICAL))
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sstable.descriptor.version.storeRows())
        {
            totalPartitions += sstable.getEstimatedPartitionSize().count();
            totalRows += sstable.getTotalRows();
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
        {
            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; colCount = sstable.getEstimatedColumnCount().count();
            totalPartitions += colCount;
            totalRows += sstable.getEstimatedColumnCount().mean() * colCount;
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; totalPartitions &amp;gt; 0 ? (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) (totalRows / totalPartitions) : 0;
}

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; getMeanRowCount2()
{
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; totalRows = 0;
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; totalPartitions = 0;
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; legacyCols = 0;
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; legacyTotal = 0;
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (SSTableReader sstable : getSSTables(SSTableSet.CANONICAL))
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (sstable.descriptor.version.storeRows())
        {
            totalPartitions += sstable.getEstimatedPartitionSize().count();
            totalRows += sstable.getTotalRows();
        } &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
        {
            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; colCount = sstable.getEstimatedColumnCount().count();
            legacyCols += sstable.getEstimatedColumnCount().mean() * colCount;
            legacyTotal += colCount;
        }
    }

    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; rowMean = totalPartitions &amp;gt; 0 ? (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) (totalRows / totalPartitions) : 0;
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; legacyMean = legacyTotal &amp;gt; 0 ? (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) (legacyCols / legacyTotal) : 0;

    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) (((rowMean * totalPartitions) + (legacyMean * legacyTotal)) / (totalPartitions + legacyTotal));
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16901202" author="bdeggleston" created="Tue, 6 Aug 2019 15:54:43 +0000"  >&lt;p&gt;I&#8217;m not 100% sure, but I think the math in both methods commute to the same calculation, in which case I&#8217;d prefer &lt;tt&gt;getMeanRowCount&lt;/tt&gt; for it&#8217;s simplicity.&lt;/p&gt;

&lt;p&gt;I do agree this should move into &lt;tt&gt;CassandraIndex&lt;/tt&gt; though, since it&#8217;s pretty specific to that use case.&lt;/p&gt;</comment>
                            <comment id="16901213" author="jrwest" created="Tue, 6 Aug 2019 16:09:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; pushed updates for 3.0 and 3.11. If I&apos;m reading the code right the legacy sstables aren&apos;t supported in trunk so I left the code as is since it seemed cleaner and generally useful. Happy to change trunk as well though if you prefer.&#160;&lt;/p&gt;</comment>
                            <comment id="16901310" author="bdeggleston" created="Tue, 6 Aug 2019 17:27:48 +0000"  >&lt;p&gt;+1, committed to 3.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/da8d41f497efedf57e335ec2664680da583a3aba&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;da8d41f497efedf57e335ec2664680da583a3aba&lt;/a&gt; and merged up to trunk. Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jwest]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12997" cascade-level="1"><![CDATA[Performance Bug/Regression]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 15 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z05ca0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/da8d41f497efedf57e335ec2664680da583a3aba&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/da8d41f497efedf57e335ec2664680da583a3aba&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Regression test added as part of patch&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>