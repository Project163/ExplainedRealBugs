<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:48:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6904] commitlog segments may not be archived after restart</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6904</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;commitlog segments are archived when they are full, so the current active segment will not be archived on restart (and its contents will not be available for pitr).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12702932">CASSANDRA-6904</key>
            <summary>commitlog segments may not be archived after restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Mar 2014 18:10:26 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:50 +0000</updated>
                            <resolved>Tue, 30 Sep 2014 19:11:46 +0000</resolved>
                                        <fixVersion>2.0.11</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>5</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="13943334" author="jbellis" created="Fri, 21 Mar 2014 18:13:33 +0000"  >&lt;p&gt;actually it&apos;s not just the current active segment; it could include any other segments for which archive is not complete at restart time.  No state is kept by the segment manager to record which have been archived and which have not.&lt;/p&gt;

&lt;p&gt;Keeping this state in a system table would have the obvious problem that you need to replay the CL before you know which segments have not been archived yet.  (because of how pitr works, it would be much better to be able to archive before replaying.)  So it&apos;s a tough problem to solve.&lt;/p&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vijay2win%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;vijay2win@yahoo.com&quot;&gt;vijay2win@yahoo.com&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13943336" author="jbellis" created="Fri, 21 Mar 2014 18:15:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; suggests that we could use hard links to track segments-pending-archive.  Since we don&apos;t recycle segments until archive is complete this should be fine.&lt;/p&gt;</comment>
                            <comment id="13943343" author="benedict" created="Fri, 21 Mar 2014 18:23:05 +0000"  >&lt;p&gt;To clarify, I think the absolute safest thing to do is to hard-link as soon as a CL is swapped into active, and then only recycle after an archive operation is successfully run on the hard-linked version. This should make sure we take care of not-yet-finished segments (and hence not-yet-archived) on startup as well, if we push all recycles through this path.&lt;/p&gt;</comment>
                            <comment id="13943887" author="vijay2win@yahoo.com" created="Sat, 22 Mar 2014 04:02:50 +0000"  >&lt;p&gt;Hi Jonathan, We can also encode it in the header, but either ways SGTM.&lt;/p&gt;</comment>
                            <comment id="14138608" author="benedict" created="Thu, 18 Sep 2014 06:49:58 +0000"  >&lt;p&gt;As discussed on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7965&quot; title=&quot;Active commit log doesn&amp;#39;t get archived on Cassandra restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7965&quot;&gt;&lt;del&gt;CASSANDRA-7965&lt;/del&gt;&lt;/a&gt;, we could simply archive all commit logs present on restart. This runs the risk of repeatedly archiving commit logs if we fail repeatedly on restart for some reason, so may be undesirable. However we can avoid replaying the same CLS twice in 2.1 since we retain the original id in the header.&lt;/p&gt;</comment>
                            <comment id="14139527" author="jbellis" created="Thu, 18 Sep 2014 21:14:48 +0000"  >&lt;p&gt;&quot;Archive everything on restart&quot; is definitely a simpler solution.&lt;/p&gt;</comment>
                            <comment id="14141106" author="beobal" created="Fri, 19 Sep 2014 19:08:47 +0000"  >&lt;p&gt;Attaching patches for 2.0 &amp;amp; 2.1&lt;/p&gt;

&lt;p&gt;If we choose to apply to 2.0 we should note that replaying commit logs isn&apos;t safe in the presence of counters (though it&apos;s not really made any less safe by this).&lt;/p&gt;

&lt;p&gt;For 2.1 I&apos;ve added an overloaded version of maybeArchive to CLA (actually, it&apos;s a resurrection of the pre 2.1 version), which takes a file path &amp;amp; name. This is what gets called at startup as instantiating segments from the unmanaged files in order to archive causes them to be recycled before they&apos;re archived. Plus, the version of maybeArchive that takes a CLS waits for it to be synced before performing the archive command, which will never happen for these files.&lt;/p&gt;

&lt;p&gt;dtest added in &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/pull/92&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14141250" author="jbellis" created="Fri, 19 Sep 2014 20:32:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="14142983" author="benedict" created="Mon, 22 Sep 2014 07:34:02 +0000"  >&lt;p&gt;In 2.1 we should be using the header information to ensure we only replay each segment once.&lt;/p&gt;

&lt;p&gt;I also think this is a good opportunity in 2.1 to drop in support for native archival, with which we could easily avoid backing up twice. The current situation feels a little clunky to me, since if we have a bug or other problem causing startup to crash we might repeatedly fill up the archive disk without the operator realising. That could be a follow up ticket, I&apos;m fine either way, but it&apos;s really not a very challenging feature to insert and helps make this much more sane.&lt;/p&gt;</comment>
                            <comment id="14143071" author="beobal" created="Mon, 22 Sep 2014 10:19:44 +0000"  >&lt;p&gt;The reason I didn&apos;t add header checking during replay is I don&apos;t think it&apos;s actually possible in 2.1.&lt;/p&gt;

&lt;p&gt;CLA.maybeRestoreArchive uses the header of the archive file to create the destination file for restore and if that target file already exists we throw an exception and bail on startup. The external restore script can in theory modify the destination filename but only to something which conforms to the defined pattern, otherwise the files aren&apos;t picked up during replay. Because of this constraint, the only thing the restore script can really do is modify the part of the filename that maps to the segment id. However, if it does do that, the file will be skipped anyway as CLR.recover(File) creates its descriptor from the (modified) filename, meaning that when it actually replays it, checksums fail due to the mismatched descriptor id.&lt;/p&gt;

&lt;p&gt;That said, it&apos;s pretty trivial to add a check for duplicate segments during recovery, so if I&apos;ve missed something let me know &amp;amp; I&apos;ll attach an updated patch.&lt;/p&gt;

&lt;p&gt;On the native archive, I&apos;d rather we handle any general rework of the archival process as a separate ticket if nobody objects.&lt;/p&gt;</comment>
                            <comment id="14143076" author="benedict" created="Mon, 22 Sep 2014 10:30:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;if that target file already exists we throw an exception and bail on startup&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point. Given we now &lt;em&gt;expect&lt;/em&gt; this situation, though, we should probably change that behaviour. But agreed, the naming of the files during restore should have already solved the problem I was highlighting.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;On the native archive, I&apos;d rather we handle any general rework of the archival process as a separate ticket if nobody objects.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;WFM. But &quot;rework&quot; is much too strong a word IMO - we&apos;re going to have to support the current archival option indefinitely, most likely (and really it&apos;s low cost to do so, code is tiny) - we just want to give people a saner option to move to. Which pretty much means offering a yaml option and making the archive command a function:CLS-&amp;gt;Runnable, with the runnable doing a native copy (and perhaps supporting hard linking, which is slightly trickier, but still not hard and not a requisite) as well as the current option. So it&apos;s small enough I&apos;d also feel very comfortable including it here.&lt;/p&gt;</comment>
                            <comment id="14143552" author="jbellis" created="Mon, 22 Sep 2014 18:11:07 +0000"  >&lt;p&gt;+1 separate ticket&lt;/p&gt;</comment>
                            <comment id="14146172" author="beobal" created="Wed, 24 Sep 2014 10:22:45 +0000"  >&lt;p&gt;Ok, so seeing as we&apos;re all good with a separate ticket for native archival, attaching a v2 patch for 2.1 which doesn&apos;t fail startup when a segment to restore is already present in the commitlog dir. &lt;/p&gt;</comment>
                            <comment id="14152144" author="puertea" created="Mon, 29 Sep 2014 19:40:11 +0000"  >&lt;p&gt;Is there anybody reviewing the patch now?&lt;/p&gt;</comment>
                            <comment id="14153581" author="jbellis" created="Tue, 30 Sep 2014 19:11:46 +0000"  >&lt;p&gt;LGTM.  Committed w/ minor changes to javadoc, and changed .info log to .debug.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12742299">CASSANDRA-7965</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12907979">CASSANDRA-10593</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12670069" name="2.0-6904.txt" size="2091" author="samt" created="Fri, 19 Sep 2014 19:08:47 +0000"/>
                            <attachment id="12670946" name="2.1-6904-v2.txt" size="4270" author="samt" created="Wed, 24 Sep 2014 10:22:45 +0000"/>
                            <attachment id="12670068" name="2.1-6904.txt" size="3420" author="samt" created="Fri, 19 Sep 2014 19:08:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>381269</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 8 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1totz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>381545</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>