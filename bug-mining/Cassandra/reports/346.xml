<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:13:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-1169] AES makes Streaming unhappy</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-1169</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Streaming service assumes there will only be one stream from S to T at a time for any nodes S and T.  For the original purpose of node movement, this was a reasonable assumption (any node T can only perform one move at a time) but AES throws off streaming tasks much more frequently than that given the right conditions, which will de-sync the fragile file ordering that Streaming assumes (that T knows which files S is going to send, in what order).  Eventually T is expecting file F1 but S sends a smaller file F2, leading to an infinite loop on T while it waits for F1 to finish, and T waits for S to acknowledge F2, which it never will.&lt;/p&gt;

&lt;p&gt;For 0.6 maybe the best solution is for AES to manually wait for one of its streaming tasks to finish, before it allows itself to create another.  For 0.7 it would be nice to make Streaming more robust.  The whole 4-stage-ack process seems very fragile, and poking around in parent objects via inetaddress keys makes reasoning about small pieces impossible b/c of encapsulation violations.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12466310">CASSANDRA-1169</key>
            <summary>AES makes Streaming unhappy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gdusbabek">Gary Dusbabek</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Mon, 7 Jun 2010 03:41:25 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:22 +0000</updated>
                            <resolved>Mon, 14 Jun 2010 18:40:07 +0000</resolved>
                                        <fixVersion>0.6.3</fixVersion>
                    <fixVersion>0.7 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="12876217" author="gdusbabek" created="Mon, 7 Jun 2010 12:04:13 +0000"  >&lt;p&gt;Is this the root cause of the problems being experienced at Digg and by Lu Ming on the ML?&lt;/p&gt;</comment>
                            <comment id="12876249" author="jbellis" created="Mon, 7 Jun 2010 14:17:30 +0000"  >&lt;p&gt;I think so.  That&apos;s what prompted this ticket.&lt;/p&gt;</comment>
                            <comment id="12876308" author="lenn0x" created="Mon, 7 Jun 2010 16:53:03 +0000"  >&lt;p&gt;As mentioned on IRC, we actually saw T sending to S, while anticompaction was running on S using the exact filename as T. We should probably break streaming out to support `stream/&amp;lt;source&amp;gt;/&amp;lt;sstables&amp;gt;`. &lt;/p&gt;</comment>
                            <comment id="12877085" author="appodictic" created="Wed, 9 Jun 2010 14:19:37 +0000"  >&lt;p&gt;I have this problem as well. I have a 5 node cluster. A simple repair on keyspace1 (which has nothing but some test data) streams never complete.&lt;/p&gt;</comment>
                            <comment id="12877086" author="appodictic" created="Wed, 9 Jun 2010 14:32:09 +0000"  >&lt;p&gt;I have upgraded to 6.2 because 6.1 streaming would randomly timeout on me. Now, I am still having issues with move, join, repair. Since I was having so many streaming problems I tuned this up in some logs. Over the past few weeks I have spent a lot of time managing my clusters, I try to do these type of operations in the AM so they are less performance impacting, but I have a very low sucess rate with any move,join,repair. I have a building list of nodes to join and ring management that I keep having to put off due to failures. So anything to make these processes less brittle would be a big big deal. Attached is ooutput.&lt;/p&gt;
</comment>
                            <comment id="12877820" author="gdusbabek" created="Fri, 11 Jun 2010 14:33:20 +0000"  >&lt;p&gt;Ensures that AES streaming happens on the streaming stage and waits for each transfer to complete.&lt;/p&gt;</comment>
                            <comment id="12877840" author="jbellis" created="Fri, 11 Jun 2010 15:56:24 +0000"  >&lt;p&gt;you don&apos;t need to do that exception dance with futures, it will throw an exception that happened in the background as a wrapped ExecutionException on get (and all our executors are DebuggableTPE, which makes sure the exception gets logged even if get() is never called)&lt;/p&gt;

&lt;p&gt;LGTM otherwise&lt;/p&gt;</comment>
                            <comment id="12878232" author="albert_e" created="Sat, 12 Jun 2010 08:21:02 +0000"  >&lt;p&gt;StreamOutManager.waitForStreamCompletion() can&apos;t block the AES streaming thread if StreamOutManager.condition is signaled once and StreamOutManager has not been removed from streamManagers map. &lt;/p&gt;

&lt;p&gt;Make StreamOutManager.addFilesToStream() synchronized and block the thread if StreamOutManager.files.size() &amp;gt; 0 may be more efficient.&lt;/p&gt;</comment>
                            <comment id="12878234" author="xluke" created="Sat, 12 Jun 2010 08:29:46 +0000"  >&lt;p&gt;I have applied your patch to cassandra.&lt;br/&gt;
According to my log on StreamOutManager.addFilesToStream() , the function is still called when StreamOutManager.files.size() &amp;gt; 0 &lt;br/&gt;
I think the problem is maybe not fixed yet.&lt;/p&gt;</comment>
                            <comment id="12878249" author="xluke" created="Sat, 12 Jun 2010 10:57:59 +0000"  >&lt;p&gt;After I applied the above patch,&lt;br/&gt;
StreamOutManager.waitForStreamCompletion()  return immediately and StreamOut.transferSSTables do Not  wait for its streaming tasks to finish&lt;/p&gt;

&lt;p&gt;27938- INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-12 17:08:48,810 StreamOut.java (line 132) Sending a stream initiate message to /121.1.1.1...&lt;br/&gt;
27939: INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-12 17:08:48,810 StreamOut.java (line 137) Waiting for transfer to /121.1.1.1 to complete&lt;br/&gt;
27940- INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-12 17:08:48,810 StreamOut.java (line 141) Done with transfer to /121.1.1.1&lt;br/&gt;
27941- INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;AE-SERVICE-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-12 17:08:48,811 AntiEntropyService.java (line 641) Finished streaming repair to /121.1.1.1 for (GroupDataStore,Group)&lt;br/&gt;
..................................&lt;br/&gt;
27982- INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-12 17:19:22,066 StreamOut.java (line 132) Sending a stream initiate message to /222.222.2.2 ...&lt;br/&gt;
27983: INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-12 17:19:22,066 StreamOut.java (line 137) Waiting for transfer to /222.222.2.2 to complete&lt;br/&gt;
27984- INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-12 17:19:22,066 StreamOut.java (line 141) Done with transfer to /222.222.2.2&lt;br/&gt;
27985- INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;AE-SERVICE-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-12 17:19:22,067 AntiEntropyService.java (line 641) Finished streaming repair to /222.222.2.2 for (GroupChat,Topic)&lt;br/&gt;
..................................&lt;/p&gt;</comment>
                            <comment id="12878664" author="gdusbabek" created="Mon, 14 Jun 2010 17:55:02 +0000"  >&lt;p&gt;Instruct AES to remove active StreamManager when it&apos;s finished and reset the condition in SOM any time files are added so that it is a bit more reentrant.&lt;/p&gt;</comment>
                            <comment id="12878665" author="gdusbabek" created="Mon, 14 Jun 2010 17:56:23 +0000"  >&lt;p&gt;albert_e: patch 2 adjusts addFilesToStream to reset the condition so that future waiters do wait.&lt;br/&gt;
Lu Ming: I believe you were experiencing that problem.&lt;/p&gt;</comment>
                            <comment id="12878670" author="jbellis" created="Mon, 14 Jun 2010 18:04:14 +0000"  >&lt;p&gt;won&apos;t removing the active SOM bork things, if another stream to that target is going on?&lt;/p&gt;</comment>
                            <comment id="12878675" author="gdusbabek" created="Mon, 14 Jun 2010 18:20:03 +0000"  >&lt;p&gt;SOM.remove() checks for that.  (I&apos;m not saying the code is perfect-&lt;del&gt;it&apos;s not&lt;/del&gt;-but I don&apos;t think removing the SOM is going to mess things up.)&lt;/p&gt;</comment>
                            <comment id="12878677" author="stuhood" created="Mon, 14 Jun 2010 18:20:45 +0000"  >&lt;p&gt;Rather than an &apos;endpoint-&amp;gt;StreamManager&apos; map, we really should have a &apos;session_id-&amp;gt;StreamManager&apos; map.&lt;/p&gt;</comment>
                            <comment id="12878682" author="gdusbabek" created="Mon, 14 Jun 2010 18:26:09 +0000"  >&lt;p&gt;Stu: Right.  But I don&apos;t think we want to introduce it in 0.6.  I&apos;m hoping just to get things to the point of working and then fix it all in 0.7. &lt;/p&gt;</comment>
                            <comment id="12878684" author="jbellis" created="Mon, 14 Jun 2010 18:34:11 +0000"  >&lt;p&gt;+1 on this patch and do-what-we-can-in-0.6-and-eviscerate-this-crap-in-0.7 in general&lt;/p&gt;</comment>
                            <comment id="12878689" author="gdusbabek" created="Mon, 14 Jun 2010 18:40:07 +0000"  >&lt;p&gt;both patches are committed and merged.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12447046" name="1169-2.txt" size="2071" author="gdusbabek" created="Mon, 14 Jun 2010 17:55:02 +0000"/>
                            <attachment id="12446866" name="1169.txt" size="1536" author="gdusbabek" created="Fri, 11 Jun 2010 14:33:20 +0000"/>
                            <attachment id="12446693" name="aes.txt" size="34515" author="appodictic" created="Wed, 9 Jun 2010 14:32:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[gdusbabek]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20014</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 24 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g3f3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91984</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>