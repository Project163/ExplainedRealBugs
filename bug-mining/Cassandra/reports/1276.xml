<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:27:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3446] Problem SliceByNamesReadCommand on super column family after flush operation</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3446</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;m having a problem with doing a multiget_slice on a super column family&lt;br/&gt;
after its first flush. Updates to the column values work properly, but&lt;br/&gt;
trying to retrieve the updated values using a multiget_slice operation fail&lt;br/&gt;
to get the updated values. Instead they return the values from before the&lt;br/&gt;
flush. The problem is not apparent with standard column families.&lt;/p&gt;

&lt;p&gt;I&apos;ve seen this problem in Cassandra v1.0.0 and v1.0.1. The problem&lt;br/&gt;
is not present in Cassandra v0.7.6.&lt;/p&gt;

&lt;p&gt;Steps to reproduce:&lt;/p&gt;

&lt;p&gt;   1. Create one or more super column entries&lt;br/&gt;
   2. Verify the sub column values can be updated and that you can retrieve&lt;br/&gt;
   the new values&lt;br/&gt;
   3. Use nodetool to flush the column family or restart cassandra&lt;br/&gt;
   4. Update the sub column values&lt;br/&gt;
   5. Verify they have been updated using cassandra-cli&lt;br/&gt;
   6. Verify you &lt;b&gt;DO NOT&lt;/b&gt; get the updated values when doing a&lt;br/&gt;
   multiget_slice; instead you get the old values from before the flush&lt;/p&gt;

&lt;p&gt;You can get the most recent value by doing a flush followed by a major&lt;br/&gt;
compaction. However, future updates are not retrieved properly either.&lt;/p&gt;

&lt;p&gt;With debug turned on, it looks like the multiget_slice query uses the&lt;br/&gt;
following command/consistency level:&lt;br/&gt;
SliceByNamesReadCommand(table=&apos;test_cassandra&apos;, key=666f6f,&lt;br/&gt;
columnParent=&apos;QueryPath(columnFamilyName=&apos;test&apos;, superColumnName=&apos;null&apos;,&lt;br/&gt;
columnName=&apos;null&apos;)&apos;, columns=&lt;span class=&quot;error&quot;&gt;&amp;#91;foo,&amp;#93;&lt;/span&gt;)/QUORUM.&lt;/p&gt;

&lt;p&gt;Cassandra-cli uses the following command/consistency level for a get_slice:&lt;br/&gt;
SliceFromReadCommand(table=&apos;test_cassandra&apos;, key=&apos;666f6f&apos;,&lt;br/&gt;
column_parent=&apos;QueryPath(columnFamilyName=&apos;test&apos;, superColumnName=&apos;null&apos;,&lt;br/&gt;
columnName=&apos;null&apos;)&apos;, start=&apos;&apos;, finish=&apos;&apos;, reversed=false,&lt;br/&gt;
count=1000000)/QUORUM&lt;/p&gt;

&lt;p&gt;Notice the test program gets &apos;bar2&apos; for the column values and cassandra-cli&lt;br/&gt;
gets &apos;bar3&apos; for the column values:&lt;/p&gt;

&lt;p&gt;tcpdump from test program using hector-core:1.0-1&lt;/p&gt;

&lt;p&gt;16:46:07.424562 IP iam.47158 &amp;gt; iam.9160: Flags &lt;span class=&quot;error&quot;&gt;&amp;#91;P.&amp;#93;&lt;/span&gt;, seq 55:138, ack 30,&lt;br/&gt;
win 257, options &lt;span class=&quot;error&quot;&gt;&amp;#91;nop,nop,TS val 27474096 ecr 27474095&amp;#93;&lt;/span&gt;, length 83&lt;br/&gt;
E....#@.@.PK.........6#.....].8......{.....&lt;br/&gt;
..8...8.........multiget_slice................foo..........test................foo.........&lt;br/&gt;
16:46:07.424575 IP iam.9160 &amp;gt; iam.47158: Flags &lt;span class=&quot;error&quot;&gt;&amp;#91;.&amp;#93;&lt;/span&gt;, ack 138, win 256,&lt;br/&gt;
options &lt;span class=&quot;error&quot;&gt;&amp;#91;nop,nop,TS val 27474096 ecr 27474096&amp;#93;&lt;/span&gt;, length 0&lt;br/&gt;
E..4..@.@.&amp;lt;.........#..6].8..........(.....&lt;br/&gt;
..8...8.&lt;br/&gt;
16:46:07.428771 IP iam.9160 &amp;gt; iam.47158: Flags &lt;span class=&quot;error&quot;&gt;&amp;#91;P.&amp;#93;&lt;/span&gt;, seq 30:173, ack 138,&lt;br/&gt;
win 256, options &lt;span class=&quot;error&quot;&gt;&amp;#91;nop,nop,TS val 27474097 ecr 27474096&amp;#93;&lt;/span&gt;, length 143&lt;br/&gt;
@.@.&amp;lt;&amp;amp;........#..6].8................&lt;br/&gt;
............foo...............foo...............foo1.......bar2&lt;br/&gt;
........6h........foo2.......bar2&lt;br/&gt;
........I.....&lt;/p&gt;


&lt;p&gt;tcpdump of cassandra-cli:&lt;/p&gt;

&lt;p&gt;16:30:55.945123 IP iam.47134 &amp;gt; iam.9160: Flags &lt;span class=&quot;error&quot;&gt;&amp;#91;P.&amp;#93;&lt;/span&gt;, seq 370:479, ack 5310,&lt;br/&gt;
win 387, options &lt;span class=&quot;error&quot;&gt;&amp;#91;nop,nop,TS val 27246226 ecr 27241207&amp;#93;&lt;/span&gt;, length 109&lt;br/&gt;
E.....@.@.9q..........#..n.X\&lt;br/&gt;
.............&lt;br/&gt;
................get_range_slices..............test.........................................................d.........&lt;br/&gt;
16:30:55.945152 IP iam.9160 &amp;gt; iam.47134: Flags &lt;span class=&quot;error&quot;&gt;&amp;#91;.&amp;#93;&lt;/span&gt;, ack 479, win 256,&lt;br/&gt;
options &lt;span class=&quot;error&quot;&gt;&amp;#91;nop,nop,TS val 27246226 ecr 27246226&amp;#93;&lt;/span&gt;, length 0&lt;br/&gt;
E..4..@.@.&quot;.........#...\&lt;br/&gt;
...n.......(.....&lt;br/&gt;
........&lt;br/&gt;
16:30:55.949245 IP iam.9160 &amp;gt; iam.47134: Flags &lt;span class=&quot;error&quot;&gt;&amp;#91;P.&amp;#93;&lt;/span&gt;, seq 5310:5461, ack&lt;br/&gt;
479, win 256, options &lt;span class=&quot;error&quot;&gt;&amp;#91;nop,nop,TS val 27246227 ecr 27246226&amp;#93;&lt;/span&gt;, length 151&lt;br/&gt;
E.....@.@.&quot;V........#...\&lt;br/&gt;
...n.............&lt;br/&gt;
....................get_range_slices...................foo..................foo...............foo1.......bar3&lt;br/&gt;
........&amp;amp;.........foo2.......bar3&lt;br/&gt;
........: .....&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux iam 3.0.0-12-generic #20-Ubuntu SMP Fri Oct 7 14:56:25 UTC 2011 x86_64 x86_64 x86_64 GNU/Linux&lt;br/&gt;
java version &quot;1.6.0_23&quot;&lt;br/&gt;
OpenJDK Runtime Environment (IcedTea6 1.11pre) (6b23~pre10-0ubuntu5)&lt;br/&gt;
OpenJDK 64-Bit Server VM (build 20.0-b11, mixed mode)&lt;br/&gt;
hector-core; 1.0-1&lt;/p&gt;</environment>
        <key id="12529885">CASSANDRA-3446</key>
            <summary>Problem SliceByNamesReadCommand on super column family after flush operation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="rheostat">Mike Smith</reporter>
                        <labels>
                            <label>supercolumns</label>
                    </labels>
                <created>Wed, 2 Nov 2011 16:15:25 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:47 +0000</updated>
                            <resolved>Tue, 8 Nov 2011 17:55:31 +0000</resolved>
                                        <fixVersion>1.0.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13142401" author="jbellis" created="Wed, 2 Nov 2011 18:40:17 +0000"  >&lt;p&gt;Can you post your columnfamily create statement?&lt;/p&gt;</comment>
                            <comment id="13142462" author="rheostat" created="Wed, 2 Nov 2011 19:59:32 +0000"  >&lt;p&gt;create keyspace test_cassandra;&lt;br/&gt;
use test_cassandra;&lt;br/&gt;
create column family test1 with column_type = &apos;Super&apos; and comparator =&lt;br/&gt;
&apos;AsciiType&apos;;&lt;br/&gt;
create column family test2 with column_type = &apos;Standard&apos; and comparator =&lt;br/&gt;
&apos;AsciiType&apos;;&lt;/p&gt;</comment>
                            <comment id="13142832" author="jbellis" created="Thu, 3 Nov 2011 04:42:38 +0000"  >&lt;p&gt;Is this just a single-node cluster?&lt;/p&gt;</comment>
                            <comment id="13142833" author="rheostat" created="Thu, 3 Nov 2011 04:49:32 +0000"  >&lt;p&gt;Yes, single node cluster.&lt;/p&gt;


&lt;p&gt;On Wed, Nov 2, 2011 at 9:43 PM, Jonathan Ellis (Commented) (JIRA) &amp;lt;&lt;/p&gt;
</comment>
                            <comment id="13144260" author="rbranson" created="Fri, 4 Nov 2011 19:19:33 +0000"  >&lt;p&gt;Adds a unit test to ColumnFamilyStoreTest to reproduce the issue.&lt;/p&gt;</comment>
                            <comment id="13145684" author="norru" created="Mon, 7 Nov 2011 18:37:59 +0000"  >&lt;p&gt;I had a similar problem and spent a fair amount of time tracking it down. It appears related to a problem in collating data from Memtables and SStables, but only when the query involves SuperColumns&lt;/p&gt;

&lt;p&gt;I may have found a fix. It did solve the problem for me but I haven&apos;t tested extensively for regressions or concurrency issues.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt; org.apache.cassandra.db;

&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;TreeMapBackedSortedColumns &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; TreeMap&amp;lt;ByteBuffer, IColumn&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; ISortedColumns



    /*
     * If we find an old column that has the same name
     * the ask it to resolve itself &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; add the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; column
    */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void addColumn(IColumn column, Allocator allocator)
    {
        ByteBuffer name = column.name();
        IColumn oldColumn = put(name, column);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldColumn != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (oldColumn &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; SuperColumn)
            {
                &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; column &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; SuperColumn;
                ((SuperColumn) oldColumn).putColumn((SuperColumn)column, allocator);
                &lt;span class=&quot;code-comment&quot;&gt;// we need to restore the old value here or things won&apos;t work! --norru@scee.net
&lt;/span&gt;                put(name, oldColumn); &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;--- here it is
&lt;/span&gt;            }
            &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
            {
                &lt;span class=&quot;code-comment&quot;&gt;// calculate reconciled col from old (existing) col and &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; col
&lt;/span&gt;                IColumn reconciledColumn = column.reconcile(oldColumn, allocator);
                put(name, reconciledColumn);
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let me know if you need a proper patch. It&apos;s an one liner so it might be easier for you to add the line yourself.&lt;/p&gt;

&lt;p&gt;Also let me know if you need more details. Cheers!&lt;/p&gt;</comment>
                            <comment id="13145705" author="jbellis" created="Mon, 7 Nov 2011 18:57:26 +0000"  >&lt;p&gt;There&apos;s at least two problems here.  One is the one Nicola describes.  The other is that the name-based path in CollationController stops as soon as it finds one subcolumn in a given supercolumn.&lt;/p&gt;

&lt;p&gt;Working on a patch for both.&lt;/p&gt;</comment>
                            <comment id="13145835" author="jbellis" created="Mon, 7 Nov 2011 21:38:45 +0000"  >&lt;p&gt;There&apos;s a third bug involved, that can hide the second: SuperColumn.minTimestamp is calculated incorrectly.&lt;/p&gt;

&lt;p&gt;Patch 01 adds tests for the two &quot;main&quot; bugs and fixes them.  Patch 02 removes SC.minTimestamp since part of the 01 fix is recognizing that we shouldn&apos;t short-circuit a SuperColumn read, since we don&apos;t know how many potential subcolumns there are without an exhaustive search.&lt;/p&gt;</comment>
                            <comment id="13145864" author="rheostat" created="Mon, 7 Nov 2011 22:02:19 +0000"  >&lt;p&gt;I applied the patches to 1.0.2 and all looks good. Thanks a lot for the quick turn around and keep up the good work!!&lt;/p&gt;</comment>
                            <comment id="13146184" author="slebresne" created="Tue, 8 Nov 2011 09:27:21 +0000"  >&lt;p&gt;+1, good catches.&lt;/p&gt;</comment>
                            <comment id="13146434" author="jbellis" created="Tue, 8 Nov 2011 17:55:31 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13147708" author="jborgstrom" created="Thu, 10 Nov 2011 14:28:49 +0000"  >&lt;p&gt;I&apos;m not sure it&apos;s related at all but &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3466&quot; title=&quot;Hinted handoff not working after rolling upgrade from 0.8.7 to 1.0.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3466&quot;&gt;&lt;del&gt;CASSANDRA-3466&lt;/del&gt;&lt;/a&gt; is about the HintsColumnFamily mysteriously losing or gaining some subcolumns after a hints delivery and corresponding flush.&lt;/p&gt;

&lt;p&gt;First assumption was that this was related to this ticket. But after some further testing with a patched 1.0.2 I was still able to reproduce the AssertionError.&lt;br/&gt;
So either these two tickets are not related at all or the proposed patches does not fix all cases.&lt;/p&gt;

&lt;p&gt;If anyone&apos;s interested &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3466&quot; title=&quot;Hinted handoff not working after rolling upgrade from 0.8.7 to 1.0.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3466&quot;&gt;&lt;del&gt;CASSANDRA-3466&lt;/del&gt;&lt;/a&gt; contains an attachment with DEBUG-logs and data files from when I reproduced the issue.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12502817" name="0001-fix-addColumn-and-collation-supercolumn-bugs.patch" size="11760" author="jbellis" created="Mon, 7 Nov 2011 21:39:16 +0000"/>
                            <attachment id="12502818" name="0002-r-m-minTimestamp-method.patch" size="3076" author="jbellis" created="Mon, 7 Nov 2011 21:39:16 +0000"/>
                            <attachment id="12502506" name="3446-test.patch" size="2930" author="rbranson" created="Fri, 4 Nov 2011 19:19:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>215744</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 2 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gk07:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94671</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>