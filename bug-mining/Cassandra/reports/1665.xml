<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:33:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4317] AssertionError in handleStateNormal in a mixed cluster</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4317</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In a 3 node cluster with one seed on trunk, a member on trunk, and another member on a previous version, the following occurs only on the non-seed trunk member:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
ERROR 16:44:18,708 Exception in thread Thread[GossipStage:1,5,main]
java.lang.AssertionError
        at org.apache.cassandra.service.StorageService.handleStateNormal(StorageService.java:1072)
        at org.apache.cassandra.service.StorageService.onChange(StorageService.java:995)
        at org.apache.cassandra.service.StorageService.onJoin(StorageService.java:1568)
        at org.apache.cassandra.gms.Gossiper.handleMajorStateChange(Gossiper.java:819)
        at org.apache.cassandra.gms.Gossiper.applyStateLocally(Gossiper.java:897)
        at org.apache.cassandra.gms.GossipDigestAck2VerbHandler.doVerb(GossipDigestAck2VerbHandler.java:43)
        at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:57)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
        at java.lang.Thread.run(Thread.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This doesn&apos;t repro if a non-trunk member is the seed, however upgrading the seed first should still be valid.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12559719">CASSANDRA-4317</key>
            <summary>AssertionError in handleStateNormal in a mixed cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Jun 2012 16:51:59 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:33 +0000</updated>
                            <resolved>Wed, 20 Jun 2012 02:12:47 +0000</resolved>
                                        <fixVersion>1.2.0 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13295104" author="brandon.williams" created="Thu, 14 Jun 2012 15:26:36 +0000"  >&lt;p&gt;The problem here is similar to what &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4311&quot; title=&quot;clean up messagingservice protocol limitations&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4311&quot;&gt;&lt;del&gt;CASSANDRA-4311&lt;/del&gt;&lt;/a&gt; is trying to solve, but with a small twist.&lt;/p&gt;

&lt;p&gt;Consider node X, Y, and Z.  Both X and Y are on the newer version v2, but Z is on the older version v1.  X is the seed, and Z is the first to talk to X, and they complete a gossip round and both speak v1 to each other.  Now Y contacts X and they complete a gossip round, where Y learns about Z.  The problem, however, is that Y has never talked directly to Z, so it doesn&apos;t actually know Z&apos;s version yet but needs to handle events for it.  StorageService then does version checks to determine how to handle the events for Z, but getVersion assumes the current version (v2 in this example) when it doesn&apos;t actually know what the version is, and thus ends up processing old-style information as new-style and fails.  This isn&apos;t limited to handleStateNormal, but likely any event called from onChange.&lt;/p&gt;

&lt;p&gt;Solving this is somewhat tricky.  Reviving &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4101&quot; title=&quot;Gossip should propagate MessagingService.version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4101&quot;&gt;&lt;del&gt;CASSANDRA-4101&lt;/del&gt;&lt;/a&gt; would do it, but then we have two sources of version information and I&apos;m not sure how clean that will be.  getVersion would have to check for null, and if found check for a gossip version, and if that too is not found assume the &lt;b&gt;lowest&lt;/b&gt; version.&lt;/p&gt;
</comment>
                            <comment id="13396900" author="brandon.williams" created="Tue, 19 Jun 2012 16:22:59 +0000"  >&lt;p&gt;The first patch is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4101&quot; title=&quot;Gossip should propagate MessagingService.version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4101&quot;&gt;&lt;del&gt;CASSANDRA-4101&lt;/del&gt;&lt;/a&gt; rebased, which gossips the net version.&lt;/p&gt;

&lt;p&gt;The second adds a way to see is MS &lt;em&gt;really&lt;/em&gt; knows the version (so that we don&apos;t have to mess with its current behavior) and encapsulates the logic to check both it and gossip to determine if hostids should be used inside SS, replacing all the current checks there as well.&lt;/p&gt;</comment>
                            <comment id="13397216" author="vijay2win@yahoo.com" created="Wed, 20 Jun 2012 01:59:25 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13397219" author="brandon.williams" created="Wed, 20 Jun 2012 02:12:47 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12559479">CASSANDRA-4311</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12549707">CASSANDRA-4120</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12548572">CASSANDRA-4101</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12532575" name="0001-Gossip-current-network-version.txt" size="3531" author="brandon.williams" created="Tue, 19 Jun 2012 16:22:59 +0000"/>
                            <attachment id="12532576" name="0002-Check-both-ms-and-gossip-for-version-when-handling-sta.txt" size="4585" author="brandon.williams" created="Tue, 19 Jun 2012 16:22:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256055</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 22 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gui7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96372</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>vijay2win@yahoo.com</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[vijay2win@yahoo.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>