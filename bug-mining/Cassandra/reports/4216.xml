<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:02:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11556] PER PARTITION LIMIT does not work properly for multi-partition query with ORDER BY</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11556</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Multi-partition queries with &lt;tt&gt;PER PARTITION LIMIT&lt;/tt&gt; with &lt;tt&gt;ORDER BY&lt;/tt&gt; do not respect the &lt;tt&gt;PER PARTITION LIMIT&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The problem can be reproduced with the following unit test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testPerPartitionLimitWithMultiPartitionQueryAndOrderBy() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
    {
        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY (a, b))&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 5; i++)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; j = 0; j &amp;lt; 5; j++)
            {
                execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (a, b, c) VALUES (?, ?, ?)&quot;&lt;/span&gt;, i, j, j);
            }
        }

        assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE a IN (2, 3) ORDER BY b DESC PER PARTITION LIMIT ?&quot;&lt;/span&gt;, 2),
                                row(2, 4, 4),
                                row(3, 4, 4),
                                row(2, 3, 3),
                                row(3, 3, 3));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </description>
                <environment></environment>
        <key id="12958087">CASSANDRA-11556</key>
            <summary>PER PARTITION LIMIT does not work properly for multi-partition query with ORDER BY</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="blerer">Benjamin Lerer</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Apr 2016 11:57:53 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:36 +0000</updated>
                            <resolved>Thu, 14 Apr 2016 09:57:04 +0000</resolved>
                                        <fixVersion>3.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="15237281" author="ifesdjeen" created="Tue, 12 Apr 2016 14:34:53 +0000"  >&lt;p&gt;I&apos;ve found the source of the problem: it&apos;s post-query ordering clause. I&apos;ve written a little patch &lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11556-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, although I can say that, for example, queries like &lt;tt&gt;SELECT COUNT&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; FROM tbl PER PARTITION LIMIT 5&lt;/tt&gt; would return unexpected amount of results, since aggregate queries do not respect limits at the moment. &lt;/p&gt;

&lt;p&gt;Do we want to support these queries, disallow them (this would be quite simple, just checking for &lt;tt&gt;perPartitionLimit == null &amp;amp;&amp;amp; selection.isAggregate()&lt;/tt&gt;? &lt;/p&gt;</comment>
                            <comment id="15237329" author="blerer" created="Tue, 12 Apr 2016 14:59:18 +0000"  >&lt;p&gt;The &lt;tt&gt;LIMIT&lt;/tt&gt; clause is used to filter the results returned to the user by consequence it has no effect on an aggregate queries as they returns only one result.&lt;br/&gt;
In my opinion, we should look at the &lt;tt&gt;PER PARTITION LIMIT&lt;/tt&gt; in the same way, meaning a limit on the results returned to the user. In which case it makes sense to reject it for aggregate queries. I think it would be reasonable on the other hand to support it with group by queries (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10707&quot; title=&quot;Add support for Group By to Select statement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10707&quot;&gt;&lt;del&gt;CASSANDRA-10707&lt;/del&gt;&lt;/a&gt;) as the groups are build at the partition level.  &lt;/p&gt;</comment>
                            <comment id="15237804" author="ifesdjeen" created="Tue, 12 Apr 2016 19:18:02 +0000"  >&lt;p&gt;In this case patch should do as you say (skip &lt;tt&gt;PER PARTITION LIMIT&lt;/tt&gt; if it&apos;s aggregate, same as &lt;tt&gt;LIMIT&lt;/tt&gt;, although allow &lt;tt&gt;PER PARTITION LIMIT&lt;/tt&gt; when post-query ordering is required).&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11556-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11556-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11556-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15238773" author="blerer" created="Wed, 13 Apr 2016 07:41:35 +0000"  >&lt;p&gt;Even if the &lt;tt&gt;LIMIT&lt;/tt&gt; clause now works like for &lt;tt&gt;SQL&lt;/tt&gt; a lot of users are still confused by it (it might be because it was implemented wrongly before 2.2).&lt;br/&gt;
If you have a query like &lt;tt&gt;SELECT count(&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/star_yellow.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;) FROM myTable PER PARTITION LIMIT 2&lt;/tt&gt; it is easy to be confused about what the result should be as it depends on when the limit will be applied (before or after the aggregation). My guess is that some people will believe that the limit is applied before the aggregation and that they will open some tickets to complain about it, when they will discover it is not. It is why in the case of &lt;tt&gt;PER PARTITION LIMIT&lt;/tt&gt;, I will prefer to throw an error. Like that users do not get wrong expectations.&lt;/p&gt;

&lt;p&gt;3 nits regarding the patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;It is better to not use &lt;tt&gt;assertRowsIgnoringOrder&lt;/tt&gt; for testing ordering as it can hide some ordering problem.&lt;/li&gt;
	&lt;li&gt;Could you also add a test for &lt;tt&gt;SELECT * FROM %s WHERE a IN (2, 3) ORDER BY b DESC PER PARTITION LIMIT ? LIMIT ?&lt;/tt&gt;?&lt;/li&gt;
	&lt;li&gt;the &lt;tt&gt;PER PARTITION LIMIT&lt;/tt&gt; tests should probably be move to &lt;tt&gt;SelectLimitTest&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15239519" author="ifesdjeen" created="Wed, 13 Apr 2016 16:14:36 +0000"  >&lt;p&gt;Thank you for the review! &lt;/p&gt;

&lt;p&gt;To summarise:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I&apos;ve added an &lt;tt&gt;InvalidRequestException&lt;/tt&gt; on aggregate queries with &lt;tt&gt;PER PARTITION LIMIT&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;got rid of &lt;tt&gt;assertRowsIgnoringOrder&lt;/tt&gt; and &lt;tt&gt;assertRowsCount&lt;/tt&gt; (there are just two places where &lt;tt&gt;assertRowsCount&lt;/tt&gt; is used. It was mostly for simplicity (as we don&apos;t know which partitions are returned) plus these tests are covered in dtest.&lt;/li&gt;
	&lt;li&gt;added test with &lt;tt&gt;ORDER&lt;/tt&gt;, &lt;tt&gt;LIMIT&lt;/tt&gt; and &lt;tt&gt;PER PARTITION LIMIT&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;moved the tests to &lt;tt&gt;SelectLimitTest&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/11556-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11556-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://cassci.datastax.com/view/Dev/view/ifesdjeen/job/ifesdjeen-11556-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Both dtests are failing on trunk, too, issue filed &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11560&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;here&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11127&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;here&lt;/a&gt;. Unit tests are passing.&lt;/p&gt;</comment>
                            <comment id="15240891" author="blerer" created="Thu, 14 Apr 2016 09:56:39 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15240892" author="blerer" created="Thu, 14 Apr 2016 09:57:04 +0000"  >&lt;p&gt;Committed in trunk at 9a0eb9a31e71cfc43def6497907ce2ab3d091aa1&lt;/p&gt;</comment>
                            <comment id="15240895" author="ifesdjeen" created="Thu, 14 Apr 2016 10:01:03 +0000"  >&lt;p&gt;Thank you!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 31 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vzrz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>