<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:00:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9949] maxPurgeableTimestamp needs to check memtables too</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9949</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;overlapIterator/maxPurgeableTimestamp don&apos;t include the memtables, so a very-out-of-order write could be ignored&lt;/p&gt;</description>
                <environment></environment>
        <key id="12850710">CASSANDRA-9949</key>
            <summary>maxPurgeableTimestamp needs to check memtables too</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Fri, 31 Jul 2015 22:20:32 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:02 +0000</updated>
                            <resolved>Mon, 25 Jan 2016 09:13:33 +0000</resolved>
                                        <fixVersion>2.2.5</fixVersion>
                    <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.3</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14649931" author="jbellis" created="Fri, 31 Jul 2015 22:22:20 +0000"  >&lt;p&gt;Nit: should probably reverse the order of the predicates in &lt;tt&gt;timestamp &amp;lt; getMaxPurgeableTimestamp() &amp;amp;&amp;amp; localDeletionTime &amp;lt; gcBefore&lt;/tt&gt; since the former is expensive while the latter is not.&lt;/p&gt;</comment>
                            <comment id="14649971" author="iamaleksey" created="Fri, 31 Jul 2015 22:58:18 +0000"  >&lt;p&gt;Very out of order, or just with ridiculously low gc gs.&lt;/p&gt;

&lt;p&gt;This issue was raised by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; during &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6230&quot; title=&quot;Write hints to flat files instead of the system.hints&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6230&quot;&gt;&lt;del&gt;CASSANDRA-6230&lt;/del&gt;&lt;/a&gt; review, originally.&lt;/p&gt;</comment>
                            <comment id="15081334" author="stefania" created="Mon, 4 Jan 2016 16:42:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; : can you confirm this is required on all versions, including 2.1?&lt;/p&gt;

&lt;p&gt;Is looking at memtables when calculating the max purgeable timestamp all that&apos;s required (along with swapping the predicate and tests)? See &lt;a href=&quot;https://github.com/stef1927/cassandra/commit/e5be5cfafcfd203e1267367d94ae38c03d9d3793&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; for 2.1.&lt;/p&gt;</comment>
                            <comment id="15086347" author="iamaleksey" created="Wed, 6 Jan 2016 21:49:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; I would stick to 2.2.x+&lt;/p&gt;</comment>
                            <comment id="15086350" author="iamaleksey" created="Wed, 6 Jan 2016 21:50:30 +0000"  >&lt;p&gt;I also wonder what the effect on performance is when implemented this way&lt;/p&gt;</comment>
                            <comment id="15092139" author="stefania" created="Mon, 11 Jan 2016 15:37:17 +0000"  >&lt;p&gt;Thanks for clarifying the fix version. &lt;/p&gt;

&lt;p&gt;Re. performance are you concerned by the loop on all cells in a column family? We could approximate the min timestamp with the memtable creation time but I don&apos;t think this is a good approximation and it&apos;s probably wrong if we receive a partition from a remote host with an older timestamp. Storing the minimum timestamp in a column family and keeping it up-to-date requires a bit of work but we can go down this route if it is the correct choice. However I feel there may be a different approximation that I am missing.&lt;/p&gt;

&lt;p&gt;I also could use some hints on how to test this. Do you think a dtest is achievable? I&apos;m not so sure how easy it is to simulate a &apos;very-out-of-order&apos; write.&lt;/p&gt;</comment>
                            <comment id="15096157" author="stefania" created="Wed, 13 Jan 2016 13:11:12 +0000"  >&lt;p&gt;The patch for 2.2 is ready, I would like a review before I implement the equivalent for 3.0+.&lt;/p&gt;

&lt;p&gt;I decided to track the min timestamp at the memtable level, when a new partition is inserted. There is an inexpensive way to calculate the minimum timestamp by piggy-backing on the &lt;tt&gt;BTree&lt;/tt&gt; update loop on cells via &lt;tt&gt;AtomicBTreeColumns.ColumnUpdater&lt;/tt&gt;, specifically its &lt;tt&gt;apply&lt;/tt&gt; methods. The downside is that if a cell is reconciled with another cell with a later timestamp, we pick the smallest of the two timestamps even though technically the latest timestamp should be sufficient. This shouldn&apos;t matter though, since we then pick the smallest timestamp across all partitions in the memtable. I hope this is a good enough approximation.&lt;/p&gt;

&lt;p&gt;I&apos;ve also added a unit test which should be sufficient to test the new functionality.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/9949-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9949-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9949-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;CI is still running.&lt;/p&gt;</comment>
                            <comment id="15096194" author="stefania" created="Wed, 13 Jan 2016 13:39:46 +0000"  >&lt;p&gt;There is something really weird with the &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9949-2.2-dtest/lastSuccessfulBuild/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;first dtest run&lt;/a&gt;: all tests are failing with &lt;tt&gt;ERROR: Cassandra 3.0+ requires Java &amp;gt;= 1.8, found Java 1.7&lt;/tt&gt; but this is a 2.2 branch as confirmed by the version in &lt;em&gt;build.xml&lt;/em&gt;. cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=philipthompson&quot; class=&quot;user-hover&quot; rel=&quot;philipthompson&quot;&gt;philipthompson&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Relaunched. &lt;/p&gt;</comment>
                            <comment id="15096294" author="philipthompson" created="Wed, 13 Jan 2016 14:53:30 +0000"  >&lt;p&gt;It looks like the second run is working now. I&apos;ll try to add better debug logging so we know why the original happened.&lt;/p&gt;</comment>
                            <comment id="15096299" author="stefania" created="Wed, 13 Jan 2016 14:58:28 +0000"  >&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                            <comment id="15105471" author="krummas" created="Mon, 18 Jan 2016 16:15:18 +0000"  >&lt;p&gt;The approach looks good to me, two comments;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;could you rephrase &lt;a href=&quot;https://github.com/stef1927/cassandra/blob/aabec6bab0d4558b7ce9bfbdec17909ff0b90bc9/src/java/org/apache/cassandra/db/AtomicBTreeColumns.java#L474-L476&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this comment&lt;/a&gt;? I don&apos;t get why we can&apos;t use the reconciled version.&lt;/li&gt;
	&lt;li&gt;We should probably check the memtable min timestamp in CompactionController.getFullyExpiredSSTables as well&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15106398" author="stefania" created="Tue, 19 Jan 2016 07:45:11 +0000"  >&lt;p&gt;Thank you for your review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;, please see &lt;a href=&quot;https://github.com/stef1927/cassandra/commit/96dacb1c2f555d34753901e48fecf1f8f0190393&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this commit&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ve clarified the comment best I could and added a test to show what I mean. If it still doesn&apos;t make much sense to you, perhaps we should just change the test and pick the reconciled timestamp. I must admit I am not 100% sure of what&apos;s best.&lt;/p&gt;

&lt;p&gt;I&apos;ve updated &lt;tt&gt;CompactionController.getFullyExpiredSSTables()&lt;/tt&gt; and added a unit test for it.&lt;/p&gt;</comment>
                            <comment id="15106541" author="krummas" created="Tue, 19 Jan 2016 10:11:39 +0000"  >&lt;p&gt;I doubt it matters much which timestamp we pick there - this should happen very rarely and when it does, there is not much harm (we keep some tombstones around for a bit longer) so lets keep it consistent with the apply(Cell insert) functionality&lt;/p&gt;

&lt;p&gt;The 2.2-patch LGTM&lt;/p&gt;</comment>
                            <comment id="15107722" author="stefania" created="Wed, 20 Jan 2016 00:17:17 +0000"  >&lt;p&gt;Thanks, starting with the 3.0+ patch then.&lt;/p&gt;</comment>
                            <comment id="15112131" author="stefania" created="Fri, 22 Jan 2016 09:10:40 +0000"  >&lt;p&gt;The 3.0 patch is ready as well. This patch is much simpler than the 2.2 version because each partition already has the minimum timestamp in &lt;tt&gt;stats().minTimestamp&lt;/tt&gt;. There is a small conflict from 3.0 to 3.3 (very easy to resolve) and then it merges clearly from 3.3 to trunk.&lt;/p&gt;

&lt;p&gt;I&apos;m still monitoring CI and I will move the ticket to patch available once CI is confirmed fine.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.3&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/9949-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/9949-3.3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;-&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9949-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9949-3.3-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9949-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9949-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9949-3.3-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-9949-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15114791" author="stefania" created="Mon, 25 Jan 2016 05:43:33 +0000"  >&lt;p&gt;CI looks good, ready for review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15114924" author="krummas" created="Mon, 25 Jan 2016 09:13:33 +0000"  >&lt;p&gt;+1, committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 43 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2i77z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>