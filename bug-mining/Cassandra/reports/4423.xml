<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:04:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12192] Retry all internode messages once after reopening connections</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12192</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;example failure:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/upgrade_tests-all/59/testReport/upgrade_tests.cql_tests/TestCQLNodes3RF3_Upgrade_current_3_0_x_To_head_trunk/map_keys_indexing_test&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/upgrade_tests-all/59/testReport/upgrade_tests.cql_tests/TestCQLNodes3RF3_Upgrade_current_3_0_x_To_head_trunk/map_keys_indexing_test&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Failed on CassCI build upgrade_tests-all #59&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Stacktrace

  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/usr/lib/python2.7/unittest/&lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;.py&quot;&lt;/span&gt;, line 329, in run
    testMethod()
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/home/automaton/cassandra-dtest/tools.py&quot;&lt;/span&gt;, line 290, in wrapped
    f(obj)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;/home/automaton/cassandra-dtest/upgrade_tests/cql_tests.py&quot;&lt;/span&gt;, line 3668, in map_keys_indexing_test
    cursor.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;TRUNCATE test&quot;&lt;/span&gt;)
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;cassandra/cluster.py&quot;&lt;/span&gt;, line 1941, in cassandra.cluster.Session.execute (cassandra/cluster.c:33642)
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; self.execute_async(query, parameters, trace, custom_payload, timeout, execution_profile).result()
  File &lt;span class=&quot;code-quote&quot;&gt;&quot;cassandra/cluster.py&quot;&lt;/span&gt;, line 3629, in cassandra.cluster.ResponseFuture.result (cassandra/cluster.c:69369)
    raise self._final_exception
&apos;&amp;lt;Error from server: code=1003 [Error during truncate] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;Error during truncate: Truncate timed out - received only 2 responses&quot;&lt;/span&gt;&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Related failure: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/job/upgrade_tests-all/59/testReport/upgrade_tests.cql_tests/TestCQLNodes2RF1_Upgrade_current_3_0_x_To_head_trunk/map_keys_indexing_test/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/upgrade_tests-all/59/testReport/upgrade_tests.cql_tests/TestCQLNodes2RF1_Upgrade_current_3_0_x_To_head_trunk/map_keys_indexing_test/&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12989167">CASSANDRA-12192</key>
            <summary>Retry all internode messages once after reopening connections</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="sean.mccarthy">Sean McCarthy</reporter>
                        <labels>
                            <label>dtest</label>
                    </labels>
                <created>Wed, 13 Jul 2016 16:15:36 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:26 +0000</updated>
                            <resolved>Wed, 24 Aug 2016 22:32:53 +0000</resolved>
                                        <fixVersion>3.10</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15382549" author="philipthompson" created="Mon, 18 Jul 2016 16:36:27 +0000"  >&lt;p&gt;So, I have the following error in the logs of nodes2 and 3:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [MessagingService-Incoming-/127.0.0.1] 2016-07-13 05:23:15,952 CassandraDaemon.java:201 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MessagingService-Incoming-/127.0.0.1,5,main]
java.lang.RuntimeException: Unknown column cdc during deserialization
	at org.apache.cassandra.db.Columns$Serializer.deserialize(Columns.java:432) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.SerializationHeader$Serializer.deserializeForMessaging(SerializationHeader.java:427) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.deserializeHeader(UnfilteredRowIteratorSerializer.java:190) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize30(PartitionUpdate.java:657) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize(PartitionUpdate.java:645) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:344) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:353) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.service.MigrationManager$MigrationsSerializer.deserialize(MigrationManager.java:609) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.service.MigrationManager$MigrationsSerializer.deserialize(MigrationManager.java:592) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:98) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:201) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:178) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:92) ~[apache-cassandra-3.0.8.jar:3.0.8]
DEBUG [GossipStage:1] 2016-07-13 05:23:16,855 MigrationManager.java:101 - Submitting migration task &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /127.0.0.1
ERROR [MessagingService-Incoming-/127.0.0.1] 2016-07-13 05:23:17,383 CassandraDaemon.java:201 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MessagingService-Incoming-/127.0.0.1,5,main]
java.lang.RuntimeException: Unknown column cdc during deserialization
	at org.apache.cassandra.db.Columns$Serializer.deserialize(Columns.java:432) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.SerializationHeader$Serializer.deserializeForMessaging(SerializationHeader.java:427) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.deserializeHeader(UnfilteredRowIteratorSerializer.java:190) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize30(PartitionUpdate.java:657) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize(PartitionUpdate.java:645) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:344) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:353) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.service.MigrationManager$MigrationsSerializer.deserialize(MigrationManager.java:609) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.service.MigrationManager$MigrationsSerializer.deserialize(MigrationManager.java:592) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:98) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:201) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:178) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:92) ~[apache-cassandra-3.0.8.jar:3.0.8]
DEBUG [GossipStage:1] 2016-07-13 05:23:17,858 StorageService.java:1899 - Node /127.0.0.1 state NORMAL, token [-1378122049260494817, -1491944349266034000, -1622944791425543487, -2011387665415943034, -2604861794090361113, -2623806159584154975, -2661418387004022901, -3056348922832743393, -3634522926981587558, -3705545868347210901, -3908608253522012139, -4184197016100579239, -4304468738156574476, -5163962544200248432, -5186438155513518780, -7535126099082732347, -8462503993082472101, -846725360334075016, 1052501304817178098, 153582774376769981, 1608837061201738937, 2506254590874653594, 2760740065197146188, 2801316407811925741, 3971348542318844430, 4471389004257102104, 529149305350352167, 5848502616542491401, 7102558182178550651, 8145642075546410367, 8236331454292925125, 999899012538997580]
INFO  [GossipStage:1] 2016-07-13 05:23:17,858 StorageService.java:1902 - Node /127.0.0.1 state jump to NORMAL
DEBUG [PendingRangeCalculator:1] 2016-07-13 05:23:17,865 PendingRangeCalculatorService.java:66 - finished calculation &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 4 keyspaces in 0ms
DEBUG [GossipStage:1] 2016-07-13 05:23:17,865 MigrationManager.java:101 - Submitting migration task &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /127.0.0.1
ERROR [MessagingService-Incoming-/127.0.0.1] 2016-07-13 05:23:17,891 CassandraDaemon.java:201 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MessagingService-Incoming-/127.0.0.1,5,main]
java.lang.RuntimeException: Unknown column cdc during deserialization
	at org.apache.cassandra.db.Columns$Serializer.deserialize(Columns.java:432) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.SerializationHeader$Serializer.deserializeForMessaging(SerializationHeader.java:427) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.deserializeHeader(UnfilteredRowIteratorSerializer.java:190) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize30(PartitionUpdate.java:657) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize(PartitionUpdate.java:645) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:344) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:353) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.service.MigrationManager$MigrationsSerializer.deserialize(MigrationManager.java:609) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.service.MigrationManager$MigrationsSerializer.deserialize(MigrationManager.java:592) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:98) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:201) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:178) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:92) ~[apache-cassandra-3.0.8.jar:3.0.8]
DEBUG [MemtablePostFlush:1] 2016-07-13 05:23:22,991 ColumnFamilyStore.java:898 - forceFlush requested but everything is clean in test
DEBUG [SharedPool-Worker-1] 2016-07-13 05:23:22,993 ColumnFamilyStore.java:2015 - Discarding sstable data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; truncated CF + indexes
DEBUG [MemtablePostFlush:1] 2016-07-13 05:23:22,994 ColumnFamilyStore.java:898 - forceFlush requested but everything is clean in test
DEBUG [SharedPool-Worker-1] 2016-07-13 05:23:23,007 ColumnFamilyStore.java:845 - Enqueuing flush of local: 653 (0%) on-heap, 0 (0%) off-heap
DEBUG [MemtableFlushWriter:2] 2016-07-13 05:23:23,007 Memtable.java:353 - Writing Memtable-local@450968517(0.122KiB serialized bytes, 5 ops, 0%/0% of on/off-heap limit)
DEBUG [MemtableFlushWriter:2] 2016-07-13 05:23:23,010 Memtable.java:386 - Completed flushing /mnt/tmp/dtest-9TElyd/test/node2/data1/system/local-7ad54392bcdd35a684174e047860b377/mb-14-big-Data.db (0.086KiB) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commitlog position ReplayPosition(segmentId=1468387367914, position=56625)
ERROR [MessagingService-Incoming-/127.0.0.1] 2016-07-13 05:23:23,198 CassandraDaemon.java:201 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MessagingService-Incoming-/127.0.0.1,5,main]
java.lang.RuntimeException: Unknown column cdc during deserialization
	at org.apache.cassandra.db.Columns$Serializer.deserialize(Columns.java:432) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.SerializationHeader$Serializer.deserializeForMessaging(SerializationHeader.java:427) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.deserializeHeader(UnfilteredRowIteratorSerializer.java:190) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize30(PartitionUpdate.java:657) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.partitions.PartitionUpdate$PartitionUpdateSerializer.deserialize(PartitionUpdate.java:645) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:344) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.Mutation$MutationSerializer.deserialize(Mutation.java:353) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.service.MigrationManager$MigrationsSerializer.deserialize(MigrationManager.java:609) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.service.MigrationManager$MigrationsSerializer.deserialize(MigrationManager.java:592) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:98) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:201) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:178) ~[apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:92) ~[apache-cassandra-3.0.8.jar:3.0.8]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15382580" author="rhatch" created="Mon, 18 Jul 2016 16:51:54 +0000"  >&lt;p&gt;From what I understand this one is safe to ignore. See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12026&quot; title=&quot;update NEWS.txt to explain system schema exceptions during partial cluster upgrade&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12026&quot;&gt;&lt;del&gt;CASSANDRA-12026&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15382581" author="rhatch" created="Mon, 18 Jul 2016 16:52:44 +0000"  >&lt;p&gt;That is to say we should set the class up with an ignore pattern for this.&lt;/p&gt;</comment>
                            <comment id="15382675" author="philipthompson" created="Mon, 18 Jul 2016 17:37:27 +0000"  >&lt;p&gt;Okay, so then disregard my copy from the logs. This error is already ignored, meaning if it isn&apos;t causing the truncate to fail, there is a different problem.&lt;/p&gt;</comment>
                            <comment id="15382687" author="philipthompson" created="Mon, 18 Jul 2016 17:42:43 +0000"  >&lt;p&gt;I see node1 and node2 log &quot;blocking truncate operation&quot;, but not node3. I do see node3 &quot;discard sstable data for truncate&quot; though, so I&apos;m not really sure what is supposed to be happening on trunk here, and I think I need a dev to take a look.&lt;/p&gt;</comment>
                            <comment id="15384507" author="philipthompson" created="Tue, 19 Jul 2016 17:00:22 +0000"  >&lt;p&gt;This could just be &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12236&quot; title=&quot;RTE from new CDC column breaks in flight queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12236&quot;&gt;&lt;del&gt;CASSANDRA-12236&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15418023" author="thobbs" created="Thu, 11 Aug 2016 22:04:42 +0000"  >&lt;p&gt;I&apos;m looking into this since Sam&apos;s on vacation for another week and a half.&lt;/p&gt;</comment>
                            <comment id="15418039" author="thobbs" created="Thu, 11 Aug 2016 22:22:39 +0000"  >&lt;p&gt;It looks like the truncate &lt;em&gt;does&lt;/em&gt; happen successfully on all nodes, but the response from the upgraded node to the old node doesn&apos;t get through.  This appears to be caused by this schema change:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if is_upgraded:
    if self.get_node_version(is_upgraded) &amp;gt;= &apos;3.0&apos;:
        cursor.execute(&quot;CREATE INDEX ON test(m)&quot;)
    else:
        assert_invalid(cursor, &quot;CREATE INDEX on test(m)&quot;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When that schema change is removed, all of the truncates complete successfully.  I&apos;m guessing what happens is that the schema change in a mixed-version cluster puts the old node in a state where it doesn&apos;t correctly handle the truncate message from the upgraded node.  I&apos;ll look into this more, but it does seem like this is a case where we should adjust the test to not perform an unsupported operation (schema change in a mixed cluster) and expect everything to work correctly afterwards.&lt;/p&gt;</comment>
                            <comment id="15419578" author="thobbs" created="Fri, 12 Aug 2016 22:02:51 +0000"  >&lt;p&gt;Here&apos;s basically what&apos;s happening:&lt;/p&gt;

&lt;p&gt;The 3.x node tries to add an index while the cluster is half-upgraded.  This basically triggers the symptoms from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12236&quot; title=&quot;RTE from new CDC column breaks in flight queries.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12236&quot;&gt;&lt;del&gt;CASSANDRA-12236&lt;/del&gt;&lt;/a&gt; (a deserialization error on the 3.0.x node).  The 3.0.x node closes its end of the connection, but of course the 3.x node won&apos;t notice this until it tries to write on that connection again.  The truncate is the next thing that happens.  All nodes truncate successfully, but when the 3.x node tries to write its response, it gets a broken pipe error.  The truncate then times out on the coordinator.&lt;/p&gt;

&lt;p&gt;I&apos;ve opened a &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/1229&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest PR&lt;/a&gt; to remove the unnecessary schema change from the test.  However, there is one improvement we could make in C* to make these sorts of errors (which especially tend to happen during upgrades) less problematic.  We already have a mechanism for retrying messages once after reconnecting.  This is currently reserved for non-droppable verbs (like schema change messages, repair messages, etc).  It seems like retrying &lt;em&gt;all&lt;/em&gt; verbs once after reconnecting would be reasonable.  This approach would also fix the test.  I&apos;m not sure why non-droppable messages were omitted from this behavior in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5393&quot; title=&quot;Add retry mechanism to OTC for non-droppable_verbs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5393&quot;&gt;&lt;del&gt;CASSANDRA-5393&lt;/del&gt;&lt;/a&gt; (where the retry mech was created), so there might be some potential issues I&apos;m unaware of.&lt;/p&gt;

&lt;p&gt;Can anybody offer a reason why we shouldn&apos;t retry &lt;em&gt;all&lt;/em&gt; verbs after reconnecting?&lt;/p&gt;</comment>
                            <comment id="15424863" author="thobbs" created="Wed, 17 Aug 2016 16:40:44 +0000"  >&lt;p&gt;Since I haven&apos;t heard any concerns, here&apos;s a patch to retry &lt;em&gt;all&lt;/em&gt; messages when a MessagingService connection is closed and reopened:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-12192-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-12192-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-12192-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-12192-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Additionally, I&apos;ve added some extra debug logging around connections being opened, closed, and erroring out.  Some of these were previously at trace level, but I think they&apos;re infrequent enough and important enough to warrant being at debug level instead.&lt;/p&gt;</comment>
                            <comment id="15424933" author="yukim" created="Wed, 17 Aug 2016 17:13:13 +0000"  >&lt;p&gt;I don&apos;t know the reason behind &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5393&quot; title=&quot;Add retry mechanism to OTC for non-droppable_verbs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5393&quot;&gt;&lt;del&gt;CASSANDRA-5393&lt;/del&gt;&lt;/a&gt; not retrying for all (maybe because the scope of ticket was just for repair), but it looks like we can turn on retry to all messages as Tyler suggests. On trunk, we try to reconnect when writing to socket fails, and if we cannot reconnect we clear backlog so retrying message won&apos;t accumulate and be problematic.&lt;/p&gt;

&lt;p&gt;One nit: can you modify the comment &lt;a href=&quot;https://github.com/thobbs/cassandra/blob/6c46045ec5e22437b5493ee66851623b0bda1209/src/java/org/apache/cassandra/net/OutboundTcpConnection.java#L314-L315&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; to fit with your change?&lt;/p&gt;

&lt;p&gt;Let&apos;s see how tests go.&lt;/p&gt;</comment>
                            <comment id="15424962" author="thobbs" created="Wed, 17 Aug 2016 17:24:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;One nit: can you modify the comment here to fit with your change?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;ve pushed a second commit to update this, thanks.&lt;/p&gt;</comment>
                            <comment id="15435645" author="thobbs" created="Wed, 24 Aug 2016 20:44:34 +0000"  >&lt;p&gt;The dtest run was good.  I&apos;ve merged in trunk and restarted the testall runs.  Assuming those look good as well, are you +1 on this committing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15435656" author="yukim" created="Wed, 24 Aug 2016 20:49:35 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15435857" author="thobbs" created="Wed, 24 Aug 2016 22:32:53 +0000"  >&lt;p&gt;The testall results also look good (eclipse-warnings were the only failures). Committed to trunk as &lt;tt&gt;c26bd91852cbf19d7dba9f62078f5da31b04dbe0&lt;/tt&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12817710" name="node1.log" size="80458" author="sean.mccarthy" created="Wed, 13 Jul 2016 16:15:36 +0000"/>
                            <attachment id="12817708" name="node1_debug.log" size="467582" author="sean.mccarthy" created="Wed, 13 Jul 2016 16:15:36 +0000"/>
                            <attachment id="12817709" name="node1_gc.log" size="24732" author="sean.mccarthy" created="Wed, 13 Jul 2016 16:15:36 +0000"/>
                            <attachment id="12817713" name="node2.log" size="48802" author="sean.mccarthy" created="Wed, 13 Jul 2016 16:15:36 +0000"/>
                            <attachment id="12817711" name="node2_debug.log" size="199839" author="sean.mccarthy" created="Wed, 13 Jul 2016 16:15:36 +0000"/>
                            <attachment id="12817712" name="node2_gc.log" size="20860" author="sean.mccarthy" created="Wed, 13 Jul 2016 16:15:36 +0000"/>
                            <attachment id="12817716" name="node3.log" size="52734" author="sean.mccarthy" created="Wed, 13 Jul 2016 16:15:36 +0000"/>
                            <attachment id="12817714" name="node3_debug.log" size="204761" author="sean.mccarthy" created="Wed, 13 Jul 2016 16:15:36 +0000"/>
                            <attachment id="12817715" name="node3_gc.log" size="20251" author="sean.mccarthy" created="Wed, 13 Jul 2016 16:15:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i30xd3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>