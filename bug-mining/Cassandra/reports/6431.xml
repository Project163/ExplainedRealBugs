<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:29:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19336] Repair causes out of memory</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19336</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14096&quot; title=&quot;Cassandra 3.11.1 Repair Causes Out of Memory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14096&quot;&gt;&lt;del&gt;CASSANDRA-14096&lt;/del&gt;&lt;/a&gt; introduced &lt;tt&gt;repair_session_space&lt;/tt&gt; as a limit for the memory usage for Merkle tree calculations during repairs. This limit is applied to the set of Merkle trees built for a received validation request (&lt;tt&gt;VALIDATION_REQ&lt;/tt&gt;), divided by the replication factor so as not to overwhelm the repair coordinator, who will have requested RF sets of Merkle trees. That way the repair coordinator should only use &lt;tt&gt;repair_session_space&lt;/tt&gt; for the RF Merkle trees.&lt;/p&gt;

&lt;p&gt;However, a repair session without &lt;tt&gt;&lt;del&gt;pr&lt;/del&gt;&lt;/tt&gt;/&lt;tt&gt;-partitioner-range&lt;/tt&gt; will send RF*RF validation requests, because the repair coordinator node has RF-1 replicas and is also the replica of RF-1 nodes. Since all the requests are sent at the same time, at some point the repair coordinator can have up to RF*&lt;tt&gt;repair_session_space&lt;/tt&gt; worth of Merkle trees if none of the validation responses is fully processed before the last response arrives.&lt;/p&gt;

&lt;p&gt;Even worse, if the cluster uses virtual nodes, many nodes can be replicas of the repair coordinator, and some nodes can be replicas of multiple token ranges. It would mean that the repair coordinator can send more than RF or RF*RF simultaneous validation requests.&lt;/p&gt;

&lt;p&gt;For example, in an 11-node cluster with RF=3 and 256 tokens, we have seen a repair session involving 44 groups of ranges to be repaired. This produces 44*3=132 validation requests contacting all the nodes in the cluster. When the responses for all these requests start to arrive to the coordinator, each containing up to &lt;tt&gt;repair_session_space&lt;/tt&gt;/3 of Merkle trees, they accumulate quicker than they are consumed, greatly exceeding &lt;tt&gt;repair_session_space&lt;/tt&gt; and OOMing the node.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13566522">CASSANDRA-19336</key>
            <summary>Repair causes out of memory</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="adelapena">Andres de la Pe&#241;a</assignee>
                                    <reporter username="adelapena">Andres de la Pe&#241;a</reporter>
                        <labels>
                    </labels>
                <created>Mon, 29 Jan 2024 13:45:59 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:58 +0000</updated>
                            <resolved>Thu, 8 Feb 2024 11:46:17 +0000</resolved>
                                        <fixVersion>4.0.13</fixVersion>
                    <fixVersion>4.1.5</fixVersion>
                    <fixVersion>5.0-rc1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Consistency/Repair</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17811890" author="adelapena" created="Mon, 29 Jan 2024 13:59:19 +0000"  >&lt;p&gt;A possible approach to prevent this could be for the repair coordinator to issue the validation requests sequentially, waiting for one to be finished before sending the next one. That would guarantee that the repair coordinator doesn&#8217;t exceed &lt;tt&gt;repair_session_space&lt;/tt&gt; independently of the number of requests. However, since more vnodes involve more requests and less validated data per request, we might be asking for too big trees and giving too much work to the cluster. This, I think, would be a problem for scalability.&lt;/p&gt;

&lt;p&gt;Alternatively, we could move the decision about the size of the Merkle trees to the repair coordinator, who knows how many requests we will need. This way, the coordinator could request smaller Merkle trees if it&apos;s sending many requests for small ranges, so they are small enough to don&#8217;t OOM itself when the responses come back. I understand that if we send many validation requests then the token ranges for those requests represent fewer data per request, and it makes sense to make the Merkle trees proportionally smaller to get the same resolution.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=molsson&quot; class=&quot;user-hover&quot; rel=&quot;molsson&quot;&gt;molsson&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt; wdyt?&lt;/p&gt;</comment>
                            <comment id="17811998" author="dcapwell" created="Mon, 29 Jan 2024 17:45:43 +0000"  >&lt;blockquote&gt;&lt;p&gt;A possible approach to prevent this could be for the repair coordinator to issue the validation requests sequentially&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We support this right now, this is defined in org.apache.cassandra.repair.RepairParallelism.  If you use PARALLEL then we must validate concurrently, so in the case you defined you want SEQUENTIAL or DATACENTER_AWARE.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnlwsu&quot; class=&quot;user-hover&quot; rel=&quot;cnlwsu&quot;&gt;cnlwsu&lt;/a&gt; and I talked about this a long time ago, but didn&apos;t have the time/bandwidth to do; the repair coordinator has enough information to &quot;guess&quot; that the range is too large and can choose to split it.  We can also sequence RepairSession in the case there are many to avoid this problem (2 different, but related solutions).&lt;/p&gt;

&lt;p&gt;So, if we see that a range is really large and likely to OOM we can split it into multiple RepairSessions rather than a single one.  This doesn&apos;t solve anything as RepairSessions are concurrent, so we would also need to batch / limit RepairSessions for this to have the full impact.&lt;/p&gt;

&lt;p&gt;With the first part we solve the case where a single range OOMs, and the second one solves the case multiple concurrent ranges OOM.&lt;/p&gt;

&lt;p&gt;At the moment the repair coordinator doesn&apos;t know about other repair coordinators, but that information is a quick lookup in-memory so we could discover if we are running multiple repairs, so we could also handle this case if it spans multiple repairs rather than a single one...&lt;/p&gt;</comment>
                            <comment id="17812043" author="adelapena" created="Mon, 29 Jan 2024 20:21:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;A possible approach to prevent this could be for the repair coordinator to issue the validation requests sequentially&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;We support this right now, this is defined in org.apache.cassandra.repair.RepairParallelism. If you use PARALLEL then we must validate concurrently, so in the case you defined you want SEQUENTIAL or DATACENTER_AWARE.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I meant that we could make all the sessions for the same command sequential, not only the requests within a session. I understand &lt;tt&gt;SEQUENTIAL&lt;/tt&gt; only makes the RF requests within a session sequential, and it still has to retain them for computing the diff. However, a repair command can start multiple sessions, and those are not sequential. Without vnodes nor the &lt;tt&gt;--primary-ranges&lt;/tt&gt; flag we will have RF sessions sending requests concurrently. In the mentioned example using 11 nodes and 256 vnodes we have 44 repair sessions started by the same repair command. By the time we get the first response with &lt;tt&gt;SEQUENTIAL&lt;/tt&gt;, we will have already sent the first 44 requests.&lt;/p&gt;</comment>
                            <comment id="17812479" author="adelapena" created="Tue, 30 Jan 2024 21:06:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Here&lt;/a&gt; is a simple patch that runs all the repair jobs for a repair operation in &lt;tt&gt;&lt;del&gt;j&lt;/tt&gt;/&lt;tt&gt;&lt;/del&gt;-job-threads&lt;/tt&gt; sequences. That way, each thread (defaults to 1 thread) should be guaranteed not to exceed the configured &lt;tt&gt;repair_session_space&lt;/tt&gt; limit.&lt;/p&gt;

&lt;p&gt;Without the patch, the &lt;tt&gt;repair_session_space&lt;/tt&gt; limit can be exceeded by repairs involving multiple subranges (vnodes), and/or by repairs involving multiple tables. I think there isn&apos;t much we can do for the case with multiple tables besides repairing the tables sequentially. For the case with multiple smaller subranges, an additional follow-up improvement could be reducing the size of the Merkle trees for each range since they cover fewer data and let them run in parallel.&lt;/p&gt;</comment>
                            <comment id="17812482" author="brandon.williams" created="Tue, 30 Jan 2024 21:14:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think there isn&apos;t much we can do for the case with multiple tables besides repairing the tables sequentially.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Indeed, I think that&apos;s where &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17787&quot; title=&quot;Full repair on a keyspace with a large amount of tables causes OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17787&quot;&gt;&lt;del&gt;CASSANDRA-17787&lt;/del&gt;&lt;/a&gt; landed too.&lt;/p&gt;</comment>
                            <comment id="17812672" author="adelapena" created="Wed, 31 Jan 2024 11:38:06 +0000"  >&lt;p&gt;Oh, I wasn&apos;t aware of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17787&quot; title=&quot;Full repair on a keyspace with a large amount of tables causes OOM&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17787&quot;&gt;&lt;del&gt;CASSANDRA-17787&lt;/del&gt;&lt;/a&gt;. This one was originally focused on similar OOM issues with multiple common ranges being repaired at the same time, but the sequencing done by the patch deals with multiple tables too.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if the behaviour proposed by the patch should be done in all cases or if it should depend on a n optional flag. Allowing the number of concurrent repair jobs to exceed &lt;tt&gt;repair_session_space&lt;/tt&gt; depending on cluster topology seems wrong, especially when we can hit OOMs when the cluster gets larger. Also, &lt;tt&gt;--job-threads&lt;/tt&gt;&#160;allows users to manually get around &lt;tt&gt;repair_session_space&lt;/tt&gt; and sequential execution to get some parallelization, so I guess it makes sense not to add more flags.&lt;/p&gt;

&lt;p&gt;By the way, here is CI for the above patch:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;PR&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3408/workflows/417096cc-570b-4fb5-b467-08e087c41395&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3408/workflows/273c21bf-42d3-4812-b3f6-d2da64fd5f9a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17812818" author="dcapwell" created="Wed, 31 Jan 2024 17:31:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure if the behaviour proposed by the patch should be done in all cases or if it should depend on a n optional flag&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it should be a new flag, but cool with yaml defining a default (as this is really a cluster problem rather than a single repair problem).&lt;/p&gt;

&lt;p&gt;Skimmed the patch quickly and this will cause a large performance regression for many users; threads is normally &quot;1&quot; (for this patch that means 1 RepairJob at a time).  This also just tries to limit the RepairJob but not RepairSession, so it might make more sense to have a higher level scheduling....  we really don&apos;t want to wait on RepairJob as streaming can take a long time, we really just want to wait on Validation, so block concurrent validations.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; I am cool with the general direction of this patch, but think we should make 2 changes&lt;/p&gt;

&lt;p&gt;1) RepairCoordinator should have a &quot;scheduler&quot; to limit RepairJob concurrency (really Validation).&lt;br/&gt;
2) this &quot;scheduler&quot; should be configurable: disabled (do existing behavior), max validations (limits concurrent validations), etc.  &lt;/p&gt;

&lt;p&gt;I am super flexible here, not saying you must do my design... just more that the problem is higher up than RepairSession trying to handle.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think there isn&apos;t much we can do for the case with multiple tables besides repairing the tables sequentially.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Nah, I think we can limit the concurrent validations rather than forcing all tables to be sequential.  If we cause a perf regression for &quot;nodetool repair ks&quot; then users will just be forced to work around it by creating a coordinator per table (which is a undocumented best practice...), at which point solving this problem gets harder as you have multiple RepairCoordinators rather than a single one...&lt;/p&gt;</comment>
                            <comment id="17812834" author="dcapwell" created="Wed, 31 Jan 2024 18:22:30 +0000"  >&lt;p&gt;I did a quick POC of what I am saying with a scheduler...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;interface&lt;/span&gt; Scheduler
    {

        void scheduleValidation(TimeUUID sessionId, ValidationTask task, Executor taskExecutor);
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;NoopScheduler &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Scheduler
    {
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void scheduleValidation(TimeUUID sessionId, ValidationTask task, Executor taskExecutor)
        {
            taskExecutor.execute(task);
        }
    }

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LimitedConcurrentScheduler &lt;span class=&quot;code-keyword&quot;&gt;implements&lt;/span&gt; Scheduler
    {
        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; concurrentValidations = 1;
        @GuardedBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;&quot;&lt;/span&gt;)
        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; inflight = 0;
        @GuardedBy(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;&quot;&lt;/span&gt;)
        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Map&amp;lt;TimeUUID, Group&amp;gt; groups = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();

        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void scheduleValidation(TimeUUID sessionId, ValidationTask task, Executor taskExecutor)
        {
            groups.computeIfAbsent(sessionId, ignore -&amp;gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Group(sessionId, taskExecutor)).add(task);
            maybeSchedule();
        }

        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;synchronized&lt;/span&gt; void onDone(Group group, ValidationTask task, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; durationNs)
        {
            group.update(durationNs);
            inflight--;
            maybeSchedule();
        }

        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void maybeSchedule()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (inflight == concurrentValidations)
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
            Group smallest = &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; smallestScore = -1;
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; g : groups.values())
            {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (g.isEmpty())
                    &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smallest == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                {
                    smallest = g;
                    smallestScore = g.score();
                }
                &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                {
                    &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; score = g.score();
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (score &amp;lt; smallestScore)
                    {
                        smallest = g;
                        smallestScore = score;
                    }
                }
            }
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (smallest == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
            inflight++;
            smallest.executeNext();
        }

        &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Group
        {
            &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; TimeUUID sessionId;
            &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Executor taskExecutor;
            &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; List&amp;lt;ValidationTask&amp;gt; tasks = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ArrayList&amp;lt;&amp;gt;();
            &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; LongArrayList durations = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; LongArrayList();
            &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; inflight = 0;
            &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; completed = 0;

            &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; Group(TimeUUID sessionId, Executor taskExecutor)
            {
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.sessionId = sessionId;
                &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.taskExecutor = taskExecutor;
            }

            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; score()
            {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (tasks.isEmpty())
                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; -1;
                &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; avgDuration = (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) durations.longStream().average().orElse(TimeUnit.HOURS.toNanos(1));
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; tasks.size() * avgDuration;
            }

            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void executeNext()
            {
                &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; task = tasks.get(0);
                tasks.remove(0);
                inflight++;
                &lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt; startNs = ctx.clock().nanoTime();
                task.addCallback((s, f) -&amp;gt; onDone(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, task, ctx.clock().nanoTime() - startNs));
                taskExecutor.execute(task);
            }

            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void add(ValidationTask task)
            {
                tasks.add(task);
            }

            &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void update(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; durationNs)
            {
                durations.add(durationNs);
                inflight--;
                completed++;
            }

            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isEmpty()
            {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; tasks.isEmpty();
            }

            @Override
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; toString()
            {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;Group{&quot;&lt;/span&gt; +
                       &lt;span class=&quot;code-quote&quot;&gt;&quot;sessionId=&quot;&lt;/span&gt; + sessionId +
                       &lt;span class=&quot;code-quote&quot;&gt;&quot;, tasks=&quot;&lt;/span&gt; + tasks.size() +
                       &lt;span class=&quot;code-quote&quot;&gt;&quot;, durations=&quot;&lt;/span&gt; + durations.longStream().average().orElse(-1) +
                       &lt;span class=&quot;code-quote&quot;&gt;&quot;, score=&quot;&lt;/span&gt; + score() +
                       &lt;span class=&quot;code-quote&quot;&gt;&quot;, inflight=&quot;&lt;/span&gt; + inflight +
                       &lt;span class=&quot;code-quote&quot;&gt;&quot;, completed=&quot;&lt;/span&gt; + completed +
                       &lt;span class=&quot;code-quote&quot;&gt;&apos;}&apos;&lt;/span&gt;;
            }
        }
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I added that to RepairCoordinator and changed CassandraRepairJob to be&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
session.scheduler.scheduleValidation(session.state.id, task, taskExecutor);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;rather than&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
taskExecutor.execute(task);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;The existing simulation tests are passing and I see that we limit to 1 concurrent validation for the whole repair...  this allows concurrent streaming / snapshot / paxos / etc., but limits validation.&lt;/p&gt;
</comment>
                            <comment id="17813308" author="adelapena" created="Thu, 1 Feb 2024 15:22:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; Thanks for the feedback. Limiting the parallelism of only the validation phase with a scheduler like the proposed one makes sense to me.&lt;/p&gt;

&lt;p&gt;The scheduler only allows one simultaneous &lt;tt&gt;ValidationTask&lt;/tt&gt; per repair coordinator. However, the Merkle trees in each &lt;tt&gt;ValidationTask&lt;/tt&gt; use &lt;tt&gt;repair_session_space&lt;/tt&gt;/RF each, not the entire &lt;tt&gt;repair_session_space&lt;/tt&gt;. That&apos;s because we need to keep the results of RF tasks in memory in order to merge them. Thus, I think we should have RF simultaneous validation tasks. Also, the RF validation tasks of a repair job should be scheduled together so we can merge them as soon as possible.&lt;/p&gt;

&lt;p&gt;Also, finishing a &lt;tt&gt;ValidationTask&lt;/tt&gt; doesn&apos;t immediately free its Merkle trees. That&apos;s not done until the RF tasks are merged by &lt;tt&gt;RepairJob#createStandardSyncTasks&lt;/tt&gt;. So, I think that the scheduler should schedule the entire process of running and finishing the RF validation tasks, merge them and possibly create the sync tasks (without waiting for them).&lt;/p&gt;

&lt;p&gt;If it sounds good, I&apos;ll create a patch for this.&lt;/p&gt;</comment>
                            <comment id="17813378" author="adelapena" created="Thu, 1 Feb 2024 18:35:02 +0000"  >&lt;p&gt;POC here:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;PR&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3410/workflows/4732b34a-618c-4ec5-aa08-559417afb04d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3410/workflows/8f40c455-8fe0-463d-a44f-d2e78253546a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I still have to add the config property, tidy up, etc.&lt;/p&gt;</comment>
                            <comment id="17814404" author="adelapena" created="Mon, 5 Feb 2024 15:32:26 +0000"  >&lt;p&gt;I have added a&#160;new &lt;tt&gt;concurrent_merkle_tree_requests&lt;/tt&gt; config property to the PR. This property controls the parallelism of the scheduler. It defaults to unbounded parallelism so it keeps the previous behaviour. I think the recommended value should be one without vnodes. Without vnodes it could either be one too, or something higher if combined with a smaller &lt;tt&gt;repair_session_space&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;CI looks good; the only failure is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19168&quot; title=&quot;Test Failure: VectorUpdateDeleteTest fails with heap_buffers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19168&quot;&gt;&lt;del&gt;CASSANDRA-19168&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;PR&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3411/workflows/bff8cab0-6dff-423c-af95-c7f70fb9a887&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3411/workflows/1c6b2337-0db7-4de2-81e3-4a6eccb70204&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17814458" author="dcapwell" created="Mon, 5 Feb 2024 17:56:42 +0000"  >&lt;p&gt;taking a look at the patch now&lt;/p&gt;</comment>
                            <comment id="17814468" author="dcapwell" created="Mon, 5 Feb 2024 18:19:41 +0000"  >&lt;p&gt;Overall LGTM.  I am +1 but have some comments that ill leave to you if you wish to handle or not&lt;/p&gt;

&lt;p&gt;1) scheduler should return a Future rather than pushing this to the caller... cleans up the calling code a bit&lt;br/&gt;
2) given you have a single task per session, can use a simpler data structure to track/limit... the current one works best when we have multiple tasks and can try to compare cross session.&lt;/p&gt;</comment>
                            <comment id="17814923" author="adelapena" created="Tue, 6 Feb 2024 17:55:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; Thanks for the review. I have tried to address the review comments.&lt;/p&gt;

&lt;p&gt;I have also added a dtest to verify that the max number of Merkle tree requests is never greater than RF*&lt;tt&gt;concurrent_merkle_tree_requests&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Here is CI:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;PR&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3417/workflows/9a3ef50e-1616-4bca-b9f9-275eb1ddf5fa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3417/workflows/43c45c1b-7fa8-48e6-9137-1ed52594b03d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I&apos;m still wondering if&#160;the default value for &lt;tt&gt;concurrent_merkle_tree_requests&lt;/tt&gt; should be one. That would change the previous behaviour possibly making some repairs slower. But the previous behaviour was OOM-prone, and the fix will be opt-in if we leave it unlimited.&lt;/p&gt;</comment>
                            <comment id="17815042" author="adelapena" created="Wed, 7 Feb 2024 00:33:32 +0000"  >&lt;p&gt;Patches for all the branches:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Patch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-4.0...adelapena:19336-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3423/workflows/6dd2bc40-d663-4c38-96d2-1a9d98b531da&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3423/workflows/d6255d7f-a238-4eb6-93f1-fe373ad567c5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-4.1...adelapena:19336-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3424/workflows/7e153df1-c7c3-453d-9003-e1cacaf0d9fb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3424/workflows/68503730-3744-4d65-8484-658711d01bf6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3417/workflows/9a3ef50e-1616-4bca-b9f9-275eb1ddf5fa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3417/workflows/43c45c1b-7fa8-48e6-9137-1ed52594b03d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:19336-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3425/workflows/0a657cb6-f749-4caa-97cd-ed6660736313&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3425/workflows/3c827700-b4a9-4860-94a9-a641dd06dfe1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Only the patch for 4.0 is slightly different due to the differences in the &lt;tt&gt;concurrent&lt;/tt&gt; package.&lt;/p&gt;</comment>
                            <comment id="17815259" author="adelapena" created="Wed, 7 Feb 2024 11:48:52 +0000"  >&lt;p&gt;The CI results above look good to me:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;MemtableSizeTest.testTruncationReleasesLogSpace&lt;/tt&gt; in 4.0 is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17298&quot; title=&quot;Improve accuracy of memtable heap usage tracking&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17298&quot;&gt;&lt;del&gt;CASSANDRA-17298&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;RepairJobTest.testNoTreesRetainedAfterDifference&lt;/tt&gt; in 4.0 is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17884&quot; title=&quot;[jamm] Test failure: o.a.c.repair.RepairJobTest.testNoTreesRetainedAfterDifference&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17884&quot;&gt;CASSANDRA-17884&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;JMXFeatureTest.testOneNetworkInterfaceProvisioning&lt;/tt&gt; in 4.1 is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19261&quot; title=&quot;Test failure: org.apache.cassandra.distributed.test.jmx.JMXFeatureTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19261&quot;&gt;CASSANDRA-19261&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;MemtableSizeTest.testSize&lt;span class=&quot;error&quot;&gt;&amp;#91;skiplist&amp;#93;&lt;/span&gt;&lt;/tt&gt; in 4.1 is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17298&quot; title=&quot;Improve accuracy of memtable heap usage tracking&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17298&quot;&gt;&lt;del&gt;CASSANDRA-17298&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;VectorUpdateDeleteTest.updateTest&lt;/tt&gt; in 5.0 and trunk is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19168&quot; title=&quot;Test Failure: VectorUpdateDeleteTest fails with heap_buffers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19168&quot;&gt;&lt;del&gt;CASSANDRA-19168&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;CompactionStrategyManagerTest.testAutomaticUpgradeConcurrency&lt;/tt&gt; in trunk is unreported, but it can be &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3427/workflows/126307ce-d465-4736-a71e-82e0b8749598/jobs/103861/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;reproduced on the base branch&lt;/a&gt;. I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19376&quot; title=&quot;CompactionStrategyManagerTest.testAutomaticUpgradeConcurrency is flaky&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19376&quot;&gt;CASSANDRA-19376&lt;/a&gt; for it.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;HarrySimulatorTest&lt;/tt&gt; in trunk is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19279&quot; title=&quot;Test Failure: org.apache.cassandra.simulator.test.HarrySimulatorTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19279&quot;&gt;&lt;del&gt;CASSANDRA-19279&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;InJVMTokenAwareExecutorTest.testRepair&lt;/tt&gt; in trunk is a timeout seen on &lt;a href=&quot;https://butler.cassandra.apache.org/#/ci/upstream/compare/Cassandra-trunk/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Butler&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;ConcurrentQuiescentCheckerIntegrationTest.testConcurrentReadWriteWorkload&lt;/tt&gt; in trunk is on &lt;a href=&quot;https://butler.cassandra.apache.org/#/ci/upstream/compare/Cassandra-trunk/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Butler&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;NativeTransportEncryptionOptionsTest.optionalTlsConnectionAllowedToRegularPortTest&lt;/tt&gt; in trunk is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19239&quot; title=&quot;jvm-dtests crash on java 17&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19239&quot;&gt;CASSANDRA-19239&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;NativeTransportEncryptionOptionsTest.testOptionalMtlsModeDoNotAllowNonSSLConnections&lt;/tt&gt; in trunk is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19239&quot; title=&quot;jvm-dtests crash on java 17&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19239&quot;&gt;CASSANDRA-19239&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;ConsistentBootstrapTest.coordinatorIsBehindTest&lt;/tt&gt; in trunk is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19343&quot; title=&quot;Test Failure: org.apache.cassandra.fuzz.ring.ConsistentBootstrapTest.coordinatorIsBehindTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19343&quot;&gt;&lt;del&gt;CASSANDRA-19343&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17815652" author="adelapena" created="Thu, 8 Feb 2024 11:44:43 +0000"  >&lt;p&gt;Committed to 4.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/505f5af645c1712c3da42d98d005276396ff2667&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;505f5af645c1712c3da42d98d005276396ff2667&lt;/a&gt; and merged to &lt;a href=&quot;https://github.com/apache/cassandra/commit/89a8155916ff7f94db9436de3f096aa22e047e35&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra/commit/5b9321eee1552a519fbefc2e07be2da8a3a9c20a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/commit/aa3ee3c7f12ab89f8590d1366135afc65c042095&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Thanks for the review.&lt;/p&gt;</comment>
                            <comment id="17819427" author="manmagic3" created="Thu, 22 Feb 2024 00:49:10 +0000"  >&lt;p&gt;Fix Version should be 4.0.13 and probably 4.1.5.&lt;/p&gt;</comment>
                            <comment id="17820818" author="JIRAUSER308715" created="Mon, 26 Feb 2024 18:56:49 +0000"  >&lt;p&gt;You are correct. This was not included in 4.0.12/4.1.5. &#160;Looks like the &quot;latest versions&quot; in JIRA were not updated after the last release.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13474272">CASSANDRA-17787</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13122803">CASSANDRA-14096</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13474272">CASSANDRA-17787</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310760">
                    <name>Testing</name>
                                            <outwardlinks description="Testing discovered">
                                        <issuelink>
            <issuekey id="13567733">CASSANDRA-19376</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12993" cascade-level="1"><![CDATA[Cluster Crash]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 37 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1n2bk:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12344930">3.0.19</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/505f5af645c1712c3da42d98d005276396ff2667&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/505f5af645c1712c3da42d98d005276396ff2667&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Patch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-4.0...adelapena:19336-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3423/workflows/6dd2bc40-d663-4c38-96d2-1a9d98b531da&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3423/workflows/d6255d7f-a238-4eb6-93f1-fe373ad567c5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-4.1...adelapena:19336-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3424/workflows/7e153df1-c7c3-453d-9003-e1cacaf0d9fb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3424/workflows/68503730-3744-4d65-8484-658711d01bf6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3073&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3417/workflows/9a3ef50e-1616-4bca-b9f9-275eb1ddf5fa&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3417/workflows/43c45c1b-7fa8-48e6-9137-1ed52594b03d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...adelapena:19336-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3425/workflows/0a657cb6-f749-4caa-97cd-ed6660736313&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/3425/workflows/3c827700-b4a9-4860-94a9-a641dd06dfe1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j17&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>