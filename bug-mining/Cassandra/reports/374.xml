<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:13:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-1221] loadbalance operation never completes on a 3 node cluster</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-1221</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Arya Goudarzi reports:&lt;/p&gt;

&lt;p&gt;Please confirm if this is an issue and should be reported or I am doing something wrong. I could not find anything relevant on JIRA:&lt;/p&gt;

&lt;p&gt;Playing with 0.7 nightly (today&apos;s build), I setup a 3 node cluster this way:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Added one node;&lt;/li&gt;
	&lt;li&gt;Loaded default schema with RF 1 from YAML using JMX;&lt;/li&gt;
	&lt;li&gt;Loaded 2M keys using py_stress;&lt;/li&gt;
	&lt;li&gt;Bootstrapped a second node;&lt;/li&gt;
	&lt;li&gt;Cleaned up the first node;&lt;/li&gt;
	&lt;li&gt;Bootstrapped a third node;&lt;/li&gt;
	&lt;li&gt;Cleaned up the second node;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I got the following ring:&lt;/p&gt;

&lt;p&gt;Address       Status     Load          Range                                      Ring&lt;br/&gt;
                                      154293670372423273273390365393543806425&lt;br/&gt;
10.50.26.132  Up         518.63 MB     69164917636305877859094619660693892452     |&amp;lt;--|&lt;br/&gt;
10.50.26.134  Up         234.8 MB      111685517405103688771527967027648896391    |   |&lt;br/&gt;
10.50.26.133  Up         235.26 MB     154293670372423273273390365393543806425    |--&amp;gt;|&lt;/p&gt;

&lt;p&gt;Now I ran:&lt;/p&gt;

&lt;p&gt;nodetool --host 10.50.26.132 loadbalance&lt;/p&gt;

&lt;p&gt;It&apos;s been going for a while. I checked the streams&lt;/p&gt;

&lt;p&gt;nodetool --host 10.50.26.134 streams&lt;br/&gt;
Mode: Normal&lt;br/&gt;
Not sending any streams.&lt;br/&gt;
Streaming from: /10.50.26.132&lt;br/&gt;
  Keyspace1: /var/lib/cassandra/data/Keyspace1/Standard1-tmp-d-3-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,22206096), (22206096,27271682)&amp;#93;&lt;/span&gt;&lt;br/&gt;
  Keyspace1: /var/lib/cassandra/data/Keyspace1/Standard1-tmp-d-4-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,15180462), (15180462,18656982)&amp;#93;&lt;/span&gt;&lt;br/&gt;
  Keyspace1: /var/lib/cassandra/data/Keyspace1/Standard1-tmp-d-5-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,353139829), (353139829,433883659)&amp;#93;&lt;/span&gt;&lt;br/&gt;
  Keyspace1: /var/lib/cassandra/data/Keyspace1/Standard1-tmp-d-6-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,366336059), (366336059,450095320)&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;nodetool --host 10.50.26.132 streams&lt;br/&gt;
Mode: Leaving: streaming data to other nodes&lt;br/&gt;
Streaming to: /10.50.26.134&lt;br/&gt;
  /var/lib/cassandra/data/Keyspace1/Standard1-d-48-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,366336059), (366336059,450095320)&amp;#93;&lt;/span&gt;&lt;br/&gt;
Not receiving any streams.&lt;/p&gt;

&lt;p&gt;These have been going for the past 2 hours.&lt;/p&gt;

&lt;p&gt;I see in the logs of the node with 134 IP address and I saw this:&lt;/p&gt;

&lt;p&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;GOSSIP_STAGE:1&amp;#93;&lt;/span&gt; 2010-06-22 16:30:54,679 StorageService.java (line 603) Will not change my token ownership to /10.50.26.132&lt;/p&gt;

&lt;p&gt;So, to my understanding from wikis loadbalance supposed to decommission and re-bootstrap again by sending its tokens to other nodes and then bootstrap again. It&apos;s been stuck in streaming for the past 2 hours and the size of ring has not changed. The log in the first node says it has started streaming for the past hours:&lt;/p&gt;

&lt;p&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-22 16:35:56,255 StreamOut.java (line 72) Beginning transfer process to /10.50.26.134 for ranges (154293670372423273273390365393543806425,69164917636305877859094619660693892452]&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-22 16:35:56,255 StreamOut.java (line 82) Flushing memtables for Keyspace1...&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-22 16:35:56,266 StreamOut.java (line 128) Stream context metadata [/var/lib/cassandra/data/Keyspace1/Standard1-d-48-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,366336059), (366336059,450095320)&amp;#93;&lt;/span&gt;] 1 sstables.&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-22 16:35:56,267 StreamOut.java (line 135) Sending a stream initiate message to /10.50.26.134 ...&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-06-22 16:35:56,267 StreamOut.java (line 140) Waiting for transfer to /10.50.26.134 to complete&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FLUSH-TIMER&amp;#93;&lt;/span&gt; 2010-06-22 17:36:53,370 ColumnFamilyStore.java (line 359) LocationInfo has reached its threshold; switching in a fresh Memtable at CommitLogContext(file=&apos;/var/lib/cassandra/commitlog/CommitLog-1277249454413.log&apos;, position=720)&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FLUSH-TIMER&amp;#93;&lt;/span&gt; 2010-06-22 17:36:53,370 ColumnFamilyStore.java (line 622) Enqueuing flush of Memtable(LocationInfo)@1637794189&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FLUSH-WRITER-POOL:1&amp;#93;&lt;/span&gt; 2010-06-22 17:36:53,370 Memtable.java (line 149) Writing Memtable(LocationInfo)@1637794189&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FLUSH-WRITER-POOL:1&amp;#93;&lt;/span&gt; 2010-06-22 17:36:53,528 Memtable.java (line 163) Completed flushing /var/lib/cassandra/data/system/LocationInfo-d-9-Data.db&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;MEMTABLE-POST-FLUSHER:1&amp;#93;&lt;/span&gt; 2010-06-22 17:36:53,529 ColumnFamilyStore.java (line 374) Discarding 1000&lt;/p&gt;


&lt;p&gt;Nothing more after this line.&lt;/p&gt;

&lt;p&gt;Am I doing something wrong?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12467688">CASSANDRA-1221</key>
            <summary>loadbalance operation never completes on a 3 node cluster</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gdusbabek">Gary Dusbabek</assignee>
                                    <reporter username="gdusbabek">Gary Dusbabek</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Jun 2010 12:39:42 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:21 +0000</updated>
                            <resolved>Tue, 20 Jul 2010 17:12:36 +0000</resolved>
                                        <fixVersion>0.6.4</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="12888116" author="arya" created="Wed, 14 Jul 2010 00:05:00 +0000"  >&lt;p&gt;Hi Gary,&lt;/p&gt;

&lt;p&gt;I was able to reproduce this using today&apos;s nightly build. This time i used a smaller data set (500000 keys) and I got the following:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test3 scripts&amp;#93;&lt;/span&gt;$ nodetool --host 10.50.26.132 ring   &lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       160348796167900510561059505917619274541    &lt;br/&gt;
10.50.26.134    Up     Normal  116.98 MB       32717880524093094169411234083126184860      &lt;br/&gt;
10.50.26.132    Up     Leaving 58.58 MB        75101027859180840627831025901565139619      &lt;br/&gt;
10.50.26.133    Up     Normal  117.09 MB       160348796167900510561059505917619274541    &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test3 scripts&amp;#93;&lt;/span&gt;$ nodetool --host 10.50.26.132 streams&lt;br/&gt;
Mode: Leaving: streaming data to other nodes&lt;br/&gt;
Streaming to: /10.50.26.133&lt;br/&gt;
   /var/lib/cassandra/data/Keyspace1/Standard1-d-17-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,54080834)&amp;#93;&lt;/span&gt;&lt;br/&gt;
Not receiving any streams.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test3 scripts&amp;#93;&lt;/span&gt;$ nodetool --host 10.50.26.133 streams&lt;br/&gt;
Mode: Normal&lt;br/&gt;
Not sending any streams.&lt;br/&gt;
Not receiving any streams.&lt;/p&gt;

&lt;p&gt;From the logs of 10.50.26.132 it seams that it tried to tell 10.50.26.133 to claim its stream:&lt;/p&gt;

&lt;p&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-07-13 16:50:35,994 StreamOut.java (line 135) Sending a stream initiate message to /10.50.26.133 ...&lt;br/&gt;
INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-STAGE:1&amp;#93;&lt;/span&gt; 2010-07-13 16:50:35,994 StreamOut.java (line 140) Waiting for transfer to /10.50.26.133 to complete&lt;/p&gt;

&lt;p&gt;But nothing in 133&apos;s log acknowledges the receipt of the request from 132 and as you see above it shows that it is getting no streams and this has been going for the past hour or so.&lt;/p&gt;

&lt;p&gt;-Arya&lt;/p&gt;
</comment>
                            <comment id="12888560" author="gdusbabek" created="Wed, 14 Jul 2010 21:50:34 +0000"  >&lt;p&gt;Arya,  can you supply the nodetool commands you are using that constitute &quot;cleanup&quot;?  I&apos;ve tried a few times now and can&apos;t get the failure you describe.  In your latest test was .132 the second or third node booted?&lt;/p&gt;</comment>
                            <comment id="12888600" author="arya" created="Wed, 14 Jul 2010 22:55:52 +0000"  >&lt;p&gt;132 is node1&lt;br/&gt;
133 is node2&lt;br/&gt;
134 is node3&lt;/p&gt;

&lt;p&gt;Give me some time and I&apos;ll regenerate all the commands for you in details. &lt;/p&gt;</comment>
                            <comment id="12888635" author="arya" created="Thu, 15 Jul 2010 00:20:55 +0000"  >&lt;p&gt;Gary, I missed one thing (Step 9-13) where I took a node down and insert. I tested this without step 9-13 and loadbalance worked. Not sure why step 9-13 changes everything. Here are the full production steps (I am also attaching the logs from all 3 nodes if it helps):&lt;/p&gt;

&lt;p&gt;This is the ring topology I discuss here:&lt;/p&gt;

&lt;p&gt;Node1 10.50.26.132 (Hostname: cas-test1)&lt;br/&gt;
Node2 10.50.26.133 (Hostname: cas-test2)&lt;br/&gt;
Node3 10.50.26.134 (Hostname: cas-test3)&lt;/p&gt;

&lt;p&gt;This run is using today&apos;s nightly built from a clean setup.&lt;/p&gt;

&lt;p&gt;Step 1: Startup Node1&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ sudo /etc/init.d/cassandra start&lt;/p&gt;

&lt;p&gt;Step 2: LoadSchemadFromYAML&lt;/p&gt;

&lt;p&gt;I go to JConsole and call the function from o.a.c.service StorageService MBeans&lt;/p&gt;

&lt;p&gt;Step 3: I insert 500000 keys into Standard1 CF using py_stress&lt;/p&gt;

&lt;p&gt;$ python stress.py --num-keys 500000 --threads 8 --nodes 10.50.26.132 --keep-going --operation insert&lt;br/&gt;
Keyspace already exists.&lt;br/&gt;
total,interval_op_rate,interval_key_rate,avg_latency,elapsed_time&lt;br/&gt;
62455,6245,6245,0.00128478354559,10&lt;br/&gt;
121893,5943,5943,0.00134767375398,21&lt;br/&gt;
184298,6240,6240,0.00128336335573,31&lt;br/&gt;
248124,6382,6382,0.00124898537112,42&lt;br/&gt;
297205,4908,4908,0.00163303957852,52&lt;br/&gt;
340338,4313,4313,0.00189026848124,63&lt;br/&gt;
380233,3989,3989,0.00203818801591,73&lt;br/&gt;
444452,6421,6421,0.00124198496903,84&lt;br/&gt;
500000,5554,5554,0.00114441244599,93&lt;/p&gt;

&lt;p&gt;Step 3: Let&apos;s Take a Look at Ring&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
10.50.26.132    Up     Normal  206.05 MB       139380634429053457983268837561452509806     &lt;/p&gt;

&lt;p&gt;Step 4: Bootstrap Node 2 into cluster&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test2 ~&amp;#93;&lt;/span&gt;$ sudo /etc/init.d/cassandra start&lt;/p&gt;

&lt;p&gt;Step 5: Check the ring&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Joining 5.84 KB         54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.132    Up     Normal  206.05 MB       139380634429053457983268837561452509806     &lt;/p&gt;

&lt;p&gt;Step 6: Check the streams on Node 1&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 streams&lt;br/&gt;
Mode: Normal&lt;br/&gt;
Streaming to: /10.50.26.133&lt;br/&gt;
   /var/lib/cassandra/data/Keyspace1/Standard1-d-5-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,34658183), (89260032,109057810)&amp;#93;&lt;/span&gt;&lt;br/&gt;
   /var/lib/cassandra/data/Keyspace1/Standard1-d-6-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,8746823), (22272929,27264363)&amp;#93;&lt;/span&gt;&lt;br/&gt;
   /var/lib/cassandra/data/Keyspace1/Standard1-d-8-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,8749389), (22336617,27264253)&amp;#93;&lt;/span&gt;&lt;br/&gt;
   /var/lib/cassandra/data/Keyspace1/Standard1-d-9-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,8235190), (21174782,25822054)&amp;#93;&lt;/span&gt;&lt;br/&gt;
   /var/lib/cassandra/data/Keyspace1/Standard1-d-7-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,8642472), (22333239,27264347)&amp;#93;&lt;/span&gt;&lt;br/&gt;
Not receiving any streams.&lt;/p&gt;

&lt;p&gt;Step 7: Check the ring from Node1 and Node2 and make sure they agree&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.132    Up     Normal  233.93 MB       139380634429053457983268837561452509806     &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.133 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.132    Up     Normal  233.93 MB       139380634429053457983268837561452509806&lt;/p&gt;

&lt;p&gt;Step 8: Cleanup Node1&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 cleanup&lt;/p&gt;

&lt;p&gt;Step 9: Check the ring agreement again&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.132    Up     Normal  117 MB          139380634429053457983268837561452509806     &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.133 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.132    Up     Normal  117 MB          139380634429053457983268837561452509806     &lt;/p&gt;

&lt;p&gt;Step 9: Let&apos;s kill Node 2&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test2 ~&amp;#93;&lt;/span&gt;$ sudo /etc/init.d/cassandra stop &lt;/p&gt;

&lt;p&gt;Step 10: Check the ring on Node 1&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Down   Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.132    Up     Normal  117 MB          139380634429053457983268837561452509806&lt;/p&gt;

&lt;p&gt;Step 11: Let&apos;s try to insert 500000 more keys expecting lots of unavailable exceptions ad the only replica for some keys is dead and py_stress does not use CLevel.ANY or ZERO&lt;/p&gt;

&lt;p&gt;$ python stress.py --num-keys 500000 --threads 8 --nodes 10.50.26.132 --keep-going --operation insert&lt;/p&gt;

&lt;p&gt;Keyspace already exists.&lt;br/&gt;
UnavailableException()&lt;br/&gt;
UnavailableException()&lt;br/&gt;
UnavailableException()&lt;br/&gt;
....&lt;br/&gt;
...&lt;br/&gt;
..&lt;br/&gt;
.&lt;br/&gt;
total,interval_op_rate,interval_key_rate,avg_latency,elapsed_time&lt;br/&gt;
500000,2922,2922,0.000816067281446,67&lt;/p&gt;

&lt;p&gt;Step 12: Check the ring&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Down   Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.132    Up     Normal  205.35 MB       139380634429053457983268837561452509806     &lt;/p&gt;

&lt;p&gt;Node 1 got more data as expected&lt;/p&gt;

&lt;p&gt;Step 13: Bring up Node 2 again&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test2 ~&amp;#93;&lt;/span&gt;$ sudo /etc/init.d/cassandra start&lt;/p&gt;

&lt;p&gt;Step 14: Check the Ring&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.132    Up     Normal  205.35 MB       139380634429053457983268837561452509806     &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.133 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.132    Up     Normal  205.35 MB       139380634429053457983268837561452509806&lt;/p&gt;

&lt;p&gt;Step 15: Bootstrap Node 3&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test3 ~&amp;#93;&lt;/span&gt;$ sudo /etc/init.d/cassandra start&lt;/p&gt;

&lt;p&gt;Step 11: Check Ring &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.134    Up     Normal  116.68 MB       96565427321648203609592911083606603165      &lt;br/&gt;
10.50.26.132    Up     Normal  234 MB          139380634429053457983268837561452509806     &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.133 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.134    Up     Normal  116.68 MB       96565427321648203609592911083606603165      &lt;br/&gt;
10.50.26.132    Up     Normal  234 MB          139380634429053457983268837561452509806     &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.134 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.134    Up     Normal  116.68 MB       96565427321648203609592911083606603165      &lt;br/&gt;
10.50.26.132    Up     Normal  234 MB          139380634429053457983268837561452509806     &lt;/p&gt;

&lt;p&gt;Step 12: Cleanup Node 1 (132)&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 cleanup&lt;/p&gt;

&lt;p&gt;Step 13: Check Ring&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.134    Up     Normal  116.68 MB       96565427321648203609592911083606603165      &lt;br/&gt;
10.50.26.132    Up     Normal  58.89 MB        139380634429053457983268837561452509806     &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.133 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.134    Up     Normal  116.68 MB       96565427321648203609592911083606603165      &lt;br/&gt;
10.50.26.132    Up     Normal  58.89 MB        139380634429053457983268837561452509806     &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.134 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.134    Up     Normal  116.68 MB       96565427321648203609592911083606603165      &lt;br/&gt;
10.50.26.132    Up     Normal  58.89 MB        139380634429053457983268837561452509806     &lt;/p&gt;

&lt;p&gt;Looks as expected. Node 1 (132) has the least load. Let&apos;s loadbalance it.&lt;/p&gt;

&lt;p&gt;Step 14: Loadbalance Node 1&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 loadbalance &amp;amp;&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; 27457&lt;/p&gt;

&lt;p&gt;Step 15: Check Ring&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.134    Up     Normal  116.68 MB       96565427321648203609592911083606603165      &lt;br/&gt;
10.50.26.132    Up     Leaving 58.89 MB        139380634429053457983268837561452509806     &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.133 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.134    Up     Normal  116.68 MB       96565427321648203609592911083606603165      &lt;br/&gt;
10.50.26.132    Up     Leaving 58.89 MB        139380634429053457983268837561452509806     &lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.134 ring&lt;br/&gt;
Address         Status State   Load            Token                                       &lt;br/&gt;
                                       139380634429053457983268837561452509806    &lt;br/&gt;
10.50.26.133    Up     Normal  116.94 MB       54081521187303805945240848606999860232      &lt;br/&gt;
10.50.26.134    Up     Normal  116.68 MB       96565427321648203609592911083606603165      &lt;br/&gt;
10.50.26.132    Up     Leaving 58.89 MB        139380634429053457983268837561452509806     &lt;/p&gt;

&lt;p&gt;Step 16: Check the Streams&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.132 streams&lt;br/&gt;
Mode: Leaving: streaming data to other nodes&lt;br/&gt;
Streaming to: /10.50.26.133&lt;br/&gt;
   /var/lib/cassandra/data/Keyspace1/Standard1-d-17-Data.db/&lt;span class=&quot;error&quot;&gt;&amp;#91;(0,54278564)&amp;#93;&lt;/span&gt;&lt;br/&gt;
Not receiving any streams.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;agoudarzi@cas-test1 ~&amp;#93;&lt;/span&gt;$ nodetool --host=10.50.26.133 streams&lt;br/&gt;
Mode: Normal&lt;br/&gt;
Not sending any streams.&lt;br/&gt;
Not receiving any streams.&lt;/p&gt;

&lt;p&gt;PROBLEM:&lt;br/&gt;
Notice 132 says I am streaming to 133 but 133 says &quot;Not receiving any streams!&quot;  &lt;/p&gt;

</comment>
                            <comment id="12888637" author="arya" created="Thu, 15 Jul 2010 00:24:27 +0000"  >&lt;p&gt;Cassandra System Logs for node 1-3&lt;/p&gt;</comment>
                            <comment id="12888913" author="gdusbabek" created="Thu, 15 Jul 2010 20:30:59 +0000"  >&lt;p&gt;Thanks Arya. I can reproduce this.  Now just to fix it.&lt;/p&gt;</comment>
                            <comment id="12890244" author="gdusbabek" created="Tue, 20 Jul 2010 11:48:34 +0000"  >&lt;p&gt;Several problems on this ticket.&lt;br/&gt;
1. MessaingService implemented IFailureDetector and was in charge of shutting down TCP connections during a partition.  However, it was never added to the listeners in FD.  This meant that MS.convict() was never getting called.&lt;br/&gt;
2. Under the right conditions (I still don&apos;t understand this fully), java sockets still give every indication they are connected even though the host on the other end is down.  A single write will succeed, even though no bytes are sent.  Seriously.  In our case the single write was a StreamInitiateMessage that we then wait forever to be acked the the &lt;span class=&quot;error&quot;&gt;&amp;#91;dead&amp;#93;&lt;/span&gt; remote host.&lt;/p&gt;

&lt;p&gt;My solution was to use Gossiper.convict, which calls SS.onDead, to call MS.convict().  I don&apos;t think it makes sense to have MS implement IFailureDetector since we treat Gossiper as authoritative with respect to node alive-ness.&lt;/p&gt;

&lt;p&gt;I&apos;ll spend some time checking this morning, but I suspect we have the same situation in 0.6.&lt;/p&gt;</comment>
                            <comment id="12890280" author="gdusbabek" created="Tue, 20 Jul 2010 15:25:48 +0000"  >&lt;p&gt;patch for 0.6.  I couldn&apos;t get stress.py to work in my branch, but the same problem should be present.  All tests pass with this patch.&lt;/p&gt;</comment>
                            <comment id="12890295" author="jbellis" created="Tue, 20 Jul 2010 16:17:32 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;(but fix brace placement in onDead please)&lt;/p&gt;</comment>
                            <comment id="12890713" author="hudson" created="Wed, 21 Jul 2010 12:50:25 +0000"  >&lt;p&gt;Integrated in Cassandra #496 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/496/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/496/&lt;/a&gt;)&lt;br/&gt;
    failure detection wasn&apos;t closing sockets. patch by gdusbabek, reviewed by jbellis. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1221&quot; title=&quot;loadbalance operation never completes on a 3 node cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1221&quot;&gt;&lt;del&gt;CASSANDRA-1221&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12449928" name="0.6-conviction-fix.diff" size="2139" author="gdusbabek" created="Tue, 20 Jul 2010 15:25:48 +0000"/>
                            <attachment id="12449920" name="0001-Gossiper-and-FD-never-called-MS.convict-to-shut-down.patch" size="3186" author="gdusbabek" created="Tue, 20 Jul 2010 11:39:22 +0000"/>
                            <attachment id="12449507" name="system1.log" size="27751" author="arya" created="Thu, 15 Jul 2010 00:24:27 +0000"/>
                            <attachment id="12449508" name="system2.log" size="16470" author="arya" created="Thu, 15 Jul 2010 00:24:27 +0000"/>
                            <attachment id="12449509" name="system3.log" size="10532" author="arya" created="Thu, 15 Jul 2010 00:24:27 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[gdusbabek]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20038</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 18 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g3qn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92036</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>