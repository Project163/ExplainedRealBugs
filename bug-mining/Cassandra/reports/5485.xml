<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:17:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14103] Fix potential race during compaction strategy reload</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14103</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When the compaction strategies are reloaded after disk boundary changes (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13948&quot; title=&quot;Reload compaction strategies when JBOD disk boundary changes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13948&quot;&gt;&lt;del&gt;CASSANDRA-13948&lt;/del&gt;&lt;/a&gt;), it&apos;s possible that a recently finished SSTable is added twice to the compaction strategy: once when the compaction strategies are reloaded due to the disk boundary change (&lt;tt&gt;maybeReloadDiskBoundarie&lt;/tt&gt;), and another when the &lt;tt&gt;CompactionStrategyManager&lt;/tt&gt; is processing the &lt;tt&gt;SSTableAddedNotification&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This should be quite unlikely because a compaction must finish as soon as the disk boundary changes, and even if it happens most compaction strategies would not be affected by it since they deduplicate sstables internally, but we should protect against such scenario. &lt;/p&gt;

&lt;p&gt;For more context see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13948?focusedCommentId=16280448&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16280448&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;this comment&lt;/a&gt; from Marcus.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13123761">CASSANDRA-14103</key>
            <summary>Fix potential race during compaction strategy reload</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="pauloricardomg">Paulo Motta</reporter>
                        <labels>
                    </labels>
                <created>Fri, 8 Dec 2017 17:59:25 +0000</created>
                <updated>Sun, 2 Apr 2023 12:06:39 +0000</updated>
                            <resolved>Wed, 16 Sep 2020 09:14:17 +0000</resolved>
                                        <fixVersion>3.11.9</fixVersion>
                    <fixVersion>4.0-beta3</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16283939" author="pauloricardomg" created="Fri, 8 Dec 2017 18:02:01 +0000"  >&lt;p&gt;I thought that a simple way to fix it without messing with the locks is to not fetch the SSTables from the tracker when reloading the compaction strategies, but only when initializing the CompactionStrategyManager, and keep an sstable set in the compaction strategy manager which is used when reloading the compaction strategies.&lt;/p&gt;</comment>
                            <comment id="16309725" author="pauloricardomg" created="Wed, 3 Jan 2018 14:38:24 +0000"  >&lt;p&gt;The patch below implements the solution described above of keeping an SSTable set in the &lt;tt&gt;CompactionStrategyManager&lt;/tt&gt; which is updated when receiving notifications from the tracker, what should prevent double adding of sstables if the strategies are reloaded by some other thread when processing a notification from the tracker. I also added a test to check that the sstables are properly added to the compaction strategies when receiving tracker notifications.&lt;/p&gt;

&lt;p&gt;On the trunk patch I also fixed a bad merge from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14082&quot; title=&quot;Do not expose compaction strategy index publicly&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14082&quot;&gt;&lt;del&gt;CASSANDRA-14082&lt;/del&gt;&lt;/a&gt; (&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-14103#diff-1d4755900f9e76a3cf93810d98189951L706&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;CI looks good:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...pauloricardomg:3.11-14103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-14103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12904399/3.11-14103-testall.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12904400/trunk-14103-dtest.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12904398/3.11-14103-dtest.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12904401/trunk-14103-testall.png&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16434981" author="krummas" created="Thu, 12 Apr 2018 05:55:57 +0000"  >&lt;p&gt;(sorry for the delay on this)&lt;/p&gt;

&lt;p&gt;LGTM, just a few minor comments;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Could we make &lt;tt&gt;CompactionStrategyManager&lt;/tt&gt; take the initial sstables as a parameter to the constructor instead of calling &lt;tt&gt;cfs.getSSTables(...CANONICAL..)&lt;/tt&gt; there? Feels it makes it more clear that the tracker has to be populated before we can create the CSM&lt;/li&gt;
	&lt;li&gt;Make &lt;tt&gt;maybeReloadDiskBoundaries&lt;/tt&gt; return &lt;tt&gt;void&lt;/tt&gt;, the only user of the return value is the test case and that could probably be refactored to check that the boundaries changed instead?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17191606" author="krummas" created="Mon, 7 Sep 2020 09:44:28 +0000"  >&lt;p&gt;Cancelling patch available&lt;/p&gt;

&lt;p&gt;It is probably a better idea to make sure LCS correctly handles duplicate notifications instead of introducing a third place where we track sstables.&lt;/p&gt;</comment>
                            <comment id="17192796" author="krummas" created="Wed, 9 Sep 2020 11:25:00 +0000"  >&lt;p&gt;Patch: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/14103&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/14103&lt;/a&gt;&lt;br/&gt;
cci: &lt;a href=&quot;https://app.circleci.com/pipelines/github/krummas/cassandra/502/workflows/3403b209-f0fd-4763-a3fe-6cd81ca9b263&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/krummas/cassandra/502/workflows/3403b209-f0fd-4763-a3fe-6cd81ca9b263&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;this patch contains 2 commits, one which cleans up &lt;tt&gt;CompactionStrategyManager&lt;/tt&gt; a bit and makes sure we don&apos;t miss any notifications, the other one fixes LCS to correctly handle getting added/removed notifications for sstables already added/removed by &lt;tt&gt;maybeReloadDiskBoundaries()&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;The second patch here essentially just changes the levels in LCS from lists to (sorted) sets, and the reason is that checking if an sstable already exists in the manifest gets very slow if we have many sstables (like when we are overrun in L0 for example). This also improves startup time which is more important now that we reload the compaction strategies after every range movement. This is a reworked patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14826&quot; title=&quot;cassandra spinning forever on 1 thread while initializing keyspace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14826&quot;&gt;&lt;del&gt;CASSANDRA-14826&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17195759" author="bdeggleston" created="Mon, 14 Sep 2020 23:59:52 +0000"  >&lt;p&gt;This looks like if fixes the issue and looks good for the most part. I had some questions about how we react to sstables that are in the wrong levels for whatever reason. AFAICT, misclassified sstables makes leveled compaction less effective, but it doesn&apos;t seem like it has the potential to cause data loss, correctness bugs, or outages. What do you think about logging something scary in LeveledGenerations.maybeVerifyLevels and putting the sstable in the right spot instead of throwing an assertion error? If so, we should also correct misplaced sstables in LeveledGenerations.addAll when we check its level against getLevelIfExists, if not, we should throw an exception there.&lt;/p&gt;

&lt;p&gt;Also 2 nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;the fields added to CompactionStrategyManager (and the 2 existing ones, supportsEarlyOpen and fanout, should be volatile)&lt;/li&gt;
	&lt;li&gt;the comment in LeveledGenerations.addAll should be indented.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17195915" author="krummas" created="Tue, 15 Sep 2020 06:53:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;LeveledGenerations.maybeVerifyLevels &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;this is only runs in the tests, so we don&apos;t throw anything during normal operation (&lt;tt&gt;private final boolean strictLCSChecksTest = Boolean.getBoolean(Config.PROPERTY_PREFIX + &quot;test.strict_lcs_checks&quot;);&lt;/tt&gt;). Added an ERROR log when adding sstables if it already exists on the wrong level, then removes it and continues to add it at the sstable-metadata-level&lt;/p&gt;

&lt;p&gt;fixed the nits&lt;/p&gt;</comment>
                            <comment id="17196214" author="bdeggleston" created="Tue, 15 Sep 2020 15:07:04 +0000"  >&lt;p&gt;ah got it, thanks. +1&lt;/p&gt;</comment>
                            <comment id="17196808" author="krummas" created="Wed, 16 Sep 2020 09:14:17 +0000"  >&lt;p&gt;and committed, test runs:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/krummas/cassandra/515/workflows/49751fc1-ef03-45d2-883f-8e8a7c5298ff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; , &lt;a href=&quot;https://app.circleci.com/pipelines/github/krummas/cassandra/509/workflows/a50f71ca-b117-4cbe-b059-60f09b3987fe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310660">
                    <name>Completes</name>
                                            <outwardlinks description="fixes">
                                        <issuelink>
            <issuekey id="13179032">CASSANDRA-14642</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13191912">CASSANDRA-14826</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13246282">CASSANDRA-15242</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13108507">CASSANDRA-13948</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12904398" name="3.11-14103-dtest.png" size="59220" author="pauloricardomg" created="Wed, 3 Jan 2018 13:05:45 +0000"/>
                            <attachment id="12904399" name="3.11-14103-testall.png" size="9607" author="pauloricardomg" created="Wed, 3 Jan 2018 13:05:42 +0000"/>
                            <attachment id="12904400" name="trunk-14103-dtest.png" size="22851" author="pauloricardomg" created="Wed, 3 Jan 2018 13:05:43 +0000"/>
                            <attachment id="12904401" name="trunk-14103-testall.png" size="69353" author="pauloricardomg" created="Wed, 3 Jan 2018 13:05:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 8 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3np93:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12341709">3.11.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/f41ea9fb14936bca4aeea0ab2bf6d55c51f37f6a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/f41ea9fb14936bca4aeea0ab2bf6d55c51f37f6a&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;new unit tests, cci run&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>