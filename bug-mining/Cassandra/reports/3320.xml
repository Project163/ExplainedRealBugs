<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8562] Fix checking available disk space before compaction starts</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8562</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When starting a compaction we check if there is enough disk space available to start it, otherwise we might (for STCS) reduce the compaction so that the result could fit. Now (since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8329&quot; title=&quot;LeveledCompactionStrategy should split large files across data directories when compacting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8329&quot;&gt;&lt;del&gt;CASSANDRA-8329&lt;/del&gt;&lt;/a&gt;) we check for the directory to write to a lot later and this can reduce the compaction after we have created the scanners.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12764919">CASSANDRA-8562</key>
            <summary>Fix checking available disk space before compaction starts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 5 Jan 2015 15:06:32 +0000</created>
                <updated>Wed, 15 Oct 2025 09:49:04 +0000</updated>
                            <resolved>Mon, 12 Jan 2015 17:52:53 +0000</resolved>
                                        <fixVersion>2.0.12</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14264659" author="krummas" created="Mon, 5 Jan 2015 15:12:45 +0000"  >&lt;p&gt;Attaching patch that checks if we have enough space for the sstables created by the compaction&lt;/p&gt;

&lt;p&gt;For LCS it sums up all data directories that have space for at least one sstable.&lt;/p&gt;

&lt;p&gt;&lt;del&gt;Kept the reduce scope code in DiskAwareRunnable since removing it could break stuff for people running their own custom CompactionTask&lt;/del&gt; edit: seems we broke it for them in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8329&quot; title=&quot;LeveledCompactionStrategy should split large files across data directories when compacting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8329&quot;&gt;&lt;del&gt;CASSANDRA-8329&lt;/del&gt;&lt;/a&gt; anyway, new patch attached&lt;/p&gt;</comment>
                            <comment id="14266991" author="jbellis" created="Tue, 6 Jan 2015 23:46:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JoshuaMcKenzie&quot; class=&quot;user-hover&quot; rel=&quot;JoshuaMcKenzie&quot;&gt;JoshuaMcKenzie&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="14271752" author="jmckenzie" created="Fri, 9 Jan 2015 19:29:45 +0000"  >&lt;ul&gt;
	&lt;li&gt;Delete default no-op implementation of reduceScopeForLimitedSpace from DiskAwareRunnable as it&apos;s no longer used&lt;/li&gt;
	&lt;li&gt;nit: normalize use of braces in:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (BlacklistedDirectories.isUnwritable(getLocationForDisk(dataDir)))
            &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
      DataDirectoryCandidate candidate = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; DataDirectoryCandidate(dataDir);
      &lt;span class=&quot;code-comment&quot;&gt;// exclude directory &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; its total writeSize does not fit to data directory
&lt;/span&gt;      &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (candidate.availableSpace &amp;lt; writeSize)
      {
            &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
      }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;A last general question - is throwing an RTE the best thing for us to do when we don&apos;t have sufficient disk space for a node to compact files?  Seems like that&apos;s a pretty serious situation for a node to be in... this gets me thinking of something like &quot;compaction_failure_policy&quot;, similar to disk_failure or commit_failure where we can instruct what to do with a node if we hit these types of conditions.  Certainly outside the scope of this ticket but might be worth following up on if we don&apos;t have something along those lines already.&lt;/p&gt;

&lt;p&gt;Other than the above 2 minor things, lgtm.&lt;/p&gt;</comment>
                            <comment id="14273287" author="krummas" created="Mon, 12 Jan 2015 07:48:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;Delete default no-op implementation of reduceScopeForLimitedSpace from DiskAwareRunnable as it&apos;s no longer used&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;fixed&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;is throwing an RTE the best thing for us to do when we don&apos;t have sufficient disk space for a node to compact files?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Perhaps not, using something like a compaction_failure_policy might be good, problem is though that in the compaction case there is a chance that we might actually recover - we could have 10 compactions going eating up disk space but once those are done we will have plenty of room on the drive. Perhaps if we do something like &quot;if we fail finding space to compact to for X minutes, die&quot;?&lt;/p&gt;

&lt;p&gt;I wanted a quick fix in for 2.0.12 though, as we broke this in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8329&quot; title=&quot;LeveledCompactionStrategy should split large files across data directories when compacting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8329&quot;&gt;&lt;del&gt;CASSANDRA-8329&lt;/del&gt;&lt;/a&gt; (which is not yet released)&lt;/p&gt;

&lt;p&gt;edit: oops misread, thought you suggested adding compaction_failure_policy in this ticket, will get it committed&lt;/p&gt;</comment>
                            <comment id="14273482" author="krummas" created="Mon, 12 Jan 2015 10:50:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JoshuaMcKenzie&quot; class=&quot;user-hover&quot; rel=&quot;JoshuaMcKenzie&quot;&gt;JoshuaMcKenzie&lt;/a&gt; attaching the 2.1-patch, seems we have a bug in CompactionTask#reduceForLimitedScope since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6916&quot; title=&quot;Preemptive opening of compaction result&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6916&quot;&gt;&lt;del&gt;CASSANDRA-6916&lt;/del&gt;&lt;/a&gt; - we remove the biggest sstable from the sstables we compact, but we never unmark it as compacting. Could you have a look at my fix?&lt;/p&gt;</comment>
                            <comment id="14273796" author="jmckenzie" created="Mon, 12 Jan 2015 17:21:35 +0000"  >&lt;p&gt;+1 on v2.&lt;/p&gt;

&lt;p&gt;We should probably augment AbstractionCompactionTask.sstables from being a dumb collection to an object that&apos;ll mark / unmark compaction status on sstables and provide hooks for that as it should help prevent these types of errors.  Right now, marking compacted is in a different file/object scope than unmarking, which is in a different file/scope than this one-off fix from removing sstables and there&apos;s no real documentation in the code to imply that removing from sstables means you also need to unmarkCompacting and when.  That kind of split leads to errors like this being &lt;b&gt;very&lt;/b&gt; easy to introduce, and having a single &quot;smart-collection&quot; shared amongst users of these sstables seems better than the current granular coupling.&lt;/p&gt;

&lt;p&gt;As with the compaction_failure_policy, that&apos;s outside the scope of this fix.  Depending on if you agree with the reasoning we can create another ticket for that and pursue it (assuming there&apos;s not other changes in the works I don&apos;t know about that would obviate the need for it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/p&gt;</comment>
                            <comment id="14273837" author="krummas" created="Mon, 12 Jan 2015 17:52:53 +0000"  >&lt;p&gt;committed, +1 on your comments, will create ticket(s) tomorrow&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12690092" name="0001-Check-for-available-disk-space-before-starting-compa.patch" size="4994" author="marcuse" created="Mon, 5 Jan 2015 15:18:44 +0000"/>
                            <attachment id="12691623" name="8562-2.1-v2.txt" size="7062" author="marcuse" created="Mon, 12 Jan 2015 10:53:21 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 45 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23ygf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>joshuamckenzie</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[joshuamckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>