<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:45:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7209] Consider changing UDT serialization format before 2.1 release.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7209</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The current serialization format of UDT is the one of CompositeType. This was initially done on purpose, so that users that were using CompositeType for values in their thrift schema could migrate smoothly to UDT (it was also convenient code wise but that&apos;s a weak point).&lt;/p&gt;

&lt;p&gt;I&apos;m having serious doubt about this being wise however for 2 reasons:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;for each component, CompositeType stores an addition byte (the end-of-component) for reasons that only pertain to querying. This byte is basically wasted for UDT and makes no sense. I&apos;ll note that outside the inefficiency, there is also the fact that it will likely be pretty surprising/error-prone for driver authors.&lt;/li&gt;
	&lt;li&gt;it uses an unsigned short for the length of each component. While it&apos;s certainly not advisable in the current implementation to use values too big inside an UDT, having this limitation hard-coded in the serialization format is wrong and we&apos;ve been bitten by this with collection already which we&apos;ve had to fix in the protocol v3. It&apos;s probably worth no doing that mistake again. Furthermore, if we use an int for the size, we can use a negative size to represent a null value (the main point being that it&apos;s consistent with how we serialize values in the native protocol), which can be useful (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7206&quot; title=&quot;UDT - allow null / non-existant attributes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7206&quot;&gt;&lt;del&gt;CASSANDRA-7206&lt;/del&gt;&lt;/a&gt;).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Of course, if we change that serialization format, we&apos;d better do it before the 2.1 release. But I think the advantages outweigh the cons especially in the long run so I think we should do it. I&apos;ll try to work out a patch quickly so if you have a problem with the principle of this issue, it would be nice to voice it quickly.&lt;/p&gt;

&lt;p&gt;I&apos;ll note that doing that change will mean existing CompositeType values won&apos;t be able to be migrated transparently to UDT. I think this was anecdotal in the first place at best, I don&apos;t think using CompositeType for values is that popular in thrift tbh. Besides, if we really really want to, it might not be too hard to re-introduce that compatibility later by having some protocol level trick. We can&apos;t change the serialization format without breaking people however.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12713660">CASSANDRA-7209</key>
            <summary>Consider changing UDT serialization format before 2.1 release.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 May 2014 16:11:56 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:45 +0000</updated>
                            <resolved>Tue, 20 May 2014 16:43:02 +0000</resolved>
                                        <fixVersion>2.1 rc1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                                                            <comments>
                            <comment id="13995675" author="jbellis" created="Mon, 12 May 2014 21:44:53 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13996477" author="iamaleksey" created="Tue, 13 May 2014 15:11:02 +0000"  >&lt;p&gt;Agreed.&lt;/p&gt;</comment>
                            <comment id="13996531" author="slebresne" created="Tue, 13 May 2014 16:05:14 +0000"  >&lt;p&gt;Patch attached for this. The &quot;new&quot; format simply use 4 bytes for value sizes instead of 2 and drop the EOC byte. It&apos;s basically what makes sense for the native protocol given other encodings. The patch does a tiny bit of renaming too (columnNames-&amp;gt;fieldNames and types-&amp;gt;fieldTypes) because it&apos;s cleaner that way I think. I include a 2nd patch that also rename column_names/types to field_names/types in the schema table while at it for coherence with the code.&lt;/p&gt;</comment>
                            <comment id="13999845" author="iamaleksey" created="Fri, 16 May 2014 14:41:29 +0000"  >&lt;p&gt;This is going to break cqlsh support, obviously (aka python-driver support), so I&apos;m reopening &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6305&quot; title=&quot;cqlsh support for User Types&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6305&quot;&gt;&lt;del&gt;CASSANDRA-6305&lt;/del&gt;&lt;/a&gt;, /cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mishail&quot; class=&quot;user-hover&quot; rel=&quot;mishail&quot;&gt;mishail&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13999967" author="iamaleksey" created="Fri, 16 May 2014 16:47:59 +0000"  >&lt;p&gt;WRT serialization, it seems to me that we can avoid serializing at least the keyspace of the user type (post &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6643&quot; title=&quot;Limit user types to the keyspace they are defined in&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6643&quot;&gt;&lt;del&gt;CASSANDRA-6643&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;Also, I suspect it would be possible to get rid of serialising fieldNames as well - the names don&apos;t tell us much, since you can hypothetically rename user type (a,b) to (b,a) in two ALTER TYPE&apos;s. Also, while the number of the fields is not fixed, their order in schema is. I understand that this might very likely cause inconvenience on C* or drivers side, but technically this information is redundant and is overhead. (other than inconvenience, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7206&quot; title=&quot;UDT - allow null / non-existant attributes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7206&quot;&gt;&lt;del&gt;CASSANDRA-7206&lt;/del&gt;&lt;/a&gt; might interfere with it, too).&lt;/p&gt;</comment>
                            <comment id="14000412" author="thobbs" created="Fri, 16 May 2014 22:24:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;I understand that this might very likely cause inconvenience on C* or drivers side, but technically this information is redundant and is overhead.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;So far we&apos;ve always included enough information in the result set metadata to allow drivers to fully decode (and present) results without any other schema knowledge.  If we expect drivers to present UDTs as dicts or objects with fieldnames, they need to be in the result set metadata.&lt;/p&gt;

&lt;p&gt;If you&apos;re worried about overhead, drivers can always use the skip_metadata flag when using prepared statements.&lt;/p&gt;</comment>
                            <comment id="14000534" author="iamaleksey" created="Sat, 17 May 2014 00:01:59 +0000"  >&lt;p&gt;Yes. Never mind that part - I have read the code incorrectly.&lt;/p&gt;</comment>
                            <comment id="14002191" author="iamaleksey" created="Mon, 19 May 2014 19:11:25 +0000"  >&lt;p&gt;Attaching a patch fixing typos in the proto doc.&lt;/p&gt;

&lt;p&gt;The rest looks good to me. One nit, as mentioned before, is that we don&apos;t need to serialize the keyspace name, but even with that I can live.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14003607" author="slebresne" created="Tue, 20 May 2014 16:42:54 +0000"  >&lt;p&gt;Committed with doc typos, thanks.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;One nit, as mentioned before, is that we don&apos;t need to serialize the keyspace name&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s true. It&apos;s not entirely trivial code-wise to remove it because we need it in DataType#readValue to create a UserType (the AbstractType class) from what we got from the protocol definition and we don&apos;t have the context easily available. We could probably make such context available somehow but it&apos;s likely painful to refactor. So, since as said by Tyler this is not hugely relevant to performance since we only send that a preparation time (thanks to the skip_metadata), I&apos;d vote for letting it be. Besides, one advantage of leaving it in is that if we ever change our mind about limiting user type to their keyspace of definition, we won&apos;t be stuck because of that. &lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12713609">CASSANDRA-7206</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12644637" name="0001-7209.txt" size="26515" author="slebresne" created="Tue, 13 May 2014 16:05:14 +0000"/>
                            <attachment id="12644638" name="0002-Rename-column_names-types-to-field_names-types.txt" size="3377" author="slebresne" created="Tue, 13 May 2014 16:05:14 +0000"/>
                            <attachment id="12645617" name="doc-typos.txt" size="963" author="aleksey" created="Mon, 19 May 2014 19:11:25 +0000"/>
                    </attachments>
                <subtasks>
                            <subtask id="12714975">CASSANDRA-7261</subtask>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>391976</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 27 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1vi8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>392177</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>