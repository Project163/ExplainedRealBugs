<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:08:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11223] Queries with LIMIT filtering on clustering columns can return less rows than expected</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11223</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;A query like &lt;tt&gt;SELECT * FROM %s WHERE b = 1 LIMIT 2 ALLOW FILTERING&lt;/tt&gt; can return less row than expected if the table has some static columns and some of the partition have no rows matching b = 1.&lt;/p&gt;

&lt;p&gt;The problem can be reproduced with the following unit test:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&#8194;&#8194;&#8194;&#8194;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testFilteringOnClusteringColumnsWithLimitAndStaticColumns() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
&#8194;&#8194;&#8194;&#8194;{
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, s &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt;, c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, primary key (a, b))&quot;&lt;/span&gt;);

&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 3; i++)
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;{
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (a, s) VALUES (?, ?)&quot;&lt;/span&gt;, i, i);
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; j = 0; j &amp;lt; 3; j++)
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!(i == 0 &amp;amp;&amp;amp; j == 1))
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (a, b, c) VALUES (?, ?, ?)&quot;&lt;/span&gt;, i, j, i + j);
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;}

&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s&quot;&lt;/span&gt;),
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194; row(1, 0, 1, 1),
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194; row(1, 1, 1, 2),
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194; row(1, 2, 1, 3),
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194; row(0, 0, 0, 0),
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194; row(0, 2, 0, 2),
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194; row(2, 0, 2, 2),
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194; row(2, 1, 2, 3),
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194; row(2, 2, 2, 4));

&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE b = 1 ALLOW FILTERING&quot;&lt;/span&gt;),
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194; row(1, 1, 1, 2),
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194; row(2, 1, 2, 3));

&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s WHERE b = 1 LIMIT 2 ALLOW FILTERING&quot;&lt;/span&gt;),
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194; row(1, 1, 1, 2),
&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194;&#8194; row(2, 1, 2, 3)); &lt;span class=&quot;code-comment&quot;&gt;// &amp;lt;-------- FAIL It returns only one row because the &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; row of partition 0 is counted and filtered out in SELECT statement
&lt;/span&gt;&#8194;&#8194;&#8194;&#8194;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12942973">CASSANDRA-11223</key>
            <summary>Queries with LIMIT filtering on clustering columns can return less rows than expected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="blerer">Benjamin Lerer</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Feb 2016 14:49:45 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:58 +0000</updated>
                            <resolved>Wed, 2 Aug 2017 02:27:06 +0000</resolved>
                                        <fixVersion>2.2.11</fixVersion>
                    <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>13</watches>
                                                                                                                <comments>
                            <comment id="15195854" author="blerer" created="Tue, 15 Mar 2016 18:17:33 +0000"  >&lt;p&gt;My initial idea was to filter out earlier in the read path the partitions containing only static columns, in the case where they should not be returned. Unfortunatly, it was the wrong approach. The filtering cannot be done before we have reconciled the data and removed the tombstoned rows as we do not know until that point if the partitions contains some rows or not. This means that we can end up with less rows that requested as the limit has been applied on the replicas taking the static rows into account.&lt;br/&gt;
I now think that this problem should probably be solved at the paging level. In the case where the partitions without rows should not be returned, the static rows should not be counted in &lt;tt&gt;DataLimits&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15389437" author="jbellis" created="Fri, 22 Jul 2016 12:52:15 +0000"  >&lt;p&gt;Is this obsoleted then by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefania_alborghetti&quot; class=&quot;user-hover&quot; rel=&quot;stefania_alborghetti&quot;&gt;stefania_alborghetti&lt;/a&gt;&apos;s work on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11521&quot; title=&quot;Implement streaming for bulk read requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11521&quot;&gt;&lt;del&gt;CASSANDRA-11521&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15390400" author="stefania" created="Sat, 23 Jul 2016 00:20:22 +0000"  >&lt;p&gt;No it isn&apos;t obsoleted. The problem is in DataLimits, which is still used by 11521: the current paging mechanism uses it for page and query limits, the new paging mechanism uses it for query limits. &lt;/p&gt;

&lt;p&gt;I&apos;ve verified that the test fails in the same place on the 11521 branch.&lt;/p&gt;</comment>
                            <comment id="16072265" author="blerer" created="Mon, 3 Jul 2017 11:09:16 +0000"  >&lt;p&gt;I pushed a patch for &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...blerer:11223-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...blerer:11223-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I ran the tests on our internal CI and the results look good. The DTests failures appear to be unrelated to the patches.&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;3.0&lt;/tt&gt; patch solve the problem by not counting partitions with only static data when the there are some restrictions on the clustering or regular columns. The &lt;tt&gt;2.2&lt;/tt&gt; patch does not count partitions with only static data  when the there are some restrictions on the clustering column. In &lt;tt&gt;2.2&lt;/tt&gt;,  partitions with only static data are never returned for index queries due to that checking restrictions on regular columns was not needed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; Could you have a first look before I create the patch for &lt;tt&gt;3.11&lt;/tt&gt; and &lt;tt&gt;trunk&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="16073035" author="stefania" created="Tue, 4 Jul 2017 02:29:27 +0000"  >&lt;p&gt;The 3.0 patch LGTM except for one concern, which regards how we count static rows when we create a cached partition and when we check if it has enough rows. To be on the safe side, we should not count static rows when creating cached partitions (&lt;tt&gt;SinglePartitionReadCommand&lt;/tt&gt; line 439), and we should actually check whether the query needs to count them in &lt;tt&gt;DataLimits.hasEnoughLiveData()&lt;/tt&gt;, WDYT?&lt;/p&gt;

&lt;p&gt;There is also some existing but related code that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; and I were debating a while ago. In &lt;tt&gt;RowFilter&lt;/tt&gt; at &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/filter/RowFilter.java#L273&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;line 273-&amp;gt;288&lt;/a&gt;, is it correct to suppress a static row when filtering on non static rows replica side? If the static row was updated only on this replica, wouldn&apos;t the combined view be incorrect then? Now that we don&apos;t count static rows if filtering on reg. or clustering columns, isn&apos;t it more correct to send the static row to the coordinator? However, would this have implications on the digest calculations?&lt;/p&gt;

&lt;p&gt;The 3.0 patch also has some typos:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;ReadQuery.selectsFullPartitions()&lt;/tt&gt; javadoc, consider something like:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;* Checks &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; {@code ReadQuery} selects full partitions, that is it has no filtering on clustering or regular columns.
* @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; {@code &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; {@code ReadQuery} selects full partitions, {@code &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;} otherwise.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;perhaps &lt;tt&gt;ReadQuery.selectsFullPartitions()&lt;/tt&gt; should be singular, &lt;tt&gt;ReadQuery.selectsFullPartition()&lt;/tt&gt; (this would also&lt;br/&gt;
  make it consistent with the the equivalent methods in &lt;tt&gt;DataRange&lt;/tt&gt; and &lt;tt&gt;ClusteringIndexFilter&lt;/tt&gt;).&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;RowFilter.hasExpressionOnClusteringOrRegularColumns()&lt;/tt&gt; javadoc:
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;* Checks &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; some expressions apply to clustering or regular columns.
* @&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; {@code &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;} &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; at least one expression applies to clustering or regular columns, {@code &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;} otherwise.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;DataLimits.newCounter&lt;/tt&gt;, the parameter name in the javadoc should change from &lt;tt&gt;countsPartitionWithOnlyStaticData&lt;/tt&gt; to &lt;tt&gt;countPartitionsWithOnlyStaticData&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&amp;#8211;&lt;/p&gt;

&lt;p&gt;The 2.2 patch LGTM, I found no problems or typos. I just have the same concerns regarding how we count static rows when dealing with cached partitions. Similarly to what discussed above, but probably not worth addressing it, &lt;em&gt;partitions with only static data are never returned for index queries&lt;/em&gt;, I am not entirely sure that this is correct.&lt;/p&gt;</comment>
                            <comment id="16073309" author="blambov" created="Tue, 4 Jul 2017 08:25:41 +0000"  >&lt;p&gt;I do have some worries about the behaviour of &lt;tt&gt;CQLFilter&lt;/tt&gt;, namely that we throw away static-row only partitions if they do not have rows that survive the filter before we have had a chance to merge data from multiple replicas. We are also somewhat inconsistent in removing deletions, letting them survive only if they are together with live data.&lt;/p&gt;

&lt;p&gt;I am not sure I understand all the implications, but I think we are over-filtering in &lt;tt&gt;CQLFilter&lt;/tt&gt;. AFAICS this patch already removes the main reason for doing so (counting static-only partitions in &lt;tt&gt;DataLimits&lt;/tt&gt;), thus I would prefer to change &lt;tt&gt;CQLFilter&lt;/tt&gt; to only remove data that does not satisfy the expressions and leave deletions and static rows in. This may impact the size of the data we have to send to the coordinator, though; I don&apos;t know if that&apos;s acceptable.&lt;/p&gt;</comment>
                            <comment id="16073368" author="blerer" created="Tue, 4 Jul 2017 09:12:30 +0000"  >&lt;p&gt;I had a discussion with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; one year ago about the static row filtering and we both agreed that we should fix that behavior. Unfortunately, I did not do it straight away and forgot about it.&lt;br/&gt;
Now, my understanding is that those problems should be fixed by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8272&quot; title=&quot;2ndary indexes can return stale data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8272&quot;&gt;&lt;del&gt;CASSANDRA-8272&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; will those problems be solved by your patches for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8272&quot; title=&quot;2ndary indexes can return stale data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8272&quot;&gt;&lt;del&gt;CASSANDRA-8272&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16073374" author="blerer" created="Tue, 4 Jul 2017 09:18:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;partitions with only static data are never returned for index queries&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It is due to following bug: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13423&quot; title=&quot;Secondary indexes can return stale data for deleted rows in 2.x&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13423&quot;&gt;CASSANDRA-13423&lt;/a&gt;.&lt;/p&gt;
</comment>
                            <comment id="16073492" author="adelapena" created="Tue, 4 Jul 2017 11:15:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8272&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-8272&lt;/a&gt; only fixes 2i queries. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8273&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-8273&lt;/a&gt; will move filtering to coordinator side once &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8272&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-8272&lt;/a&gt; is done, with &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/1416d9b082d7f93b187cbf67abd9a917735c4804/src/java/org/apache/cassandra/db/filter/DataLimits.java#L208-L221&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;RowFilter&lt;/tt&gt;-aware &lt;tt&gt;DataLimits&lt;/tt&gt;&lt;/a&gt;, and might be a good place to address this problem. &lt;/p&gt;</comment>
                            <comment id="16082603" author="blerer" created="Tue, 11 Jul 2017 17:28:08 +0000"  >&lt;p&gt;I pushed new patches for &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...blerer:11223-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...blerer:11223-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;,  &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...blerer:11223-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; and  &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The patches do not fix the static row filtering as it is probably best to have it fix in   &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8273&quot; title=&quot;Allow filtering queries can return stale data&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8273&quot;&gt;&lt;del&gt;CASSANDRA-8273&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I ran CI on the different branches and the failures seem unrelated.&lt;/p&gt;</comment>
                            <comment id="16085292" author="stefania" created="Thu, 13 Jul 2017 07:10:22 +0000"  >&lt;p&gt;2.2 patch:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I missed it last time sorry, but we should not count the static row in &lt;tt&gt;GroupByPrefixReversed.count()&lt;/tt&gt; when &lt;tt&gt;countPartitionsWithOnlyStaticData&lt;/tt&gt; is false.&lt;/li&gt;
	&lt;li&gt;Are we sure it&apos;s fine to always count the static row in &lt;tt&gt;ColumnFamily.liveCQL3RowCount()&lt;/tt&gt;?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;3.0 patch:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Should we count static rows for the limits used by &lt;tt&gt;RowCacheSerializer.deserialize()&lt;/tt&gt;?&lt;/li&gt;
	&lt;li&gt;Nit: we still have a typo in the parameter name &lt;tt&gt;countPartitionsWithOnlyStaticData&lt;/tt&gt; for &lt;tt&gt;DataLimits.newCounter()&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;Nit: &lt;tt&gt;RowFilter.hasExpressionOnClusteringOrRegularColumns()&lt;/tt&gt; javadoc still has a typo repeated twice: &lt;em&gt;expressions applies&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I haven&apos;t checked the 3.11 and trunk patches yet, did they apply or do they need a full review?&lt;/p&gt;</comment>
                            <comment id="16085685" author="blerer" created="Thu, 13 Jul 2017 13:19:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;I missed it last time sorry, but we should not count the static row in &lt;tt&gt;GroupByPrefixReversed.count()&lt;/tt&gt; when &lt;tt&gt;countPartitionsWithOnlyStaticData&lt;/tt&gt; is false.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I did not change it on purpose.&lt;br/&gt;
The problem only affect range queries and multi-partition queries. Range queries do not accept an &lt;tt&gt;ORDER BY&lt;/tt&gt; clause. Multi-partition queries only accept an &lt;tt&gt;ORDER BY&lt;/tt&gt; clause when paging is off. The limit in this case is used only when the rows with only static data have already been discarded. So, in practice changing &lt;tt&gt;GroupByPrefixReversed.count()&lt;/tt&gt;  has no effect.&lt;/p&gt;

&lt;p&gt;I will add a test to prove that the behavior is correct.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Are we sure it&apos;s fine to always count the static row in &lt;tt&gt;ColumnFamily.liveCQL3RowCount()&lt;/tt&gt;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;tt&gt;ColumnFamily.liveCQL3RowCount()&lt;/tt&gt; is only used by &lt;tt&gt;ColumnFamilyStore::isFilterFullyCoveredBy&lt;/tt&gt; to check if the whole partition is cached. That we count the static row or not, the answer will be correct.&lt;br/&gt;
We could argue about &lt;tt&gt;ColumnFamily.liveCQL3RowCount()&lt;/tt&gt; independently of its current use, but I am in favor of minimizing the changes on &lt;tt&gt;2.2&lt;/tt&gt; (taken into account that everything is different in &lt;tt&gt;3.0&lt;/tt&gt;). What do you think?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Should we count static rows for the limits used by &lt;tt&gt;RowCacheSerializer.deserialize()&lt;/tt&gt;?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think it is fine. The limit is only used for limiting the number of rows stored in the cache for each partition and we will only count the static row if the partition does not have any row.  &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I haven&apos;t checked the 3.11 and trunk patches yet, did they apply or do they need a full review?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;tt&gt;3.11&lt;/tt&gt; is different due to the &lt;tt&gt;GROUP BY&lt;/tt&gt; functionality.&lt;/p&gt;

&lt;p&gt;I pushed the updated branches.&lt;/p&gt;</comment>
                            <comment id="16086730" author="stefania" created="Fri, 14 Jul 2017 02:09:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;So, in practice changing GroupByPrefixReversed.count() has no effect.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Fine to leave it as is then, but let&apos;s add a comment explaining this, so that people don&apos;t find it confusing later on.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The limit is only used for limiting the number of rows stored in the cache for each partition and we will only count the static row if the partition does not have any row.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;ColumnFamily.liveCQL3RowCount() is only used by ColumnFamilyStore::isFilterFullyCoveredBy to check if the whole partition is cached. That we count the static row or not, the answer will be correct. We could argue about ColumnFamily.liveCQL3RowCount() independently of its current use,&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You are right in that &lt;tt&gt;wholePartitionCached&lt;/tt&gt; will be correct regardless and we don&apos;t need to consider any other use cases that don&apos;t exist for 2.2. So it&apos;s fine as is, I was getting mixed up with 3.0.&lt;/p&gt;

&lt;p&gt;I&apos;ve checked the 3.11 patch in depth, and the trunk patch with the GH diff:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I think we can remove &lt;tt&gt;selectsFullPartitions&lt;/tt&gt; from &lt;tt&gt;MultiPartitionPager&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;The javadoc of &lt;tt&gt;ReadQuery.selectsFullPartition()&lt;/tt&gt; still looks wrong, I think the return is the opposite of what the doc says. This applies to 3.0 as well.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There is a conflict with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13482&quot; title=&quot;NPE on non-existing row read when row cache is enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13482&quot;&gt;&lt;del&gt;CASSANDRA-13482&lt;/del&gt;&lt;/a&gt; for 3.0+ so we need to rebase and rerun CI. Afterwards, if CI is still OK, we should be able to commit.&lt;/p&gt;</comment>
                            <comment id="16086967" author="blerer" created="Fri, 14 Jul 2017 07:27:31 +0000"  >&lt;p&gt;Shame on me. I need 3 tries out to properly correct some javadoc (not even able to copy paste the proper stuff) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16086999" author="stefania" created="Fri, 14 Jul 2017 07:54:13 +0000"  >&lt;p&gt;Shame on me for only picking up a grammar mistake and not the actual content yesterday... &#175;&amp;#92;&lt;em&gt;(&#12484;)&lt;/em&gt;/&#175;&lt;/p&gt;</comment>
                            <comment id="16087314" author="blerer" created="Fri, 14 Jul 2017 13:30:14 +0000"  >&lt;p&gt;I rebased the branches and ran CI. Everything looks good.&lt;/p&gt;</comment>
                            <comment id="16087845" author="blerer" created="Fri, 14 Jul 2017 19:20:46 +0000"  >&lt;p&gt;Committed into 2.2 at b08843de67b3c63fa9c0efe10bb9eda07c007f6c and merged into 3.0, 3.11 and trunk.&lt;/p&gt;</comment>
                            <comment id="16094408" author="stefania" created="Thu, 20 Jul 2017 09:12:29 +0000"  >&lt;p&gt;I don&apos;t think it&apos;s correct to always return false in &lt;a href=&quot;https://github.com/stef1927/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/filter/ClusteringIndexNamesFilter.java#L75&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ClusteringIndexNamesFilter.selectsAllPartition()&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;It&apos;s existing code, but with this patch applied we are no longer able to count rows for tables of the form &lt;tt&gt;CREATE TABLE %s (k int, v int, PRIMARY KEY (k) ) WITH COMPACT STORAGE&lt;/tt&gt;. We don&apos;t notice in the tests because we trim the results in &lt;tt&gt;SelectStatement&lt;/tt&gt;, but it does mean that we return too much data replica side in this cases. I noticed because of timeouts with large range queries on tables created by cassandra-stress.&lt;/p&gt;

&lt;p&gt;Here is a &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...stef1927:11223-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test&lt;/a&gt; for 3.0 that reproduces the problem: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; @Test
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testLimitInStaticTable() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; Throwable
    {
        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (k &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, v &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY (k) ) WITH COMPACT STORAGE &quot;&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; 10; i++)
            execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s(k, v) VALUES (?, ?)&quot;&lt;/span&gt;, i, i);

        assertRows(execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT * FROM %s LIMIT 5&quot;&lt;/span&gt;),
                   row(0, 0),
                   row(1, 1),
                   row(2, 2),
                   row(3, 3),
                   row(4, 4));
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If we temporarily comment out &lt;tt&gt;cqlRows.trim(userLimit);&lt;/tt&gt; in &lt;tt&gt;SelectStatement.process()&lt;/tt&gt;, then the test only passes if we return &lt;tt&gt;clusterings.isEmpty()&lt;/tt&gt; from &lt;tt&gt;ClusteringIndexNamesFilter.selectsAllPartition&lt;/tt&gt;. However, note that I am not 100% sure this approach is correct.&lt;/p&gt;

&lt;p&gt;Once you are back from holiday, could you take a look &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="16094562" author="JIRAUSER308715" created="Thu, 20 Jul 2017 11:36:58 +0000"  >&lt;p&gt;Sounds like we may want to revert this until it can be fixed?&lt;/p&gt;</comment>
                            <comment id="16095785" author="stefania" created="Fri, 21 Jul 2017 05:01:20 +0000"  >&lt;p&gt;The problem does not affect 2.2 because NamesQueryFilter.getLiveCount() is unchanged, and in any case GroupByPrefix will count 1 live row if toGroup is zero, which would be the case for the GroupByPrefix used by NamesQueryFilter.columnCounter(). The queries on this type of tables will never use SliceQueryFilter.&lt;/p&gt;

&lt;p&gt;For 3.0+, it&apos;s a bit of a pain to revert, so I have created the follow-up &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...stef1927:11223-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;. CI is currently running. &lt;/p&gt;

&lt;p&gt;The patch ensures that static rows are always counted for static compact tables (which is sufficient to fix the problem) but also assumes that a NamesQueryFilter is selecting the entire partition if it has no clustering values. This second part is not necessary but I think it&apos;s more correct because in this case NamesQueryFilter is not restricting anything, and prior usages of selectsAllPartition are limited to check if the filter restricts anything, in order to create CQL string representations of a query.&lt;/p&gt;

&lt;p&gt;Benjamin should be back in 1 week,  but I can find a reviewer sooner if required.&lt;/p&gt;</comment>
                            <comment id="16108995" author="blerer" created="Tue, 1 Aug 2017 14:29:39 +0000"  >&lt;p&gt;The patch looks good to me. Just a typo in the &lt;tt&gt;AbstractReadCommandBuilder::makeColumnFilter&lt;/tt&gt;. It should be &lt;tt&gt;StatementRestrictions&lt;/tt&gt; instead of &lt;tt&gt;StatementRestrinctions&lt;/tt&gt;.&lt;br/&gt;
Sorry, for forgetting the static compact table problem &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. &lt;/p&gt;</comment>
                            <comment id="16110159" author="stefania" created="Wed, 2 Aug 2017 02:26:42 +0000"  >&lt;p&gt;Thanks for the review, fixed the typo, committed to 3.0 as &lt;tt&gt;336baebadcd6114ad961ca1027474499e15ae42a&lt;/tt&gt; and merged upwards.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 15 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2thif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stefania</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>