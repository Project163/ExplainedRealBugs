<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8558] deleted row still can be selected out</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8558</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;first&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE  KEYSPACE space1 WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 3};
CREATE  TABLE space1.table3(a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, c text,primary key(a,b));
CREATE  KEYSPACE space2 WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 3};&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;second&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE  TABLE space2.table1(a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, primary key(a,b));
CREATE  TABLE space2.table2(a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, b &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, primary key(a,b));
INSERT INTO space1.table3(a,b,c) VALUES(1,1,&lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;);
drop table space2.table1;
DELETE FROM space1.table3 where a=1 and b=1;
drop table space2.table2;
select * from space1.table3 where a=1 and b=1;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;you will find that the row (a=1 and b=1)  in space1.table3 is not deleted.&lt;/p&gt;</description>
                <environment>&lt;p&gt;2.1.2 &lt;br/&gt;
java version &quot;1.7.0_55&quot;&lt;/p&gt;</environment>
        <key id="12764771">CASSANDRA-8558</key>
            <summary>deleted row still can be selected out</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="zhaoyan">zhaoyan</reporter>
                        <labels>
                            <label>qa-resolved</label>
                    </labels>
                <created>Sun, 4 Jan 2015 09:40:08 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:24 +0000</updated>
                            <resolved>Wed, 14 Jan 2015 11:14:41 +0000</resolved>
                                        <fixVersion>2.0.12</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="14263827" author="slebresne" created="Sun, 4 Jan 2015 10:30:54 +0000"  >&lt;p&gt;Have you made sure that you&apos;re using &lt;tt&gt;CL.QUORUM&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="14263868" author="zhaoyan" created="Sun, 4 Jan 2015 13:22:25 +0000"  >

&lt;p&gt;first i find it with java driver (yes, with CL.QUORUM)&lt;br/&gt;
then i find it with cqlsh client (default, not set CL).&lt;/p&gt;

&lt;p&gt;you can try with cqlsh.&lt;/p&gt;

&lt;p&gt;you will get the row with:&lt;br/&gt;
select * from space1.table3 where a=1 and b=1; &lt;br/&gt;
but get nothing with:&lt;br/&gt;
select * from space1.table3;&lt;/p&gt;</comment>
                            <comment id="14263871" author="zhaoyan" created="Sun, 4 Jan 2015 13:27:33 +0000"  >&lt;p&gt;the key point is&#65306;&lt;/p&gt;

&lt;p&gt;the &#8220;delete&#8220; operation is between two &#8220;drop table&#8221;&lt;/p&gt;</comment>
                            <comment id="14264482" author="slebresne" created="Mon, 5 Jan 2015 10:52:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=philipthompson&quot; class=&quot;user-hover&quot; rel=&quot;philipthompson&quot;&gt;philipthompson&lt;/a&gt; Can you try to see if you can reproduce consistently (maybe push a dtest for it), if it reproduce on 2.0 or not, and if not, see if we can bisect more closely what introduced that problem in 2.1 since a priori it&apos;s unclear why dropping a table would have any effect on another table.&lt;/p&gt;</comment>
                            <comment id="14264524" author="zhaoyan" created="Mon, 5 Jan 2015 12:00:13 +0000"  >&lt;p&gt;we used 2.0.8 before&lt;br/&gt;
it is ok with 2.0.8&lt;/p&gt;</comment>
                            <comment id="14264638" author="philipthompson" created="Mon, 5 Jan 2015 14:48:43 +0000"  >&lt;p&gt;I am able to reproduce this with just one node through cqlsh on 2.1.2. I will write up a dtest that reproduces the issue.&lt;/p&gt;</comment>
                            <comment id="14264645" author="philipthompson" created="Mon, 5 Jan 2015 14:56:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;, I have pushed the dtest cql_tests.py:TestCQL.bug_8558_test that reproduces this issue.&lt;/p&gt;</comment>
                            <comment id="14264898" author="philipthompson" created="Mon, 5 Jan 2015 18:50:56 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;22e18f5a348a911f89deed9f9984950de451d28a is the first bad commit
commit 22e18f5a348a911f89deed9f9984950de451d28a
Author: Jonathan Ellis &amp;lt;jbellis@apache.org&amp;gt;
Date:   Mon Dec 2 13:07:28 2013 -0600

    Multithreaded commitlog
    patch by Benedict Elliot Smith; reviewed by jbellis &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; CASSANDRA-3578

:100644 100644 6efbfbcfcdf6154901515af6773b2506f0c01cf6 bb3a98a3c9901496ddefcf86aed65b34c948d86d M	CHANGES.txt
:040000 040000 11cf0d09242214f03de546dd5af8c7c38f626089 50d2eeff23bb7135387f09bfe21e3d92d85fe2c2 M	src
:040000 040000 c521f53214555abc46a9b6b766a2787d9e4b0755 fc1c5f1ab579c49f53be9a50b98aee0a937ba022 M	test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; is the first commit where the test stops passing, but it is timing out when dropping space2.table1, it is not making it to the assert.&lt;/p&gt;

&lt;p&gt;I have now seen this error in the logs when running the test: &lt;tt&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;MigrationStage:1&amp;#93;&lt;/span&gt; 2015-01-05 13:33:48,087 CommitLogSegmentManager.java:309 - Failed waiting for a forced recycle of in-use commit log segments&lt;/tt&gt;&lt;/p&gt;



&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;4b54b8acd21999ad4394feb93deb7cca1de445c0 is the first bad commit
commit 4b54b8acd21999ad4394feb93deb7cca1de445c0
Author: Jonathan Ellis &amp;lt;jbellis@apache.org&amp;gt;
Date:   Thu Jan 30 17:08:46 2014 -0600

    remove Table.switchlock and introduce o.a.c.utils.memory &lt;span class=&quot;code-keyword&quot;&gt;package&lt;/span&gt;
    patch by Benedict Elliott Smith; reviewed by jbellis &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; CASSANDRA-5549

:100644 100644 de477aadf9d1893cf4ee716501566f3524c7bc8b a0338747c2faabdddd5751fd3e598ebb7cefebb3 M	build.xml
:040000 040000 6a25b19597fd53e0e0f9e87cf7932fff9bed291d 5dc978748e1edb11a7c422c7b6ae6c807b6aef3c M	conf
:040000 040000 72b9515eed1738bde3b557449ffde734e3f01f9c 860751f996ccb315eac621386010c6f9cc28b4a6 M	lib
:040000 040000 7439706601eebd2cf74fb8bfd453023de01b6e22 a40c4e4d537df88308cf4669beef8a60a0f52412 M	src
:040000 040000 def7eaf6366d75ed03ccaddeb7c5b7f173ae1374 b404d22ed0f571244922530772a4ca56e815de9f M	test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; is the first commit where the deleted row can still be selected.&lt;/p&gt;</comment>
                            <comment id="14264900" author="philipthompson" created="Mon, 5 Jan 2015 18:51:25 +0000"  >&lt;p&gt;I&apos;ve assigned this to Benedict accordingly.&lt;/p&gt;</comment>
                            <comment id="14265965" author="benedict" created="Tue, 6 Jan 2015 11:16:33 +0000"  >&lt;p&gt;This is nothing to do with either change as far as I can tell. Somewhere inbetween those two changes something else was presumably broken, that is unrelated to either of them. It&apos;s possible that it was broken before either, in fact. Somewhere amongst them we changed drop behaviour to introduce flushing of dirty tables, and this flushing causes the problem. In fact we probably have a much worse problem than this appears.&lt;/p&gt;

&lt;p&gt;I can illicit this behaviour with a simple call to nodetool flush. The deletion records are flushed to disk, and appear in their respective sstables, but are not being returned by the IndexedSliceReader that queries them. A new test to find this behaviour would be simpler: &lt;/p&gt;

&lt;p&gt;CREATE  KEYSPACE space1 WITH replication = &lt;/p&gt;
{&apos;class&apos;: &apos;SimpleStrategy&apos;, &apos;replication_factor&apos;: 1}
&lt;p&gt;;&lt;br/&gt;
CREATE  TABLE space1.table1(a int, b int, c text,primary key(a,b));&lt;br/&gt;
INSERT INTO space1.table1(a,b,c) VALUES(1,1,&apos;1&apos;);&lt;br/&gt;
// nodetool flush&lt;br/&gt;
DELETE FROM space1.table1 where a=1 and b=1;&lt;br/&gt;
// nodetool flush&lt;br/&gt;
SELECT * FROM space1.table1 where a=1 and b=1;&lt;/p&gt;

&lt;p&gt;This is much more fundamentally broken than this ticket suggests, but I&apos;m probably not the best person to investigate, since it looks to be a problem with IndexedSliceReader. Hopefully a git bisect with the updated test will blame a suitable candidate next time around &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;(assuming it isn&apos;t somehow still my fault)&lt;/p&gt;</comment>
                            <comment id="14266195" author="philipthompson" created="Tue, 6 Jan 2015 14:58:40 +0000"  >&lt;p&gt;Thanks for the better test. The new bisect was much cleaner, the only failure I saw was the expected one highlighted by the reporter. Here is the bisect output:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;362cc05352ec67e707e0ac790732e96a15e63f6b is the first bad commit
commit 362cc05352ec67e707e0ac790732e96a15e63f6b
Author: Sylvain Lebresne &amp;lt;sylvain@datastax.com&amp;gt;
Date:   Tue Oct 29 11:03:52 2013 +0100

    Push composites support in the storage engine

    patch by slebresne; reviewed by benedict &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; CASSANDRA-5417

:100644 100644 c0d0f0d243f0454c1b1926957634bb52165295aa dcc7e33b064e52d245d8c6ba5de887c74e0f0a00 M	CHANGES.txt
:040000 040000 da620b5b36e8ba6b97cdb8efe4f690692a85e15e 5dd1113af54ad7b90dd8694e462483bac6e7f985 M	src
:040000 040000 1fe1db9fca3bf03946828cdc917a0aef5bf7a9e1 3bf0563361febc821a357cf61b5a0760f5a8eca4 M	test
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14266220" author="benedict" created="Tue, 6 Jan 2015 15:08:48 +0000"  >&lt;p&gt;I had a quick debug, and it appears EOCs are the problem: the range tombstone has an EOC of start, but the SliceQuery has an EOC of NONE, and the SimpleBlockFetcher skips over every atom &amp;lt;= the slice start. But the name of a range tombstone is only its start, so this is considered prior to the slice&apos;s start, even though it stretches across the slice&apos;s range.&lt;/p&gt;</comment>
                            <comment id="14269509" author="slebresne" created="Thu, 8 Jan 2015 16:29:53 +0000"  >&lt;p&gt;Yes, we&apos;re inconsistent in our use of the EOC for the start of slice/range tombstones. We should really always be using &lt;tt&gt;EOC.START&lt;/tt&gt; (the same way we use &lt;tt&gt;EOC.END&lt;/tt&gt; for the end), but for bad historical reasons we&apos;re using &lt;tt&gt;EOC.NONE&lt;/tt&gt;.  In 2.0 we&apos;re fine because we&apos;re consistently using &lt;tt&gt;EOC.NONE&lt;/tt&gt; for both slices and range tombstones (which is ok in practice, even though it&apos;s somewhat unlogical). In 2.1 however, range tombstones have somehow been &quot;fixed&quot; to use &lt;tt&gt;EOC.START&lt;/tt&gt; but slices haven&apos;t. Anyway, the right fix is basically to finish the job and use &lt;tt&gt;EOC.START&lt;/tt&gt; for slices too (it&apos;s an oversight of mine that this hasn&apos;t been done before). Attaching simple patch that does that (along with the test above as a unit test).&lt;/p&gt;</comment>
                            <comment id="14272427" author="benedict" created="Sat, 10 Jan 2015 09:58:47 +0000"  >&lt;p&gt;ISTM this could still affect thrift users? If they insert a range tombstone that spans a non-singleton range, and query a slice starting in the middle of that range...?&lt;/p&gt;

&lt;p&gt;Further, if &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6237&quot; title=&quot;Allow range deletions in CQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6237&quot;&gt;&lt;del&gt;CASSANDRA-6237&lt;/del&gt;&lt;/a&gt; appears sometime soon, we could continue to break this with:&lt;/p&gt;

&lt;p&gt;INSERT INTO space1.table1(a,b,c) VALUES(1,1,&apos;1&apos;);&lt;br/&gt;
// nodetool flush&lt;br/&gt;
DELETE FROM space1.table1 where a=1 and b &amp;gt; 0;&lt;br/&gt;
// nodetool flush&lt;br/&gt;
SELECT * FROM space1.table1 where a=1 and b=1;&lt;/p&gt;</comment>
                            <comment id="14273641" author="slebresne" created="Mon, 12 Jan 2015 14:26:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;If they insert a range tombstone that spans a non-singleton range, and query a slice starting in the middle of that range...?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right. I looked at your previous comment and focused on the EOC thing because that&apos;s something I&apos;ve wanted (and forgot) to change for a long time, but that&apos;s actually not the problem. It&apos;s inconsistent and I think we should fix it at least in 2.1 but the fact it fixes the test above is incidental and a slightly modified version of the test (including in the patch) exhibits the bug of this ticket even with the EOC &quot;fix&quot;. I was further lead astray by the fix version: the underlying bug does affect 2.0 as well, it&apos;s just that particular example that does not.&lt;/p&gt;

&lt;p&gt;The problem is indeed that IndexSliceReader don&apos;t include those range tombstones that does intersect with the queried slices but don&apos;t start within said slice. Attaching v2 patches to fix that. The 2.0 patch is smaller because:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;2.1 is a little bit more careful to not create cell objects for stuff it doesn&apos;t need to and as a consequence require a bit more code.&lt;/li&gt;
	&lt;li&gt;the 2.1 patch includes a unit test (a small variation on the test above but such that the range tombstone starts strictly before the queried slice to avoid having the EOC business shadow the important issue). 2.0 doesn&apos;t have CQLTester so I&apos;ll push the dtest when this is committed.&lt;/li&gt;
	&lt;li&gt;I&apos;ve included the v1 fixes in the 2.1 patch because it&apos;s the right thing to do. I&apos;ve left 2.0 alone however since it&apos;s less inconsistent than 2.1 on that point.&lt;/li&gt;
	&lt;li&gt;For some reason the indexed case of SSTablesNamesIterator has the same problem. 2.0 and the non-indexed case do the right thing however so it&apos;s an oversight.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="14274235" author="iamaleksey" created="Mon, 12 Jan 2015 21:55:54 +0000"  >&lt;p&gt;This is blocking the 2.0.12 release now.&lt;/p&gt;</comment>
                            <comment id="14275644" author="thobbs" created="Tue, 13 Jan 2015 18:16:57 +0000"  >&lt;p&gt;So, I may be missing something, but it seems like we still have a problem.  A range tombstone can start far enough before the slice start that it gets a different index entry, in which case we won&apos;t ever see it.  It seems like to handle arbitrary range tombstones with the current on-disk format, we would need to read every RT before the slice start to check for overlap.  Normally, for CQL3, this isn&apos;t a problem, because RTs only cover a row.  But with slice deletions in Thrift, we should be able to see this problem.&lt;/p&gt;

&lt;p&gt;Am I missing something about how we handle this, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14275650" author="benedict" created="Tue, 13 Jan 2015 18:21:15 +0000"  >&lt;p&gt;There is already a bunch of ugliness that attempts to address this on flushing. Whether or not it works, though, I&apos;m not certain &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14275732" author="thobbs" created="Tue, 13 Jan 2015 19:16:58 +0000"  >&lt;p&gt;Ah, nevermind, this comment explains how that&apos;s handled pretty well: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3708?focusedCommentId=13258303&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13258303&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-3708?focusedCommentId=13258303&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13258303&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14275869" author="thobbs" created="Tue, 13 Jan 2015 20:22:39 +0000"  >&lt;p&gt;+1 with a few nits:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;In &lt;tt&gt;IndexSliceReader.fetchMoreData()&lt;/tt&gt;, it seems like &lt;tt&gt;gotSome&lt;/tt&gt; should only be set to true if we read a non-RangeTombstone.  However, that&apos;s a minor optimization (if I&apos;m correct) and shouldn&apos;t affect correctness, so I won&apos;t block the patch for that.&lt;/li&gt;
	&lt;li&gt;In the 2.1 patch, &lt;tt&gt;nextKind&lt;/tt&gt; is a bit of a strange name.  I suggest &lt;tt&gt;nextFlags&lt;/tt&gt; instead.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;CellNameType.readNextFully()&lt;/tt&gt; is also a confusing name.  It seems like &lt;tt&gt;nextNameIsNotEmpty()&lt;/tt&gt; would be more accurate?&lt;/li&gt;
	&lt;li&gt;In the 2.0 patch, indentation is off for the comments in the last two hunks&lt;/li&gt;
	&lt;li&gt;A couple of typos: &quot;maskes&quot; in AtomDeserializer, &quot;prefecthed&quot; in IndexSliceReader (2.1 patch),&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14276794" author="slebresne" created="Wed, 14 Jan 2015 11:14:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;In IndexSliceReader.fetchMoreData(), it seems like gotSome should only be set to true if we read a non-RangeTombstone.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, any range tombstone we add to &lt;tt&gt;blockColumns&lt;/tt&gt; should be absolutely be returned and if we don&apos;t set &lt;tt&gt;gotSome&lt;/tt&gt;, &lt;tt&gt;getNextBlock&lt;/tt&gt; might well return &lt;tt&gt;false&lt;/tt&gt;, which would make &lt;tt&gt;fetchMoreData&lt;/tt&gt; return &lt;tt&gt;false&lt;/tt&gt; and the overal iterator skip some range tombstones it shouldn&apos;t. But the attached patches do have a bug in that they forget to set it to &lt;tt&gt;true&lt;/tt&gt; in the added code so I fixed that. That said, I realized that &lt;tt&gt;gotSome&lt;/tt&gt; could really be remove in favor of testing if &lt;tt&gt;blockColumns.isEmpty()&lt;/tt&gt; so I&apos;ll commit that simplification (as it&apos;s also less error prone).  &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In the 2.1 patch, nextKind is a bit of a strange name. I suggest nextFlags instead.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, &lt;tt&gt;nextFlags&lt;/tt&gt; was my initial choice but we have another thing called &lt;tt&gt;flag&lt;/tt&gt; in that class so I feared this would be confusing. Anyway, it&apos;s probably not a big deal and I agree that &lt;tt&gt;nextKind&lt;/tt&gt; is weird so I went with &lt;tt&gt;nextFlags&lt;/tt&gt;.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;CellNameType.readNextFully() is also a confusing name.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Maybe, though the reason is that its main goal was to guarantee the name was read from the underlying &lt;tt&gt;InputStream&lt;/tt&gt;. But I actually realized that it&apos;s not needed: we always call &lt;tt&gt;nextIsRangeTombstone()&lt;/tt&gt; after &lt;tt&gt;compareNext()&lt;/tt&gt; anyway in &lt;tt&gt;AtomDeserializer&lt;/tt&gt; so the name will have been read anyway and we can ignore that method entirely. Committed with that simplication.&lt;/p&gt;</comment>
                            <comment id="14493572" author="itayadler" created="Tue, 14 Apr 2015 05:08:53 +0000"  >&lt;p&gt;I still experience this issue in version 2.0.14.&lt;br/&gt;
To make sure I experience the same issue here&apos;s what happens to me:&lt;br/&gt;
I have a column family &quot;events&quot;, with a primary key user_id and clustering_key created_at (with ordering by created_at).&lt;br/&gt;
I deleted rows for some primary_key, and when I query with the primary_key I get no results back, but when I query it&lt;br/&gt;
with the primary key and a range on the created_at, I still get back the data.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12908830">CASSANDRA-10618</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12691650" name="8558-v2_2.0.txt" size="4399" author="slebresne" created="Mon, 12 Jan 2015 14:26:46 +0000"/>
                            <attachment id="12691651" name="8558-v2_2.1.txt" size="16676" author="slebresne" created="Mon, 12 Jan 2015 14:26:46 +0000"/>
                            <attachment id="12690876" name="8558.txt" size="4329" author="slebresne" created="Thu, 8 Jan 2015 16:29:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23xjr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328841">2.1.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>philipthompson</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>