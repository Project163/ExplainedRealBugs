<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:55:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7357] Cleaning up snapshots on startup leftover from repairs that got interrupted</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7357</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When a repair is interrupted, such as a restart, it can leave a snapshot behind on disk.  These could be checked for and cleared possibly on startup.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12718628">CASSANDRA-7357</key>
            <summary>Cleaning up snapshots on startup leftover from repairs that got interrupted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pauloricardomg">Paulo Motta</assignee>
                                    <reporter username="stephen-juk">Stephen Johnson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Jun 2014 13:24:35 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:43 +0000</updated>
                            <resolved>Wed, 22 Jul 2015 04:22:27 +0000</resolved>
                                        <fixVersion>2.1.9</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>3.0 alpha 1</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14627167" author="pauloricardomg" created="Tue, 14 Jul 2015 22:28:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; do you think we could somehow benefit from repair tracing here (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5483&quot; title=&quot;Repair tracing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5483&quot;&gt;&lt;del&gt;CASSANDRA-5483&lt;/del&gt;&lt;/a&gt;), or a simple scan over the snapshot directory during startup should do the job?&lt;/p&gt;</comment>
                            <comment id="14627291" author="pauloricardomg" created="Tue, 14 Jul 2015 23:45:51 +0000"  >&lt;p&gt;hmm, nevermind, after closer inspection I verified repair tracing is an optional feature so we can&apos;t rely on that for cleaning up repair leftover snapshots.&lt;br/&gt;
the simplest solution here would be to add a &quot;repair-&quot; prefix to snapshots originated from repair, but then this could delete user snapshots with this same prefix. other options include adding a flag to the snapshot indicating it originated from a repair session, or persist somewhere repairs in progress and clean up snapshots from these repairs on startup (this would be the most elegant solution I guess).&lt;/p&gt;</comment>
                            <comment id="14628641" author="pauloricardomg" created="Wed, 15 Jul 2015 20:07:23 +0000"  >&lt;p&gt;added a new boolean option &quot;ephemeral&quot; (default=false) to ColumnFamilyStore.snapshot. if this option is enabled, an ephemeral marker file is created in the snapshot directory. during node initialization, all snapshots with the &quot;ephemeral mark&quot; are cleared. &lt;br/&gt;
then, modified repair to use ephemeral snapshot. so, in case a repair fails and does not clean its snapshot, it will be cleared during next node startup.&lt;/p&gt;

&lt;p&gt;could you please review, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt;? will port to 2.2 and 2.0 after review.&lt;/p&gt;</comment>
                            <comment id="14629996" author="yukim" created="Thu, 16 Jul 2015 16:55:32 +0000"  >&lt;p&gt;I like the approache and overall patch looks good.&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-7357-2.1-testall/5/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; and &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-7357-2.1-dtest/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; seem good too.&lt;/p&gt;

&lt;p&gt;One thing that I suggest is doing &lt;tt&gt;clearEphemeralSnapshots&lt;/tt&gt; inside &lt;tt&gt;ColumnFamilyStore.scrubDataDirectories&lt;/tt&gt; before actually opening tables.&lt;br/&gt;
That way the code will look more orgazined.&lt;/p&gt;</comment>
                            <comment id="14632023" author="pauloricardomg" created="Fri, 17 Jul 2015 22:23:16 +0000"  >&lt;p&gt;As suggested, I added the clear ephemeral snapshot logic to ColumnFamilyStore.scrubDataDirectories. Code looks cleaner now.&lt;/p&gt;

&lt;p&gt;I found a minor bug with indexed CFs, since a marker file was being created twice (once for the original CFS, and other for the indexed CFS), so I adjusted test to use a indexed CF.&lt;/p&gt;

&lt;p&gt;Attached updated 2.1, 2.2 and trunk patches. Trunk patch uses the new storage engine for testing.&lt;/p&gt;

&lt;p&gt;Test links:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-7357-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1 dtests&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-7357-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1 utests&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-cassandra-7357-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 dtests&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-cassandra-7357-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2 utests&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-cassandra-7357-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk dtests&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-cassandra-7357-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk utests&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(cc: &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="14636194" author="yukim" created="Wed, 22 Jul 2015 04:22:27 +0000"  >&lt;p&gt;Patch and tests looks good to me. +1.&lt;br/&gt;
Committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12755867">CASSANDRA-8327</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396827</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 17 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1wbhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>396946</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>