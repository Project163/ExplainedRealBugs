<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:41:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6488] Batchlog writes consume unnecessarily large amounts of CPU on vnodes clusters</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6488</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The cloneTokenOnlyMap call in StorageProxy.getBatchlogEndpoints causes enormous amounts of CPU to be consumed on clusters with many vnodes. I created a patch to cache this data as a workaround and deployed it to a production cluster with 15,000 tokens. CPU consumption drop to 1/5th. This highlights the overall issues with cloneOnlyTokenMap() calls on vnodes clusters. I&apos;m including the maybe-not-the-best-quality workaround patch to use as a reference, but cloneOnlyTokenMap is a systemic issue and every place it&apos;s called should probably be investigated.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12684588">CASSANDRA-6488</key>
            <summary>Batchlog writes consume unnecessarily large amounts of CPU on vnodes clusters</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="rbranson">Rick Branson</assignee>
                                    <reporter username="rbranson">Rick Branson</reporter>
                        <labels>
                    </labels>
                <created>Sat, 14 Dec 2013 00:49:08 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:57 +0000</updated>
                            <resolved>Tue, 17 Dec 2013 14:50:05 +0000</resolved>
                                        <fixVersion>1.2.13</fixVersion>
                    <fixVersion>2.0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13848115" author="rbranson" created="Sat, 14 Dec 2013 00:51:03 +0000"  >&lt;p&gt;CPU usage dropping on a production cluster after the attached patch is rolled out.&lt;/p&gt;</comment>
                            <comment id="13848378" author="jbellis" created="Sat, 14 Dec 2013 15:38:08 +0000"  >&lt;p&gt;v2 to move the caching logic inside cloneOnlyTokenMap&lt;/p&gt;</comment>
                            <comment id="13848379" author="jbellis" created="Sat, 14 Dec 2013 15:39:30 +0000"  >&lt;p&gt;NB: I&apos;m not sure what the changes to candidates/chosenEndpoints do so I&apos;ve left that out for now.&lt;/p&gt;</comment>
                            <comment id="13848573" author="iamaleksey" created="Sun, 15 Dec 2013 10:24:13 +0000"  >&lt;p&gt;v3 merges both and has some minor (stylistic) changes to SP on top.&lt;/p&gt;</comment>
                            <comment id="13848575" author="iamaleksey" created="Sun, 15 Dec 2013 10:31:15 +0000"  >&lt;p&gt;Committed in 4be9e6720d9f94a83aa42153c3e71ae1e557d2d9.&lt;/p&gt;</comment>
                            <comment id="13849261" author="mshuler" created="Mon, 16 Dec 2013 16:08:21 +0000"  >&lt;p&gt;This introduced a failure in BootStrapperTest:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;test:
     [echo] running unit tests
    [mkdir] Created dir: /home/mshuler/git/cassandra/build/test/cassandra
    [mkdir] Created dir: /home/mshuler/git/cassandra/build/test/output
    [junit] WARNING: multiple versions of ant detected in path &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; junit 
    [junit]          jar:file:/usr/share/ant/lib/ant.jar!/org/apache/tools/ant/Project.class
    [junit]      and jar:file:/home/mshuler/git/cassandra/build/lib/jars/ant-1.6.5.jar!/org/apache/tools/ant/Project.class
    [junit] Testsuite: org.apache.cassandra.dht.BootStrapperTest
    [junit] Tests run: 4, Failures: 1, Errors: 0, Time elapsed: 6.177 sec
    [junit] 
    [junit] ------------- Standard Error -----------------
    [junit]  WARN 09:47:46,135 No host ID found, created 9019bb70-4d6e-4cf6-b730-140ff5ae4be5 (Note: This should happen exactly once per node).
    [junit]  WARN 09:47:46,262 Generated random token [d9180feb2e806704effa4024e8f4c631]. Random tokens will result in an unbalanced ring; see http:&lt;span class=&quot;code-comment&quot;&gt;//wiki.apache.org/cassandra/Operations
&lt;/span&gt;    [junit] ------------- ---------------- ---------------
    [junit] Testcase: testSourceTargetComputation(org.apache.cassandra.dht.BootStrapperTest):   FAILED
    [junit] expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;
    [junit] junit.framework.AssertionFailedError: expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;
    [junit]     at org.apache.cassandra.dht.BootStrapperTest.testSourceTargetComputation(BootStrapperTest.java:212)
    [junit]     at org.apache.cassandra.dht.BootStrapperTest.testSourceTargetComputation(BootStrapperTest.java:173)
    [junit] 
    [junit] 
    [junit] Test org.apache.cassandra.dht.BootStrapperTest FAILED

BUILD FAILED
/home/mshuler/git/cassandra/build.xml:1113: The following error occurred &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; executing &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; line:
/home/mshuler/git/cassandra/build.xml:1078: Some unit test(s) failed.

Total time: 9 seconds
((4be9e67...)|BISECTING)mshuler@hana:~/git/cassandra$ git bisect bad
4be9e6720d9f94a83aa42153c3e71ae1e557d2d9 is the first bad commit
commit 4be9e6720d9f94a83aa42153c3e71ae1e557d2d9
Author: Aleksey Yeschenko &amp;lt;aleksey@apache.org&amp;gt;
Date:   Sun Dec 15 13:29:56 2013 +0300

    Improve batchlog write performance with vnodes
    
    patch by Jonathan Ellis and Rick Branson; reviewed by Aleksey Yeschenko
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; CASSANDRA-6488

:100644 100644 e5865925f160faabc2506c3a5aac9985c17c1658 b55393b2ed138011bab52f95f2e9b52107709938 M      CHANGES.txt
:040000 040000 dea10aa8044e10eb60002e75f2586a9c8e94b647 7030c09f9713bd3e342e4e012c59b09c86b79a42 M      src
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13849273" author="mshuler" created="Mon, 16 Dec 2013 16:18:31 +0000"  >&lt;p&gt;I&apos;m working on the cassandra-2.0 branch, since I didn&apos;t mention it above. Around the same time, LeaveAndBootstrapTest, MoveTest, and RelocateTest were new failures - I&apos;m looking at those&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/job/cassandra-2.0_test/49/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/cassandra-2.0_test/49/console&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13849282" author="iamaleksey" created="Mon, 16 Dec 2013 16:22:44 +0000"  >&lt;p&gt;So, the caching part. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; can you have a look? If not, I will, later, but it&apos;s potentially 1.2.13 vote-affecting.&lt;/p&gt;</comment>
                            <comment id="13849291" author="mshuler" created="Mon, 16 Dec 2013 16:31:26 +0000"  >&lt;p&gt;Commit bb09d3c fully passed all the unit tests in cassandra-2.0 branch.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/job/cassandra-2.0_test/47/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/cassandra-2.0_test/47/console&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13849312" author="mshuler" created="Mon, 16 Dec 2013 16:47:04 +0000"  >&lt;p&gt;Those same tests look like new failures with this commit in cassandra-1.2 branch also&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/job/cassandra-1.2_test/32/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/cassandra-1.2_test/32/console&lt;/a&gt;&lt;br/&gt;
vs.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/job/cassandra-1.2_test/33/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/cassandra-1.2_test/33/console&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;(edit for clarity) New unit test failures in c-2.0 and c-1.2 branches with this commit:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;BootStrapperTest&lt;/li&gt;
	&lt;li&gt;LeaveAndBootstrapTest&lt;/li&gt;
	&lt;li&gt;MoveTest&lt;/li&gt;
	&lt;li&gt;RelocateTest&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13850491" author="iamaleksey" created="Tue, 17 Dec 2013 14:25:01 +0000"  >&lt;p&gt;Separates TM.cloneOnlyTokenMap() and TM.cachedOnlyTokenMap() and only switched SP.getBatchlogEndpoints() and ARS.getNaturalEndpoints() to use the cached version.&lt;/p&gt;

&lt;p&gt;They aren&apos;t the only methods that &lt;b&gt;don&apos;t&lt;/b&gt; mutate the returned metadata, but going through the rest of the usages and optimizing those can wait.&lt;/p&gt;

&lt;p&gt;Also fixes a regression from 6435 in TM.cachedOnlyTokenMap().&lt;/p&gt;</comment>
                            <comment id="13850518" author="jbellis" created="Tue, 17 Dec 2013 14:50:05 +0000"  >&lt;p&gt;updated comments and committed&lt;/p&gt;</comment>
                            <comment id="13850623" author="mshuler" created="Tue, 17 Dec 2013 16:18:16 +0000"  >&lt;p&gt;cassandra-1.2 branch, commit 13348c4, is passing these 4 unit tests:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/job/cassandra-1.2_test/35/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/cassandra-1.2_test/35/console&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;cassandra-2.0 is passing these, also&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/job/cassandra-2.0_test/50/console&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/cassandra-2.0_test/50/console&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Thanks all!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12619106" name="6488-fix.txt" size="3861" author="aleksey" created="Tue, 17 Dec 2013 14:25:01 +0000"/>
                            <attachment id="12618736" name="6488-rbranson-patch.txt" size="5350" author="rbranson" created="Sat, 14 Dec 2013 00:49:56 +0000"/>
                            <attachment id="12618777" name="6488-v2.txt" size="6280" author="jbellis" created="Sat, 14 Dec 2013 15:38:08 +0000"/>
                            <attachment id="12618811" name="6488-v3.txt" size="10050" author="aleksey" created="Sun, 15 Dec 2013 10:24:13 +0000"/>
                            <attachment id="12618737" name="graph (21).png" size="41555" author="rbranson" created="Sat, 14 Dec 2013 00:51:03 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[rbranson]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363660</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 49 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qonz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363966</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325022">1.2.11</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>