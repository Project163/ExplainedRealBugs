<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:13:37 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15013] Prevent client requests from blocking on executor task queue</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15013</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This is a follow-up ticket out of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14855&quot; title=&quot;Message Flusher scheduling fell off the event loop, resulting in out of memory&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14855&quot;&gt;&lt;del&gt;CASSANDRA-14855&lt;/del&gt;&lt;/a&gt;, to make the Flusher queue bounded, since, in the current state, items get added to the queue without any checks on queue size, nor with any checks on netty outbound buffer to check the isWritable state.&lt;br/&gt;
We are seeing this issue hit our production 3.0 clusters quite often.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13214422">CASSANDRA-15013</key>
            <summary>Prevent client requests from blocking on executor task queue</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sumanth.pasupuleti">Sumanth Pasupuleti</assignee>
                                    <reporter username="sumanth.pasupuleti">Sumanth Pasupuleti</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Thu, 7 Feb 2019 17:22:13 +0000</created>
                <updated>Thu, 3 Sep 2020 13:16:15 +0000</updated>
                            <resolved>Mon, 15 Jul 2019 13:55:54 +0000</resolved>
                                        <fixVersion>3.0.19</fixVersion>
                    <fixVersion>3.11.5</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Messaging/Client</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="16763176" author="sumanth.pasupuleti" created="Fri, 8 Feb 2019 00:00:35 +0000"  >&lt;p&gt;Working on a fix to make the Flusher queue bounded.&lt;/p&gt;</comment>
                            <comment id="16763453" author="benedict" created="Fri, 8 Feb 2019 09:50:53 +0000"  >&lt;p&gt;Have you tested that this approach resolves your issues?&lt;/p&gt;

&lt;p&gt;There&apos;s a deadlock that could occur with this change, as the request executor is also blocking, so the Netty event loop could block for room on the request executor, and the request executor could block on queueing to the Flusher (that will be executed on the eventLoop).&lt;/p&gt;

&lt;p&gt;Probably we should be disabling reads from the inbound channel during overflow, in both cases, rather than blocking either the eventLoop or the requestExecutor.  The behaviour of blocking the eventLoop could also be the cause of your flusher queue growing so large.&lt;/p&gt;</comment>
                            <comment id="16765356" author="sumanth.pasupuleti" created="Mon, 11 Feb 2019 20:17:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; By making the flusher queue bounded, my intention is &lt;b&gt;not&lt;/b&gt; to make the request executor blocked on enqueuing if the queue is full, rather it would &lt;em&gt;drop&lt;/em&gt; the response if the flusher queue is full. This should avoid the deadlock situation you are referring to, I believe.&lt;/p&gt;</comment>
                            <comment id="16765781" author="benedict" created="Tue, 12 Feb 2019 08:20:33 +0000"  >&lt;p&gt;There is a potential semantic change here that could have negative consequences for clients, so we need to be careful.  &lt;/p&gt;

&lt;p&gt;Presently, clients can expect a response to every message they send to the server while they are connected; the server handles time outs, failures etc. and makes sure to respond to the client in some way (unless the connection is lost).  If we change this, we would need to corroborate client behaviour - do they all gracefully timeout outstanding requests, for instance, or do they kill them on a per-connection basis?&lt;/p&gt;

&lt;p&gt;In either case, though, it is a shame to discard work that we&apos;ve gone to the effort of performing.  From a cluster stability perspective, this is more likely to put the cluster under steadily more pressure, rather than less, as the client will no doubt want to retry this work.  It is better to either discard work that has yet to be initiated, or to try not to discard work at all and provide back pressure signals to the client.&lt;/p&gt;

&lt;p&gt;I think it would also be more relevant as an initial step to remove the blocking behaviour on incoming, so that the eventLoop can always service the outgoing queue to prevent this build up.  There&apos;s a strong chance the build up of outgoing messages you see is down to the eventLoop that must process it being blocked on offering work to the &lt;tt&gt;requestExecutor&lt;/tt&gt;, and by removing this block the outgoing queue will not accumulate so readily.&lt;/p&gt;

&lt;p&gt;There are two options if we do this: stop reading from incoming channels when the &lt;tt&gt;requestExecutor&lt;/tt&gt; is full, or throw &lt;tt&gt;OverloadedException&lt;/tt&gt;.  In my opinion, this is exactly what TCP back pressure is for, but we also have a world where clients have been depending on the server trying its best to never push back, so they have inadequate queueing models internally, with no support for noticing or handling this back pressure.  &lt;/p&gt;

&lt;p&gt;This to me is a design flaw that should be addressed in clients, but we could mitigate it for now by increasing the size of our &lt;tt&gt;requestExecutor&lt;/tt&gt; queue (which is actually unnecessarily small), or even making it unbounded and simply tracking the total number of bytes we have read off the wire but not answered.  Perhaps we could even make the behaviour of &lt;tt&gt;OverloadedException&lt;/tt&gt; vs back pressure a connection-configurable option, so that clients with poor flow control can utilise &lt;tt&gt;OverloadedException&lt;/tt&gt; to handle this, and those with better control can use normal TCP flow control mechanisms.&lt;/p&gt;

&lt;p&gt;What do you think?&lt;/p&gt;</comment>
                            <comment id="16768865" author="sumanth.pasupuleti" created="Fri, 15 Feb 2019 02:02:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&#160;Your theory seems to be spot on (I have all the evidence supporting it from the heap dumps and thread dumps now).&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Evidence of requestExecutor queue full (indicated by taskPermit), and all 128 workers busy (indicated by workPermit)&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;a id=&quot;12958809_thumb&quot; href=&quot;https://issues.apache.org/jira/secure/attachment/12958809/12958809_RequestExecutorQueueFull.png&quot; title=&quot;RequestExecutorQueueFull.png&quot; file-preview-type=&quot;image&quot; file-preview-id=&quot;12958809&quot; file-preview-title=&quot;RequestExecutorQueueFull.png&quot;&gt;&lt;img style=&quot;border: 0px solid black&quot; role=&quot;presentation&quot;/&gt;&lt;/a&gt;&lt;/span&gt; &lt;/li&gt;
	&lt;li&gt;Evidence of blocked epollEventLoopGroup threads (from heap)&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;a id=&quot;12958807_thumb&quot; href=&quot;https://issues.apache.org/jira/secure/attachment/12958807/12958807_BlockedEpollEventLoopFromHeapDump.png&quot; title=&quot;BlockedEpollEventLoopFromHeapDump.png&quot; file-preview-type=&quot;image&quot; file-preview-id=&quot;12958807&quot; file-preview-title=&quot;BlockedEpollEventLoopFromHeapDump.png&quot;&gt;&lt;img style=&quot;border: 0px solid black&quot; role=&quot;presentation&quot;/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;Evidence of blocked epollEventLoopGroup threads (from thread dump)&lt;br/&gt;
&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;a id=&quot;12958808_thumb&quot; href=&quot;https://issues.apache.org/jira/secure/attachment/12958808/12958808_BlockedEpollEventLoopFromThreadDump.png&quot; title=&quot;BlockedEpollEventLoopFromThreadDump.png&quot; file-preview-type=&quot;image&quot; file-preview-id=&quot;12958808&quot; file-preview-title=&quot;BlockedEpollEventLoopFromThreadDump.png&quot;&gt;&lt;img style=&quot;border: 0px solid black&quot; role=&quot;presentation&quot;/&gt;&lt;/a&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16768875" author="sumanth.pasupuleti" created="Fri, 15 Feb 2019 02:10:42 +0000"  >&lt;p&gt;Regarding the fix,&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Changes to requestExecutor queue&#160;size&lt;br/&gt;
a. Making it unbounded - tracking the total number of bytes we have read off the wire but not answered&lt;br/&gt;
b. Keep it bounded, by giving a bigger size&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think both options are good, but to keep things simple I am&#160;inclined towards (b) - increasing the default queue size&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;When requestExecutor is full, based on the new configuration option, either&lt;br/&gt;
a. stop reading from incoming channels (TCP back pressure)&lt;br/&gt;
b. Throw OverloadedException&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I think we should do both, and have a configurable as&#160;you suggest.&lt;/p&gt;</comment>
                            <comment id="16768913" author="jasobrown" created="Fri, 15 Feb 2019 03:50:42 +0000"  >&lt;p&gt;I agree with upping the max queue depth (or unbounded plus size monitoring) as well as stop reading from the socket (by setting netty&apos;s &lt;tt&gt;autoRead&lt;/tt&gt; to false). I&apos;m not, however, convinced about adding yet another configuration option; adding&#160;more configs options only complicates the lives of operators. How will an operator know how to set it most appropriately to their use case(s)? We should choose the best solution, &lt;b&gt;document it&lt;/b&gt;,&#160;and go with that as a built-in behavior. (Note: I&apos;m amenable to throwing the OverloadedException, as well.)&lt;/p&gt;</comment>
                            <comment id="16769041" author="benedict" created="Fri, 15 Feb 2019 07:46:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt;: FWIW, I was proposing a &lt;em&gt;client configurable&lt;/em&gt; option.  So operators shouldn&apos;t need to do anything - in fact, perhaps only client &lt;em&gt;authors&lt;/em&gt; would ever specify this, though some might make this available to the developer using their library if their application semantics prefer one or the other.&lt;/p&gt;

&lt;p&gt;I don&apos;t mind which we pick as the default, and don&apos;t mind if this has a user configurable option, but while tcp back pressure should be the preferred mechanism some clients probably don&apos;t behave well in the face of it, and for these clients specifying OverloadedException behaviour is probably useful.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;: Also, if you do the work of implementing back pressure, I am happy to make the change to monitor bytes instead of queued items.  I don&apos;t think it should be significantly more challenging, and it would permit us to more tightly bound system resource consumption.&lt;/p&gt;</comment>
                            <comment id="16769292" author="jasobrown" created="Fri, 15 Feb 2019 13:02:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Ahhhh, I see now that&apos;s what you intended by &lt;tt&gt;connection-configurable option&lt;/tt&gt;. I&apos;m fine with that.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if specifying the &apos;backpressure type&apos; would require a change to the native protocol. I think it would be most appropriate in the OPTIONS section (and thus &lt;tt&gt;OptionasMessage&lt;/tt&gt;), but I might be mistaken.&#160; However, I wonder if we should break that work out into a separate ticket to unblock the other work here, so that it can be backported and fixed in production. wdyt?&lt;/p&gt;</comment>
                            <comment id="16769310" author="benedict" created="Fri, 15 Feb 2019 13:28:33 +0000"  >&lt;p&gt;I guess maybe let&apos;s wait and see how much more complicated it would be?  You&apos;re right that the &lt;tt&gt;OptionsMessage&lt;/tt&gt; should be sufficient for supplying the option, and I think the complicated bit is going to be negotiating safely with the &lt;tt&gt;requestExecutor&lt;/tt&gt; when we should start and stop reading. &lt;/p&gt;

&lt;p&gt;If it turns out to be super challenging, by all means let&apos;s make it a 4.0-only follow-up, but if (as I suspect) it&apos;s nominally extra work, I think it&apos;s better to tie up the work while there&apos;s pressure to do so. WDYT?&lt;/p&gt;</comment>
                            <comment id="16769331" author="jasobrown" created="Fri, 15 Feb 2019 13:53:56 +0000"  >&lt;p&gt;Yup, I agree the harder part, programming wise, is &lt;tt&gt;requestExecutor&lt;/tt&gt;&#160;stuffs, and let&apos;s plow through that first. The &lt;tt&gt;OptionsMessage/client protocol work&lt;/tt&gt; is significantly easier, as I think we agree, but would that qualify as a change to the native protocol, for which we need to wait for a major rev (as in, 4.0)? Or are additive additions ok&#160;acceptable for&#160;previous native protocol versions? We might have a policy or general advice around this, but I don&apos;t know.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Either way, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt; has enough to work forward for now, and we can figure out the native protocol-impacting stuffs in parallel.&lt;/p&gt;</comment>
                            <comment id="16769335" author="benedict" created="Fri, 15 Feb 2019 13:56:06 +0000"  >&lt;p&gt;I would be OK with either approach.  There&apos;s no strong reason not to add a feature to the protocol that is optional, though - it&apos;s not actually a protocol change, just a behavioural change to a message that is permitted on the protocol today.  Since the riskiest change will be fixing the underlying bug, I&apos;d be in favour of at least supporting this option for clients in 3.0, if we intend to fix this behaviour that far back.&lt;/p&gt;

&lt;p&gt;But I&apos;m also comfortable with limiting the client option to 4.0&lt;/p&gt;
</comment>
                            <comment id="16769340" author="jasobrown" created="Fri, 15 Feb 2019 14:04:34 +0000"  >&lt;p&gt;Ahh, I just reread the &lt;tt&gt;doc/native_protocol_v5.spec&lt;/tt&gt;, and the OPTIONS are a semi-defined map, basically. I thought they were a fixed listing (primarily because we only support a fixed set of compression types). OK, so any version works for me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.&lt;/p&gt;</comment>
                            <comment id="16806412" author="sumanth.pasupuleti" created="Mon, 1 Apr 2019 05:59:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; &lt;br/&gt;
Pull Request: &lt;a href=&quot;https://github.com/apache/cassandra/pull/308&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/308&lt;/a&gt;&lt;br/&gt;
Passing UTs: &lt;a href=&quot;https://circleci.com/gh/sumanth-pasupuleti/cassandra/261&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/sumanth-pasupuleti/cassandra/261&lt;/a&gt;&lt;br/&gt;
Passing JVM DTests: &lt;a href=&quot;https://circleci.com/gh/sumanth-pasupuleti/cassandra/260&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/sumanth-pasupuleti/cassandra/260&lt;/a&gt;&lt;br/&gt;
Passing DTests with vnodes: &lt;a href=&quot;https://circleci.com/gh/sumanth-pasupuleti/cassandra/262&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/sumanth-pasupuleti/cassandra/262&lt;/a&gt;&lt;br/&gt;
DTests without vnodes with two failures: &lt;a href=&quot;https://circleci.com/gh/sumanth-pasupuleti/cassandra/263&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/sumanth-pasupuleti/cassandra/263&lt;/a&gt; (looking into the two failures)&lt;/p&gt;</comment>
                            <comment id="16806963" author="benedict" created="Mon, 1 Apr 2019 16:32:46 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt; for the patch. &#160;I&apos;ve only taken a quick glance at it so far,&#160;but it looks pretty good, and I&apos;m looking forward to integrating it.&lt;/p&gt;

&lt;p&gt;There&apos;s only one substantive&#160;comment I have for the moment, which is that I think when we &lt;tt&gt;setAutoread(false)&lt;/tt&gt;, we need to not discard the message. &#160;We should perform only one of the two options; if we ever discard, I think we should always let the user know by throwing&#160;&lt;tt&gt;OverloadedException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;If we want to use back pressure without throwing away any messages that are over our limit, I can think of two fairly straight forward mechanisms,&#160;with the best being unfortunately quite difficult given our current Netty pipeline. &#160;&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Like we have done for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15066&quot; title=&quot;Improvements to Internode Messaging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15066&quot;&gt;&lt;del&gt;CASSANDRA-15066&lt;/del&gt;&lt;/a&gt;, we would ideally leave the message unparsed in&#160;the buffer until we have capacity to process it. &#160;&lt;/li&gt;
	&lt;li&gt;Alternatively, as an easier&#160;solution, we can unconditionally enqueue the message to the executor, assuming&#160;that we must have a fairly limited quantity of bytes we can overshoot by&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Also, as a point of consideration only, we &lt;em&gt;might&lt;/em&gt;&#160;also want to limit the number of bytes we have in-flight per-endpoint, rather than per-channel,&#160;to avoid a given host spamming the database with many connections. &#160;It&apos;s perhaps not a very good unit to limit by, either, since an IP address&#160;may host many applications, but an application can also open an arbitrary number of connections, and crowd out all other hosts... &#160;&lt;/p&gt;

&lt;p&gt;Just something to consider, I&apos;m not sure what the best constraints are here. &#160;Perhaps, similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15066&quot; title=&quot;Improvements to Internode Messaging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15066&quot;&gt;&lt;del&gt;CASSANDRA-15066&lt;/del&gt;&lt;/a&gt;, a very small per-connection limit that can always be consumed, to ensure progress on any given channel, with per-endpoint and global limits for when these are exceeded (though this is less obvious than for internode, as there could be many more clients connected, so it would be plausible for these low limits to consume a great deal in combination).&lt;/p&gt;

&lt;p&gt;It might be that we want to introduce the concept of an application identifier, so that users who want to run multiple applications per host can do so, while still ensuring QoS to other applications if one goes awry.&lt;/p&gt;</comment>
                            <comment id="16807988" author="sumanth.pasupuleti" created="Tue, 2 Apr 2019 18:16:35 +0000"  >&lt;p&gt;Thanks for the feedback &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;+1 on unconditionally enqueuing the message to the executor when we setAutoRead(false), and throwing OverloadedException each time a message is discarded. In other words, we would never discard a message if the client chose to go with backpressure option, rather we just setAutoRead(false) and process the message.&lt;/p&gt;

&lt;p&gt;Regarding in-flight per-endpoint, and having an application identifier, I like the suggestion, as it offers better guarantees on throttling client instances, however, I propose cutting a separate ticket for that work, and keeping the scope limited for this current ticket.&lt;/p&gt;</comment>
                            <comment id="16807994" author="benedict" created="Tue, 2 Apr 2019 18:22:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;In other words, we would never discard a message if the client chose to go with backpressure option&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;+1&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I propose cutting a separate ticket for that work, and keeping the scope limited for this current ticket&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;How about a middle ground: we implement the per-endpoint (IP address) limit&#160;(which would be&#160;easily generalised to incorporate an application identifier) in this patch, so that the logical behaviour of the message control flow&#160;isn&apos;t really revisited, we just have to change the inputs and introduce any client API changes in the&#160;follow-up patch?&lt;/p&gt;

&lt;p&gt;I personally have a preference for trying to get all of the logical semantics settled in the first patch, though I&apos;m not deeply wed to that.&lt;/p&gt;</comment>
                            <comment id="16813902" author="sumanth.pasupuleti" created="Tue, 9 Apr 2019 23:35:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Regarding the per-endpoint limit, we have had multiple back and forth discussions within our team, and since driver offers maxConnectionsPerHost option, it is quite possible for one client instance to have more than one connection to a given C* instance. I will be working on changes to implement the per-endpoint limit, in addition to per-connection and global limit.&lt;/p&gt;</comment>
                            <comment id="16819299" author="sumanth.pasupuleti" created="Tue, 16 Apr 2019 17:22:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; here is the PR that includes per-endpoint limit &lt;a href=&quot;https://github.com/apache/cassandra/pull/311/commits/a03cd0550118e3c1dc98694c0dc0ed84824853d1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/311/commits/a03cd0550118e3c1dc98694c0dc0ed84824853d1&lt;/a&gt;&lt;br/&gt;
This patch has a drawback of a slow leak (we never remove an endpoint from the endpoint inflight map) - looking for advice.&lt;/p&gt;</comment>
                            <comment id="16819331" author="benedict" created="Tue, 16 Apr 2019 17:42:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt; thanks for the update.  As to addressing the slow leak, I would propose the following:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Instead of a &lt;tt&gt;Map&amp;lt;InetAddress, AtomicLong&amp;gt;&lt;/tt&gt; in &lt;tt&gt;Dispatcher&lt;/tt&gt; have a &lt;tt&gt;Map&amp;lt;InetAddress, Dispatcher&amp;gt;&lt;/tt&gt; in &lt;tt&gt;Server.Initializer&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Add a reference count to the &lt;tt&gt;Dispatcher&lt;/tt&gt; as well as an atomic &lt;tt&gt;bytesInFlight&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;Server.Initializer.initChannel&lt;/tt&gt;, lookup the socket InetAddress:
	&lt;ol&gt;
		&lt;li&gt;If there is no &lt;tt&gt;Dispatcher&lt;/tt&gt; create one&lt;/li&gt;
		&lt;li&gt;If the &lt;tt&gt;Dispatcher&lt;/tt&gt; cannot increment its reference count, remove it from the map and goto (1)&lt;/li&gt;
		&lt;li&gt;Otherwise we&apos;ve taken ownership of the &lt;tt&gt;Dispatcher&lt;/tt&gt; and can use it&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;Then, in the &lt;tt&gt;Dispatcher&lt;/tt&gt;, override &lt;tt&gt;channelInactive&lt;/tt&gt; to decrement our reference count and remove ourselves from the map if we&apos;ve been freed&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This also marginally reduces the per-message cost of enforcing these constraints.  WDYT?&lt;/p&gt;</comment>
                            <comment id="16822372" author="sumanth.pasupuleti" created="Sat, 20 Apr 2019 06:05:06 +0000"  >&lt;p&gt;Updated patch: &lt;a href=&quot;https://github.com/apache/cassandra/pull/313&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/313&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Passing UTs and DTests: &lt;a href=&quot;https://circleci.com/workflow-run/31dabaa6-eab8-4f00-a711-f1b210bf7578&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/workflow-run/31dabaa6-eab8-4f00-a711-f1b210bf7578&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;. I learnt from your suggestion, &lt;tt&gt;Ref&lt;/tt&gt; class is useful for getting around the race conditions I was initially worried about, to evict endpoint from the map.&lt;br/&gt;
Attached patch evicts endpoint along the lines of your proposal, except that, I used a new class &lt;tt&gt;EndpointPayloadTracker&lt;/tt&gt;, in place of suggested class (&lt;tt&gt;Dispatcher&lt;/tt&gt;). Having Dispatcher mapped against endpoint makes it as 1:1 Dispatcher per endpoint, whereas currently it is one Dispatcher per Channel, and I rely on that association to store channel level inflight payload, which is then useful to turn off backpressure on a channel (one of the conditions I check to &lt;tt&gt;setAutoRead&lt;/tt&gt;(true) is when channel level inflight payload comes down to zero).&lt;/p&gt;

&lt;p&gt;A few other changes I have made as part of this updated patch&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Removed channel level threshold with the worry of too many config knobs (channel level, endpoint level, global level). So each time endpoint/global thresholds are exceeded, a channel is put backpressure on, or an overloadedexception is thrown.&lt;/li&gt;
	&lt;li&gt;In addition to memory based limit, added another tracker and limit check based on number of requests in flight - this is to keep a check on a situation where there are too many in-coming requests with small enough payload that get around memory limit checks, but result in blocking event loop threads.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16831069" author="benedict" created="Wed, 1 May 2019 15:35:15 +0000"  >&lt;p&gt;Hi Sumanth,&lt;/p&gt;

&lt;p&gt;Thanks for the updated patch. This is not a full review, just some initial feedback.&lt;/p&gt;

&lt;p&gt;First, I think we could do with revisiting the naming of a couple of things. The config parameters should probably be prefixed with native_transport for consistency, and the connection parameter should be shorter (since we encode every byte) and perhaps convey the intent - maybe THROW_ON_OVERLOAD?&lt;/p&gt;

&lt;p&gt;Secondly, the patch looks to have some data races when updating shared state. It might be sensible to reuse what we have already produced for this in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15066&quot; title=&quot;Improvements to Internode Messaging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15066&quot;&gt;&lt;del&gt;CASSANDRA-15066&lt;/del&gt;&lt;/a&gt; - if you look in &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/messaging-improvements&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this branch&lt;/a&gt; you will find a class called &lt;tt&gt;ResourceLimits&lt;/tt&gt; that we use to impose per-endpoint and global limits, which is exactly what you&#8217;re doing here. There&#8217;s not much sense in duplicating the work, so perhaps you can copy the class and use it in this patch; it shouldn&#8217;t change before we commit.&lt;/p&gt;

&lt;p&gt;Similarly, the accesses of &lt;tt&gt;requestPayloadInFlightPerEndpoint&lt;/tt&gt; need to be made atomic. In &lt;tt&gt;initChannel&lt;/tt&gt; this means grabbing the result of &lt;tt&gt;computeIfAbsent&lt;/tt&gt; and to &lt;tt&gt;tryRef&lt;/tt&gt; this - if we fail, we need to immediately remove the object you fetched from the map and try again (not just loop, else we may block on another thread removing it). In &lt;tt&gt;tidy&lt;/tt&gt; we need to remove the (key, value) pair to ensure we do not remove a newer object that has replaced us. Similarly for invocations of &lt;tt&gt;containsKey&lt;/tt&gt;, we need to instead invoke &lt;tt&gt;get&lt;/tt&gt; and check the result is not null.&lt;/p&gt;

&lt;p&gt;In general, in concurrent operation we need to access the shared state once up front, and only refresh it when necessary, as it can change underneath us at any time.&lt;/p&gt;

&lt;p&gt;Finally, we should remove the task queue length limit from &lt;tt&gt;requestExecutor&lt;/tt&gt; else this patch won&#8217;t actually stop us blocking the event loop.&lt;/p&gt;

&lt;p&gt;Look forward to giving the final patch a full review in the near future.&#160;&lt;/p&gt;</comment>
                            <comment id="16838232" author="sumanth.pasupuleti" created="Mon, 13 May 2019 03:18:30 +0000"  >&lt;p&gt;Thanks for the feedback &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;. I have incorporated it in the branch &lt;a href=&quot;https://github.com/sumanth-pasupuleti/cassandra/commits/15013_trunk_2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/sumanth-pasupuleti/cassandra/commits/15013_trunk_2&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;However, with this change, we will lose the ability to change the endpoint/global limits on a node on the fly, without restarting C* process.&lt;/p&gt;

&lt;p&gt;Added forceAllocate method to ResourceLimits, to accommodate backpressure scenario.&lt;br/&gt;
A few DTest failures, seemingly from race conditions on allocate/release. Working on figuring out where the race is coming from.&lt;br/&gt;
Dtest results:&lt;br/&gt;
&lt;a href=&quot;https://circleci.com/gh/sumanth-pasupuleti/cassandra/369#tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/sumanth-pasupuleti/cassandra/369#tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://circleci.com/gh/sumanth-pasupuleti/cassandra/368#tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/sumanth-pasupuleti/cassandra/368#tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16839326" author="benedict" created="Tue, 14 May 2019 11:25:49 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;.  I started reviewing your new changes, and part way through realised we could potentially simplify this all a great deal with a slightly different approach.  Namely, if we were to hash endpoints to a specific eventLoop when accepting the connection.  If we were to do this, we could have very simple per-thread accounting, and we could even aggregate all of the per-endpoint channels into a single flusher for stopping/starting together once they exceed their limits.  Everything would be single threaded, so our logic would be much simpler to reason about.&lt;/p&gt;

&lt;p&gt;This isn&apos;t without its tradeoffs - potentially users might have a setup with a single application node speaking to the cluster, but this would be a very peculiar system design to pair with Cassandra, and a single dedicated eventLoop for this node would still likely suffice for a majority of workloads.  We also have the potential issue of endpoint collisions, but if we use a cryptographic hash function this should only be a problem for a very small number of nodes (and if we ever find it is a real problem, we can remedy it)&lt;/p&gt;

&lt;p&gt;What do you think?  I&apos;m sorry for moving the goal posts suddenly, it just hadn&apos;t occurred to me until now.  My goal is only the best patch, so I&apos;m interested to hear your thoughts.&lt;/p&gt;</comment>
                            <comment id="16840266" author="benedict" created="Wed, 15 May 2019 10:08:24 +0000"  >&lt;p&gt;So, thinking on it a bit more, I don&apos;t think this would actually be a very large change, but it also wouldn&apos;t simplify things as much as I might like.  It might only save concurrency for endpoint resource allocation.  So I&apos;ll review the patch as it is, and we can consider after that if we want to make any further changes.&lt;/p&gt;

&lt;p&gt;It looks like I also made an error in my first skim of the patch, or I was looking at a different version - there&apos;s no need to set the queue limit to -1; Integer.MAX_VALUE is fine - if we hit that limit we have bigger problems &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="16840301" author="benedict" created="Wed, 15 May 2019 11:28:34 +0000"  >&lt;p&gt;I&apos;ve pushed some minor suggestions &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/15013-suggestions&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; around naming:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Tried to make the native_transport config parameters have more consistent naming with prior parameters - feel free to modify them further, if you think you can improve them still&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;forceAllocate&lt;/tt&gt; -&amp;gt; &lt;tt&gt;allocate&lt;/tt&gt;, which is usually the alternative to &lt;tt&gt;tryAllocate&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Shortened THROW_ON_OVERLOAD parameter&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;There are three remaining bugs, and I&apos;ve paused review until they can be addressed:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;&lt;tt&gt;this::releaseItem&lt;/tt&gt; is unsafe to provide to the &lt;tt&gt;Flusher&lt;/tt&gt; constructor, since these are unique to a channel, and the &lt;tt&gt;Flusher&lt;/tt&gt; is per-eventLoop.  If we choose to hash all connections on an endpoint to a single eventLoop this would be easy to accommodate, or otherwise &lt;tt&gt;FlushItem&lt;/tt&gt; needs to be the implementor of &lt;tt&gt;release()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;I don&apos;t think we can use &lt;tt&gt;Ref&lt;/tt&gt; for management of the &lt;tt&gt;EndpointPayloadTracker&lt;/tt&gt;.  The &lt;tt&gt;Tidy&lt;/tt&gt; implementation requires a reference to the object itself, and anyway logically deleting itself after release defeats the point of Ref (which is leak detection).  It&apos;s impossible for it to detect a leak and cleanup, if the strong reference is cleaned up by this process (since there will always be a strong reference until it invokes, and it requires there to be no strong references, it will never invoke).  Probably we should use a simple AtomicInteger to manage reference counts.  I think it would be cleanest to encapsulate the map management inside a static method in &lt;tt&gt;EndpointPayloadTracker&lt;/tt&gt; as well.&lt;/li&gt;
	&lt;li&gt;I think we currently have a race condition around the release of a channel (and its &lt;tt&gt;EndpointPayloadTracker&lt;/tt&gt;) and the attempt to release capacity from the &lt;tt&gt;EndpointPayloadTracker&lt;/tt&gt; we have requests in flight for.  Channels can be invalidated before we complete requests issued by them, so we must be sure to release from the tracker we allocated from, so that we do not wrap into negative on release.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16841835" author="sumanth.pasupuleti" created="Fri, 17 May 2019 00:53:08 +0000"  >&lt;p&gt;Incorporated the feedback from your branch (naming and TODOs) and from the jira comments.&lt;br/&gt;
Here is the updated change: &lt;a href=&quot;https://github.com/sumanth-pasupuleti/cassandra/commit/45e31829e839d7e74b08566d7e501a46ed818330&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/sumanth-pasupuleti/cassandra/commit/45e31829e839d7e74b08566d7e501a46ed818330&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;A couple of major changes&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Dispatcher would never query the map for getting EndpointPayloadTracker, rather it uses the reference it already has.&lt;/li&gt;
	&lt;li&gt;FlushItem gets a reference to the corresponding Dispatcher, so it calls releaseItem on the right Dispatcher.&lt;/li&gt;
	&lt;li&gt;I implemented tryRef and release that manage refCount on EndpointPayloadTracker, which &quot;should&quot; be thread safe&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;All UTs and DTests pass.&lt;br/&gt;
&lt;a href=&quot;https://circleci.com/workflow-run/bb6b2eb6-daa6-41c1-9a3d-44b53bc7fb50&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/workflow-run/bb6b2eb6-daa6-41c1-9a3d-44b53bc7fb50&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16842121" author="benedict" created="Fri, 17 May 2019 12:01:01 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;, the patch is looking really good.  Some remaining questions:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Do we need requestsProcessed metric?  We already have &lt;tt&gt;regularStatementsExecuted&lt;/tt&gt; and &lt;tt&gt;preparedStatementsExecuted&lt;/tt&gt; which should track closely for the traffic we care about.&lt;/li&gt;
	&lt;li&gt;Conversely, do we want some metric to track back pressure being deployed?  It&#8217;s not clear exactly what semantics we would want to maintain here, since we don&#8217;t &lt;em&gt;currently&lt;/em&gt; pause all channels for a given endpoint when the endpoint overflows, and it&#8217;s also unclear if we would want to track this per-client (probably not, although it would be really nice to do so)&lt;/li&gt;
	&lt;li&gt;I think it would be nice to manage &lt;tt&gt;requestPayloadInFlightPerEndpoint&lt;/tt&gt; entirely inside &lt;tt&gt;EndpointPayloadTracker&lt;/tt&gt; ; it&apos;s presently only accessed once outside in an adjacent class, but it would be very simple to hide the map entirely, as well as &lt;tt&gt;tryRef&lt;/tt&gt;, and simply offer a &lt;tt&gt;public static get&lt;/tt&gt; method in &lt;tt&gt;EndpointPayloadTracker&lt;/tt&gt;.  WDYT?&lt;/li&gt;
	&lt;li&gt;It might also be nice to introduce a new version of &lt;tt&gt;EndpointAndGlobal.release&lt;/tt&gt; that informs the caller if we are presently above or below the limits.  This would simplify the re-activation of a channel.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;What do you also think about starting/stopping all channels for an endpoint at once, when we cross the threshold?  I don&apos;t think it is essential, but is probably worth considering, as it makes our limits even less clearly defined (given we&apos;re permitted to cross them already, once per channel; it would be nice to tighten that to once per-endpoint)&lt;/p&gt;</comment>
                            <comment id="16843339" author="sumanth.pasupuleti" created="Sun, 19 May 2019 07:02:09 +0000"  >&lt;p&gt;Thanks for the additional feedback. I&apos;ve made following further changes to the &lt;a href=&quot;https://github.com/sumanth-pasupuleti/cassandra/commit/98126f5d887228f5e88eca66f007873b52a0aacf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Removed &lt;tt&gt;requestsProcessed&lt;/tt&gt; metric.&lt;/li&gt;
	&lt;li&gt;Added &lt;tt&gt;BackpressureDeployed&lt;/tt&gt; metric to indicate how many times server attempted to apply backpressure.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;EndpointPayloadTracker&lt;/tt&gt; manages &lt;tt&gt;requestPayloadInFlightPerEndpoint&lt;/tt&gt;, and an external consumer of &lt;tt&gt;EndpointPayloadTracker&lt;/tt&gt; calls a static &lt;tt&gt;get&lt;/tt&gt; that internally does &lt;tt&gt;tryRef&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;EndpointAndGlobal.release&lt;/tt&gt; returns &lt;tt&gt;ABOVE_LIMIT&lt;/tt&gt; or &lt;tt&gt;BELOW_LIMIT&lt;/tt&gt; Outcome.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://circleci.com/workflow-run/561b655c-c3d8-4ea6-9997-ed24754ad133&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Passing Tests&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;EndpointPayloadTracker&lt;/tt&gt; is the only accessor of &lt;tt&gt;globalRequestPayloadInFlight&lt;/tt&gt;, however, it did not seem to make semantic sense of moving &lt;tt&gt;globalRequestPayloadInFlight&lt;/tt&gt; as a member of &lt;tt&gt;EndpointPayloadTracker&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Regarding starting/stopping all channels for an endpoint at once, I agree it would make the system better respect the limits than otherwise letting each channel cross once (incase of backpressure mode). However, since each channel&apos;s connection properties maybe different (THROW_ON_OVERLOAD vs BACKPRESSURE), we will then have to check the property and make a decision accordingly. I am inclining towards punting this for now. Let me know what you think.&lt;/p&gt;

&lt;p&gt;Regarding per-client limit, I see it as a good logical extension to this patch, and I would like to tackle it as a separate ticket. Also, as an additional ticket, I would like to explore extending this concurrency limitting patch to go beyond the current parameter of incoming payload which works well for writes, but not necessarily for reads, maybe considering the response payload and/or no. of concurrent tasks in flight.&lt;/p&gt;</comment>
                            <comment id="16873477" author="benedict" created="Wed, 26 Jun 2019 16:13:11 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;.  I think this is very close to commit.&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed a small number of extra suggestions &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/15013-suggestions&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.  Mostly just minor stylistic simplifications, as well as a modification to of back pressure deployed to simply the number of connections currently experiencing back pressure, since it&apos;s not entirely clear how an operator would meaningfully interpret the number of times it was independently applied (since it would be applied more often for small messages than large ones)&lt;/p&gt;

&lt;p&gt;Let me know what you think, and we can hopefully see about merging this soon.&lt;/p&gt;</comment>
                            <comment id="16873870" author="sumanth.pasupuleti" created="Thu, 27 Jun 2019 07:12:07 +0000"  >&lt;p&gt;+1 on the suggestions &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;. I have applied your commit on my &lt;a href=&quot;https://github.com/sumanth-pasupuleti/cassandra/commits/15013_trunk_2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; and ran the tests.&lt;br/&gt;
UTs and JVM DTests pass. All Dtests pass except for 6 failures which seem unrelated. &lt;br/&gt;
&lt;a href=&quot;https://circleci.com/workflow-run/04b77dd7-7dca-49d4-8328-e55b357fcca6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/workflow-run/04b77dd7-7dca-49d4-8328-e55b357fcca6&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16874159" author="benedict" created="Thu, 27 Jun 2019 13:46:19 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;.  I realised I had forgotten to handle the case of &lt;tt&gt;channelInactive&lt;/tt&gt; whilst paused, so I&apos;ve pushed a tiny follow-up modification.  If it looks good to you, I&apos;ll merge the lot into trunk.&lt;/p&gt;</comment>
                            <comment id="16874183" author="sumanth.pasupuleti" created="Thu, 27 Jun 2019 14:12:05 +0000"  >&lt;p&gt;Thanks for catching the &lt;tt&gt;channelInactive&lt;/tt&gt; case. lgtm.&lt;/p&gt;

&lt;p&gt;One thing remaining I suppose,&#160;is to revisit the&#160;default limits&#160;&lt;a href=&quot;https://github.com/apache/cassandra/commit/98126f5d887228f5e88eca66f007873b52a0aacf#diff-b66584c9ce7b64019b5db5a531deeda1R173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/98126f5d887228f5e88eca66f007873b52a0aacf#diff-b66584c9ce7b64019b5db5a531deeda1R173&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// TODO: Revisit limit
&lt;/span&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; native_transport_max_concurrent_requests_in_bytes_per_ip = 3000000000L;
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;volatile&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; native_transport_max_concurrent_requests_in_bytes = 5000000000L;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16874184" author="benedict" created="Thu, 27 Jun 2019 14:14:41 +0000"  >&lt;p&gt;Yes, I guess 3GiB per IP is probably too high, as is 5GiB per node.  Not really sure what a good default is - probably it should be a function of heap size like most of our other limits.&lt;/p&gt;</comment>
                            <comment id="16874366" author="sumanth.pasupuleti" created="Thu, 27 Jun 2019 17:28:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Makes sense. I pushed a &lt;a href=&quot;https://github.com/sumanth-pasupuleti/cassandra/commit/0c75ecf7b6f0824786b840c6cba167eb393b92ce&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;change&lt;/a&gt;&#160;to &lt;a href=&quot;https://github.com/sumanth-pasupuleti/cassandra/commits/15013_trunk_2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; branch.&lt;/p&gt;

&lt;p&gt;Per node defaults to 1/10th of heap size, per IP defaults to 1/40th of heap size.&lt;/p&gt;

&lt;p&gt;Similar test &lt;a href=&quot;https://circleci.com/workflow-run/c61d7df2-c77a-4eab-a954-a59f6165f372&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;results&lt;/a&gt; as previous run.&lt;/p&gt;</comment>
                            <comment id="16874927" author="benedict" created="Fri, 28 Jun 2019 13:36:18 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;.  I&apos;m happy this resolves the issue, but it occurs to me it would be great to confirm the worst case performance impact of this change is manageable - particularly given your performance testing infrastructure.&lt;/p&gt;

&lt;p&gt;The worst case behaviour is probably LOCAL_ONE in-memory reads on a high core count multi-socket machine, serving thousands of TCP connections from the same host at a total rate of hundreds of thousands of QPS.  So a single i3.16xlarge system would be optimal.&lt;/p&gt;

&lt;p&gt;Does that sound reasonable to you?&lt;/p&gt;</comment>
                            <comment id="16874969" author="sumanth.pasupuleti" created="Fri, 28 Jun 2019 14:42:15 +0000"  >&lt;p&gt;Absolutely. I was thinking along similar lines as well, as to performance test this patch - I was more thinking about having two clusters with&#160;the same configuration, one with and one without this patch, and measuring their performance when put under similar load. As you said, we can employ LOCAL_ONE traffic and see that data is small enough to fit into memory. I am thinking about at least a 3-node i3.8xl /i3.16xl cluster setup to even out any instance related issues but will ensure we&#160;have thousands of TCP connections per host and ops in the order of ~100k qps per host (or at least as high as we can get). Will start these tests today.&lt;/p&gt;</comment>
                            <comment id="16874970" author="benedict" created="Fri, 28 Jun 2019 14:44:19 +0000"  >&lt;p&gt;Fantastic, that sounds great.&lt;/p&gt;</comment>
                            <comment id="16881762" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 06:29:44 +0000"  >&lt;p&gt;Performance tests were run against two C* clusters, one running latest trunk (referred to as &lt;em&gt;cass_perf_15013_base&lt;/em&gt;), and one running &lt;span class=&quot;error&quot;&gt;&amp;#91;latest trunk + 15013 patch&amp;#93;&lt;/span&gt; (referred to as &lt;em&gt;cass_perf_15013_patch&lt;/em&gt;). Two NDBench clusters, with similar configuration to emit similar traffic, were setup to throw load at each of the C* clusters. Each of the C* clusters is a single region, six i3.8xl nodes, and each of the NDBench clusters is 450 nodes.&lt;/p&gt;

&lt;p&gt;Following is the analysis of the perf run:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;No blocked threadpool in patch, vs blocked threadpool in trunk&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12974132/12974132_perftest_blockedthreads.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/li&gt;
	&lt;li&gt;Similar writeops&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12974130/12974130_perftest_writeops.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/li&gt;
	&lt;li&gt;Patch does more readops vs trunk&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12974133/12974133_perftest_readops.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/li&gt;
	&lt;li&gt;Comparable read and write latencies (99th and avg)&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12974135/12974135_perftest_readlatency_99th.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12974136/12974136_perftest_readlatency_avg.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12974137/12974137_perftest_writelatency_99th.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12974138/12974138_perftest_writelatency_avg.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/li&gt;
	&lt;li&gt;Comparable CPU usage&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12974139/12974139_perftest_cpu_usage.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/li&gt;
	&lt;li&gt;Comparable heap usage&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12974140/12974140_perftest_heap_usage.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/li&gt;
	&lt;li&gt;Connections count (~1000 connections per C* node)&lt;br/&gt;
 &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12974141/12974141_perftest_connections_count.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16881781" author="benedict" created="Wed, 10 Jul 2019 07:01:24 +0000"  >&lt;p&gt;Thanks for these &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;Just to log for watchers, I have had a brief chat with Sumanth, and we intend to capture flame graphs to see if we can explain the 10% (5 percentage point) bump in average CPU utilisation, which may well be down to competition on a single variable for every operation.  This is a worst case cost, given the formulation of this test, which was the whole point - but it&apos;s potentially still significant, so we might need to reduce friction by e.g. assigning each connection its own share of the pie at connection, so that we only have to compete for the shared resource infrequently (when we overshot our share, or need to dis/connect).  We&apos;ll see what the flame graphs show.&lt;/p&gt;

&lt;p&gt;We will also try to explain the different shape of heap utilisation graph - which might be as simple as only one node is coordinating instead of all three, for instance.&lt;/p&gt;</comment>
                            <comment id="16881793" author="benedict" created="Wed, 10 Jul 2019 07:32:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; has just pointed out that we are seeing &lt;em&gt;double&lt;/em&gt; the throughput of reads (I hadn&apos;t carefully looked at all the graphs), which very likely explains the increase in CPU&lt;/p&gt;

&lt;p&gt;It would be nice to perform a run with fixed throughput at a rate trunk can manage, so we can get directly comparable results.  But this is a &lt;em&gt;huge&lt;/em&gt; win, nice work!&lt;/p&gt;

&lt;p&gt;(If we can grab flame graphs anyway, there&apos;d be no harm and it would be nice to take a look to confirm nothing unexpected)&lt;/p&gt;</comment>
                            <comment id="16882103" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 14:18:09 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt;. I&apos;ve re-run the perf test such that throughput is same across both the clusters (I had to tone down the ndbench client pointing to patch version of C* by quite a lot to make it equal to trunk throughput).&lt;/p&gt;

&lt;p&gt;I have attached the flamegraphs - CPU usage is a tad lower in patch vs trunk (based on avg).&lt;/p&gt;

&lt;p&gt;Also attached all the metrics of this perf run (files starting with perftest2*).&lt;/p&gt;

&lt;p&gt;Following is the summary of perf run #2&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Very similar readops and write ops&lt;/li&gt;
	&lt;li&gt;Read latency (99th and avg) slightly better for patch vs trunk&lt;/li&gt;
	&lt;li&gt;Write latency 99th similar between patch and trunk. Write latency avg is slightly better for patch vs trunk&lt;/li&gt;
	&lt;li&gt;No blocked threadpool for patch&lt;/li&gt;
	&lt;li&gt;Cpu usage (avg) is slightly better for patch vs trunk&lt;/li&gt;
	&lt;li&gt;Heap usage pattern was similar between patch and trunk&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16882981" author="benedict" created="Thu, 11 Jul 2019 13:51:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;: this looks good to go.  Could you prepare the patch for commit, and submit 3.0, 3.x and trunk versions for me to merge?  Thanks!&lt;/p&gt;</comment>
                            <comment id="16883581" author="sumanth.pasupuleti" created="Fri, 12 Jul 2019 06:56:25 +0000"  >&lt;p&gt;Sure &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;. Here are the patches:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;3.0&lt;/b&gt;&lt;br/&gt;
Patch:  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12974481/12974481_15013-3.0.txt&quot; title=&quot;15013-3.0.txt attached to CASSANDRA-15013&quot;&gt;15013-3.0.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;br/&gt;
Passing UTs and DTests &lt;a href=&quot;https://circleci.com/workflow-run/c7889003-9c58-4099-9530-0439bf241238&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/workflow-run/c7889003-9c58-4099-9530-0439bf241238&lt;/a&gt;&lt;br/&gt;
Github: &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...sumanth-pasupuleti:15013_3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/cassandra-3.0...sumanth-pasupuleti:15013_3.0?expand=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;3.11&lt;/b&gt;&lt;br/&gt;
Patch:  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12974480/12974480_15013-3.11.txt&quot; title=&quot;15013-3.11.txt attached to CASSANDRA-15013&quot;&gt;15013-3.11.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;br/&gt;
Passing UTs and DTests &lt;a href=&quot;https://circleci.com/workflow-run/46de0958-850a-4531-a15f-fd1df0c65aac&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/workflow-run/46de0958-850a-4531-a15f-fd1df0c65aac&lt;/a&gt;&lt;br/&gt;
Github: &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...sumanth-pasupuleti:15013_3.11?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/cassandra-3.11...sumanth-pasupuleti:15013_3.11?expand=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;trunk&lt;/b&gt;&lt;br/&gt;
Patch:  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12974482/12974482_15013-trunk.txt&quot; title=&quot;15013-trunk.txt attached to CASSANDRA-15013&quot;&gt;15013-trunk.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; &lt;br/&gt;
Passing UTs and DTests &lt;a href=&quot;https://circleci.com/workflow-run/67e43b0b-7f13-4de2-8fbd-7cab3d72b607&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/workflow-run/67e43b0b-7f13-4de2-8fbd-7cab3d72b607&lt;/a&gt;&lt;br/&gt;
Github: &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...sumanth-pasupuleti:15013_trunk?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...sumanth-pasupuleti:15013_trunk?expand=1&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16885255" author="benedict" created="Mon, 15 Jul 2019 13:59:50 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;Great work, I&apos;ve merged it up.  &lt;/p&gt;

&lt;p&gt;For future reference, it&apos;s super helpful if you can also modify CHANGES.txt, to avoid unnecessary rebasing and merging.  If you can also stick to the commit message format (that I&apos;m unsure if we&apos;ve codified anywhere, and we should probably rectify), it also makes merging easier:&lt;/p&gt;

&lt;p&gt;&quot;&lt;br/&gt;
&amp;lt;One sentence description, usually Jira title and CHANGES.txt summary&amp;gt;&lt;/p&gt;

&lt;p&gt;&amp;lt;Optional lengthier description&amp;gt;&lt;/p&gt;

&lt;p&gt;patch by &amp;lt;Authors&amp;gt;; reviewed by &amp;lt;Reviewers&amp;gt; for CASSANDRA-#####&lt;br/&gt;
&quot;&lt;/p&gt;</comment>
                            <comment id="16885313" author="sumanth.pasupuleti" created="Mon, 15 Jul 2019 15:08:10 +0000"  >&lt;p&gt;Thanks for the feedback and review &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;. I will incorporate this feedback into my future commits and submit a patch for the documentation if necessary.&lt;/p&gt;</comment>
                            <comment id="16892289" author="sumanth.pasupuleti" created="Thu, 25 Jul 2019 00:03:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Created a task with patch attached to update the documentation w.r.t. suggested commit message format. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15246&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-15246&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13325865">CASSANDRA-16100</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12974481" name="15013-3.0.txt" size="59229" author="sumanth.pasupuleti" created="Fri, 12 Jul 2019 06:50:46 +0000"/>
                            <attachment id="12974480" name="15013-3.11.txt" size="59512" author="sumanth.pasupuleti" created="Fri, 12 Jul 2019 06:50:45 +0000"/>
                            <attachment id="12974482" name="15013-trunk.txt" size="56831" author="sumanth.pasupuleti" created="Fri, 12 Jul 2019 06:50:46 +0000"/>
                            <attachment id="12958807" name="BlockedEpollEventLoopFromHeapDump.png" size="190785" author="sumanth.pasupuleti" created="Fri, 15 Feb 2019 02:00:20 +0000"/>
                            <attachment id="12958808" name="BlockedEpollEventLoopFromThreadDump.png" size="674279" author="sumanth.pasupuleti" created="Fri, 15 Feb 2019 02:00:47 +0000"/>
                            <attachment id="12958809" name="RequestExecutorQueueFull.png" size="153662" author="sumanth.pasupuleti" created="Fri, 15 Feb 2019 02:01:49 +0000"/>
                            <attachment id="12957937" name="heap dump showing each ImmediateFlusher taking upto 600MB.png" size="328596" author="sumanth.pasupuleti" created="Thu, 7 Feb 2019 17:22:48 +0000"/>
                            <attachment id="12974207" name="perftest2_15013_base_flamegraph.svg" size="637383" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 13:56:04 +0000"/>
                            <attachment id="12974208" name="perftest2_15013_patch_flamegraph.svg" size="758335" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 13:56:03 +0000"/>
                            <attachment id="12974189" name="perftest2_blocked_threadpool.png" size="90916" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 12:46:10 +0000"/>
                            <attachment id="12974194" name="perftest2_cpu_usage.png" size="205008" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 12:49:29 +0000"/>
                            <attachment id="12974197" name="perftest2_heap.png" size="1255813" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 12:58:54 +0000"/>
                            <attachment id="12974184" name="perftest2_read_latency_99th.png" size="348213" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 12:38:04 +0000"/>
                            <attachment id="12974185" name="perftest2_read_latency_avg.png" size="264318" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 12:39:08 +0000"/>
                            <attachment id="12974182" name="perftest2_readops.png" size="281250" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 12:35:41 +0000"/>
                            <attachment id="12974188" name="perftest2_write_latency_99th.png" size="354208" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 12:43:04 +0000"/>
                            <attachment id="12974187" name="perftest2_write_latency_avg.png" size="257771" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 12:41:18 +0000"/>
                            <attachment id="12974186" name="perftest2_writeops.png" size="269329" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 12:40:07 +0000"/>
                            <attachment id="12974132" name="perftest_blockedthreads.png" size="179935" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 05:47:29 +0000"/>
                            <attachment id="12974141" name="perftest_connections_count.png" size="264818" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 05:58:48 +0000"/>
                            <attachment id="12974139" name="perftest_cpu_usage.png" size="289264" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 05:57:09 +0000"/>
                            <attachment id="12974140" name="perftest_heap_usage.png" size="525299" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 05:58:21 +0000"/>
                            <attachment id="12974135" name="perftest_readlatency_99th.png" size="252015" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 05:55:05 +0000"/>
                            <attachment id="12974136" name="perftest_readlatency_avg.png" size="213161" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 05:55:35 +0000"/>
                            <attachment id="12974133" name="perftest_readops.png" size="217920" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 05:47:58 +0000"/>
                            <attachment id="12974137" name="perftest_writelatency_99th.png" size="286726" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 05:56:04 +0000"/>
                            <attachment id="12974138" name="perftest_writelatency_avg.png" size="221283" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 05:56:34 +0000"/>
                            <attachment id="12974130" name="perftest_writeops.png" size="217957" author="sumanth.pasupuleti" created="Wed, 10 Jul 2019 05:46:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>28.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[sumanth.pasupuleti]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13101"><![CDATA[Clients]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 16 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|yi0r9s:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324629">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/tree/5a03898c680ed6ada63901e8a4b278ccc8070717&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5a03898c680ed6ada63901e8a4b278ccc8070717&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Passing UTs: &lt;a href=&quot;https://circleci.com/gh/sumanth-pasupuleti/cassandra/288&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/sumanth-pasupuleti/cassandra/288&lt;/a&gt;&lt;br/&gt;
Passing jvm dtests: &lt;a href=&quot;https://circleci.com/gh/sumanth-pasupuleti/cassandra/287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/sumanth-pasupuleti/cassandra/287&lt;/a&gt;&lt;br/&gt;
DTests with 2 failures (seems unrelated): &lt;a href=&quot;https://circleci.com/gh/sumanth-pasupuleti/cassandra/290#tests/containers/81&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/sumanth-pasupuleti/cassandra/290#tests/containers/81&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/sumanth-pasupuleti/cassandra/289#tests/containers/66&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/sumanth-pasupuleti/cassandra/289#tests/containers/66&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>