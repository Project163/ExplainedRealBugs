<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:25:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3407] Changing partitioner causes interval tree build failure before the change can be detected</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3407</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After installed 1.0.0 and changed config file cassandra.yaml, restart cassandra and got exception,&lt;/p&gt;

&lt;p&gt;INFO 22:25:37,727 Opening /srv/opt/cassandra8/data/system/IndexInfo-g-121 (5428 bytes)&lt;br/&gt;
ERROR 22:25:37,753 Exception encountered during startup_type: 0},&lt;br/&gt;
java.lang.StackOverflowError, validation_class: UTF8Type, index_type: 0},&lt;br/&gt;
       at java.math.BigInteger.compareMagnitude(BigInteger.java:2477)&lt;br/&gt;
       at java.math.BigInteger.compareTo(BigInteger.java:2463)type: 0},&lt;br/&gt;
       at org.apache.cassandra.dht.BigIntegerToken.compareTo(BigIntegerToken.java:39)&lt;br/&gt;
       at org.apache.cassandra.db.DecoratedKey.compareTo(DecoratedKey.java:83)&lt;br/&gt;
       at org.apache.cassandra.db.DecoratedKey.compareTo(DecoratedKey.java:38)&lt;br/&gt;
       at java.util.Arrays.mergeSort(Arrays.java:1144)dex_type: 0},&lt;br/&gt;
       at java.util.Arrays.sort(Arrays.java:1079)dex_type: 0},&lt;br/&gt;
       at java.util.Collections.sort(Collections.java:117)},&lt;br/&gt;
       at org.apache.cassandra.utils.IntervalTree.IntervalNode.findMinMedianMax(IntervalNode.java:102)&lt;br/&gt;
       at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:43)&lt;br/&gt;
       at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:51)&lt;br/&gt;
       at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:51)&lt;br/&gt;
       at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:51)&lt;br/&gt;
       at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:51)&lt;br/&gt;
       at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:51)&lt;br/&gt;
       at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:51)&lt;br/&gt;
.....&lt;/p&gt;

&lt;p&gt;       at org.apache.cassandra.utils.IntervalTree.IntervalNode.&amp;lt;init&amp;gt;(IntervalNode.java:51)&lt;br/&gt;
       at org.apache.cassandra.utils.IntervalTree.IntervalTree.&amp;lt;init&amp;gt;(IntervalTree.java:38)&lt;br/&gt;
       at org.apache.cassandra.db.DataTracker$View.buildIntervalTree(DataTracker.java:522)&lt;br/&gt;
       at org.apache.cassandra.db.DataTracker$View.replace(DataTracker.java:547)&lt;br/&gt;
       at org.apache.cassandra.db.DataTracker.replace(DataTracker.java:268)&lt;br/&gt;
       at org.apache.cassandra.db.DataTracker.addSSTables(DataTracker.java:237)&lt;br/&gt;
       at org.apache.cassandra.db.ColumnFamilyStore.&amp;lt;init&amp;gt;(ColumnFamilyStore.java:216)&lt;br/&gt;
       at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:315)&lt;br/&gt;
       at org.apache.cassandra.db.ColumnFamilyStore.createColumnFamilyStore(ColumnFamilyStore.java:285)&lt;br/&gt;
       at org.apache.cassandra.db.Table.initCf(Table.java:372)&lt;br/&gt;
       at org.apache.cassandra.db.Table.&amp;lt;init&amp;gt;(Table.java:320)&lt;br/&gt;
       at org.apache.cassandra.db.Table.open(Table.java:121)&lt;br/&gt;
       at org.apache.cassandra.db.Table.open(Table.java:104)&lt;br/&gt;
       at org.apache.cassandra.db.SystemTable.checkHealth(SystemTable.java:215)&lt;br/&gt;
       at org.apache.cassandra.service.AbstractCassandraDaemon.setup(AbstractCassandraDaemon.java:150)&lt;br/&gt;
       at org.apache.cassandra.service.AbstractCassandraDaemon.activate(AbstractCassandraDaemon.java:337)&lt;br/&gt;
       at org.apache.cassandra.thrift.CassandraDaemon.main(CassandraDaemon.java:106)&lt;br/&gt;
Exception encountered during startup: null&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux  2.6.18&lt;/p&gt;</environment>
        <key id="12529058">CASSANDRA-3407</key>
            <summary>Changing partitioner causes interval tree build failure before the change can be detected</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="apache.zli">Zhong Li</reporter>
                        <labels>
                    </labels>
                <created>Thu, 27 Oct 2011 14:33:36 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:47 +0000</updated>
                            <resolved>Wed, 16 Nov 2011 22:09:01 +0000</resolved>
                                        <fixVersion>1.0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13137178" author="apache.zli" created="Thu, 27 Oct 2011 14:34:32 +0000"  >&lt;p&gt;Full logs&lt;/p&gt;</comment>
                            <comment id="13137192" author="jbellis" created="Thu, 27 Oct 2011 15:00:19 +0000"  >&lt;p&gt;Superficially it looks like we might want to change that IntervalTree method to a loop instead of recursion&lt;/p&gt;</comment>
                            <comment id="13137241" author="slebresne" created="Thu, 27 Oct 2011 16:16:43 +0000"  >&lt;p&gt;On my machine, I&apos;m able to do 1156 recursive calls with -Xss128k (which we use by default) before getting a StackOverflowException. Is that expected that we create such huge intervalTree ?&lt;/p&gt;</comment>
                            <comment id="13137245" author="jbellis" created="Thu, 27 Oct 2011 16:23:29 +0000"  >&lt;p&gt;Does our intervaltree self-balance or will it degenerate if nodes are added in the &quot;wrong&quot; order, e.g. sorted order in a standard binary tree?&lt;/p&gt;</comment>
                            <comment id="13137284" author="thepaul" created="Thu, 27 Oct 2011 17:03:16 +0000"  >&lt;p&gt;They&apos;re immutable and recreated as necessary with new DataTracker.View object, so ongoing balancing isn&apos;t an issue. It looks like the worst case depth (with the right arrangement of intervals; insertion order doesn&apos;t matter) is equal to the number of SSTableReaders in a View.&lt;/p&gt;</comment>
                            <comment id="13137287" author="jbellis" created="Thu, 27 Oct 2011 17:06:49 +0000"  >&lt;p&gt;Hmm.  We could have way more than 1156 SSTables in a view very easily.&lt;/p&gt;</comment>
                            <comment id="13137296" author="thepaul" created="Thu, 27 Oct 2011 17:18:34 +0000"  >&lt;p&gt;To get that, you&apos;d need all the SSTable intervals to be wholly contained by the next larger one, and none intersecting the center point of any larger intervals. It seems unlikely, but maybe there are patterns of usage which could have that effect.&lt;/p&gt;

&lt;p&gt;Either way, it probably is worth changing both the tree creation and search methods to use iteration instead of recursion.&lt;/p&gt;</comment>
                            <comment id="13137301" author="jbellis" created="Thu, 27 Oct 2011 17:23:53 +0000"  >&lt;p&gt;In the meantime, Zhong should be able to just use a larger stack as a workaround.&lt;/p&gt;</comment>
                            <comment id="13137317" author="slebresne" created="Thu, 27 Oct 2011 17:38:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;It seems unlikely, but maybe there are patterns of usage which could have that effect&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It sound to me like we don&apos;t understand what is going on.&lt;/p&gt;

&lt;p&gt;Besides, if you look at the full log, the exception is triggered on the IndexInfo cf. It also happens at the very startup after he has loaded only 3 sstables (hence DataTracker likely have 3 sstables, not a shit load). I&apos;m pretty sure it&apos;s a bug leading to infinite recursive calls, not a stack size problem.&lt;/p&gt;</comment>
                            <comment id="13137350" author="jbellis" created="Thu, 27 Oct 2011 18:13:20 +0000"  >&lt;p&gt;Good point.&lt;/p&gt;</comment>
                            <comment id="13137358" author="jbellis" created="Thu, 27 Oct 2011 18:24:35 +0000"  >&lt;p&gt;I added debug logging for the intervals in the tree to the 1.0 branch in r1189921; if Zhong can build with that and give us the log, that would help a lot.&lt;/p&gt;</comment>
                            <comment id="13137406" author="apache.zli" created="Thu, 27 Oct 2011 19:08:32 +0000"  >
&lt;p&gt;I will try to build it and test it.&lt;/p&gt;

</comment>
                            <comment id="13137433" author="apache.zli" created="Thu, 27 Oct 2011 19:38:47 +0000"  >&lt;p&gt;I turn on debug and this is full logs&lt;/p&gt;</comment>
                            <comment id="13138748" author="thepaul" created="Fri, 28 Oct 2011 21:02:42 +0000"  >&lt;p&gt;So here&apos;s the culprit:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Interval(DecoratedKey(145657158669597754039818762792796113368, 6b657973706163654c42534441544150524f445553), DecoratedKey(130897858884062407407634012854175581156, 6b65797370616365544553544441544150524f445553))&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Notice that the min of that Interval (~1.45e38) is greater than the max (~1.30e38). The IntervalTree logic is wholly incapable of dealing with that, so we end up in an infinite loop. The only way I can find that this could happen is from an invalid SSTableReader object. I&apos;ll make a patch with some extra asserts; if you can run with that, Zhong, maybe we can at least see where that invalid data is coming from.&lt;/p&gt;</comment>
                            <comment id="13138807" author="thepaul" created="Fri, 28 Oct 2011 21:46:01 +0000"  >&lt;p&gt;Zhong, please try building and running that same setup with this patch.&lt;/p&gt;</comment>
                            <comment id="13138844" author="apache.zli" created="Fri, 28 Oct 2011 22:09:07 +0000"  >&lt;p&gt;patch applied and log attached.&lt;/p&gt;</comment>
                            <comment id="13138849" author="thepaul" created="Fri, 28 Oct 2011 22:15:20 +0000"  >&lt;p&gt;Hmm, the patch doesn&apos;t seem to have taken effect. Are you running with java&apos;s -ea option to enable assertions?&lt;/p&gt;</comment>
                            <comment id="13139528" author="thepaul" created="Sun, 30 Oct 2011 03:24:43 +0000"  >&lt;p&gt;I haven&apos;t been able to reproduce this still, even with the IndexInfo files. I guess let&apos;s figure out where things are going differently. You&apos;re using the ByteOrderedPartitioner, it looks like? And can you confirm, you&apos;re running a single node of Cassandra 1.0.0, with all its data/commitlog/saved_caches directories empty except for data/system/IndexInfo*.db, and you get this exception?&lt;/p&gt;</comment>
                            <comment id="13140230" author="apache.zli" created="Mon, 31 Oct 2011 15:38:23 +0000"  >&lt;p&gt;Oh. Forgot to change the partitioner setting, it is default &quot;RandomPartitioner&quot;. I should use OrderPreservingPartitioner.&lt;/p&gt;

&lt;p&gt;After I changed to OrderPreservingPartitioner, everything works fine.&lt;/p&gt;

&lt;p&gt;Sorry about this.&lt;/p&gt;</comment>
                            <comment id="13140241" author="jbellis" created="Mon, 31 Oct 2011 15:56:08 +0000"  >&lt;p&gt;Actually we do have a problem, since we&apos;re supposed to check the partitioner setting in system table and raise an error there.  But it looks like we run into this problem first...&lt;/p&gt;

&lt;p&gt;If we only built the interval tree for LCS then that would take care of it for the size-tiered case.  Any better ideas?&lt;/p&gt;</comment>
                            <comment id="13140243" author="jbellis" created="Mon, 31 Oct 2011 15:57:37 +0000"  >&lt;p&gt;What if we stored the partitioner in the metadata/statistics component so we don&apos;t depend on that not changing to be able to read the data files?&lt;/p&gt;</comment>
                            <comment id="13140245" author="jbellis" created="Mon, 31 Oct 2011 16:02:04 +0000"  >&lt;p&gt;That approach would also make our partitioner-change detection more robust against manually copying data files into a cluster with a different partitioner.&lt;/p&gt;</comment>
                            <comment id="13146053" author="yukim" created="Tue, 8 Nov 2011 02:55:58 +0000"  >&lt;p&gt;Patch attached for 1.0 branch.&lt;br/&gt;
It writes partitioner class name to sstable metadata and when opening sstable, checks recorded partitioner against node&apos;s.&lt;/p&gt;

&lt;p&gt;Since opening sstable is done in parallel, C* just skips failed ones regardless of whether its system keyspace or not.&lt;/p&gt;

&lt;p&gt;And note that I did not modify the descriptor version(&quot;h&quot;) here. If updating version is desirable, I&apos;ll update the patch.&lt;/p&gt;</comment>
                            <comment id="13146059" author="jbellis" created="Tue, 8 Nov 2011 03:21:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;I did not modify the descriptor version(&quot;h&quot;) here&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We probably should, but see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3470&quot; title=&quot;Add a second letter to Descriptor version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3470&quot;&gt;&lt;del&gt;CASSANDRA-3470&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13148207" author="yukim" created="Fri, 11 Nov 2011 01:52:24 +0000"  >&lt;p&gt;Rebased and modified original patch to use minor versioning of sstable metadata.&lt;/p&gt;</comment>
                            <comment id="13151568" author="jbellis" created="Wed, 16 Nov 2011 22:09:01 +0000"  >&lt;p&gt;Committed w/ update to throw RuntimeException instead of using assert, and remove of the old SystemTable-based partitioner checking.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12530678">CASSANDRA-3470</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12501376" name="3407-assert-intervals.patch" size="954" author="thepaul" created="Fri, 28 Oct 2011 21:46:01 +0000"/>
                            <attachment id="12503322" name="3407-v2.txt" size="6842" author="yukim" created="Fri, 11 Nov 2011 01:52:24 +0000"/>
                            <attachment id="12502876" name="3407.txt" size="7035" author="yukim" created="Tue, 8 Nov 2011 03:21:23 +0000"/>
                            <attachment id="12501096" name="exception1.txt" size="60682" author="apache.zli" created="Thu, 27 Oct 2011 14:34:32 +0000"/>
                            <attachment id="12501383" name="system.log" size="285313" author="apache.zli" created="Fri, 28 Oct 2011 22:09:06 +0000"/>
                            <attachment id="12501141" name="system.log" size="270637" author="apache.zli" created="Thu, 27 Oct 2011 19:38:47 +0000"/>
                            <attachment id="12501416" name="system.tar.gz" size="2400" author="apache.zli" created="Sat, 29 Oct 2011 00:54:58 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>214918</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 1 week, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gjif:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94591</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>