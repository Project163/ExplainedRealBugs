<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:54:16 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9411] Bound statement executions fail after adding a collection-type column</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9411</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After adding a collection-type column to an existing table, executions of statements that are already prepared result in server error (error code 0), with the error message &lt;tt&gt;java.lang.ArrayIndexOutOfBoundsException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;To reproduce it.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE tbl1 (a text, b text, c text, PRIMARY KEY (a, b))&quot;&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;//prepare initially
&lt;/span&gt;PreparedStatement ps = session.prepare(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT a, b, c FROM tbl1&quot;&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;//insert some data
&lt;/span&gt;session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO tbl1 (a, b, c) VALUES (&lt;span class=&quot;code-quote&quot;&gt;&apos;a1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;b1&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;c1&apos;&lt;/span&gt;)&quot;&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;//Executes successfully as expected
&lt;/span&gt;session.execute(ps.bind());
&lt;span class=&quot;code-comment&quot;&gt;//Add a column of a collection type
&lt;/span&gt;session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;ALTER TABLE tbl1 ADD d set&amp;lt;text&amp;gt;&quot;&lt;/span&gt;);
&lt;span class=&quot;code-comment&quot;&gt;//All following executions fail
&lt;/span&gt;session.execute(ps.bind());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Some notes:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;This only occurs for SELECT with fields (not with SELECT *)&lt;/li&gt;
	&lt;li&gt;This only occurs with C* 2.0. Probably because &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7910&quot; title=&quot;wildcard prepared statements are incorrect after a column is added to the table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7910&quot;&gt;&lt;del&gt;CASSANDRA-7910&lt;/del&gt;&lt;/a&gt; was applied for 2.1+&lt;/li&gt;
	&lt;li&gt;This only occurs if the column added is a collection type (list / set / map)&lt;/li&gt;
	&lt;li&gt;This occurs with all SELECT statements using that column family, that were already prepared.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Repreparing it on all hosts fixes the issue, but for that, the user should normally restart existing application (even if the existing apps/apps versions don&apos;t handle this new field).&lt;/p&gt;</description>
                <environment>&lt;p&gt;Cassandra 2.0.13.&lt;br/&gt;
OS X 10.9&lt;/p&gt;</environment>
        <key id="12830627">CASSANDRA-9411</key>
            <summary>Bound statement executions fail after adding a collection-type column</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="jorgebg">Jorge Bay</reporter>
                        <labels>
                    </labels>
                <created>Mon, 18 May 2015 09:36:57 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:10 +0000</updated>
                            <resolved>Wed, 27 May 2015 14:19:22 +0000</resolved>
                                        <fixVersion>2.0.16</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14554382" author="jorgebg" created="Thu, 21 May 2015 14:51:45 +0000"  >&lt;p&gt;Server Stack trace, C* 2.0.11: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [Native-Transport-Requests:53] 2015-05-21 16:49:24,657 ErrorMessage.java (line 230) Unexpected exception during request
java.lang.ArrayIndexOutOfBoundsException: 2
	at org.apache.cassandra.cql3.statements.ColumnGroupMap.add(ColumnGroupMap.java:48)
	at org.apache.cassandra.cql3.statements.ColumnGroupMap.access$200(ColumnGroupMap.java:32)
	at org.apache.cassandra.cql3.statements.ColumnGroupMap$Builder.add(ColumnGroupMap.java:140)
	at org.apache.cassandra.cql3.statements.SelectStatement.processColumnFamily(SelectStatement.java:1176)
	at org.apache.cassandra.cql3.statements.SelectStatement.process(SelectStatement.java:1079)
	at org.apache.cassandra.cql3.statements.SelectStatement.processResults(SelectStatement.java:285)
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:241)
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:65)
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:158)
	at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:309)
	at org.apache.cassandra.transport.messages.ExecuteMessage.execute(ExecuteMessage.java:132)
	at org.apache.cassandra.transport.Message$Dispatcher.messageReceived(Message.java:321)
	at org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)
	at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)
	at org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791)
	at org.jboss.netty.handler.execution.ChannelUpstreamEventRunnable.doRun(ChannelUpstreamEventRunnable.java:43)
	at org.jboss.netty.handler.execution.ChannelEventRunnable.run(ChannelEventRunnable.java:67)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14554482" author="jorgebg" created="Thu, 21 May 2015 15:07:20 +0000"  >&lt;p&gt;Server stack trace using C* 2.0.13:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [Native-Transport-Requests:53] 2015-05-21 17:04:10,840 ErrorMessage.java (line 231) Unexpected exception during request
java.lang.ArrayIndexOutOfBoundsException: 2
	at org.apache.cassandra.cql3.statements.ColumnGroupMap.add(ColumnGroupMap.java:51)
	at org.apache.cassandra.cql3.statements.ColumnGroupMap.access$200(ColumnGroupMap.java:35)
	at org.apache.cassandra.cql3.statements.ColumnGroupMap$Builder.add(ColumnGroupMap.java:167)
	at org.apache.cassandra.cql3.statements.SelectStatement.processColumnFamily(SelectStatement.java:1237)
	at org.apache.cassandra.cql3.statements.SelectStatement.process(SelectStatement.java:1123)
	at org.apache.cassandra.cql3.statements.SelectStatement.processResults(SelectStatement.java:286)
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:242)
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:64)
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:158)
	at org.apache.cassandra.cql3.QueryProcessor.processPrepared(QueryProcessor.java:309)
	at org.apache.cassandra.transport.messages.ExecuteMessage.execute(ExecuteMessage.java:132)
	at org.apache.cassandra.transport.Message$Dispatcher.messageReceived(Message.java:321)
	at org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)
	at org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)
	at org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791)
	at org.jboss.netty.handler.execution.ChannelUpstreamEventRunnable.doRun(ChannelUpstreamEventRunnable.java:43)
	at org.jboss.netty.handler.execution.ChannelEventRunnable.run(ChannelEventRunnable.java:67)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745)
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14554505" author="slebresne" created="Thu, 21 May 2015 15:18:20 +0000"  >&lt;p&gt;The problem is that on C* 2.0, &lt;tt&gt;SelectStatement&lt;/tt&gt; aliases &lt;tt&gt;CFDefinition&lt;/tt&gt; instead of &lt;tt&gt;CFMetaData&lt;/tt&gt;, the former being some post-processed version of &lt;tt&gt;CFMetaData&lt;/tt&gt; more suited to CQL. Except that when altering the table, while &lt;tt&gt;CFMetadaData&lt;/tt&gt; rebuilds a new updated &lt;tt&gt;CFDefinition&lt;/tt&gt;, prepared statements will still alias the old version and have some updated information. As a result, we compute a broken index in &lt;tt&gt;ColumnGroupMap.Builder&lt;/tt&gt; (the comparator passed is the proper one, with collections infos, but the &lt;tt&gt;hasCollections&lt;/tt&gt; flag is outdated). The good fix is probably just to have &lt;tt&gt;SelectStatement&lt;/tt&gt; alias &lt;tt&gt;CFMetaData&lt;/tt&gt; directly and call &lt;tt&gt;CFMetaData.getCfDef&lt;/tt&gt; when it needs the &lt;tt&gt;CFDefinition&lt;/tt&gt; object. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; can you have a look at that soonish?&lt;/p&gt;

&lt;p&gt;I&apos;ll note that this won&apos;t affect 2.1+, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7910&quot; title=&quot;wildcard prepared statements are incorrect after a column is added to the table&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7910&quot;&gt;&lt;del&gt;CASSANDRA-7910&lt;/del&gt;&lt;/a&gt; or not.&lt;/p&gt;</comment>
                            <comment id="14554538" author="blerer" created="Thu, 21 May 2015 15:41:06 +0000"  >&lt;p&gt;I was planing to have a look at it right now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14556646" author="blerer" created="Fri, 22 May 2015 19:07:51 +0000"  >&lt;p&gt;The patch changes &lt;tt&gt;SelectStatement&lt;/tt&gt; to store the &lt;tt&gt;CFMetadata&lt;/tt&gt; instead of the &lt;tt&gt;CFDefinition&lt;/tt&gt;. The &lt;tt&gt;CFDefinition&lt;/tt&gt; is created in the &lt;tt&gt;execute&lt;/tt&gt; methods and passed to all the methods that need it. &lt;/p&gt;</comment>
                            <comment id="14561047" author="slebresne" created="Wed, 27 May 2015 14:19:22 +0000"  >&lt;p&gt;+1, committed (only to 2.0 and merged with &lt;tt&gt;--strategy=ours&lt;/tt&gt; to 2.1 since nothing of that applies there).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12734903" name="9411.txt" size="35995" author="blerer" created="Fri, 22 May 2015 19:07:51 +0000"/>
                            <attachment id="12734904" name="DTest-9411.txt" size="1290" author="blerer" created="Fri, 22 May 2015 19:07:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 25 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ev0f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329259">2.0.13</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>