<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:21:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16669] Password obfuscation for DCL audit log statements</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16669</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The goal of this JIRA is to obfuscate passwords or any sensitive information from DCL audit log statements.&lt;/p&gt;

&lt;p&gt;Currently, (Cassandra version 4.0-rc1) logs query statements for any DCL (&lt;a href=&quot;https://cassandra.apache.org/doc/latest/cql/security.html#database-roles&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ROLE&lt;/a&gt; and &lt;a href=&quot;https://cassandra.apache.org/doc/latest/cql/security.html#users&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;USER&lt;/a&gt; ) queries with passwords in plaintext format in audit log files.&lt;/p&gt;

&lt;p&gt;The current workaround to avoid plain text passwords from being logged in audit log files is either by &lt;a href=&quot;https://cassandra.apache.org/doc/latest/operating/audit_logging.html#options&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;excluding&lt;/a&gt; DCL statements from auditing or by excluding the user who is creating these roles from auditing.&lt;/p&gt;

&lt;p&gt;It would be ideal for Cassandra to provide an option or default to obfuscate passwords or any sensitive information from DCL audit log statements.&lt;/p&gt;

&lt;p&gt;Sample audit logs with DCL queries&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sh&quot;&gt;
Type: audit
LogMessage: user:cassandra|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:51908|timestamp:1620190499676|type:CREATE_ROLE|category:DCL|operation:CREATE ROLE new_role;
Type: audit
LogMessage: user:cassandra|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:51908|timestamp:1620190505313|type:CREATE_ROLE|category:DCL|operation:CREATE ROLE alice WITH PASSWORD = &lt;span class=&quot;code-quote-red&quot;&gt;&apos;password_a&apos;&lt;/span&gt; AND LOGIN = true;
Type: audit
LogMessage: user:cassandra|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:51908|timestamp:1620190519521|type:REQUEST_FAILURE|category:ERROR|operation:ALTER ROLE bob WITH PASSWORD = &lt;span class=&quot;code-quote-red&quot;&gt;&apos;PASSWORD_B&apos;&lt;/span&gt; AND SUPERUSER = false;; bob doesn&apos;t exist
Type: audit
LogMessage: user:cassandra|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:51908|timestamp:1620190525376|type:CREATE_ROLE|category:DCL|operation:CREATE ROLE bob WITH PASSWORD = &lt;span class=&quot;code-quote-red&quot;&gt;&apos;password_b&apos;&lt;/span&gt; AND LOGIN = true AND SUPERUSER = true;
Type: audit
LogMessage: user:cassandra|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:51908|timestamp:1620190532462|type:ALTER_ROLE|category:DCL|operation:ALTER ROLE bob WITH PASSWORD = &lt;span class=&quot;code-quote-red&quot;&gt;&apos;PASSWORD_B&apos;&lt;/span&gt; AND SUPERUSER = false;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It is also ideal to document this workaround or assumption in Cassandra audit log documentation until we close this JIRA&lt;/p&gt;</description>
                <environment></environment>
        <key id="13378551">CASSANDRA-16669</key>
            <summary>Password obfuscation for DCL audit log statements</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sumanth.pasupuleti">Sumanth Pasupuleti</assignee>
                                    <reporter username="vinaykumarcse">Vinay Chella</reporter>
                        <labels>
                            <label>audit</label>
                            <label>security</label>
                    </labels>
                <created>Sat, 15 May 2021 01:44:31 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:54 +0000</updated>
                            <resolved>Tue, 15 Jun 2021 12:46:08 +0000</resolved>
                                        <fixVersion>4.0.0</fixVersion>
                    <fixVersion>4.1-alpha1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                                    <component>Tool/auditlogging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="24000">6h 40m</timespent>
                                <comments>
                            <comment id="17344981" author="stefan.miklosovic" created="Sat, 15 May 2021 07:06:57 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;hit me if you want a reviewer / committer, I think I can manage to get this to trunk.&lt;/p&gt;</comment>
                            <comment id="17345829" author="sumanth.pasupuleti" created="Mon, 17 May 2021 02:22:27 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt;. I should be ready with a patch in a day or two.&lt;/p&gt;</comment>
                            <comment id="17350915" author="stefan.miklosovic" created="Tue, 25 May 2021 08:38:00 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;, any progress?&lt;/p&gt;</comment>
                            <comment id="17353577" author="sumanth.pasupuleti" created="Fri, 28 May 2021 21:37:58 +0000"  >&lt;p&gt;Here is the first version of the patch &lt;a href=&quot;https://github.com/apache/cassandra/pull/1028&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/1028&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;This follows a rather less complicated approach of obfuscating anything that follows &quot;password&quot; token in the DCL query, inspired from what the &lt;a href=&quot;https://github.com/pgaudit/pgaudit/blob/master/pgaudit.c#L489-L535&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PostgreSQL Audit Extension (pgAudit)&lt;/a&gt; does. &lt;/p&gt;</comment>
                            <comment id="17353686" author="stefan.miklosovic" created="Sat, 29 May 2021 07:36:00 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;, I will review on Monday morning CEST.&lt;/p&gt;</comment>
                            <comment id="17354251" author="stefan.miklosovic" created="Mon, 31 May 2021 07:13:42 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;thanks for the patch.&lt;/p&gt;

&lt;p&gt;1) Are you aware of ecaudit from Ericsson? They did this obfuscation very robustly, treating new lines, obfuscating just passwords and so on. I do not think we should be inspired by what PG audit does when there is obviously more appropriate solution already existing. Check this (1) and (2). We can nicely obfuscate just passwords leaving other parts untouched.&lt;/p&gt;

&lt;p&gt;(1)&#160;&lt;a href=&quot;https://github.com/Ericsson/ecaudit/issues/170&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Ericsson/ecaudit/issues/170&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(2)&#160;&lt;a href=&quot;https://github.com/emolsson/ecaudit/blob/f01e3c1f75a9df2d767abc051b5b224d9b6c66f9/ecaudit/src/main/java/com/ericsson/bss/cassandra/ecaudit/obfuscator/PasswordObfuscator.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/emolsson/ecaudit/blob/f01e3c1f75a9df2d767abc051b5b224d9b6c66f9/ecaudit/src/main/java/com/ericsson/bss/cassandra/ecaudit/obfuscator/PasswordObfuscator.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2) Do you think that we would ever have a need to see these passwords &lt;em&gt;not&lt;/em&gt; obfuscated? What is the use case? Why would we want to see them in plaintext? I am not sure we ever need this, even it is configurable. I just do not see the reason for that configuration option to exist. It would also simplify the code.&lt;/p&gt;

&lt;p&gt;3) I prefer to change the obfuscation string from &quot;&amp;lt;OBFUSCATED&amp;gt;&quot; to &quot;*******&quot; as ecaudit has it to be somehow &quot;compatible&quot;. If people are migrating from that to our stuff, it would be nice to have the least amount of differencies here.&lt;/p&gt;

&lt;p&gt;4) I would prefer to have a separate class which would implement obfuscator interface where this logic would be done. It would be also better testable and so on - encapsulating all the logic just there.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17354786" author="vinaykumarcse" created="Tue, 1 Jun 2021 04:13:22 +0000"  >&lt;p&gt;Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;, good test coverage for the patch.&lt;/p&gt;

&lt;p&gt;Few comments from my first glance.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I +1 &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt; comment on the option to enable password obfuscation. Why should obfuscate_password be an option? the database should not allow logging passwords in plain text files.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Why did you choose to obfuscate passwords in AuditLogging vs QueryEvents? What is your stance on password being visible in FQL or other subscribers of QueryEvents?&lt;/li&gt;
	&lt;li&gt;Please update the documentation with the details of password obfuscation.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17356230" author="sumanth.pasupuleti" created="Thu, 3 Jun 2021 06:42:42 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vinaykumarcse&quot; class=&quot;user-hover&quot; rel=&quot;vinaykumarcse&quot;&gt;vinaykumarcse&lt;/a&gt; for the feedback.&lt;/p&gt;

&lt;p&gt;I&apos;ve incorporated following updates and the &lt;a href=&quot;https://github.com/apache/cassandra/pull/1028&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt; reflects the changes.&lt;br/&gt;
1. I changed obfuscation logic to just replace the password with ****** and retain rest of the operation string.&lt;br/&gt;
2. Having thought about it again, I agree we may not need a toggle to turn off password obfuscation for audit logging. I&apos;ve now removed the configurable, and we now always obfuscate password for DCL statements&lt;br/&gt;
3. Extracted obfuscation logic into its own (singleton) class that implements an interface.&lt;br/&gt;
4. Added test cases specific to password obfuscation logic.&lt;br/&gt;
5. Audit logging documentation has been updated to reflect this change about obfuscating passwords&lt;/p&gt;

&lt;p&gt;With regards to &quot;Why did you choose to obfuscate passwords in AuditLogging vs QueryEvents? What is your stance on password being visible in FQL or other subscribers of QueryEvents?&quot;,&lt;br/&gt;
1. Given that QueryEvents is a centralized common emitter of events to all registered listeners, choosing to obfuscate password in QueryEvents would force the obfuscation behavior to all the registered listeners vs leaving that decision to individual listeners. This is the reason why I chose to keep this obfuscation change localized to AuditLogging.&lt;br/&gt;
2. My stance on password visibility in FQL is that, given FQL is meant to replay traffic to achieve identical results, I would vote for password staying visible in FQL.&lt;/p&gt;

&lt;p&gt;Please let me know if you have further feedback on the updated PR.&lt;/p&gt;</comment>
                            <comment id="17356475" author="stefan.miklosovic" created="Thu, 3 Jun 2021 14:34:50 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;after initial scan, this looks way better. I will review closely again very soon.&lt;/p&gt;</comment>
                            <comment id="17357387" author="stefan.miklosovic" created="Fri, 4 Jun 2021 14:16:54 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I added few minor improvements into this branch of mine &lt;a href=&quot;https://github.com/sumanth-pasupuleti/cassandra/pull/3/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/sumanth-pasupuleti/cassandra/pull/3/files&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;All you did is fine with me it is just about moving it over the line and it is just hard to tell exactly how it should be and so on. I hope you are not finding this offensive, I really just try to move this forward soon and doing communication ping-pong is quite time consuming. To make review more comfortable, maybe you could include these changes into your branch and squash so the final review is easier for everybody.&lt;/p&gt;

&lt;p&gt;You will be still the original author of the work after we squash it.&lt;/p&gt;

&lt;p&gt;Please go over it and tell me what you think.&lt;/p&gt;

&lt;p&gt;I am running the build here:&#160;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/842/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/842/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17357424" author="vinaykumarcse" created="Fri, 4 Jun 2021 15:21:21 +0000"  >&lt;p&gt;Thank you for the update &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;. I left a few nitpicks (doc updates and few more specific tests covering regex) on your PR.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;1. Given that QueryEvents is a centralized common emitter of events to all registered listeners, choosing to obfuscate password in QueryEvents would force the obfuscation behavior to all the registered listeners vs leaving that decision to individual listeners. This is the reason why I chose to keep this obfuscation change localized to AuditLogging.&lt;br/&gt;
 2. My stance on password visibility in FQL is that given FQL is meant to replay traffic to achieve identical results, I would vote for password staying visible in FQL.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;SGTM, thanks to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt;&#160;for asking about FQL password obfuscation on dev list,&#160;I would love to hear other&apos;s opinions on this,&lt;/p&gt;</comment>
                            <comment id="17357568" author="sumanth.pasupuleti" created="Fri, 4 Jun 2021 19:03:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vinaykumarcse&quot; class=&quot;user-hover&quot; rel=&quot;vinaykumarcse&quot;&gt;vinaykumarcse&lt;/a&gt; Incorporated your review comments. Please verify and let me know if you have further feedback. &lt;a href=&quot;https://github.com/apache/cassandra/pull/1028&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/1028&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&amp;gt;I hope you are not finding this offensive&lt;br/&gt;
Absolutely not &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;, one of the biggest advantage working as a community is to improve and provide quality patches, so please keep the feedback coming.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt; jfyi, I merged your PR but made slight modifications to comments in IObfuscator to keep it generic from PasswordObfuscator. I added specific comments in PasswordObfuscator.&lt;/p&gt;</comment>
                            <comment id="17357591" author="stefan.miklosovic" created="Fri, 4 Jun 2021 19:50:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;&#160;superb stuff, I will run all the builds soonish, I still wait to see what we do about FQL though.&lt;/p&gt;</comment>
                            <comment id="17358357" author="sumanth.pasupuleti" created="Mon, 7 Jun 2021 05:01:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt; Thank you. Meanwhile, here is the patch against QueryEvents that would apply obfuscation to all the listeners like AuditLogger and FullQueryLogger - &lt;a href=&quot;https://github.com/apache/cassandra/pull/1043/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/1043/files&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;All UTs and JVMDtests pass except for one that seems unrelated (incompletePropose jvm dtest failed with timeout)&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/sumanth-pasupuleti/cassandra?branch=feature%2FCASSANDRA-16669-queryevents-ut&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/sumanth-pasupuleti/cassandra?branch=feature%2FCASSANDRA-16669-queryevents-ut&lt;/a&gt;&lt;br/&gt;
JVMDtest re-run succeeded (&lt;a href=&quot;https://app.circleci.com/pipelines/github/sumanth-pasupuleti/cassandra/67/workflows/fa067000-181f-4ceb-8998-78e39f26e00e/jobs/1343/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/sumanth-pasupuleti/cassandra/67/workflows/fa067000-181f-4ceb-8998-78e39f26e00e/jobs/1343/tests&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="17360416" author="stefan.miklosovic" created="Wed, 9 Jun 2021 22:15:12 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;I have covered one corner case here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/commit/1b19a8257340118aa9423d8e8bb40ed0e327ecb5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/instaclustr/cassandra/commit/1b19a8257340118aa9423d8e8bb40ed0e327ecb5&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I saw this kind of entry in audit logs:&lt;/p&gt;

&lt;p&gt;LogMessage: user:cassandra|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:49190|timestamp:1623273348839|type:REQUEST_FAILURE|category:ERROR|operation:ALTER USER stefan3 WITH PASSWORD = &apos;bleble&apos;;; line 1:33 mismatched input &apos;=&apos; expecting STRING_LITERAL (ALTER USER stefan3 WITH PASSWORD &lt;span class=&quot;error&quot;&gt;&amp;#91;=&amp;#93;&lt;/span&gt;...)&lt;/p&gt;

&lt;p&gt;That happens when somebody executes an invalid cql statement. It should be &lt;em&gt;without&lt;/em&gt; that &quot;=&quot; (interesting why it is like that though).&lt;/p&gt;

&lt;p&gt;That statement is then not an instance of AuthenticationStatement because it failed to be instantiated in QueryMessage#execute which means that an exception is caught in its catch block and it is propagated to&#160;&lt;/p&gt;

&lt;p&gt;QueryEvents.instance.notifyQueryFailure as &quot;null&quot;.&lt;/p&gt;

&lt;p&gt;&quot;null&quot; is not an instance of AuthenticationStatement so obfuscation is skipped.&lt;/p&gt;

&lt;p&gt;My fix consists of obfuscating if statement is null every time. I also obfuscate in AuditLogManager where log with exception is treated because there an exception message appended to that log entry and just to be safe I rather obfuscate it there as well.&lt;/p&gt;</comment>
                            <comment id="17360535" author="edimitrova" created="Thu, 10 Jun 2021 04:24:32 +0000"  >&lt;p&gt;Hi all,&lt;/p&gt;

&lt;p&gt;First of all, great job.&lt;/p&gt;

&lt;p&gt;Feedback/questions:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I guess you opted in for the centralized solution and maybe the question is whether we want the users to be given the chance not to obfuscate passwords if they want to when they use FQL? Is that correct? &#160;&lt;/li&gt;
	&lt;li&gt;The ticket is still work in progress not in review but I made a review on the latest pull request as I see everyone was working on it lately and I had the impression that is what was decided?&#160;&lt;/li&gt;
	&lt;li&gt;I think we might want to add tests for the corner cases identified in the previous comment by Stefan. (Great catch!) Also, I found one more weird corner case which Stefan&apos;s patch took care of. If a user does an invalid batch request including DCL - that would be logged as below with the password still being &lt;em&gt;password_a&lt;/em&gt;:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO&#160; [Native-Transport-Requests-1] 2021-06-09 23:38:05,965 FileAuditLogger.java:51 - user:anonymous|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:63360|timestamp:1623296285965|type:REQUEST_FAILURE|category:ERROR|operation:BEGIN BATCH CREATE ROLE alice WITH PASSWORD = &lt;span class=&quot;code-quote&quot;&gt;&apos;password_a&apos;&lt;/span&gt; AND LOGIN = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;; CREATE ROLE new_role; APPLY BATCH;; line 1:12 mismatched input &lt;span class=&quot;code-quote&quot;&gt;&apos;CREATE&apos;&lt;/span&gt; expecting K_APPLY (BEGIN BATCH [CREATE]...)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I know it is highly unlikely to happen but It was there and Stefan&apos;s latest patch takes care of it. We might want to add a test for that edge case too&#160;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;I didn&apos;t see &lt;a href=&quot;https://github.com/apache/cassandra/pull/1043/commits/07990ebaba79e6d9553de14733e28d89caa5e171#diff-df97ca69d481fde559e155c724ca60967a1e57222ea845d8ee8299d7b014df46R86&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this question &lt;/a&gt; being resolved&lt;/li&gt;
	&lt;li&gt;Do we need an interface? What other implementations are planned?&#160;&lt;/li&gt;
	&lt;li&gt;I believe the rest is nits on the PR itself.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I will make another pass tomorrow morning again&lt;/p&gt;</comment>
                            <comment id="17360546" author="edimitrova" created="Thu, 10 Jun 2021 04:30:20 +0000"  >&lt;p&gt;One more comment which probably we can address in a new ticket for improvement:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
cqlsh&amp;gt; CREATE ROLE role1 WITH PASSWORD = &lt;span class=&quot;code-quote&quot;&gt;&apos;me&apos;&lt;/span&gt; AND LOGIN = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
InvalidRequest: Error from server: code=2200 [Invalid query] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.cassandra.auth.CassandraRoleManager doesn&apos;t support PASSWORD&quot;&lt;/span&gt;
cqlsh&amp;gt; CREATE ROLE role1;
Unauthorized: Error from server: code=2100 [Unauthorized] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;You have to be logged in and not anonymous to perform &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; request&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I believe the first error message might be confusing for a user.&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="17360888" author="stefan.miklosovic" created="Thu, 10 Jun 2021 13:20:23 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;we decided on not providing a user any possibility to not obfuscated passwords. We do not see any use case behind that. Why would you want to have them in plain text in the first place?&lt;/li&gt;
	&lt;li&gt;yes, still WIP be we were about to close the last bits but we found more issues&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This batch issue is rather complicated, it also leaks stuff like this:&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
BEGIN BATCH
   CREATE ROLE alice WITH PASSWORD = &lt;span class=&quot;code-quote&quot;&gt;&apos;alice123&apos;&lt;/span&gt; and LOGIN = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
   CREATE ROLE alice2 WITH PASSWORD = &lt;span class=&quot;code-quote&quot;&gt;&apos;alice2123&apos;&lt;/span&gt; and LOGIN = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
APPLY BATCH;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The entry, currently, looks like:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Type: audit
LogMessage: user:cassandra|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:56698|timestamp:1623322819632|type:REQUEST_FAILURE|category:ERROR|operation:BEGIN BATCH
CREATE ROLE alice WITH PASSWORD = &lt;span class=&quot;code-quote&quot;&gt;&apos;alice123&apos;&lt;/span&gt; and LOGIN = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
CREATE ROLE alice2 WITH PASSWORD = &lt;span class=&quot;code-quote&quot;&gt;&apos;*******&apos;&lt;/span&gt; and LOGIN = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
APPLY BATCH;; line 2:0 mismatched input &lt;span class=&quot;code-quote&quot;&gt;&apos;CREATE&apos;&lt;/span&gt; expecting K_APPLY (BEGIN BATCH[CREATE]...)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I started to fix this but that is more complicated than it looks so I am not fixing it as of now.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I added it to my commits&lt;/li&gt;
	&lt;li&gt;thinking more about it, we do not need an interface tbh, I was thinking we do but it is not necessary, if we ever needed that, we might just create one afterwards so we should return to simple impl, sorry for the mess.&lt;/li&gt;
	&lt;li&gt;I addressed your issues&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The problem with adding a test for failing request like that is that I can not receive it in the tests of AuditAuthLoggerTest, if I want to do something like this:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testREQUEST_FAILUREAuditing()
{
    createTestRole();
    &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; cql = &lt;span class=&quot;code-quote&quot;&gt;&quot;BEGIN BATCH \n&quot;&lt;/span&gt; +
                 &lt;span class=&quot;code-quote&quot;&gt;&quot;    CREATE ROLE alice WITH PASSWORD = &lt;span class=&quot;code-quote&quot;&gt;&apos;alice123&apos;&lt;/span&gt; and LOGIN = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;; \n&quot;&lt;/span&gt; +
                 &lt;span class=&quot;code-quote&quot;&gt;&quot;APPLY BATCH&quot;&lt;/span&gt;;
    executeWithCredentials(Arrays.asList(cql), CASS_USER, CASS_PW, AuditLogEntryType.REQUEST_FAILURE);
    assertTrue(getInMemAuditLogger().size() &amp;gt; 0);
    AuditLogEntry logEntry = getInMemAuditLogger().poll();
    assertLogEntry(logEntry, AuditLogEntryType.REQUEST_FAILURE, cql, CASS_USER);
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;the method &quot;executeWithCredentials&quot; will fails as such so the test will never proceed because the underlying driver evaluates this as a failure and it throws an exception and whole test fails so I think it is enough to test this empirically of you do not have any idea how to actually solve this. We might add a test which tests the obfuscator though, there is not any problem with that.&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;&#160;I have put these things together here &lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-16669-queryevents&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/instaclustr/cassandra/tree/CASSANDRA-16669-queryevents&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I do not know why but I am not able to create a pull request against your branch anymore.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17360947" author="edimitrova" created="Thu, 10 Jun 2021 14:21:49 +0000"  >&lt;blockquote&gt;&lt;blockquote&gt;&lt;p&gt;&#160;&#160;&lt;font color=&quot;#172b4d&quot;&gt;we decided on not providing a user any possibility to not obfuscated passwords. We do not see any use case behind that. Why would you want to have them in plain text in the first place?&lt;/font&gt;&lt;/p&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Benjamin pointed me correctly to&#160;the&#160;mailing&#160;list that was agreed already, my bad.&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;ul&gt;
	&lt;li&gt;yes, still WIP be we were about to close the last bits but we found more issues&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;That is fine, I will continue testing and thinking of other cases. Thank you for addressing my comments and looking into the BATCH part. Please, let me know if I can help with something there.&lt;/p&gt;
&lt;blockquote&gt;&lt;ul&gt;
	&lt;li&gt;thinking more about it, we do not need an interface tbh, I was thinking we do but it is not necessary, if we ever needed that, we might just create one afterwards so we should return to simple impl, sorry for the mess.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;I think it was needed with the initial solution but not with the centralized one. Thanks for removing it. Not a mess, it is just still work in progress. Appreciate all your efforts.&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;We might add a test which tests the obfuscator though, there is not any problem with that.&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;What test do you have in mind? I will think about it too.&#160;&lt;/p&gt;</comment>
                            <comment id="17361165" author="edimitrova" created="Thu, 10 Jun 2021 18:32:19 +0000"  >&lt;p&gt;I have one main concern here and it is that we might be missing cases with the regex and it is hard to cover all possible corner cases. Also, one little change somewhere in behavior can break it. Did anyone of you think about a more robust way to extract only the PASSWORD value? I just wanted to run the idea here before I start digging into that. Also, if this is not really an option with this patch, should we consider going back to Vinay&apos;s idea from the dev mailing list to exclude the DCL statements for 4.0.0 and finish the obfuscation for 4.0.1?&#160;&lt;/p&gt;</comment>
                            <comment id="17361183" author="JIRAUSER308715" created="Thu, 10 Jun 2021 19:06:07 +0000"  >&lt;p&gt;I would suggest going back to the simplified version for 4.0.0.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This follows a rather less complicated approach of obfuscating anything that follows &quot;password&quot; token in the DCL query, inspired from what the PostgreSQL Audit Extension (pgAudit) does.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That or just excluding all CREATE/ALTER ROLE DCL statements.&lt;/p&gt;

&lt;p&gt;There can then be a follow up ticket that actually uses the ANTLR grammar parsed statement to pull out the password field and only remove that, if it is what people want.&lt;/p&gt;</comment>
                            <comment id="17361186" author="brandon.williams" created="Thu, 10 Jun 2021 19:10:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;I would suggest going back to the simplified version for 4.0.0.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1 to that and following up with ANTLR later.  I don&apos;t think we have the resources for the full proper solution at this point in time in the release cycle.&lt;/p&gt;</comment>
                            <comment id="17361190" author="edimitrova" created="Thu, 10 Jun 2021 19:21:24 +0000"  >&lt;p&gt;One suggestion is to get as intermediate solution to the initial proposal based on Postgre for 4.0.0 so we can have something better than removing DCL as a whole but to work on the robust solution to obfuscate only the particular password field in 4.0.1. Not perfect but intermediate and we can take the time to do a robust solution. Any thoughts anyone? I am open for brainstorming, looking into it with Sumanth and Stefan in Slack at the moment.&#160;&lt;/p&gt;</comment>
                            <comment id="17361191" author="edimitrova" created="Thu, 10 Jun 2021 19:26:52 +0000"  >&lt;p&gt;Our comments crashed, thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjordan&quot; class=&quot;user-hover&quot; rel=&quot;jjordan&quot;&gt;jjordan&lt;/a&gt;&#160;and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;&#160;for looking into this.&#160;&lt;/p&gt;</comment>
                            <comment id="17361221" author="vinaykumarcse" created="Thu, 10 Jun 2021 20:44:14 +0000"  >&lt;p&gt;I am on +1 on&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I would suggest going back to the simplified version for 4.0.0.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;It is better than excluding DCL, and an operator mistake/oops could lead to exposing passwords, so I feel this is better.&lt;/p&gt;</comment>
                            <comment id="17361769" author="edimitrova" created="Fri, 11 Jun 2021 13:31:34 +0000"  >&lt;p&gt;Thank you all! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;&#160;already updated his PR and I am starting another round of review.&#160;&lt;/p&gt;</comment>
                            <comment id="17361780" author="stefan.miklosovic" created="Fri, 11 Jun 2021 13:43:30 +0000"  >&lt;p&gt;Hey, I am running builds, I target the merging on Monday to sleep on it.&lt;/p&gt;</comment>
                            <comment id="17361958" author="sumanth.pasupuleti" created="Fri, 11 Jun 2021 18:39:33 +0000"  >&lt;p&gt;I am out due to emergency. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vinaykumarcse&quot; class=&quot;user-hover&quot; rel=&quot;vinaykumarcse&quot;&gt;vinaykumarcse&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; please take the patch forward, thank you!&lt;/p&gt;</comment>
                            <comment id="17362204" author="edimitrova" created="Sat, 12 Jun 2021 00:28:13 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt;&#160;for all your work. I spent some time on the patch today and I did also a lot of additional manual testing to be sure about my understanding about how things work.&#160;&lt;/p&gt;

&lt;p&gt;Attached is a &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/pull/140&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR &lt;/a&gt; containing your &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/pull/140/commits/b2ed399c0818c0d3616fdb353a089829be469d3e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit &lt;/a&gt; and &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/pull/140/commits/3b57f9ccfc6cec0a677463bc1f0cef722d61dbab&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit &lt;/a&gt; with my small review comments. The new tests are all passing locally for me.&#160;&lt;/p&gt;

&lt;p&gt;I added a few sentences to the docs to reflect the current limitations around password obfuscation.&lt;/p&gt;

&lt;p&gt;I am currently running full CI -&#160;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/954/workflows/5e3fa9b6-0c5f-443a-880f-7635d04cea18&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java 8 &lt;/a&gt; | &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/954/workflows/edb2b149-f237-4302-8814-3c41b8fb9035&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java 11 &lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I was thinking of more tests to add but after running more FQL and the AuditLogging locally I think the current suite satisfies the needs as we have a centralized solution within the &lt;em&gt;QueryEvents&lt;/em&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vinaykumarcse&quot; class=&quot;user-hover&quot; rel=&quot;vinaykumarcse&quot;&gt;vinaykumarcse&lt;/a&gt;, please, correct me if I am wrong as you are the author and you might have some additional deep knowledge. Please let me know If you want me to add something more.&lt;/p&gt;

&lt;p&gt;Currently we obfuscate with ******** everything after the word password in a DCL statement record so I would expect more information than less to be obfuscated.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;NOTE:&lt;/b&gt;&#160;On green CI and +1 from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vinaykumarcse&quot; class=&quot;user-hover&quot; rel=&quot;vinaykumarcse&quot;&gt;vinaykumarcse&lt;/a&gt;&#160;I will propagate to cassandra-4.0 and trunk branches and commit. I was informed by&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aholmber&quot; class=&quot;user-hover&quot; rel=&quot;aholmber&quot;&gt;aholmber&lt;/a&gt;&#160; that&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt;&#160;agreed if we are done before he is back next week to merge the change on +1 from me and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vinaykumarcse&quot; class=&quot;user-hover&quot; rel=&quot;vinaykumarcse&quot;&gt;vinaykumarcse&lt;/a&gt;&#160;so we can unblock the 4.0 RC2&lt;/p&gt;

&lt;p&gt;I am +1 to the patch on green CI completion. I will check back a bit later tonight if there are any new failures.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17362217" author="edimitrova" created="Sat, 12 Jun 2021 02:13:25 +0000"  >&lt;p&gt;There is one &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/954/workflows/5e3fa9b6-0c5f-443a-880f-7635d04cea18/jobs/5693&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;single failure &lt;/a&gt; which is not related.&#160;&lt;/p&gt;</comment>
                            <comment id="17363396" author="vinaykumarcse" created="Tue, 15 Jun 2021 06:16:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; Latest changes LGTM, except for a couple of minor nitpicks at latest &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/pull/140&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I confirm that the local testing of valid/invalid DCL statements obfuscated passwords&lt;/p&gt;

&lt;p&gt;&lt;b&gt;before&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Type: audit
LogMessage: user:cassandra|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:62542|timestamp:1621049034578|type:REQUEST_FAILURE|category:ERROR|operation:CREATE ROLE bob WITH PASSWORD=&lt;span class=&quot;code-quote&quot;&gt;&apos;password_b&apos;&lt;/span&gt; AND LOGIN = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; AND SUPERUSER = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;; bob already exists
Type: audit
LogMessage: user:cassandra|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:62542|timestamp:1621049057271|type:REQUEST_FAILURE|category:ERROR|operation:CREATE ROLE bob WITH PASSWORD=&lt;span class=&quot;code-quote&quot;&gt;&apos;password_b&apos;&lt;/span&gt; AND LOGIN = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; AND SUPERUSER = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;; bob already exists

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;after&lt;/b&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Type: audit
LogMessage: user:cassandra|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:59634|timestamp:1623736337400|type:REQUEST_FAILURE|category:ERROR|operation:CREATE ROLE bob WITH PASSWORD *******; bob already exists
Type: audit
LogMessage: user:cassandra|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:59634|timestamp:1623736351148|type:REQUEST_FAILURE|category:ERROR|operation:CREATE ROLE bob1 WITH PASSWORD *******; bob1 already exists
Type: audit
LogMessage: user:cassandra|host:localhost/127.0.0.1:7000|source:/127.0.0.1|port:59634|timestamp:1623736356902|type:CREATE_ROLE|category:DCL|operation:CREATE ROLE bob12 WITH PASSWORD *******
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;b&gt;CircleCI Tests:&lt;/b&gt;&lt;br/&gt;
 I could not run tests due to circleci account restrictions on my side, so I am leaning your test results.&lt;/p&gt;</comment>
                            <comment id="17363429" author="bereng" created="Tue, 15 Jun 2021 07:29:35 +0000"  >&lt;p&gt;I wanted to give a hand here and went over the PR. I focused on:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Invalid stmnts which do indeed obfuscate&lt;/li&gt;
	&lt;li&gt;Bypassing Audit logging through: inline cql comments, lexer &amp;amp; parser token hacking and similar corner cases&lt;/li&gt;
	&lt;li&gt;Generic review&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;And my feedback would be:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add a test case for &lt;tt&gt;CREATE /&amp;#42;password&amp;#42;/ ROLE bla bla&lt;/tt&gt; which would be a way to bypass&lt;/li&gt;
	&lt;li&gt;In the future move to lexer/parser level obfuscation&lt;/li&gt;
	&lt;li&gt;You can only hack the thing with useless stmnts like &lt;tt&gt;ALTER ROLE alicepassword...&lt;/tt&gt; that lead nowhere&lt;/li&gt;
	&lt;li&gt;So overall +1&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17363442" author="stefan.miklosovic" created="Tue, 15 Jun 2021 07:50:39 +0000"  >&lt;p&gt;I think we complicate this already, I am just fine how it is with a test from Vinay in GH I added. I am going to merge this today.&lt;/p&gt;</comment>
                            <comment id="17363449" author="stefan.miklosovic" created="Tue, 15 Jun 2021 07:59:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/864/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/864/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17363732" author="edimitrova" created="Tue, 15 Jun 2021 15:54:48 +0000"  >&lt;p&gt;Thank you all for your work!&lt;/p&gt;

&lt;p&gt;For visibility and the sake of completeness:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;There is a failure in the Jenkins devbranch run which is because the branch with the patch was not rebased so the &lt;a href=&quot;https://github.com/apache/cassandra/commit/a0af091a5cbceeaa2b8f724b1790b61ef512b033&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt; for which the failing test was created was missing. No new failures introduced by this patch. The post-commit CI is still running but the cqlsh tests are already &lt;a href=&quot;https://jenkins-cm4.apache.org/blue/organizations/jenkins/Cassandra-4.0.0/detail/Cassandra-4.0.0/27/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;successfully completed&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;blockquote&gt;&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Add a test case for &lt;tt&gt;CREATE /&lt;b&gt;password&lt;/b&gt;/ ROLE bla bla&lt;/tt&gt; which would be a way to bypass&lt;/li&gt;
	&lt;li&gt;In the future move to lexer/parser level obfuscation&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;You can only hack the thing with useless stmnts like &lt;tt&gt;ALTER ROLE alicepassword...&lt;/tt&gt; that lead nowhere&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;These cases are covered in the latest patch as the patch is simple and drastic at this point until we work on the mentioned improvement for 4.0.1, It simply takes the DCL statement as a String and checks for password substring (upper case, mixed case, and lower case covered) and then obfuscates everything after it; non-valid statements are also covered which is visible from the test added by Vinay.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13389459">CASSANDRA-16801</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[sumanth.pasupuleti]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313826" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Change Category</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13005"><![CDATA[Operability]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13103"><![CDATA[Security]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0r1tc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
        <customfieldvalue><![CDATA[e.dimitrova]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
        <customfieldvalue><![CDATA[vinaykumarcse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/f978bea272409109e312a27a121f849879650bdb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/f978bea272409109e312a27a121f849879650bdb&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/pull/140&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ekaterinadimitrova2/cassandra/pull/140&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Additional tests and docs added as part of the patch&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>