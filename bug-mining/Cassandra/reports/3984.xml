<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10288] Incremental repair can hang if replica aren&apos;t all up (was: Inconsistent behaviours on repair when a node in RF is missing)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10288</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;So with a cluster of 3 nodes and a RF=3 for my keyspace, I tried to repair my data with a single node down. I got 3 different behaviours with different C* versions. With:&lt;/p&gt;

&lt;p&gt;cassandra-2.1: it fails saying a node is down. (acceptable)&lt;br/&gt;
cassandra-2.2: it hangs forever (???)&lt;br/&gt;
cassandra-3.0: it completes successfully&lt;/p&gt;

&lt;p&gt;What is the correct behaviour of this repair use case? Obviously, cassandra-2.2 has to be fixed, too.&lt;/p&gt;

&lt;p&gt;Here are the result logs when testing:&lt;br/&gt;
cassandra-2.1&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ccmlib.node.NodetoolError: Nodetool command &lt;span class=&quot;code-quote&quot;&gt;&apos;/home/aboudreault/git/cstar/cassandra/bin/nodetool -h localhost -p 7100 repair test test&apos;&lt;/span&gt; failed; exit status: 2; stdout: [2015-09-08 16:32:24,488] Starting repair command #3, repairing 3 ranges &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; keyspace test (parallelism=SEQUENTIAL, full=&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;)
[2015-09-08 16:32:24,492] Repair session b69b5990-5668-11e5-b4ae-b3ffbc47f04c &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (3074457345618258602,-9223372036854775808] failed with error java.io.IOException: Cannot proceed on repair because a neighbor (/127.0.0.2) is dead: session failed
[2015-09-08 16:32:24,493] Repair session b69b80a0-5668-11e5-b4ae-b3ffbc47f04c &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (-9223372036854775808,-3074457345618258603] failed with error java.io.IOException: Cannot proceed on repair because a neighbor (/127.0.0.2) is dead: session failed
[2015-09-08 16:32:24,494] Repair session b69ba7b0-5668-11e5-b4ae-b3ffbc47f04c &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range (-3074457345618258603,3074457345618258602] failed with error java.io.IOException: Cannot proceed on repair because a neighbor (/127.0.0.2) is dead: session failed
[2015-09-08 16:32:24,494] Repair command #3 finished
; stderr: error: nodetool failed, check server logs
-- StackTrace --
java.lang.RuntimeException: nodetool failed, check server logs
        at org.apache.cassandra.tools.NodeTool$NodeToolCmd.run(NodeTool.java:291)
        at org.apache.cassandra.tools.NodeTool.main(NodeTool.java:203)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;cassandra-2.2:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;just hangs .... waited more than 10 minutes.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;cassandra-3.0:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;$ ccm node1 nodetool repair test test

[2015-09-08 16:39:40,139] Starting repair command #1, repairing keyspace test with repair options (parallelism: parallel, primary range: &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;, incremental: &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, job threads: 1, ColumnFamilies: [test], dataCenters: [], hosts: [], # of ranges: 2)
[2015-09-08 16:39:40,241] Repair session ba4a1440-5669-11e5-bc8e-b3ffbc47f04c &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; range [(3074457345618258602,-9223372036854775808], (-9223372036854775808,3074457345618258602]] finished (progress: 80%)
[2015-09-08 16:39:40,267] Repair completed successfully
[2015-09-08 16:39:40,270] Repair command #1 finished in 0 seconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12862552">CASSANDRA-10288</key>
            <summary>Incremental repair can hang if replica aren&apos;t all up (was: Inconsistent behaviours on repair when a node in RF is missing)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="aboudreault">Alan Boudreault</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Sep 2015 20:56:53 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:57 +0000</updated>
                            <resolved>Wed, 2 Dec 2015 14:56:52 +0000</resolved>
                                        <fixVersion>2.1.12</fixVersion>
                    <fixVersion>2.2.4</fixVersion>
                    <fixVersion>3.0.1</fixVersion>
                    <fixVersion>3.1</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14735611" author="aboudreault" created="Tue, 8 Sep 2015 21:06:18 +0000"  >&lt;p&gt;adding a bash script to reproduce the issue &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12754735/12754735_repait_test.sh&quot; title=&quot;repait_test.sh attached to CASSANDRA-10288&quot;&gt;repait_test.sh&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="14735678" author="yukim" created="Tue, 8 Sep 2015 21:45:23 +0000"  >&lt;p&gt;It&apos;s actually the same behavior among versions (2.1 with -inc -par is the same as others).&lt;br/&gt;
Using incremental repair with nodes less than RF can hang, since coordinator sends prepare messages to all nodes (dead or alive) and wait for response.&lt;/p&gt;

&lt;p&gt;I will fix this by checking live nodes beforehand.&lt;/p&gt;</comment>
                            <comment id="14735832" author="jbellis" created="Tue, 8 Sep 2015 23:35:43 +0000"  >&lt;p&gt;Checking live nodes beforehand is good, but you can still have a node fail after the check.  There should probably be a timeout-and-abort path as well.&lt;/p&gt;</comment>
                            <comment id="14738975" author="yukim" created="Thu, 10 Sep 2015 15:55:14 +0000"  >&lt;p&gt;Patch here: &lt;a href=&quot;https://github.com/yukim/cassandra/tree/10288-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt; &lt;a href=&quot;https://github.com/yukim/cassandra/tree/10288-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt; &lt;a href=&quot;https://github.com/yukim/cassandra/tree/10288-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/job/yukim-10288-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; and &lt;a href=&quot;http://cassci.datastax.com/job/yukim-10288-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I added live node check before sending prepare and anticompaction message.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;There should probably be a timeout-and-abort path as well.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There are timeout actually, but it&apos;s set to long (1 hour / 1 day).&lt;br/&gt;
I feel the need to periodically ping repair status of all replica, since timeout is not suitable for every environment, and still message can be lost.&lt;br/&gt;
&lt;del&gt;I will create the ticket for this.&lt;/del&gt; Created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10302&quot; title=&quot;Track repair state for more reliable repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10302&quot;&gt;CASSANDRA-10302&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14740875" author="aboudreault" created="Fri, 11 Sep 2015 14:13:38 +0000"  >&lt;p&gt;+1. Tested all patches and seems to work well. Have you wrote a dtest, or just ran them with your changes? If you wrote one, just ping me in the github PR.&lt;/p&gt;</comment>
                            <comment id="14740908" author="yukim" created="Fri, 11 Sep 2015 14:30:55 +0000"  >&lt;p&gt;I wrote one that sets up 3 node cluster and do incremental repair with one down.&lt;br/&gt;
But before this patch it just hangs and not sure how to write &quot;check if not hang&quot; kind of test properly.&lt;/p&gt;

&lt;p&gt;I can make PR for that version though.&lt;/p&gt;</comment>
                            <comment id="14740913" author="aboudreault" created="Fri, 11 Sep 2015 14:38:43 +0000"  >&lt;p&gt;just add a @require until we get all patches committed&lt;/p&gt;</comment>
                            <comment id="14984894" author="krummas" created="Mon, 2 Nov 2015 08:53:32 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15035908" author="yukim" created="Wed, 2 Dec 2015 14:56:52 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12754735" name="repait_test.sh" size="1126" author="aboudreault" created="Tue, 8 Sep 2015 21:06:18 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 50 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jwvr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    <customfieldvalue id="12332983">2.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aboudreault</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>