<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:44:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6924] Data Inserted Immediately After Secondary Index Creation is not Indexed</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6924</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The head of the cassandra-1.2 branch (currently 1.2.16-tentative) contains a regression from 1.2.15.  Data that is inserted immediately after secondary index creation may never get indexed.&lt;/p&gt;

&lt;p&gt;You can reproduce the issue with a &lt;a href=&quot;https://github.com/pycassa/pycassa/blob/master/tests/test_autopacking.py#L793&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;pycassa integration test&lt;/a&gt; by running:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;nosetests tests/test_autopacking.py:TestKeyValidators.test_get_indexed_slices
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;from the pycassa directory.&lt;/p&gt;

&lt;p&gt;The operation order goes like this:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;create CF&lt;/li&gt;
	&lt;li&gt;create secondary index&lt;/li&gt;
	&lt;li&gt;insert data&lt;/li&gt;
	&lt;li&gt;query secondary index&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;If a short sleep is added in between steps 2 and 3, the data gets indexed and the query is successful.&lt;/p&gt;

&lt;p&gt;If a sleep is only added in between steps 3 and 4, some of the data is never indexed and the query will return incomplete results.  This appears to be the case even if the sleep is relatively long (30s), which makes me think the data may never get indexed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12703555">CASSANDRA-6924</key>
            <summary>Data Inserted Immediately After Secondary Index Creation is not Indexed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="thobbs">Tom Hobbs</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Mar 2014 18:56:53 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:50 +0000</updated>
                            <resolved>Tue, 15 Apr 2014 12:23:55 +0000</resolved>
                                        <fixVersion>2.1 beta2</fixVersion>
                                    <component>Feature/2i Index</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="13948005" author="slebresne" created="Wed, 26 Mar 2014 15:32:17 +0000"  >&lt;p&gt;How reliable is the test failure on your box? I just tried said test (5 times so far) without reproducing the failure.&lt;/p&gt;</comment>
                            <comment id="13948055" author="rhatch" created="Wed, 26 Mar 2014 16:23:58 +0000"  >&lt;p&gt;This came up on the cassandra user&apos;s list as well (March 13th). I tried unsuccessfully to reproduce but there&apos;s got to be something going on here. If we can figure out what&apos;s triggering the issue I&apos;d be glad to add this to dtest.&lt;/p&gt;</comment>
                            <comment id="13948056" author="rhatch" created="Wed, 26 Mar 2014 16:27:39 +0000"  >&lt;p&gt;Oops looks like I was a bit wrong, the mailing list issue was inserting data first, then creating the secondary index so perhaps not the exact same problem.&lt;/p&gt;</comment>
                            <comment id="13948070" author="thobbs" created="Wed, 26 Mar 2014 16:34:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;How reliable is the test failure on your box? I just tried said test (5 times so far) without reproducing the failure.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;When run against a three-node ccm cluster, it fails about 80% of the time.  I&apos;ll run a bisect to pinpoint the cause.&lt;/p&gt;</comment>
                            <comment id="13948631" author="thobbs" created="Wed, 26 Mar 2014 23:17:11 +0000"  >&lt;p&gt;After a few unsuccessful bisect runs, it looks like this problem is caused by 1) dropping and recreating a keyspace too quickly, or 2) querying a secondary index too quickly after creation.  I&apos;m not sure why these are more problematic in 1.2.16-tentative than in 1.2.15. (Bisect roughly pointed at &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6700&quot; title=&quot;Use real node messaging versions for schema exchange decisions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6700&quot;&gt;&lt;del&gt;CASSANDRA-6700&lt;/del&gt;&lt;/a&gt;, which doesn&apos;t make a lot of sense.)&lt;/p&gt;

&lt;p&gt;With unique keyspace names each run, a 1s sleep after creating the index and inserting the data was enough to guarantee correct results.  When re-using the same keyspace name, even a 30s sleep wasn&apos;t always enough (as I noted before).  That&apos;s annoying, but since it goes against recommended practices (and we have a proper fix in 2.1?), I&apos;m okay with marking this as invalid.&lt;/p&gt;</comment>
                            <comment id="13948678" author="enigmacurry" created="Wed, 26 Mar 2014 23:54:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;and we have a proper fix in 2.1?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m aware of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5202&quot; title=&quot;CFs should have globally and temporally unique CF IDs to prevent &amp;quot;reusing&amp;quot; data from earlier incarnation of same CF name&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5202&quot;&gt;&lt;del&gt;CASSANDRA-5202&lt;/del&gt;&lt;/a&gt; for reusing CFs, what&apos;s the 2.1 fix of the same for keyspaces?&lt;/p&gt;</comment>
                            <comment id="13949464" author="thobbs" created="Thu, 27 Mar 2014 15:43:45 +0000"  >&lt;p&gt;I assumed that the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5202&quot; title=&quot;CFs should have globally and temporally unique CF IDs to prevent &amp;quot;reusing&amp;quot; data from earlier incarnation of same CF name&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5202&quot;&gt;&lt;del&gt;CASSANDRA-5202&lt;/del&gt;&lt;/a&gt; fix would cover this as well, but after some quick testing, it looks like 2.1 still has the same problem.&lt;/p&gt;</comment>
                            <comment id="13949476" author="thobbs" created="Thu, 27 Mar 2014 15:58:49 +0000"  >&lt;p&gt;Attaching a simple python script that reproduces the issue.&lt;/p&gt;</comment>
                            <comment id="13955489" author="enigmacurry" created="Mon, 31 Mar 2014 18:26:36 +0000"  >&lt;p&gt;I ported &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt;&apos; pycassa test to &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/commit/36960090d219ab8dbc7f108faa91c3ea5cea2bec&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a CQL based dtest&lt;/a&gt;. It&apos;s failing on 1.2, 2.0, and 2.1 HEAD.&lt;/p&gt;</comment>
                            <comment id="13955505" author="enigmacurry" created="Mon, 31 Mar 2014 18:45:07 +0000"  >&lt;p&gt;Also, this test raises some assertion errors that may be related, but I created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6959&quot; title=&quot;Reusing Keyspace and CF names raises assertion errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6959&quot;&gt;&lt;del&gt;CASSANDRA-6959&lt;/del&gt;&lt;/a&gt; for them.&lt;/p&gt;</comment>
                            <comment id="13969428" author="beobal" created="Tue, 15 Apr 2014 10:48:55 +0000"  >&lt;p&gt;This doesn&apos;t seem like a regression as the repro script fails for me just as consistently on 1.2.15 as it does on later versions.&lt;/p&gt;

&lt;p&gt;The issue appears to be that when a ks or cf is dropped, we don&apos;t update system.IndexInfo to remove the entry for the 2i. Then when the ks/cf &amp;amp; index are recreated, we treat the index creation not as a brand new index, but as if we&apos;re restarting and linking in an existing index to the cf. So we skip the buildIndexAsync call that we should make which is what causes some entries to never get indexed. &lt;/p&gt;

&lt;p&gt;Fixing this so that we do clean up IndexInfo leads to us running into &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5202&quot; title=&quot;CFs should have globally and temporally unique CF IDs to prevent &amp;quot;reusing&amp;quot; data from earlier incarnation of same CF name&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5202&quot;&gt;&lt;del&gt;CASSANDRA-5202&lt;/del&gt;&lt;/a&gt; on pre-2.1 branches. On 2.1, we see the issues mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6959&quot; title=&quot;Reusing Keyspace and CF names raises assertion errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6959&quot;&gt;&lt;del&gt;CASSANDRA-6959&lt;/del&gt;&lt;/a&gt; so as Sylvain suggests there, the test needs to be changed to wait for schema agreement. This can be acheived with a 1s wait, or by actively testing for agreement. Now that the buildIndexAsync call is happening on index initialisation, we can insert this wait in one of two places: between the index creation and the inserts, or between the inserts and the reads. I&apos;ve updated the dtest accordingly and added another variant which drops just the cf, rather than the entire ks (&lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/40&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/pull/40&lt;/a&gt;). I do still see the errors from &lt;tt&gt;CommitLogSegmentManager&lt;/tt&gt; on 2.1 detailed on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6959&quot; title=&quot;Reusing Keyspace and CF names raises assertion errors&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6959&quot;&gt;&lt;del&gt;CASSANDRA-6959&lt;/del&gt;&lt;/a&gt; even after applying the patch attached to that issue.&lt;/p&gt;

&lt;p&gt;Likewise, using Tyler&apos;s original repro script, a 1s sleep before commencing the reads is now enough to ensure the run succeeds (on the 2.1 branch).&lt;/p&gt;

&lt;p&gt;On trunk, I get completely different errors running both the dtest &amp;amp; repro.py, both with and without the IndexInfo fix:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [Thrift:1] 2014-04-14 15:45:10,714 CustomTThreadPoolServer.java:212 - Error occurred during processing of message.
java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.IllegalArgumentException: fromIndex(34) &amp;gt; toIndex(25)
        at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:411) ~[main/:na]
        at org.apache.cassandra.service.MigrationManager.announce(MigrationManager.java:281) ~[main/:na]
        at org.apache.cassandra.service.MigrationManager.announceColumnFamilyUpdate(MigrationManager.java:242) ~[main/:na]
        at org.apache.cassandra.cql3.statements.CreateIndexStatement.announceMigration(CreateIndexStatement.java:141) ~[main/:na]
        at org.apache.cassandra.cql3.statements.SchemaAlteringStatement.execute(SchemaAlteringStatement.java:71) ~[main/:na]
        at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:180) ~[main/:na]
        at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:214) ~[main/:na]
        at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:204) ~[main/:na]
        at org.apache.cassandra.thrift.CassandraServer.execute_cql3_query(CassandraServer.java:1973) ~[main/:na]
        at org.apache.cassandra.thrift.Cassandra$Processor$execute_cql3_query.getResult(Cassandra.java:4486) ~[thrift/:na]
        at org.apache.cassandra.thrift.Cassandra$Processor$execute_cql3_query.getResult(Cassandra.java:4470) ~[thrift/:na]
        at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:39) ~[libthrift-0.9.1.jar:0.9.1]
        at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:39) ~[libthrift-0.9.1.jar:0.9.1]
        at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:194) ~[main/:na]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [na:1.7.0_51]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_51]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744) [na:1.7.0_51]
Caused by: java.util.concurrent.ExecutionException: java.lang.IllegalArgumentException: fromIndex(34) &amp;gt; toIndex(25)
        at java.util.concurrent.FutureTask.report(FutureTask.java:122) ~[na:1.7.0_51]
        at java.util.concurrent.FutureTask.get(FutureTask.java:188) ~[na:1.7.0_51]
        at org.apache.cassandra.utils.FBUtilities.waitOnFuture(FBUtilities.java:407) ~[main/:na]
        ... 16 common frames omitted
Caused by: java.lang.IllegalArgumentException: fromIndex(34) &amp;gt; toIndex(25)
        at java.util.TimSort.rangeCheck(TimSort.java:921) ~[na:1.7.0_51]
        at java.util.TimSort.sort(TimSort.java:182) ~[na:1.7.0_51]
        at java.util.Arrays.sort(Arrays.java:727) ~[na:1.7.0_51]
        at org.apache.cassandra.db.ArrayBackedSortedColumns.sortCells(ArrayBackedSortedColumns.java:113) ~[main/:na]
        at org.apache.cassandra.db.ArrayBackedSortedColumns.maybeSortCells(ArrayBackedSortedColumns.java:103) ~[main/:na]
        at org.apache.cassandra.db.ArrayBackedSortedColumns.getColumnCount(ArrayBackedSortedColumns.java:313) ~[main/:na]
        at org.apache.cassandra.db.ColumnFamilySerializer.contentSerializedSize(ColumnFamilySerializer.java:117) ~[main/:na]
        at org.apache.cassandra.db.ColumnFamilySerializer.serializedSize(ColumnFamilySerializer.java:132) ~[main/:na]
        at org.apache.cassandra.db.Mutation$MutationSerializer.serializedSize(Mutation.java:337) ~[main/:na]
        at org.apache.cassandra.db.commitlog.CommitLog.add(CommitLog.java:201) ~[main/:na]
        at org.apache.cassandra.db.commitlog.CommitLog.add(CommitLog.java:193) ~[main/:na]
        at org.apache.cassandra.db.Keyspace.apply(Keyspace.java:349) ~[main/:na]
        at org.apache.cassandra.db.Keyspace.apply(Keyspace.java:328) ~[main/:na]
        at org.apache.cassandra.db.Mutation.apply(Mutation.java:205) ~[main/:na]
        at org.apache.cassandra.db.DefsTables.mergeSchema(DefsTables.java:170) ~[main/:na]
        at org.apache.cassandra.service.MigrationManager$2.runMayThrow(MigrationManager.java:299) ~[main/:na]
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_51]
        at java.util.concurrent.FutureTask.run(FutureTask.java:262) ~[na:1.7.0_51]
        ... 3 common frames omitted

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13969484" author="iamaleksey" created="Tue, 15 Apr 2014 12:23:55 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12640252" name="6924-2.1.txt" size="1793" author="samt" created="Tue, 15 Apr 2014 10:49:06 +0000"/>
                            <attachment id="12637168" name="repro.py" size="1079" author="thobbs" created="Thu, 27 Mar 2014 15:58:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>381889</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tsmv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>382164</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326174">1.2.16</customfieldvalue>
    <customfieldvalue id="12326170">2.0.6</customfieldvalue>
    <customfieldvalue id="12326275">2.1 beta1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>