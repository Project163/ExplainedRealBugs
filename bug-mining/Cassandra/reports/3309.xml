<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7704] FileNotFoundException during STREAM-OUT triggers 100% CPU usage</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7704</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;See attached backtrace which was what triggered this. This stream failed and then ~12 seconds later it emitted that exception. At that point, all CPUs went to 100%. A thread dump shows all the ReadStage threads stuck inside IntervalTree.searchInternal inside of CFS.markReferenced().&lt;/p&gt;</description>
                <environment></environment>
        <key id="12732175">CASSANDRA-7704</key>
            <summary>FileNotFoundException during STREAM-OUT triggers 100% CPU usage</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="rbranson">Rick Branson</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 Aug 2014 23:17:08 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:38 +0000</updated>
                            <resolved>Sat, 16 Aug 2014 06:34:11 +0000</resolved>
                                        <fixVersion>2.0.12</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14087574" author="benedict" created="Wed, 6 Aug 2014 11:41:05 +0000"  >&lt;p&gt;Attaching a patch that I think addresses this. There are a number of concurrency bugs here, and whilst we could fix them with more advanced lock-freedom, there is no compelling reason this class doesn&apos;t use synchronized everywhere, which would probably have avoided this problem in the first place. There is only one place where the execution is not guaranteed to be prompt, and I have left this out of the synchronization. I have at the same time simplified the logic, and fixed the logic for cancelling timeouts, as well as made the scheduled executor for timeouts globally shared (there&apos;s no good reason to spinup a new executor for each set of transfers)&lt;/p&gt;

&lt;p&gt;In this particular instance the issue seems to have been a lack of atomicity between abort() and complete(); an ACK arrived at the same time as abort() was cancelling all transfers, causing a reference to be released twice. This could also occur with the timeouts, but since they occur only every 12hrs, the risk is low.&lt;/p&gt;</comment>
                            <comment id="14087575" author="benedict" created="Wed, 6 Aug 2014 11:42:06 +0000"  >&lt;p&gt;The patch is for 2.1, but we can backport to 2.0 once we agree on approach&lt;/p&gt;</comment>
                            <comment id="14087577" author="benedict" created="Wed, 6 Aug 2014 11:43:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rbranson&quot; class=&quot;user-hover&quot; rel=&quot;rbranson&quot;&gt;rbranson&lt;/a&gt;, ftr, could we get the earlier stack traces you saw and other related info? I suspect it&apos;s possible the earlier failing transfer caused a file to be deleted prematurely, which then caused this failure. Both the same bug.&lt;/p&gt;</comment>
                            <comment id="14088374" author="yukim" created="Wed, 6 Aug 2014 22:25:41 +0000"  >&lt;p&gt;I agree we have race in StreamTransferTask between abort and complete. Thanks for the catch.&lt;br/&gt;
We should fix it in 2.0 also.&lt;/p&gt;</comment>
                            <comment id="14090967" author="rbranson" created="Fri, 8 Aug 2014 17:03:14 +0000"  >&lt;p&gt;There wasn&apos;t anything in the logs that indicated &lt;b&gt;why&lt;/b&gt; the failure happened. Th I attached anything suspect. The IndexOutOfBoundsException occurred on the bootstrapping node &lt;b&gt;after&lt;/b&gt; the stream failure occurred on the node that was streaming out.&lt;/p&gt;

&lt;p&gt;There was a CompactionTask that ran at 2014-08-05 18:00:25,804 (4 minutes before the StreamOut task) that tried to compact that SSTable that referenced in the FileNotFoundException. No other log messages related to that file though.&lt;/p&gt;</comment>
                            <comment id="14091053" author="benedict" created="Fri, 8 Aug 2014 18:00:30 +0000"  >&lt;p&gt;My mistake. I thought on IRC you said there were errors preceding it that might be related. Not necessary at all, just thought they might be explicable.&lt;/p&gt;</comment>
                            <comment id="14093450" author="benedict" created="Mon, 11 Aug 2014 22:23:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; was that comment a +1 on the 2.0 patch, and asking for a corresponding 2.1 patch?&lt;/p&gt;</comment>
                            <comment id="14093461" author="benedict" created="Mon, 11 Aug 2014 22:34:33 +0000"  >&lt;p&gt;FTR, there was a (probably innocuous) mistake in that patch; fixed version attached.&lt;/p&gt;</comment>
                            <comment id="14094544" author="yukim" created="Tue, 12 Aug 2014 19:20:25 +0000"  >&lt;p&gt;I was +1 though looks like it breaks StreamTransferTaskTest.&lt;br/&gt;
Let me see if I can make it work.&lt;/p&gt;</comment>
                            <comment id="14096146" author="yukim" created="Wed, 13 Aug 2014 21:20:47 +0000"  >&lt;p&gt;&lt;tt&gt;complete&lt;/tt&gt; calls &lt;tt&gt;cancel&lt;/tt&gt; with interuption on ScheduledFuture, but since &lt;tt&gt;complete&lt;/tt&gt; is also called from scheduled task, ScheduledFuture#get always throws CancellationException even if it is run. This is causing StreamTransferTaskTest to fail.&lt;br/&gt;
Though returned ScheduledFuture is not used in production code, I feel the new behavior confusing.&lt;/p&gt;

&lt;p&gt;I  wrote the original to just let scheduled task run even if task is completed and noop. Can we do it in similar way?&lt;/p&gt;</comment>
                            <comment id="14096779" author="benedict" created="Thu, 14 Aug 2014 09:23:48 +0000"  >&lt;p&gt;Not cleaning up resources is really not ideal in my book, however there is absolutely no reason we need to cancel with interruption - note this does &lt;b&gt;not&lt;/b&gt; always result in a cancelled state if it ran, only if it was in the middle of running at the time (but still completed), and this can be fixed by not permitting it to be interrupted. However this is not the problem - in the test it will often be the case that the task was &lt;em&gt;genuinely&lt;/em&gt; successfully cancelled. In my opinion the test is broken, since previously there was &lt;em&gt;no&lt;/em&gt; guarantee that all cancellations would run (although the cancellation in the test case will); after the last task completes successfully the scheduled tasks were all removed from the queue (but &lt;b&gt;not&lt;/b&gt; cancelled), so the behaviour of the future in this case would be to never return, which is much more surprising and inconsistent in my book.&lt;/p&gt;

&lt;p&gt;I&apos;m not entirely sure what the offending line is intended to test, anyway?&lt;/p&gt;</comment>
                            <comment id="14097856" author="yukim" created="Thu, 14 Aug 2014 22:50:12 +0000"  >&lt;p&gt;Test is to check stream session state change after timeout task, and the test depends on current behavior of timeout task.&lt;br/&gt;
I&apos;m fine with changing test to match the new behavior.&lt;/p&gt;</comment>
                            <comment id="14098358" author="benedict" created="Fri, 15 Aug 2014 08:53:29 +0000"  >&lt;p&gt;Attaching a new version which does not cancel the task that was run, and updates the unit tests to match the new behaviour&lt;/p&gt;</comment>
                            <comment id="14098784" author="yukim" created="Fri, 15 Aug 2014 17:24:57 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14099527" author="benedict" created="Sat, 16 Aug 2014 06:33:52 +0000"  >&lt;p&gt;Committed to 2.0, 2.1.0 and 2.1 branches. I overwrote 2.0&apos;s contents with 2.1&apos;s, only removing the repairedAt property, since the only other difference was the lack of aborted property preventing inconsistent state.&lt;/p&gt;</comment>
                            <comment id="14268118" author="benedict" created="Wed, 7 Jan 2015 19:55:55 +0000"  >&lt;p&gt;Somewhat embarassingly, I never actually pushed this to the repository. It still applied relatively cleanly (with a bit of git butchery), so I&apos;ve simply pushed it. Updating fix version also.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12732298">CASSANDRA-7705</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12775933">CASSANDRA-8829</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12699420">CASSANDRA-6818</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12662032" name="7704-2.1.txt" size="8287" author="benedict" created="Fri, 15 Aug 2014 08:53:29 +0000"/>
                            <attachment id="12660124" name="7704.txt" size="6238" author="benedict" created="Wed, 6 Aug 2014 11:41:05 +0000"/>
                            <attachment id="12659994" name="backtrace.txt" size="1938" author="rbranson" created="Tue, 5 Aug 2014 23:17:08 +0000"/>
                            <attachment id="12660662" name="other-errors.txt" size="1268" author="rbranson" created="Fri, 8 Aug 2014 17:03:14 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410204</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 45 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ykqn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>410196</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326830">2.0.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12322954">2.0 beta 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>