<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5799] Column can expire while lazy compacting it...</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5799</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Using TTL + range tombstones can lead to failure while lazy compacting rows.&lt;/p&gt;

&lt;p&gt;Scenario to reproduce :&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;create an SSTable with one row and some columns and a TTL of 8 seconds&lt;/li&gt;
	&lt;li&gt;wait one second&lt;/li&gt;
	&lt;li&gt;create a second SSTable with the same rowkey as above, and add a range tombstone&lt;/li&gt;
	&lt;li&gt;start the first pass of the lazy compaction before the columns with TTL are expired&lt;/li&gt;
	&lt;li&gt;wait 10 seconds (enough for columns with TTL to expire)&lt;/li&gt;
	&lt;li&gt;continue lazy expiration&lt;/li&gt;
	&lt;li&gt;the following assertion will fail :&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; junit.framework.AssertionFailedError: originally calculated column size of 1379 but now it is 1082&lt;br/&gt;
    &lt;span class=&quot;error&quot;&gt;&amp;#91;junit&amp;#93;&lt;/span&gt; 	at org.apache.cassandra.db.compaction.LazilyCompactedRow.write(LazilyCompactedRow.java:150)&lt;/li&gt;
&lt;/ul&gt;



</description>
                <environment></environment>
        <key id="12659571">CASSANDRA-5799</key>
            <summary>Column can expire while lazy compacting it...</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="frousseau">Fabien Rousseau</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Jul 2013 13:37:36 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:09 +0000</updated>
                            <resolved>Fri, 26 Jul 2013 18:15:36 +0000</resolved>
                                        <fixVersion>1.2.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13718370" author="frousseau" created="Wed, 24 Jul 2013 13:45:21 +0000"  >&lt;p&gt;Note : it was initially reported here &lt;a href=&quot;http://www.mail-archive.com/user@cassandra.apache.org/msg31277.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/user@cassandra.apache.org/msg31277.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The row size is around 153Mb, thus, compacting at 16Mb/s =&amp;gt; around 9s to compact, which is an open window for columns to expire&lt;/p&gt;</comment>
                            <comment id="13718402" author="jbellis" created="Wed, 24 Jul 2013 14:20:08 +0000"  >&lt;p&gt;If it requires compaction to take longer than TTL to be a problem, I&apos;m inclined to say &quot;don&apos;t do that in 1.2.&quot;  2.0 has single-pass compaction so should not matter there.&lt;/p&gt;</comment>
                            <comment id="13718413" author="slebresne" created="Wed, 24 Jul 2013 14:28:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;If it requires compaction to take longer than TTL to be a problem&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, it only requires that a TTL expire between the first and second phase, which can happen whatever the TTL and compaction time is. For some reason, DeletionTime.isDeleted(), which is just supposed to check if the deletion time shadows a given column is completely broken (it checks if the columns is deleted which shouldn&apos;t even matter for that method) and depends on the current time. Attaching simple patch to fix.&lt;/p&gt;</comment>
                            <comment id="13718420" author="jbellis" created="Wed, 24 Jul 2013 14:35:56 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13718428" author="slebresne" created="Wed, 24 Jul 2013 14:45:09 +0000"  >&lt;p&gt;Alright, committed, thanks&lt;/p&gt;</comment>
                            <comment id="13721745" author="efalcao" created="Sat, 27 Jul 2013 20:34:26 +0000"  >&lt;p&gt;I was excited to see this fix in 1.2.7 but I fear it&apos;s still an issue. Here is a stack I just saw in my freshly upgraded 1.2.7 cluster:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [CompactionExecutor:17] 2013-07-27 17:24:31,132 CassandraDaemon.java (line 192) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:17,1,RMI &lt;span class=&quot;code-object&quot;&gt;Runtime&lt;/span&gt;]
java.lang.AssertionError: originally calculated column size of 516898177 but now it is 516898234
	at org.apache.cassandra.db.compaction.LazilyCompactedRow.write(LazilyCompactedRow.java:135)
	at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:160)
	at org.apache.cassandra.db.compaction.CompactionTask.runWith(CompactionTask.java:162)
	at org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:58)
	at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:60)
	at org.apache.cassandra.db.compaction.CompactionManager$6.runMayThrow(CompactionManager.java:355)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
	at java.util.concurrent.FutureTask.run(FutureTask.java:166)
	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:722)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Does it matter that my SSTables are mostly on version ic?&lt;/p&gt;

&lt;p&gt;FWIW, I&apos;ve been unable to compact this CF since we went to C* 1.2. I&apos;ll attach other JIRAs that may be related.&lt;/p&gt;</comment>
                            <comment id="13721746" author="efalcao" created="Sat, 27 Jul 2013 20:36:11 +0000"  >&lt;p&gt;Here&apos;s my earlier JIRA that might be related. Any thoughts, Sylvain?&lt;/p&gt;</comment>
                            <comment id="13747345" author="slebresne" created="Thu, 22 Aug 2013 07:58:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;Does it matter that my SSTables are mostly on version ic?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I shouldn&apos;t matter, no.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;but I fear it&apos;s still an issue. Here is a stack I just saw in my freshly upgraded 1.2.7 cluster&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It could be that there is still a problem. But I&apos;m confident that we did fixed one issue with this ticket, so that would be a separate problem. Let&apos;s track that new problem in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5720&quot; title=&quot;AssertionError in CompactionExecutor&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5720&quot;&gt;&lt;del&gt;CASSANDRA-5720&lt;/del&gt;&lt;/a&gt; then maybe. Can you indicate in that latter issue that you can reproduce on 1.2.7 btw (so we don&apos;t close it as a duplicate of something fixed).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;ve been unable to compact this CF since we went to C* 1.2.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If you have some sstables that always fail to compact with that error on 1.2.7, then would you be allowed to provide that set of sstables privately so I can check what&apos;s going on on my side?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12656062">CASSANDRA-5720</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12593942" name="5799.txt" size="1790" author="slebresne" created="Wed, 24 Jul 2013 14:28:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>339764</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 13 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1mlnj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>340083</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>