<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:26:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18110] Streaming progress virtual table lock contention can trigger TCP_USER_TIMEOUT and fail streaming</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18110</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Running four concurrent host replacements on a 4.1.0 development cluster has repeatably failed to complete bootstrap with all four hosts failing bootsrrap and staying in JOINING, logging the message.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR 2022-12-07T21:15:48,860 [main] org.apache.cassandra.service.StorageService:2019 - Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; waiting on bootstrap to complete. Bootstrap will have to be restarted.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Bootstrap fails as the the FileStreamTasks on the streaming followers encounter an EOF while transmitting the files.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR 2022-12-07T15:49:39,164 [NettyStreaming-Outbound-/1.2.3.4.7000:2] org.apache.cassandra.streaming.StreamSession:718 - [Stream #8d313690-7674-11ed-813f-95c261b64a82] Streaming error occurred on session with peer 1.2.3.4:7000 through 1.2.3.4:40292
org.apache.cassandra.net.AsyncChannelOutputPlus$FlushException: The channel &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; output stream was writing to has been closed
       at org.apache.cassandra.net.AsyncChannelOutputPlus.propagateFailedFlush(AsyncChannelOutputPlus.java:200) ~[cassandra.jar]
       at org.apache.cassandra.net.AsyncChannelOutputPlus.waitUntilFlushed(AsyncChannelOutputPlus.java:158) ~[cassandra.jar]
       at org.apache.cassandra.net.AsyncChannelOutputPlus.waitForSpace(AsyncChannelOutputPlus.java:140) ~[cassandra.jar]
       at org.apache.cassandra.net.AsyncChannelOutputPlus.beginFlush(AsyncChannelOutputPlus.java:97) ~[cassandra.jar]
       at org.apache.cassandra.net.AsyncStreamingOutputPlus.lambda$writeToChannel$0(AsyncStreamingOutputPlus.java:124) ~[cassandra.jar]
       at org.apache.cassandra.db.streaming.CassandraCompressedStreamWriter.lambda$write$0(CassandraCompressedStreamWriter.java:89) ~[cassandra.jar]
       at org.apache.cassandra.net.AsyncStreamingOutputPlus.writeToChannel(AsyncStreamingOutputPlus.java:120) ~[cassandra.jar]
       at org.apache.cassandra.db.streaming.CassandraCompressedStreamWriter.write(CassandraCompressedStreamWriter.java:88) ~[cassandra.jar]
       at org.apache.cassandra.db.streaming.CassandraOutgoingFile.write(CassandraOutgoingFile.java:177) ~[cassandra.jar]
       at org.apache.cassandra.streaming.messages.OutgoingStreamMessage.serialize(OutgoingStreamMessage.java:87) ~[cassandra.jar]
       at org.apache.cassandra.streaming.messages.OutgoingStreamMessage$1.serialize(OutgoingStreamMessage.java:45) ~[cassandra.jar]
       at org.apache.cassandra.streaming.messages.OutgoingStreamMessage$1.serialize(OutgoingStreamMessage.java:34) ~[cassandra.jar]
       at org.apache.cassandra.streaming.messages.StreamMessage.serialize(StreamMessage.java:39) ~[cassandra.jar]
       at org.apache.cassandra.streaming.async.StreamingMultiplexedChannel$FileStreamTask.run(StreamingMultiplexedChannel.java:311) [cassandra.jar]
       at org.apache.cassandra.concurrent.FutureTask$1.call(FutureTask.java:96) [cassandra.jar]
       at org.apache.cassandra.concurrent.FutureTask.call(FutureTask.java:61) [cassandra.jar]
       at org.apache.cassandra.concurrent.FutureTask.run(FutureTask.java:71) [cassandra.jar]
       at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]
       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]
       at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [netty-all-4.1.58.Final.jar:4.1.58.Final]
       at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829) [?:?]
       Suppressed: java.nio.channels.ClosedChannelException
               at org.apache.cassandra.net.AsyncStreamingOutputPlus.doFlush(AsyncStreamingOutputPlus.java:82) ~[cassandra.jar]
               at org.apache.cassandra.net.AsyncChannelOutputPlus.flush(AsyncChannelOutputPlus.java:229) ~[cassandra.jar]
               at org.apache.cassandra.net.AsyncChannelOutputPlus.close(AsyncChannelOutputPlus.java:248) ~[cassandra.jar]
               at org.apache.cassandra.streaming.async.NettyStreamingChannel$1.close(NettyStreamingChannel.java:141) ~[cassandra.jar]
               at org.apache.cassandra.streaming.async.StreamingMultiplexedChannel$FileStreamTask.run(StreamingMultiplexedChannel.java:312) [cassandra.jar]
               at org.apache.cassandra.concurrent.FutureTask$1.call(FutureTask.java:96) [cassandra.jar]
               at org.apache.cassandra.concurrent.FutureTask.call(FutureTask.java:61) [cassandra.jar]
               at org.apache.cassandra.concurrent.FutureTask.run(FutureTask.java:71) [cassandra.jar]
               at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]
               at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]
               at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) [netty-all-4.1.58.Final.jar:4.1.58.Final]
               at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829) [?:?]
Caused by: io.netty.channel.unix.Errors$NativeIoException: writevAddresses(..) failed: Connection timed out

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Running a debug build with extra logging added to org.apache.cassandra.streaming.StreamSession#progress shows long periods where the streaming task does not log any progress events of up to 15 mins in duration. After these stalls the next attempt to write hits EOF.&lt;/p&gt;

&lt;p&gt;Example caught by extra logging in org.apache.cassandra.streaming.StreamSession#progress&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INFO  2022-12-07T15:10:56,149 [NettyStreaming-Outbound-/1.2.3.4.7000:2] org.apache.cassandra.streaming.StreamSession:1082 - Got stream progress event /datadir/ks/tbl-xxx/ks-tbl-nb-87763-big-Data.db 22216704/25673094 bytes (86%) s
ent to idx:0/1.2.3.4 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; file /datadir/ks/tbl-xxx/ks-tbl-nb-87763-big-Data.db bytes 22216704 out of total 25673094
# ... 15min delay during which other streams can be seen transmitting to the same and other hosts
INFO  2022-12-07T15:25:29,614 [NettyStreaming-Outbound-/1.2.3.4.7000:2] org.apache.cassandra.streaming.StreamSession:1082 - Got stream progress event /datadir/ks/tbl-xxx/ks-tbl-nb-87763-big-Data.db 22282240/25673094 bytes (86%) sent to idx:0/1.2.3.4 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; file /datadir/ks/tbl-xxx/ks-tbl-nb-87763-big-Data.db bytes 22282240 out of total 25673094
INFO  2022-12-07T15:25:29,615 [NettyStreaming-Outbound-/1.2.3.4.7000:2] org.apache.cassandra.streaming.StreamSession:1082 - Got stream progress event /datadir/ks/tbl-xxx/ks-tbl-nb-87763-big-Data.db 22347776/25673094 bytes (87%) sent to idx:0/1.2.3.4 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; file /datadir/ks/tbl-xxx/ks-tbl-nb-87763-big-Data.db bytes 22347776 out of total 25673094


INFO  2022-12-07T15:25:29,626 [NettyStreaming-Outbound-/1.2.3.4.7000:2] org.apache.cassandra.streaming.StreamSession:1082 - Got stream progress event /datadir/ks/tbl-xxx/ks-tbl-nb-87763-big-Data.db 23855104/25673094 bytes (92%) sent to idx:0/1.2.3.4 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; file /datadir/ks/tbl-xxx/ks-tbl-nb-87763-big-Data.db bytes 23855104 out of total 25673094
INFO  2022-12-07T15:25:29,627 [NettyStreaming-Outbound-/1.2.3.4.7000:2] org.apache.cassandra.streaming.StreamSession:1082 - Got stream progress event /datadir/ks/tbl-xxx/ks-tbl-nb-87763-big-Data.db 23920640/25673094 bytes (93%) sent to idx:0/1.2.3.4 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; file /datadir/ks/tbl-xxx/ks-tbl-nb-87763-big-Data.db bytes 23920640 out of total 25673094
# ...12min delay &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; other streams &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt; to transmit
INFO  2022-12-07T15:37:29,775 [NettyStreaming-Outbound-/1.2.3.4.7000:2] org.apache.cassandra.streaming.StreamSession:1082 - Got stream progress event /datadir/ks/tbl-xxx/ks-tbl-nb-87763-big-Data.db 23986176/25673094 bytes (93%) sent to idx:0/1.2.3.4 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; file /datadir/ks/tbl-xxx/ks-tbl-nb-87763-big-Data.db bytes 23986176 out of total 25673094
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The issue has not succesfully been reproduced in other clusters or in a dtest, but is reliable reproducible on the cluster. The hosts being used are relatively large and have an available CPU count of 32 causing the streaming system to allow up to 32 concurrent streams.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/81c616826ab3c8aa96467771d0e074a874efdd77/src/java/org/apache/cassandra/streaming/async/StreamingMultiplexedChannel.java#L93&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/81c616826ab3c8aa96467771d0e074a874efdd77/src/java/org/apache/cassandra/streaming/async/StreamingMultiplexedChannel.java#L93&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;One possible explanation is that the stream rate limiter is not being fair and blocking sends long enough for TCP user timeout to fire and cause the kernel to close the socket which is detected on the next write, another is something is taking unusually long flushing the socket in AsyncChannelOutputPlus.beginFlush.&lt;/p&gt;

&lt;p&gt;Restarting the instances with the streaming TCP user timeout disabled on the cluster (set to zero in the boostrapping instances config, and updated with JMX on the other instances) allowed the host-replacements to complete bootstrap successfully.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13511953">CASSANDRA-18110</key>
            <summary>Streaming progress virtual table lock contention can trigger TCP_USER_TIMEOUT and fail streaming</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dcapwell">David Capwell</assignee>
                                    <reporter username="jonmeredith">Jon Meredith</reporter>
                        <labels>
                    </labels>
                <created>Sun, 11 Dec 2022 00:34:25 +0000</created>
                <updated>Tue, 12 Sep 2023 13:02:38 +0000</updated>
                            <resolved>Thu, 12 Jan 2023 17:49:49 +0000</resolved>
                                        <fixVersion>4.1.1</fixVersion>
                    <fixVersion>5.0-alpha1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                    <component>Consistency/Bootstrap and Decommission</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="17645812" author="jonmeredith" created="Sun, 11 Dec 2022 17:45:23 +0000"  >&lt;p&gt;To clarify the workaround, on any new nodes being started, ensure the config is set with&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
internode_streaming_tcp_user_timeout: 0s
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and on existing nodes in the cluster, the timeout can be reset with JMX without restarting&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.cassandra.db/StorageService/InternodeStreamingTcpUserTimeoutInMS&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;before the bootstrap attempt.&lt;/p&gt;</comment>
                            <comment id="17646377" author="jonmeredith" created="Tue, 13 Dec 2022 00:32:11 +0000"  >&lt;p&gt;No success reproducing this issue in a test environment still.&lt;/p&gt;

&lt;p&gt;Given that all attempts have failed to reproduce and have completed investigating our theories how this could happen without finding anything so far, this should not block the release.&lt;/p&gt;

&lt;p&gt;Downgrading severity to Normal and will update this ticket with any future findings.&lt;/p&gt;</comment>
                            <comment id="17651433" author="jonmeredith" created="Thu, 22 Dec 2022 23:13:39 +0000"  >&lt;p&gt;tl;dr an event listener added to collect data for the streaming status&#160;vtable is causing lock contention and starving the stream deserializer thread which causes a TCP user timeout on the sender that fails&#160;the stream.&lt;/p&gt;

&lt;p&gt;Details - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17390&quot; title=&quot;Expose streaming as a vtable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17390&quot;&gt;&lt;del&gt;CASSANDRA-17390&lt;/del&gt;&lt;/a&gt; exposed streaming status over a virtual table by&#160;listening to all streaming events with class &lt;tt&gt;StreamingState&lt;/tt&gt;. It maintains a &lt;tt&gt;SessionInfo&lt;/tt&gt; structure for each peer&#160;active in streaming, tracking a &lt;tt&gt;ProgressInfo&lt;/tt&gt; for each streamed&#160;file that tracks transferred/total bytes for the file and updates it&#160;on every streaming event calling &lt;tt&gt;org.apache.cassandra.streaming.StreamingState.Sessions#create&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Streaming events include &lt;tt&gt;FILE_PROGRESS&lt;/tt&gt; events generated on the &lt;tt&gt;StreamDeserializingTask&lt;/tt&gt; for every section (64kb) read by &lt;tt&gt;CompressedStreamReader&lt;/tt&gt;, and for every file components&#160;for &lt;tt&gt;CassandraEntireSSTableStreamReader&lt;/tt&gt;. They happen frequently during heavy streaming activity.&lt;/p&gt;

&lt;p&gt;In the event handler, &lt;tt&gt;Sessions.create&lt;/tt&gt; recreates a summary &lt;tt&gt;org.apache.cassandra.streaming.StreamingState.Sessions&lt;/tt&gt; object by iterating over all of the active session/files it knows about (multiple times) summing received/total for bytes and #files.&lt;/p&gt;

&lt;p&gt;In one heap dump investigated the top three sessions has 5612, 1780 and 1528 received files. Generating the summary takes longer as the bootstrap proceeds and&#160; creates contention in the synchronized org.apache.cassandra.streaming.StreamResultFuture.fireStreamEvent method.&#160;&lt;/p&gt;

&lt;p&gt;Method synchronization is unfair and causes starvation for some of the &lt;tt&gt;StreamDeserializerTask&lt;/tt&gt; threads that consume the &lt;tt&gt;AsyncStreamingInputPlus&lt;/tt&gt; slowing calls to netty to read from the streaming channel in &lt;tt&gt;rebuffer&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;On the unfairly scheduled threads, eventually socket reads slow down enough to keep the TCP receive queue above the high water mark for 300s preventing an ACK of pending bytes to the sender, which trips the TCP user timeout on the sender causing it to close it before completing the transfer and failing the stream.&lt;/p&gt;

&lt;p&gt;Raising the streaming TCP user timeout or disabling it entirely is still the correct workaround for this issue until it can be resolved.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;Stream-Deserializer-/1.2.3.4:7000-deadbeef&quot;&lt;/span&gt; #176 daemon prio=5 os_prio=0 cpu=299135.87ms elapsed=8341.21s tid=0x00007f25e2064a00 nid=0xe02f runnable  [0x00007f25b03a4000]
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: RUNNABLE
        at org.apache.cassandra.streaming.SessionInfo.getTotalSizeInProgress(SessionInfo.java:172)
        at org.apache.cassandra.streaming.SessionInfo.getTotalSizeReceived(SessionInfo.java:125)
        at org.apache.cassandra.streaming.StreamingState$Sessions.create(StreamingState.java:379)
        at org.apache.cassandra.streaming.StreamingState.handleStreamEvent(StreamingState.java:255)
        - locked &amp;lt;0x0000000604ac7bf0&amp;gt; (a org.apache.cassandra.streaming.StreamingState)
        at org.apache.cassandra.streaming.StreamResultFuture.fireStreamEvent(StreamResultFuture.java:218)
        - locked &amp;lt;0x000000060c3e57a0&amp;gt; (a org.apache.cassandra.streaming.StreamResultFuture)
        at org.apache.cassandra.streaming.StreamResultFuture.handleProgress(StreamResultFuture.java:208)
        at org.apache.cassandra.streaming.StreamSession.progress(StreamSession.java:1096)
        at org.apache.cassandra.db.streaming.CassandraCompressedStreamReader.read(CassandraCompressedStreamReader.java:96)
        at org.apache.cassandra.db.streaming.CassandraIncomingFile.read(CassandraIncomingFile.java:84)
        - locked &amp;lt;0x000000064a637510&amp;gt; (a org.apache.cassandra.db.streaming.CassandraIncomingFile)
        at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:55)
        at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:41)
        at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:50)
        at org.apache.cassandra.streaming.StreamDeserializingTask.run(StreamDeserializingTask.java:59)
        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(java.base@11.0.16/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;other streaming threads blocked on the lock&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
   java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.State: BLOCKED (on object monitor)
        at org.apache.cassandra.streaming.StreamResultFuture.fireStreamEvent(StreamResultFuture.java:214)
        - waiting to lock &amp;lt;0x000000060c3e57a0&amp;gt; (a org.apache.cassandra.streaming.StreamResultFuture)
        at org.apache.cassandra.streaming.StreamResultFuture.handleProgress(StreamResultFuture.java:208)
        at org.apache.cassandra.streaming.StreamSession.progress(StreamSession.java:1096)
        at org.apache.cassandra.db.streaming.CassandraCompressedStreamReader.read(CassandraCompressedStreamReader.java:96)
        at org.apache.cassandra.db.streaming.CassandraIncomingFile.read(CassandraIncomingFile.java:84)
        - locked &amp;lt;0x00000006e0f7aa58&amp;gt; (a org.apache.cassandra.db.streaming.CassandraIncomingFile)
        at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:55)
        at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:41)
        at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:50)
        at org.apache.cassandra.streaming.StreamDeserializingTask.run(StreamDeserializingTask.java:59)
        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(java.base@11.0.16/&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17654100" author="cscotta" created="Tue, 3 Jan 2023 16:57:13 +0000"  >&lt;p&gt;This one&apos;s a hall-of-famer for sure.&lt;/p&gt;</comment>
                            <comment id="17654630" author="dcapwell" created="Wed, 4 Jan 2023 20:50:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jonmeredith&quot; class=&quot;user-hover&quot; rel=&quot;jonmeredith&quot;&gt;jonmeredith&lt;/a&gt; if you don&apos;t mind I can take this as you found the issue was caused by the vtable I worked on.&lt;/p&gt;

&lt;p&gt;Looking at the code / stack trace the issue looks to be in org.apache.cassandra.streaming.StreamingState#handleStreamEvent the line &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
sessions = Sessions.create(streamProgress.values());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The single usage of this field is org.apache.cassandra.db.virtual.StreamingVirtualTable#updateDataSet, which is only needed when the vtable is requested...&lt;/p&gt;

&lt;p&gt;There are a few options I think we can take (can take multiple)&lt;/p&gt;

&lt;p&gt;1) don&apos;t be eager and have org.apache.cassandra.streaming.StreamingState#sessions build on-demand from org.apache.cassandra.streaming.StreamingState#streamProgress&lt;br/&gt;
2) org.apache.cassandra.streaming.StreamingState#onSuccess and org.apache.cassandra.streaming.StreamingState#onFailure could build the sessions eagerly (like it does today), but push this logic to another thread&lt;br/&gt;
3) feature flag to allow tracking to be disabled (why I didn&apos;t do this in the first place....)&lt;br/&gt;
4) Sessions is just received/sent so why do we need to compute using 100% of events?  can we not just use a counter?&lt;/p&gt;

&lt;p&gt;Given that building 1 session can take 15m, then #1 just breaks the vtable... for this reason I am in favor of #3 and #4... ill look closer to see if I can write #4 and see if there are any tradeoffs I don&apos;t see yet&lt;/p&gt;</comment>
                            <comment id="17654633" author="aratnofsky" created="Wed, 4 Jan 2023 20:59:08 +0000"  >&lt;p&gt;For #3 - wouldn&apos;t disabling tracking mean that the virtual table isn&apos;t usable? This would put us in a situation where you can either use the vtable or stream successfully on larger clusters, which seems to defeat the purpose of the vtable.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;m also in favor of #4.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I was also thinking of changing the pacing (via debounce) for individual file progress events, so a progress event does not trigger handleStreamEvent if it was called within the last X millis.&lt;/p&gt;</comment>
                            <comment id="17654713" author="dcapwell" created="Thu, 5 Jan 2023 03:03:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;For #3 - wouldn&apos;t disabling tracking mean that the virtual table isn&apos;t usable?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Correct, this allows you to break the vtable if the feature causes things to not be stable.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;m also in favor of #4.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am working on a patch doing both #3 and #4; so fix the issue by doing less work, and allow opt-out... &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I was also thinking of changing the pacing (via debounce) for individual file progress events, so a progress event does not trigger handleStreamEvent if it was called within the last X millis.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think we have enough people familiar with Streaming to make that safe... Even the vtable was a problem as no one is around who knows streaming!  Changing the pacing could have side effects non of us are aware of... &lt;/p&gt;</comment>
                            <comment id="17655525" author="dcapwell" created="Fri, 6 Jan 2023 17:32:40 +0000"  >&lt;p&gt;sent out a PR, but seems my bytesReceived/bytesSent needs to be changed... this one is a bit more annoying to deal with &lt;/p&gt;</comment>
                            <comment id="17655530" author="dcapwell" created="Fri, 6 Jan 2023 17:52:41 +0000"  >&lt;p&gt;more fun, SessionPreparedEvent is seen twice; we double post the same event!&lt;/p&gt;

&lt;p&gt;Here is the stack trace for the 2 events on the same instance&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
first:
org.apache.cassandra.streaming.StreamingState.streamPrepared
org.apache.cassandra.streaming.StreamingState.handleStreamEvent
org.apache.cassandra.streaming.StreamResultFuture.fireStreamEvent
org.apache.cassandra.streaming.StreamResultFuture.handleSessionPrepared
org.apache.cassandra.streaming.StreamSession.prepareAsync
org.apache.cassandra.streaming.StreamSession.lambda$prepare$4

second:
org.apache.cassandra.streaming.StreamingState.streamPrepared
org.apache.cassandra.streaming.StreamingState.handleStreamEvent
org.apache.cassandra.streaming.StreamResultFuture.fireStreamEvent
org.apache.cassandra.streaming.StreamResultFuture.handleSessionPrepared
org.apache.cassandra.streaming.StreamSession.startStreamingFiles
org.apache.cassandra.streaming.StreamSession.prepareAck
org.apache.cassandra.streaming.StreamSession.messageReceived
org.apache.cassandra.streaming.StreamDeserializingTask.run
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17655536" author="aratnofsky" created="Fri, 6 Jan 2023 18:08:54 +0000"  >&lt;p&gt;&amp;gt; Changing the pacing could have side effects non of us are aware of...&lt;/p&gt;

&lt;p&gt;I&apos;m referring to the pacing of updates to the vtable data, not the streaming data. In org.apache.cassandra.streaming.StreamingState#handleStreamEvent, only update this.sessions on a FILE_PROGRESS event if it hasn&apos;t been updated in X millis. For other event types, update this.sessions right away.&lt;/p&gt;

&lt;p&gt;This is my first thought at least - would reduce the time spent updating sessions when FILE_PROGRESS is frequent (which it should be).&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;An even better solution would be to not re-create this.sessions but instead update it based on the deltas, since the incoming event should only update for a single ProgressInfo (peer, direction, file, etc) and the handler is already synchronized.&lt;/p&gt;</comment>
                            <comment id="17655542" author="dcapwell" created="Fri, 6 Jan 2023 18:29:47 +0000"  >&lt;p&gt;pushed update that avoids the double counting of prepare and file progress events, this memory cost for file progress is less than before this patch, but it no longer is just updating a counter (we need the delta between events)&lt;/p&gt;</comment>
                            <comment id="17655544" author="dcapwell" created="Fri, 6 Jan 2023 18:31:38 +0000"  >&lt;p&gt;.bq I&apos;m referring to the pacing of updates to the vtable data, not the streaming data. In org.apache.cassandra.streaming.StreamingState#handleStreamEvent, only update this.sessions on a FILE_PROGRESS event if it hasn&apos;t been updated in X millis. For other event types, update this.sessions right away.&lt;/p&gt;

&lt;p&gt;We could, but that doesn&apos;t avoid the 15m to build a single event you and Jon saw.&lt;/p&gt;

&lt;p&gt;.bq An even better solution would be to not re-create this.sessions but instead update it based on the deltas&lt;/p&gt;

&lt;p&gt;yep, that&apos;s what I did, already sent out patch doing this!&lt;/p&gt;</comment>
                            <comment id="17655595" author="dcapwell" created="Fri, 6 Jan 2023 22:43:58 +0000"  >&lt;p&gt;Update: I added a feature flag to disable tracking, and made it so the costs are lower and more predictable (file progress does require a ObjectLongHashMap to track per-file progress)&lt;/p&gt;</comment>
                            <comment id="17655745" author="aratnofsky" created="Sat, 7 Jan 2023 23:28:01 +0000"  >&lt;p&gt;Left review with a few questions on GitHub&lt;/p&gt;</comment>
                            <comment id="17656984" author="jonmeredith" created="Tue, 10 Jan 2023 21:47:04 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17675733" author="dcapwell" created="Wed, 11 Jan 2023 21:52:21 +0000"  >&lt;p&gt;Starting commit&lt;/p&gt;

&lt;p&gt;CI Results (pending):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-4.1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-18110-cassandra-4.1-880F7124-2E8C-43F5-891A-F37CABAF55FB&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-18110-cassandra-4.1-880F7124-2E8C-43F5-891A-F37CABAF55FB&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/2180/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-18110-trunk-880F7124-2E8C-43F5-891A-F37CABAF55FB&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-18110-trunk-880F7124-2E8C-43F5-891A-F37CABAF55FB&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/2181/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12992" cascade-level="1"><![CDATA[Process Crash]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12977"><![CDATA[Adhoc Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 43 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1drcw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aratnofsky]]></customfieldvalue>
        <customfieldvalue><![CDATA[jmeredithco]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12352689">4.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/5be1038c5d38af32d3cbb0545d867f21304f3a46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/5be1038c5d38af32d3cbb0545d867f21304f3a46&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;existing tests&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>