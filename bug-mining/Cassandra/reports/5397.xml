<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:16:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15778] CorruptSSTableException after a 2.1 SSTable is upgraded to 3.0, failing reads</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15778</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Below is the exception with stack trace. This issue is consistently reproduce-able.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [SharedPool-Worker-1] 2020-05-01 14:57:57,661 AbstractLocalAwareExecutorService.java:169 - Uncaught exception on thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[SharedPool-Worker-1,5,main]ERROR [SharedPool-Worker-1] 2020-05-01 14:57:57,661 AbstractLocalAwareExecutorService.java:169 - Uncaught exception on thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[SharedPool-Worker-1,5,main]org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /mnt/data/cassandra/data/&amp;lt;ks&amp;gt;/&amp;lt;cf-fda511301fb311e7bd79fd24f2fcfb0d/md-10151-big-Data.db at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$Reader.hasNext(AbstractSSTableIterator.java:349) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.columniterator.AbstractSSTableIterator.hasNext(AbstractSSTableIterator.java:220) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.columniterator.SSTableIterator.hasNext(SSTableIterator.java:33) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:95) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:32) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:95) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:32) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:131) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:87) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:77) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:294) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.ReadResponse$LocalDataResponse.build(ReadResponse.java:187) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:180) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:176) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.ReadResponse.createDataResponse(ReadResponse.java:76) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:341) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.ReadCommandVerbHandler.doVerb(ReadCommandVerbHandler.java:47) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:67) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_231] at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:165) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:137) [nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:109) [nf-cassandra-3.0.19.8.jar:3.0.19.8] at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748) [na:1.8.0_231]Caused by: java.lang.ArrayIndexOutOfBoundsException: 121 at org.apache.cassandra.db.ClusteringPrefix$Deserializer.prepare(ClusteringPrefix.java:425) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.UnfilteredDeserializer$CurrentDeserializer.prepareNext(UnfilteredDeserializer.java:170) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.UnfilteredDeserializer$CurrentDeserializer.hasNext(UnfilteredDeserializer.java:151) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.columniterator.SSTableIterator$ForwardReader.computeNext(SSTableIterator.java:140) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.columniterator.SSTableIterator$ForwardReader.hasNextInternal(SSTableIterator.java:172) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$Reader.hasNext(AbstractSSTableIterator.java:336) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] ... 27 common frames omitted

Caused by: java.lang.ArrayIndexOutOfBoundsException: 121
    at org.apache.cassandra.db.ClusteringPrefix$Deserializer.prepare(ClusteringPrefix.java:425) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8]
    at org.apache.cassandra.db.UnfilteredDeserializer$CurrentDeserializer.prepareNext(UnfilteredDeserializer.java:170) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8]
    at org.apache.cassandra.db.UnfilteredDeserializer$CurrentDeserializer.hasNext(UnfilteredDeserializer.java:151) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8]
    at org.apache.cassandra.db.columniterator.SSTableIterator$ForwardReader.computeNext(SSTableIterator.java:140) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8]
    at org.apache.cassandra.db.columniterator.SSTableIterator$ForwardReader.hasNextInternal(SSTableIterator.java:172) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8]
    at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$Reader.hasNext(AbstractSSTableIterator.java:336) ~[nf-cassandra-3.0.19.8.jar:3.0.19.8] ... 27 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Column family definition&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE &amp;lt;keyspace&amp;gt;.&lt;span class=&quot;code-quote&quot;&gt;&quot;&amp;lt;cf&amp;gt;&quot;&lt;/span&gt; (
 key text,
 value text,
 PRIMARY KEY (key, value)
 ) WITH COMPACT STORAGE
 AND CLUSTERING ORDER BY (value ASC)
 AND bloom_filter_fp_chance = 0.01
 AND caching = {&lt;span class=&quot;code-quote&quot;&gt;&apos;keys&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;ALL&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;rows_per_partition&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;NONE&apos;&lt;/span&gt;}
 AND comment = &apos;&apos;
 AND compaction = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;max_threshold&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;32&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;min_threshold&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;4&apos;&lt;/span&gt;}
 AND compression = {&lt;span class=&quot;code-quote&quot;&gt;&apos;enabled&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;&apos;&lt;/span&gt;}
 AND crc_check_chance = 1.0
 AND dclocal_read_repair_chance = 0.1
 AND default_time_to_live = 0
 AND gc_grace_seconds = 864000
 AND max_index_interval = 2048
 AND memtable_flush_period_in_ms = 0
 AND min_index_interval = 128
 AND read_repair_chance = 0.0
 AND speculative_retry = &lt;span class=&quot;code-quote&quot;&gt;&apos;99PERCENTILE&apos;&lt;/span&gt;;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13302322">CASSANDRA-15778</key>
            <summary>CorruptSSTableException after a 2.1 SSTable is upgraded to 3.0, failing reads</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="sumanth.pasupuleti">Sumanth Pasupuleti</reporter>
                        <labels>
                    </labels>
                <created>Fri, 1 May 2020 15:39:54 +0000</created>
                <updated>Sun, 1 Aug 2021 12:18:28 +0000</updated>
                            <resolved>Thu, 4 Jun 2020 18:21:01 +0000</resolved>
                                        <fixVersion>3.0.21</fixVersion>
                                    <component>Local/Compaction</component>
                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17097498" author="dcapwell" created="Fri, 1 May 2020 16:44:48 +0000"  >&lt;p&gt;The stack trace points to &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0.19/src/java/org/apache/cassandra/db/ClusteringPrefix.java#L425&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.0.19/src/java/org/apache/cassandra/db/ClusteringPrefix.java#L425&lt;/a&gt;.  If you have the 2.1 sstable attempt to read it with the tool sstable2json, that will tell you if the file was valid in 2.1.  &lt;/p&gt;

&lt;p&gt;How was the data written, was it always though CQL or some other system (like MapReduce)?&lt;/p&gt;</comment>
                            <comment id="17097500" author="dcapwell" created="Fri, 1 May 2020 16:49:33 +0000"  >&lt;p&gt;Looking closer the file is md-10151-big-Data.db, so this was after the 2.1 file got upgraded to 3.0&lt;/p&gt;</comment>
                            <comment id="17097566" author="sumanth.pasupuleti" created="Fri, 1 May 2020 18:11:10 +0000"  >&lt;p&gt;Thanks correct &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt;. We have restored 2.1 sstables on this 3.0 cluster, and kicked off sstableupgrade, to eagerly rewrite all 2.1 sstables to 3.0 format. &lt;br/&gt;
I was able to trace back the 2.1 sstable that got compacted into this 3.0 sstable. The data was originally written using &lt;a href=&quot;https://github.com/Netflix/astyanax&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;astyanax&lt;/a&gt; driver.&lt;/p&gt;</comment>
                            <comment id="17100198" author="dcapwell" created="Tue, 5 May 2020 19:12:22 +0000"  >&lt;p&gt;Created a branch to ignore value field for compact storage: &lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/corruption/CASSANDRA-15778&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/dcapwell/cassandra/tree/corruption/CASSANDRA-15778&lt;/a&gt;. Running through testing now.&lt;/p&gt;</comment>
                            <comment id="17105653" author="ifesdjeen" created="Tue, 12 May 2020 18:22:09 +0000"  >&lt;p&gt;I&apos;ve taken a short look and wanted to precaution against ignoring or even purging values from the hidden compact column, since there are scenarios when it can contain legitimate data. &lt;/p&gt;

&lt;p&gt;I&apos;ve been able to reproduce an issue with a similar, albeit not exactly same stacktrace (leaving only the part from sstable iterator downward):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR 18:08:11 Uncaught exception on thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[SharedPool-Worker-2,10,main]
java.lang.RuntimeException: org.apache.cassandra.serializers.MarshalException: EmptyType only accept empty values
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2470) ~[main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_171]
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:165) ~[main/:na]
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:137) [main/:na]
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:109) [main/:na]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748) [na:1.8.0_171]
Caused by: org.apache.cassandra.serializers.MarshalException: EmptyType only accept empty values
        at org.apache.cassandra.serializers.EmptySerializer.validate(EmptySerializer.java:42) ~[main/:na]
        at org.apache.cassandra.db.marshal.AbstractType.validate(AbstractType.java:159) ~[main/:na]
        at org.apache.cassandra.db.marshal.AbstractType.validateIfFixedSize(AbstractType.java:390) ~[main/:na]
        at org.apache.cassandra.db.LegacyLayout$CellGrouper.addCell(LegacyLayout.java:1457) ~[main/:na]
        at org.apache.cassandra.db.LegacyLayout$CellGrouper.addAtom(LegacyLayout.java:1377) ~[main/:na]
        at org.apache.cassandra.db.UnfilteredDeserializer$OldFormatDeserializer$UnfilteredIterator.readRow(UnfilteredDeserializer.java:542) ~[main/:na]
        at org.apache.cassandra.db.UnfilteredDeserializer$OldFormatDeserializer$UnfilteredIterator.hasNext(UnfilteredDeserializer.java:519) ~[main/:na]
        at org.apache.cassandra.db.UnfilteredDeserializer$OldFormatDeserializer.hasNext(UnfilteredDeserializer.java:336) ~[main/:na]
        at org.apache.cassandra.db.columniterator.SSTableIterator$ForwardReader.computeNext(SSTableIterator.java:140) ~[main/:na]
        at org.apache.cassandra.db.columniterator.SSTableIterator$ForwardReader.hasNextInternal(SSTableIterator.java:172) ~[main/:na]
        at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$Reader.hasNext(AbstractSSTableIterator.java:336) ~
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In short, this is a table created on 2.2 side with: &lt;tt&gt;CREATE TABLE table_0 (key text, value text, PRIMARY KEY (key, value)) WITH COMPACT STORAGE;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;If you write data into this table with thrift (&lt;tt&gt;ThriftClient#batch_mutate&lt;/tt&gt;), you will end up with data in the hidden column, which looks like this on the 2.1 side:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
select * from ks1.table_0;

 key   | value
-------+-------
 key22 |  key1
 key22 |  key4
 key11 |  key1
 key11 |  key4

(4 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And like this in sstabledump:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[
{&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;key22&quot;&lt;/span&gt;,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt;: [[&lt;span class=&quot;code-quote&quot;&gt;&quot;key1&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;76616c756531&quot;&lt;/span&gt;,1589306163593],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;key4&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;76616c756534&quot;&lt;/span&gt;,1589306163594]]},
{&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;key11&quot;&lt;/span&gt;,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt;: [[&lt;span class=&quot;code-quote&quot;&gt;&quot;key1&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;76616c756531&quot;&lt;/span&gt;,1589306163593],
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;key4&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;76616c756534&quot;&lt;/span&gt;,1589306163594]]}
]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Of course, on 3.x side you wouldn&apos;t be able to see the values.&lt;/p&gt;

&lt;p&gt;UPDATE: Was able to reproduce it: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.RuntimeException: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /Users/ifesdjeen/foss/java/apache-cassandra/data/data/ks1/table_0-05609b80948511eabfa891431c623cd5/md-2-big-Data.db
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2470) ~[main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_171]
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:165) ~[main/:na]
        at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:137) [main/:na]
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:109) [main/:na]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748) [na:1.8.0_171]
Caused by: org.apache.cassandra.io.sstable.CorruptSSTableException: Corrupted: /Users/ifesdjeen/foss/java/apache-cassandra/data/data/ks1/table_0-05609b80948511eabfa891431c623cd5/md-2-big-Data.db
        at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$Reader.hasNext(AbstractSSTableIterator.java:349) ~[main/:na]
        at org.apache.cassandra.db.columniterator.AbstractSSTableIterator.hasNext(AbstractSSTableIterator.java:220) ~[main/:na]
        at org.apache.cassandra.db.columniterator.SSTableIterator.hasNext(SSTableIterator.java:33) ~[main/:na]
        at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:95) ~[main/:na]
        at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:32) ~[main/:na]
        at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[main/:na]
        at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[main/:na]
        at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:95) ~[main/:na]
        at org.apache.cassandra.db.rows.LazilyInitializedUnfilteredRowIterator.computeNext(LazilyInitializedUnfilteredRowIterator.java:32) ~[main/:na]
        at org.apache.cassandra.utils.AbstractIterator.hasNext(AbstractIterator.java:47) ~[main/:na]
        at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[main/:na]
        at org.apache.cassandra.db.transform.BaseRows.hasNext(BaseRows.java:129) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:131) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:87) ~[main/:na]
        at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:77) ~[main/:na]
        at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:294) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.build(ReadResponse.java:187) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:180) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:176) ~[main/:na]
        at org.apache.cassandra.db.ReadResponse.createDataResponse(ReadResponse.java:76) ~[main/:na]
        at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:341) ~[main/:na]
        at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1785) ~[main/:na]
        at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2466) ~[main/:na]
        ... 5 common frames omitted
Caused by: java.lang.ArrayIndexOutOfBoundsException: 97
        at org.apache.cassandra.db.ClusteringPrefix$Deserializer.prepare(ClusteringPrefix.java:431) ~[main/:na]
        at org.apache.cassandra.db.UnfilteredDeserializer$CurrentDeserializer.prepareNext(UnfilteredDeserializer.java:170) ~[main/:na]
        at org.apache.cassandra.db.UnfilteredDeserializer$CurrentDeserializer.hasNext(UnfilteredDeserializer.java:151) ~[main/:na]
        at org.apache.cassandra.db.columniterator.SSTableIterator$ForwardReader.computeNext(SSTableIterator.java:140) ~[main/:na]
        at org.apache.cassandra.db.columniterator.SSTableIterator$ForwardReader.hasNextInternal(SSTableIterator.java:172) ~[main/:na]
        at org.apache.cassandra.db.columniterator.AbstractSSTableIterator$Reader.hasNext(AbstractSSTableIterator.java:336) ~[main/:na]
        ... 27 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Steps: &lt;/p&gt;

&lt;p&gt;1. Create a compact table in 2.1 (or 2.2), doesn&apos;t matter&lt;br/&gt;
2. Write data to it with thrift&lt;br/&gt;
3. Upgrade sstables&lt;br/&gt;
4. Try reading data from this table&lt;/p&gt;

&lt;p&gt;On latest 3.0, you won&apos;t get past &lt;tt&gt;EmptySerializer#validate&lt;/tt&gt;, because of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15373&quot; title=&quot;validate value sizes in LegacyLayout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15373&quot;&gt;&lt;del&gt;CASSANDRA-15373&lt;/del&gt;&lt;/a&gt;, so you&apos;ll have to skip validation manually or use a version that doesn&apos;t contain a fix.&lt;/p&gt;

&lt;p&gt;But this only confirms that we should reconsider the way we treat EmptyType and thrift values.&lt;/p&gt;

&lt;p&gt;UPDATE2: if we&apos;re making a thrift write against a fresh 3.0 node with compact storage (prior to validation patch), we&apos;ll end up with the same stack trace.&lt;/p&gt;</comment>
                            <comment id="17105793" author="dcapwell" created="Tue, 12 May 2020 22:37:42 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; for taking a look at this.  Most of the context is not in JIRA and the patch I posted was so Sumanth and I could test out if the value field being empty was the issue and if there were other issues; &lt;b&gt;no one should apply that patch to production&lt;/b&gt;.&lt;/p&gt;

&lt;p&gt;The current state is that the value field silently corrupted the data because&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15373&quot; title=&quot;validate value sizes in LegacyLayout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15373&quot;&gt;&lt;del&gt;CASSANDRA-15373&lt;/del&gt;&lt;/a&gt; is 3.0.20 and not 3.0.19 (test cluster)&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15790&quot; title=&quot;EmptyType doesn&amp;#39;t override writeValue so could attempt to write bytes when expected not to&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15790&quot;&gt;&lt;del&gt;CASSANDRA-15790&lt;/del&gt;&lt;/a&gt; is needed to not write data and instead fail.  We currently write out data that has no logic to read, so corrupts the stream.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Action items so far are to come up with a resolution to this case.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; has the idea that we should migrate the hidden column out of VOID and to BLOB (2.1 logic), this will make the data readable via Thrift but not CQL.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; about your reproduction, skimming the method (and CassandraServer version) you sent I don&apos;t see us injecting anything, are you saying CassandraDaemon, ThriftClient, or client code added this data?  If ThriftClient or CassandraDaemon do you know where?&lt;/p&gt;</comment>
                            <comment id="17107181" author="ifesdjeen" created="Thu, 14 May 2020 10:29:26 +0000"  >&lt;p&gt;Posting the patch:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/ifesdjeen/cassandra/tree/15778-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:15778-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;In summary, problem was caused by the fact that CQL-created &lt;tt&gt;COMPACT STORAGE&lt;/tt&gt; dense tables (i.e., ones that have a clustering key and have no regular columns), had a hidden &lt;tt&gt;EmptyType&lt;/tt&gt; column (compact value column). This compact value column was accessible through thrift, and it was possible to write key-value pairs to it, which would look like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
[
{&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;key22&quot;&lt;/span&gt;,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt;: [[&lt;span class=&quot;code-quote&quot;&gt;&quot;key1&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;76616c756531&quot;&lt;/span&gt;,1589306163593], # &amp;lt;-- thrift-written cell
           [&lt;span class=&quot;code-quote&quot;&gt;&quot;key4&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;76616c756534&quot;&lt;/span&gt;,1589306163594]]}
], [
{&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;key000&quot;&lt;/span&gt;,
 &lt;span class=&quot;code-quote&quot;&gt;&quot;cells&quot;&lt;/span&gt;: [[&lt;span class=&quot;code-quote&quot;&gt;&quot;value000&quot;&lt;/span&gt;,&quot;&quot;,1589371872206298]]}, # &amp;lt;-- cql-written cell, &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; comparison
]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When upgrading to 3.0, we were running into one of the following situations. During sstable upgrade, value would get written to 3.0 sstable using &lt;tt&gt;AbstractType#write&lt;/tt&gt;, which would write any fixed-size (0 size is fixed for empty type), taking &lt;tt&gt;ByteBuffer#remaining&lt;/tt&gt; bytes from its value. Since the value was written through thrift, it is non-empty. Similar situation would happen when issuing a local read, which would go through local response. When trying to read upgraded sstable, we read all the way to the beginning of empty value, then try to read the value itself, but we know that its size is zero, so we read nothing. Whichever code path attempts to read next bytes, will try to interpret our thrift-written bytes as the rest of cells, which leads to corruption.&lt;/p&gt;

&lt;p&gt;I was a bit reluctant to effectively turn &lt;tt&gt;EmptyType&lt;/tt&gt; into &lt;tt&gt;BytesType&lt;/tt&gt;, but using empty compact value from thrift in a way that makes it look like it&apos;s just a byte array was already possible (even though I believe only a few people have used it this way), and now we have to make this behaviour official.&lt;/p&gt;

&lt;p&gt;3.11 patch will look more or less the same as 3.0 one. Patch is not applicable to 4.0, but we will have to make sure we make &lt;tt&gt;EmptyType&lt;/tt&gt; is migrated to &lt;tt&gt;BytesType&lt;/tt&gt; when dropping compact storage in scope of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15811&quot; title=&quot;Improve DROP COMPACT STORAGE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15811&quot;&gt;&lt;del&gt;CASSANDRA-15811&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17107598" author="dcapwell" created="Thu, 14 May 2020 19:26:55 +0000"  >&lt;p&gt;I am -1 to this.  This attempts to change the EmptyType to be the BytesType.  Why not change the schema?  As we talked about COMPACT STOAGE was BLOB in 2.1 but is now VOID, which means this is the wrong type to use; we should change the schema to match the 2.1 behavior, not change the semantics of empty.&lt;/p&gt;</comment>
                            <comment id="17107654" author="ifesdjeen" created="Thu, 14 May 2020 20:29:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;Why not change the schema? &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;First off, I&apos;d like to highlight that I was (and still am) reluctant to the change to &lt;tt&gt;EmptyType&lt;/tt&gt;. I did take a look at that option (changing schema), but was weary, as this would be potentially a much larger change that would probably achieve the same thing. The only problem I see is that &quot;empty&quot; type is not really empty anymore. However, it is &lt;em&gt;already&lt;/em&gt; not empty from compaction perspective, and from data perspective. &lt;/p&gt;

&lt;p&gt;The reason I thought it was valuable to keep a distinction between the thift-created table with a Blob (where this column is visible) and CQL-created dense table (where value is hidden). I did check all usages of &lt;tt&gt;EmptyType&lt;/tt&gt; and, apart from &lt;tt&gt;Set&lt;/tt&gt;, all usages seem to be compact-storage related. &lt;/p&gt;

&lt;p&gt;&lt;del&gt;It is not possible to create a table with CQL that has an empty type&lt;/del&gt; (UPD: turns out that we can, through fully qualified type name), so we&apos;re only really changing semantics of something that I think is internal to compact storage...&lt;/p&gt;</comment>
                            <comment id="17107899" author="dcapwell" created="Fri, 15 May 2020 03:31:18 +0000"  >&lt;p&gt;We spoke offline, dumping here.  &lt;/p&gt;

&lt;p&gt;Splunking through GitHub I found projects which use the empty type and you can create a schema with the empty type.  Even if we update all usage within Cassandra, we struggle to really understand the impact outside of Cassandra since it is modifying a public API; changing EmptyType to me is very high risk.&lt;/p&gt;

&lt;p&gt;I was also showing that CQL created tables in 2.1.20 used the blob type and allowed me to write bytes to the hidden column (the write was outside CQL), so this isn&apos;t localized to CQL vs Thrift tables, but more that 3.0 changed behavior to go from BytesType to EmptyType.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
-- &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; table was created via CQL
cqlsh&amp;gt; desc table test.kv;

CREATE TABLE test.kv (
    key text,
    value text,
    &quot;&quot; blob,
    PRIMARY KEY (key, value)
) WITH COMPACT STORAGE
    AND CLUSTERING ORDER BY (value ASC)
    AND bloom_filter_fp_chance = 0.01
    AND caching = &lt;span class=&quot;code-quote&quot;&gt;&apos;{&lt;span class=&quot;code-quote&quot;&gt;&quot;keys&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;ALL&quot;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&quot;rows_per_partition&quot;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&quot;NONE&quot;&lt;/span&gt;}&apos;&lt;/span&gt;
    AND comment = &apos;&apos;
    AND compaction = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&apos;&lt;/span&gt;}
    AND compression = {}
    AND dclocal_read_repair_chance = 0.1
    AND default_time_to_live = 0
    AND gc_grace_seconds = 864000
    AND max_index_interval = 2048
    AND memtable_flush_period_in_ms = 0
    AND min_index_interval = 128
    AND read_repair_chance = 0.0
    AND speculative_retry = &lt;span class=&quot;code-quote&quot;&gt;&apos;99.0PERCENTILE&apos;&lt;/span&gt;;
cqlsh&amp;gt; select * from system.schema_columns where keyspace_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt; and columnfamily_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;kv&apos;&lt;/span&gt;;

 keyspace_name | columnfamily_name | column_name | component_index | index_name | index_options | index_type | type           | validator
---------------+-------------------+-------------+-----------------+------------+---------------+------------+----------------+-------------------------------------------
          test |                kv |             |            &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |       &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |          &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |       &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |  compact_value | org.apache.cassandra.db.marshal.BytesType
          test |                kv |         key |            &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |       &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |          &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |       &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |  partition_key |  org.apache.cassandra.db.marshal.UTF8Type
          test |                kv |       value |            &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |       &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |          &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; |       &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; | clustering_key |  org.apache.cassandra.db.marshal.UTF8Type

(3 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;After upgrading to 3.0, the schema was changed to empty type&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
cqlsh&amp;gt; cqlsh&amp;gt; select * from system_schema.columns where keyspace_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;test&apos;&lt;/span&gt; and table_name=&lt;span class=&quot;code-quote&quot;&gt;&apos;kv&apos;&lt;/span&gt;;

 keyspace_name | table_name | column_name | clustering_order | column_name_bytes | kind          | position | type
---------------+------------+-------------+------------------+-------------------+---------------+----------+-------
          test |         kv |         key |             none |          0x6b6579 | partition_key |        0 |  text
          test |         kv |       value |              asc |      0x76616c7565 |    clustering |        0 |  text
          test |         kv |      value1 |             none |    0x76616c756531 |       regular |       -1 | empty

(3 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17108389" author="ifesdjeen" created="Fri, 15 May 2020 15:11:54 +0000"  >&lt;p&gt;After thinking about it for longer time and talking with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt;, I think there&apos;re no good solution to this problem. At the moment &lt;tt&gt;EmptyType&lt;/tt&gt; assumes that it&apos;s fixed-size, therefore doesn&apos;t write its size (only writes bytes). This means that anyone who has already written the value, won&apos;t be able to read it back, and writing a generic scrub tool for that will be non-trivial since we can have arbitrary bytes there. &lt;/p&gt;

&lt;p&gt;From the alternatives, I think everything we have right now is risky to some degree:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;if we inherit &lt;tt&gt;EmptyType&lt;/tt&gt; from &lt;tt&gt;BytesType&lt;/tt&gt;, we change semantics of the empty type, which can have unforeseen consequences&lt;/li&gt;
	&lt;li&gt;if we change schema and migrate from &lt;tt&gt;EmptyType&lt;/tt&gt; to &lt;tt&gt;BytesType&lt;/tt&gt;, we&apos;ll end up showing the hidden column. To keep it hidden, we&apos;ll have to add a flag to table metadata&lt;/li&gt;
	&lt;li&gt;if we just migrate &lt;tt&gt;EmptyType&lt;/tt&gt; from fixed-size to variable-size (basically by not overriding &lt;tt&gt;valueLengthIfFixed&lt;/tt&gt;), it&apos;ll work in principle because of &lt;tt&gt;BufferCell#hasValue&lt;/tt&gt;, but this also might be risky&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So the only reasonable thing to do seems to handle this particular case: people who still have their 2.1 sstables, and they haven&apos;t upgraded, and they&apos;re (somewhat) interested in the data they&apos;ve written. People who&apos;re not interested in the data they&apos;re written receive the same solution, but can just drop the column.&lt;/p&gt;

&lt;p&gt;I suggest we do the following:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;we keep the existing validation that forbids writes into &lt;tt&gt;EmptyType&lt;/tt&gt; columns and make &lt;tt&gt;EmptyType&lt;/tt&gt; write method no-op to be on an even safer side&lt;/li&gt;
	&lt;li&gt;we add a way to &quot;unbreak&quot; cql-created thrift-written tables by adding new &lt;tt&gt;ALTER TABLE FIX EMPTY TYPE&lt;/tt&gt; (naming is just for example here) statement, which would &lt;em&gt;only&lt;/em&gt; work for cql-created dense tables and nothing else, and would turn hidden &lt;tt&gt;EmptyType&lt;/tt&gt; column to &lt;tt&gt;BytesType&lt;/tt&gt;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Main reason to ask for human intervention is that we&apos;d like to avoid changes that can add new problems whie not bein fully satisfactory for the given problem. This will give anyone with a problem a clear path to a solution without risking already existing setups.&lt;/p&gt;

&lt;p&gt;This also implies that in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15811&quot; title=&quot;Improve DROP COMPACT STORAGE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15811&quot;&gt;&lt;del&gt;CASSANDRA-15811&lt;/del&gt;&lt;/a&gt;, we&apos;ll simply drop &lt;tt&gt;EmptyType&lt;/tt&gt; column entirely when doing &lt;tt&gt;DROP COMPACT STORAGE&lt;/tt&gt;, so no surprising column without data will show up.&lt;/p&gt;</comment>
                            <comment id="17108618" author="dcapwell" created="Fri, 15 May 2020 20:11:20 +0000"  >&lt;p&gt;Alex and I spoke offline, dumping here for context.&lt;/p&gt;

&lt;p&gt;There are a few cases we want to worry about, and some cases which we don&apos;t feel are important to worry about:&lt;/p&gt;

&lt;p&gt;Cases we feel are important to worry about&lt;/p&gt;

&lt;p&gt;1) upgrade from 2.1 to 3.0 &lt;b&gt;or&lt;/b&gt; 3.11&lt;br/&gt;
2) CQL Table with values written to the previous blob type (hidden type only exposed via Thrift)&lt;br/&gt;
3) Thrift tables with arbitrary types&lt;/p&gt;

&lt;p&gt;Cases we don&apos;t feel are important to worry about&lt;/p&gt;

&lt;p&gt;1) upgrade from 3.0 to 3.0 or 3.11&lt;/p&gt;

&lt;p&gt;Given this, we came up with a proposal that should address the above concerns.&lt;/p&gt;

&lt;p&gt;1) while upgrading from 2.1 to 3.0 or 3.11, legacy schema migration should default to BytesType, but allow an override to switch to EmptyType; BytesType will cause the column to be no longer hidden &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;br/&gt;
2) if override is set to EmptyType and data is found to be rejected in validation, then DROP COMPACT STORAGE will be needed and should add an option to expose this column.  This means the hidden column will now be exposed and will allow alter statements to change the type or drop it completely.&lt;br/&gt;
3) Attempt to add a more meaningful exception which tells users about this fix.  Right now the exception is &quot;EmptyType only accept empty values&quot;, this is not actionable and can cause confusion.&lt;br/&gt;
4) For clusters already upgraded to 3.0 or 3.11, the only impact would be the options added to DROP COMPACT STORAGE which would allow the column to be exposed or not &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;; we have not worked out the default behaviors of this.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; - This is actually an open disagreement.  Alex&apos;s point is that this affects a small user base, but would expose the field to all users upgrading.  My point is summarized in &lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt; - The reason to default to BytesTypes is because the rolling upgrade case.  Since there may be data present, the default of EmptyType is unsafe as it would cause the token range impacted to be unavailable to the users.  Schema migrations are not allowed in mixed mode so the only way to resolve this would be to complete the upgrade, which may cause a larger outage for users.  If the user is aware of this behavior and know its safe, they may choose to switch to the EmptyType case.&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt; - There is an assumption that all clusters are 3.0.20+, the reason for this assumption is that validation checks were in 3.0.20 (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15373&quot; title=&quot;validate value sizes in LegacyLayout&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15373&quot;&gt;&lt;del&gt;CASSANDRA-15373&lt;/del&gt;&lt;/a&gt;) and would protect against corrupting the SSTable in the upgrade or compaction case.  If the cluster is 3.0.19 or earlier, then corruption would have happened as the EmptyType was writing the bytes but was not reading them (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15790&quot; title=&quot;EmptyType doesn&amp;#39;t override writeValue so could attempt to write bytes when expected not to&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15790&quot;&gt;&lt;del&gt;CASSANDRA-15790&lt;/del&gt;&lt;/a&gt;).  As of this moment we are not aware of a generic way to repair this data as we don&apos;t know what those bytes were so couldn&apos;t account for them generically (they are written without length).&lt;/p&gt;</comment>
                            <comment id="17110473" author="ifesdjeen" created="Mon, 18 May 2020 17:24:09 +0000"  >&lt;p&gt;I think I have a patch I think solves the problem without introducing breaking changes: &lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/ifesdjeen/cassandra/tree/15778-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:15778-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;It does the following things:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;makes &lt;tt&gt;EmptyType&lt;/tt&gt; restrictions slightly stricter withouot changing semantics. Just make sure we can not write values with empty type.&lt;/li&gt;
	&lt;li&gt;changes &lt;tt&gt;LegacySchemaMigrator&lt;/tt&gt;, allowing to start a 3.0 node during upgrade with &lt;tt&gt;-D cassandra.init_dense_table_compact_value_as_bytes=true&lt;/tt&gt;, which would initialize a dense table compact value as &lt;tt&gt;ByteType&lt;/tt&gt;. It will be initialized as &lt;tt&gt;EmptyType&lt;/tt&gt; by default.&lt;/li&gt;
	&lt;li&gt;improves an error message in &lt;tt&gt;EmptySerializer&lt;/tt&gt; for anyone who have faced written data in the column that was supposed to be empty, referring them here.&lt;/li&gt;
	&lt;li&gt;since we initialize with &lt;tt&gt;EmptyType&lt;/tt&gt; by default, in case someone has proceeded to upgrade their nodes withouot even testing an upgrade out (and being able to just start upgrade with an aforementioned flag), allow &lt;tt&gt;ALTER TABLE ALTER TYPE&lt;/tt&gt; &lt;em&gt;only&lt;/em&gt; from &lt;tt&gt;EmptyType&lt;/tt&gt; to &lt;tt&gt;BytesType&lt;/tt&gt; and &lt;em&gt;only&lt;/em&gt; for a dense table.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We should not change compact storage behaviour to suddenly reveal a &lt;tt&gt;BytesType&lt;/tt&gt; column for a huge userbase. Instead, we help out anyone who may have written values with Thrift: either to &lt;em&gt;prevent&lt;/em&gt; seeing this issue (which is ideal), or to &lt;em&gt;quickly fix&lt;/em&gt; it after upgrade. Schema changes won&apos;t propagate accross versions, but they only need to propagate to 3.0 nodes only anyways.&lt;/p&gt;</comment>
                            <comment id="17117827" author="slebresne" created="Wed, 27 May 2020 14:56:59 +0000"  >&lt;p&gt;That patch looks like a reasonable solution to me, at least from my understanding of the issue.&lt;/p&gt;

&lt;p&gt;Small comments on the code itself:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I&apos;d put a comment in &lt;tt&gt;AlterTableStatement&lt;/tt&gt; to point out to this ticket (may feel like a peculiar special case to future readers without context).&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;AbstractType&lt;/tt&gt;, the changes to &lt;tt&gt;writeValue&lt;/tt&gt;/&lt;tt&gt;writtenLength&lt;/tt&gt; feels confusing to me, and if the new code is ever triggered, this would mean we silently drop a value on the floor (we get a non-empty value, but the type say the value should be empty, so we&apos;d write nothing), and that doesn&apos;t feel lik a good idea. Instead of specializing the 0 size case, I&apos;d just add a &lt;tt&gt;assert valueLengthIfFixed &amp;lt; 0 || value.remaining() == valueLengthIfFixed&lt;/tt&gt; to basically ensure we&apos;re not going to write something we don&apos;t know how to read (and effectively forbid the call of those method for &lt;tt&gt;EmptyType&lt;/tt&gt; in conjunction with the existing assert).&lt;/li&gt;
	&lt;li&gt;Assuming we agree on the previous point, I&apos;d prefer not overriding the methods in &lt;tt&gt;EmptyType&lt;/tt&gt;. For the write ones, it wouldn&apos;t add anything, and overriding &lt;tt&gt;readValue&lt;/tt&gt; feels confusing when the rest of the code ensures we can never write an empty value through those methods.&lt;/li&gt;
	&lt;li&gt;Nit: LegacySchemaMigrator has unused leftover imports (&lt;tt&gt;java.io.InvalidClassException&lt;/tt&gt; and &lt;tt&gt;net.bytebuddy.implementation.bytecode.Throw&lt;/tt&gt;).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17119759" author="ifesdjeen" created="Fri, 29 May 2020 16:51:52 +0000"  >&lt;p&gt;Thank you for the review. Made suggested changes and triggered CI again:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/ifesdjeen/cassandra/tree/15778-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:15778-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/ifesdjeen/cassandra/tree/15778-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:15778-3.11?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11 patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17119847" author="dcapwell" created="Fri, 29 May 2020 18:39:46 +0000"  >&lt;p&gt;Spoke on slack, mostly held off reviewing as I was waiting on testing.  &lt;/p&gt;

&lt;p&gt;Feedback:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:15778-3.0?expand=1#diff-43b2d530031e2f7ad4286bd05fed4ca0R127&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:15778-3.0?expand=1#diff-43b2d530031e2f7ad4286bd05fed4ca0R127&lt;/a&gt;. exception can be hard for someone who hasn&apos;t read the code.  It would be good to move the validation part into a different if statement after the dense check, so the exception can be more actionable.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:15778-3.0?expand=1#diff-0a4167e798cf91857b5d6995661cd421R398&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...ifesdjeen:15778-3.0?expand=1#diff-0a4167e798cf91857b5d6995661cd421R398&lt;/a&gt; can we add a assert message to show how much is remaining?  Same for the other method as well&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Mostly good with this since alter unblocks a cluster.  One thing I would like to test is mixed mode, alter half way, will legacy still migrate to empty?&lt;/p&gt;</comment>
                            <comment id="17120155" author="ifesdjeen" created="Sat, 30 May 2020 08:38:20 +0000"  >&lt;p&gt;Thank you for the review!&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;One thing I would like to test is mixed mode, alter half way, will legacy still migrate to empty?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I did test all of the scenarios locally, including the one you describe. I believe current tests cover all code paths.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;exception can be hard for someone who hasn&apos;t read the code. It would be good to move the validation part into a different if statement after the dense check, so the exception can be more actionable.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Could you elaborate a bit? Stack trace doesn&apos;t change in this case, and exception itself hasn&apos;t changed from the old version. &lt;/p&gt;</comment>
                            <comment id="17121290" author="dcapwell" created="Mon, 1 Jun 2020 19:46:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;Could you elaborate a bit? Stack trace doesn&apos;t change in this case, and exception itself hasn&apos;t changed from the old version.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Think code will speak loader.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (meta.isDense() &amp;amp;&amp;amp; meta.compactValueColumn().type &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; EmptyType)
{
  &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (validator != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
      &amp;amp;&amp;amp; validator.getType() &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; BytesType
      &amp;amp; meta.compactValueColumn().equals(def))
  {
                    cfm = meta.copyWithNewCompactValueType(validator.getType());
                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
  }
  &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
  {
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; InvalidRequestException(&lt;span class=&quot;code-quote&quot;&gt;&quot;Altering of compaction value column types is only allowed &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; changing to bytes, but given &quot;&lt;/span&gt; + validator.getType());
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;If I know that the column has always been an integer and I attempt to set as a int32 I get an exception saying that alter isn&apos;t allowed; this exception can imply that there is no way to fix the issue.  To make it more actionable, it would be better to say that alter is only allowed to be bytes and that the provided type is not supported.&lt;/p&gt;</comment>
                            <comment id="17123353" author="sumanth.pasupuleti" created="Tue, 2 Jun 2020 05:05:05 +0000"  >&lt;p&gt;Thanks for the patch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;. I was able to validate both the flows of the patch on the actual data that I was able to repro the issue with.&lt;/p&gt;

&lt;p&gt;In either of the flows, the resulting table ended up with the following schema, and doing a select * on the table includes the third column.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
cqlsh:ks&amp;gt; desc &lt;span class=&quot;code-quote&quot;&gt;&quot;cf&quot;&lt;/span&gt;;

CREATE TABLE ks.&lt;span class=&quot;code-quote&quot;&gt;&quot;cf&quot;&lt;/span&gt; (
    key text,
    value text,
    value1 blob,
    PRIMARY KEY (key, value)
) WITH COMPACT STORAGE
    AND CLUSTERING ORDER BY (value ASC)
    ...
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;A couple of comments on the patch:&lt;br/&gt;
1. It maybe helpful to add the following tests to &lt;tt&gt;testAlterTableAlterType()&lt;/tt&gt; method.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, value &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, PRIMARY KEY (a,value)) WITH COMPACT STORAGE&quot;&lt;/span&gt;);
        assertInvalidMessage(&lt;span class=&quot;code-quote&quot;&gt;&quot;Altering of types is not allowed&quot;&lt;/span&gt;,
                             &lt;span class=&quot;code-quote&quot;&gt;&quot;ALTER TABLE %s ALTER value TYPE &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.db.marshal.IntegerType&apos;&lt;/span&gt;&quot;&lt;/span&gt;);
        execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;ALTER TABLE %s ALTER value1 TYPE &lt;span class=&quot;code-quote&quot;&gt;&apos;org.apache.cassandra.db.marshal.BytesType&apos;&lt;/span&gt;&quot;&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2. For the system property &lt;tt&gt;cassandra.init_dense_table_compact_value_as_bytes&lt;/tt&gt;, I am not sure if folks may find it useful to control what keyspace/cf this needs to be applied to. I personally feel it may be rare enough to ignore this, but wanted to bring it up nevertheless.&lt;/p&gt;</comment>
                            <comment id="17126122" author="ifesdjeen" created="Thu, 4 Jun 2020 18:02:26 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; thank you for the detailed explanation. I&apos;ve taken your suggestion in.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sumanth.pasupuleti&quot; class=&quot;user-hover&quot; rel=&quot;sumanth.pasupuleti&quot;&gt;sumanth.pasupuleti&lt;/a&gt; thank you for checking this on the cluster and your feedback on the patch! I&apos;ve added the test you have suggested. As regards keyspace/cf key/value pairs, I did think about this. I think if you have written to even a single cf, it makes sense to force &lt;tt&gt;BytesType&lt;/tt&gt; for all cfs, in particular - to avoid folks forgetting about previous writes. We can open up a ticket with a follow-up/improvement, but I do not feel this is a necessary condition for the fix.&lt;/p&gt;</comment>
                            <comment id="17126130" author="ifesdjeen" created="Thu, 4 Jun 2020 18:19:41 +0000"  >&lt;p&gt;Thank you all for review and comments. Committed to 3.0 with &lt;a href=&quot;https://github.com/apache/cassandra/commit/c4064dd80e427aec7c04e8e2e1e4630d6c8087b6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;c4064dd80e427aec7c04e8e2e1e4630d6c8087b6&lt;/a&gt;, and merged up to &lt;a href=&quot;https://github.com/apache/cassandra/commit/056c9eff4b0311d9bde526e0bc9f39e5fad21e39&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;. Merge to trunk was done with &lt;tt&gt;-s ours&lt;/tt&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13303726">CASSANDRA-15799</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13302943">CASSANDRA-15790</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13264131">CASSANDRA-15373</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="13161" cascade-level="1"><![CDATA[Unrecoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 23 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0eas0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
        <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
        <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332361">3.0 alpha 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/c4064dd80e427aec7c04e8e2e1e4630d6c8087b6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/c4064dd80e427aec7c04e8e2e1e4630d6c8087b6&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Test added; manually tested additional scenarios of upgrade to 3.11, dropping compact storage, and reading in 4.0. However, this is going to be fully handled in scope of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15811&quot; title=&quot;Improve DROP COMPACT STORAGE&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15811&quot;&gt;&lt;del&gt;CASSANDRA-15811&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>