<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:40:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6023] CAS should distinguish promised and accepted ballots</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6023</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Currently, we only keep 1) the most recent promise we&apos;ve made and 2) the last update we&apos;ve accepted. But we don&apos;t keep the ballot at which that last update was accepted. And because a node always promise to newer ballot, this means an already committed update can be replayed even after another update has been committed. Re-committing a value is fine, but only as long as we&apos;ve not start a new round yet.&lt;/p&gt;

&lt;p&gt;Concretely, we can have the following case (with 3 nodes A, B and C) with the current implementation:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;A proposer P1 prepare and propose a value X at ballot t1. It is accepted by all nodes.&lt;/li&gt;
	&lt;li&gt;A proposer P2 propose at t2 (wanting to commit a new value Y). If say A and B receive the commit of P1 before the propose of P2 but C receives those in the reverse order, we&apos;ll current have the following states:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;A: in-progress = (t2, _), mrc = (t1, X)
B: in-progress = (t2, _), mrc = (t1, X)
C: in-progress = (t2, X), mrc = (t1, X)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Because C has received the t1 commit after promising t2, it won&apos;t have removed X during t1 commit (but note that the problem is not during commit, that example still stand if C never receive any commit message).&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;Now, based on the promise of A and B, P2 will propose Y at t2 (C don&apos;t see this propose in particular, not before he promise on t3 below at least). A and B accepts, P2 will send a commit for Y.&lt;/li&gt;
	&lt;li&gt;In the meantime a proposer P3 submit a prepare at t3 (for some other irrelevant value) which reaches C before it receives P2 propose&amp;amp;commit. That prepare reaches A and B too, but after the P2 commit. At that point the state will be:
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;A: in-progress = (t3, _), mrc = (t2, Y)
B: in-progress = (t3, _), mrc = (t2, Y)
C: in-progress = (t3, X), mrc = (t2, Y)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In particular, C still has X as update because each time it got a commit, it has promised to a more recent ballot and thus skipped the delete. The value is still X because it has received the P2 propose after having promised t3 and has thus refused it.&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;P3 gets back the promise of say C and A. Both response has t3 as in-progress ballot (and it is more recent than any mrc) but C comes with value X. So P3 will replay X. Assuming no more contention this replay will succeed and X will be committed at t3.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;At the end of that example, we&apos;ve comitted X, Y and then X again, even though only P1 has ever proposed X.&lt;/p&gt;

&lt;p&gt;I believe the correct fix is to keep the ballot of when an update is accepted (instead of using the most recent promised ballot). That way, in the example above, P3 would receive from C a promise on t3, but would know that X was accepted at t1. And so P3 would be able to ignore X since the mrc of A will tell him it&apos;s an obsolete value.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12668469">CASSANDRA-6023</key>
            <summary>CAS should distinguish promised and accepted ballots</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                            <label>LWT</label>
                    </labels>
                <created>Fri, 13 Sep 2013 11:48:31 +0000</created>
                <updated>Fri, 25 Oct 2019 13:10:51 +0000</updated>
                            <resolved>Mon, 16 Sep 2013 06:48:16 +0000</resolved>
                                        <fixVersion>2.0.1</fixVersion>
                                    <component>Feature/Lightweight Transactions</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13766427" author="slebresne" created="Fri, 13 Sep 2013 12:03:01 +0000"  >&lt;p&gt;Attaching patch for the suggestion above. The patch also simplify slightly SK.savePaxosCommit: we used to not erase the update if the commit was older than in-progress. I believe that was a bit buggy and in any case unecessary since we write with the commit timestamp (so that there was no risk to erase a more recent update in fact). The other thing we were doing is to update the in-progress ballot if the commit was newer: I&apos;m not sure that has any benefit and it makes me nervous to update in-progress outside of the prepare phase. Besides, if we remove that, we don&apos;t need to read the state to commit, which save a read and the lock acquisition on every commit.&lt;/p&gt;

&lt;p&gt;I&apos;m including a 2nd trivial patch that adds the population of commitsByReplica in PrepareCallback. It&apos;s partly unrelated to the problem of this ticket but it&apos;s clearly wrong and I&apos;m not sure that warrant a separate ticket.&lt;/p&gt;</comment>
                            <comment id="13767580" author="jbellis" created="Sat, 14 Sep 2013 21:02:42 +0000"  >&lt;p&gt;I&apos;m pretty sure we don&apos;t need to make everything volatile/concurrent in PrepareCallback, since the latch and synchronized establish happens-before for the StorageProxy thread.&lt;/p&gt;

&lt;p&gt;I&apos;m not crazy about PrepareResponse including two different values for inProgressCommit.  Can we clean that up somehow?&lt;/p&gt;

&lt;p&gt;Might also be worth renaming in_progress_ballot to promised_ballot to be a little more clear on the distinction vs proposal_ballot.&lt;/p&gt;

&lt;p&gt;Rest LGTM.&lt;/p&gt;</comment>
                            <comment id="13767794" author="jbellis" created="Sun, 15 Sep 2013 13:11:42 +0000"  >&lt;p&gt;... Thinking about it more, I&apos;m fine with the PrepareResponse, and it&apos;s not worth the backwards compatibility code for a column rename.  +1&lt;/p&gt;</comment>
                            <comment id="13768109" author="slebresne" created="Mon, 16 Sep 2013 06:48:16 +0000"  >&lt;p&gt;Ok. Committed then, thanks.&lt;/p&gt;

&lt;p&gt;(I did remove the volatile though. I got a ConcurrentModificationException during one run on commitsByReplica and instead of just fixing that I went overboard with the volatile. But you&apos;re right, the latch makes it unnecessary).&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12603003" name="0001-Distinguish-between-promised-and-accepted-ballots.txt" size="13630" author="slebresne" created="Fri, 13 Sep 2013 12:03:01 +0000"/>
                            <attachment id="12603004" name="0002-Populate-commitsByReplica-in-PrepareCallback.txt" size="977" author="slebresne" created="Fri, 13 Sep 2013 12:03:01 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>348403</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 10 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1o2q7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>348700</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324629">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>