<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14362] Bind to correct local address in 4.0 streaming</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14362</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;m not sure if anybody has tried using &lt;tt&gt;trunk&lt;/tt&gt; and starting an actual EC2 cluster, but with a 3 node setup that works on 3.11, it fails to work on &lt;tt&gt;trunk&lt;/tt&gt;. I mistakenly stumbled into it while testing my own code changes. &lt;/p&gt;

&lt;p&gt;My setup is as follows:&lt;/p&gt;

&lt;p&gt;broadcast_rpc_address: publicIP&lt;br/&gt;
broadcast_address: publicIP&lt;br/&gt;
listen_address: omitted. Ends up as privateIP. &lt;/p&gt;

&lt;p&gt;Works on 3.11 just fine. &lt;/p&gt;

&lt;p&gt;On &lt;tt&gt;trunk&lt;/tt&gt; though, it never works. My node is never able to join the cluster:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Apr 03 05:57:06 ip-10-0-47-122 cassandra[13914]: INFO  [main] 2018-04-03 05:57:05,895 RangeStreamer.java:195 - Bootstrap: range (-128373781239966537,-122439194129870521] exists on 52.88.241.181:7000 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; keyspace system_traces
Apr 03 05:57:06 ip-10-0-47-122 cassandra[13914]: INFO  [main] 2018-04-03 05:57:05,895 RangeStreamer.java:195 - Bootstrap: range (6968670424536541270,6973888347502882935] exists on 52.88.241.181:7000 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; keyspace system_traces
Apr 03 05:57:42 ip-10-0-47-122 cassandra[13914]: WARN  [GossipTasks:1] 2018-04-03 05:57:42,298 FailureDetector.java:324 - Not marking nodes down due to local pause of 26215173446ns &amp;gt; 5000000000ns
Apr 03 05:57:53 ip-10-0-47-122 cassandra[13914]: WARN  [GossipTasks:1] 2018-04-03 05:57:53,035 FailureDetector.java:324 - Not marking nodes down due to local pause of 10736485907ns &amp;gt; 5000000000ns
Apr 03 05:58:30 ip-10-0-47-122 cassandra[13914]: WARN  [GossipTasks:1] 2018-04-03 05:58:30,790 Gossiper.java:814 - Gossip stage has 28 pending tasks; skipping status check (no nodes will be marked down)
Apr 03 05:58:33 ip-10-0-47-122 cassandra[13914]: WARN  [GossipTasks:1] 2018-04-03 05:58:33,060 Gossiper.java:814 - Gossip stage has 20 pending tasks; skipping status check (no nodes will be marked down)
Apr 03 06:04:33 ip-10-0-47-122 cassandra[13914]: WARN  [GossipTasks:1] 2018-04-03 06:04:33,826 FailureDetector.java:324 - Not marking nodes down due to local pause of 400790432954ns &amp;gt; 5000000000ns
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]: WARN  [GossipTasks:1] 2018-04-03 06:04:49,133 Gossiper.java:814 - Gossip stage has 2 pending tasks; skipping status check (no nodes will be marked down)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]: ERROR [StreamConnectionEstablisher:1] 2018-04-03 06:04:49,138 StreamSession.java:524 - [Stream #d4cd6420-3703-11e8-a6a5-e51ddc10cfe6] Streaming error occurred on session with peer 52.88.241.181:7000
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]: java.io.IOException: failed to connect to 52.88.241.181:7000 (STREAM) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; streaming data
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.streaming.DefaultConnectionFactory.createConnection(DefaultConnectionFactory.java:98)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.streaming.DefaultConnectionFactory.createConnection(DefaultConnectionFactory.java:57)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.streaming.async.NettyStreamingMessageSender.createChannel(NettyStreamingMessageSender.java:183)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.streaming.async.NettyStreamingMessageSender.setupControlMessageChannel(NettyStreamingMessageSender.java:165)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.streaming.async.NettyStreamingMessageSender.sendMessage(NettyStreamingMessageSender.java:222)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.streaming.async.NettyStreamingMessageSender.initialize(NettyStreamingMessageSender.java:146)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.streaming.StreamSession.start(StreamSession.java:271)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.streaming.StreamCoordinator$StreamSessionConnector.run(StreamCoordinator.java:273)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:81)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]: Caused by: io.netty.channel.unix.Errors$NativeIoException: bind(..) failed: Cannot assign requested address
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.channel.unix.Errors.newIOException(Errors.java:117)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.channel.unix.Socket.bind(Socket.java:266)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.channel.epoll.AbstractEpollStreamChannel.doConnect(AbstractEpollStreamChannel.java:729)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.channel.epoll.EpollSocketChannel.doConnect(EpollSocketChannel.java:184)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.connect(AbstractEpollStreamChannel.java:797)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.channel.DefaultChannelPipeline$HeadContext.connect(DefaultChannelPipeline.java:1274)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.channel.AbstractChannelHandlerContext.invokeConnect(AbstractChannelHandlerContext.java:545)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.channel.AbstractChannelHandlerContext.connect(AbstractChannelHandlerContext.java:530)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.channel.DefaultChannelPipeline.connect(DefaultChannelPipeline.java:999)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.channel.AbstractChannel.connect(AbstractChannel.java:260)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.bootstrap.Bootstrap$3.run(Bootstrap.java:254)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:163)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:403)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:312)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run(DefaultThreadFactory.java:138)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         ... 1 common frames omitted
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]: INFO  [StreamConnectionEstablisher:1] 2018-04-03 06:04:49,140 StreamResultFuture.java:197 - [Stream #d4cd6420-3703-11e8-a6a5-e51ddc10cfe6] Session with 52.88.241.181:7000 is complete
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]: ERROR [StreamConnectionEstablisher:1] 2018-04-03 06:04:49,146 StreamSession.java:524 - [Stream #d4cd6420-3703-11e8-a6a5-e51ddc10cfe6] Streaming error occurred on session with peer 52.88.241.181:7000
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]: java.lang.RuntimeException: stream has been closed, cannot send Prepare SYN (3 requests,  0 files}
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.streaming.async.NettyStreamingMessageSender.sendMessage(NettyStreamingMessageSender.java:209)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.streaming.StreamSession.onInitializationComplete(StreamSession.java:495)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.streaming.StreamSession.start(StreamSession.java:272)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.streaming.StreamCoordinator$StreamSessionConnector.run(StreamCoordinator.java:273)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:81)
Apr 03 06:04:49 ip-10-0-47-122 cassandra[13914]:         at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Remote debugging it, it eventually seems to come to be due to trying to call &lt;tt&gt;socket.bind&lt;/tt&gt; in &lt;tt&gt;doConnect&lt;/tt&gt; in &lt;tt&gt;AbstractEpollStreamChannel&lt;/tt&gt;. Local address is &amp;lt;publicIP&amp;gt;:0. I think port 0 is fine because it just means pick the next ephemeral port available, but there&apos;s no way of binding to the public IP. &lt;/p&gt;

&lt;p&gt;I made a commit &lt;a href=&quot;https://github.com/apache/cassandra/commit/00222ddf0694f1c35c2bdd84fd7407174c3fc57a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/00222ddf0694f1c35c2bdd84fd7407174c3fc57a&lt;/a&gt; that seems to have fixed it so I can continue on with my purposes, and that is have &lt;tt&gt;StreamSession&lt;/tt&gt; use listen address instead of broadcast address which may be public. In the event listen address is public I guess that means if it was able to bind to that interface to begin with then &lt;tt&gt;socket.bind&lt;/tt&gt; should also work. &lt;/p&gt;

&lt;p&gt;Not sure if this is the right way though, and it seems to have been introduced by the Streaming rework to netty. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12229&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-12229&lt;/a&gt;. &lt;/p&gt;</description>
                <environment></environment>
        <key id="13149864">CASSANDRA-14362</key>
            <summary>Bind to correct local address in 4.0 streaming</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Lerh Low">Lerh Chuan Low</assignee>
                                    <reporter username="Lerh Low">Lerh Chuan Low</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Apr 2018 01:44:46 +0000</created>
                <updated>Fri, 15 May 2020 08:05:15 +0000</updated>
                            <resolved>Tue, 17 Apr 2018 12:49:09 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16424847" author="lerh low" created="Wed, 4 Apr 2018 01:45:54 +0000"  >&lt;p&gt;Any thoughts on this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt;...? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16424860" author="jasobrown" created="Wed, 4 Apr 2018 01:58:33 +0000"  >&lt;p&gt;I&apos;ll take a look tomorrow, certainly looks like me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. Which snitch are you using?&lt;/p&gt;</comment>
                            <comment id="16424869" author="lerh low" created="Wed, 4 Apr 2018 02:01:44 +0000"  >&lt;p&gt;I&apos;m using EC2Snitch (mostly was just using bare bones to get a cluster working). If the commit I made seems like the appropriate fix to you (I may be missing something.... :/ ) then I&apos;m happy to create a proper patch for it. &lt;/p&gt;

&lt;p&gt;(And feel free to LMK if you need any more details)&lt;/p&gt;</comment>
                            <comment id="16426241" author="jasobrown" created="Wed, 4 Apr 2018 22:04:26 +0000"  >&lt;p&gt;So it looks like when working on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8457&quot; title=&quot;nio MessagingService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8457&quot;&gt;&lt;del&gt;CASSANDRA-8457&lt;/del&gt;&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12229&quot; title=&quot;Move streaming to non-blocking IO and netty (streaming 2.1)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12229&quot;&gt;&lt;del&gt;CASSANDRA-12229&lt;/del&gt;&lt;/a&gt;, I introduced a regression of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12673&quot; title=&quot;Nodes cannot see each other in multi-DC, non-EC2 environment with two-interface nodes due to outbound node-to-node connection binding to private interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12673&quot;&gt;&lt;del&gt;CASSANDRA-12673&lt;/del&gt;&lt;/a&gt;. The short of it is we no longer bind the local side of a outbound connection as of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12673&quot; title=&quot;Nodes cannot see each other in multi-DC, non-EC2 environment with two-interface nodes due to outbound node-to-node connection binding to private interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12673&quot;&gt;&lt;del&gt;CASSANDRA-12673&lt;/del&gt;&lt;/a&gt;, yet I mistakenly brought that back (see &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/net/async/NettyFactory.java#L337&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;NettyFactory#createOutboundBootstrap()&lt;/tt&gt;&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I believe the most correct fix is just not setting the local address to bind to for outbound connections, as that&apos;s bascially what &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12673&quot; title=&quot;Nodes cannot see each other in multi-DC, non-EC2 environment with two-interface nodes due to outbound node-to-node connection binding to private interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12673&quot;&gt;&lt;del&gt;CASSANDRA-12673&lt;/del&gt;&lt;/a&gt; does. Removing the local bind should resolve &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lerh+Low&quot; class=&quot;user-hover&quot; rel=&quot;Lerh Low&quot;&gt;Lerh Low&lt;/a&gt;&apos;s error as well as eliminate the regression against &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12673&quot; title=&quot;Nodes cannot see each other in multi-DC, non-EC2 environment with two-interface nodes due to outbound node-to-node connection binding to private interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12673&quot;&gt;&lt;del&gt;CASSANDRA-12673&lt;/del&gt;&lt;/a&gt;. However, we should also incorporate &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lerh+Low&quot; class=&quot;user-hover&quot; rel=&quot;Lerh Low&quot;&gt;Lerh Low&lt;/a&gt;&apos;s fix as well, to clarify the intent of which address we want to &apos;reference&apos; (but not actually use) on the local side.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;14362&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/14362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jasobrown/workflows/cassandra/tree/14362&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests &amp;amp; dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;tests are running now. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; do you mind reviewing?&lt;/p&gt;

&lt;p&gt;UPDATE: dtests seem to be pretty unhappy. I&apos;ll investigate what&apos;s wrong and ping this ticket with updates.&lt;/p&gt;</comment>
                            <comment id="16429722" author="djoshi3" created="Sun, 8 Apr 2018 11:07:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; I think I know what the issue is. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; not only changed the &lt;tt&gt;OutboundConnectionIdentifier&lt;/tt&gt; to prefer the local address of the node but also removed the binding to a specific local IP address during &lt;tt&gt;NettyFactory#createOutboundBootstrap&lt;/tt&gt; setup. This had an unintended consequence. When you leave the &lt;tt&gt;Socket&lt;/tt&gt;&apos;s source IP (local address) unset, the kernel will choose one for you. This normally is not an issue. However, during the&#160;dtest run all nodes are local and rely on 127.0.0.x IPs. When the C* nodes try to setup the streaming connections, they get tripped up due to this change.&lt;/p&gt;

&lt;p&gt;Say node1 (127.0.0.1) &amp;amp; node2 (127.0.0.2) are started up by the dtest (I know in reality its 3 nodes but for the sake of simplicity I&apos;m limiting it to two nodes). node1 attempts to create an outbound connection for streaming with node2, the outbound socket should actually be &lt;tt&gt;127.0.0.1:ANY_PORT -&amp;gt; 127.0.0.2:INTERNODE_PORT&lt;/tt&gt;. However, per this patch, we leave the source IP unbound. When the connection is established and node1 sends the &lt;tt&gt;FirstHandshakeMessage&lt;/tt&gt;, it has a source IP set to set to an arbitrarily chose IP by the kernel - in this case it was &lt;tt&gt;127.0.0.2&lt;/tt&gt; (when it should actually be &lt;tt&gt;127.0.0.1&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;The receiving node (node2) gets this message &lt;tt&gt;InboundHandshakeHandler#handleStart&lt;/tt&gt;, decodes it fine but when it goes to &lt;tt&gt;InboundHandshakeHandler#setupStreamingPipeline&lt;/tt&gt;, it creates a &lt;tt&gt;StreamingInboundHandler&lt;/tt&gt; with remote IP set to &lt;tt&gt;127.0.0.2&lt;/tt&gt;. This messes up the streaming pipeline because now node2 is waiting on &lt;tt&gt;127.0.0.2&lt;/tt&gt; (itself) for data. Hence we find it stuck in the bootstrap phase -&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;Stream-Deserializer-127.0.0.2:7000-4004ef3b&quot; #133 daemon prio=5 os_prio=35 tid=0x00007ff58c601ca0 nid=0xdc03 waiting on condition [0x0000700007613000]
   java.lang.Thread.State: TIMED_WAITING (sleeping)
	at java.lang.Thread.sleep(Native Method)
	at java.lang.Thread.sleep(Thread.java:340)
	at java.util.concurrent.TimeUnit.sleep(TimeUnit.java:386)
	at com.google.common.util.concurrent.Uninterruptibles.sleepUninterruptibly(Uninterruptibles.java:285)
	at org.apache.cassandra.streaming.async.StreamingInboundHandler$StreamDeserializingTask.run(StreamingInboundHandler.java:174)
	at java.lang.Thread.run(Thread.java:748)

&quot;main&quot; #1 prio=5 os_prio=35 tid=0x00007ff58c706000 nid=0x2803 waiting on condition [0x0000700004e5e000]
   java.lang.Thread.State: WAITING (parking)
	at sun.misc.Unsafe.park(Native Method)
	- parking to wait for  &amp;lt;0x00000007a11a3f98&amp;gt; (a org.apache.cassandra.streaming.StreamResultFuture)
	at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
	at com.google.common.util.concurrent.AbstractFuture.get(AbstractFuture.java:497)
	at org.apache.cassandra.service.StorageService.bootstrap(StorageService.java:1519)
	at org.apache.cassandra.service.StorageService.joinTokenRing(StorageService.java:949)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:651)
	- locked &amp;lt;0x00000007a40f80b8&amp;gt; (a org.apache.cassandra.service.StorageService)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:586)
	- locked &amp;lt;0x00000007a40f80b8&amp;gt; (a org.apache.cassandra.service.StorageService)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:367)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:590)
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:679)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I also noted this error in the logs which further points to the wrong IP for the peer being used -&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [Stream-Deserializer-127.0.0.2:53830-7b781083] 2018-04-06 13:19:25,863 StreamingInboundHandler.java:210 - [Stream channel: 7b781083] stream operation from 127.0.0.2:53830 failed
java.lang.IllegalArgumentException: Unknown peer requested: 127.0.0.2:7000
        at org.apache.cassandra.streaming.StreamCoordinator.getHostData(StreamCoordinator.java:242)
        at org.apache.cassandra.streaming.StreamCoordinator.getSessionById(StreamCoordinator.java:170)
        at org.apache.cassandra.streaming.StreamResultFuture.getSession(StreamResultFuture.java:237)
        at org.apache.cassandra.streaming.StreamManager.findSession(StreamManager.java:194)
        at org.apache.cassandra.streaming.StreamManager.findSession(StreamManager.java:185)
        at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:41)
        at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:36)
        at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:55)
        at org.apache.cassandra.streaming.async.StreamingInboundHandler$StreamDeserializingTask.run(StreamingInboundHandler.java:177)
        at java.lang.Thread.run(Thread.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I added a bit of debugging code and turned &lt;tt&gt;TRACE&lt;/tt&gt; logging on and confirmed that this was indeed the case.&lt;/p&gt;

&lt;p&gt;Below is the output of node2&apos;s debug.log in the 3 node cluster that dtest run created. node1, 2 &amp;amp; 3 were assigned IPs &lt;tt&gt;127.0.0.1, 127.0.0.2, 127.0.0.3&lt;/tt&gt; respectively. Note that node2&apos;s actual IP is never used as we&apos;ve left it unbound so it seems the OS kernel prefers the IP that it thinks is closest to the remote IP so channel local &amp;amp; remote as the showing up as the same IP.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;03:07 $ tail -F /var/folders/5f/_29kl4f524l7gp__02cxby_c0000gn/T/dtest-wu9pai7a/test/node2/logs/debug.log  | grep handshake
TRACE [MessagingService-NettyOutbound-Thread-4-1] 2018-04-08 03:07:55,360 OutboundHandshakeHandler.java:107 - starting handshake with peer 127.0.0.1:7000, msg = FirstHandshakeMessage - messaging version: 12, mode: MESSAGING, compress: false, channel local = /127.0.0.1:65020 remote = /127.0.0.1:7000
TRACE [MessagingService-NettyOutbound-Thread-4-3] 2018-04-08 03:09:21,427 OutboundHandshakeHandler.java:107 - starting handshake with peer 127.0.0.3:7000, msg = FirstHandshakeMessage - messaging version: 12, mode: MESSAGING, compress: false, channel local = /127.0.0.3:65091 remote = /127.0.0.3:7000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I only modified the trace log line in &lt;tt&gt;OutboundHandshakeHandler#channelActive&lt;/tt&gt; as below -&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        logger.trace(&quot;starting handshake with peer {}, msg = {}, channel local = {} remote = {}&quot;, connectionId.connectionAddress(),
                     msg, ctx.channel().localAddress(), ctx.channel().remoteAddress());
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;What is unclear to me is why is this an issue now if &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12673&quot; title=&quot;Nodes cannot see each other in multi-DC, non-EC2 environment with two-interface nodes due to outbound node-to-node connection binding to private interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12673&quot;&gt;&lt;del&gt;CASSANDRA-12673&lt;/del&gt;&lt;/a&gt; left the local side unbound?&lt;/p&gt;</comment>
                            <comment id="16440818" author="jasobrown" created="Tue, 17 Apr 2018 12:49:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lerh+Low&quot; class=&quot;user-hover&quot; rel=&quot;Lerh Low&quot;&gt;Lerh Low&lt;/a&gt;&apos;s patch is correct and fixes a bug I introduced with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12229&quot; title=&quot;Move streaming to non-blocking IO and netty (streaming 2.1)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12229&quot;&gt;&lt;del&gt;CASSANDRA-12229&lt;/del&gt;&lt;/a&gt;. Further, there is something wrong with my handling of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12673&quot; title=&quot;Nodes cannot see each other in multi-DC, non-EC2 environment with two-interface nodes due to outbound node-to-node connection binding to private interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12673&quot;&gt;&lt;del&gt;CASSANDRA-12673&lt;/del&gt;&lt;/a&gt;, but I don&apos;t want to hold up Lerh or anyone else looking at 4.0 in ec2. Thus, I&apos;ve decided to commit Lerh&apos;s patch and will open a followup ticket to address the local address binding issue.&lt;/p&gt;

&lt;p&gt;Committed as sha &lt;tt&gt;70d95359d2dca1c35f573776d11ed87bb9b4b441&lt;/tt&gt;. Nice find and fix, Lehr.&lt;/p&gt;</comment>
                            <comment id="16440820" author="jasobrown" created="Tue, 17 Apr 2018 12:53:43 +0000"  >&lt;p&gt;Opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14389&quot; title=&quot;Resolve local address binding in 4.0&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14389&quot;&gt;&lt;del&gt;CASSANDRA-14389&lt;/del&gt;&lt;/a&gt; for the local address binding regression. Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi3&quot; class=&quot;user-hover&quot; rel=&quot;djoshi3&quot;&gt;djoshi3&lt;/a&gt; for also looking at this ticket.&lt;/p&gt;</comment>
                            <comment id="16443363" author="lerh low" created="Thu, 19 Apr 2018 00:07:38 +0000"  >&lt;p&gt;It&apos;s not blocking me because I have that workaround, but thanks for looking into it so quickly, much appreciated &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[Lerh Low]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 30 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3s413:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>