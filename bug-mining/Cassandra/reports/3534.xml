<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:52:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8051] Add SERIAL and LOCAL_SERIAL consistency levels to cqlsh</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8051</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;cqlsh does not support setting the serial consistency level. The default CL.SERIAL does not let users safely execute LWT alongside an app that runs at LOCAL_SERIAL, and can prevent any LWT from running when a DC is down (e.g. with 2 DCs, RF=3 in each.)&lt;/p&gt;

&lt;p&gt;Implementing this well is a bit tricky. A user setting the serial CL will probably not want all of their statements to have a serial CL attached, but only the conditional updates. At the same time it would be useful to support serial reads. &quot;WITH CONSISTENCY LEVEL&quot; used to provide this flexibility.&lt;/p&gt;

&lt;p&gt;I believe that it is currently impossible to run a SELECT at SERIAL or LOCAL_SERIAL; the only workaround seems to be to run a conditional update with a predicate that always resolves to False, and to rely on the CAS response to read the data.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12745776">CASSANDRA-8051</key>
            <summary>Add SERIAL and LOCAL_SERIAL consistency levels to cqlsh</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="carlyeks">Carl Yeksigian</assignee>
                                    <reporter username="nff">Nicolas Favre-Felix</reporter>
                        <labels>
                            <label>LWT</label>
                            <label>cqlsh</label>
                    </labels>
                <created>Fri, 3 Oct 2014 17:27:57 +0000</created>
                <updated>Fri, 25 Oct 2019 13:11:47 +0000</updated>
                            <resolved>Tue, 5 May 2015 19:47:35 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.6</fixVersion>
                                    <component>Feature/Lightweight Transactions</component>
                    <component>Legacy/Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14489621" author="carlyeks" created="Fri, 10 Apr 2015 13:30:33 +0000"  >&lt;p&gt;To add support for &lt;tt&gt;SERIAL&lt;/tt&gt; and &lt;tt&gt;LOCAL_SERIAL&lt;/tt&gt; consistency levels in cqlsh, we need to update the Thrift generated files in &lt;tt&gt;cassandra-dbapi2&lt;/tt&gt;. I&apos;ve attached a patch to do this.&lt;/p&gt;

&lt;p&gt;I&apos;d lean towards not adding per-statement consistency levels since it will probably only be used in cqlsh, and while it is inconvenient to have to included &lt;tt&gt;CONSISTENCY&lt;/tt&gt; statements in front of each statement, it would work the same as including it afterward.&lt;/p&gt;</comment>
                            <comment id="14506667" author="stefania" created="Wed, 22 Apr 2015 08:50:37 +0000"  >&lt;p&gt;Provided we are happy with the chosen approach to specify CONSISTENCY before issuing a statement, the patch is +1, ready for commit.&lt;/p&gt;
</comment>
                            <comment id="14507414" author="thobbs" created="Wed, 22 Apr 2015 17:00:02 +0000"  >&lt;p&gt;The patch handles setting serial consistency levels for reads, but not for writes.  This section of the python driver docs explains how &lt;tt&gt;consistency_level&lt;/tt&gt; and &lt;tt&gt;serial_consistency_level&lt;/tt&gt; work in conjunction: &lt;a href=&quot;http://datastax.github.io/python-driver/api/cassandra/query.html#cassandra.query.Statement.serial_consistency_level&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://datastax.github.io/python-driver/api/cassandra/query.html#cassandra.query.Statement.serial_consistency_level&lt;/a&gt;.  To support setting the &lt;tt&gt;serial_consistency_level&lt;/tt&gt; for writes, we probably need a new cqlsh command: &lt;tt&gt;SERIAL CONSISTENCY&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14507570" author="carlyeks" created="Wed, 22 Apr 2015 18:08:12 +0000"  >&lt;p&gt;For 2.1, add &lt;tt&gt;SERIAL CONSISTENCY&lt;/tt&gt; command. For 2.0, since we are using the Thrift protocol, we can&apos;t set &lt;tt&gt;serial_consistency_level&lt;/tt&gt;, so that patch is as good as we&apos;ll get.&lt;/p&gt;</comment>
                            <comment id="14508327" author="stefania" created="Thu, 23 Apr 2015 02:27:47 +0000"  >&lt;p&gt;&lt;b&gt;Note:&lt;/b&gt;&lt;br/&gt;
For testing I used some log statements in StorageProxy.java and SelectStatement.java, see attached patches.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;2.0 patch:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;Confirmed that it only works for reads, for conditional updates it cannot be used and afaict it cannot be set from Thrift either.&lt;/p&gt;

&lt;p&gt;Here&apos;s what happens for updates:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CONSISTENCY SERIAL;
Consistency level set to SERIAL.
insert into test (id, col, val) values (2, 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;) IF NOT EXISTS;
Bad Request: SERIAL is not supported as conditional update commit consistency. Use ANY &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you mean &lt;span class=&quot;code-quote&quot;&gt;&quot;make sure it is accepted but I don&apos;t care how many replicas commit it &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; non-SERIAL reads&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Same for LOCAL_SERIAL.&lt;/p&gt;

&lt;p&gt;&lt;b&gt;2.1 patch:&lt;/b&gt;&lt;/p&gt;

&lt;p&gt;&quot;Sets consistency level for future requests&quot; should perhaps be changed to &quot;..for future conditional updates&quot;&lt;/p&gt;

&lt;p&gt;Trailing space just above &lt;tt&gt;def do_serial(self, parsed):&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Same issue as in 2.0 with setting CONSISTENCY to SERIAL or LOCAL_SERIAL before conditional updates:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:test&amp;gt; CONSISTENCY LOCAL_SERIAL 
Consistency level set to LOCAL_SERIAL.
cqlsh:test&amp;gt; insert into test (id, col, val) values (1, 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;) IF NOT EXISTS;
InvalidRequest: code=2200 [Invalid query] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;LOCAL_SERIAL is not supported as conditional update commit consistency. Use ANY &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you mean &quot;&lt;/span&gt;make sure it is accepted but I don&apos;t care how many replicas commit it &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; non-SERIAL reads&quot;&quot;
cqlsh:test&amp;gt; CONSISTENCY SERIAL 
Consistency level set to SERIAL.
cqlsh:test&amp;gt; insert into test (id, col, val) values (1, 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;) IF NOT EXISTS;
InvalidRequest: code=2200 [Invalid query] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;SERIAL is not supported as conditional update commit consistency. Use ANY &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you mean &quot;&lt;/span&gt;make sure it is accepted but I don&apos;t care how many replicas commit it &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; non-SERIAL reads&quot;&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The patch doesn&apos;t work for conditional updates:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SERIAL CONSISTENCY LOCAL_SERIAL;
insert into test (id, col, val) values (1, 1, &lt;span class=&quot;code-quote&quot;&gt;&apos;1&apos;&lt;/span&gt;) IF NOT EXISTS;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;it will give these log messages, which are incorrect:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INFO  01:20:01 Consistency level in cas &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; paxos : SERIAL
INFO  01:20:01 Consistency level in cas &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commit : ONE
INFO  01:20:01 Consistency level in read : QUORUM
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The problem is in the python driver, in query.py &lt;tt&gt;_set_serial_consistency_level&lt;/tt&gt; forgets to actually set the value:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    def _set_serial_consistency_level(self, serial_consistency_level):
        acceptable = (None, ConsistencyLevel.SERIAL, ConsistencyLevel.LOCAL_SERIAL)
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; serial_consistency_level not in acceptable:
            raise ValueError(
                &lt;span class=&quot;code-quote&quot;&gt;&quot;serial_consistency_level must be either ConsistencyLevel.SERIAL &quot;&lt;/span&gt;
                &lt;span class=&quot;code-quote&quot;&gt;&quot;or ConsistencyLevel.LOCAL_SERIAL&quot;&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;python-driver-fix.txt fixes it. We need to raise a python driver ticket.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure it it&apos;s an overkill, but given that CONSISTENCY SERIAL/LOCAL_SERIAL causes errors to conditional updates, in both 2.0 and 2.1, perhaps we ought to consider attaching it to SELECT statements only.&lt;/p&gt;</comment>
                            <comment id="14509307" author="aholmber" created="Thu, 23 Apr 2015 16:33:21 +0000"  >&lt;p&gt;Thanks for identifying this. Will have a fix and test in shortly. &lt;a href=&quot;https://datastax-oss.atlassian.net/browse/PYTHON-299&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://datastax-oss.atlassian.net/browse/PYTHON-299&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14509481" author="carlyeks" created="Thu, 23 Apr 2015 18:07:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt;: I agree that we should consider dropping &lt;tt&gt;SERIAL&lt;/tt&gt;/&lt;tt&gt;LOCAL_SERIAL&lt;/tt&gt; for selects, but I think we should create a separate ticket for that, as it will affect more than just cqlsh.&lt;/p&gt;</comment>
                            <comment id="14510085" author="stefania" created="Thu, 23 Apr 2015 23:45:08 +0000"  >&lt;p&gt;Understood, provided the first two trivial points are addressed the 2.1 patch is +1.&lt;/p&gt;</comment>
                            <comment id="14510089" author="stefania" created="Thu, 23 Apr 2015 23:46:50 +0000"  >&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="14510671" author="slebresne" created="Fri, 24 Apr 2015 08:53:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;I agree that we should consider dropping SERIAL/LOCAL_SERIAL for selects, but I think we should create a separate ticket for that&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Why would you want do that?&lt;/p&gt;</comment>
                            <comment id="14510987" author="carlyeks" created="Fri, 24 Apr 2015 13:03:47 +0000"  >&lt;p&gt;I meant non-selects.&lt;/p&gt;</comment>
                            <comment id="14515007" author="carlyeks" created="Mon, 27 Apr 2015 21:11:09 +0000"  >&lt;p&gt;The python driver just released a 2.5.1 version which includes the fix that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; had for serial consistency.&lt;/p&gt;

&lt;p&gt;Attaching a v2 which includes the updated internal driver.&lt;/p&gt;</comment>
                            <comment id="14516041" author="stefania" created="Tue, 28 Apr 2015 00:32:00 +0000"  >&lt;p&gt;The 2.1-v2 patch works as expected, +1.&lt;/p&gt;

&lt;p&gt;Nits:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;we still have a trailing space just above &lt;tt&gt;def do_serial(self, parsed):&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;the HELP documentation of the SERIAL CONSISTENCY command could be changed from &quot;Sets consistency level for future requests&quot; to &quot;Sets consistency level for future conditional updates&quot;.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Also:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the HELP documentation for CONSISTENCY should perhaps mention that SERIAL and LOCAL_SERIAL can only be used for selects and will be rejected with updates.&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="14517064" author="carlyeks" created="Tue, 28 Apr 2015 14:09:45 +0000"  >&lt;p&gt;v3 addresses feedback.&lt;/p&gt;</comment>
                            <comment id="14518361" author="stefania" created="Tue, 28 Apr 2015 23:39:56 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14526391" author="stefania" created="Mon, 4 May 2015 08:07:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; review is complete, 8051-2.1-v3 and 8051-2.0 can be committed if you are OK with them.&lt;/p&gt;</comment>
                            <comment id="14529141" author="thobbs" created="Tue, 5 May 2015 19:47:35 +0000"  >&lt;p&gt;Thanks, committed as &lt;tt&gt;afe541a4&lt;/tt&gt; in 2.0, &lt;tt&gt;2252773&lt;/tt&gt; in 2.1, and merged to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12724557" name="8051-2.0.txt" size="238792" author="carlyeks" created="Fri, 10 Apr 2015 13:30:33 +0000"/>
                            <attachment id="12728510" name="8051-2.1-v2.txt" size="478228" author="carlyeks" created="Mon, 27 Apr 2015 21:11:09 +0000"/>
                            <attachment id="12728788" name="8051-2.1-v3.txt" size="478670" author="carlyeks" created="Tue, 28 Apr 2015 14:09:45 +0000"/>
                            <attachment id="12727294" name="8051-2.1.txt" size="3597" author="carlyeks" created="Wed, 22 Apr 2015 18:08:12 +0000"/>
                            <attachment id="12727509" name="log-statements-2.0.txt" size="2932" author="stefania" created="Thu, 23 Apr 2015 02:27:47 +0000"/>
                            <attachment id="12727510" name="log-statements-2.1.txt" size="2840" author="stefania" created="Thu, 23 Apr 2015 02:27:47 +0000"/>
                            <attachment id="12727508" name="python-driver-fix.txt" size="508" author="stefania" created="Thu, 23 Apr 2015 02:27:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>7.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 29 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20s0n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stefania</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>