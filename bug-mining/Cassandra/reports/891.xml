<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:20:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2536] Schema disagreements when using connections to multiple hosts</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2536</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If you have two thrift connections open to different nodes and you create a KS using the first, then a CF in that KS using the second, you wind up with a schema disagreement even if you wait/sleep after creating the KS.&lt;/p&gt;

&lt;p&gt;The attached script reproduces the issue using pycassa (1.0.6 should work fine, although it has the 0.7 thrift-gen code).  It&apos;s also reproducible by hand with two cassandra-cli sessions.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Two node 0.8-beta1 cluster with one seed and JNA.&lt;/p&gt;</environment>
        <key id="12504930">CASSANDRA-2536</key>
            <summary>Schema disagreements when using connections to multiple hosts</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="thobbs">Tom Hobbs</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Apr 2011 22:55:36 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:01 +0000</updated>
                            <resolved>Fri, 29 Apr 2011 15:38:01 +0000</resolved>
                                        <fixVersion>0.7.6</fixVersion>
                    <fixVersion>0.8.0 beta 2</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13022978" author="mbulman" created="Thu, 21 Apr 2011 23:20:47 +0000"  >&lt;p&gt;I feel like a better, more critical sounding explanation, is:  create a keyspace on node1, create a cf in that keyspace on node2 = hang + schema disagreement.&lt;/p&gt;</comment>
                            <comment id="13023070" author="jbellis" created="Fri, 22 Apr 2011 01:37:04 +0000"  >&lt;p&gt;And this is fine in 0.7?&lt;/p&gt;</comment>
                            <comment id="13023257" author="thobbs" created="Fri, 22 Apr 2011 16:03:49 +0000"  >&lt;p&gt;Actually, I can also reproduce this with a two node 0.7.4 cluster.  I&apos;m pretty sure that this does not happen with 0.7.3, but I&apos;ll go ahead and verify that.&lt;/p&gt;</comment>
                            <comment id="13023263" author="thobbs" created="Fri, 22 Apr 2011 16:20:22 +0000"  >&lt;p&gt;Nevermind my thoughts that it doesn&apos;t happen in 0.7.3 &amp;#8211; it seems to happen there too.  It appears this is not a recent problem.&lt;/p&gt;</comment>
                            <comment id="13024804" author="1eightt" created="Mon, 25 Apr 2011 14:09:58 +0000"  >&lt;p&gt;Just bumped into this on a fresh 0.7.4 install on our test cluster. Does this only happen in a 2 node ring?&lt;/p&gt;</comment>
                            <comment id="13025942" author="ceocoder" created="Wed, 27 Apr 2011 18:38:05 +0000"  >&lt;p&gt;encountered this on fresh 0.7.4 - 5 nodes - 100G+ per node. &lt;/p&gt;

&lt;p&gt;decommissioning the bad node and rejoin fixed the problem.&lt;/p&gt;</comment>
                            <comment id="13026070" author="jbellis" created="Thu, 28 Apr 2011 02:10:29 +0000"  >&lt;p&gt;Gary, any thoughts on where to start looking?&lt;/p&gt;</comment>
                            <comment id="13026292" author="gdusbabek" created="Thu, 28 Apr 2011 12:42:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;any thoughts...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I was going to add some jmx to get the last N schema versions (seems like it would be handy anyway and will be necessary if we ever get the rollback pony). Send schema to node A, verify that schema is propagated to B, send schema to B and watch the problem happen.  The code to start looking at are the Definitions*VerbHandlers.&lt;/p&gt;

&lt;p&gt;Schema version is tracked in two places: gossip and in DatabaseDescriptor.defsVersion.  Make sure those are reasonably in sync (was the sourced of one bug in the past). &lt;/p&gt;</comment>
                            <comment id="13026674" author="thobbs" created="Thu, 28 Apr 2011 20:58:51 +0000"  >&lt;p&gt;The issue is the clocks being out of sync between nodes.  Sometimes the v1 UUID generated by the second node has an earlier timestamp than the current schema UUID has.&lt;/p&gt;

&lt;p&gt;There are a couple of things that could be fixed here:&lt;/p&gt;

&lt;p&gt;1. A node shouldn&apos;t accept a schema change if the timestamp for the new schema would be earlier than its current schema.&lt;br/&gt;
2. Schema modification calls should accept an optional client-side timestamp that will be used for the v1 UUID.&lt;/p&gt;</comment>
                            <comment id="13026684" author="gdusbabek" created="Thu, 28 Apr 2011 21:08:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;Sometimes the v1 UUID generated by the second node has an earlier timestamp than the current schema UUID has.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Wouldn&apos;t that update be DOA then?  I thought we checked to make sure the new migration compared after the current migration (as well as making sure the new migration&apos;s previous version matches with the current version).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;A node shouldn&apos;t accept a schema change if the timestamp for the new schema would be earlier than its current schema.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;If the clocks are &lt;b&gt;that&lt;/b&gt; far off sync, I think the cluster has bigger problems (like writes not being applied). Plus, it would be easy for a node whose clock is way head to &apos;poison&apos; schema updates from the rest of the cluster who are, in effect, behind the times.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Schema modification calls should accept an optional client-side timestamp that will be used for the v1 UUID.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Seems like a better approach.&lt;/p&gt;
</comment>
                            <comment id="13026698" author="jbellis" created="Thu, 28 Apr 2011 21:21:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;A node shouldn&apos;t accept a schema change if the timestamp for the new schema would be earlier than its current schema.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You need this with or without the client-side timestamp, though; there&apos;s no sense in letting people blow their leg off.&lt;/p&gt;

&lt;p&gt;And once you have that you don&apos;t need to add a client-side timestamp with all the PITA-ness that involves.&lt;/p&gt;

&lt;p&gt;(And unlike with data modification, I can&apos;t think of a use for doing &quot;clever&quot; things w/ a client side timesamp.  So pushing it to the client doesn&apos;t really solve anything, just means you need to sync clocks across more machines.)&lt;/p&gt;</comment>
                            <comment id="13026710" author="thobbs" created="Thu, 28 Apr 2011 21:33:33 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Wouldn&apos;t that update be DOA then? I thought we checked to make sure the new migration compared after the current migration (as well as making sure the new migration&apos;s previous version matches with the current version).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We do check that the previous version matches, but the migration is applied locally without comparing the current and new uuids.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;If the clocks are that far off sync, I think the cluster has bigger problems (like writes not being applied).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This can theoretically happen with clocks being off by only tens of milliseconds.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;And unlike with data modification, I can&apos;t think of a use for doing &quot;clever&quot; things w/ a client side timesamp. So pushing it to the client doesn&apos;t really solve anything, just means you need to sync clocks across more machines.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Not for clever purposes &amp;#8211; it seems to me that clients making schema modifications are more likely to be centralized, so schema changes coming from a single client will (almost) always have increasing timestamps.&lt;/p&gt;</comment>
                            <comment id="13026738" author="thobbs" created="Thu, 28 Apr 2011 22:26:27 +0000"  >&lt;p&gt;Attached patch compares version timestamps before applying migration locally.&lt;/p&gt;</comment>
                            <comment id="13026763" author="thobbs" created="Thu, 28 Apr 2011 23:08:39 +0000"  >&lt;p&gt;I personally think the timestamp comparison is good enough for now.  Any interest in opening a new ticket for client-side timestamps?&lt;/p&gt;</comment>
                            <comment id="13026801" author="jbellis" created="Fri, 29 Apr 2011 01:11:52 +0000"  >&lt;blockquote&gt;&lt;p&gt;it seems to me that clients making schema modifications are more likely to be centralized&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I would have also argued that they are likely to use the same connection (to the same server), and look where that got us. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I personally think the timestamp comparison is good enough for now&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am okay with this. What do you think, Gary?&lt;/p&gt;

&lt;p&gt;(Nit: the exception message says &quot;older&quot; but the comparison is &quot;older or equal.&quot;)&lt;/p&gt;</comment>
                            <comment id="13026896" author="slebresne" created="Fri, 29 Apr 2011 07:38:44 +0000"  >&lt;p&gt;I&apos;ll hijack this conversation by saying that I think we should start advertising that people should try to keep their server clocks in sync unless they have a good reason not too (which would legitimize the fact that &quot;timestamp comparison is good enough&quot;). Counter removes for instance use server side timestamps and would be screwed up by diverging clocks (and by that I mean more screwed up than they already are by design). And really, is there any reason not to install a ntpd server in the first place anyway?&lt;/p&gt;</comment>
                            <comment id="13026953" author="gdusbabek" created="Fri, 29 Apr 2011 12:35:33 +0000"  >&lt;p&gt;I think timestamp comparisons will be fine.&lt;/p&gt;</comment>
                            <comment id="13027035" author="jbellis" created="Fri, 29 Apr 2011 15:38:01 +0000"  >&lt;p&gt;committed, thanks!&lt;/p&gt;</comment>
                            <comment id="13027046" author="hudson" created="Fri, 29 Apr 2011 15:56:06 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #462 (See &lt;a href=&quot;https://builds.apache.org/hudson/job/Cassandra-0.7/462/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/hudson/job/Cassandra-0.7/462/&lt;/a&gt;)&lt;br/&gt;
    refuse to apply migrations with older timestamps than the current schema&lt;br/&gt;
patch by Tyler Hobbs; reviewed by jbellis and gdusbabek for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2536&quot; title=&quot;Schema disagreements when using connections to multiple hosts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2536&quot;&gt;&lt;del&gt;CASSANDRA-2536&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12477706" name="2536-compare-timestamp.txt" size="853" author="thobbs" created="Thu, 28 Apr 2011 22:26:27 +0000"/>
                            <attachment id="12477050" name="schema_disagree.py" size="1205" author="thobbs" created="Thu, 21 Apr 2011 22:56:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20682</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 30 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gbxz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93365</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>