<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13009] Speculative retry bugs</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13009</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There are a few issues with speculative retry:&lt;/p&gt;

&lt;p&gt;1. Time unit bugs. These are from ColumnFamilyStore (v3.0.10):&lt;/p&gt;

&lt;p&gt;The left hand side is in nanos, as the name suggests, while the right hand side is in millis.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sampleLatencyNanos = DatabaseDescriptor.getReadRpcTimeout() / 2;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here coordinatorReadLatency is already in nanos and we shouldn&apos;t multiple the value by 1000. This was a regression in 8896a70 when we switch metrics library and the two libraries use different time units.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sampleLatencyNanos = (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;) (metric.coordinatorReadLatency.getSnapshot().getValue(retryPolicy.threshold()) * 1000d);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;2. Confusing overload protection and retry delay. As the name &quot;sampleLatencyNanos&quot; suggests, it should be used to keep the actually sampled read latency. However, we assign it the retry threshold in the case of CUSTOM. Then we compare the retry threshold with read timeout (defaults to 5000ms). This means, if we use speculative_retry=10ms for the table, we won&apos;t be able to avoid being overloaded. We should compare the actual read latency with the read timeout for overload protection. See line 450 of ColumnFamilyStore.java and line 279 of AbstractReadExecutor.java.&lt;/p&gt;

&lt;p&gt;My proposals are:&lt;br/&gt;
a. We use sampled p99 delay and compare it with a customizable threshold (-Dcassandra.overload.threshold) for overload detection.&lt;br/&gt;
b. Introduce another variable retryDelayNanos for waiting time before retry. This is the value from table setting (PERCENTILE or CUSTOM).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13026184">CASSANDRA-13009</key>
            <summary>Speculative retry bugs</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="szhou">Simon Zhou</assignee>
                                    <reporter username="szhou">Simon Zhou</reporter>
                        <labels>
                    </labels>
                <created>Wed, 7 Dec 2016 01:19:25 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:56 +0000</updated>
                            <resolved>Fri, 3 Feb 2017 20:21:48 +0000</resolved>
                                        <fixVersion>2.2.9</fixVersion>
                    <fixVersion>3.0.11</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="15727346" author="szhou" created="Wed, 7 Dec 2016 01:37:41 +0000"  >&lt;p&gt;We should have some unit tests for SpeculatingReadExecutor and AbstractReadExecutor#getReadExecutor. I&apos;ll try to add some after the initial review.&lt;/p&gt;</comment>
                            <comment id="15832727" author="szhou" created="Sat, 21 Jan 2017 01:47:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;, do you mind reviewing this patch? Thanks.&lt;/p&gt;</comment>
                            <comment id="15850481" author="tjake" created="Thu, 2 Feb 2017 20:58:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=szhou&quot; class=&quot;user-hover&quot; rel=&quot;szhou&quot;&gt;szhou&lt;/a&gt; nice find!&lt;/p&gt;

&lt;p&gt;I&apos;m leaning towards just fixing the two unit bugs with sampleLatencyNanos. &lt;/p&gt;

&lt;p&gt;I think your idea of splitting the sample vs the delay is valid but I&apos;d like to fix this first and you can re-submit the rest of the patch under an improvement ticket ok?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/tjake/cassandra/tree/speculative_retries_22&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt; &lt;a href=&quot;http://cassci.datastax.com/job/tjake-speculative_retries_22-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;a href=&quot;http://cassci.datastax.com/job/tjake-speculative_retries_22-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/tjake/cassandra/tree/speculative_retries_30&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;a href=&quot;http://cassci.datastax.com/job/tjake-speculative_retries_30-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt; &lt;a href=&quot;http://cassci.datastax.com/job/tjake-speculative_retries_30-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="15850486" author="JIRAUSER308715" created="Thu, 2 Feb 2017 21:02:00 +0000"  >&lt;p&gt;The &quot;just fix the time unit issues&quot; patches look good to me. +1&lt;/p&gt;</comment>
                            <comment id="15850545" author="szhou" created="Thu, 2 Feb 2017 21:30:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;, sure. I abstracted out the time unit fix as v2 patch. For the improvement, I&apos;ll create a separate ticket to track that. Thanks for the review!&lt;/p&gt;</comment>
                            <comment id="15852057" author="tjake" created="Fri, 3 Feb 2017 20:21:48 +0000"  >&lt;p&gt;Thanks! committed as &lt;tt&gt;25938090a68b10d12bf594fc344dd52fe5bd5447&lt;/tt&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12842067" name="CASSANDRA-13009-v1.patch" size="7186" author="szhou" created="Wed, 7 Dec 2016 01:33:21 +0000"/>
                            <attachment id="12850691" name="CASSANDRA-13009-v2.patch" size="1748" author="szhou" created="Thu, 2 Feb 2017 21:30:57 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[szhou]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 41 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i379j3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12338291">3.0.10</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332983">2.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>