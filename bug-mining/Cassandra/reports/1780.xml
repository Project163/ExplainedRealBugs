<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:35:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4377] CQL3 column value validation bug</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4377</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh&amp;gt; create keyspace test with strategy_class = &apos;SimpleStrategy&apos; and strategy_options:replication_factor = 1;
cqlsh&amp;gt; use test;
cqlsh:test&amp;gt; CREATE TABLE stats (
        ...   gid          blob,
        ...   period     int,
        ...   tid          blob, 
        ...   sum        int,
        ...   uniques           blob,
        ...   PRIMARY KEY(gid, period, tid)
        ... );
cqlsh:test&amp;gt; describe columnfamily stats;

CREATE TABLE stats (
  gid blob PRIMARY KEY
) WITH
  comment=&apos;&apos; AND
  comparator=&apos;CompositeType(org.apache.cassandra.db.marshal.Int32Type,org.apache.cassandra.db.marshal.BytesType,org.apache.cassandra.db.marshal.UTF8Type)&apos; AND
  read_repair_chance=0.100000 AND
  gc_grace_seconds=864000 AND
  default_validation=text AND
  min_compaction_threshold=4 AND
  max_compaction_threshold=32 AND
  replicate_on_write=&apos;true&apos; AND
  compaction_strategy_class=&apos;SizeTieredCompactionStrategy&apos; AND
  compression_parameters:sstable_compression=&apos;SnappyCompressor&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You can see in the above output that the stats cf is created with the column validator set to text, but neither of the non primary key columns defined are text. It should either be setting metadata for those columns or not setting a default validator or some combination of the two.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12595934">CASSANDRA-4377</key>
            <summary>CQL3 column value validation bug</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xedin">Pavel Yaskevich</assignee>
                                    <reporter username="nickmbailey">Nick Bailey</reporter>
                        <labels>
                            <label>cql3</label>
                    </labels>
                <created>Tue, 26 Jun 2012 16:44:06 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:31 +0000</updated>
                            <resolved>Tue, 11 Sep 2012 09:03:56 +0000</resolved>
                                        <fixVersion>1.2.0 beta 1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="13402002" author="slebresne" created="Wed, 27 Jun 2012 07:00:03 +0000"  >&lt;p&gt;What happens is that columns metadata for composite CQL3 columns refers to only one of the component of the column name. So internally they have a &apos;componentIndex&apos; parameter which allow to handle them correctly (otherwise you don&apos;t know which comparator to use to display those column metadata). However, we decided that thrift users shouldn&apos;t have to care about this, so we don&apos;t expose those metadata to thrift at all. In other words, the CF does have metadata for &apos;sum&apos; and &apos;uniques&apos; internally, but they are not exposed to thrift.&lt;/p&gt;

&lt;p&gt;So I guess it is more of a cqlsh problem that shouldn&apos;t use the thrift describe call for CQL3. Instead, it should directly query the system.keyspace, system.columnfamilies and system.columns table. However, it&apos;d be much more easier to do that with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4018&quot; title=&quot;Add column metadata to system columnfamilies&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4018&quot;&gt;&lt;del&gt;CASSANDRA-4018&lt;/del&gt;&lt;/a&gt;, but that is not in 1.1.&lt;/p&gt;</comment>
                            <comment id="13402266" author="nickmbailey" created="Wed, 27 Jun 2012 14:45:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;So I guess it is more of a cqlsh problem that shouldn&apos;t use the thrift describe call for CQL3.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The main problem here from my perspective is that it was impossible to insert data into the column family except with cqlsh. Using a basic thrift batch mutate failed on the validation step because it tried to validate the value in the sum column as text (default_validation_class).&lt;/p&gt;</comment>
                            <comment id="13402590" author="hubaghdadi" created="Wed, 27 Jun 2012 22:01:56 +0000"  >&lt;p&gt;True, I&apos;m unable to save any data to Cassandra.&lt;br/&gt;
Trying to save with Hector (uses Mutators):&lt;br/&gt;
#&amp;lt;HInvalidRequestException me.prettyprint.hector.api.exceptions.HInvalidRequestException: InvalidRequestException(why:(String didn&apos;t validate.) &lt;span class=&quot;error&quot;&gt;&amp;#91;mks&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;stats&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1234:7461726765742d3131:sum&amp;#93;&lt;/span&gt; failed validation)&amp;gt;&lt;/p&gt;</comment>
                            <comment id="13403036" author="slebresne" created="Thu, 28 Jun 2012 11:51:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;it was impossible to insert data into the column family except with cqlsh. Using a basic thrift batch mutate failed on the validation step because it tried to validate the value&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Alright, that part is not expected and is likely a bug.&lt;/p&gt;

&lt;p&gt;Though I note that even if we fix that, since we don&apos;t expose on the thrift side everything needed to interpret the value correctly, thrift client won&apos;t be able to work with those kind of table very well. In particular they won&apos;t know how to interpret the value of a get. So I guess we need to either say clearly that CQL3 table are not meant to be accessed from thrift, or we should probably start exposing all the column metatada on the thrift side (but we need to expose the componentIndex part of the metadata in particular and the discussion on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4093&quot; title=&quot;schema_* CFs do not respect column comparator which leads to CLI commands failure.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4093&quot;&gt;&lt;del&gt;CASSANDRA-4093&lt;/del&gt;&lt;/a&gt; is relevant for that).&lt;/p&gt;</comment>
                            <comment id="13410446" author="slebresne" created="Tue, 10 Jul 2012 15:40:00 +0000"  >&lt;p&gt;Attaching simple patch to allow the insertion in the case above. Truth is, I&apos;m not really satisfied (though I don&apos;t have a clearly better option) by such a patch for 2 reasons:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;it will break the case for thrift where people were using compositeType and column_metadata on them. That might be 0 people we&apos;re talking about but it&apos;s still a bit annoying. An alternative here would be that for each composite column, we iterater over all column_metadata and check where one apply. This would work but this feels butt ugly.&lt;/li&gt;
	&lt;li&gt;it feels to me we supporting either not enough or too much in the thrift side. Even if we support this, we still don&apos;t expose the CQL3 metadata to thrift, so one has to know the CQL schema definition to be able to create the column in the first place (or deserialize it on read). In particular, most advanced thrift client will likely still break at one point or another.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Overall I see two reasonable approaches:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Either we start exposing enough on the thirft side so that thrift client can work correctly with CQL3. While this may be doable reasonably easily now, this will be increasingly difficult with things like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4179&quot; title=&quot;Add more general support for composites (to row key, column value)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4179&quot;&gt;&lt;del&gt;CASSANDRA-4179&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3647&quot; title=&quot;Support collection (list, set, and map) value types in CQL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3647&quot;&gt;&lt;del&gt;CASSANDRA-3647&lt;/del&gt;&lt;/a&gt;, ... Besides, even if we make it possible to work with CQL3 table, it doesn&apos;t mean it will be convenient since thrift won&apos;t do the grouping of columns in sparse table.&lt;/li&gt;
	&lt;li&gt;Be clear that you cannot work with CQL3 created table from thrift.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;But imo the in-the-middle approach that this patch would start takes the risk of polluting the thrift side without adding much.&lt;/p&gt;</comment>
                            <comment id="13410456" author="slebresne" created="Tue, 10 Jul 2012 15:48:32 +0000"  >&lt;p&gt;To be clear, if this issue is for instance a blocker for map-reduce for CQL3, I&apos;m not against committing it, but on a more long term/general level, I do want to note that accessing CQL3 tables to thrift is imho a larger problem and we should be clear on what we want to guarantee.&lt;/p&gt;</comment>
                            <comment id="13410495" author="nickmbailey" created="Tue, 10 Jul 2012 16:32:29 +0000"  >&lt;p&gt;It doesn&apos;t sound like its going to be possible to make things work well in the case of accessing cql3 data from thrift.&lt;/p&gt;

&lt;p&gt;If thats the case I&apos;m in favor of making that incompatibility &lt;b&gt;very&lt;/b&gt; explicit. I would say explicitly throwing an exception when trying to access a cql3 column family from thrift would be an acceptable solution.&lt;/p&gt;

&lt;p&gt;The fact that it took me quite a bit of time as well as digging around in both client code and cassandra source code to figure this bug out makes me worried for other users hitting similar problems.&lt;/p&gt;</comment>
                            <comment id="13410554" author="thepaul" created="Tue, 10 Jul 2012 17:11:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;I would say explicitly throwing an exception when trying to access a cql3 column family from thrift would be an acceptable solution.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;-1 on that; it&apos;s very useful to have a lower-level access method to look at the &quot;storage engine&quot; layer instead of the logical CQL3 rows at times.&lt;/p&gt;</comment>
                            <comment id="13410558" author="nickmbailey" created="Tue, 10 Jul 2012 17:14:51 +0000"  >&lt;p&gt;so disable write access to cql3 cfs from thrift? And leave read access with the qualification that everything will be returned as BytesType?&lt;/p&gt;

&lt;p&gt;The only other option I see is to say that we are going to identify and fix all bugs like this one.&lt;/p&gt;</comment>
                            <comment id="13410569" author="jbellis" created="Tue, 10 Jul 2012 17:22:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;disable write access to cql3 cfs from thrift? And leave read access with the qualification that everything will be returned as BytesType?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sounds reasonable to me.&lt;/p&gt;</comment>
                            <comment id="13410609" author="slebresne" created="Tue, 10 Jul 2012 17:44:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;disable write access to cql3 cfs from thrift? And leave read access with the qualification that everything will be returned as BytesType?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;A variation in the same spirit could be to disable access to CQL3 table by default but add a thrift debug mode (either per-connection through or globally through JMX if we don&apos;t want to add a new thrift method) that would make thrift disable every validation. That way, by default the message that CQL3 tables should be access through CQL3 would be clear but we would have low-level read/write for debugging.  &lt;/p&gt;</comment>
                            <comment id="13410614" author="thepaul" created="Tue, 10 Jul 2012 17:46:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;disable access to CQL3 table by default but add a thrift debug mode&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+lots.&lt;/p&gt;</comment>
                            <comment id="13410627" author="nickmbailey" created="Tue, 10 Jul 2012 17:53:15 +0000"  >&lt;p&gt;sgtm&lt;/p&gt;</comment>
                            <comment id="13410649" author="jbellis" created="Tue, 10 Jul 2012 18:15:42 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;(and I&apos;d prefer JMX otherwise I foresee clients using this as an escape hatch and fubarring things up.)&lt;/p&gt;</comment>
                            <comment id="13411014" author="thepaul" created="Tue, 10 Jul 2012 22:38:17 +0000"  >&lt;p&gt;So, from an outside conversation, it sounds like there may be some confusion on exactly what is being discussed here. Are we talking about disabling Thrift access entirely to columnfamilies which use named metadata with composites, or are we just talking about not supporting Thrift addressing columns inside composites by their CQL3 names?&lt;/p&gt;

&lt;p&gt;The second seems eminently reasonable. The former sounds crazy.&lt;/p&gt;</comment>
                            <comment id="13411298" author="slebresne" created="Wed, 11 Jul 2012 07:36:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;are we just talking about not supporting Thrift addressing columns inside composites by their CQL3 names&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That is not what I was talking about, but I don&apos;t even understand how we could ever support that.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;disabling Thrift access entirely to columnfamilies which use named metadata with composites&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That is what I&apos;m talking about (though to be precise, it would be for composites using named metadata &lt;b&gt;created through CQL3&lt;/b&gt;). Anyway, I don&apos;t know if that&apos;s so crazy but in any case calling it crazy doesn&apos;t help solving the problem.&lt;/p&gt;
</comment>
                            <comment id="13425376" author="nickmbailey" created="Mon, 30 Jul 2012 23:26:39 +0000"  >&lt;p&gt;So here is where I ended up on this.&lt;/p&gt;

&lt;p&gt;Assuming we aren&apos;t extremely interested in fixing bugs like these when the come up then I&apos;m all for disabling thrift access by default to cql3 cfs. From what I can tell there isn&apos;t an immediately easy way to know a cf was created through cql3 at the moment but we could add that I guess.&lt;/p&gt;

&lt;p&gt;On the other hand if we want to just go ahead and fix these bugs when they happen, I don&apos;t see much reason to go out of our way to disable thrift access to cql3 cfs.&lt;/p&gt;</comment>
                            <comment id="13431892" author="jbellis" created="Thu, 9 Aug 2012 15:17:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;one has to know the CQL schema definition to be able to create the column in the first place (or deserialize it on read)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Can you remind me why we don&apos;t translate &lt;tt&gt;PRIMARY KEY(gid, period, tid)&lt;/tt&gt; into a comparator of &lt;tt&gt;CompositeType(Int32Type, BytesType, UTF8Type)&lt;/tt&gt;?  (period -&amp;gt; int, tid -&amp;gt; bytes, sparse columns -&amp;gt; utf8)&lt;/p&gt;</comment>
                            <comment id="13431911" author="slebresne" created="Thu, 9 Aug 2012 15:41:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can you remind me why we don&apos;t translate PRIMARY KEY(gid, period, tid) into a comparator of CompositeType(Int32Type, BytesType, UTF8Type)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We do. The problem is actually with columns that are not part of the key. Let me try to sum that up:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Pre-CQL3, the ColumnDefinition name was always a full column name.&lt;/li&gt;
	&lt;li&gt;In CQL3, the ColumnDefinition name only correspond to one of the component of the column name, i.e. to the UTF8Type component above.&lt;/li&gt;
	&lt;li&gt;To be able to distinguish both case internally, we&apos;ve introduce the componentIndex field in ColumnDefinition. However, we decided that we didn&apos;t wanted to expose this field to thrift, and so we don&apos;t expose to thrift the ColumnDefinition from CQL3 table.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The net result is that as far as thrift is concerned, the CQL3 tables have no columns_metadata whatsoever. It follows that thrift clients don&apos;t know what are the correct value for the last UTF8Type component, and don&apos;t know what is the type of the corresponding value (and thus cannot serialize/deserialize said value correctly). &lt;/p&gt;</comment>
                            <comment id="13431924" author="jbellis" created="Thu, 9 Aug 2012 15:53:30 +0000"  >&lt;p&gt;So basically, the problem is we&apos;re trying to maintain compatibility with (non-cql3) wide-row named columns?   If we&apos;re willing to break that scenario, does the problem go away?&lt;/p&gt;

&lt;p&gt;I still think that naming wide row columns is nonsensical, but we could add an extra layer of protection by warning on startup in 1.2 that you need to update your schema:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if you have named columns and non-utf8-or-bytes comparator&lt;/li&gt;
	&lt;li&gt;if you have named columns but metadata shows more columns than names&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13431965" author="slebresne" created="Thu, 9 Aug 2012 16:41:37 +0000"  >&lt;p&gt;I&apos;m not sure I understand what&apos;s a named columns above to be honest.&lt;/p&gt;

&lt;p&gt;There is basically two informations from CFMetadata you need to know to insert a column correctly in a table (CQL3 or no CQL3): the comparator and &lt;b&gt;all&lt;/b&gt; of column_metadata. The comparator is necessary to know what is a valid column name and the column_metadata is necessary to know what is a valid column value (I&apos;m simplifying a bit, I&apos;m assuming that the key_validation and default_validator are BytesType but that doesn&apos;t matter for the problem at hand).&lt;/p&gt;

&lt;p&gt;Now the problem is that for any table created through CQL3 that doesn&apos;t use COMPACT STORAGE (let&apos;s call those CQL3 tables), all the ColumnDefinition of column_metada will have a componentIndex. So none of those ColumnDefinition are exposed in thrift. In practice it means that if I do:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE user {
    user_id blob PRIMARY KEY,
    name text,
    age int
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;then if a thrift client do a describe, it will basically get:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;comparator = CompositeType(UTF8Type) // it&apos;s a composite so that we can add collection later on
column_metadata = []
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At that point we have two slightly separate problems:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Even if a user produces a valid column, with say a composite name being &quot;age&quot; and a value being an int, then currently the code throw an exception. Fixing that exception is the goal of the attached patch (though it would have to be updated to work with collections in 1.2). I&apos;m fine fixing that, though I&apos;m pointing that there is a second, more general problem.&lt;/li&gt;
	&lt;li&gt;Since the thrift client doesn&apos;t know about the actual column_metadata, how can we expect it to correctly insert data. In particular I&apos;m pretty sure higher level clients like pycassa or astyanax will serialize data incorrectly if they don&apos;t know the right value validator. Besides, there is many way to be confused if you use a CQL3 table from thrift. For instance if you create the wrong column (i&apos;ts enough to mess up the case), you&apos;ll be surprised to not be able to access it when you go back to CQL3. So be clear, I do am suggesting that we don&apos;t allow accessing table created from CQL3 &lt;b&gt;without&lt;/b&gt; COMPACT STORAGE from thrift, because I think it will be more sane, even if it does mean that you&apos;re not coming back from CQL3 once you&apos;ve start really using it.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13431980" author="jbellis" created="Thu, 9 Aug 2012 17:07:04 +0000"  >&lt;p&gt;Right, so what I was saying was, if we&apos;re willing to say that columndefinition name is always the cql3 column name, then we don&apos;t need componentIndex, at the price of potentially breaking a corner case in non-cql3 schemas.&lt;/p&gt;</comment>
                            <comment id="13432011" author="slebresne" created="Thu, 9 Aug 2012 17:33:09 +0000"  >&lt;p&gt;But what the componentIndex give us is which of the composite component is the cql3 column name. Typically, with collections, it&apos;s not even necessarily the last of the component. Now, if you know the table is a CQL3 one, you could try to infer which component it is by saying that it&apos;s the last component, except if the last is a collection type, in which case that&apos;s the previous one, but that feels a bit messy. And besides, thrift client libraries don&apos;t have a simple automatic way to know if the table is a CQL3 one in the first place. I guess you could say that if you have a composite comparator &lt;b&gt;and&lt;/b&gt; some column_metadata then you are likely a CQL3 table, but again, not very clean imo.&lt;/p&gt;


&lt;p&gt;At least internally I would be in favor of keeping the componentIndex as it is cleaner. I guess we could start returning the ColumnDefinition from CQL3 table without the componentIndex and let thrift client infer what they can. As said, I still think using CQL3 table from thrift has other way to be confusing, but why not.&lt;/p&gt;</comment>
                            <comment id="13436817" author="jbellis" created="Fri, 17 Aug 2012 16:00:05 +0000"  >&lt;p&gt;Here&apos;s what I think our goals are, in order of importance:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;Existing &quot;high level&quot; clients should have a reasonable upgrade path to read and update collections and cql3 CFs.&lt;/li&gt;
	&lt;li&gt;CLI and other tools that don&apos;t speak cql should have a way to tell that they can&apos;t cope with CQL3 CF definitions.  This is the problem Nick described originally in this ticket description.  Actually making such tools able to manipulate CQL3 definitions is NOT a goal, but we should, as Nick says, make that more obvious.&lt;/li&gt;
	&lt;li&gt;We should allow updates to CQL3 CFs from Thrift, if someone manually composes the correct CompositeType bytes.  This is what most of the rest of the discussion here involves.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Analysis:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;This we have done--they will have to use cql-over-thrift, but IMO this is reasonable.  Thrift RPC methods to deal with collections have never been on the roadmap.&lt;/li&gt;
	&lt;li&gt;This is tough since if this involves new information (like exposing component_index, or even adding a cql3 boolean to CfDef) then old tools by definition won&apos;t know about it.  &lt;b&gt;Proposal:&lt;/b&gt; what if we omit CQL3 CfDefs from those we return to describe_keyspace&lt;span class=&quot;error&quot;&gt;&amp;#91;s&amp;#93;&lt;/span&gt; calls?  Not quite as good as returning a CfDef that explicitly says &quot;I am here but you can&apos;t touch this,&quot; but compare to displaying incomplete information (that the cli doesn&apos;t know is incomplete) it&apos;s much more obvious that the cli and other old thrift-base schema manipulators can&apos;t cope with such.&lt;/li&gt;
	&lt;li&gt;Sylvain mentioned adding a thrift or JMX method to enable validation-free updates but I&apos;d rather make ThriftValidation cql3-aware, which would let this work without any special flags.  I don&apos;t see any downside to this except added complexity for ThriftValidation.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13436822" author="jbellis" created="Fri, 17 Aug 2012 16:11:50 +0000"  >&lt;p&gt;I do think we should push this to 1.2 however, since I&apos;m leery of changing the behavior or describe_keyspace&lt;span class=&quot;error&quot;&gt;&amp;#91;s&amp;#93;&lt;/span&gt; when we are fairly deep into 1.1&apos;s stable lifetime.&lt;/p&gt;</comment>
                            <comment id="13439382" author="xedin" created="Wed, 22 Aug 2012 09:50:59 +0000"  >&lt;p&gt;CQL3 defined CFs won&apos;t be exposed to Thrift API anymore (with warning), I also checked CassandraServer and ThriftValidation and figured that column name validation already in place via ThriftValidation.validateColumnNames(...).&lt;/p&gt;</comment>
                            <comment id="13446048" author="nickmbailey" created="Fri, 31 Aug 2012 15:25:26 +0000"  >&lt;p&gt;Just glanced at the patch, but it looks like this just makes cql3 cfs not show up in describe_keyspaces calls right? Reading/writing to the cf would still go through and error?&lt;/p&gt;

&lt;p&gt;If I&apos;m looking at that right then it seems like we would want the opposite behavior. At least from my perspective, I would like to have an indication that the cf exists in my client even if i can&apos;t write to it.&lt;/p&gt;</comment>
                            <comment id="13446499" author="jbellis" created="Fri, 31 Aug 2012 23:43:17 +0000"  >&lt;p&gt;The idea was to do two things:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;update ThriftValidation to be cql3-aware, so if a Thrift user manually composes a valid column, we accept it&lt;/li&gt;
	&lt;li&gt;but, we don&apos;t expose cql3 CFs via describe_keyspaces since clients do not have enough information to generate valid requests automatically&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13447177" author="slebresne" created="Mon, 3 Sep 2012 09:21:07 +0000"  >&lt;p&gt;I agree that the two points above (make ThriftValidation cql3-aware but don&apos;t expose cql3 CFs defs) make sense as a strategy.&lt;/p&gt;</comment>
                            <comment id="13449571" author="slebresne" created="Thu, 6 Sep 2012 11:16:31 +0000"  >&lt;p&gt;On Pavel&apos;s patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I&apos;m not a fan of logging a warning (or to log anything really) if someone has CQL3 CFs. We&apos;re trying to push CQL3 as a good thing, let&apos;s not log anything that could be interpreted as if something was wrong/abnormal.&lt;/li&gt;
	&lt;li&gt;The check is excluding composite CF without any ColumnDefinition while it shouldn&apos;t.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Attaching a v2 that:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Fix the two remarks above.&lt;/li&gt;
	&lt;li&gt;Rename the check as isThriftIncompatible. I think it&apos;s more about detecting CF definitions that cannot be exploided fully by thrift rather than discriminate between what is a thrift CF and CQL3 CF. Especially since the intersection between those two notions is not empty.&lt;/li&gt;
	&lt;li&gt;Ship the changes to ThriftValidation from my first patch, though modified a bit to be more generic and handle correctly collections. I&apos;ll note that this part makes validation potentially iterate over all ColumnDefinition for composite CF, but that&apos;s not really an issue since composite CF created on the thrift side are almost guaranteed to have no ColumnDefinition.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13449582" author="xedin" created="Thu, 6 Sep 2012 11:42:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not a fan of logging a warning (or to log anything really) if someone has CQL3 CFs. We&apos;re trying to push CQL3 as a good thing, let&apos;s not log anything that could be interpreted as if something was wrong/abnormal.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Wouldn&apos;t that create confusion when some CFs are visible through Thrift and some are not or do we rely on that users should know what is so special about CQL3 CFs?&lt;/p&gt;</comment>
                            <comment id="13449586" author="slebresne" created="Thu, 6 Sep 2012 11:52:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;Wouldn&apos;t that create confusion when some CFs are visible through Thrift and some are not&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not saying this shouldn&apos;t be documented at all, but merely that it&apos;s a documentation issue and as such logging it at each startup is not the right place. &lt;/p&gt;</comment>
                            <comment id="13449588" author="xedin" created="Thu, 6 Sep 2012 11:57:21 +0000"  >&lt;p&gt;If everyone else is ok with that, lgtm.&lt;/p&gt;</comment>
                            <comment id="13452664" author="jbellis" created="Tue, 11 Sep 2012 02:36:59 +0000"  >&lt;p&gt;So, this is good to commit?&lt;/p&gt;</comment>
                            <comment id="13452831" author="slebresne" created="Tue, 11 Sep 2012 09:03:56 +0000"  >&lt;p&gt;Alright, committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12614680">CASSANDRA-4907</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12544028" name="4377-2.txt" size="5331" author="slebresne" created="Thu, 6 Sep 2012 11:16:31 +0000"/>
                            <attachment id="12535860" name="4377.txt" size="2265" author="slebresne" created="Tue, 10 Jul 2012 15:40:00 +0000"/>
                            <attachment id="12541883" name="CASSANDRA-4377.patch" size="4715" author="xedin" created="Wed, 22 Aug 2012 09:50:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[xedin]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>255103</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 11 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ep2n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>83824</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>