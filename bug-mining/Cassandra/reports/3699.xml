<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:55:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9382] Snapshot file descriptors not getting purged (possible fd leak)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9382</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;OpsCenter has the repair service which does a lot of small range repairs. Each repair would generate a snapshot as per normal. The cluster was showing a steady increase in disk space over the course of a couple of days and the only way to workaround the issue was to restart the node.&lt;/p&gt;

&lt;p&gt;Upon some further inspection it was seen that a lsof output of the cassandra process was still showing file descriptors for snapshots that no longer existed on the file system. For example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ava    5822 cassandra  DEL    REG             202,32                 7359833 /media/ephemeral1/cassandra/data/somekeyspace/table1/snapshots/669a3a30-f3d3-11e4-bec6-3f6c4fb06498/somekeyspace-table1-jb-897689-Data.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We also took a heapdump which basically showed the same thing, lots of references to these file handles. We checked the logs for any errors especially relating to repairs that might have failed but there was nothing observed&lt;/p&gt;

&lt;p&gt;The repair service logs in OpsCenter showed also that all repairs (1000s of them) had completed successfully, again showing that there was no repair issue.&lt;/p&gt;

&lt;p&gt;I have not yet been able to reproduce the issue locally on a test box. The cluster that this original issue appeared on was a production cluster with the following spec:&lt;/p&gt;

&lt;p&gt;cassandra_versions: 2.0.14.352&lt;br/&gt;
cluster_cores : 8, &lt;br/&gt;
cluster_instance_types : i2.2xlarge&lt;br/&gt;
cluster_os : Amazon linux amd64 &lt;br/&gt;
node count: 4&lt;br/&gt;
node java version: Oracle Java 1.7.0_51&lt;/p&gt;</description>
                <environment></environment>
        <key id="12829851">CASSANDRA-9382</key>
            <summary>Snapshot file descriptors not getting purged (possible fd leak)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="Mark Curtis">Mark Curtis</reporter>
                        <labels>
                    </labels>
                <created>Thu, 14 May 2015 13:30:31 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:11 +0000</updated>
                            <resolved>Tue, 28 Jul 2015 23:57:35 +0000</resolved>
                                        <fixVersion>2.0.17</fixVersion>
                    <fixVersion>2.1.9</fixVersion>
                    <fixVersion>2.2.1</fixVersion>
                    <fixVersion>3.0 alpha 1</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="14620234" author="zariel" created="Thu, 9 Jul 2015 10:06:28 +0000"  >&lt;p&gt;I have observed what could be the same issue, repair jobs have been randomly failing with could not create snapshot and no other issues, then we ran out of disk space on the node, restarting cassandra freed lots of a disk space so it looks like something is causing the references to the FD to be held onto by the process. This is Cassandra 2.0.13. I have a heap dump and the lsof of the machine at the time, &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;grep DEL openfiles | wc -l
34376
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which are mostly&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/mnt/cassandra/data/keyspace/table/snapshots/90566a10-fd79-11e4-a65b-bdf89f99ad2d/keyspace-table-jb-205530-Index.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14621289" author="yukim" created="Thu, 9 Jul 2015 21:22:43 +0000"  >&lt;p&gt;I had a chance to look at the heap dump from the original issue, and found that the leak is coming from SSTable&apos;s &lt;tt&gt;readMeter&lt;/tt&gt; sync task.&lt;/p&gt;

&lt;p&gt;Edit: turns out the following was wrong.&lt;/p&gt;

&lt;p&gt;&lt;del&gt;When SSTable is getting closed, &lt;tt&gt;readMeter&lt;/tt&gt; sync task is cancelled, but it is only cancelled if it&apos;s not running. Since task is scheduled to run every 5 min, that task is scheduled again holding reference to deleted SSTable.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;This is only affected in versions before 2.1.5, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8707&quot; title=&quot;Move SegmentedFile, IndexSummary and BloomFilter to utilising RefCounted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8707&quot;&gt;&lt;del&gt;CASSANDRA-8707&lt;/del&gt;&lt;/a&gt; changed to call &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.1.5/src/java/org/apache/cassandra/io/sstable/SSTableReader.java#L2270&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;cancel&lt;/tt&gt; with interruption when the task is running&lt;/a&gt;.&lt;/del&gt;&lt;/p&gt;</comment>
                            <comment id="14621346" author="yukim" created="Thu, 9 Jul 2015 21:48:51 +0000"  >&lt;p&gt;My previous comment was a bit wrong.&lt;br/&gt;
&lt;tt&gt;readMeter&lt;/tt&gt; sync tasks can be blocked on &lt;tt&gt;syncExecutor&lt;/tt&gt; that executes task in single thread, when rate limiter throttles their execution.&lt;br/&gt;
&lt;tt&gt;readMeterSyncFuture.cancel&lt;/tt&gt; does not remove task itself from the queue imeediately unless &lt;tt&gt;ScheduledThreadPoolExecutor&lt;/tt&gt;&apos;s &lt;tt&gt;RemoveOnCancelPolicy&lt;/tt&gt; is &lt;tt&gt;true&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Patch to turn it on: &lt;a href=&quot;https://github.com/yukim/cassandra/tree/9382&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yukim/cassandra/tree/9382&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This affects 2.1+ versions as well.&lt;/p&gt;</comment>
                            <comment id="14621568" author="yukim" created="Fri, 10 Jul 2015 01:27:03 +0000"  >&lt;p&gt;Thinking about this again, I think we should skip using readMeter when opening from snapshot for validation.&lt;br/&gt;
Let me work a little bit more on that.&lt;/p&gt;</comment>
                            <comment id="14622698" author="yukim" created="Fri, 10 Jul 2015 18:16:47 +0000"  >&lt;p&gt;Pushed the second patch not to track hotness when opening from snapshot for validation.&lt;br/&gt;
Ready for review.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/yukim/cassandra/tree/9382&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yukim/cassandra/tree/9382&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;testall: &lt;a href=&quot;http://cassci.datastax.com/job/yukim-9382-testall/2/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/yukim-9382-testall/2/&lt;/a&gt;&lt;br/&gt;
dtest: &lt;a href=&quot;http://cassci.datastax.com/job/yukim-9382-dtest/4/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/job/yukim-9382-dtest/4/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;look good.&lt;/p&gt;</comment>
                            <comment id="14631559" author="wadey" created="Fri, 17 Jul 2015 16:41:39 +0000"  >&lt;p&gt;I just wanted to add that we ran into this issue with our 2.0.16 cluster. We were running range based repairs after a few nodes were down and after a little bit of time had accumulated 75GB of these left open files. We had to restart the cassandra node to recover this leaked disk space.&lt;/p&gt;

&lt;p&gt;I looked at Yuki&apos;s patch (thanks Yuki!) and it seems to make sense but I don&apos;t know enough about how this part of Cassandra works to weigh in. Just wanted to note that this is an issue that people run into in the wild.&lt;/p&gt;</comment>
                            <comment id="14644592" author="benedict" created="Tue, 28 Jul 2015 16:15:20 +0000"  >&lt;p&gt;+1.&lt;/p&gt;

&lt;p&gt;This bug shouldn&apos;t affect 2.1+, however there&apos;s no reason to track hotness anyway, even if it closes the resources safely.&lt;/p&gt;</comment>
                            <comment id="14645246" author="yukim" created="Tue, 28 Jul 2015 23:57:35 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12744574" name="yjp-heapdump.png" size="44906" author="yukim" created="Thu, 9 Jul 2015 21:22:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 16 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2eq9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329670">2.0.14</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>