<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:21:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16758] Flaky ClientResourceLimitsTest</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16758</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Flaky &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-4.0.0/35/testReport/junit/org.apache.cassandra.transport/ClientResourceLimitsTest/testBackPressureWhenEndpointLimitExceeded_cdc/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ClientResourceLimitsTest&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Error Message

Timed out after waiting 5 seconds for paused connections metric to increment due to backpressure expected:&amp;lt;11&amp;gt; but was:&amp;lt;24&amp;gt;

Stacktrace

junit.framework.AssertionFailedError: Timed out after waiting 5 seconds for paused connections metric to increment due to backpressure expected:&amp;lt;11&amp;gt; but was:&amp;lt;24&amp;gt;
	at org.apache.cassandra.Util.spinAssertEquals(Util.java:610)
	at org.apache.cassandra.transport.ClientResourceLimitsTest.backPressureTest(ClientResourceLimitsTest.java:218)
	at org.apache.cassandra.transport.ClientResourceLimitsTest.testBackPressureWhenEndpointLimitExceeded(ClientResourceLimitsTest.java:179)

Standard Output

INFO  [main] 2021-06-22 01:56:41,489 YamlConfigurationLoader.java:93 - Configuration location: file:////home/cassandra/cassandra/build/test/cassandra.cdc.yaml
DEBUG [main] 2021-06-22 01:56:41,491 YamlConfigurationLoader.java:112 - Loading settings from file:////home/cassandra/cassandra/build/test/cassandra.cdc.yaml
DEBUG [main] 2021-06-22 01:56:41,551 InternalLoggerFactory.java:63 - Using SLF4J as the default logging framework
DEBUG [main] 2021-06-22 01:56:41,565 PlatformDependent0.java:417 - -D
...[truncated 765272 chars]...
 org.apache.cassandra.transport.SimpleClient.execute(SimpleClient.java:275)
	at org.apache.cassandra.transport.ClientResourceLimitsTest.lambda$testQueryUpdatesConcurrentMetricsUpdate$11(ClientResourceLimitsTest.java:352)
	at java.lang.Thread.run(Thread.java:748)
DEBUG [Test Cluster-nio-worker-0] 2021-06-22 01:57:08,353 Slf4JLogger.java:81 - Freed 24 thread-local buffer(s) from thread: Test Cluster-nio-worker-0
INFO  [main] 2021-06-22 01:57:08,364 Server.java:171 - Stop listening for CQL clients
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13385348">CASSANDRA-16758</key>
            <summary>Flaky ClientResourceLimitsTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bereng">Berenguer Blasi</assignee>
                                    <reporter username="bereng">Berenguer Blasi</reporter>
                        <labels>
                    </labels>
                <created>Wed, 23 Jun 2021 08:08:29 +0000</created>
                <updated>Wed, 30 Jun 2021 19:41:18 +0000</updated>
                            <resolved>Wed, 30 Jun 2021 11:32:50 +0000</resolved>
                                        <fixVersion>4.0</fixVersion>
                    <fixVersion>4.0.0</fixVersion>
                                    <component>Test/unit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17368013" author="bereng" created="Wed, 23 Jun 2021 10:12:39 +0000"  >&lt;p&gt;Queries in the background can alter stats. It&apos;s easy to repro locally by adding a sleep just after starting the thread &lt;a href=&quot;https://github.com/apache/cassandra/pull/1082/files#diff-c801dfb00bc39ce5bf66a5876779350dba35def185588d13f5e492b6d79212f7R214&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Also printing out the values in the spin assert loop makes that very obvious and visible. Waiting for background cleaning tasks of &lt;tt&gt;CQLTtester&lt;/tt&gt; is not enough. The equality assert can&apos;t be guaranteed but a GTE can.&lt;/p&gt;

&lt;p&gt;Passes 1K runs whereas it used to fail.&lt;/p&gt;</comment>
                            <comment id="17368318" author="maedhroz" created="Wed, 23 Jun 2021 16:07:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;bereng&lt;/a&gt; I noticed this while working on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16663&quot; title=&quot;Request-Based Native Transport Rate-Limiting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16663&quot;&gt;&lt;del&gt;CASSANDRA-16663&lt;/del&gt;&lt;/a&gt;, and I think I fixed it there, although in a &lt;a href=&quot;https://github.com/apache/cassandra/pull/1045/files#diff-c801dfb00bc39ce5bf66a5876779350dba35def185588d13f5e492b6d79212f7R77&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;slightly different&lt;/a&gt; way. Basically, the background queries are from the driver control connections, which we don&apos;t actually use for &lt;tt&gt;ClientResourceLimitsTest&lt;/tt&gt;. My patch for 16663 is obviously only for trunk, but you could use it here, and then I could just rebase my stuff and pick it up when this issue resolves. I think we can avoid relaxing the assertion to GTE...&lt;/p&gt;</comment>
                            <comment id="17368372" author="adelapena" created="Wed, 23 Jun 2021 17:29:06 +0000"  >&lt;p&gt;Indeed getting rid of the driver&apos;s interferences without relaxing the assertion sounds like the way to go. Also it seems to fix the occasional failures in other tests in &lt;tt&gt;ClientResourceLimitsTest&lt;/tt&gt;, like &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/612/workflows/09dec5a9-2ac4-4595-b455-fce14aa381cf/jobs/6010&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;these ones&lt;/a&gt;. Unfortunately&#160;&lt;tt&gt;testQueryUpdatesConcurrentMetricsUpdate&lt;/tt&gt; seems &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/613/workflows/693bbc01-eae8-4f56-8298-2811d72892d2/jobs/6015&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;flaky&lt;/a&gt; with both approaches, but we can deal with that in a separate ticket if we think that it&apos;s not related.&lt;/p&gt;</comment>
                            <comment id="17369694" author="adelapena" created="Fri, 25 Jun 2021 20:11:00 +0000"  >&lt;p&gt;Using the &lt;tt&gt;requireNetworkWithoutDriver&lt;/tt&gt; method suggested in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16663&quot; title=&quot;Request-Based Native Transport Rate-Limiting&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16663&quot;&gt;&lt;del&gt;CASSANDRA-16663&lt;/del&gt;&lt;/a&gt; in 4.0.0 definitely solves all the failures but the one in &lt;tt&gt;testQueryUpdatesConcurrentMetricsUpdate&lt;/tt&gt;, as it can be seen in &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/614/workflows/974352fc-a2d7-453e-ae07-002280b9910e/jobs/6020&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this multiplexer run&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Regarding the failure in &lt;tt&gt;testQueryUpdatesConcurrentMetricsUpdate&lt;/tt&gt;, I think that the creation of the startup message of&#160;&lt;tt&gt;SimpleClient&lt;/tt&gt; is messing with the metrics. We can simply use &lt;tt&gt;spinAssertEquals&lt;/tt&gt;/&lt;tt&gt;Awaitility&lt;/tt&gt; to wait until the moment the startup message finishes and the client metric goes back to zero, as it&apos;s done &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/c0caca66eae1dd388a15cf415ffc25fc37190d2d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this way&lt;/a&gt;. With that change the test survives &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/623/workflows/b69efc53-0e20-4466-a90a-78f162dde54b/jobs/6097&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5000 runs&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17370474" author="bereng" created="Mon, 28 Jun 2021 07:49:39 +0000"  >&lt;p&gt;I agree with you both filtering out driver noise is a superior solution. Also if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; managed to get 5K runs for the other failure lurking here then I say +1 to everything after reviewing it and let &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; commit it. There&apos;s no point in me duplicating the effort of building the same PR etc. &lt;/p&gt;</comment>
                            <comment id="17370737" author="maedhroz" created="Mon, 28 Jun 2021 17:16:37 +0000"  >&lt;p&gt;+1 on the &lt;a href=&quot;https://github.com/adelapena/cassandra/compare/16758-4.0.0-review-caleb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;16758-4.0.0-review-caleb&lt;/a&gt; branch&lt;/p&gt;</comment>
                            <comment id="17371023" author="bereng" created="Tue, 29 Jun 2021 03:41:08 +0000"  >&lt;p&gt;Andres is OOO but back tomorrow so I&apos;d rather wait for him to be around than hijack his PR in case he had some outstanding work we&apos;re not aware of.&lt;/p&gt;</comment>
                            <comment id="17371929" author="bereng" created="Wed, 30 Jun 2021 09:49:13 +0000"  >&lt;p&gt;Good the concurrent update &lt;a href=&quot;http://https://ci-cassandra.apache.org/job/Cassandra-4.0.0-test-compression/37/jdk=jdk_11_latest,label=cassandra,split=7/testReport/junit/org.apache.cassandra.transport/ClientResourceLimitsTest/testQueryUpdatesConcurrentMetricsUpdate_compression/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;failed&lt;/a&gt; today but this should fix it. 2 birds with one stone.&lt;/p&gt;</comment>
                            <comment id="17371938" author="adelapena" created="Wed, 30 Jun 2021 10:22:17 +0000"  >&lt;p&gt;It&apos;s good to know that we have a real Jenkins failure for the last fix&#160;&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I don&apos;t have any outstanding work besides some trivial warning fixes. The final patch is &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/506ebff98860a25f76d936a1a1b67b5509189cd4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, I&apos;m running the multiplexer &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/624/workflows/3b758554-0e14-41e7-847b-01da79daf27f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;one last time&lt;/a&gt; just in case before committing.&lt;/p&gt;</comment>
                            <comment id="17371942" author="bereng" created="Wed, 30 Jun 2021 10:36:55 +0000"  >&lt;p&gt;sgtm +1&lt;/p&gt;</comment>
                            <comment id="17371952" author="adelapena" created="Wed, 30 Jun 2021 11:30:11 +0000"  >&lt;p&gt;Committed to 4.0.0 as &lt;a href=&quot;https://github.com/apache/cassandra/commit/636e8b99226703d643cc4b30e5c30a64ce830434&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;636e8b99226703d643cc4b30e5c30a64ce830434&lt;/a&gt; and merged up to &lt;a href=&quot;https://github.com/apache/cassandra/commit/07803c8cd22d6918ef9bdbb6653cb90f45291ed9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/commit/700c290350c86444c81e3ab3fa4c7988050ac82f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17372045" author="bereng" created="Wed, 30 Jun 2021 14:48:01 +0000"  >&lt;p&gt;Thx &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13377694">CASSANDRA-16663</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
        <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
        <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0s7o8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
        <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
        <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12349335">4.0-beta4</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/636e8b99226703d643cc4b30e5c30a64ce830434&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/636e8b99226703d643cc4b30e5c30a64ce830434&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;See PR&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>