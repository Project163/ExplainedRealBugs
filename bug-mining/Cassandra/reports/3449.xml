<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8979] MerkleTree mismatch for deleted and non-existing rows</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8979</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Validation compaction will currently create different hashes for rows that have been deleted compared to nodes that have not seen the rows at all or have already compacted them away. &lt;/p&gt;

&lt;p&gt;In case this sounds familiar to you, see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4905&quot; title=&quot;Repair should exclude gcable tombstones from merkle-tree computation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4905&quot;&gt;&lt;del&gt;CASSANDRA-4905&lt;/del&gt;&lt;/a&gt; which was supposed to prevent hashing of expired tombstones. This still seems to be in place, but does not address the issue completely. Or there was a change in 2.0 that rendered the patch ineffective. &lt;/p&gt;

&lt;p&gt;The problem is that rowHash() in the Validator will return a new hash in any case, whether the PrecompactedRow did actually update the digest or not. This will lead to the case that a purged, PrecompactedRow will not change the digest, but we end up with a different tree compared to not having rowHash called at all (such as in case the row already doesn&apos;t exist).&lt;/p&gt;

&lt;p&gt;As an implication, repair jobs will constantly detect mismatches between older sstables containing purgable rows and nodes that have already compacted these rows. After transfering the reported ranges, the newly created sstables will immediately get deleted again during the following compaction. This will happen for each repair run over again until the sstable with the purgable row finally gets compacted. &lt;/p&gt;</description>
                <environment></environment>
        <key id="12782603">CASSANDRA-8979</key>
            <summary>MerkleTree mismatch for deleted and non-existing rows</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="spod">Stefan Podkowinski</assignee>
                                    <reporter username="spod">Stefan Podkowinski</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Mar 2015 16:17:25 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:17 +0000</updated>
                            <resolved>Fri, 3 Apr 2015 14:29:49 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14367434" author="yukim" created="Wed, 18 Mar 2015 16:45:26 +0000"  >&lt;p&gt;For 2.0 and PrecompactedRow, patch works as described.&lt;br/&gt;
Though I think we need to do the same for LazilyCompactedRow as well. (For 2.1+ we don&apos;t have PrecompactedRow anymore.)&lt;/p&gt;

&lt;p&gt;LazilyCompactedRow does not have null ColumnFamily even when all it&apos;s cells are removed. So when we have wide rows, we still have hash mismatch between empty rows and removed rows.&lt;/p&gt;</comment>
                            <comment id="14382217" author="spodxx@gmail.com" created="Thu, 26 Mar 2015 16:58:02 +0000"  >&lt;p&gt;I think the main problem here is that digest.update() is always called with the top-level row tombstone even if no tombstone exists. In this case digest is updated with DeletionTime.LIVE which doesn&apos;t seem to be correct. &lt;br/&gt;
Patches have been update, but couldn&apos;t test 2.1 yet. &lt;br/&gt;
I&apos;ve also created a test cluster &lt;a href=&quot;https://github.com/spodkowinski/phantom-cabinet-cases/tree/master/CASSANDRA-8979&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;bootstrap script&lt;/a&gt; to reproduce the problem for 2.0. &lt;/p&gt;</comment>
                            <comment id="14384260" author="yukim" created="Fri, 27 Mar 2015 18:06:15 +0000"  >&lt;p&gt;Thanks for the patch!&lt;br/&gt;
All those patches look good to me (except code formatting, I will fix that when I commit).&lt;/p&gt;

&lt;p&gt;For the test, I made automated test using cassandra-dtest here (&lt;a href=&quot;https://github.com/yukim/cassandra-dtest/tree/CASSANDRA-8979&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yukim/cassandra-dtest/tree/CASSANDRA-8979&lt;/a&gt;) because it is integrated to CI.&lt;br/&gt;
The test covers both 2.0 and 2.1+, and it checks repair for both gc-able and non gc-able data.&lt;/p&gt;</comment>
                            <comment id="14384342" author="yukim" created="Fri, 27 Mar 2015 18:40:46 +0000"  >&lt;p&gt;Committed.&lt;br/&gt;
cassandra-dtest pull request is here: &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/212&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/pull/212&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14388774" author="m0nstermind" created="Tue, 31 Mar 2015 16:20:23 +0000"  >&lt;p&gt;Noticed an unneccessary ByteBuffer allocation in PrecompactedRow in case it does not updates a digest.&lt;br/&gt;
Attached a patch that avoids it.&lt;/p&gt;</comment>
                            <comment id="14388836" author="yukim" created="Tue, 31 Mar 2015 16:59:12 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                            <comment id="14389476" author="thobbs" created="Tue, 31 Mar 2015 21:48:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; the new dtest is failing on 2.0, 2.1, and trunk.  Do you want to reopen this ticket to investigate?&lt;/p&gt;</comment>
                            <comment id="14389490" author="yukim" created="Tue, 31 Mar 2015 22:00:00 +0000"  >&lt;p&gt;dtest is failing on trunk. 2.0 and 2.1 are fine.&lt;br/&gt;
I will investigate.&lt;/p&gt;</comment>
                            <comment id="14390519" author="slebresne" created="Wed, 1 Apr 2015 13:17:53 +0000"  >&lt;p&gt;I&apos;m not sure unconditionally skipping the top-level partition tombstone if it&apos;s live is a good idea, because that means that if you do a repair with nodes both prior and after this patch, all partitions will mismatch (they will include the live partition tombstone before this patch, not after it). And that&apos;s probably not something we should do in a minor upgrade.&lt;/p&gt;

&lt;p&gt;Now, I don&apos;t think including the top-level partition tombstone is really a problem in general, it&apos;s only when the partition ends up having no live cells (when the partition is empty) that we should skip it so it&apos;s equivalent to having no partition at all. If we only skip it in that case, that will avoid the repair hell in mixed version cluster.&lt;/p&gt;</comment>
                            <comment id="14392508" author="spodxx@gmail.com" created="Thu, 2 Apr 2015 10:29:57 +0000"  >&lt;p&gt;Yes, I guess the implications for clusters running mixed versions haven&apos;t been really considered. I&apos;ve added a new patch which makes sure the digest calculation for non-empty rows will stay the same after the patch.&lt;/p&gt;

&lt;p&gt;Changes in detail:&lt;/p&gt;

&lt;p&gt;PrecompactedRow&lt;/p&gt;

&lt;p&gt;Would be reverted to exact same code as before the patch. &lt;br/&gt;
The issue described in the ticket would still be solved by the patched Validator, which now only creates a new RowHash in case the digest has been updated. The PrecompactRow never updated the digest in case of empty rows. &lt;/p&gt;


&lt;p&gt;LazilyCompactedRow&lt;/p&gt;

&lt;p&gt;I&apos;ve changed the digest update call condition to: nonEmpty || !DeletionTime.LIVE&lt;br/&gt;
this makes sure that digest update is called in any case for non-empty rows (and will thus be backwards compatible) but still skips update for empty rows with LIVE deletes.&lt;/p&gt;

&lt;p&gt;As for backwards compatability it still should be clear that after the patch empty/purged rows will now not create a digest in the MT anymore compared to versions before the patch. In this case those rows would still be streamed after repairs. This applies to both Precompacted and Lazy. One node with the new version would create the same mismatch as a node with the old version and a missing row.&lt;/p&gt;</comment>
                            <comment id="14392955" author="yukim" created="Thu, 2 Apr 2015 17:03:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=spodxx%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;spodxx@gmail.com&quot;&gt;spodxx@gmail.com&lt;/a&gt;&lt;br/&gt;
Sorry, I missed about mixed minor version cluster. Thanks for catching that.&lt;br/&gt;
In my opinion, users may experience more streaming if they have mixed versioned cluster.&lt;br/&gt;
I don&apos;t think they keep mixed version forever and eventually upgrade to their cluster to the same version, the impact is temporary.&lt;br/&gt;
So I&apos;m +1 to this change in minor version (with the latest patches by Stefan).&lt;/p&gt;

&lt;p&gt;And for the dtest failing on trunk, it is caused by another bug in trunk and will be fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9099&quot; title=&quot;Validation compaction not working for parallel repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9099&quot;&gt;&lt;del&gt;CASSANDRA-9099&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14394218" author="slebresne" created="Fri, 3 Apr 2015 08:48:09 +0000"  >&lt;p&gt;To avoid any confusion, I never suggested we wouldn&apos;t do this in a minor version, just that we basically added what the last patches from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=spodxx%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;spodxx@gmail.com&quot;&gt;spodxx@gmail.com&lt;/a&gt; adds. so &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt;, if you go ahead and commit those last patches, I&apos;m good closing this.&lt;/p&gt;</comment>
                            <comment id="14394477" author="yukim" created="Fri, 3 Apr 2015 14:29:49 +0000"  >&lt;p&gt;Thanks, committed follow ups.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310010">
                    <name>Incorporates</name>
                                                                <inwardlinks description="is part of">
                                        <issuelink>
            <issuekey id="12783375">CASSANDRA-8996</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12828991">CASSANDRA-9354</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12708449" name="8979-AvoidBufferAllocation-2.0_patch.txt" size="1465" author="m0nstermind" created="Tue, 31 Mar 2015 16:20:23 +0000"/>
                            <attachment id="12708965" name="8979-LazilyCompactedRow-2.0.txt" size="2630" author="spod" created="Thu, 2 Apr 2015 10:32:25 +0000"/>
                            <attachment id="12708966" name="8979-RevertPrecompactedRow-2.0.txt" size="1824" author="spod" created="Thu, 2 Apr 2015 10:32:25 +0000"/>
                            <attachment id="12707529" name="cassandra-2.0-8979-lazyrow_patch.txt" size="2383" author="spod" created="Thu, 26 Mar 2015 16:30:10 +0000"/>
                            <attachment id="12707530" name="cassandra-2.0-8979-validator_patch.txt" size="2329" author="spod" created="Thu, 26 Mar 2015 16:30:10 +0000"/>
                            <attachment id="12707531" name="cassandra-2.0-8979-validatortest_patch.txt" size="3289" author="spod" created="Thu, 26 Mar 2015 16:30:10 +0000"/>
                            <attachment id="12707527" name="cassandra-2.1-8979-lazyrow_patch.txt" size="1423" author="spod" created="Thu, 26 Mar 2015 16:30:10 +0000"/>
                            <attachment id="12707528" name="cassandra-2.1-8979-validator_patch.txt" size="2398" author="spod" created="Thu, 26 Mar 2015 16:30:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[spod]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 33 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i26vgf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12322954">2.0 beta 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>