<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:20:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16524] Upgrading SSL enabled Cassandra cluster from 3.11.10 to 4.0-beta4 failing with javax.net.ssl.SSLException: java.lang.IndexOutOfBoundsException</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16524</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;We have SSL enabled cluster running on Apache Cassandra 3.11.10 and we are trying to upgrade it to&#160;4.0-beta4 as a part of testing.&lt;/p&gt;

&lt;p&gt;Cluster size is 3x3 and deployed on Azure IaaS.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[cassandra@cass-521828978-1-1189299202 ~]$ nodetool status
Datacenter: southcentral
========================
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address      Load       Tokens       Owns (effective)  Host ID                               Rack
UN  10.12.74.31  85.61 KiB  16           32.2%             6db7a7ef-3490-4823-9ff3-c60a32165124  2
UN  10.12.74.42  263.27 KiB  16           27.6%             7ad99ecf-7c7d-4780-872b-7c68b6b19849  1
UN  10.12.74.34  85.61 KiB  16           37.8%             41ce16b7-2ab2-44ea-a810-8391f7f3caf2  0
Datacenter: westus
==================
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address      Load       Tokens       Owns (effective)  Host ID                               Rack
UN  10.12.90.11  90.63 KiB  16           38.9%             8d4cdb65-ff66-4bcd-8d4b-a4a0e893a728  2
UN  10.12.90.6   85.61 KiB  16           34.5%             4f8007e9-fa3e-4e99-a9f9-f99997bf9625  1
UN  10.12.89.80  94.1 KiB   16           28.9%             11f86cb0-c86b-440e-848f-b160118f43d5  0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;We placed a new&#160;4.0-beta4 binary on the first seed node (10.12.74.310) and starting Cassandra.&lt;/p&gt;

&lt;p&gt;It started throwing the below error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [Messaging-EventLoop-3-11] 2021-03-15 22:10:05,188 InboundConnectionInitiator.java:342 - Failed to properly handshake with peer /10.12.74.42:52356. Closing the channel.
io.netty.handler.codec.DecoderException: javax.net.ssl.SSLException: java.lang.IndexOutOfBoundsException: writerIndex(8560) + minWritableBytes(1977) exceeds maxCapacity(10240): BufferPoolAllocator$Wrapped(ridx: 0, widx: 8560, cap: 10240/10240)
	at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:471)
	at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:276)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)
	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:357)
	at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)
	at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)
	at io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:795)
	at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:480)
	at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:378)
	at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:989)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:748)
Caused by: javax.net.ssl.SSLException: java.lang.IndexOutOfBoundsException: writerIndex(8560) + minWritableBytes(1977) exceeds maxCapacity(10240): BufferPoolAllocator$Wrapped(ridx: 0, widx: 8560, cap: 10240/10240)
	at io.netty.handler.ssl.OpenSslKeyMaterialManager.setKeyMaterial(OpenSslKeyMaterialManager.java:115)
	at io.netty.handler.ssl.OpenSslKeyMaterialManager.setKeyMaterialServerSide(OpenSslKeyMaterialManager.java:84)
	at io.netty.handler.ssl.ReferenceCountedOpenSslServerContext$OpenSslServerCertificateCallback.handle(ReferenceCountedOpenSslServerContext.java:229)
	at io.netty.internal.tcnative.SSL.readFromSSL(Native Method)
	at io.netty.handler.ssl.ReferenceCountedOpenSslEngine.readPlaintextData(ReferenceCountedOpenSslEngine.java:596)
	at io.netty.handler.ssl.ReferenceCountedOpenSslEngine.unwrap(ReferenceCountedOpenSslEngine.java:1203)
	at io.netty.handler.ssl.ReferenceCountedOpenSslEngine.unwrap(ReferenceCountedOpenSslEngine.java:1325)
	at io.netty.handler.ssl.ReferenceCountedOpenSslEngine.unwrap(ReferenceCountedOpenSslEngine.java:1368)
	at io.netty.handler.ssl.SslHandler$SslEngineType$1.unwrap(SslHandler.java:206)
	at io.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1387)
	at io.netty.handler.ssl.SslHandler.decodeNonJdkCompatible(SslHandler.java:1294)
	at io.netty.handler.ssl.SslHandler.decode(SslHandler.java:1331)
	at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:501)
	at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:440)
	... 15 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;I have also used the below parameter under &lt;tt&gt;server_encryption_options&lt;/tt&gt; as suggested at : &lt;a href=&quot;https://cassandra.apache.org/doc/latest/configuration/cass_yaml_file.html#server-encryption-options&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://cassandra.apache.org/doc/latest/configuration/cass_yaml_file.html#server-encryption-options&lt;/a&gt; but still getting the same error.&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;enable_legacy_ssl_storage_port: true
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;br/&gt;
 I am attaching the system.log file here for your review.&lt;/p&gt;

&lt;p&gt;It is working fine with Cassandra 3.11.10 and it looks like some bug in&#160;4.0-beta4.&lt;/p&gt;

&lt;p&gt;Let me know if you need any more details.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
 Alaykumar Barochia&lt;/p&gt;</description>
                <environment></environment>
        <key id="13365514">CASSANDRA-16524</key>
            <summary>Upgrading SSL enabled Cassandra cluster from 3.11.10 to 4.0-beta4 failing with javax.net.ssl.SSLException: java.lang.IndexOutOfBoundsException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gianluca">Gianluca Righetto</assignee>
                                    <reporter username="abarochia">Alaykumar Barochia</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Mar 2021 13:23:02 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:58 +0000</updated>
                            <resolved>Wed, 21 Apr 2021 12:49:19 +0000</resolved>
                                        <fixVersion>4.0-rc1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Feature/Encryption</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>16</watches>
                                                                                                                <comments>
                            <comment id="17302822" author="aholmber" created="Tue, 16 Mar 2021 19:00:11 +0000"  >&lt;p&gt;Thanks for the report. Is &lt;tt&gt;enable_legacy_ssl_storage_port&lt;/tt&gt; the only thing you&apos;re changing in yaml? &lt;/p&gt;

&lt;p&gt;I&apos;m not sure it will matter, but which Java runtime are you running?&lt;/p&gt;</comment>
                            <comment id="17302922" author="aholmber" created="Tue, 16 Mar 2021 21:52:24 +0000"  >&lt;p&gt;This scenario is supported and should be covered in &lt;tt&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/blob/trunk/upgrade_tests/upgrade_through_versions_test.py#L328-L333&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test_rolling_upgrade_with_internode_ssl&lt;/a&gt;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I tried reproducing locally in ccm with these exact versions:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;keytool -genkeypair -alias ccm_node -keyalg RSA -validity 365 -keystore keystore.jks -storepass cassandra -dname &quot;cn=Cassandra Node,ou=CCMnode,o=DataStax,c=US&quot; -keypass cassandra
keytool -export -rfc -alias ccm_node -keystore keystore.jks -file ccm_node.cer -storepass cassandra
ccm create -n 3 -v 3.11.10 --node-ssl `pwd` c16258 -s
ccm node1 cqlsh -e &apos;select release_version from system.local&apos;
ccm node1 showlog | grep -i exception
ccm node1 stop
ccm node1 setdir -v 4.0-beta4
ccm node1 updateconf &apos;server_encryption_options.enable_legacy_ssl_storage_port: true&apos;
ccm node1 start
ccm node1 nodetool status
ccm node2 nodetool status
ccm node1 cqlsh -e &apos;select release_version from system.local&apos;
ccm node1 showlog | grep -i exception
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I did not reproduce the error with either 4.0-beta4 or trunk. &lt;/p&gt;

&lt;p&gt;We may need more information from troubleshooting your deployment, although I don&apos;t have anything more specific to ask for at this point.&lt;/p&gt;</comment>
                            <comment id="17303238" author="abarochia" created="Wed, 17 Mar 2021 09:44:08 +0000"  >&lt;p&gt;We added only &lt;tt&gt;enable_legacy_ssl_storage_port&lt;/tt&gt; parameter in cassandra.yaml file while upgrading to Cassandra 4.&lt;/p&gt;

&lt;p&gt;Below is our Java version:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[abaroch@cass-521828978-1-1189299202 ~]$ java -version
openjdk version &quot;1.8.0_241&quot;
OpenJDK Runtime Environment (Zulu 8.43.0.6-SA-linux64) (build 1.8.0_241-b08)
OpenJDK 64-Bit Server VM (Zulu 8.43.0.6-SA-linux64) (build 25.241-b08, mixed mode)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17309057" author="jmeredithco" created="Fri, 26 Mar 2021 00:18:32 +0000"  >&lt;p&gt;Do you have larger than usual key sizes or perhaps an openssl configuration that&apos;s being picked up on the host? It seems to be failing when adding the key material.&lt;/p&gt;</comment>
                            <comment id="17309431" author="abarochia" created="Fri, 26 Mar 2021 13:42:04 +0000"  >&lt;p&gt;How can we check the key sizes? &lt;/p&gt;</comment>
                            <comment id="17309809" author="jmeredithco" created="Fri, 26 Mar 2021 23:42:20 +0000"  >&lt;p&gt;You may be able to get the info using&lt;/p&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 keytool -list -v -keystore keystore.jks
 keytool -list -v -keystore truststore.jks
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Look for anything containing &quot;bit&quot;, for example&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Subject Public Key Algorithm: 2048-bit RSA key
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17311686" author="gianluca" created="Tue, 30 Mar 2021 17:39:43 +0000"  >&lt;p&gt;I can programmatically reproduce the exception reported in this ticket with the following piece of code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
	&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void main(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;[] args) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; CertificateEncodingException
    	{
		X509Certificate[] chain = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; X509Certificate[5];
		Random rand = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Random();
		DatabaseDescriptor.clientInitialization();
		&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; i = 0; i &amp;lt; chain.length; i++) {
		    &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] bytes = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[i % 2 == 0 ? 1024 : 4096];
		    rand.nextBytes(bytes);
		    OpenSslX509Certificate certificate = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; OpenSslX509Certificate(bytes);
		    chain[i] = certificate;
		}
		PemX509Certificate.toPEM(GlobalBufferPoolAllocator.instance, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;, chain);
	}
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note: this test code has to live in io.netty.hadler.ssl because `toPEM` is package-protected.&lt;br/&gt;
What it does is creating a chain of certificates (just random bytes for testing purposes) with different sizes (1024 and 4096 bits).&lt;/p&gt;

&lt;p&gt;The issue is that netty allocates a buffer that&apos;s proportional in size to the size of the first certificate in the chain, so if the certificates vary in length and the first one is shorter than the rest, the buffer size estimate will be off:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/netty/netty/blob/netty-4.1.58.Final/handler/src/main/java/io/netty/handler/ssl/PemX509Certificate.java#L135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/blob/netty-4.1.58.Final/handler/src/main/java/io/netty/handler/ssl/PemX509Certificate.java#L135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In general, that shouldn&apos;t be a problem because netty&apos;s default allocator, ByteBufAllocator.DEFAULT, will increase the max buffer capacity. But in C* 4.0, we can see from the attached stacktrace that it&apos;s using BufferPoolAllocator, which does not increase:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.0-beta4/src/java/org/apache/cassandra/net/BufferPoolAllocator.java#L59&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.0-beta4/src/java/org/apache/cassandra/net/BufferPoolAllocator.java#L59&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;In the sample code above, if I switch from &lt;tt&gt;GlobalBufferPoolAllocator.instance&lt;/tt&gt; to &lt;tt&gt;ByteBufAllocator.DEFAULT&lt;/tt&gt;, it throws no exception.&lt;br/&gt;
In C* 3.11.10 as far as I can tell it&apos;s using netty&apos;s default implementation.&lt;/p&gt;</comment>
                            <comment id="17313210" author="gianluca" created="Thu, 1 Apr 2021 14:38:01 +0000"  >&lt;p&gt;As I hinted above, this seems to be more of a general buffer allocation problem than SSL specific.&lt;br/&gt;
In C* 4.0, a buffer is initialized with its max capacity equal to its initial capacity, for example, the following piece of code fails in C* 4.0:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ByteBuf myBuffer = GlobalBufferPoolAllocator.instance.buffer(100);
&lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] toWrite = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[2000];
myBuffer.writeBytes(toWrite);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So when netty tries to read a PEM certificate chain larger than what it originally estimated, it will fail.&lt;br/&gt;
If we want to restore a similar behavior of 3.11.10 and allow for increasing the max buffer capacity up to Integer.MAX_VALUE (netty&apos;s &lt;a href=&quot;https://github.com/netty/netty/blob/netty-4.1.58.Final/buffer/src/main/java/io/netty/buffer/AbstractByteBufAllocator.java#L31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;default value&lt;/a&gt;), I have the following patch:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/grighetto/cassandra/pull/5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grighetto/cassandra/pull/5&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;CI build still pending, but I wanted to raise this for an early review/discussion. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; Would you mind taking a look?&lt;/p&gt;</comment>
                            <comment id="17313925" author="jasonstack" created="Fri, 2 Apr 2021 15:16:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt; thanks for the reproduction test. the fix looks good to me, left some minor nits.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt; do you mind having a look as well?&lt;/p&gt;</comment>
                            <comment id="17314943" author="gianluca" created="Mon, 5 Apr 2021 15:59:02 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; Thanks for the review. PR comments addressed.&lt;br/&gt;
Left a follow-up question: &lt;a href=&quot;https://github.com/grighetto/cassandra/pull/5/files#r607168291&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grighetto/cassandra/pull/5/files#r607168291&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17315404" author="bereng" created="Tue, 6 Apr 2021 09:50:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt; can you please run the j11 tests under the j8 link? I can&apos;t trigger them for you unfortunately.&lt;/p&gt;</comment>
                            <comment id="17315648" author="gianluca" created="Tue, 6 Apr 2021 15:08:16 +0000"  >&lt;p&gt;Pushed new change as the result of the follow-up question above.&lt;br/&gt;
Running new builds in CI.&lt;/p&gt;</comment>
                            <comment id="17315743" author="gianluca" created="Tue, 6 Apr 2021 17:31:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;bereng&lt;/a&gt; Latest change looks good on CI.&lt;br/&gt;
Test result links updated in the ticket.&lt;/p&gt;</comment>
                            <comment id="17315758" author="benedict" created="Tue, 6 Apr 2021 18:10:34 +0000"  >&lt;p&gt;I suspect there may be a bug if you don&apos;t at least look at overriding &lt;tt&gt;capacity(int)&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17319459" author="gianluca" created="Mon, 12 Apr 2021 13:37:16 +0000"  >&lt;p&gt;&lt;tt&gt;BufferPoolAllocator.Wrapped#capacity(int)&lt;/tt&gt; is now overridden to ensure the original ByteBuffer will be returned to the pool when the buffer is resized.&lt;br/&gt;
I also added unit tests for &lt;tt&gt;adopt()&lt;/tt&gt; and various other scenarios of resizing.&lt;/p&gt;

&lt;p&gt;Tests passed in CircleCI and result links have been updated in the issue description.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Would you mind taking another look?&lt;/p&gt;</comment>
                            <comment id="17321074" author="bereng" created="Wed, 14 Apr 2021 15:10:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt; I think we are just waiting for another +1 from either &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; or some other committer right?&lt;/p&gt;</comment>
                            <comment id="17321858" author="gianluca" created="Thu, 15 Apr 2021 02:30:11 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;bereng&lt;/a&gt; Right, I&apos;m not anticipating additional changes, just waiting for the final review.&lt;/p&gt;</comment>
                            <comment id="17322574" author="jasonstack" created="Fri, 16 Apr 2021 02:50:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;BufferPoolAllocator.Wrapped#capacity(int) is now overridden to ensure the original ByteBuffer will be returned to the pool when the buffer is resized.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Left a comment on whether to get rid of `super.capacity(int)` which allocated outside of pool.. &lt;a href=&quot;https://github.com/grighetto/cassandra/pull/5/files#r614524653&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grighetto/cassandra/pull/5/files#r614524653&lt;/a&gt;  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;bereng&lt;/a&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt; wdyt?&lt;/p&gt;</comment>
                            <comment id="17322607" author="gianluca" created="Fri, 16 Apr 2021 04:33:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; I went that route initially, but there&apos;s a problem with that approach, we pass the initial buffer to the constructor of UnpooledUnsafeDirectByteBuf and it keeps a reference to that internally:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/netty/netty/blob/netty-4.1.58.Final/buffer/src/main/java/io/netty/buffer/UnpooledDirectByteBuf.java#L42&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/blob/netty-4.1.58.Final/buffer/src/main/java/io/netty/buffer/UnpooledDirectByteBuf.java#L42&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We would have to call setByteBuffer to replace that object, but it is not public:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/netty/netty/blob/netty-4.1.58.Final/buffer/src/main/java/io/netty/buffer/UnpooledDirectByteBuf.java#L114&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/blob/netty-4.1.58.Final/buffer/src/main/java/io/netty/buffer/UnpooledDirectByteBuf.java#L114&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If we don&apos;t replace that internal buffer, there will be mismatches because some internal functions use it.&lt;br/&gt;
&lt;tt&gt;super.capacity(newCapacity)&lt;/tt&gt; already does the right things, creates a new buffer, copies over the bytes, releases the old one and replaces that reference.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;So we don&apos;t have to keep track of returnToPool which defeats the purpose of reducing fragmented buffer allocation&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, I thought about that too and I agree, but for most cases it will behave as before (it has been working with fixed-length buffers up until now). Increasing the buffer capacity should be an edge case as the one reported in the ticket.&lt;/p&gt;</comment>
                            <comment id="17323814" author="edimitrova" created="Fri, 16 Apr 2021 13:29:45 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt;&#160;for all the work and bearing with me in Slack to confirm details.&#160;&lt;/p&gt;

&lt;p&gt;I just submitted my pass of review with just small comments. I have only two questions.&#160;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Do we really need to use the new capacity function for max ?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I want to align this with 3.11 and have the least hurdle. Does 3.11 always use the Netty &lt;a href=&quot;https://github.com/netty/netty/blob/netty-4.1.58.Final/buffer/src/main/java/io/netty/buffer/AbstractByteBufAllocator.java#L31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DEFAULT_MAX_CAPACITY&lt;/a&gt;?&#160;&lt;/p&gt;

&lt;p&gt;&#160;- resizing happens in the same way it happens in 3.11 now?&lt;/p&gt;

&lt;p&gt;Also, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aholmber&quot; class=&quot;user-hover&quot; rel=&quot;aholmber&quot;&gt;aholmber&lt;/a&gt;, as you were working on the upgrade tests, do you think there is another one we can add to cover this case and show the smooth upgrade after this patch or it is overkill?&#160;&lt;/p&gt;</comment>
                            <comment id="17323974" author="aholmber" created="Fri, 16 Apr 2021 17:21:49 +0000"  >&lt;p&gt;I understand that this was found during upgrade, but imo an upgrade test is fairly abstract characterization of this fix. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt; said creating the cert chain was fairly involved. Do you think it&apos;s worth codifying that in an integration test?  I had been thinking that the new unit tests were sufficient.&lt;/p&gt;</comment>
                            <comment id="17324687" author="bereng" created="Mon, 19 Apr 2021 04:56:49 +0000"  >&lt;p&gt;The root cause has nothing to do with an upgrade or SSL. But it&apos;s just a generic BB resizing problem we have. So the unit tests should suffice and are the right fix imo if I am not missing anything.&lt;/p&gt;</comment>
                            <comment id="17325017" author="edimitrova" created="Mon, 19 Apr 2021 13:00:50 +0000"  >&lt;blockquote&gt;&lt;p&gt;The root cause has nothing to do with an upgrade or SSL. But it&apos;s just a generic BB resizing problem we have.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I didn&apos;t say anything different I think? As I mentioned &quot;to simulate the smooth upgrade&quot; but probably only the unit tests are enough here. Ignore me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;

&lt;p&gt;I am hesitant whether we want to keep the current behavior during resizing or get back to using DEFAULT_MAX_CAPACITY, similar to what we do in 3.11. (I asked Gianluca on Friday and he verified it is  DEFAULT_MAX_CAPACITY in 3.11)&lt;/p&gt;

</comment>
                            <comment id="17325469" author="bereng" created="Tue, 20 Apr 2021 04:39:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;I didn&apos;t say anything different I think?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ah no, I was just thinking loud about the update thing.&lt;/p&gt;</comment>
                            <comment id="17326049" author="edimitrova" created="Tue, 20 Apr 2021 19:13:10 +0000"  >&lt;p&gt;Jenkins is running &lt;a href=&quot;https://jenkins-cm4.apache.org/job/Cassandra-devbranch/690/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; for the latest version of the patch.&lt;/p&gt;</comment>
                            <comment id="17326149" author="edimitrova" created="Tue, 20 Apr 2021 23:07:41 +0000"  >&lt;p&gt;Jenkins finished with three failures which seem to me unrelated to the patch:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://jenkins-cm4.apache.org/job/Cassandra-devbranch/690/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins-cm4.apache.org/job/Cassandra-devbranch/690/testReport/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Two of the tests seem flaky and have failed with the same issue before:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/446/testReport/junit/org.apache.cassandra.net/AsyncPromiseTest/testFailure_cdc/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/446/testReport/junit/org.apache.cassandra.net/AsyncPromiseTest/testFailure_cdc/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/447/testReport/junit/org.apache.cassandra.db.compaction/LongLeveledCompactionStrategyCQLTest/stressTestCompactionStrategyManager/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/job/Cassandra-trunk/447/testReport/junit/org.apache.cass[&#8230;]ctionStrategyCQLTest/stressTestCompactionStrategyManager/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The third one looks to me as a CI env issue, WDYT?:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://jenkins-cm4.apache.org/job/Cassandra-devbranch/690/testReport/junit.framework/TestSuite/org_apache_cassandra_distributed_test_PreviewRepairCoordinatorFastTest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins-cm4.apache.org/job/Cassandra-devbranch/690/testReport/junit.framework/Te[&#8230;]sandra_distributed_test_PreviewRepairCoordinatorFastTest/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR 20:56:36 Repair e500b3d0-a21a-11eb-882f-cd9857e77aff failed:
java.lang.IllegalArgumentException: Unknown host specified thisreally.should.not.exist.apache.org
 at org.apache.cassandra.service.ActiveRepairService.getNeighbors(ActiveRepairService.java:478)
 at org.apache.cassandra.repair.RepairRunnable.getNeighborsAndRanges(RepairRunnable.java:326)
 at org.apache.cassandra.repair.RepairRunnable.runMayThrow(RepairRunnable.java:265)
 at org.apache.cassandra.repair.RepairRunnable.run(RepairRunnable.java:241)
 at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
 at java.util.concurrent.FutureTask.run(FutureTask.java:266)
 at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
 at java.util.concurrent.FutureTask.run(FutureTask.java:266)
 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
 at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
 at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.net.UnknownHostException: thisreally.should.not.exist.apache.org: Name or service not known
 at java.net.Inet4AddressImpl.lookupAllHostAddr(Native Method)
 at java.net.InetAddress$2.lookupAllHostAddr(InetAddress.java:929)
 at java.net.InetAddress.getAddressesFromNameService(InetAddress.java:1324)
 at java.net.InetAddress.getAllByName0(InetAddress.java:1277)
 at java.net.InetAddress.getAllByName(InetAddress.java:1193)
 at java.net.InetAddress.getAllByName(InetAddress.java:1127)
 at java.net.InetAddress.getByName(InetAddress.java:1077)
 at org.apache.cassandra.locator.InetAddressAndPort.getByNameOverrideDefaults(InetAddressAndPort.java:228)
 at org.apache.cassandra.locator.InetAddressAndPort.getByName(InetAddressAndPort.java:213)
 at org.apache.cassandra.service.ActiveRepairService.getNeighbors(ActiveRepairService.java:472)
 ... 11 common frames omitted&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17326157" author="gianluca" created="Tue, 20 Apr 2021 23:53:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt;&#160;The third test recently failed on trunk too: &lt;a href=&quot;https://jenkins-cm4.apache.org/job/Cassandra-trunk/451/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins-cm4.apache.org/job/Cassandra-trunk/451/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I agree they look unrelated to the patch.&lt;/p&gt;</comment>
                            <comment id="17326158" author="edimitrova" created="Tue, 20 Apr 2021 23:53:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt;&#160;just shared with me that the same test just failed again in the latest trunk build actually:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://jenkins-cm4.apache.org/job/Cassandra-trunk/451/testReport/junit/junit.framework/TestSuite/org_apache_cassandra_distributed_test_PreviewRepairCoordinatorFastTest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://jenkins-cm4.apache.org/job/Cassandra-trunk/451/testReport/junit/junit.framework/TestSuite/org_apache_cassandra_distributed_test_PreviewRepairCoordinatorFastTest/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17326159" author="edimitrova" created="Tue, 20 Apr 2021 23:54:21 +0000"  >&lt;p&gt;I think our messages crashed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17326172" author="edimitrova" created="Wed, 21 Apr 2021 00:17:19 +0000"  >&lt;p&gt;I am +1 on the latest version of the patch.&lt;/p&gt;

&lt;p&gt;We were brainstorming with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt; around the usage of&#160; DEFAULT_MAX_CAPACITY, and after looking at the whole testing done around that part of the code in 4.0 (with huge clusters and a lot of data), I think it sounds probably reasonable to keep the current limit/behavior.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt;&#160;already approved the latest &lt;a href=&quot;https://github.com/grighetto/cassandra/pull/6/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt; in GitHub. I will leave the patch not committed until tomorrow morning if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;bereng&lt;/a&gt;(or anyone else)&#160;has something to add, based on CI or some of my statements or anything and I think tomorrow morning I can commit it (if they don&apos;t do it and there is nothing else to be added here)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17326337" author="bereng" created="Wed, 21 Apr 2021 07:53:04 +0000"  >&lt;p&gt;If I followed the code correctly I &lt;em&gt;think&lt;/em&gt; we&apos;re not checking, neither is Netty, for &lt;tt&gt;BuffePool.memoryUsageThreshold&lt;/tt&gt;. In this case that&apos;d be &lt;tt&gt;NETWORKING_MEMORY_USAGE_THRESHOLD&lt;/tt&gt; coming from &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/utils/memory/BufferPools.java#L45&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. That is being honored in reads i.e. but I think it&apos;d be nice to do the same on resizing. At least I would add a unit test that tries to violate the buffer pool&apos;s memory threshold as future proofing. &lt;/p&gt;</comment>
                            <comment id="17326432" author="blerer" created="Wed, 21 Apr 2021 10:44:48 +0000"  >&lt;p&gt;The patch has been approved by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt;. CI looks good.&lt;br/&gt;
I will fix 1 formatting issue and rename the test class as suggested by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; and commit.&lt;/p&gt;</comment>
                            <comment id="17326483" author="blerer" created="Wed, 21 Apr 2021 12:26:38 +0000"  >&lt;p&gt;Sorry, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;bereng&lt;/a&gt;, I missed your comment.&lt;br/&gt;
When &lt;tt&gt;Wrapped.capacity(int newCapacity)&lt;/tt&gt; is called it calls &lt;tt&gt;super.capacity(int newCapacity)&lt;/tt&gt; that call back &lt;tt&gt;Wrapped.allocateDirect&lt;/tt&gt; that take care of using the BufferPool instead of allocating the buffer itself.&lt;br/&gt;
I checked the test and they trigger that path before checking that the changes have updated correctly the &lt;tt&gt;BufferPool&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17326493" author="bereng" created="Wed, 21 Apr 2021 12:37:19 +0000"  >&lt;p&gt;So we cleared these doubts with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; on Slack. &lt;tt&gt;allocateDirect()&lt;/tt&gt; being overridden is the key here. Upon resizing it gets called by Netty and that will prevent going over the threshold. That also makes current tests already have that check implicit.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17326500" author="blerer" created="Wed, 21 Apr 2021 12:47:20 +0000"  >&lt;p&gt;A big thank you to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;bereng&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; for the patch and the reviews. Great job!&lt;/p&gt;</comment>
                            <comment id="17326502" author="blerer" created="Wed, 21 Apr 2021 12:49:19 +0000"  >&lt;p&gt;Committed into trunk at 27cc2fc3e275f56f1fa1df7285c389d5491acc8c&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13623040">CASSANDRA-20753</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13022384" name="system.log.ssl-error.txt" size="328134" author="abarochia" created="Tue, 16 Mar 2021 13:22:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[gianluca]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 29 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ou5k:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
        <customfieldvalue><![CDATA[e.dimitrova]]></customfieldvalue>
        <customfieldvalue><![CDATA[jasonstack]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/27cc2fc3e275f56f1fa1df7285c389d5491acc8c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/27cc2fc3e275f56f1fa1df7285c389d5491acc8c&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Patch available at:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/grighetto/cassandra/pull/6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grighetto/cassandra/pull/6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Added unit tests:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/grighetto/cassandra/blob/ecc8e3fc82769229231e4142857b88fce1d2263b/test/unit/org/apache/cassandra/net/BufferAllocatorTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grighetto/cassandra/blob/ecc8e3fc82769229231e4142857b88fce1d2263b/test/unit/org/apache/cassandra/net/BufferAllocatorTest.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/grighetto/cassandra/blob/ecc8e3fc82769229231e4142857b88fce1d2263b/test/unit/org/apache/cassandra/utils/memory/BufferPoolTest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grighetto/cassandra/blob/ecc8e3fc82769229231e4142857b88fce1d2263b/test/unit/org/apache/cassandra/utils/memory/BufferPoolTest.java&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;JDK 8 tests results:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/grighetto/cassandra/57/workflows/0a2fa3ee-d502-4b4f-b311-b30d24a31465&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/grighetto/cassandra/57/workflows/0a2fa3ee-d502-4b4f-b311-b30d24a31465&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;JDK 11 test results:&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/grighetto/cassandra/57/workflows/717987da-4226-40ec-8522-770dc9791129&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/grighetto/cassandra/57/workflows/717987da-4226-40ec-8522-770dc9791129&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>