<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:29:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19461] SAI does not index empty bytes even for types that allow empty bytes as a valid input</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19461</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This is easy to reproduce with a test that looks something like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;@Test
public void testEmptyString()
{
    createTable(&quot;CREATE TABLE %s (k TEXT PRIMARY KEY, v text)&quot;);
    createIndex(String.format(CREATE_INDEX_TEMPLATE, &apos;v&apos;));

    execute(&quot;INSERT INTO %s (k, v) VALUES (&apos;0&apos;, &apos;&apos;)&quot;);
    execute(&quot;INSERT INTO %s (k) VALUES (&apos;1&apos;)&quot;);
    
    // flush(); &amp;lt;---- there is not always a memtable index involved, a fix will have to pay attention to this

    List&amp;lt;Row&amp;gt; rows = executeNet(&quot;SELECT * FROM %s WHERE v = &apos;&apos;&quot;).all();
    assertEquals(1, rows.size()); &amp;lt;&#8212; FAILS! No matches...
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13571178">CASSANDRA-19461</key>
            <summary>SAI does not index empty bytes even for types that allow empty bytes as a valid input</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maedhroz">Caleb Rackliffe</assignee>
                                    <reporter username="maedhroz">Caleb Rackliffe</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 Mar 2024 17:22:55 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:46 +0000</updated>
                            <resolved>Fri, 22 Mar 2024 17:00:47 +0000</resolved>
                                        <fixVersion>5.0-rc1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Feature/SAI</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="7800">2h 10m</timespent>
                                <comments>
                            <comment id="17829301" author="maedhroz" created="Wed, 20 Mar 2024 21:15:18 +0000"  >&lt;p&gt;5.0 patch: &lt;a href=&quot;https://github.com/apache/cassandra/pull/3185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3185&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;CI  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13067563/13067563_ci_summary.html&quot; title=&quot;ci_summary.html attached to CASSANDRA-19461&quot;&gt;looks good&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;. Just a unit test issue I&apos;ve already fixed and a couple unrelated Python dtest failures, which look like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18325&quot; title=&quot;Test failure: dtest.bootstrap_test.TestBootstrap.test_cleanup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18325&quot;&gt;&lt;del&gt;CASSANDRA-18325&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17829337" author="edimitrova" created="Thu, 21 Mar 2024 00:13:31 +0000"  >&lt;p&gt;I&apos;ll review it tomorrow when we have CI also ready. Thanks&lt;/p&gt;</comment>
                            <comment id="17829558" author="edimitrova" created="Thu, 21 Mar 2024 13:21:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; already reviewed it so I will move away &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17829727" author="maedhroz" created="Fri, 22 Mar 2024 03:01:58 +0000"  >&lt;p&gt;Trunk CI results are similarly unremarkable. Moving to commit...&lt;/p&gt;</comment>
                            <comment id="17829938" author="maedhroz" created="Fri, 22 Mar 2024 17:00:47 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/46acaf22e688e7a2e707ac61fd88c96ed33b60d7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/46acaf22e688e7a2e707ac61fd88c96ed33b60d7&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17925395" author="adelapena" created="Sun, 9 Feb 2025 15:34:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; It seems this breaks the indexing of empty values in types that allow them and are not indexed as literals. For example, with &lt;tt&gt;int&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
@Test
&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testEmptyNonLiteral()
{
    createTable(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE TABLE %s (k &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; PRIMARY KEY, v &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)&quot;&lt;/span&gt;);
    execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO %s (k, v) VALUES (0, ?)&quot;&lt;/span&gt;, EMPTY_BYTE_BUFFER);
    flush();
    createIndex(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(CREATE_INDEX_TEMPLATE, &lt;span class=&quot;code-quote&quot;&gt;&apos;v&apos;&lt;/span&gt;)); &lt;span class=&quot;code-comment&quot;&gt;// fails!!!
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The index creation will fail with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN  [SecondaryIndexManagement:1] 2025-02-09 15:11:23,714 SecondaryIndexManager.java:843 - Index build of table_testemptynonliteral_00_v_idx failed. Please run full index rebuild to fix it.
java.util.concurrent.ExecutionException: java.lang.NullPointerException
	at org.apache.cassandra.utils.concurrent.AbstractFuture.getWhenDone(AbstractFuture.java:239)
	at org.apache.cassandra.utils.concurrent.AbstractFuture.get(AbstractFuture.java:246)
	at org.apache.cassandra.index.sai.StorageAttachedIndex.lambda$getInitializationTask$4(StorageAttachedIndex.java:337)
	at org.apache.cassandra.concurrent.FutureTask.call(FutureTask.java:61)
	at org.apache.cassandra.concurrent.FutureTask.run(FutureTask.java:71)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
Caused by: java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.db.tries.InMemoryTrie.putRecursive(InMemoryTrie.java:904)
	at org.apache.cassandra.db.tries.InMemoryTrie.putRecursive(InMemoryTrie.java:897)
	at org.apache.cassandra.db.tries.InMemoryTrie.putSingleton(InMemoryTrie.java:878)
	at org.apache.cassandra.index.sai.disk.v1.segment.SegmentTrieBuffer.add(SegmentTrieBuffer.java:69)
	at org.apache.cassandra.index.sai.disk.v1.segment.SegmentBuilder$TrieSegmentBuilder.addInternal(SegmentBuilder.java:90)
	at org.apache.cassandra.index.sai.disk.v1.segment.SegmentBuilder.add(SegmentBuilder.java:195)
	at org.apache.cassandra.index.sai.disk.v1.SSTableIndexWriter.addTerm(SSTableIndexWriter.java:208)
	at org.apache.cassandra.index.sai.disk.v1.SSTableIndexWriter.addRow(SSTableIndexWriter.java:99)
	at org.apache.cassandra.index.sai.disk.StorageAttachedIndexWriter.addRow(StorageAttachedIndexWriter.java:257)
	at org.apache.cassandra.index.sai.disk.StorageAttachedIndexWriter.nextUnfilteredCluster(StorageAttachedIndexWriter.java:131)
	at org.apache.cassandra.index.sai.StorageAttachedIndexBuilder.indexSSTable(StorageAttachedIndexBuilder.java:188)
	at org.apache.cassandra.index.sai.StorageAttachedIndexBuilder.build(StorageAttachedIndexBuilder.java:118)
	at org.apache.cassandra.db.compaction.CompactionManager$13.run(CompactionManager.java:1905)
	at org.apache.cassandra.concurrent.FutureTask$3.call(FutureTask.java:141)
	... 6 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I think this happens for all data types except for &lt;tt&gt;text&lt;/tt&gt;, &lt;tt&gt;ascii&lt;/tt&gt;, &lt;tt&gt;boolean&lt;/tt&gt; and frozen multicells.&lt;/p&gt;

&lt;p&gt;All the data types indexed with the block-balanced tree (numeric types amongst others) use &lt;tt&gt;AbstractTpye#asComparableBytes&lt;/tt&gt; to produce the &lt;tt&gt;ByteSource&lt;/tt&gt;. There are multiple implementations of that method, but most of them if not all return null for an empty column value, which leads to the NPE shown above.&lt;/p&gt;

&lt;p&gt;I guess if we want to index those empty values &lt;tt&gt;AbstractTpye#asComparableBytes&lt;/tt&gt; should return something non-null that can be put on the tree. This would be ideal and would mimic legacy table-based index behaviour. I don&apos;t know how we should represent empty values for each affected data type, though.&lt;/p&gt;

&lt;p&gt;However, it&apos;s not clear to me how valuable it is, besides consistency with legacy table-based 2i, to index empty values for types where &lt;tt&gt;AbstractType#isEmptyValueMeaningless&lt;/tt&gt; is &lt;tt&gt;true&lt;/tt&gt;, which are those not going to the literal index. Perhaps we should ignore them until we have a means to represent empty values in the tree?&lt;/p&gt;</comment>
                            <comment id="17925650" author="maedhroz" created="Mon, 10 Feb 2025 17:20:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=adelapena&quot; class=&quot;user-hover&quot; rel=&quot;adelapena&quot;&gt;adelapena&lt;/a&gt; I&apos;m creating a new Jira to figure this out shortly. Will link here...&lt;/p&gt;</comment>
                            <comment id="17925684" author="maedhroz" created="Mon, 10 Feb 2025 18:43:21 +0000"  >&lt;p&gt;See&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-20313&quot; title=&quot;SAI should avoid attempting to index empty values for numerics and types that do not allow them&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-20313&quot;&gt;&lt;del&gt;CASSANDRA-20313&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13608030">CASSANDRA-20313</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13067563" name="ci_summary.html" size="7090" author="maedhroz" created="Thu, 21 Mar 2024 03:49:47 +0000"/>
                            <attachment id="13067564" name="result_details.tar.gz" size="39945761" author="maedhroz" created="Thu, 21 Mar 2024 03:54:47 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
        <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12972"><![CDATA[Fuzz Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>CASSANDRA-19224</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            39 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1nuk8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12353513">5.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/46acaf22e688e7a2e707ac61fd88c96ed33b60d7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/46acaf22e688e7a2e707ac61fd88c96ed33b60d7&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;new tests around empty text values for literal indexes through the write lifecycle&lt;/li&gt;
	&lt;li&gt;new general randomized tests for supported index data types&lt;/li&gt;
&lt;/ul&gt;
</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>