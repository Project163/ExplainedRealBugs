<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:19:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2256] BRAF assertion error</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2256</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;While investigating &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2240&quot; title=&quot;nodetool scrub hangs or throws an exception&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2240&quot;&gt;&lt;del&gt;CASSANDRA-2240&lt;/del&gt;&lt;/a&gt; I ran into this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.AssertionError
        at org.apache.cassandra.io.util.BufferedRandomAccessFile.read(BufferedRandomAccessFile.java\
:230)
        at java.io.RandomAccessFile.readByte(RandomAccessFile.java:589)
        at org.apache.cassandra.utils.ByteBufferUtil.readShortLength(ByteBufferUtil.java:273)
        at org.apache.cassandra.utils.ByteBufferUtil.readWithShortLength(ByteBufferUtil.java:284)
        at org.apache.cassandra.db.CompactionManager.doScrub(CompactionManager.java:539)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12499978">CASSANDRA-2256</key>
            <summary>BRAF assertion error</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xedin">Pavel Yaskevich</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Mon, 28 Feb 2011 21:29:06 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:05 +0000</updated>
                            <resolved>Thu, 3 Mar 2011 16:44:20 +0000</resolved>
                                        <fixVersion>0.7.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="14400">4h</timeoriginalestimate>
                            <timeestimate seconds="14400">4h</timeestimate>
                                        <comments>
                            <comment id="13001502" author="xedin" created="Wed, 2 Mar 2011 17:52:23 +0000"  >&lt;p&gt;Test for the problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void testAssertOnRead() &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
    {
        BufferedRandomAccessFile file = createTempFile(&lt;span class=&quot;code-quote&quot;&gt;&quot;braf&quot;&lt;/span&gt;);
        file.write(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[10]);
        file.sync();

        BufferedRandomAccessFile copy = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; BufferedRandomAccessFile(file.getPath(), &lt;span class=&quot;code-quote&quot;&gt;&quot;r&quot;&lt;/span&gt;);

        copy.seek(15);
        copy.read();

        file.close();
        copy.close();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This happens when you are trying to seek to position &amp;gt; file length on read-only file and then read (because fileLength is cached, method isEOF() does not work properly). I don&apos;t think that we should allow such seeks.&lt;/p&gt;</comment>
                            <comment id="13001550" author="jbellis" created="Wed, 2 Mar 2011 19:02:24 +0000"  >&lt;p&gt;Technically RAF.seek allows seeking beyond EOF and writing there (presumably the intervening space would be filled with 0?) but Cassandra doesn&apos;t use this and it&apos;s kind of a weird corner case.  There&apos;s a pretty strong assumption in BRAF that current &amp;lt;= EOF.&lt;/p&gt;

&lt;p&gt;So, I would be okay with throwing EOFException if you try to seek past EOF.&lt;/p&gt;</comment>
                            <comment id="13001573" author="jbellis" created="Wed, 2 Mar 2011 19:36:33 +0000"  >&lt;p&gt;Is there a way to do this w/o calling channel.size() for each seek?  We seek twice for every row written, and channel.size() is fairly expensive.&lt;/p&gt;</comment>
                            <comment id="13001576" author="xedin" created="Wed, 2 Mar 2011 19:41:37 +0000"  >&lt;p&gt;There is no way to skip this unless we will check this only for read-only files.&lt;/p&gt;</comment>
                            <comment id="13001578" author="tjake" created="Wed, 2 Mar 2011 19:50:48 +0000"  >&lt;p&gt;throwing EOF is good.&lt;/p&gt;

&lt;p&gt;Regarding the check of length on every seek for writable files, I think you could change it to see if the seek is &amp;lt; bufferOffset + buffer.length before calling length()&lt;/p&gt;
</comment>
                            <comment id="13001592" author="xedin" created="Wed, 2 Mar 2011 20:11:16 +0000"  >&lt;p&gt;It is also half-solving, I think we can check that for read-only files and for writable we can leave this as is (makes perfect sense), any counter-argument?&lt;/p&gt;</comment>
                            <comment id="13001597" author="tjake" created="Wed, 2 Mar 2011 20:19:21 +0000"  >&lt;p&gt;The counter argument is we call seek() 2 times for every row in SSTableWriter.&lt;/p&gt;

&lt;p&gt;So we need to make sure we don&apos;t call stat() unless we have no other choice.&lt;br/&gt;
Another approach would be to set fileLength based on the total number of bytes from the starting size, or 0 for a new file...&lt;/p&gt;</comment>
                            <comment id="13001610" author="xedin" created="Wed, 2 Mar 2011 20:36:47 +0000"  >&lt;p&gt;if we will be doing this for read-only condition will be &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fileLength != -1 &amp;amp;&amp;amp; newPosition &amp;gt; fileLength)
    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; EOFException();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;this won&apos;t call channel.size() or do any expensive calculations like length()&lt;/p&gt;</comment>
                            <comment id="13001620" author="tjake" created="Wed, 2 Mar 2011 20:45:26 +0000"  >&lt;p&gt;Oh so you mean let the it throw an AssertionError if you try to seek beyond the end of a file in &quot;rw&quot; mode?&lt;/p&gt;</comment>
                            <comment id="13001621" author="jbellis" created="Wed, 2 Mar 2011 20:48:33 +0000"  >&lt;p&gt;Not a fan of relying on assert when we really want EOFException.&lt;/p&gt;</comment>
                            <comment id="13001625" author="xedin" created="Wed, 2 Mar 2011 20:55:04 +0000"  >&lt;p&gt;Seems that we don&apos;t understand each other here &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;seek method will look like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void seek(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; newPosition) &lt;span class=&quot;code-keyword&quot;&gt;throws&lt;/span&gt; IOException
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (newPosition &amp;lt; 0)
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; IllegalArgumentException(&lt;span class=&quot;code-quote&quot;&gt;&quot;&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; position should not be negative&quot;&lt;/span&gt;);

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (fileLength != -1 &amp;amp;&amp;amp; newPosition &amp;gt; fileLength)
            &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; EOFException(&lt;span class=&quot;code-quote&quot;&gt;&quot;unable to seek past the end of the file in read-only mode.&quot;&lt;/span&gt;);

        current = newPosition;

        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (newPosition &amp;gt;= bufferOffset + validBufferBytes || newPosition &amp;lt; bufferOffset)
            reBuffer(); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; will set bufferEnd &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; us
&lt;/span&gt;    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We set fileLength = -1 for &quot;rw&quot; mode and caching fileLength = channel.size() for &quot;r&quot; mode files, so condition &quot;fileLength != -1 &amp;amp;&amp;amp; newPosition &amp;gt; fileLength&quot; will allow us to block seeking past the end of the file in &quot;r&quot; mode leaving &quot;rw&quot; untouched (which makes a good sense even if it&apos;s unused right now and lets us avoid calling length() for every seek()).&lt;/p&gt;</comment>
                            <comment id="13001635" author="tjake" created="Wed, 2 Mar 2011 21:00:23 +0000"  >&lt;p&gt;Right, but what happens if you try to seek past the end of a file in &quot;rw&quot; mode?&lt;/p&gt;</comment>
                            <comment id="13001642" author="xedin" created="Wed, 2 Mar 2011 21:04:13 +0000"  >&lt;p&gt;That will be allowed as it is right now but that won&apos;t create any problems because length of the file is dynamic in that case and isEOF() method will be working properly.&lt;/p&gt;</comment>
                            <comment id="13001660" author="tjake" created="Wed, 2 Mar 2011 21:23:45 +0000"  >&lt;p&gt;If that&apos;s tested and proven then I don&apos;t see an issue with using the code snippet above.&lt;/p&gt;</comment>
                            <comment id="13001665" author="xedin" created="Wed, 2 Mar 2011 21:27:38 +0000"  >&lt;p&gt;Yes, it is. I will attach v2 patch asap.&lt;/p&gt;</comment>
                            <comment id="13002036" author="jbellis" created="Thu, 3 Mar 2011 16:06:36 +0000"  >&lt;p&gt;committed with additional test that writing past EOF actually works&lt;/p&gt;</comment>
                            <comment id="13002049" author="hudson" created="Thu, 3 Mar 2011 16:27:39 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #341 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/341/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/341/&lt;/a&gt;)&lt;br/&gt;
    throw EOFException when seeking past EOF in read-only mode&lt;br/&gt;
patch by Pavel Yaskevich; reviewed by tjake and jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2256&quot; title=&quot;BRAF assertion error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2256&quot;&gt;&lt;del&gt;CASSANDRA-2256&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12472476" name="CASSANDRA-2256-v2.patch" size="4657" author="xedin" created="Wed, 2 Mar 2011 22:09:51 +0000"/>
                            <attachment id="12472452" name="CASSANDRA-2256.patch" size="4557" author="xedin" created="Wed, 2 Mar 2011 19:30:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[xedin]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20529</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 38 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gaaf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93097</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>