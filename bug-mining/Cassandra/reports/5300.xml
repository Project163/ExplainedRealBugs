<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:14:55 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15308] Fix flakey testAcquireReleaseOutbound - org.apache.cassandra.net.ConnectionTest</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15308</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Example failure:&#160;&lt;a href=&quot;https://circleci.com/gh/jolynch/cassandra/554#tests/containers/61&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/jolynch/cassandra/554#tests/containers/61&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Your job ran 4428 tests with 1 failure
- testAcquireReleaseOutbound - org.apache.cassandra.net.ConnectionTest

junit.framework.AssertionFailedError
	at org.apache.cassandra.net.ConnectionTest.lambda$testAcquireReleaseOutbound$53(ConnectionTest.java:770)
	at org.apache.cassandra.net.ConnectionTest.lambda$doTest$8(ConnectionTest.java:238)
	at org.apache.cassandra.net.ConnectionTest.doTestManual(ConnectionTest.java:258)
	at org.apache.cassandra.net.ConnectionTest.doTest(ConnectionTest.java:236)
	at org.apache.cassandra.net.ConnectionTest.test(ConnectionTest.java:225)
	at org.apache.cassandra.net.ConnectionTest.testAcquireReleaseOutbound(ConnectionTest.java:767) &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13255300">CASSANDRA-15308</key>
            <summary>Fix flakey testAcquireReleaseOutbound - org.apache.cassandra.net.ConnectionTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yifanc">Yifan Cai</assignee>
                                    <reporter username="jolynch">Joey Lynch</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Sep 2019 15:35:00 +0000</created>
                <updated>Mon, 21 Dec 2020 08:07:56 +0000</updated>
                            <resolved>Tue, 3 Mar 2020 16:30:23 +0000</resolved>
                                        <fixVersion>4.0-alpha4</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Test/unit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17025382" author="yifanc" created="Tue, 28 Jan 2020 19:14:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/yifan-c/cassandra/tree/CASSANDRA-15308&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Code&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra/pull/433&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/github/yifan-c/cassandra/pipelines/55450fa4-3a68-4136-aa35-927daf158687/workflows/94e4335b-a73f-43c2-9a5a-4e5e6ad43c49&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Test&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;testAcquireReleaseOutbound&lt;/tt&gt; starts multiple testing rounds. In each round, it set up the test settings and starts N threads to contend for capacity. &lt;br/&gt;
 The test fails due to leaking resources (insufficient global capacity). &lt;br/&gt;
 The global limit that tracks the global capacity usage is shred among different rounds, and the reserved capacity is not completely released in each round.&lt;/p&gt;

&lt;p&gt;The patch fixes the test by releasing all pending capacity at the end of each round.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Update 1/29&lt;/em&gt;&lt;br/&gt;
 The test result linked failed due to some other test. &lt;br/&gt;
 All unit test passed in the recent run. &lt;a href=&quot;https://app.circleci.com/jobs/github/yifan-c/cassandra/214&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/jobs/github/yifan-c/cassandra/214&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17026296" author="yifanc" created="Wed, 29 Jan 2020 23:02:23 +0000"  >&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;br/&gt;
Hopefully, the fix did not change the intention of the test. &lt;/p&gt;</comment>
                            <comment id="17026303" author="benedict" created="Wed, 29 Jan 2020 23:07:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;the reserved capacity is not completely released in each round.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I haven&apos;t looked closely at this test, but I worry that this is unintentional and might indicate a bug.  Do we know why there is unreleased capacity at the end of the test?&lt;/p&gt;</comment>
                            <comment id="17026317" author="yifanc" created="Wed, 29 Jan 2020 23:34:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;Do we know why there is unreleased capacity at the end of the test?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes. At the beginning of each round, new outbound was created with the shared variable &lt;tt&gt;MessagingService#outboundGlobalReserveLimit&lt;/tt&gt;. Why a shared one is used? Because &lt;tt&gt;outboundTemplate&lt;/tt&gt; is created with default, which picks up &lt;tt&gt;MessagingService#outboundGlobalReserveLimit&lt;/tt&gt;. Therefore the acquired capacity from the previous round was counted in the &lt;tt&gt;global&lt;/tt&gt; limit and carried over to the next one. However, the &lt;tt&gt;endpoint&lt;/tt&gt; limit was reset for each round. &lt;/p&gt;</comment>
                            <comment id="17026331" author="benedict" created="Thu, 30 Jan 2020 00:10:26 +0000"  >&lt;p&gt;This doesn&apos;t indicate why there is any unreleased capacity at the end of the test, only why there is some still allocated at the beginning of the next one.&lt;/p&gt;

&lt;p&gt;A reasonable expectation of these tests is that they naturally release any allocated capacity before they complete.  Since the point of the test is to determine if allocation/release is working, artificially releasing any that is still held might mask a bug.&lt;/p&gt;</comment>
                            <comment id="17026338" author="yifanc" created="Thu, 30 Jan 2020 00:28:42 +0000"  >&lt;p&gt;The unreleased capacity at the end of each round is the cause of &quot;there is some still allocated at the beginning of the next one.&quot;&lt;/p&gt;

&lt;p&gt;In the previous version of the test, this round &lt;b&gt;just ended&lt;/b&gt; after asserting the &lt;tt&gt;outbound.pendingBytes()&lt;/tt&gt; equals to the amount of acquired capacity. The pending bytes (i.e. still acquired capacity) were not released. Another potential issue is that if the assertion failed, the pending bytes are not going to be released as well. That is why the releasing is in the &lt;tt&gt;finally&lt;/tt&gt; block.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;A reasonable expectation of these tests is that they naturally release any allocated capacity before they complete.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree. The previous test did not do that (i.e. not releasing the capacity before the round complete). The patch changed the test to have the behavior as you described.&lt;/p&gt;</comment>
                            <comment id="17038682" author="benedict" created="Mon, 17 Feb 2020 23:42:24 +0000"  >&lt;p&gt;I don&apos;t know if I was just expressing myself poorly, but I don&apos;t &lt;em&gt;think&lt;/em&gt; your comment addressed my concern.  However, I&apos;ve taken a look at the test myself and the issue I worried about is not a problem.&lt;/p&gt;

&lt;p&gt;Is there a reason you don&apos;t simply release all remaining capacity, as opposed to looping releasing &lt;tt&gt;acquireStep&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="17038728" author="yifanc" created="Tue, 18 Feb 2020 01:53:46 +0000"  >&lt;p&gt;I got your concern. It was probably mainly that I failed to explain it clearly. IMO, only the test was wrong for not cleaning up the remaining in the &lt;tt&gt;global&lt;/tt&gt; and the same &lt;tt&gt;global&lt;/tt&gt; is referenced in the next run. The &lt;tt&gt;global&lt;/tt&gt; was supposed to be shared. So the implementation looked good to me. Just the test was wrong.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Is there a reason you don&apos;t simply release all remaining capacity, as opposed to looping releasing acquireStep?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;There is no API from &lt;tt&gt;OutboundConnection&lt;/tt&gt; to release all remaining capacity. I do not feel like to add one more method just for testing purpose. Therefore, it uses the existing one and release the capacity by looping.&lt;/p&gt;

&lt;p&gt;There is one potential place that can release all remaining capacity in the &lt;tt&gt;ConnectionTest#doTestManual&lt;/tt&gt; by releasing the &lt;tt&gt;reserveCapacityInBytes&lt;/tt&gt;. But I think it is more proper to clean up the remaining capacity in the test itself. Because only &lt;tt&gt;testAcquireReleaseOutbound&lt;/tt&gt; tests the contention scenario by explicitly acquiring and releasing capacity.&lt;/p&gt;</comment>
                            <comment id="17040244" author="yifanc" created="Wed, 19 Feb 2020 17:07:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; review wanted &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17040291" author="benedict" created="Wed, 19 Feb 2020 18:13:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;There is no API from OutboundConnection to release all remaining capacity&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There isn&apos;t, but we &lt;em&gt;can&lt;/em&gt; know how much we should release, and simply invoke &lt;tt&gt;unsafeReleaseCapacity&lt;/tt&gt; with the amount, no?&lt;/p&gt;

&lt;p&gt;This test could also do with some better comments, such as explaining that we &quot;reserve capacity&quot; before we begin releasing to ensure we cannot release more than we have acquired.  This is particularly important given the misleading comment at the bottom indicating the ability to release more than we acquire (since it only really means more than we acquired concurrently, else we would be at risk of assertion failures)&lt;/p&gt;</comment>
                            <comment id="17040529" author="yifanc" created="Thu, 20 Feb 2020 00:18:50 +0000"  >&lt;p&gt;I pushed a new commit to address the comments. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Comments are added to the test case to describe the what exactly the test does and what the result we expect. A testing method &lt;tt&gt;void unsafeReleaseCapacity(long count, long amount)&lt;/tt&gt; was added to not looping release the remaining capacity. However, it need to be aware that it is a testing method that is located in the production scope. We already have several such methods declared in that class. &lt;/p&gt;

&lt;p&gt;Since they must only be used in test, potentially we can do the below assertion at the start of the methods annotated with &lt;tt&gt;VisibleForTesting&lt;/tt&gt;, or make a new annotation that inserts the assertion. I did not add it in the code. Just mentioned here. &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; Stream.of(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.currentThread().getStackTrace()).map(trace -&amp;gt; trace.getClassName().toLowerCase()).anyMatch(name -&amp;gt; name.contains(&lt;span class=&quot;code-quote&quot;&gt;&quot;test&quot;&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="17041051" author="benedict" created="Thu, 20 Feb 2020 14:54:01 +0000"  >&lt;p&gt;Thanks, it looks good.  I&apos;ve pushed some &lt;a href=&quot;http://github.com/belliottsmith/cassandra/tree/15308-suggest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;minor suggestions&lt;/a&gt; to further improve the test, specifically imposing a bound on the number of failures we witness, and randomising the invocation order of the concurrent operations so as to vary the behaviour a bit more between runs.&lt;/p&gt;</comment>
                            <comment id="17041267" author="yifanc" created="Thu, 20 Feb 2020 19:50:27 +0000"  >&lt;p&gt;Cool. I like the idea of randomizing the invocation order and asserting the failures number upper bound.&lt;/p&gt;

&lt;p&gt;The PR was updated according to the suggestions with several changes made on top of it.&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Declare a fixed &lt;tt&gt;maxFailures&lt;/tt&gt; as upper bound and calculate the &lt;tt&gt;acquireStep&lt;/tt&gt; based on that.&lt;/li&gt;
	&lt;li&gt;Simplified the helper method that randomizes invoke oder.&lt;/li&gt;
	&lt;li&gt;The if/else added to the unsafe method is redundant. It got removed.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17044734" author="dcapwell" created="Tue, 25 Feb 2020 18:43:04 +0000"  >&lt;p&gt;It seems that the try/finally is the actual reason the test is stable and all the other changes are style or improvement to the existing test.  All my comments were nit-picks or style things so I leave it to your discretion; no blocking comments.&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13259322">CASSANDRA-15338</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yifanc]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 38 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z06emw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
        <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12346093">4.0-alpha</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314136" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/abeaa3ea5ef99691cc1b29787cfcd573a90e34fb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;abeaa3ea5ef99691cc1b29787cfcd573a90e34fb&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;unit test and CI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>