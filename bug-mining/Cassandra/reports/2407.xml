<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:40:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5725] Silently failing messages in case of schema not fully propagated</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5725</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When a new keyspace and/or column family is created on a multi nodes cluster (at least three), and then a mutation is executed on such new column family, the operations sometimes silently fails by timing out.&lt;/p&gt;

&lt;p&gt;I tracked this down to the schema not being fully propagated to all nodes. Here&apos;s what happens:&lt;br/&gt;
1) Node 1 receives the create keyspace/column family request.&lt;br/&gt;
2) The same node receives a mutation request at CL.QUORUM and sends to other nodes too.&lt;br/&gt;
3) Upon receiving the mutation request, other nodes try to deserialize it and fail in doing so if the schema is not fully propagated, i.e. because they don&apos;t find the mutated column family.&lt;br/&gt;
4) The connection between node 1 and the failed node is dropped, and the request on the former hangs until timing out.&lt;/p&gt;

&lt;p&gt;Here is the underlying exception, I had to tweak several log levels to get it: &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO 13:11:39,441 IOException reading from socket; closing
org.apache.cassandra.db.UnknownColumnFamilyException: Couldn&apos;t find cfId=a31c7604-0e40-393b-82d7-ba3d910ad50a
	at org.apache.cassandra.db.ColumnFamilySerializer.deserializeCfId(ColumnFamilySerializer.java:184)
	at org.apache.cassandra.db.ColumnFamilySerializer.deserialize(ColumnFamilySerializer.java:94)
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.deserialize(RowMutation.java:397)
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.deserialize(RowMutation.java:407)
	at org.apache.cassandra.db.RowMutation$RowMutationSerializer.deserialize(RowMutation.java:367)
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:94)
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:207)
	at org.apache.cassandra.net.IncomingTcpConnection.handleModernVersion(IncomingTcpConnection.java:139)
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:82)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Finally, there&apos;s probably a correlated failure happening during repairs of newly created/mutated column family, causing the repair process to hang forever as follows:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;&quot;AntiEntropySessions:1&quot; daemon prio=5 tid=7fe981148000 nid=0x11abea000 in Object.wait() [11abe9000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on &amp;lt;7c6200840&amp;gt; (a org.apache.cassandra.utils.SimpleCondition)
	at java.lang.Object.wait(Object.java:485)
	at org.apache.cassandra.utils.SimpleCondition.await(SimpleCondition.java:34)
	- locked &amp;lt;7c6200840&amp;gt; (a org.apache.cassandra.utils.SimpleCondition)
	at org.apache.cassandra.service.AntiEntropyService$RepairSession.runMayThrow(AntiEntropyService.java:695)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:439)
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:895)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:918)
	at java.lang.Thread.run(Thread.java:680)

&quot;http-8983-1&quot; daemon prio=5 tid=7fe97d24d000 nid=0x11a5c8000 in Object.wait() [11a5c6000]
   java.lang.Thread.State: WAITING (on object monitor)
	at java.lang.Object.wait(Native Method)
	- waiting on &amp;lt;7c620db58&amp;gt; (a org.apache.cassandra.utils.SimpleCondition)
	at java.lang.Object.wait(Object.java:485)
	at org.apache.cassandra.utils.SimpleCondition.await(SimpleCondition.java:34)
	- locked &amp;lt;7c620db58&amp;gt; (a org.apache.cassandra.utils.SimpleCondition)
	at org.apache.cassandra.service.StorageService$4.runMayThrow(StorageService.java:2442)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:439)
	at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)
	at java.util.concurrent.FutureTask.run(FutureTask.java:138)
	at org.apache.cassandra.service.StorageService.forceTableRepairRange(StorageService.java:2409)
	at org.apache.cassandra.service.StorageService.forceTableRepair(StorageService.java:2387)
	at com.datastax.bdp.cassandra.index.solr.SolrCoreResourceManager.repairResources(SolrCoreResourceManager.java:693)
	at com.datastax.bdp.cassandra.index.solr.SolrCoreResourceManager.createCore(SolrCoreResourceManager.java:255)
	at com.datastax.bdp.cassandra.index.solr.CassandraCoreAdminHandler.handleCreateAction(CassandraCoreAdminHandler.java:121)
	at org.apache.solr.handler.admin.CoreAdminHandler.handleRequestBody(CoreAdminHandler.java:144)
	at org.apache.solr.handler.RequestHandlerBase.handleRequest(RequestHandlerBase.java:135)
	at org.apache.solr.servlet.SolrDispatchFilter.handleAdminRequest(SolrDispatchFilter.java:615)
	at org.apache.solr.servlet.SolrDispatchFilter.doFilter(SolrDispatchFilter.java:206)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I wasn&apos;t able to track any exception as I can&apos;t reproduce it reliably enough, but I believe it&apos;s correlated to schema propagation as based on log messages the merkle tree request on node 1 happens concurrently to schema installation on other nodes.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12656254">CASSANDRA-5725</key>
            <summary>Silently failing messages in case of schema not fully propagated</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="sureshsajja">Suresh</assignee>
                                    <reporter username="sbtourist">Sergio Bossa</reporter>
                        <labels>
                    </labels>
                <created>Thu, 4 Jul 2013 13:28:32 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:10 +0000</updated>
                            <resolved>Wed, 9 Oct 2013 12:36:49 +0000</resolved>
                                        <fixVersion>1.2.11</fixVersion>
                    <fixVersion>2.0.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13700177" author="jbellis" created="Thu, 4 Jul 2013 16:13:11 +0000"  >&lt;p&gt;This is working as designed.  What do you think should happen instead?&lt;/p&gt;</comment>
                            <comment id="13700187" author="sbtourist" created="Thu, 4 Jul 2013 16:33:48 +0000"  >&lt;p&gt;Well, in an ideal world, given C* has the notion of schema, mutations should be validated with the schema of the coordinator node and associated to such schema version, which should be unique and monotonic (we are the former, not the latter): this way, replica nodes could understand if they&apos;re missing a schema update and request it (which would solve this bug), as well as recognize if a partition is ongoing and react accordingly.&lt;br/&gt;
By the way, this probably translates in using vector clocks for schema updates, and I understand C* has not been designed this way, so let&apos;s forget about the ideal world.&lt;/p&gt;

&lt;p&gt;A more pragmatic solution may be to implement a consistency level for schema updates too: right now we only wait for the schema to be applied on the local node, while supporting all consistency levels would allow subsequent updates to succeed under the same CL specification: i.e., applying a schema update at CL.QUORUM would allow subsequent updates at the same CL to succeed too.&lt;/p&gt;

&lt;p&gt;Finally, a trivial one may just be to make the schema problem explicit with a specific exception.&lt;/p&gt;

&lt;p&gt;Certainly, in my opinion, masking a schema problem with a timeout exception is pretty much confusing, and may lead to several hours spent in debugging/testing or (if the user isn&apos;t that smart to do that) increasing the timeouts, which is a bad solution to a wrong problem.&lt;/p&gt;

&lt;p&gt;Unless I&apos;m missing something in the current design/implementation, which may well be &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13700213" author="jbellis" created="Thu, 4 Jul 2013 16:56:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Finally, a trivial one may just be to make the schema problem explicit with a specific exception.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is not trivial since replicas only ack writes on success.&lt;/p&gt;

&lt;p&gt;Here&apos;s how it&apos;s supposed to work: you perform your schema change, then you check for schema agreement before starting to write to the new table.&lt;/p&gt;</comment>
                            <comment id="13700221" author="sbtourist" created="Thu, 4 Jul 2013 17:05:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;Here&apos;s how it&apos;s supposed to work: you perform your schema change, then you check for schema agreement before starting to write to the new table.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sure, you can do that, but doesn&apos;t look like a great solution to me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;By the way, if any change to fix this is too big at the moment, or really not worth, feel free to close this as won&apos;t fix, we&apos;ll live with this.&lt;/p&gt;</comment>
                            <comment id="13700246" author="jbellis" created="Thu, 4 Jul 2013 17:40:41 +0000"  >&lt;p&gt;IMO the fix here is to special case UnknownColumnFamilyException so that it gets logged at INFO or WARN instead of being swallowed by the default IOException handler, which it currently subclasses.&lt;/p&gt;</comment>
                            <comment id="13700563" author="slebresne" created="Fri, 5 Jul 2013 09:31:28 +0000"  >&lt;blockquote&gt;&lt;p&gt;the fix here is to special case UnknownColumnFamilyException so that it gets logged at INFO or WARN instead of being swallowed by the default IOException handler&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed, at least it&apos;s by far the simplest fix and it&apos;s probably good enough in practice.&lt;/p&gt;

&lt;p&gt;I don&apos;t think getting more fancy is worth the complexity that it would add. &quot;you perform your schema change, then you check for schema agreement before starting to write to the new table&quot; is not that hard a rule to follow, and a good client driver will do that for you under the hood anyway &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; &lt;/p&gt;</comment>
                            <comment id="13701538" author="sbtourist" created="Sun, 7 Jul 2013 09:46:32 +0000"  >&lt;p&gt;Attaching patch.&lt;/p&gt;

&lt;p&gt;I think it&apos;s better to catch a generic Throwable in IncomingTcpConnection, as special casing to UnknownColumnFamilyException means we may find ourselves in the same situation if some other unexpected exception is thrown.&lt;/p&gt;</comment>
                            <comment id="13701648" author="jbellis" created="Sun, 7 Jul 2013 19:46:08 +0000"  >&lt;p&gt;This doesn&apos;t work on two levels:&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;UCFE will still be caught and logged at debug by the IOE clause&lt;/li&gt;
	&lt;li&gt;There&apos;s no need to add a logger.warn for &quot;everything else&quot; because fatal exceptions are logged by the default uncaught exception handler (that is set up in CassandraDaemon)&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13701656" author="sbtourist" created="Sun, 7 Jul 2013 20:15:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;UCFE will still be caught and logged at debug by the IOE clause&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Oh, UCFE actually being an IOE is a bit unexpected. By the way, silly ranting, my fault I didn&apos;t check for it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;There&apos;s no need to add a logger.warn for &quot;everything else&quot; because fatal exceptions are logged by the default uncaught exception handler&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Got it, but my point still stands: by special casing for UCFE, we possibly miss other IOE-derived exceptions and make the IncomingTcpConnection catch block pretty ugly (and wrong actually, as an implementation detail about an exception thrown by an opaque message leaks through).&lt;/p&gt;

&lt;p&gt;At this point, I&apos;d rather log IOEs at info level: what do you think? Or are there too many IOEs during normal C* operations, which would mess up the logs?&lt;/p&gt;</comment>
                            <comment id="13701663" author="jbellis" created="Sun, 7 Jul 2013 20:47:25 +0000"  >&lt;blockquote&gt;&lt;p&gt;are there too many IOEs during normal C* operations, which would mess up the logs?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Exactly (every time you bounce a node, for instance); that&apos;s why we special cased it.&lt;/p&gt;</comment>
                            <comment id="13701668" author="sbtourist" created="Sun, 7 Jul 2013 21:10:00 +0000"  >&lt;p&gt;Then I guess there&apos;s only one thing left ... I&apos;ll update the patch.&lt;/p&gt;</comment>
                            <comment id="13727273" author="jbellis" created="Fri, 2 Aug 2013 03:26:09 +0000"  >&lt;p&gt;Still working on this, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sbtourist&quot; class=&quot;user-hover&quot; rel=&quot;sbtourist&quot;&gt;sbtourist&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13727900" author="sbtourist" created="Fri, 2 Aug 2013 18:05:55 +0000"  >&lt;p&gt;I&apos;m sorry I didn&apos;t have the time to get back to this: if anyone else wants to pick it up, feel free, otherwise I&apos;ll try to update the PR in the next few days.&lt;/p&gt;</comment>
                            <comment id="13790044" author="sureshsajja" created="Wed, 9 Oct 2013 05:35:35 +0000"  >&lt;p&gt;Based on above comments, UnknownColumnFamilyException is handled separately and logged as WARN.&lt;/p&gt;

&lt;p&gt;Patch is attached here for 1.2 branch&lt;/p&gt;</comment>
                            <comment id="13790142" author="sbtourist" created="Wed, 9 Oct 2013 07:53:22 +0000"  >&lt;p&gt;Apologize for not getting back to this one myself.&lt;br/&gt;
Patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="13790303" author="jbellis" created="Wed, 9 Oct 2013 12:36:50 +0000"  >&lt;p&gt;Committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12591120" name="5725-0001.patch" size="1128" author="sbtourist" created="Sun, 7 Jul 2013 09:47:25 +0000"/>
                            <attachment id="12607512" name="5725_V2.patch" size="1710" author="sureshsajja" created="Wed, 9 Oct 2013 05:35:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[sureshsajja]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>336477</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 6 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1m1f3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>336801</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>sbtourist</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[sbtourist]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>