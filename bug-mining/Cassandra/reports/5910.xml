<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:23:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-17205] File leaks will not be be detected and released due to strong self-references in the tidier</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-17205</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;LogTransaction.SSTableTidier holds a reference to a &lt;tt&gt;Tracker&lt;/tt&gt; which holds references to both a &lt;tt&gt;ColumnFamilyStore&lt;/tt&gt; and a &lt;tt&gt;View&lt;/tt&gt;, both of which hold refs to SSTableReaders. As per the comment at the top of the SSTableTidier:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;// must not retain a reference to the SSTableReader, else leak detection cannot kick in&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We shouldn&apos;t hold a reference to the Tracker here; long running unit tests w/-Dcassandra.debugrefcount=true had this pop up.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [Strong-Reference-Leak-Detector:1] 2020-10-27T01:10:12,421 NoSpamLogger.java:97 - Strong self-ref loop detected&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13417510">CASSANDRA-17205</key>
            <summary>File leaks will not be be detected and released due to strong self-references in the tidier</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jmckenzie">Josh McKenzie</assignee>
                                    <reporter username="jmckenzie">Josh McKenzie</reporter>
                        <labels>
                    </labels>
                <created>Tue, 14 Dec 2021 17:16:52 +0000</created>
                <updated>Fri, 27 May 2022 19:25:08 +0000</updated>
                            <resolved>Fri, 17 Dec 2021 16:24:30 +0000</resolved>
                                        <fixVersion>4.1-alpha1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17459347" author="jmckenzie" created="Tue, 14 Dec 2021 17:23:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...josh-mckenzie:cassandra-17205?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/josh-mckenzie/cassandra/151/workflows/ed12dd8c-a3d9-4b87-a895-903132502221&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JDK11 CI&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;Functionally changes in a couple subtle ways:&lt;/p&gt;

&lt;p&gt;Before, we&apos;d assess if the &lt;tt&gt;Tracker&lt;/tt&gt; existed and if the &lt;tt&gt;ColumnFamilyStore&lt;/tt&gt; was valid &lt;b&gt;at time of tidy run&lt;/b&gt;; we instead evaluate now at time of &lt;b&gt;creation&lt;/b&gt; of the &lt;tt&gt;SSTableTidier&lt;/tt&gt;, meaning the &lt;tt&gt;Tracker&lt;/tt&gt; could go out of scope and be otherwise nullified before the two operations that relied on its presence for evaluation.&lt;/p&gt;

&lt;p&gt;Those 2 operations are pretty benign however; clearing the &lt;tt&gt;SSTableReadMeter&lt;/tt&gt; in &lt;tt&gt;system.sstable_activity&lt;/tt&gt;, and decrementing the &lt;tt&gt;totalDiskSpaceUsed&lt;/tt&gt; metric in the &lt;tt&gt;ColumnFamilyStore&lt;/tt&gt;. Both operations we should be able to just try and gracefully fail if the Tracker&apos;s no longer active or valid by time of SSTableTidier run.&lt;/p&gt;

&lt;p&gt;Second, we now grab a reference to the totalDiskSpaceUsed Counter inside the ColumnFamilyStore at time of &lt;tt&gt;SSTableTidier&lt;/tt&gt; creation instead of at run() runtime, meaning we could theoretically hold a handle to a metric on a ColumnFamilyStore that&apos;s dropped in the interim. I don&apos;t &lt;em&gt;think&lt;/em&gt; this should be a problem; the code around releasing metrics in &lt;tt&gt;TableMetrics.releaseMetric&lt;/tt&gt; should still run w/out issue and remove the metric from the top level registry, we&apos;ll just hold a ref to it and operate on the &lt;tt&gt;LongAdder&lt;/tt&gt; in the &lt;tt&gt;Counter&lt;/tt&gt; and then drop the ref to it when the &lt;tt&gt;SSTableTidier&lt;/tt&gt; gets collected.&lt;/p&gt;

&lt;p&gt;So in short: I don&apos;t love it and I&apos;ve commented in the diff around these subtleties, but it sidesteps the current strong ref loop we have to the Tracker.&lt;/p&gt;

&lt;p&gt;Going to give CI a bit to run, make sure things are clean before I find a reviewer.&#160; &#160; &#160;&lt;/p&gt;</comment>
                            <comment id="17459404" author="jmckenzie" created="Tue, 14 Dec 2021 18:40:56 +0000"  >&lt;p&gt;CI looks good except&#160;&lt;tt&gt;TestClientRequestMetricsLocalRemote&lt;/tt&gt; which look both new and to be failing on trunk. Thanks &lt;a href=&quot;https://butler.cassandra.apache.org/#/ci/upstream/compare/Cassandra-trunk/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Butler!&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Going to think for a couple minutes on whether it&apos;s worth it to logically tie this &quot;clear out sstable_activity and clear out &lt;tt&gt;TableMetrics&lt;/tt&gt;&quot; action together or keep it bespoke for the &lt;tt&gt;Tidier&lt;/tt&gt; here...&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Edit: Nope. Literally only used in&#160;&lt;tt&gt;SSTableTidier&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17459409" author="jmckenzie" created="Tue, 14 Dec 2021 18:47:05 +0000"  >&lt;p&gt;One other detail here to call out: this changes from runtime evaluation of whether there&apos;s a Memtable associated with a ColumnFamilyStore to SSTableTidier time creation. Currently in the codebase we don&apos;t create a Tracker w/out a Memtable in it and then later add it; this functionality straddle is there to enable both Online and Offline usage of the same infrastructure, so we should be fine here.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;But it&apos;s a change.&lt;/p&gt;</comment>
                            <comment id="17459954" author="benedict" created="Wed, 15 Dec 2021 13:57:45 +0000"  >&lt;p&gt;We could check &lt;tt&gt;totalDiskSpaceUsed != null &amp;amp;&amp;amp; DatabaseDescriptor.isDaemonInitialized()&lt;/tt&gt; if we can assume that it is always set in the &lt;tt&gt;Metrics&lt;/tt&gt; object (which today it is), to keep functionality equivalent.&lt;/p&gt;

&lt;p&gt;Otherwise LGTM&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jmckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="13163" cascade-level=""><![CDATA[Code]]></customfieldvalue>
                                <customfieldvalue key="13164" cascade-level="1"><![CDATA[Bug - Unclear Impact]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 47 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0xpc8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
        <customfieldvalue><![CDATA[jmckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332955">3.0.0 rc1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commit;h=f4a2135c5ba442aafd27bb7c12c85b376d5a2b87&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commit;h=f4a2135c5ba442aafd27bb7c12c85b376d5a2b87&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;No new testing or documentation needed; discovered by existing long-running testing&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>