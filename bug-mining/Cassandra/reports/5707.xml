<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:20:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16601] Flaky CassandraIndexTest</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16601</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;See failure &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/436/testReport/junit/org.apache.cassandra.index.internal/CassandraIndexTest/indexCorrectlyMarkedAsBuildAndRemoved_cdc/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Error Message

expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;

Stacktrace

junit.framework.AssertionFailedError: expected:&amp;lt;1&amp;gt; but was:&amp;lt;0&amp;gt;
	at org.apache.cassandra.index.internal.CassandraIndexTest.indexCorrectlyMarkedAsBuildAndRemoved(CassandraIndexTest.java:588)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="13372238">CASSANDRA-16601</key>
            <summary>Flaky CassandraIndexTest</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bereng">Berenguer Blasi</assignee>
                                    <reporter username="bereng">Berenguer Blasi</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Apr 2021 08:26:02 +0000</created>
                <updated>Sun, 1 Aug 2021 11:08:04 +0000</updated>
                            <resolved>Thu, 22 Apr 2021 06:06:48 +0000</resolved>
                                        <fixVersion>3.11.11</fixVersion>
                    <fixVersion>4.0-rc1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Test/unit</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="16200">4.5h</timespent>
                                <comments>
                            <comment id="17320875" author="bereng" created="Wed, 14 Apr 2021 10:09:06 +0000"  >&lt;p&gt;Impossible to repro. It happened only once so the fix is based more on intuition than actual deterministic reproduction.&lt;/p&gt;</comment>
                            <comment id="17322106" author="adelapena" created="Thu, 15 Apr 2021 11:32:29 +0000"  >&lt;p&gt;I have managed to reproduce the failure running the entire test class in our internal multiplexer, with 22 failures in 200 runs (&lt;a href=&quot;https://jenkins-dse.build.dsinternal.org/view/Parameterized/job/parameterized-testall/789/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;). Indeed the problem is that the other tests also write entries in the &lt;tt&gt;system.IndexInfo&lt;/tt&gt; table and, since &lt;tt&gt;CQLTester.afterTest&lt;/tt&gt; cleanup is asynchronous, that table can change in any moment. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15565&quot; title=&quot;Fix flaky test org.apache.cassandra.index.internal.CassandraIndexTest indexCorrectlyMarkedAsBuildAndRemoved&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15565&quot;&gt;&lt;del&gt;CASSANDRA-15565&lt;/del&gt;&lt;/a&gt; solved the problem of having indexes from previous tests in the table by taking note of how many indexes were in the table at the beginning of the test. The missed part was that &lt;tt&gt;CQLTester.afterTest&lt;/tt&gt; can remove them in the middle of the test.&lt;/p&gt;

&lt;p&gt;The proposed PR indeed avoids that risk by just checking the specific entry for the tested index, but I think it defeats part of the purpose of the test, which aims to verify that creating, rebuilding and dropping an index doesn&apos;t create unexpected entries in &lt;tt&gt;system.IndexInfo&lt;/tt&gt;. If we wish to not do this check, we should probably get rid of the calls to &lt;tt&gt;assertRowsIgnoringOrderAndExtra&lt;/tt&gt;, the picking of the initial query size (which is always zero), and the comments of the form &lt;tt&gt;&quot;check that there are no other rows in the built indexes table&quot;&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Alternatively, if we want to keep checking that no unexpected entries are added to &lt;tt&gt;system.IndexInfo&lt;/tt&gt;, we should make sure that no other test writes in that table while we do our checks. The simplest way I can think of is making the test a dtest, since those use a dedicated cluster. I gave it a go &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/1efcc5781bdfebc39692da6ea49bfbde7e49f866&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Also, now that we are probably going to get rid of parallel test execution, we could add a method in &lt;tt&gt;CQLTester&lt;/tt&gt; to wait for the cleanup tasks of previous tests, which should guarantee us an empty &lt;tt&gt;system.IndexInfo&lt;/tt&gt;, as it&apos;s done &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/8cf7145b8437f616e8085169cc3829197961031c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. That method could also be helpful for other similar tests, and will allow us to restore the simpler pre-15565 shape of the test.&lt;/p&gt;

&lt;p&gt;wdyt?&lt;/p&gt;</comment>
                            <comment id="17322170" author="bereng" created="Thu, 15 Apr 2021 13:12:56 +0000"  >&lt;p&gt;Ah good I didn&apos;t manage to repro that repeatedly. What about a spinAssert for &lt;tt&gt;IndexInfo&lt;/tt&gt; to be empty at the beginning of the test? :thinking:...&lt;/p&gt;</comment>
                            <comment id="17322182" author="adelapena" created="Thu, 15 Apr 2021 13:29:52 +0000"  >&lt;p&gt;Good idea, &lt;tt&gt;spinAssert&lt;/tt&gt; can also do the trick more easily that waiting for the cleanup tasks, although perhaps it&apos;s less reusable than &lt;tt&gt;waitForSchemaCleanups&lt;/tt&gt;. Anyway, I think both approaches assume that there aren&apos;t other tests running parallely in the same JVM, and we are still discussing in the mail list whether to remove that. I&apos;m not sure whether we should add this test to the ones that don&apos;t work with parallel runners or use the slower but safer dtest approach.&lt;/p&gt;</comment>
                            <comment id="17322610" author="bereng" created="Fri, 16 Apr 2021 04:45:06 +0000"  >&lt;p&gt;I think removal of parallelization is already happening with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16595&quot; title=&quot;Remove test parallelism from ant build.xml in all branches&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16595&quot;&gt;&lt;del&gt;CASSANDRA-16595&lt;/del&gt;&lt;/a&gt; and the follow up tickets. So let me push a &lt;tt&gt;spinAssert&lt;/tt&gt; and multiplex 200 times.&lt;/p&gt;</comment>
                            <comment id="17322765" author="bereng" created="Fri, 16 Apr 2021 10:32:56 +0000"  >&lt;p&gt;Took ages to complete but yep, &lt;tt&gt;spinAssert&lt;/tt&gt; +200 runs seems to work &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17323513" author="adelapena" created="Fri, 16 Apr 2021 11:22:16 +0000"  >&lt;p&gt;Great, with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16595&quot; title=&quot;Remove test parallelism from ant build.xml in all branches&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16595&quot;&gt;&lt;del&gt;CASSANDRA-16595&lt;/del&gt;&lt;/a&gt; merged we can happily wait for the cleanup tasks. Probably &lt;tt&gt;spinAssertEquals&lt;/tt&gt; can be replaced by &lt;tt&gt;Awaitabilty.await()&lt;/tt&gt; to specify a poll delay and save us the try-catch block. Also I still think we should remove most of the changes introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15565&quot; title=&quot;Fix flaky test org.apache.cassandra.index.internal.CassandraIndexTest indexCorrectlyMarkedAsBuildAndRemoved&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15565&quot;&gt;&lt;del&gt;CASSANDRA-15565&lt;/del&gt;&lt;/a&gt; since they are not needed anymore, as it&apos;s done &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/8cf7145b8437f616e8085169cc3829197961031c/test/unit/org/apache/cassandra/index/internal/CassandraIndexTest.java#L567-L584&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17324793" author="bereng" created="Mon, 19 Apr 2021 07:42:49 +0000"  >&lt;p&gt;Latest review comments addressed and 200 runs where ok &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17325834" author="adelapena" created="Tue, 20 Apr 2021 14:28:21 +0000"  >&lt;p&gt;Last changes look good to me, +1&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 30 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0pywo:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[adelapena]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12339541">3.11.x</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/4bfe68717d9a419ab6a0b3a681478b39117dee80&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/commit/b2e897f6a92b931f6f8595a2c0c8d12b04aaf601&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;See PR&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>