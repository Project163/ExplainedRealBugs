<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:12:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-995] restarting node crashes with NPE when, while replaying the commitlog, the cfMetaData is requested</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-995</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Removing the commitlog directory completely fixes this.   I can reliably reproduce it by 1) starting and configuring a schema with one keyspace, one super CF with LongType supercolumns; 2) inserting data; 3) shutting down and restarting the node.&lt;/p&gt;

&lt;p&gt;Here&apos;s my schema expressed in cassidy.pl, should be obvious what the parameters are:&lt;br/&gt;
./cassidy.pl -server X -port Y -keyspace system &apos;kdefine test org.apache.cassandra.locator.RackUnawareStrategy 2 org.apache.cassandra.locator.EndPointSnitch&apos;&lt;br/&gt;
./cassidy.pl -server X -port Y -keyspace test &apos;fdefine Status Super LongType BytesType comment=statuschanges,row_cache_size=0,key_cache_size=20000&apos;&lt;/p&gt;

&lt;p&gt;The problem seems to be related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-44&quot; title=&quot;It is difficult to modify the set of ColumnFamliies in an existing cluster&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-44&quot;&gt;&lt;del&gt;CASSANDRA-44&lt;/del&gt;&lt;/a&gt; as it happens when the CF metadata is requested but I don&apos;t know what&apos;s causing it.&lt;/p&gt;

&lt;p&gt;10/04/16 15:25:11 INFO commitlog.CommitLog: Replaying /home/cassandra/commitlog/CommitLog-1271449410100.log, /home/cassandra/commitlog/CommitLog-1271449378151.log, /home/cassandra/commitlog/CommitLog-1271449415800.log&lt;br/&gt;
java.lang.reflect.InvocationTargetException&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)&lt;br/&gt;
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)&lt;br/&gt;
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)&lt;br/&gt;
        at java.lang.reflect.Method.invoke(Method.java:597)&lt;br/&gt;
        at org.apache.commons.daemon.support.DaemonLoader.load(DaemonLoader.java:160)&lt;br/&gt;
Caused by: java.lang.NullPointerException&lt;br/&gt;
        at org.apache.cassandra.db.Table.&amp;lt;init&amp;gt;(Table.java:261)&lt;br/&gt;
        at org.apache.cassandra.db.Table.open(Table.java:102)&lt;br/&gt;
        at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:233)&lt;br/&gt;
        at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:172)&lt;br/&gt;
        at org.apache.cassandra.thrift.CassandraDaemon.setup(CassandraDaemon.java:104)&lt;br/&gt;
        at org.apache.cassandra.thrift.CassandraDaemon.init(CassandraDaemon.java:151)&lt;br/&gt;
        ... 5 more&lt;/p&gt;</description>
                <environment>&lt;p&gt;SVN rev 935070&lt;/p&gt;</environment>
        <key id="12462287">CASSANDRA-995</key>
            <summary>restarting node crashes with NPE when, while replaying the commitlog, the cfMetaData is requested</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gdusbabek">Gary Dusbabek</assignee>
                                    <reporter username="tzz">Ted Zlatanov</reporter>
                        <labels>
                    </labels>
                <created>Fri, 16 Apr 2010 20:31:58 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:25 +0000</updated>
                            <resolved>Wed, 21 Apr 2010 13:51:56 +0000</resolved>
                                        <fixVersion>0.7 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12857962" author="jbellis" created="Fri, 16 Apr 2010 20:39:38 +0000"  >&lt;p&gt;If this is just saying that &quot;I can&apos;t replay a commitlog written before -44, after applying 44 and restarting,&quot; then that is expected.  Use nodetool drain before upgrading (or simply r/m the commitlog as you say).&lt;/p&gt;</comment>
                            <comment id="12857965" author="tzz" created="Fri, 16 Apr 2010 20:45:45 +0000"  >&lt;p&gt;I wouldn&apos;t report it as a bug if it wasn&apos;t on a commitlog written by the same version of the software.  All the steps (1,2,3) are on the same SVN revision I stated in the Environment section.&lt;/p&gt;</comment>
                            <comment id="12857993" author="tzz" created="Fri, 16 Apr 2010 21:11:03 +0000"  >&lt;p&gt;This is the complete log.  First start is fresh without commitlog or data.  Second start is after shutting down completely by killing jsvc (through /etc/init.d/cassandra restart on a Debian system).&lt;/p&gt;</comment>
                            <comment id="12858007" author="tzz" created="Fri, 16 Apr 2010 21:19:05 +0000"  >&lt;p&gt;My complete schema, although only Status and Property are used.  Sorry I edited the original but it was not substantially different.&lt;/p&gt;

&lt;p&gt;./cassidy.pl -server X -port 9170 -keyspace system &apos;kdefine HB3-prod org.apache.cassandra.locator.RackUnawareStrategy 2 org.apache.cassandra.locator.EndPointSnitch&apos;&lt;br/&gt;
./cassidy.pl -server X -port 9170 -keyspace HB3-prod &apos;fdefine Status Super LongType BytesType comment=statuschanges,row_cache_size=0,key_cache_size=20000&apos;&lt;br/&gt;
./cassidy.pl -server X -port 9170 -keyspace HB3-prod &apos;fdefine Property Super LongType BytesType comment=statuschanges,row_cache_size=0,key_cache_size=20000&apos;&lt;br/&gt;
./cassidy.pl -server X -port 9170 -keyspace HB3-prod &apos;fdefine Analysis Super LongType BytesType comment=statuschanges,row_cache_size=0,key_cache_size=20000&apos;&lt;br/&gt;
./cassidy.pl -server X -port 9170 -keyspace HB3-prod &apos;fdefine Relationships Super LongType BytesType comment=statuschanges,row_cache_size=0,key_cache_size=20000&apos;&lt;br/&gt;
./cassidy.pl -server X -port 9170 -keyspace HB3-prod &apos;fdefine Knowledge Super LongType BytesType comment=statuschanges,row_cache_size=0,key_cache_size=20000&apos;&lt;/p&gt;

&lt;p&gt;./cassidy.pl -server X -port 9170 -keyspace system &apos;kdefine CM org.apache.cassandra.locator.RackUnawareStrategy 2 org.apache.cassandra.locator.EndPointSnitch&apos;&lt;br/&gt;
./cassidy.pl -server X -port 9170 -keyspace CM &apos;fdefine Inventory Super LongType BytesType comment=statuschanges,row_cache_size=0,key_cache_size=20000&apos;&lt;/p&gt;

&lt;p&gt;When I tried to trigger the error manually with cassidy with just a few inserts like this (the below inserts test=abc into SC 0 in the Status CF):&lt;/p&gt;

&lt;p&gt;./cassidy.pl -server X -port 9170 -keyspace HB3-prod &apos;ins Status testkey 0 test=abc&apos;&lt;br/&gt;
./cassidy.pl -server X -port 9170 -keyspace HB3-prod &apos;get Status testkey 0&apos;&lt;/p&gt;

&lt;p&gt;the problem doesn&apos;t happen.  I don&apos;t know how much data causes it.  My typical writes that trigger this, over a minute, are about 20-30 columns per supercolumn, about 2500 keys, about 5 SCs per key.  I can reliably trigger it with a one-minute population run.&lt;/p&gt;

&lt;p&gt;Thanks and I hope this is enough information to replicate the bug.  If not I&apos;ll try to give you more including a better test case.&lt;/p&gt;</comment>
                            <comment id="12858037" author="gdusbabek" created="Fri, 16 Apr 2010 22:29:23 +0000"  >&lt;p&gt;I couldn&apos;t reproduce this.  run_1.txt is a log from defining a KS with a SC and then inserting 100 rows.  run_2.txt is what happens after a restart.&lt;/p&gt;

&lt;p&gt;Ted, can you reproduce this outside of cassidy.pl?&lt;/p&gt;</comment>
                            <comment id="12858548" author="tzz" created="Mon, 19 Apr 2010 15:12:52 +0000"  >&lt;p&gt;I&apos;m working on replicating the inserts I do from Perl but so far haven&apos;t been able to replicate in Java.  I&apos;ll keep trying.&lt;/p&gt;</comment>
                            <comment id="12858588" author="tzz" created="Mon, 19 Apr 2010 16:43:07 +0000"  >&lt;p&gt;OK, I can prepare a proper test if you need it but the atteched Tester.java definitely causes the NPE and should work with minor changes for you (makeOpenLoginClient and getLongAsBytes are really simple helper methods).  I do &quot;sudo /etc/init.d/cassandra stop; rm -rf *; sudo /etc/init.d/cassandra start&quot;, run the test, then &quot;sudo /etc/init.d/cassandra restart&quot; and get the NPE I showed earlier.  This is with today&apos;s SVN (r935659).&lt;/p&gt;

&lt;p&gt;It definitely is a combination of the number of keyspaces and CFs together with the number of inserts.  If I do less that 1000 iterations or if I define fewer CFs and keyspaces, the problem doesn&apos;t happen on restart.  So it took me a long time to hunt it down.&lt;/p&gt;</comment>
                            <comment id="12858650" author="gdusbabek" created="Mon, 19 Apr 2010 19:34:24 +0000"  >&lt;p&gt;Thanks Ted.  I can reproduce this problem now.&lt;/p&gt;</comment>
                            <comment id="12858900" author="gdusbabek" created="Tue, 20 Apr 2010 14:23:50 +0000"  >&lt;p&gt;Migration code was only storing the most recently modified keyspace when recording a migration instead of all of them.&lt;/p&gt;</comment>
                            <comment id="12858952" author="jbellis" created="Tue, 20 Apr 2010 16:01:00 +0000"  >&lt;p&gt;+1 except don&apos;t commit the .iml &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12858965" author="tzz" created="Tue, 20 Apr 2010 17:00:59 +0000"  >&lt;p&gt;I tested and the fix works for me. Thank you.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12442298" name="0001-include-all-keyspaces-when-creating-the-schema-migra.patch" size="4648" author="gdusbabek" created="Tue, 20 Apr 2010 14:23:49 +0000"/>
                            <attachment id="12442299" name="0002-Use-RackUnawareStrategy-in-unit-tests-because-it-doe.patch" size="4307" author="gdusbabek" created="Tue, 20 Apr 2010 14:23:49 +0000"/>
                            <attachment id="12442006" name="ASF.LICENSE.NOT.GRANTED--crashlog-995" size="21053" author="tzz" created="Fri, 16 Apr 2010 21:11:03 +0000"/>
                            <attachment id="12442014" name="ASF.LICENSE.NOT.GRANTED--run_1.txt" size="16704" author="gdusbabek" created="Fri, 16 Apr 2010 22:29:23 +0000"/>
                            <attachment id="12442015" name="ASF.LICENSE.NOT.GRANTED--run_2.txt" size="26411" author="gdusbabek" created="Fri, 16 Apr 2010 22:29:23 +0000"/>
                            <attachment id="12442199" name="Tester.java" size="3544" author="tzz" created="Mon, 19 Apr 2010 16:46:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[gdusbabek]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19946</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g2cv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91812</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>