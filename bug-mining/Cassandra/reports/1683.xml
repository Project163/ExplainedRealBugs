<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:33:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4396] Subcolumns not removed when compacting tombstoned super column</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4396</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When we compact a tombstone for a super column with the old data for that super column, we end up writing the deleted super column and all the subcolumn data that is now worthless to the new sstable. This is especially inefficient when reads need to scan tombstones during a slice.&lt;/p&gt;

&lt;p&gt;Here is the output of a simple test I ran to confirm:&lt;/p&gt;

&lt;p&gt;insert supercolumn, then flush&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Nicks-MacBook-Pro:12:20:52 cassandra-1.0] cassandra$ bin/sstable2json ~/.ccm/1node/node1/data/Keyspace2/Super4-hd-1-Data.db 
{
&quot;6b657931&quot;: {&quot;supercol1&quot;: {&quot;deletedAt&quot;: -9223372036854775808, &quot;subColumns&quot;: [[&quot;737562636f6c31&quot;,&quot;7468697320697320612074657374&quot;,1340990212532000]]}}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;delete supercolumn, flush again&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[Nicks-MacBook-Pro:12:20:59 cassandra-1.0] cassandra$ bin/nodetool -h localhost flush
[Nicks-MacBook-Pro:12:22:41 cassandra-1.0] cassandra$ bin/sstable2json ~/.ccm/1node/node1/data/Keyspace2/Super4-hd-2-Data.db 
{
&quot;6b657931&quot;: {&quot;supercol1&quot;: {&quot;deletedAt&quot;: 1340990544005000, &quot;subColumns&quot;: []}}
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;compact and check resulting sstable&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[Nicks-MacBook-Pro:12:22:55 cassandra-1.0] cassandra$ bin/nodetool -h localhost compact 
[Nicks-MacBook-Pro:12:23:09 cassandra-1.0] cassandra$ bin/sstable2json ~/.ccm/1node/node1/data/Keyspace2/Super4-hd-3-Data.db 
{
&quot;6b657931&quot;: {&quot;supercol1&quot;: {&quot;deletedAt&quot;: 1340990544005000, &quot;subColumns&quot;: [[&quot;737562636f6c31&quot;,&quot;7468697320697320612074657374&quot;,1340990212532000]]}}
}
[Nicks-MacBook-Pro:12:23:20 cassandra-1.0] cassandra$ 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12596424">CASSANDRA-4396</key>
            <summary>Subcolumns not removed when compacting tombstoned super column</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="nickmbailey">Nick Bailey</reporter>
                        <labels>
                            <label>compaction</label>
                    </labels>
                <created>Fri, 29 Jun 2012 17:34:59 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:31 +0000</updated>
                            <resolved>Tue, 10 Jul 2012 13:36:00 +0000</resolved>
                                        <fixVersion>1.0.11</fixVersion>
                    <fixVersion>1.1.3</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13404077" author="jbellis" created="Fri, 29 Jun 2012 18:04:15 +0000"  >&lt;p&gt;This code in removeDeletedSuper is intended to address this scenario:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;.               &lt;span class=&quot;code-comment&quot;&gt;// remove subcolumns &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// (a) the subcolumn itself is tombstoned or
&lt;/span&gt;                &lt;span class=&quot;code-comment&quot;&gt;// (b) the supercolumn is tombstoned and the subcolumn is not newer than it
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (subColumn.timestamp() &amp;lt;= minTimestamp
                    || subColumn.getLocalDeletionTime() &amp;lt; gcBefore)
                {
                    subIter.remove();
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Unclear why it&apos;s not actually working here.&lt;/p&gt;</comment>
                            <comment id="13404238" author="nickmbailey" created="Fri, 29 Jun 2012 21:43:15 +0000"  >&lt;p&gt;This is also a problem with simply flushing super column deletes:&lt;/p&gt;

&lt;p&gt;From a fresh cluster I can create a supercolumn with subcolumns, delete that supercolumn, trigger a flush with nodetool, and observe the subcolumn data in the flushed sstable with sstable2json.&lt;/p&gt;</comment>
                            <comment id="13404265" author="jbellis" created="Fri, 29 Jun 2012 22:04:45 +0000"  >&lt;p&gt;I&apos;m okay with not calling removeDeleted on flush, in fact I think it&apos;s probably the right tradeoff given that the extra overhead will be a no-op most of the time, but compaction should definitely evict it.&lt;/p&gt;</comment>
                            <comment id="13404296" author="jbellis" created="Fri, 29 Jun 2012 23:01:50 +0000"  >&lt;p&gt;This was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3234&quot; title=&quot;LeveledCompaction has several performance problems&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3234&quot;&gt;&lt;del&gt;CASSANDRA-3234&lt;/del&gt;&lt;/a&gt;.  Fix attached to allow dropping columns shadowed by supercolumn (and row) tombstones that are not yet expired.&lt;/p&gt;

&lt;p&gt;Reducing gcgs is one way to work around the problem without this patch.  This only affects in-memory compactions, so reducing in_memory_compaction_limit_in_mb could also mitigate it.&lt;/p&gt;</comment>
                            <comment id="13404912" author="slebresne" created="Mon, 2 Jul 2012 07:00:25 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13404930" author="jbellis" created="Mon, 2 Jul 2012 08:05:05 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13408381" author="nickmbailey" created="Fri, 6 Jul 2012 21:52:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; I still see the same behavior with this patch applied. Major compaction of an sstable with subcolumns and an sstable with a tombstone for the relevant super column, produces a new sstable with the super column tombstoned but the subcolumns still present.&lt;/p&gt;</comment>
                            <comment id="13408423" author="jbellis" created="Fri, 6 Jul 2012 23:02:43 +0000"  >&lt;p&gt;patch to fix mixing user-provided timestamps and local deletion time.  includes unit test.&lt;/p&gt;</comment>
                            <comment id="13408425" author="jbellis" created="Fri, 6 Jul 2012 23:03:29 +0000"  >&lt;p&gt;(also fixes &amp;lt; to &amp;lt;=)&lt;/p&gt;</comment>
                            <comment id="13408428" author="jbellis" created="Fri, 6 Jul 2012 23:05:20 +0000"  >&lt;p&gt;patch is against 1.0, merging to trunk fixed the bug there...&lt;/p&gt;</comment>
                            <comment id="13408470" author="ctrahman" created="Sat, 7 Jul 2012 00:12:11 +0000"  >&lt;p&gt;v2 is working here - thanks!&lt;/p&gt;</comment>
                            <comment id="13410210" author="slebresne" created="Tue, 10 Jul 2012 10:19:36 +0000"  >&lt;p&gt;v2 lgtm, +1.&lt;/p&gt;</comment>
                            <comment id="13410333" author="jbellis" created="Tue, 10 Jul 2012 13:36:00 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12535455" name="4396-2.txt" size="3712" author="jbellis" created="Fri, 6 Jul 2012 23:02:43 +0000"/>
                            <attachment id="12534068" name="4396.txt" size="4326" author="jbellis" created="Fri, 29 Jun 2012 23:01:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256124</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 20 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gvf3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96520</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>