<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:07:13 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13354] LCS estimated compaction tasks does not take number of files into account</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13354</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In LCS, the way we estimate number of compaction tasks remaining for L0 is by taking the size of a SSTable and multiply it by four. This would give 4*160mb with default settings. This calculation is used to determine whether repaired or repaired data is being compacted.&lt;/p&gt;

&lt;p&gt;Now this works well until you take repair into account. Repair streams over many many sstables which could be smaller than the configured SSTable size depending on your use case. In our case we are talking about many thousands of tiny SSTables. As number of files increases one can run into any number of problems, including GC issues, too many open files or plain increase in read latency.&lt;/p&gt;

&lt;p&gt;With the current algorithm we will choose repaired or unrepaired depending on whichever side has more data in it. Even if the repaired files outnumber the unrepaired files by a large margin.&lt;/p&gt;

&lt;p&gt;Similarily, our algorithm that selects compaction candidates takes up to 32 SSTables at a time in L0, however our estimated task calculation does not take this number into account. These two mechanisms should be aligned with each other.&lt;/p&gt;

&lt;p&gt;I propose that we take the number of files in L0 into account when estimating remaining tasks. &lt;/p&gt;</description>
                <environment>&lt;p&gt;Cassandra 2.2.9&lt;/p&gt;</environment>
        <key id="13057554">CASSANDRA-13354</key>
            <summary>LCS estimated compaction tasks does not take number of files into account</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Jan Karlsson">Jan Karlsson</assignee>
                                    <reporter username="Jan Karlsson">Jan Karlsson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 20 Mar 2017 15:12:59 +0000</created>
                <updated>Wed, 15 Oct 2025 09:49:05 +0000</updated>
                            <resolved>Fri, 7 Apr 2017 10:57:10 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="15932799" author="jan karlsson" created="Mon, 20 Mar 2017 15:16:02 +0000"  >&lt;p&gt;Added patch on 4.0 to fix this. Applies cleanly to other versions as well(tested 2.2.9).&lt;br/&gt;
I have tested this in a cluster and will upload some graphs as well.&lt;br/&gt;
Comments and suggestions welcome!&lt;/p&gt;</comment>
                            <comment id="15939107" author="jan karlsson" created="Thu, 23 Mar 2017 19:47:01 +0000"  >&lt;p&gt;I did some tests simulating traffic on a 4 node cluster. 2 of the nodes were running with my patch while the other two ran without it.&lt;br/&gt;
Steps to reproduce:&lt;br/&gt;
Traffic on&lt;br/&gt;
Turn one of the nodes off&lt;br/&gt;
Wait 7 minutes&lt;br/&gt;
Truncate hints on all other nodes&lt;br/&gt;
Turn node on&lt;br/&gt;
Run repair on the node&lt;/p&gt;

&lt;p&gt;As you can see the unpatched version kept increasing as non-repaired data from ongoing traffic was prioritized. If I had more discrepancies in my data set, this would just increase to the configured FD limit or until you die from heap pressure.&lt;/p&gt;

&lt;p&gt;Repair is completed at 8:11pm but those small repaired files are not compacted as it picks unrepaired new sstables over the small repaired sstables. However, it did show a downwards trend as compaction was slightly faster than insertion and would probably eventually end with the repaired files compacted.&lt;/p&gt;

&lt;p&gt;During the unpatched test, it only showed 2 pending compactions with 22k~ file descriptors open/10k~ sstables. At 8:33pm I disabled the traffic completely to hurry this along.&lt;br/&gt;
SSTables in each level: &lt;span class=&quot;error&quot;&gt;&amp;#91;10347/4, 5, 0, 0, 0, 0, 0, 0, 0&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="15959691" author="jmckenzie" created="Thu, 6 Apr 2017 20:29:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;: have bandwidth for review on this one?&lt;/p&gt;</comment>
                            <comment id="15960380" author="krummas" created="Fri, 7 Apr 2017 07:03:34 +0000"  >&lt;p&gt;patch lgtm, I just pushed a tiny nit here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/13354&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/13354&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m running dtests, not unlikely that some test relies on the old calculations, will commit if tests look good and you agree with my small change &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Jan+Karlsson&quot; class=&quot;user-hover&quot; rel=&quot;Jan Karlsson&quot;&gt;Jan Karlsson&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15960403" author="jan karlsson" created="Fri, 7 Apr 2017 07:19:22 +0000"  >&lt;p&gt;yes small change lgtm&lt;/p&gt;</comment>
                            <comment id="15960604" author="krummas" created="Fri, 7 Apr 2017 10:57:10 +0000"  >&lt;p&gt;committed, thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12859578" name="13354-trunk.txt" size="1223" author="Jan Karlsson" created="Mon, 20 Mar 2017 15:43:36 +0000"/>
                            <attachment id="12860216" name="patchedTest.png" size="41135" author="Jan Karlsson" created="Thu, 23 Mar 2017 19:41:44 +0000"/>
                            <attachment id="12860217" name="unpatchedTest.png" size="35453" author="Jan Karlsson" created="Thu, 23 Mar 2017 19:42:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[Jan Karlsson]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310250" key="com.atlassian.jira.plugin.system.customfieldtypes:multicheckboxes">
                        <customfieldname>Flags</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="10430"><![CDATA[Patch]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 32 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3cir3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12338318">2.2.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>