<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:03 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6086] Node refuses to start with exception in ColumnFamilyStore.removeUnfinishedCompactionLeftovers when find that some to be removed files are already removed</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6086</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Node refuses to start with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Caused by: java.lang.IllegalStateException: Unfinished compactions reference missing sstables. This should never happen since compactions are marked finished before we start removing the old sstables.
      at org.apache.cassandra.db.ColumnFamilyStore.removeUnfinishedCompactionLeftovers(ColumnFamilyStore.java:544)
      at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:262)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;IMO, there is no reason to refuse to start discivering files that must be removed are already removed. It looks like pure bug diagnostic code and mean nothing to operator (nor he can do anything about this).&lt;/p&gt;

&lt;p&gt;Replaced throw of excepion with dump of diagnostic warning and continue startup.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12670272">CASSANDRA-6086</key>
            <summary>Node refuses to start with exception in ColumnFamilyStore.removeUnfinishedCompactionLeftovers when find that some to be removed files are already removed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="m0nstermind">Oleg Anastasyev</reporter>
                        <labels>
                    </labels>
                <created>Tue, 24 Sep 2013 13:30:48 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:04 +0000</updated>
                            <resolved>Mon, 30 Dec 2013 20:05:27 +0000</resolved>
                                        <fixVersion>2.0.5</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="13776390" author="yukim" created="Tue, 24 Sep 2013 15:31:46 +0000"  >&lt;p&gt;The primary reason we have removeUnfinishedCompacitonLeftovers check is to not overcount counters stored.&lt;br/&gt;
If we do not stop at the original exception, then we will have both compacted SSTables and leftovers which may produce unexpected counter value.&lt;/p&gt;

&lt;p&gt;Though we have the report that &quot;this happens&quot;(&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6008&quot; title=&quot;Getting &amp;#39;This should never happen&amp;#39; error at startup due to sstables missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6008&quot;&gt;&lt;del&gt;CASSANDRA-6008&lt;/del&gt;&lt;/a&gt;), we should fix somehow.&lt;br/&gt;
Maybe we can consider compaction is finished even if we have entry in compactions_in_progress but some or all of the input SSTables are missing.&lt;/p&gt;</comment>
                            <comment id="13776424" author="m0nstermind" created="Tue, 24 Sep 2013 16:06:46 +0000"  >&lt;p&gt;Well, the common with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6008&quot; title=&quot;Getting &amp;#39;This should never happen&amp;#39; error at startup due to sstables missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6008&quot;&gt;&lt;del&gt;CASSANDRA-6008&lt;/del&gt;&lt;/a&gt; is that in my case node was dead before restart due to OOM. However, unlike 6008, CFs on which it reported this error was never truncated.&lt;/p&gt;</comment>
                            <comment id="13776428" author="m0nstermind" created="Tue, 24 Sep 2013 16:09:58 +0000"  >&lt;p&gt;From the other hand, the leftovers about to remove are already missing (i.e. already removed) when exception is thrown. I am not sure how can it  influence counter value.&lt;/p&gt;</comment>
                            <comment id="13789411" author="yukim" created="Tue, 8 Oct 2013 17:21:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;From the other hand, the leftovers about to remove are already missing (i.e. already removed) when exception is thrown.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Is this the case that, for example, you have SSTable &apos;C&apos; that is produced from compacting SSTables &apos;A&apos; and &apos;B&apos;(&apos;C&apos; has ancestors &apos;A&apos; and &apos;B&apos;), and &apos;A&apos; and &apos;B&apos; are already deleted, but removeUnfinishedCompactionLeftovers reports you have unfinished compaction of &apos;A&apos; and &apos;B&apos;?&lt;/p&gt;

&lt;p&gt;In above case, you definitely don&apos;t want to proceed, since the code tries remove SSTable &apos;C&apos; afterwards.&lt;br/&gt;
Patch v2 is attached to prevent deleting SSTable if its ancestors are already missing after printing warning.&lt;/p&gt;

&lt;p&gt;(I&apos;m still looking for the case why the above happened though. We supposed not to have entries in compaction_in_progress when those are removed.)&lt;/p&gt;</comment>
                            <comment id="13797976" author="cowardlydragon" created="Thu, 17 Oct 2013 15:04:38 +0000"  >&lt;p&gt;Well, how would one repair this for now, beyond reconstructing a virgin node and then replication? If there are counters, certainly you could provide an option for an admin to reset them or accept invalid values and get access to the rest of the data, or mark it in some (tombstone-ish?) way that other nodes with more accurate values for the counters can then replicate the correct state?&lt;/p&gt;

&lt;p&gt;And yes, we just got this.&lt;/p&gt;</comment>
                            <comment id="13797977" author="ngrigoriev" created="Thu, 17 Oct 2013 15:08:13 +0000"  >&lt;p&gt;@Constance,&lt;/p&gt;

&lt;p&gt;I was able to repair my node - see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6008&quot; title=&quot;Getting &amp;#39;This should never happen&amp;#39; error at startup due to sstables missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6008&quot;&gt;&lt;del&gt;CASSANDRA-6008&lt;/del&gt;&lt;/a&gt;. Used the suggestion I received + had to add some flavor to it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13817757" author="jre" created="Fri, 8 Nov 2013 22:26:09 +0000"  >&lt;p&gt;Hi, we are able to consistently reproduce this issue:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR 23:14:06,001 Exception encountered during startup
java.lang.IllegalStateException: Unfinished compactions reference missing sstables. This should never happen since compactions are marked finished before we start removing the old sstables.
       at org.apache.cassandra.db.ColumnFamilyStore.removeUnfinishedCompactionLeftovers(ColumnFamilyStore.java:489)
       at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:264)
       at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:461)
       at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:504)
java.lang.IllegalStateException: Unfinished compactions reference missing sstables. This should never happen since compactions are marked finished before we start removing the old sstables.
       at org.apache.cassandra.db.ColumnFamilyStore.removeUnfinishedCompactionLeftovers(ColumnFamilyStore.java:489)
       at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:264)
       at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:461)
       at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:504)
Exception encountered during startup: Unfinished compactions reference missing sstables. This should never happen since compactions are marked finished before we start removing the old sstables.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Here are the two ways in which we have found to reproduce this issue:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Buffer a large amount of CL.LOCAL_QUORUM writes into a Cassandra CF, then drop the CF while the writes are still buffered.&lt;/li&gt;
	&lt;li&gt;Buffer a large amount of CL.LOCAL_QUORUM writes into a Cassandra CF, then restart some nodes while before the buffer has finished draining.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13826686" author="yukim" created="Tue, 19 Nov 2013 17:14:31 +0000"  >&lt;p&gt;Rebased patch against cassandra-2.0 attached.&lt;/p&gt;

&lt;p&gt;Again, the patch changes log ERROR and stop starting C* to print WARN but prevent deleting SSTable if its ancestors are already missing.&lt;/p&gt;</comment>
                            <comment id="13845701" author="thobbs" created="Wed, 11 Dec 2013 20:21:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; the patch looks pretty good.  Can you add a test like &lt;tt&gt;ColumnFamilyStoreTest.testRemoveUnifinishedCompactionLeftovers()&lt;/tt&gt; to cover this?  Also, warning logs should either suggest an action or let the user know that no action is required; in this case, we should tell the user to report the issue but that no corrective action is needed.&lt;/p&gt;</comment>
                            <comment id="13850854" author="yukim" created="Tue, 17 Dec 2013 20:23:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; Added test and slightly changed message: &lt;a href=&quot;https://github.com/yukim/cassandra/commits/6086&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yukim/cassandra/commits/6086&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;m not good at wording, so suggestion is welcome.&lt;/p&gt;</comment>
                            <comment id="13853486" author="thobbs" created="Thu, 19 Dec 2013 23:58:45 +0000"  >&lt;p&gt;The v3 patch (and &lt;a href=&quot;https://github.com/thobbs/cassandra/tree/6086&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;) builds on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt;&apos;s v2 patch and adds incremental deletions of entries in &lt;tt&gt;compactions_in_progress&lt;/tt&gt; as discussed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6008&quot; title=&quot;Getting &amp;#39;This should never happen&amp;#39; error at startup due to sstables missing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6008&quot;&gt;&lt;del&gt;CASSANDRA-6008&lt;/del&gt;&lt;/a&gt;.  Additionally, this move the warning log to debug level, since there&apos;s not anything the user can do or should do.&lt;/p&gt;</comment>
                            <comment id="13859043" author="yukim" created="Mon, 30 Dec 2013 20:05:28 +0000"  >&lt;p&gt;Thanks Tyler, committed.&lt;br/&gt;
(I removed LegacyLeveledManifest related change in trunk since it no longer exists.)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12668155">CASSANDRA-6008</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12619699" name="6086-2.0-v3.txt" size="18687" author="thobbs" created="Thu, 19 Dec 2013 23:58:45 +0000"/>
                            <attachment id="12614653" name="6086-v2.txt" size="2504" author="yukim" created="Tue, 19 Nov 2013 17:14:31 +0000"/>
                            <attachment id="12604794" name="removeUnfinishedCompactionLeftovers.txt" size="2101" author="m0nstermind" created="Tue, 24 Sep 2013 13:31:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>350101</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 47 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1od6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>350395</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324629">2.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>