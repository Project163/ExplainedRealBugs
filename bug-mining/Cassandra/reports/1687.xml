<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:33:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3881] reduce computational complexity of processing topology changes</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3881</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This constitutes follow-up work from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3831&quot; title=&quot;scaling to large clusters in GossipStage impossible due to calculatePendingRanges &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3831&quot;&gt;&lt;del&gt;CASSANDRA-3831&lt;/del&gt;&lt;/a&gt; where a partial improvement was committed, but the fundamental issue was not fixed. The maximum &quot;practical&quot; cluster size was significantly improved, but further work is expected to be necessary as cluster sizes grow.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Edit0: Appended patch information.&lt;/em&gt;&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Patches&quot;&gt;&lt;/a&gt;Patches&lt;/h3&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Compare&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Raw diff&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Description&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/acunu/cassandra/compare/refs/top-bases/p/3881/00_snitch_topology...p/3881/00_snitch_topology&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;00_snitch_topology&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/acunu/cassandra/compare/refs/top-bases/p/3881/00_snitch_topology...p/3881/00_snitch_topology.diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;00_snitch_topology.patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Adds some functionality to TokenMetadata to track which endpoints and racks exist in a DC.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/acunu/cassandra/compare/refs/top-bases/p/3881/01_calc_natural_endpoints...p/3881/01_calc_natural_endpoints&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;01_calc_natural_endpoints&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/acunu/cassandra/compare/refs/top-bases/p/3881/01_calc_natural_endpoints...p/3881/01_calc_natural_endpoints.diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;01_calc_natural_endpoints.patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Rewritten O(logN) implementation of calculateNaturalEndpoints using the topology information from the tokenMetadata.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;hr /&gt;

&lt;p&gt;&lt;em&gt;Note: These are branches managed with TopGit. If you are applying the patch output manually, you will either need to filter the TopGit metadata files (i.e. &lt;tt&gt;wget -O - &amp;lt;url&amp;gt; | filterdiff -x*.topdeps -x*.topmsg | patch -p1&lt;/tt&gt;), or remove them afterward (&lt;tt&gt;rm .topmsg .topdeps&lt;/tt&gt;).&lt;/em&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12541955">CASSANDRA-3881</key>
            <summary>reduce computational complexity of processing topology changes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="soverton">Sam Overton</assignee>
                                    <reporter username="scode">Peter Schuller</reporter>
                        <labels>
                            <label>vnodes</label>
                    </labels>
                <created>Thu, 9 Feb 2012 10:31:09 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:40 +0000</updated>
                            <resolved>Tue, 3 Jul 2012 18:24:24 +0000</resolved>
                                        <fixVersion>1.2.0 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13216604" author="scode" created="Sun, 26 Feb 2012 01:26:05 +0000"  >&lt;p&gt;Even with post-&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3831&quot; title=&quot;scaling to large clusters in GossipStage impossible due to calculatePendingRanges &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3831&quot;&gt;&lt;del&gt;CASSANDRA-3831&lt;/del&gt;&lt;/a&gt; code, the need here is great. When bootstrapping a new node into a pre-existing cluster of 200+ nodes, the time it takes being CPU bound in gossip stage on the node being bootstrapped, is so large that we&apos;re close to seeing it initiate the bootstrap streaming process before being done CPU spinning i gossip stage.&lt;/p&gt;

&lt;p&gt;We&apos;re increasing the bootstrap wait delay for now to work around this.&lt;/p&gt;</comment>
                            <comment id="13216605" author="scode" created="Sun, 26 Feb 2012 01:26:56 +0000"  >&lt;p&gt;Another work-around that is still hacky is to wait for the gossip stage pending to also be 0, after waiting for the ring delay, before proceeding with bootstrap.&lt;/p&gt;</comment>
                            <comment id="13216607" author="scode" created="Sun, 26 Feb 2012 01:32:22 +0000"  >&lt;p&gt;Apologies for spamming, but I want to make clear: This applies when bootstrapping nodes into a ring with at least one other node already bootstrapping (otherwise calculatePendingRanges won&apos;t get called repeatedly as the ring is populated in the storage service). The greater the number of bootstrapping nodes, the greater the probability of pending range calculations having to be done more often (it is determined by how many nodes get populated into the storage service&apos; notion of the ring before the first bootstrapping node is seen), and the greater the probability of initiating bootstrap based on an incomplete ring view.&lt;/p&gt;</comment>
                            <comment id="13275892" author="soverton" created="Tue, 15 May 2012 15:44:40 +0000"  >&lt;p&gt;First the important bit: With these patches, StorageService.calculatePendingRanges is almost three orders of magnitude faster when calculating two nodes bootstrapping into a cluster with 2048 nodes (22ms vs 14.6sec). See the &lt;a href=&quot;https://github.com/acunu/cassandra/wiki/images/calculate_pending_ranges.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;graph here&lt;/a&gt;. This was tested with 1 DC and 1 rack with RF=2.&lt;/p&gt;

&lt;p&gt;The problem lies in NetworkTopologyStrategy.calculateNaturalEndpoints. The main problems with the existing implementation are:&lt;/p&gt;

&lt;p&gt;1. for each datacentre:&lt;br/&gt;
2. it iterates through all the tokens in the ring at least once&lt;br/&gt;
3. then does an NlogN sort of those tokens&lt;br/&gt;
4. then if number of racks &amp;lt; RF it will iterate through all tokens again because it can&apos;t tell if it has exhausted the racks in that DC&lt;br/&gt;
5. then if number of hosts in that DC &amp;lt; RF it will iterate through all tokens again, otherwise it will iterate through until it has RF hosts in that DC&lt;/p&gt;

&lt;p&gt;so it&apos;s doing O(DC * (N + NlogN + N + N)) operations just to work out the endpoints for a single token. StorageService.calculatePendingRanges then puts this inside other loops (such as AbstractReplicationStrategy.getAddressRanges) which makes it at least O(N^2*logN).&lt;/p&gt;

&lt;p&gt;These patches fix (1) by iterating through the tokens only once, and processing all DCs simultaneously.&lt;/p&gt;

&lt;p&gt;(2,3&amp;amp;5) relate to knowing which endpoints exist in a given DC, (4) relates to knowing which racks appear in a DC, so the first patch adds this knowledge to the snitch. The second patch makes use of this knowledge to simplify calculateNaturalEndpoints.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&amp;nbsp;&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;description&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;p/3881/00_snitch_topology&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/acunu/cassandra/compare/refs/top-bases/p/3881/00_snitch_topology...p/3881/00_snitch_topology&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;compare&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/acunu/cassandra/compare/refs/top-bases/p/3881/00_snitch_topology...p/3881/00_snitch_topology.diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;raw diff&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Adds some functionality to AbstractEndpointSnitch to track which endpoints and racks exist in a DC (allows for fixing of 2-5).&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;p/3881/01_calc_natural_endpoints&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/acunu/cassandra/compare/refs/top-bases/p/3881/01_calc_natural_endpoints...p/3881/01_calc_natural_endpoints&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;compare&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/acunu/cassandra/compare/refs/top-bases/p/3881/01_calc_natural_endpoints...p/3881/01_calc_natural_endpoints.diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;raw diff&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;Rewritten O(logN) implementation of calculateNaturalEndpoints using the topology information from the snitch.&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;Note: These branches are managed with &lt;a href=&quot;http://repo.or.cz/w/topgit.git&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TopGit&lt;/a&gt;.  If you are applying the patch output manually, you will either need to filter the TopGit metadata files ( &lt;tt&gt;wget -O - &amp;lt;url&amp;gt; | filterdiff -x*.topdeps -x*.topmsg | patch -p1&lt;/tt&gt; ), or remove them afterward ( &lt;tt&gt;rm .topmsg .topdeps&lt;/tt&gt; ).&lt;/p&gt;</comment>
                            <comment id="13275918" author="jbellis" created="Tue, 15 May 2012 16:59:22 +0000"  >&lt;p&gt;Peter, are you available to review?&lt;/p&gt;</comment>
                            <comment id="13276002" author="soverton" created="Tue, 15 May 2012 17:19:33 +0000"  >&lt;p&gt;Just added an additional test to NetworkTopologyStrategyTest. &lt;/p&gt;

&lt;p&gt;The above patches will be up to date, or if you already downloaded the diff then here is the &lt;a href=&quot;https://github.com/acunu/cassandra/commit/b199d14f1a33115c66552b3c821af7dc1f0ceedb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;incremental patch&lt;/a&gt; (&lt;a href=&quot;https://github.com/acunu/cassandra/commit/b199d14f1a33115c66552b3c821af7dc1f0ceedb.diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;raw diff&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="13276660" author="soverton" created="Wed, 16 May 2012 10:58:35 +0000"  >&lt;p&gt;AbstractEndpointSnitch should handle every state change, not just onChange and onRemove&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/acunu/cassandra/commit/b462500e7b8edad0581c60b8e2011cf76e1c7a92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;incremental patch&lt;/a&gt; (&lt;a href=&quot;https://github.com/acunu/cassandra/commit/b462500e7b8edad0581c60b8e2011cf76e1c7a92.diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;raw diff&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="13276678" author="soverton" created="Wed, 16 May 2012 11:51:04 +0000"  >&lt;p&gt;Some remaining issues:&lt;br/&gt;
1. Handling changes to dc/rack assignment. Currently the topology maps would get out of sync if any endpoint changes dc/rack. This will require Ec2Snitch and PropertyFileSnitch to notify the superclass when they detect a topology change.&lt;br/&gt;
2. Delegate getTopology in DynamicSnitch to the subsnitch.&lt;/p&gt;
</comment>
                            <comment id="13278644" author="scode" created="Fri, 18 May 2012 08:20:19 +0000"  >&lt;p&gt;Jonathan, I&apos;ll try to do so within the next few days.&lt;/p&gt;</comment>
                            <comment id="13283289" author="soverton" created="Fri, 25 May 2012 10:26:46 +0000"  >&lt;p&gt;The original approach was not quite there. The snitch was tracking the topology of nodes in NORMAL state for the benefit of NTS.calculateNaturalEndpoints, but calculateNaturalEndpoints is called with modified TokenMetadata (eg, with leaving nodes removed, or a bootstrapped node added or some other modification) to calculate ranges for some future state of the ring, not the current state as tracked by the snitch.&lt;/p&gt;

&lt;p&gt;The correct solution is to have TokenMetadata track the topology of the nodes which it considers to be part of the ring, so that when a tokenMetadata is cloned and modified it also updates its view of the topology. This is also much simpler and cleaner.&lt;/p&gt;

&lt;p&gt;Patches above are updated.&lt;/p&gt;</comment>
                            <comment id="13400667" author="jbellis" created="Mon, 25 Jun 2012 17:03:20 +0000"  >&lt;p&gt;This looks reasonable.  I have two concerns:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Topology syncronization: a mix between &quot;Topology synchronizes internally&quot; and &quot;caller must synchronize externally&quot; is a recipe for trouble.  Maybe just synchronizing getDatacenterEndpoints/getDatacenterRacks and returning copies, would be enough.  Alternatively, we could just say &quot;you must clone TMD before calling calculateNaturalEndpoints&quot; and possibly get rid of all the Topology synchronization (relying on TMD&apos;s on the update path)&lt;/li&gt;
	&lt;li&gt;I think there is a hole in the rack-handling logic in cNE: we only check skippedDcEndpoints when a new rack is found.  So if there is (for instance) a single rack in a DC w/ RF=3, we&apos;ll add the first endpoint in that rack, then the rest will get added to the skipped list, but never added to replicas.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;00 nits:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;would like to see javadoc for Topology&lt;/li&gt;
	&lt;li&gt;type specification is not necessary for HMM.create calls (this is why guava prefers factories to constructors)&lt;/li&gt;
	&lt;li&gt;I recognize that you were following precedent here, but I would prefer the param-less TMD constructor to call new TMD(HashBimap.create(), new Topology()) instead of (null, null) + special casing in the 2-param version&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;01 nits:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;@Override is redundant for calculateNaturalEndpoints since parent declares it abstract&lt;/li&gt;
	&lt;li&gt;some &quot;} else&quot; formatting issues in cNE&lt;/li&gt;
	&lt;li&gt;&quot;!skippedDcEndpoints.get(dc).isEmpty()&quot; is redundant since the empty iterator case will just be a no-op in the following loop&lt;/li&gt;
	&lt;li&gt;perhaps dcReplicas would be a better name than replicaEndpoints, for symmetry w/ &quot;replicas&quot;&lt;/li&gt;
	&lt;li&gt;would be cleaner to move the &quot;replicaEndpoints.get(dc).size() &amp;gt;= Math.min(allEndpoints.get(dc).size(), getReplicationFactor)&quot; check into &quot;have we already found all replicas for this dc&quot;, instead of playing games w/ mutating replicaEndpoints as an (unimportant) optimization.  (Note that &quot;datacenters.containsKey(dc)&quot; remains a sufficient check for &quot;is this a dc we care about at all.&quot;)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13401472" author="soverton" created="Tue, 26 Jun 2012 15:58:17 +0000"  >&lt;p&gt;Thanks Jonathan. I&apos;ve addressed the above in the following commits:&lt;br/&gt;
7eab101 &lt;a href=&quot;https://github.com/acunu/cassandra/commit/7eab101fd1649737682d4ce30004a15d0c6c2343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;incremental patch&lt;/a&gt; (&lt;a href=&quot;https://github.com/acunu/cassandra/commit/7eab101fd1649737682d4ce30004a15d0c6c2343.diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;raw diff&lt;/a&gt;)&lt;br/&gt;
1474cf0 &lt;a href=&quot;https://github.com/acunu/cassandra/commit/1474cf090f5b2c80bbe573d16041458f1782ecbb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;incremental patch&lt;/a&gt; (&lt;a href=&quot;https://github.com/acunu/cassandra/commit/1474cf090f5b2c80bbe573d16041458f1782ecbb.diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;raw diff&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;(patch links above updated)&lt;/p&gt;

&lt;p&gt;except for the following:&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
	&lt;li&gt;Topology syncronization: a mix between &quot;Topology synchronizes internally&quot; and &quot;caller must synchronize externally&quot; is a recipe for trouble. Maybe just synchronizing getDatacenterEndpoints/getDatacenterRacks and returning copies, would be enough. Alternatively, we could just say &quot;you must clone TMD before calling calculateNaturalEndpoints&quot; and possibly get rid of all the Topology synchronization (relying on TMD&apos;s on the update path)&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;I was trying to avoid any copying, as calculateNaturalEndpoints will be called thousands of times with vnodes in some code paths. I prefer the latter solution of cloning TMD before using it in any method which will use the Topology. The only places where cloning will be necessary to avoid concurrent updates are those where StorageService.instance.tokenMetadata is used directly. I&apos;ll update the patches shortly.&lt;/p&gt;

&lt;blockquote&gt;
&lt;ul&gt;
	&lt;li&gt;I think there is a hole in the rack-handling logic in cNE: we only check skippedDcEndpoints when a new rack is found. So if there is (for instance) a single rack in a DC w/ RF=3, we&apos;ll add the first endpoint in that rack, then the rest will get added to the skipped list, but never added to replicas.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;I think this case is already handled: the subsequent endpoints for that duplicate rack will hit this line first:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    // can we skip checking the rack?
    if (seenRacks.get(dc).size() == racks.get(dc).keySet().size())
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and they get added as a replica immediately because we know we have exhausted the racks for that DC. Did I miss something?&lt;/p&gt;
</comment>
                            <comment id="13401573" author="jbellis" created="Tue, 26 Jun 2012 18:06:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;The only places where cloning will be necessary to avoid concurrent updates are those where StorageService.instance.tokenMetadata is used directly. I&apos;ll update the patches shortly.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sounds good, I&apos;ll have a look when that hits.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I think this case is already handled: the subsequent endpoints for that duplicate rack will hit this line first&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Ah, right.  LGTM.&lt;/p&gt;</comment>
                            <comment id="13402144" author="soverton" created="Wed, 27 Jun 2012 11:15:57 +0000"  >&lt;p&gt;I tried out the different approaches for removing this sychronization requirement on Topology:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/acunu/cassandra/compare/bb6f4b40c8a8276971e9e4c50e92e6801dba08bf...3881-review-clone-tmd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;clone TokenMetadata before passing to calculateNaturalEndpoints&lt;/a&gt; (&lt;a href=&quot;https://github.com/acunu/cassandra/compare/bb6f4b40c8a8276971e9e4c50e92e6801dba08bf...3881-review-clone-tmd.diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;raw diff&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This looks much more hairy than having synchronization - the places where tokenMetadata needs to be cloned look arbitrary and it&apos;s much less obvious what the convention is for other people looking at this (eg. why do you need to clone before passing into AbstractReplicationStrategy.getAddressRanges() but not AbstractReplicationStrategy.getPendingAddressRanges() ? A: it&apos;s because getPendingAddressRanges makes its own clone to update a token). &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/acunu/cassandra/compare/bb6f4b40c8a8276971e9e4c50e92e6801dba08bf...3881-review-copy-topo&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;return copies from Topology.getDatacenterEndpoints() and Topology.getDatacenterRacks()&lt;/a&gt; (&lt;a href=&quot;https://github.com/acunu/cassandra/compare/bb6f4b40c8a8276971e9e4c50e92e6801dba08bf...3881-review-copy-topo.diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;raw diff&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is less error-prone because Topology now handles all its own synchonization. Unfortunately copying those maps adds a large overhead which removes most of the benefit of this ticket. See the &lt;a href=&quot;https://github.com/acunu/cassandra/wiki/images/calculate_pending_ranges_topo_copy.png&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;updated graph of calculatePendingRanges vs. cluster size&lt;/a&gt;. This is not surprising because these copies require O(N) time. &lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/acunu/cassandra/commit/6d25673c372587beea3971d8ce31b06372525861&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;document the synchronization requirements of Topology so that it&apos;s clear what is necessary&lt;/a&gt; (&lt;a href=&quot;https://github.com/acunu/cassandra/commit/6d25673c372587beea3971d8ce31b06372525861.diff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;raw diff&lt;/a&gt;)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;This is my preferred solution. Currently only calculateNaturalEndpoints uses the TMD.Topology, so requiring to synchronize around it seems like a reasonable solution to me. The javadoc should make it obvious to any new uses of it that they need to synchronize.&lt;/p&gt;</comment>
                            <comment id="13402392" author="dr-alves" created="Wed, 27 Jun 2012 17:43:25 +0000"  >&lt;p&gt;Hi&lt;/p&gt;

&lt;p&gt;small nit:&lt;br/&gt;
I was using the ctor &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TokenMetadata(BiMap&amp;lt;Token, InetAddress&amp;gt; tokenToEndpointMap)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; in non-commited code. That ctor has now become &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; TokenMetadata(BiMap&amp;lt;Token, InetAddress&amp;gt; tokenToEndpointMap, Topology topology)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; since the ctor in Topology is protected this ctor in TokenMetadata can&apos;t be called outside of protected scope from now on. I suggest either broadening the scope of the ctor in Topology or restricting the scope in TokenMetadata.&lt;/p&gt;</comment>
                            <comment id="13402959" author="soverton" created="Thu, 28 Jun 2012 09:45:55 +0000"  >&lt;p&gt;Hi David, is this non-committed code that&apos;s part of another ticket?&lt;/p&gt;</comment>
                            <comment id="13402965" author="dr-alves" created="Thu, 28 Jun 2012 09:54:44 +0000"  >&lt;p&gt;hi sam&lt;/p&gt;

&lt;p&gt;yes I was using that ctor to test StorageService.effectiveOwnership, included in the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3047&quot; title=&quot;implementations of IPartitioner.describeOwnership() are not DC aware&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3047&quot;&gt;&lt;del&gt;CASSANDRA-3047&lt;/del&gt;&lt;/a&gt; patch. &lt;/p&gt;

&lt;p&gt;I worked around it since it makes sense that it makes sense that TokenMetadata receives token-&amp;gt;endpoint mappings through &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;updateNormalTokens&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;, in order to build topology. The thing was that while previously the ctor &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;TokenMetadata(BiMap&amp;lt;Token, InetAddress&amp;gt; tokenToEndpointMap)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; was usable, now it is not, at least not without getting topology from another TokenMetadata instance.&lt;/p&gt;</comment>
                            <comment id="13402988" author="soverton" created="Thu, 28 Jun 2012 10:29:18 +0000"  >&lt;p&gt;Ok, I was going to suggest using updateNormalTokens, or you could change ctor visibility in your patch if required.&lt;/p&gt;</comment>
                            <comment id="13403507" author="jbellis" created="Thu, 28 Jun 2012 21:59:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;the places where tokenMetadata needs to be cloned look arbitrary and it&apos;s much less obvious what the convention is for other people looking at this&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What if we just added an assert (&lt;tt&gt;assert tokenMetadata != StorageService.tokenMetadata&lt;/tt&gt;) to enforce this requirement?&lt;/p&gt;

&lt;p&gt;Granted that we are choosing lesser evils here, but I like that better than trying to reason about synchronized(Topology) mixed with locks mixed with synchronized(bootstrapTokens).&lt;/p&gt;</comment>
                            <comment id="13403538" author="jbellis" created="Thu, 28 Jun 2012 22:48:06 +0000"  >&lt;p&gt;Pushed this to &lt;a href=&quot;https://github.com/jbellis/cassandra/tree/3881-clone-tmd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jbellis/cassandra/tree/3881-clone-tmd&lt;/a&gt; with some extra synchronization cleanup&lt;/p&gt;</comment>
                            <comment id="13403551" author="jbellis" created="Thu, 28 Jun 2012 22:57:46 +0000"  >&lt;p&gt;More general assert instead (against TM.getTopology) pushed to &lt;a href=&quot;https://github.com/jbellis/cassandra/tree/3881-clone-tmd-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jbellis/cassandra/tree/3881-clone-tmd-2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13405153" author="soverton" created="Mon, 2 Jul 2012 17:38:33 +0000"  >&lt;p&gt;Agreed that having a single lock is easier to reason about its correctness.&lt;/p&gt;

&lt;p&gt;There was one more extra synchronization to cleanup - pushed to &lt;a href=&quot;https://github.com/acunu/cassandra/tree/3881-clone-tmd-3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/acunu/cassandra/tree/3881-clone-tmd-3&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ll get these changes merged into the TopGit branches. They&apos;ll possibly need separating out for the two separate patches.&lt;/p&gt;</comment>
                            <comment id="13405172" author="jbellis" created="Mon, 2 Jul 2012 17:57:55 +0000"  >&lt;p&gt;I can merge/squash/commit from here.&lt;/p&gt;</comment>
                            <comment id="13405188" author="jbellis" created="Mon, 2 Jul 2012 18:12:19 +0000"  >&lt;p&gt;I take it back, history is a mess w/o topgit. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  Will wait for your update.&lt;/p&gt;</comment>
                            <comment id="13405917" author="soverton" created="Tue, 3 Jul 2012 13:31:52 +0000"  >&lt;p&gt;It&apos;s all merged in now, so the patch links in the ticket description are up to date.&lt;/p&gt;

&lt;p&gt;There was one more place in some tests that TMD needed to be cloned: &lt;a href=&quot;https://github.com/acunu/cassandra/commit/08620c55a77ba1dc257b853610386297ab0c379b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/acunu/cassandra/commit/08620c55a77ba1dc257b853610386297ab0c379b&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13405963" author="jbellis" created="Tue, 3 Jul 2012 18:24:25 +0000"  >&lt;p&gt;thanks, committed!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10032">
                    <name>Blocker</name>
                                            <outwardlinks description="blocks">
                                        <issuelink>
            <issuekey id="12549706">CASSANDRA-4119</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12540841">CASSANDRA-3831</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[soverton]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>227242</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gpdb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95540</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>