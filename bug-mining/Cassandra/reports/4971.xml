<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:10:48 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14092] Max ttl of 20 years will overflow localDeletionTime</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14092</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4771&quot; title=&quot;Setting TTL to Integer.MAX causes columns to not be persisted.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4771&quot;&gt;&lt;del&gt;CASSANDRA-4771&lt;/del&gt;&lt;/a&gt; added a max value of 20 years for ttl to protect against &lt;a href=&quot;https://en.wikipedia.org/wiki/Year_2038_problem&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;year 2038 overflow bug&lt;/a&gt; for &lt;tt&gt;localDeletionTime&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;It turns out that next year the &lt;tt&gt;localDeletionTime&lt;/tt&gt; will start overflowing with the maximum ttl of 20 years (&lt;tt&gt;System.currentTimeMillis() + ttl(20 years) &amp;gt; Integer.MAX_VALUE&lt;/tt&gt;), so we should remove this limitation.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13122467">CASSANDRA-14092</key>
            <summary>Max ttl of 20 years will overflow localDeletionTime</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pauloricardomg">Paulo Motta</assignee>
                                    <reporter username="pauloricardomg">Paulo Motta</reporter>
                        <labels>
                    </labels>
                <created>Sun, 3 Dec 2017 22:01:51 +0000</created>
                <updated>Mon, 27 Oct 2025 07:53:09 +0000</updated>
                            <resolved>Sun, 11 Feb 2018 13:38:11 +0000</resolved>
                                        <fixVersion>2.1.20</fixVersion>
                    <fixVersion>2.2.12</fixVersion>
                    <fixVersion>3.0.16</fixVersion>
                    <fixVersion>3.11.2</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>19</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="16276120" author="pauloricardomg" created="Sun, 3 Dec 2017 22:04:12 +0000"  >&lt;p&gt;I think that &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8099&quot; title=&quot;Refactor and modernize the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8099&quot;&gt;&lt;del&gt;CASSANDRA-8099&lt;/del&gt;&lt;/a&gt; already removed this limitation from the storage engine by encoding &lt;tt&gt;localDeletionTime&lt;/tt&gt; as a varint, so it should be relatively easy to update the code to represent &lt;tt&gt;localDeletionTime&lt;/tt&gt; as a long instead.&lt;/p&gt;</comment>
                            <comment id="16337907" author="christianmovi" created="Wed, 24 Jan 2018 17:15:29 +0000"  >&lt;p&gt;Reproduced in 3.0.15.&lt;/p&gt;</comment>
                            <comment id="16338130" author="rbfblk" created="Wed, 24 Jan 2018 19:46:39 +0000"  >&lt;p&gt;Copying/paraphrasing my recent comment from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4771&quot; title=&quot;Setting TTL to Integer.MAX causes columns to not be persisted.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4771&quot;&gt;&lt;del&gt;CASSANDRA-4771&lt;/del&gt;&lt;/a&gt; here:&lt;/p&gt;

&lt;p&gt;It looks like local deletion time is encoded per cell as an offset in seconds from the minimum local deletion time in the SSTable. If I&apos;m reading it right the offset is serialized as a variable length integer, so reading it into a long instead of an int would give a very large range of offsets that would be more than sufficient. However it looks to me like the minimum local deletion time at the SSTable metadata level is saved as a fixed-size 4-bytes and de-serialized into a (signed) int. Without changing the serialization format we could change the interpretation of that metadata field to assume it is an unsigned integer (and de-serialize it also into a long variable instead of an int) which should give us another 68 years. A better fix would probably be to also change the serialization format of minLocalDeletionTime in the metadata to an 8 byte integer or a variable size integer so it could hold values in the far far future. Changing the SSTable format might be a 4.0+ thing though. Either way the in-memory representation of local delete time would become a long not an int.&lt;/p&gt;

&lt;p&gt;I haven&apos;t yet looked at what if anything this means for the inter-node wire format between coordinator and replica, that might be a complicating factor if&#160;this is a breaking change to the format.&lt;/p&gt;</comment>
                            <comment id="16340499" author="pauloricardomg" created="Fri, 26 Jan 2018 02:55:57 +0000"  >&lt;p&gt;The patch below&#160;&lt;a href=&quot;https://github.com/apache/cassandra/commit/6e66a4730a6f606fe1bb609ba4d8ec650877605e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;reduces the maximum allowed TTL&lt;/a&gt; from 20 years to 15 years to prevent integer overflow on the &lt;tt&gt;localDeletionTime&lt;/tt&gt; field what causes inserts with TTL close to the current maximum of 20 years to fail with AssertionError on 2.1 and expire as soon as they are inserted on 3.0, as discussed on the &lt;a href=&quot;https://www.mail-archive.com/dev@cassandra.apache.org/msg11888.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;mailing list thread&lt;/a&gt;.This is just an immediate measure to prevent data loss on 3.0+ while we look for a more permanent solution to raise this limitation.&lt;/p&gt;

&lt;p&gt;In addition to lowering the max default TTL, this patch also &lt;a href=&quot;https://github.com/apache/cassandra/commit/d9bbb7992696a02ccc490229280894f0437ae0b7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;adds ability to scrub to detect and fix rows/cels&lt;/a&gt; with overflowed &lt;tt&gt;localDeletionTime&lt;/tt&gt; which were not yet turned into tombstones by compaction and detect rows which were already turned into tombstones to allow operators to identify which rows were affected. Furthermore, I &lt;a href=&quot;https://github.com/apache/cassandra/commit/ac04a4199947d41962c34bce07d9aad4ebf87e47&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;modified the compaction purger&lt;/a&gt; to not purge rows with overflowed localDeletionTime to allow them to be fixed via scrub.&lt;/p&gt;

&lt;p&gt;This is ready for a initial round of review, but I will still add some tests for scrub and a more detailed NEWS.txt entry.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-14092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-14092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16341202" author="pauloricardomg" created="Fri, 26 Jan 2018 16:02:59 +0000"  >&lt;p&gt;Canceling the patch while I work on an alternative version after discussion on the ML.&lt;/p&gt;</comment>
                            <comment id="16341749" author="pauloricardomg" created="Fri, 26 Jan 2018 22:59:50 +0000"  >&lt;p&gt;This patch below takes a simpler and more transparent approach. The idea is to keep the maximum allowed TTL of 20 years, but cap the maximum expiration time to 2038-01-19T03:14:06+00:00.&lt;/p&gt;

&lt;p&gt;When this capping is done, the following log is print in the client and system.log:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN  [SharedPool-Worker-2] 2018-01-26 19:15:36,877 NoSpamLogger.java:94 - TTL of 630720000 seconds exceeds maximum supported expiration date of 2038-01-19T03:14:06+00:00. Rows with expiration date exceeding the maximum supported date will expire in the limit date. In order to avoid this use a lower TTL or upgrade to a version where this limitation is fixed. See CASSANDRA-14092 for more details.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In addition to this, the patch converts any negative localExpirationTime that may have been written to 2038-01-19T03:14:06+00:00 - fixing any wrong entries that may still be present but were not yet purged.&lt;/p&gt;

&lt;p&gt;Since we store the TTL as a separate field, once we fix this limitation we can recompute the correct expiration time with the timestamp/1000+ttl time during upgradesstables.&lt;/p&gt;

&lt;p&gt;I added tests to check that data inserted with a TTL exceeding the maximum allowed expiration time is present and a warning is logged. I also added tests to check that SSTables written with the negative localExpirationTime are correctly interpreted.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-14092-v2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-14092-v2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-14092-v2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-14092-v2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/master...pauloricardomg:14092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;Submitted CI, will attach results when ready.&lt;/p&gt;</comment>
                            <comment id="16343378" author="dimitarndimitrov" created="Mon, 29 Jan 2018 14:06:36 +0000"  >&lt;p&gt;Some review comments on the dtest and trunk changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;On the dtest change:
	&lt;ol&gt;
		&lt;li&gt;Shouldn&apos;t the dtest docstring&#160;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/83c73ef0a3cbe50232d3a9eea4fd26c877ea58db#diff-a8f4dac4af77196a8c7881abd067a5b9R345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&#160;say something related to the TTL problem?&lt;/li&gt;
		&lt;li&gt;The start time&#160;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/83c73ef0a3cbe50232d3a9eea4fd26c877ea58db#diff-a8f4dac4af77196a8c7881abd067a5b9R348&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&#160;seems redundant&lt;/li&gt;
		&lt;li&gt;It may be good to extract the max TTL value in a variable - we may decide to keep a version of this test after we patch by just reducing that value, but before we fix it nicely&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
	&lt;li&gt;On the trunk change:
	&lt;ol&gt;
		&lt;li&gt;Maybe it&apos;s my English, but&#160;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-14092-v2#diff-5414c0e96996be355c3aff1184ec859aR48&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this wording&lt;/a&gt;&#160;sounds a bit confusing to me, using &quot;maximum supported date&quot; and &quot;limit date&quot; for the same thing. Thoughts? If you&apos;re also hesitant, what do you think about &quot;Rows that should expire after that date would still expire on that date.&quot;?&lt;/li&gt;
		&lt;li&gt;You can quickly mention the relevant JIRA ticket&#160;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-14092-v2#diff-b7ca4b9c415e93b6cbfb31daf90cc598R185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/li&gt;
		&lt;li&gt;Qualify the static access to&#160;&lt;tt&gt;Cell.sanitizeLocalDeletionTime&lt;/tt&gt;&#160;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-14092-v2#diff-b7ca4b9c415e93b6cbfb31daf90cc598R53&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/li&gt;
		&lt;li&gt;Could you please add some comments/Javadoc for&#160;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-14092-v2#diff-3e9f1fc67f99d27e92a3eb32201d8ca6R311&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;Cell.sanitizeLocalDeletionTime&lt;/tt&gt;&lt;/a&gt;? I would assume that &lt;tt&gt;NO_TTL&lt;/tt&gt; and &lt;tt&gt;NO_DELETION_TIME&lt;/tt&gt; are needed to determine whether the cell is an expiring one, an expired one, or a tombstone, but I&apos;m not too sure&lt;/li&gt;
		&lt;li&gt;There are missing spaces between the boolean arguments of the delegation call for some of the unit tests (e.g. &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-14092-v2#diff-0d8cf6ca6ed99c947903359c1beaf386R74&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;)&lt;/li&gt;
	&lt;/ol&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16343619" author="vincentwhite" created="Mon, 29 Jan 2018 16:46:23 +0000"  >&lt;p&gt;I haven&apos;t had a chance to completely catch up on the ML discussion but I thought I would post a proof of concept branch I had that promotes localDeletionTime to long on trunk. The code definitely isn&apos;t meant to be a final product but it might be a useful starting point regardless of whether we actually decide to go this route or not. It&apos;s fairly straight forward and unfortunately most of the code went towards undoing optimizations introduced to tombstone histograms in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13444&quot; title=&quot;Fast and garbage-free Streaming Histogram&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13444&quot;&gt;&lt;del&gt;CASSANDRA-13444&lt;/del&gt;&lt;/a&gt;. I put together the majority of this last year so I may be forgetting some glaring issues but I believe it was basically complete minus a few unit tests to be cleaned up and tools updated.&lt;/p&gt;

&lt;p&gt;One outstanding issue I do recall is related to EXPIRED_LIVENESS_TTL which is currently Integer.MAX_VALUE but sounds like that should be resolved/removed at some point by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13826&quot; title=&quot;Specialize row structure to support complex Materialized Views liveness&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13826&quot;&gt;CASSANDRA-13826&lt;/a&gt;.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/vincewhite/cassandra/commit/364f9ac848ae54eae9a1360d72aad4ba0a2b63a8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16344410" author="jjirsa" created="Tue, 30 Jan 2018 02:22:40 +0000"  >&lt;p&gt;Given the nature of this bug, can we get someone familiar with engine internals (read: an existing committer) to review it? Like maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; ?&#160;&lt;/p&gt;</comment>
                            <comment id="16344514" author="pauloricardomg" created="Tue, 30 Jan 2018 05:13:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;Some review comments on the dtest and trunk changes:&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks for your feedback! I addressed your suggestions/nits and updated the warning message to:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Request on table ks.ttl_table with default ttl of 630720000 seconds exceeds maximum supported expiration date of 2038-01-19T03:14:06+00:00 and will have its expiration capped to that date. In order to avoid this use a lower TTL or upgrade to a version where this limitation is fixed. See CASSANDRA-14092 for more details.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In addition to the fixes above, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; pointed out offline that the &lt;tt&gt;default_time_to_live&lt;/tt&gt; is not capped to 20 years on the 2.1 branch, so I added the cap &lt;a href=&quot;https://github.com/apache/cassandra/commit/4d592eb990c1f7a84ae79738ea3ffb22f67282d3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. This made me realize that the warning was not being print when the insert was using the table default TTL, so I fixed this &lt;a href=&quot;https://github.com/apache/cassandra/commit/109fa214fbedc3b803e47f8dc79b41132ef2a1eb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and added a dtest &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/09f39d5910d4c0dd1b800698deec7f7a6c5c747a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. I also added some dtests to check that the warning is print when the access is done via thrift (&lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/748ab67a1ce3950640747d6b980ef57b7871e59b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;I updated all branches above with the changes above + other minor fixes and test fixes. Will update with test results when CI is ready.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I thought I would post a proof of concept branch I had that promotes localDeletionTime to long on trunk.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Thanks a lot for your effort! While this looks like a straightforward approach and I don&apos;t see any particular problems with it at first glance, I&apos;d like to focus right now on shipping a temporary solution to fix the silent data loss problem on 3.0+ as soon as we can before working on a permanent solution with proper vetting, testing and impact analysis.&lt;/p&gt;</comment>
                            <comment id="16345640" author="beobal" created="Tue, 30 Jan 2018 19:15:09 +0000"  >&lt;p&gt;This is a nasty problem because all the potential solutions are bad and I should say that I&apos;ve only gone in depth on the 3.0 patch as of yet, but I assume that the other versions are functionally equivalent.&lt;/p&gt;

&lt;p&gt;I have serious concerns about the default action here being to fix up the data. IMO, the default action should be to reject client requests which attempt to set a TTL that&apos;s going to push expiration/deletion time past the threshold. As mentioned on the dev list there might be clients out there that can&apos;t easily tolerate that, so my suggestion would be that we enable the capping of the expiration date (at insert/update time only and with a client + log warning) by means of a -D flag. All of which is definitely annoying and ugly, but probably not too controversial.&lt;/p&gt;

&lt;p&gt;However, there is another issue as the current patch can also lead to previously &apos;gone&apos; data being resurrected without warning or notification. If an SSTable contains data with an overflowed expiration, from the client&apos;s perspective that data is not present. Applying the patch before the data is purged fixes up the expiration date, capping it at the limit date and so the previously gone data will once again be returned in query results. Whether we should allow this resurrection is IMO highly questionable, not knowing what decisions have been taken outside of the database based on that data not being present/visible. My preference would be for gone data to stay gone, with another -D flag to turn on post-insert capping of the expiration date.&lt;/p&gt;

&lt;p&gt;Moreover, this resurrection is temporary and persists only until the SSTable is involved in a compaction. At that point, the expiration date causes a purge and the data disappears again. This is definitely not cool and if we do fix up the data, it has to stay fixed up.&lt;/p&gt;</comment>
                            <comment id="16345668" author="JIRAUSER308715" created="Tue, 30 Jan 2018 19:41:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;I have serious concerns about the default action here being to fix up the data. IMO, the default action should be to reject client requests which attempt to set a TTL that&apos;s going to push expiration/deletion time past the threshold. As mentioned on the dev list there might be clients out there that can&apos;t easily tolerate that, so my suggestion would be that we enable the capping of the expiration date (at insert/update time only and with a client + log warning) by means of a -D flag. All of which is definitely annoying and ugly, but probably not too controversial.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think our default should be to cap with warnings. &#160;What is a user going to do when they get the error? &#160;They are going to just go change there code to pick a new date that is still real big, so I don&apos;t see a reason to fail things.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Whether we should allow this resurrection is IMO highly questionable, not knowing what decisions have been taken outside of the database based on that data not being present/visible.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We need a way to let users recover the data that was silently dropped. &#160;I could see an argument for a -D to let the data stay dropped, rather than recovering it, but I definitely think our default here should be to recover the lost data.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Moreover, this resurrection is temporary and persists only until the SSTable is involved in a compaction. At that point, the expiration date causes a purge and the data disappears again. This is definitely not cool and if we do fix up the data, it has to stay fixed up.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Does this actually happen? &#160;The expiration date will be fixed up when the cell is loaded, so on compaction it should be written back out with the new time? &#160;If this is not what happens then it is&#160;an over sight in the patch and should be fixed.&lt;/p&gt;</comment>
                            <comment id="16345706" author="pauloricardomg" created="Tue, 30 Jan 2018 20:02:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;I have serious concerns about the default action here being to fix up the data. IMO, the default action should be to reject client requests which attempt to set a TTL that&apos;s going to push expiration/deletion time past the threshold. As mentioned on the dev list there might be clients out there that can&apos;t easily tolerate that, so my suggestion would be that we enable the capping of the expiration date (at insert/update time only and with a client + log warning) by means of a -D flag. All of which is definitely annoying and ugly, but probably not too controversial.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My reasoning for this is that once we fix the issue permanently, the idea is to restore/recompute the correct localExpirationTime via (timestamp/1000 + ttl). This is obviously not perfect as the timestamp could be provided by the client, so there could be some slight variance here, but if someone is setting a TTL 20 years in advance, I think it is able to tolerate a few seconds or even minutes of difference in the expiration time. I don&apos;t think the case where the client is using a different timestamp format plus overflowing TTL is realistic enough that it will create problems, but we can also protect against this and perhaps provide and option to opt out of fix by default behavior if necessary.&lt;/p&gt;</comment>
                            <comment id="16345733" author="pauloricardomg" created="Tue, 30 Jan 2018 20:17:31 +0000"  >&lt;blockquote&gt;&lt;p&gt;Whether we should allow this resurrection is IMO highly questionable, not knowing what decisions have been taken outside of the database based on that data not being present/visible. My preference would be for gone data to stay gone, with another -D flag to turn on post-insert capping of the expiration date.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t expect us to take longer than a few weeks (at worst a couple of months) to come up with a permanent solution for this, our goal here is to prevent users from inadvertedly losing data in the time frame where the permanent fix is not available. People that detect that data have gone missing without issuing a deletion, will be aware of these issues and will likely take additional measures to remediate it - like reducing the TTL or update their application to correctly handle the data in the affected time period. I personally find it highly unlikely that this scenario will be a problem in practice,  as long we properly document and communicate the problem on NEWS.txt, users that were affected and care about their data will likely take additional measure to recover their state. &lt;/p&gt;</comment>
                            <comment id="16345734" author="beobal" created="Tue, 30 Jan 2018 20:18:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think our default should be to cap with warnings.  What is a user going to do when they get the error?  They are going to just go change there code to pick a new date that is still real big, so I don&apos;t see a reason to fail things.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I imagine that&apos;s exactly what they will do, but the user will fully aware that it&apos;s happening, not having their data changed on them. We ought to be being conservative by default here.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;We need a way to let users recover the data that was silently dropped.  I could see an argument for a -D to let the data stay dropped, rather than recovering it, but I definitely think our default here should be to recover the lost data.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t agree. It&apos;s definitely bad that the data was silently dropped, but like I said we (the db) has no way of knowing what (application) decisions have been taken based on the visible state of the database. I think it&apos;s pretty clear that if the data appeared to be gone at any point (and we have no good reason to assume that the client has not observed such a state) that it must stay gone. &lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Does this actually happen?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, of course I tested it.&lt;/p&gt;</comment>
                            <comment id="16345738" author="pauloricardomg" created="Tue, 30 Jan 2018 20:23:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;Moreover, this resurrection is temporary and persists only until the SSTable is involved in a compaction. At that point, the expiration date causes a purge and the data disappears again. This is definitely not cool and if we do fix up the data, it has to stay fixed up.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This was definitely not supposed to happen, I&apos;ll take a look at it. Would you have an easy repro for this?&lt;/p&gt;

&lt;p&gt;Thanks for taking the time to review this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; and for the comments &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjordan&quot; class=&quot;user-hover&quot; rel=&quot;jjordan&quot;&gt;jjordan&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="16346504" author="beobal" created="Wed, 31 Jan 2018 09:48:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;Would you have an easy repro for this?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sure:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;On an unpatched version (I used 3.0), insert a row with a big enough TTL&lt;/li&gt;
	&lt;li&gt;Query &amp;amp; see that the data is not returned.&lt;/li&gt;
	&lt;li&gt;Apply the patch &amp;amp; restart&lt;/li&gt;
	&lt;li&gt;Query &amp;amp; see that the row now appears&lt;/li&gt;
	&lt;li&gt;Run nodetool compact on the table&lt;/li&gt;
	&lt;li&gt;Query &amp;amp; the row has gone again&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;If you do &lt;b&gt;only&lt;/b&gt; these steps&#160;on a clean node, then the compaction will result in 0 SSTables for the table. A more normal workflow of inserting rows then flushing until an automatic compaction is triggered also has the same effect, but of course doesn&apos;t remove any data without the overflowed expiry.&lt;/p&gt;</comment>
                            <comment id="16347924" author="kurtg" created="Thu, 1 Feb 2018 02:28:09 +0000"  >&lt;p&gt;I don&apos;t think it&apos;s a good idea not to fix the data. That&apos;s incrementally going to break more and more applications as we get closer to 2038.  We should be fixing the data, making it very clear that we are in fact fixing the data (client and server warnings) and advertising heavily on the website/ML/NEWS.txt for people to get off affected versions.&lt;/p&gt;</comment>
                            <comment id="16347939" author="jjirsa" created="Thu, 1 Feb 2018 02:58:34 +0000"  >&lt;p&gt;I don&#8217;t care if there&#8217;s logic to resurrect data, but it must be off by default. People may have already adapted and reacted to the absence of that data, and we can&#8217;t assume it&apos;s always safe to resurrect&lt;/p&gt;</comment>
                            <comment id="16348101" author="pauloricardomg" created="Thu, 1 Feb 2018 06:45:12 +0000"  >&lt;p&gt;After a second thought I agree that trying to automatically recover lost data is bad not only because users may have reacted to the absence of data, but also because due to the negative &lt;tt&gt;localDeletionTime&lt;/tt&gt;, the lost data will likely be purged instantly during compaction, so not much data will be left to recover after a while and the auto-recovery behavior will be pretty much undefined. Furthermore, we will need to keep the recovery logic in the storage engine at least until 4.0 with limited benefit.&lt;/p&gt;

&lt;p&gt;The only way a user that set TTL 20 years ahead can get away with reliably recovering its data is if it has &lt;tt&gt;incremental_backups&lt;/tt&gt; enabled, and in this case, it can easily find out which SSTables have a negative &lt;tt&gt;minLocalDeletionTime&lt;/tt&gt; and run scrub on them to fix the overflow, so I&apos;m strongly leaning towards my previous approach of providing a way for scrub to fix negative timestamps, rather then embedding this recovery logic in the storage engine itself - which would be arguably useful in a handful of cases.&lt;/p&gt;

&lt;p&gt;Regarding what to do with TTLs exceeding the maximum expiry date until we have a permanent solution to the problem, I think it&apos;s fair to expose the cap vs reject trade-off as flag to the operator, so I introduced a &lt;tt&gt;-Dcassandra.expiration_date_overflow_policy={REJECT, CAP_NOWARN, CAP_WARN&lt;/tt&gt; option, which defaults to the conservative REJECT behavior and has the following meaning explained on NEWS.txt:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;      - REJECT: this is the default policy and will reject any requests with expiration date timestamp after 2038-01-19T03:14:06+00:00.
      - CAP_NOWARN: any insert with TTL expiring after 2038-01-19T03:14:06+00:00 will expire on 2038-01-19T03:14:06+00:00.
      - CAP_WARN: same as previous, but will log a warning message when inserted data is capped.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Any feedback and suggestions of alternative more meaningful naming is welcome.&lt;/p&gt;

&lt;p&gt;One downside of defaulting to REJECT I see is that applications will start to break as time progresses and TTLs start reaching the maximum date more often, but given that we plan to fix the underlying issue soon in upcoming versions and users have a way to change the policy I think it shouldn&apos;t be a big problem, but I don&apos;t feel strongly about it so if anyone does please chime in.&lt;/p&gt;

&lt;p&gt;The patch below implements and tests the expiration_date_overflow_policy, but also adds a new flag &lt;tt&gt;cassandra.recover_overflowed_expiration_best_effort&lt;/tt&gt; to perform the auto-recovery, which I intend to remove due to the reasons explained above and replace it with the &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-14092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;scrub-based recovery&lt;/a&gt; (unless someone objects).&lt;/p&gt;

&lt;p&gt;I plan to cleanup these details later today, but if anyone can take a look and give early feedback that would be nice, as I&apos;m hoping to get this in as soon as we can to start a vote.&lt;/p&gt;

&lt;p&gt;The 2.1 and 3.0 are functionally equivalent, except that the 2.1 patch adds a missing 20-years cap for the default_time_to_live option, and that the 3.0 patch adds the to-be-removed &lt;tt&gt;cassandra.recover_overflowed_expiration_best_effort&lt;/tt&gt; option. The versions for the other branches are pretty much derived from those so I will do that after the final review round.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-14092-v3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-14092-v3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/master...pauloricardomg:14092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16348437" author="beobal" created="Thu, 1 Feb 2018 11:22:15 +0000"  >&lt;p&gt;Sounds good to me. Reject and optionally cap at input time, plus a offline route to full recovery (if possible &amp;amp; desired) via scrub sounds like the best way forward IMO. I&apos;ll do a full review when you have the cleaned up patches ready, but the WIP branches generally LGTM at first glance. The wording of the NEWS.txt entry is good, I do wonder if we should maybe place it right at the top of the file rather than just in the 3.0.16 section for extra emphasis. Any thoughts on that? &lt;/p&gt;

&lt;p&gt;I also have one piece of feedback on the policies; I don&apos;t see any benefit in being able to turn off logging of capped expirations (especially since we&apos;re using NoSpamLogger) but I do I think the client warning is useful. So I would change the policies to:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;- REJECT (default and as you&apos;ve defined it)
- CAP (cap, log and issue client warning)
- CAP_NOWARN (cap and log)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I also noticed that the logging of a parse error/invalid value for the policy sysprop is at DEBUG in the current patches, but it might be sensible to draw a bit more attention to that if it happens.&lt;/p&gt;</comment>
                            <comment id="16349529" author="kurtg" created="Thu, 1 Feb 2018 23:51:59 +0000"  >&lt;p&gt;To clarify, CAP and CAP_NOWARN will cap the expiry but we&apos;ll have NO INTENTION of ever fixing it in an upgrade? Or would they have to do a scrub to convert anything that got capped to its actual TTL?&lt;/p&gt;

&lt;p&gt;I think it&apos;s worth pointing out that REJECT is a ticking time bomb. The main concern being people who are still running anything &amp;lt;4.0 when their TTL&apos;s breach 2038-01-19 (which could be literally at any time). If the default was CAP and warn, fixing after upgrade then at least we wouldn&apos;t be bound to break peoples application in the future, and we&apos;d still have almost 20 years to get everyone off these versions without breaking their applications.&lt;/p&gt;</comment>
                            <comment id="16349824" author="pauloricardomg" created="Fri, 2 Feb 2018 05:54:26 +0000"  >&lt;p&gt;Thanks for the quick turnaround &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;! See follow-up below:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The wording of the NEWS.txt entry is good, I do wonder if we should maybe place it right at the top of the file rather than just in the 3.0.16 section for extra emphasis. Any thoughts on that?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Good idea, I did this and also updated the text to contemplate the possibility of data loss before this patch and how to fix it with scrub:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;MAXIMUM TTL EXPIRATION DATE NOTICE
-----------------------------------

The maximum expiration timestamp that can be represented by the storage engine is 2038-01-19T03:14:06+00:00,
which means that inserts with TTL that expire after this date are not currently supported.

Prior to 3.0.16 in the 3.0.X series and 3.11.2 in the 3.11 series, there was no protection against INSERTS
with TTL expiring after the maximum supported date, causing the expiration time field to overflow and the
records to expire immediately. Expired records due to overflow may have been removed permanently after a
compaction. The 2.1.X and 2.2.X series are not subject to data loss due to this issue if assertions are enabled,
since an AssertionError is thrown during INSERT when the expiration time field overflows on these versions.

In practice this issue will affect only users that use very large TTLs, close to the maximum allowed value of
630720000 seconds (20 years), starting from 2018-01-19T03:14:06+00:00. As time progresses, the maximum supported
TTL will be gradually reduced as the the maximum expiration date approaches. For instance, a user on an affected
version on 2028-01-19T03:14:06 with a TTL of 10 years will be affected by this bug, so we urge users of very
large TTLs to upgrade to a version where this issue is addressed as soon as possible.

Potentially affected users should inspect their SSTables and search for negative min local deletion times to
detect this issue. SSTables in this state must be backed up immediately, as they are subject to data loss
during auto-compactions, and may be recovered by running the sstablescrub tool from versions 3.0.16+ and/or 3.11.2+.

The Cassandra project plans to fix this limitation in newer versions, but while the fix is not available, operators
can decide which policy to apply when dealing with inserts with TTL exceeding the maximum supported expiration date:
  - REJECT: this is the default policy and will reject any requests with expiration date timestamp after 2038-01-19T03:14:06+00:00.
  - CAP: any insert with TTL expiring after 2038-01-19T03:14:06+00:00 will expire on 2038-01-19T03:14:06+00:00 and the client will receive a warning.
  - CAP_NOWARN: same as previous, except that the client warning will not be emitted.

These policies may be specified via the -Dcassandra.expiration_date_overflow_policy=POLICY startup option which can be set in the jvm.options file.

See CASSANDRA-14092 for more details about this issue.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Please let me know what do you think of the updated text. We should also probably publish this text (or a subset of it) during the release announcement e-mail.&lt;/p&gt;

&lt;p&gt;While writing the text above, I figured that there is also a remote possibility of data loss in 2.1/2.2 if assertions are disabled, but didn&apos;t backport the scrub recovery since it was not a straightforward backport and I didn&apos;t think it was worth the effort right now. We can always do that later if necessary, the most important thing right now is to ship the policies. To reflect this I updated the 4th paragraph on 2.1 and 2.2 to:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2.1.X / 2.2.X users in the conditions above should not be subject to data loss unless assertions are disabled, in which
case the suspect SSTables must be backed up immediately and manually recovered, as they are subject to data loss
during auto-compaction.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I also have one piece of feedback on the policies; I don&apos;t see any benefit in being able to turn off logging of capped expirations (especially since we&apos;re using NoSpamLogger) but I do I think the client warning is useful.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree and updated the patch with this suggestion, but at the same time I think advanced operators may want to control the periodicity of the logging, so I created a property &lt;tt&gt;cassandra.expiration_overflow_warning_interval_minutes=5&lt;/tt&gt; to control this.&lt;br/&gt;
 &#160;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I also noticed that the logging of a parse error/invalid value for the policy sysprop is at DEBUG in the current patches, but it might be sensible to draw a bit more attention to that if it happens.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Agreed, changed the logging to WARN.&lt;/p&gt;

&lt;p&gt;I finished the cleanup of the patch and already provided a version for all branches. The 2.1 and 2.2 versions are pretty much the same, as well as the 3.0/3.11/trunk, except for some minor conflicts. Please find below a short summary of the changes per branch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;2.1:
	&lt;ul&gt;
		&lt;li&gt;Add REJECT and CAP expiration date overflow policies and tests&lt;/li&gt;
		&lt;li&gt;Cap max default TTL at 20 years and tests&lt;/li&gt;
		&lt;li&gt;Add NEWS.txt entry&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;2.2:
	&lt;ul&gt;
		&lt;li&gt;Same as 2.1, few minor import conflicts&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;3.0
	&lt;ul&gt;
		&lt;li&gt;Add REJECT and CAP, CAP_NOWARN expiration date overflow policies and tests&lt;/li&gt;
		&lt;li&gt;Add ability to scrub to fix negative localDeletionTime and tests with broken SSTables&lt;/li&gt;
		&lt;li&gt;Add ability to sstablemetadata to show minLocalDeletionTime&lt;/li&gt;
		&lt;li&gt;Add expiration date overflow policies to jvm.options file&lt;/li&gt;
		&lt;li&gt;Add NEWS.txt entry&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;3.11
	&lt;ul&gt;
		&lt;li&gt;Same as 3.0, few minor conflicts during merge&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;master
	&lt;ul&gt;
		&lt;li&gt;Same as 3.11, few minor conflicts during merge&lt;/li&gt;
		&lt;li&gt;Removed ability of scrub to fix sstables with negative localdeletionTime and tests&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;dtest
	&lt;ul&gt;
		&lt;li&gt;Test all policies on CQL for default and user supplied TTL&lt;/li&gt;
		&lt;li&gt;Test cap policy on thrift for default and user supplied TTL&lt;/li&gt;
		&lt;li&gt;Check that offline scrub recovers sstable with negative localDeletionTime&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I submitted a preliminary round of CI with the non-cleaned up patch and the results looked good. I will submit again for all the branches below and post the results here when they are ready.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-14092-v5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-14092-v5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-14092-v5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...pauloricardomg:3.11-14092-v5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-14092-v5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/master...pauloricardomg:14092-v5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16349833" author="pauloricardomg" created="Fri, 2 Feb 2018 06:07:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;To clarify, CAP and CAP_NOWARN will cap the expiry but we&apos;ll have NO INTENTION of ever fixing it in an upgrade?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;We&apos;re not promising to fix the correct TTL in an upgrade, but we could do it in some cases, but I prefer to leave this decision for later.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Or would they have to do a scrub to convert anything that got capped to its actual TTL?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;The scrub is just to fix SSTables of affected systems that overflowed from 2018-01-19T03:14:06+00:00 until the upgrade and were backed up. As I said before, we&apos;re not doing any promise yet regarding honoring the actual TTL when it&apos;s capped. But if we were to implement this would probably be done during upgradesstables and not scrub.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I think it&apos;s worth pointing out that REJECT is a ticking time bomb.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I agree but I don&apos;t feel strongly about the default, because the policies will be clearly specified in big letters in the NEWS.txt which is the document which everyone should read before upgrading, so if you don&apos;t want applications to break in your organization just change your policy to CAP.&lt;/p&gt;

&lt;p&gt;Do you mind proof-reading the NEWS.txt and check if something is not clear/can be improved? Thanks!&lt;/p&gt;</comment>
                            <comment id="16349974" author="mshuler" created="Fri, 2 Feb 2018 08:36:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;We should also probably publish this text (or a subset of it) during the release announcement e-mail.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I&apos;ll definitely include the text with the release, which sounds pretty complete to me. Thanks for writing it up.&lt;/p&gt;</comment>
                            <comment id="16351979" author="kurtg" created="Mon, 5 Feb 2018 02:09:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;Do you mind proof-reading the NEWS.txt and check if something is not clear/can be improved? Thanks!&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Looks good, but a few things to reduce confusion:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;Can we stick a PLEASE READ/WARNING/ALERT or something in the title to make it clear that users actually have to read that section?&lt;br/&gt;
Can we be a bit more clear on the following points?&lt;/li&gt;
	&lt;li&gt;Expired records due to overflow &lt;b&gt;will&lt;/b&gt; be removed permanently after a compaction. (there&apos;s only a very small chance that it would survive a compaction, and that&apos;s only if they previously wrote the same record and it overflowed by more, which somehow made it into a separate SSTable and didn&apos;t get compacted with )&lt;/li&gt;
	&lt;li&gt;Data that is expired due to overflow &lt;b&gt;will&lt;/b&gt; not be queryable and that prior to patching they&apos;ll have no way of telling they inserted with an overflowed TTL.&lt;/li&gt;
	&lt;li&gt;How to search for negative min local deletion times (sstablemetadata)&lt;/li&gt;
	&lt;li&gt;Probably a good time to note that all users will need to upgrade to &amp;gt;4.0 by 2038 and that during upgrade their TTL&apos;s will be set to their expected value.&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="16352862" author="beobal" created="Mon, 5 Feb 2018 20:04:09 +0000"  >&lt;p&gt;I think we&apos;re almost there with this, I just have a few smallish comments on the v5 patches:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In the 3.0+ branches, &lt;tt&gt;ExpirationDateOverflowHandling::maybeApplyExpirationDateOverflowPolicy&lt;/tt&gt; can use &lt;tt&gt;Cell.NO_TTL&lt;/tt&gt; rather than 0 in the first check.&lt;/li&gt;
	&lt;li&gt;In 3.0+ you renamed the static policy field to have a shorter name, but missed that in the 2.1 &amp;amp; 2.2 branches.&lt;/li&gt;
	&lt;li&gt;In 2.1 I saw some (very) intermittent test failures in TTLTest. I instrumented &lt;tt&gt;checkTTLIsCapped&lt;/tt&gt; to print out the (min | actual | max) TTLs to sysout and eventually managed to repro it. You can see from the output that in the first line, the min and actual are actually &amp;gt; the max, which caused the test to fail (this happened around 10% of the time).&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
testlist:
 [echo] running test bucket 0 tests
 [junit] WARNING: multiple versions of ant detected in path &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; junit 
 [junit] jar:file:/usr/local/Cellar/ant@1.9/1.9.8/libexec/lib/ant.jar!/org/apache/tools/ant/Project.class
 [junit] and jar:file:/Users/sam/git/cassandra/build/lib/jars/ant-1.9.4.jar!/org/apache/tools/ant/Project.class
 [junit] Testsuite: org.apache.cassandra.cql3.validation.operations.TTLTest
 [junit] Tests run: 5, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 2.024 sec
 [junit] 
 [junit] ------------- Standard Output ---------------
 [junit] WARN 18:01:55 JNA link failure, one or more &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; method will be unavailable.
 [junit] WARN 18:01:55 JNA link failure, one or more &lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt; method will be unavailable.
 [junit] WARN 18:01:55 Request on table cql_test_keyspace.table_1 with &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; ttl of 630720000 seconds exceeds maximum supported expiration date of 2038-01-19T03:14:06+00:00 and will have its expiration capped to that date. In order to avoid &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; use a lower TTL or upgrade to a version where &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; limitation is fixed. See CASSANDRA-14092 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more details.
 [junit] WARN 18:01:55 Request on table cql_test_keyspace.table_1 with &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; ttl of 630720000 seconds exceeds maximum supported expiration date of 2038-01-19T03:14:06+00:00 and will have its expiration capped to that date. In order to avoid &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; use a lower TTL or upgrade to a version where &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; limitation is fixed. See CASSANDRA-14092 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more details.
 [junit] 629629931 | 629629931 | 629629930
 [junit] 629629930 | 629629930 | 629629930
 [junit] 629629930 | 629629930 | 629629930
 [junit] 629629930 | 629629930 | 629629930
 [junit] 629629930 | 629629930 | 629629930
 [junit] 629629930 | 629629930 | 629629930
 [junit] 629629930 | 629629930 | 629629930
 [junit] 629629930 | 629629930 | 629629930
 [junit] 629629930 | 629629930 | 629629930
 [junit] 629629930 | 629629930 | 629629930
 [junit] 629629930 | 629629930 | 629629930
 [junit] 629629930 | 629629930 | 629629930
 [junit] 629629930 | 629629930 | 629629930
 [junit] ------------- ---------------- ---------------
 [junit] Testcase: testCapExpirationDatePolicyDefaultTTL(org.apache.cassandra.cql3.validation.operations.TTLTest): FAILED
 [junit] &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
 [junit] junit.framework.AssertionFailedError
 [junit] at org.apache.cassandra.cql3.validation.operations.TTLTest.checkTTLIsCapped(TTLTest.java:259)
 [junit] at org.apache.cassandra.cql3.validation.operations.TTLTest.testCapExpirationDatePolicyDefaultTTL(TTLTest.java:139)
 [junit] 
 [junit]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The last thing is about providing a route to fix up overflowed dates via scrub, I think we should definitely leave the remedial Scrubber code in trunk until we have a proper fix committed. This will be in for 4.0, and at that point we can hapilly remove it, but until then it feels wrong to not have it. I also think we should have the scrub fix in 2.1 &amp;amp; 2.2 as some users have not yet moved to 3.x and they should probably get the chance to repair (maybe) their data if they want/are able to.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16357234" author="pauloricardomg" created="Thu, 8 Feb 2018 17:10:47 +0000"  >&lt;p&gt;Thanks for the review, this took a bit longer than expected as I found an edge case which required a change from the previous approach as I describe later. First, see the follow-up from the previous round of review:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In the 3.0+ branches, ExpirationDateOverflowHandling::maybeApplyExpirationDateOverflowPolicy can use Cell.NO_TTL rather than 0 in the first check.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Agreed, fixed &lt;a href=&quot;https://github.com/apache/cassandra/commit/4bcea858f62b619b83a5db83f0cd93e192fea80c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In 3.0+ you renamed the static policy field to have a shorter name, but missed that in the 2.1 &amp;amp; 2.2 branches.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Good catch, fixed &lt;a href=&quot;https://github.com/apache/cassandra/commit/df59f2de8042e7ea67e520d509d675da1d53bbce&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;In 2.1 I saw some (very) intermittent test failures in TTLTest. I instrumented checkTTLIsCapped to print out the (min | actual | max) TTLs to sysout and eventually managed to repro it. You can see from the output that in the first line, the min and actual are actually &amp;gt; the max, which caused the test to fail (this happened around 10% of the time).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Oh, that&apos;s funny! Perhaps it could be related to the platform, as I cannot reproduce this locally? In any case, I updated the check &lt;a href=&quot;https://github.com/apache/cassandra/commit/18be7f140c3c2159f69d50b1bfb068927c734a13&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; to be more deterministic.&lt;/p&gt;

&lt;p&gt;I also noticed that we weren&apos;t applying the expiration overflow policy in the CQLv2 interface, so I updated it &lt;a href=&quot;https://github.com/apache/cassandra/commit/4230a5b4126e972827990dc33c1a9140af07afe1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. I find it hard someone is using this but I wouldn&apos;t be totally surprised.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I think we should have the scrub fix in 2.1 &amp;amp; 2.2 as some users have not yet moved to 3.x and they should probably get the chance to repair (maybe) their data if they want/are able to.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Agreed, as noted in the NEWS.txt, 2.1/2.2 is only affected if users have assertions disabled, but given that we have this &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.1/conf/cassandra-env.sh#L173&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;comment&lt;/a&gt; on 2.1 I wouldn&apos;t be surprised if some users with assertions disabled hit this.&lt;/p&gt;

&lt;p&gt;While writing the 2.1 scrubber (which is slightly different from 3.0 due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8099&quot; title=&quot;Refactor and modernize the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8099&quot;&gt;&lt;del&gt;CASSANDRA-8099&lt;/del&gt;&lt;/a&gt;), I found a nasty edge case with the recovery process. The problem is that, if the cell with negative/overflowed &lt;tt&gt;localExpirationTime&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/30ed83d9266a03debad98ffac5610dcb3ae30934/src/java/org/apache/cassandra/db/rows/AbstractCell.java#L95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;is converted to a tombstone during compaction&lt;/a&gt;, we can&apos;t convert the tombstone back into an expired cell because the TTL value is lost and we can&apos;t differentiate this from an ordinary tombstone. Furthermore, even if the original SSTable is scrubbed and the negative &lt;tt&gt;localExpirationTime&lt;/tt&gt; is converted to &lt;tt&gt;MAX_DELETION_TIME&lt;/tt&gt;, if the tombstone was already generated, it will shadow/delete the fixed expired cell, because &lt;a href=&quot;https://github.com/apache/cassandra/blob/8b3a60b9a7dbefeecc06bace617279612ec7092d/src/java/org/apache/cassandra/db/Conflicts.java#L43&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;deleted cells have precedence over live cells when the timestamp is the same&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I updated &lt;tt&gt;recover_negative_expiration_date_sstables_with_scrub&lt;/tt&gt; to &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/63b0e7d51fbacf4fabbb860d81873605c3b66c92&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;add an SSTable with the expired cell converted to a tombstone&lt;/a&gt;, and verified that an existing tombstone shadows recovered data in the current version.&lt;/p&gt;

&lt;p&gt;In order to fix this, the idea is during scrub increment the timestamp of cells with negative &lt;tt&gt;localExpirationTime&lt;/tt&gt; by one in addition to setting the &lt;tt&gt;localExpirationTime&lt;/tt&gt; to &lt;tt&gt;MAX_DELETION_TIME&lt;/tt&gt;, so the recovered cell will shadow/supersede the potential tombstone that was already written.&lt;/p&gt;

&lt;p&gt;Since this will not recreate the row, but technically reinsert the row with a higher timestamp, we cannot do this automatically on scrub, since it may overwrite an existing row inserted just one millisecond after the original row (while very hard to happen in practice, this may depend on application logic). For this reason, the user needs to specify the &lt;tt&gt;--reinsert-overflowed-ttl&lt;/tt&gt; option during scrub to perform the recovery.&lt;/p&gt;

&lt;p&gt;This approach is implemented &lt;a href=&quot;https://github.com/apache/cassandra/commit/5f9f704449ed1ef579c61953b02a9ef32f13082b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; on 3.0 and ported to all other branches in a separate commit.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The last thing is about providing a route to fix up overflowed dates via scrub, I think we should definitely leave the remedial Scrubber code in trunk until we have a proper fix committed.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Since 4.0 was not released, and it will come out with this fix it&apos;s impossible that someone will hit this on 4.0, but I don&apos;t see any problem in keeping the scrub option for the lazy ones upgrading from 3.x without fixing their SSTables beforehand. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; For this reason I kept the 3.11 SSTables in the 4.X (d)tests.&lt;/p&gt;

&lt;p&gt;To prevent scrub and the tests from throwing an &lt;tt&gt;AssertionError&lt;/tt&gt; on 2.1 I removed &lt;a href=&quot;https://github.com/apache/cassandra/commit/4501eee5c962547c059a4f624155c5e18d5369d3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this assertion&lt;/a&gt;, since it&apos;s no longer necessary given we apply the overflow policy.&lt;/p&gt;

&lt;p&gt;Finally, I &lt;a href=&quot;https://github.com/apache/cassandra/commit/c3e1fcc25b3db9db212dfc805a47430ff537b101&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;refactored&lt;/a&gt; the NEWS.txt section a bit to take &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=KurtG&quot; class=&quot;user-hover&quot; rel=&quot;KurtG&quot;&gt;KurtG&lt;/a&gt; comments into account and also to give more emphasis to the expiration overflow policies since this will be what most users need to care about, and added a recovery subsection with detailed recovery instructions.&lt;/p&gt;

&lt;p&gt;I now wonder if this notice has gotten to big and is cluttering the NEWS.txt file too much - what may confuse users looking for upgrade instructions - and we should maybe create a new WARNING/IMPORTANT file and add a pointer to it in the NEWS.txt file instead?&lt;/p&gt;

&lt;p&gt;To facilitate review, I squashed the previous commits and created a new branch with new commits only representing changes since last review (except for the 2.2 patch, which is basically the same as 2.1 except the additional commit simplifying TTLTest). The previous CI looked good, I will submit a new CI run and post the results here later.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-14092-v6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-14092-v6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-14092-v6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...pauloricardomg:3.11-14092-v6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-14092-v6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/master...pauloricardomg:14092&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16358318" author="beobal" created="Fri, 9 Feb 2018 12:15:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;Since 4.0 was not released, and it will come out with this fix it&apos;s impossible that someone will hit this on 4.0, but I don&apos;t see any problem in keeping the scrub option for the lazy ones upgrading from 3.x without fixing their SSTables beforehand.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yeah, this was the scenario I was thinking about.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;I now wonder if this notice has gotten to big and is cluttering the NEWS.txt file too much - what may confuse users looking for upgrade instructions - and we should maybe create a new WARNING/IMPORTANT file and add a pointer to it in the NEWS.txt file instead?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I tend to agree with you. Even if adding another file is less than ideal, it&apos;s probably better than adding a large, unchanging header as that&apos;s likely just going to lead to more users not properly reading it and missing critical info about other future upgrades. So I&apos;d be +1 on adding a new file (&lt;tt&gt;CASSANDRA&amp;#45;14092.txt&lt;/tt&gt; maybe?) and just a brief explanation of the severity of the issue plus a &lt;b&gt;very&lt;/b&gt; clear pointer to more detailed file at the top of &lt;tt&gt;NEWS.txt&lt;/tt&gt;. I think you should keep the&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARNING: MAXIMUM TTL EXPIRATION DATE NOTICE
--------------------------------------------
(General upgrading instructions are available in the next section)

The maximum expiration timestamp that can be represented by the storage engine is 2038-01-19T03:14:06+00:00,
which means that inserts with TTL that expire after &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; date are not currently supported.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and add the pointer after that.&lt;/p&gt;

&lt;p&gt;1 nit on the text in &lt;tt&gt;NEWS.txt&lt;/tt&gt;, you have a double &quot;the&quot; in the sentence &lt;br/&gt;
 &lt;tt&gt;&quot;As time progresses, the maximum supported TTL will be gradually reduced as the the maximum expiration date approaches.&quot;&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;Extracting the news text to a new file notwithstanding, I&apos;m +1 on the latest patches (pending CI, of course). Thanks for all the hard work on this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16359943" author="pauloricardomg" created="Sun, 11 Feb 2018 13:37:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;I tend to agree with you. Even if adding another file is less than ideal, it&apos;s probably better than adding a large, unchanging header as that&apos;s likely just going to lead to more users not properly reading it and missing critical info about other future upgrades. So I&apos;d be +1 on adding a new file (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14092&quot; title=&quot;Max ttl of 20 years will overflow localDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14092&quot;&gt;&lt;del&gt;CASSANDRA-14092&lt;/del&gt;&lt;/a&gt;.txt maybe?) and just a brief explanation of the severity of the issue plus a very clear pointer to more detailed file at the top of NEWS.txt.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sounds good. Settled on this (not-so) summarized note for NEWS.txt (the full text goes on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14092&quot; title=&quot;Max ttl of 20 years will overflow localDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14092&quot;&gt;&lt;del&gt;CASSANDRA-14092&lt;/del&gt;&lt;/a&gt;.txt):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;PLEASE READ: MAXIMUM TTL EXPIRATION DATE NOTICE (CASSANDRA-14092)
------------------------------------------------------------------
(General upgrading instructions are available in the next section)

The maximum expiration timestamp that can be represented by the storage engine is
2038-01-19T03:14:06+00:00, which means that inserts with TTL thatl expire after
this date are not currently supported. By default, INSERTS with TTL exceeding the
maximum supported date are rejected, but it&apos;s possible to choose a different
 expiration overflow policy. See CASSANDRA]-14092.txt for more details.

Prior to 3.0.16 (3.0.X) and 3.11.2 (3.11.x) there was no protection against INSERTS
with TTL expiring after the maximum supported date, causing the expiration time
field to overflow and the records to expire immediately. Clusters in the 2.X and
lower series are not subject to this when assertions are enabled. Backed up SSTables
can be potentially recovered and recovery instructions can be found on the
CASSANDRA-14092.txt file.

If you use or plan to use very large TTLS (10 to 20 years), read CASSANDRA-14092.txt
for more information.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;&lt;p&gt;Extracting the news text to a new file notwithstanding, I&apos;m +1 on the latest patches (pending CI, of course).&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Still had to fix a couple of test nits and resubmit tests after rebase to get a clean run (attached internal CI screenshots, verified other failures and they look unrelated).&lt;/p&gt;

&lt;p&gt;I&apos;ve added the new &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14092&quot; title=&quot;Max ttl of 20 years will overflow localDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14092&quot;&gt;&lt;del&gt;CASSANDRA-14092&lt;/del&gt;&lt;/a&gt;.txt file to the debian/redhat package manifests &lt;a href=&quot;https://github.com/apache/cassandra/commit/a25898253ea3b5bc7262ff2d17f8466d489eaf96&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; (thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mshuler&quot; class=&quot;user-hover&quot; rel=&quot;mshuler&quot;&gt;mshuler&lt;/a&gt; for the help).&lt;/p&gt;

&lt;p&gt;Committed as &lt;tt&gt;b2949439ec62077128103540e42570238520f4ee&lt;/tt&gt; to cassandra-2.1 and merged up to cassandra-2.2, cassandra-3.0, cassandra-3.11 and master (phew). cassandra-dtest commit merged as &lt;tt&gt;781c4ecdf67bb63f508e8af70599b45b896c28ae&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;ve kept the previous branches with separate commits, and created a new branch with the squashed + rebased version:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-14092-final&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-14092-final&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-14092-final&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...pauloricardomg:3.11-14092-final&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-14092-final&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/master...pauloricardomg:14092-rebased&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I will open follow-up tickets to fix this limitation permanently and add the expiration overflow notice to the docs.&lt;/p&gt;

&lt;p&gt;Thanks for all who helped with feedback and Sam for kindly reviewing this.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                            <outwardlinks description="is a parent of">
                                        <issuelink>
            <issuekey id="13137703">CASSANDRA-14227</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13133278">CASSANDRA-14188</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12610619">CASSANDRA-4771</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13137705">CASSANDRA-14228</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12910103" name="2.1-14092-dtest.png" size="57338" author="pauloricardomg" created="Sun, 11 Feb 2018 13:27:29 +0000"/>
                            <attachment id="12910102" name="2.1-14092-testall.png" size="31674" author="pauloricardomg" created="Sun, 11 Feb 2018 13:27:29 +0000"/>
                            <attachment id="12910101" name="2.2-14092-dtest.png" size="51750" author="pauloricardomg" created="Sun, 11 Feb 2018 13:27:28 +0000"/>
                            <attachment id="12910100" name="2.2-14092-testall.png" size="103645" author="pauloricardomg" created="Sun, 11 Feb 2018 13:27:27 +0000"/>
                            <attachment id="12910099" name="3.0-14092-dtest.png" size="71205" author="pauloricardomg" created="Sun, 11 Feb 2018 13:27:22 +0000"/>
                            <attachment id="12910098" name="3.0-14092-testall.png" size="153956" author="pauloricardomg" created="Sun, 11 Feb 2018 13:27:25 +0000"/>
                            <attachment id="12910097" name="3.11-14092-dtest.png" size="94611" author="pauloricardomg" created="Sun, 11 Feb 2018 13:27:28 +0000"/>
                            <attachment id="12910096" name="3.11-14092-testall.png" size="130704" author="pauloricardomg" created="Sun, 11 Feb 2018 13:27:29 +0000"/>
                            <attachment id="12910095" name="trunk-14092-dtest.png" size="91870" author="pauloricardomg" created="Sun, 11 Feb 2018 13:27:22 +0000"/>
                            <attachment id="12910094" name="trunk-14092-testall.png" size="134639" author="pauloricardomg" created="Sun, 11 Feb 2018 13:27:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>10.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 40 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3nhbz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12341001">3.0.15</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>samt</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>