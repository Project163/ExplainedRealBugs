<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:23:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15215] VIntCoding should read and write more efficiently</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15215</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Most vints occupy significantly fewer than 8 bytes, and most buffers have &amp;gt;= 8 bytes spare, in which case we can construct the relevant bytes in a register and memcpy them to the correct position.  Since we read and write a lot of vints, this waste is probably measurable, particularly during compaction and flush, and can probably be considered a performance bug.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13245158">CASSANDRA-15215</key>
            <summary>VIntCoding should read and write more efficiently</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="Gerrrr">Alex Sorokoumov</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                    </labels>
                <created>Tue, 16 Jul 2019 09:36:50 +0000</created>
                <updated>Fri, 11 Nov 2022 19:00:49 +0000</updated>
                            <resolved>Wed, 2 Feb 2022 12:20:22 +0000</resolved>
                                        <fixVersion>4.1-alpha1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                                    <component>Local/Compaction</component>
                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17436519" author="gerrrr" created="Sun, 31 Oct 2021 17:27:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; if I understood your idea correctly, you suggest writing relevant bytes directly instead of preparing the thread-local byte array and memcpy&apos;ing it into the given buffer. Is my interpretation correct? In the title and description you also mentioned reads, but I haven&apos;t figured how to adjust this idea there, so here are results for writes only.&lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Code&quot;&gt;&lt;/a&gt;Code&lt;/h2&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Description&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...Gerrrr:15215-baseline-trunk?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;baseline&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk + benchmark&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...Gerrrr:15215-trunk?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;patch + benchmark&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

&lt;h2&gt;&lt;a name=&quot;Setup&quot;&gt;&lt;/a&gt;Setup&lt;/h2&gt;

&lt;p&gt;Each benchmark does &lt;tt&gt;VIntCoding.writeUnsignedVInt&lt;/tt&gt; on a &lt;tt&gt;long&lt;/tt&gt; from 1 to 9 bytes. The write target is a &lt;tt&gt;ByteBuffer&lt;/tt&gt; - both on- and off- heap.&lt;/p&gt;

&lt;p&gt;The results are produced on a MBP 2019 - 2,3 GHz 8-Core Intel Core i9.&lt;/p&gt;
&lt;h2&gt;&lt;a name=&quot;Results&quot;&gt;&lt;/a&gt;Results&lt;/h2&gt;
&lt;h3&gt;&lt;a name=&quot;Baseline&quot;&gt;&lt;/a&gt;Baseline&lt;/h3&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Benchmark                        (allocation)  Mode  Cnt   Score   Error  Units
VIntCodingBench.testWrite1Byte           HEAP  avgt   15   9.084 &#177; 5.196  ns/op
VIntCodingBench.testWrite1Byte         DIRECT  avgt   15   5.037 &#177; 0.638  ns/op
VIntCodingBench.testWrite2Bytes          HEAP  avgt   15  15.604 &#177; 0.646  ns/op
VIntCodingBench.testWrite2Bytes        DIRECT  avgt   15  15.028 &#177; 0.568  ns/op
VIntCodingBench.testWrite3Bytes          HEAP  avgt   15  16.704 &#177; 0.461  ns/op
VIntCodingBench.testWrite3Bytes        DIRECT  avgt   15  17.410 &#177; 0.489  ns/op
VIntCodingBench.testWrite4Bytes          HEAP  avgt   15  17.086 &#177; 0.527  ns/op
VIntCodingBench.testWrite4Bytes        DIRECT  avgt   15  20.307 &#177; 0.705  ns/op
VIntCodingBench.testWrite5Bytes          HEAP  avgt   15  17.395 &#177; 0.578  ns/op
VIntCodingBench.testWrite5Bytes        DIRECT  avgt   15  17.558 &#177; 0.512  ns/op
VIntCodingBench.testWrite6Bytes          HEAP  avgt   15  18.114 &#177; 0.967  ns/op
VIntCodingBench.testWrite6Bytes        DIRECT  avgt   15  19.023 &#177; 0.591  ns/op
VIntCodingBench.testWrite7Bytes          HEAP  avgt   15  18.004 &#177; 0.298  ns/op
VIntCodingBench.testWrite7Bytes        DIRECT  avgt   15  19.081 &#177; 0.601  ns/op
VIntCodingBench.testWrite8Bytes          HEAP  avgt   15  18.466 &#177; 0.463  ns/op
VIntCodingBench.testWrite8Bytes        DIRECT  avgt   15  20.228 &#177; 5.620  ns/op
VIntCodingBench.testWrite9Bytes          HEAP  avgt   15  18.553 &#177; 0.537  ns/op
VIntCodingBench.testWrite9Bytes        DIRECT  avgt   15  20.101 &#177; 0.476  ns/op
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h3&gt;&lt;a name=&quot;Patch&quot;&gt;&lt;/a&gt;Patch&lt;/h3&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Benchmark                        (allocation)  Mode  Cnt   Score   Error  Units
VIntCodingBench.testWrite1Byte           HEAP  avgt   15   4.728 &#177; 0.077  ns/op
VIntCodingBench.testWrite1Byte         DIRECT  avgt   15   6.415 &#177; 3.157  ns/op
VIntCodingBench.testWrite2Bytes          HEAP  avgt   15   8.244 &#177; 0.440  ns/op
VIntCodingBench.testWrite2Bytes        DIRECT  avgt   15   9.136 &#177; 3.979  ns/op
VIntCodingBench.testWrite3Bytes          HEAP  avgt   15   8.714 &#177; 0.134  ns/op
VIntCodingBench.testWrite3Bytes        DIRECT  avgt   15   9.690 &#177; 2.735  ns/op
VIntCodingBench.testWrite4Bytes          HEAP  avgt   15   8.634 &#177; 0.164  ns/op
VIntCodingBench.testWrite4Bytes        DIRECT  avgt   15   6.830 &#177; 0.061  ns/op
VIntCodingBench.testWrite5Bytes          HEAP  avgt   15   8.389 &#177; 0.207  ns/op
VIntCodingBench.testWrite5Bytes        DIRECT  avgt   15   8.059 &#177; 1.537  ns/op
VIntCodingBench.testWrite6Bytes          HEAP  avgt   15  10.861 &#177; 0.336  ns/op
VIntCodingBench.testWrite6Bytes        DIRECT  avgt   15   9.816 &#177; 1.482  ns/op
VIntCodingBench.testWrite7Bytes          HEAP  avgt   15  11.045 &#177; 0.419  ns/op
VIntCodingBench.testWrite7Bytes        DIRECT  avgt   15  10.702 &#177; 2.377  ns/op
VIntCodingBench.testWrite8Bytes          HEAP  avgt   15  10.375 &#177; 0.423  ns/op
VIntCodingBench.testWrite8Bytes        DIRECT  avgt   15   7.237 &#177; 0.176  ns/op
VIntCodingBench.testWrite9Bytes          HEAP  avgt   15  11.200 &#177; 0.365  ns/op
VIntCodingBench.testWrite9Bytes        DIRECT  avgt   15   8.152 &#177; 0.282  ns/op
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17436524" author="benedict" created="Sun, 31 Oct 2021 17:55:21 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Gerrrr&quot; class=&quot;user-hover&quot; rel=&quot;Gerrrr&quot;&gt;Gerrrr&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Thanks for picking this up, but what you&apos;ve proposed in the patch isn&apos;t quite what I had in mind. The premise is to introduce a new method to &lt;tt&gt;DataOutputPlus&lt;/tt&gt; that is able to write up to 8 bytes from a long, so it would be something like &lt;tt&gt;putBytes(long register, int bytes)&lt;/tt&gt; where &lt;tt&gt;bytes&amp;lt;=8&lt;/tt&gt;. If there are more than 8 bytes left in the underlying storage then &lt;tt&gt;putLong(offset, register)&lt;/tt&gt; is invoked on any underlying &lt;tt&gt;ByteBuffer&lt;/tt&gt;, and the offset counter is incremented only by &lt;tt&gt;bytes&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This same approach can of course be performed directly to a &lt;tt&gt;ByteBuffer&lt;/tt&gt;, and symmetrically for &lt;tt&gt;readBytes(bytes)&lt;/tt&gt; with &lt;tt&gt;DataInputPlus&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;This way the vint can be assembled and inserted using simple register instructions while there is &amp;gt;= 8 bytes in the underlying storage buffer, i.e. the majority of instances. Otherwise we could fall back to this suggested approach or any other.&lt;/p&gt;</comment>
                            <comment id="17436528" author="benedict" created="Sun, 31 Oct 2021 18:26:36 +0000"  >&lt;p&gt;Worth noting that the relative performance of the &lt;tt&gt;ByteBuffer&lt;/tt&gt; variants is probably harder to predict, and depends a lot on how smart HotSpot is, and the morphism of the call-sites.&lt;/p&gt;

&lt;p&gt;Also, your approach already appears to be an improvement over the status quo which is great! Though it might be less impressive for &lt;tt&gt;DataOutput&lt;/tt&gt; due to the greater complexity of implementation for their corresponding methods. I think it is &lt;em&gt;likely&lt;/em&gt; that they will all be monomorphic call-sites which should mitigate it, but they may have to potentially invoke &lt;tt&gt;flush()&lt;/tt&gt; multiple times which at minimum leads to much larger methods.&lt;/p&gt;</comment>
                            <comment id="17436539" author="gerrrr" created="Sun, 31 Oct 2021 19:10:12 +0000"  >&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;! Thank you so much for a quick and elaborate answer! &lt;/p&gt;

&lt;p&gt;As a next step, I am going to extend the benchmark for implementations of &lt;tt&gt;DataOutput&lt;/tt&gt; to estimate how well my patch works there. After that, I will extend &lt;tt&gt;DataOutputPlus&lt;/tt&gt; and &lt;tt&gt;DataInputPlus&lt;/tt&gt; as you suggested. &lt;/p&gt;

&lt;p&gt;As I am working on this patch in my free time, it might take a bit. I hope to provide an update by the end of next week.&lt;/p&gt;</comment>
                            <comment id="17437244" author="blerer" created="Tue, 2 Nov 2021 09:48:32 +0000"  >&lt;p&gt;This ticket might be a good place to also improve the performance of the &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/utils/vint/VIntCoding.java#L279&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;computeUnsignedVIntSize&lt;/a&gt; method which relies on a division operation. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; mentioned to me that: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; 9 - ((magnitude - 1) / 7);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;could be replaced by&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; (639 - magnitude * 9) &amp;gt;&amp;gt; 6;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which produce the same result and avoid the division high cost in term of CPU time.  &lt;/p&gt;</comment>
                            <comment id="17437257" author="gerrrr" created="Tue, 2 Nov 2021 10:04:32 +0000"  >&lt;p&gt;Thank you for the suggestion! I will add a benchmark to see if there is measurable difference.&lt;/p&gt;</comment>
                            <comment id="17437451" author="blambov" created="Tue, 2 Nov 2021 16:15:21 +0000"  >&lt;p&gt;A small suggestion: we also need a benchmark that randomly chooses a length, so that the branch doesn&apos;t always hit the same target and isn&apos;t predictable. Because in our code we call this encoding for many different types of values, I expect unpredictable length to be common.&lt;/p&gt;

&lt;p&gt;Also, because we are switching on the exact value of &lt;tt&gt;size&lt;/tt&gt;, it makes sense to put the mask explicitly in the specific cases. To me that also makes it a bit easier to read.&lt;/p&gt;

&lt;p&gt;If you do use the magic numbers above, please add a comment that they are hand-picked to match &lt;tt&gt;9 - ((magnitude - 1) / 7)&lt;/tt&gt; for &lt;tt&gt;magnitude&lt;/tt&gt;&#160;between 0 and 63.&lt;/p&gt;</comment>
                            <comment id="17437456" author="benedict" created="Tue, 2 Nov 2021 16:19:38 +0000"  >&lt;p&gt;If we&apos;re improving the benchmark we might also want to consider increasing the morphism of the call sites, i.e. randomly supplying either a &lt;tt&gt;DirectByteBuffer&lt;/tt&gt; or &lt;tt&gt;HeapByteBuffer&lt;/tt&gt;, and maybe even a &lt;tt&gt;MappedByteBuffer&lt;/tt&gt; to make it megamorphic.&lt;/p&gt;

&lt;p&gt;Preferably we would have three benchmarks, namely monomorphic (HeapByteBuffer only), bimorphic (HeapByteBuffer and DirectByteBuffer selected randomly), megamorphic (HBB, DBB and MappedByteBuffer))&lt;/p&gt;

&lt;p&gt;The &lt;tt&gt;DataOutput&lt;/tt&gt; variants of the test can similarly be updated to pick two or three variants.&lt;/p&gt;

&lt;p&gt;FWIW, my expectation is that there will be no relative difference between approaches at different levels of morphism, but HotSpot &lt;em&gt;might&lt;/em&gt; make poor decisions particularly for the above &lt;tt&gt;ByteBuffer&lt;/tt&gt; approach. We could also just check the byte code, but that is only a snapshot of HotSpot&apos;s decision-making, and its validity depends on us not changing the code to break it (not that we unfortunately currently monitor these benchmarks for regressions).&lt;/p&gt;</comment>
                            <comment id="17440071" author="gerrrr" created="Sun, 7 Nov 2021 18:44:40 +0000"  >&lt;p&gt;Short status update: I just pushed changes to the benchmarks as suggested by Branimir and Benedict. The changes are:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;All tests have monomorphic, bimorphic, and megamorphic versions.&lt;/li&gt;
	&lt;li&gt;Added a test that writes random longs to the ByteBuffer.&lt;/li&gt;
	&lt;li&gt;Added a test for calculating VInt size and applied Branimir&apos;s formula.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Results:&lt;/p&gt;
&lt;h4&gt;&lt;a name=&quot;Baseline&quot;&gt;&lt;/a&gt;Baseline&lt;/h4&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Benchmark                                    (allocation)  Mode  Cnt   Score   Error  Units
VIntCodingBench.testComputeUnsignedVIntSize   monomorphic  avgt   15  17.069 &#177; 1.087  ns/op
VIntCodingBench.testComputeUnsignedVIntSize     bimorphic  avgt   15  17.323 &#177; 0.656  ns/op
VIntCodingBench.testComputeUnsignedVIntSize   megamorphic  avgt   15  16.791 &#177; 0.473  ns/op
VIntCodingBench.testWrite1Byte                monomorphic  avgt   15   9.047 &#177; 0.254  ns/op
VIntCodingBench.testWrite1Byte                  bimorphic  avgt   15  16.935 &#177; 0.207  ns/op
VIntCodingBench.testWrite1Byte                megamorphic  avgt   15  17.835 &#177; 0.090  ns/op
VIntCodingBench.testWrite2Bytes               monomorphic  avgt   15  18.612 &#177; 0.194  ns/op
VIntCodingBench.testWrite2Bytes                 bimorphic  avgt   15  25.033 &#177; 0.239  ns/op
VIntCodingBench.testWrite2Bytes               megamorphic  avgt   15  28.352 &#177; 0.115  ns/op
VIntCodingBench.testWrite3Bytes               monomorphic  avgt   15  21.333 &#177; 0.197  ns/op
VIntCodingBench.testWrite3Bytes                 bimorphic  avgt   15  26.173 &#177; 0.170  ns/op
VIntCodingBench.testWrite3Bytes               megamorphic  avgt   15  29.983 &#177; 0.208  ns/op
VIntCodingBench.testWrite4Bytes               monomorphic  avgt   15  21.229 &#177; 0.245  ns/op
VIntCodingBench.testWrite4Bytes                 bimorphic  avgt   15  28.966 &#177; 0.606  ns/op
VIntCodingBench.testWrite4Bytes               megamorphic  avgt   15  33.219 &#177; 1.276  ns/op
VIntCodingBench.testWrite5Bytes               monomorphic  avgt   15  22.886 &#177; 0.602  ns/op
VIntCodingBench.testWrite5Bytes                 bimorphic  avgt   15  29.209 &#177; 1.077  ns/op
VIntCodingBench.testWrite5Bytes               megamorphic  avgt   15  32.731 &#177; 0.944  ns/op
VIntCodingBench.testWrite6Bytes               monomorphic  avgt   15  22.579 &#177; 0.794  ns/op
VIntCodingBench.testWrite6Bytes                 bimorphic  avgt   15  29.067 &#177; 0.678  ns/op
VIntCodingBench.testWrite6Bytes               megamorphic  avgt   15  35.419 &#177; 1.496  ns/op
VIntCodingBench.testWrite7Bytes               monomorphic  avgt   15  22.823 &#177; 0.527  ns/op
VIntCodingBench.testWrite7Bytes                 bimorphic  avgt   15  29.521 &#177; 1.216  ns/op
VIntCodingBench.testWrite7Bytes               megamorphic  avgt   15  34.295 &#177; 2.327  ns/op
VIntCodingBench.testWrite8Bytes               monomorphic  avgt   15  22.032 &#177; 0.918  ns/op
VIntCodingBench.testWrite8Bytes                 bimorphic  avgt   15  30.388 &#177; 1.015  ns/op
VIntCodingBench.testWrite8Bytes               megamorphic  avgt   15  33.632 &#177; 1.200  ns/op
VIntCodingBench.testWrite9Bytes               monomorphic  avgt   15  22.616 &#177; 1.309  ns/op
VIntCodingBench.testWrite9Bytes                 bimorphic  avgt   15  29.291 &#177; 1.096  ns/op
VIntCodingBench.testWrite9Bytes               megamorphic  avgt   15  32.597 &#177; 0.807  ns/op
VIntCodingBench.testWriteRandomLong           monomorphic  avgt   15  35.010 &#177; 1.145  ns/op
VIntCodingBench.testWriteRandomLong             bimorphic  avgt   15  43.090 &#177; 0.615  ns/op
VIntCodingBench.testWriteRandomLong           megamorphic  avgt   15  43.196 &#177; 1.742  ns/op
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;h4&gt;&lt;a name=&quot;Patch&quot;&gt;&lt;/a&gt;Patch&lt;/h4&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;VIntCodingBench.testComputeUnsignedVIntSize   monomorphic  avgt   15  16.339 &#177; 0.418  ns/op
VIntCodingBench.testComputeUnsignedVIntSize     bimorphic  avgt   15  16.340 &#177; 0.417  ns/op
VIntCodingBench.testComputeUnsignedVIntSize   megamorphic  avgt   15  16.435 &#177; 0.408  ns/op
VIntCodingBench.testWrite1Byte                monomorphic  avgt   15   9.362 &#177; 0.208  ns/op
VIntCodingBench.testWrite1Byte                  bimorphic  avgt   15  18.164 &#177; 0.839  ns/op
VIntCodingBench.testWrite1Byte                megamorphic  avgt   15  19.800 &#177; 0.942  ns/op
VIntCodingBench.testWrite2Bytes               monomorphic  avgt   15  10.094 &#177; 0.444  ns/op
VIntCodingBench.testWrite2Bytes                 bimorphic  avgt   15  18.310 &#177; 0.813  ns/op
VIntCodingBench.testWrite2Bytes               megamorphic  avgt   15  19.685 &#177; 0.692  ns/op
VIntCodingBench.testWrite3Bytes               monomorphic  avgt   15  11.541 &#177; 0.433  ns/op
VIntCodingBench.testWrite3Bytes                 bimorphic  avgt   15  19.087 &#177; 0.720  ns/op
VIntCodingBench.testWrite3Bytes               megamorphic  avgt   15  20.518 &#177; 1.035  ns/op
VIntCodingBench.testWrite4Bytes               monomorphic  avgt   15  10.677 &#177; 0.417  ns/op
VIntCodingBench.testWrite4Bytes                 bimorphic  avgt   15  18.815 &#177; 0.921  ns/op
VIntCodingBench.testWrite4Bytes               megamorphic  avgt   15  21.106 &#177; 0.731  ns/op
VIntCodingBench.testWrite5Bytes               monomorphic  avgt   15  11.564 &#177; 0.549  ns/op
VIntCodingBench.testWrite5Bytes                 bimorphic  avgt   15  18.961 &#177; 0.783  ns/op
VIntCodingBench.testWrite5Bytes               megamorphic  avgt   15  20.939 &#177; 0.541  ns/op
VIntCodingBench.testWrite6Bytes               monomorphic  avgt   15  13.463 &#177; 0.441  ns/op
VIntCodingBench.testWrite6Bytes                 bimorphic  avgt   15  20.188 &#177; 0.792  ns/op
VIntCodingBench.testWrite6Bytes               megamorphic  avgt   15  23.087 &#177; 1.044  ns/op
VIntCodingBench.testWrite7Bytes               monomorphic  avgt   15  12.655 &#177; 0.347  ns/op
VIntCodingBench.testWrite7Bytes                 bimorphic  avgt   15  21.307 &#177; 0.892  ns/op
VIntCodingBench.testWrite7Bytes               megamorphic  avgt   15  23.209 &#177; 0.526  ns/op
VIntCodingBench.testWrite8Bytes               monomorphic  avgt   15  11.712 &#177; 0.404  ns/op
VIntCodingBench.testWrite8Bytes                 bimorphic  avgt   15  19.179 &#177; 0.730  ns/op
VIntCodingBench.testWrite8Bytes               megamorphic  avgt   15  20.692 &#177; 0.627  ns/op
VIntCodingBench.testWrite9Bytes               monomorphic  avgt   15  12.029 &#177; 0.387  ns/op
VIntCodingBench.testWrite9Bytes                 bimorphic  avgt   15  19.826 &#177; 0.971  ns/op
VIntCodingBench.testWrite9Bytes               megamorphic  avgt   15  21.953 &#177; 0.450  ns/op
VIntCodingBench.testWriteRandomLong           monomorphic  avgt   15  24.668 &#177; 0.523  ns/op
VIntCodingBench.testWriteRandomLong             bimorphic  avgt   15  31.157 &#177; 0.832  ns/op
VIntCodingBench.testWriteRandomLong           megamorphic  avgt   15  32.698 &#177; 1.376  ns/op
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Next week I plan to start working on &lt;tt&gt;DataOutputPlus#writeBytes(long register, int bytes)&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17440803" author="benedict" created="Mon, 8 Nov 2021 22:42:27 +0000"  >&lt;p&gt;This is great, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Gerrrr&quot; class=&quot;user-hover&quot; rel=&quot;Gerrrr&quot;&gt;Gerrrr&lt;/a&gt;! Looks like pretty significant improvements for such common code paths. I&apos;ll be very interested to see how the register approach compares, both for &lt;tt&gt;ByteBuffer&lt;/tt&gt; and &lt;tt&gt;DataOutputPlus&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17444639" author="gerrrr" created="Tue, 16 Nov 2021 16:22:24 +0000"  >&lt;p&gt;I implemented &lt;tt&gt;DataOutputPlus#writeBytes&lt;/tt&gt; and added benchmarks that use the &lt;tt&gt;DataOutputPlus&lt;/tt&gt; version of the method.&lt;/p&gt;

&lt;p&gt;The register approach definitely improves write throughput. Due to increased number of benchmarks, I also added a visualization for megamorphic calls in addition to the raw results. &quot;Multiple writes&quot; below refers to the initial approach I tried with switch-cases for different number of bytes.&lt;/p&gt;

&lt;p&gt;I am going to apply the same register approach to reads next.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13036160/13036160_writeUnsignedVInt_megamorphic_DOP.png&quot; width=&quot;800&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13036159/13036159_writeUnsignedVInt_megamorphic_BB.png&quot; width=&quot;800&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Register&quot;&gt;&lt;/a&gt;Register&lt;/h4&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Benchmark                                    (allocation)  Mode  Cnt   Score   Error  Units
VIntCodingBench.testComputeUnsignedVIntSize   monomorphic  avgt   15  15.939 &#177; 0.235  ns/op
VIntCodingBench.testComputeUnsignedVIntSize     bimorphic  avgt   15  15.972 &#177; 0.170  ns/op
VIntCodingBench.testComputeUnsignedVIntSize   megamorphic  avgt   15  15.976 &#177; 0.225  ns/op
VIntCodingBench.testWrite1ByteBB              monomorphic  avgt   15   9.555 &#177; 0.059  ns/op
VIntCodingBench.testWrite1ByteBB                bimorphic  avgt   15  16.777 &#177; 0.107  ns/op
VIntCodingBench.testWrite1ByteBB              megamorphic  avgt   15  18.286 &#177; 0.155  ns/op
VIntCodingBench.testWrite1ByteDOP             monomorphic  avgt   15  10.507 &#177; 0.522  ns/op
VIntCodingBench.testWrite1ByteDOP               bimorphic  avgt   15  19.048 &#177; 0.262  ns/op
VIntCodingBench.testWrite1ByteDOP             megamorphic  avgt   15  19.339 &#177; 0.155  ns/op
VIntCodingBench.testWrite2BytesBB             monomorphic  avgt   15  14.688 &#177; 0.170  ns/op
VIntCodingBench.testWrite2BytesBB               bimorphic  avgt   15  19.421 &#177; 0.115  ns/op
VIntCodingBench.testWrite2BytesBB             megamorphic  avgt   15  21.975 &#177; 0.110  ns/op
VIntCodingBench.testWrite2BytesDOP            monomorphic  avgt   15  14.675 &#177; 0.102  ns/op
VIntCodingBench.testWrite2BytesDOP              bimorphic  avgt   15  22.644 &#177; 0.217  ns/op
VIntCodingBench.testWrite2BytesDOP            megamorphic  avgt   15  22.789 &#177; 0.854  ns/op
VIntCodingBench.testWrite3BytesBB             monomorphic  avgt   15  14.764 &#177; 0.112  ns/op
VIntCodingBench.testWrite3BytesBB               bimorphic  avgt   15  19.543 &#177; 0.363  ns/op
VIntCodingBench.testWrite3BytesBB             megamorphic  avgt   15  22.054 &#177; 0.138  ns/op
VIntCodingBench.testWrite3BytesDOP            monomorphic  avgt   15  14.706 &#177; 0.115  ns/op
VIntCodingBench.testWrite3BytesDOP              bimorphic  avgt   15  22.549 &#177; 0.151  ns/op
VIntCodingBench.testWrite3BytesDOP            megamorphic  avgt   15  22.560 &#177; 0.370  ns/op
VIntCodingBench.testWrite4BytesBB             monomorphic  avgt   15  14.679 &#177; 0.158  ns/op
VIntCodingBench.testWrite4BytesBB               bimorphic  avgt   15  19.593 &#177; 0.254  ns/op
VIntCodingBench.testWrite4BytesBB             megamorphic  avgt   15  22.202 &#177; 0.194  ns/op
VIntCodingBench.testWrite4BytesDOP            monomorphic  avgt   15  14.669 &#177; 0.098  ns/op
VIntCodingBench.testWrite4BytesDOP              bimorphic  avgt   15  22.469 &#177; 0.195  ns/op
VIntCodingBench.testWrite4BytesDOP            megamorphic  avgt   15  22.681 &#177; 0.643  ns/op
VIntCodingBench.testWrite5BytesBB             monomorphic  avgt   15  14.655 &#177; 0.142  ns/op
VIntCodingBench.testWrite5BytesBB               bimorphic  avgt   15  19.390 &#177; 0.100  ns/op
VIntCodingBench.testWrite5BytesBB             megamorphic  avgt   15  22.086 &#177; 0.185  ns/op
VIntCodingBench.testWrite5BytesDOP            monomorphic  avgt   15  14.668 &#177; 0.137  ns/op
VIntCodingBench.testWrite5BytesDOP              bimorphic  avgt   15  22.833 &#177; 0.615  ns/op
VIntCodingBench.testWrite5BytesDOP            megamorphic  avgt   15  22.127 &#177; 0.298  ns/op
VIntCodingBench.testWrite6BytesBB             monomorphic  avgt   15  14.766 &#177; 0.252  ns/op
VIntCodingBench.testWrite6BytesBB               bimorphic  avgt   15  19.502 &#177; 0.128  ns/op
VIntCodingBench.testWrite6BytesBB             megamorphic  avgt   15  22.386 &#177; 0.314  ns/op
VIntCodingBench.testWrite6BytesDOP            monomorphic  avgt   15  14.690 &#177; 0.122  ns/op
VIntCodingBench.testWrite6BytesDOP              bimorphic  avgt   15  22.543 &#177; 0.200  ns/op
VIntCodingBench.testWrite6BytesDOP            megamorphic  avgt   15  22.278 &#177; 0.469  ns/op
VIntCodingBench.testWrite7BytesBB             monomorphic  avgt   15  14.687 &#177; 0.268  ns/op
VIntCodingBench.testWrite7BytesBB               bimorphic  avgt   15  19.434 &#177; 0.179  ns/op
VIntCodingBench.testWrite7BytesBB             megamorphic  avgt   15  21.991 &#177; 0.160  ns/op
VIntCodingBench.testWrite7BytesDOP            monomorphic  avgt   15  14.677 &#177; 0.131  ns/op
VIntCodingBench.testWrite7BytesDOP              bimorphic  avgt   15  22.819 &#177; 0.553  ns/op
VIntCodingBench.testWrite7BytesDOP            megamorphic  avgt   15  22.893 &#177; 0.736  ns/op
VIntCodingBench.testWrite8BytesBB             monomorphic  avgt   15  13.047 &#177; 0.072  ns/op
VIntCodingBench.testWrite8BytesBB               bimorphic  avgt   15  17.629 &#177; 0.192  ns/op
VIntCodingBench.testWrite8BytesBB             megamorphic  avgt   15  20.674 &#177; 0.216  ns/op
VIntCodingBench.testWrite8BytesDOP            monomorphic  avgt   15  14.785 &#177; 0.316  ns/op
VIntCodingBench.testWrite8BytesDOP              bimorphic  avgt   15  22.605 &#177; 0.143  ns/op
VIntCodingBench.testWrite8BytesDOP            megamorphic  avgt   15  22.411 &#177; 0.907  ns/op
VIntCodingBench.testWrite9BytesBB             monomorphic  avgt   15  14.495 &#177; 0.123  ns/op
VIntCodingBench.testWrite9BytesBB               bimorphic  avgt   15  20.330 &#177; 1.697  ns/op
VIntCodingBench.testWrite9BytesBB             megamorphic  avgt   15  22.011 &#177; 0.637  ns/op
VIntCodingBench.testWrite9BytesDOP            monomorphic  avgt   15  13.706 &#177; 0.089  ns/op
VIntCodingBench.testWrite9BytesDOP              bimorphic  avgt   15  21.891 &#177; 0.435  ns/op
VIntCodingBench.testWrite9BytesDOP            megamorphic  avgt   15  22.970 &#177; 0.246  ns/op
VIntCodingBench.testWriteRandomLongBB         monomorphic  avgt   15  26.456 &#177; 0.536  ns/op
VIntCodingBench.testWriteRandomLongBB           bimorphic  avgt   15  32.810 &#177; 0.580  ns/op
VIntCodingBench.testWriteRandomLongBB         megamorphic  avgt   15  32.634 &#177; 0.602  ns/op
VIntCodingBench.testWriteRandomLongDOP        monomorphic  avgt   15  26.408 &#177; 0.988  ns/op
VIntCodingBench.testWriteRandomLongDOP          bimorphic  avgt   15  32.097 &#177; 2.057  ns/op
VIntCodingBench.testWriteRandomLongDOP        megamorphic  avgt   15  34.598 &#177; 1.319  ns/op
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h4&gt;&lt;a name=&quot;Multiplewrites&quot;&gt;&lt;/a&gt;Multiple writes&lt;/h4&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Benchmark                                    (allocation)  Mode  Cnt   Score   Error  Units
VIntCodingBench.testComputeUnsignedVIntSize   monomorphic  avgt   15  17.127 &#177; 0.709  ns/op
VIntCodingBench.testComputeUnsignedVIntSize     bimorphic  avgt   15  17.389 &#177; 1.306  ns/op
VIntCodingBench.testComputeUnsignedVIntSize   megamorphic  avgt   15  16.287 &#177; 0.481  ns/op
VIntCodingBench.testWrite1ByteBB              monomorphic  avgt   15   9.417 &#177; 0.284  ns/op
VIntCodingBench.testWrite1ByteBB                bimorphic  avgt   15  17.806 &#177; 0.589  ns/op
VIntCodingBench.testWrite1ByteBB              megamorphic  avgt   15  18.623 &#177; 0.787  ns/op
VIntCodingBench.testWrite1ByteDOP             monomorphic  avgt   15  13.974 &#177; 0.576  ns/op
VIntCodingBench.testWrite1ByteDOP               bimorphic  avgt   15  22.223 &#177; 0.883  ns/op
VIntCodingBench.testWrite1ByteDOP             megamorphic  avgt   15  23.301 &#177; 0.685  ns/op
VIntCodingBench.testWrite2BytesBB             monomorphic  avgt   15   9.537 &#177; 0.314  ns/op
VIntCodingBench.testWrite2BytesBB               bimorphic  avgt   15  17.371 &#177; 0.472  ns/op
VIntCodingBench.testWrite2BytesBB             megamorphic  avgt   15  18.636 &#177; 0.539  ns/op
VIntCodingBench.testWrite2BytesDOP            monomorphic  avgt   15  14.921 &#177; 0.661  ns/op
VIntCodingBench.testWrite2BytesDOP              bimorphic  avgt   15  22.561 &#177; 0.448  ns/op
VIntCodingBench.testWrite2BytesDOP            megamorphic  avgt   15  24.397 &#177; 0.745  ns/op
VIntCodingBench.testWrite3BytesBB             monomorphic  avgt   15  11.220 &#177; 0.337  ns/op
VIntCodingBench.testWrite3BytesBB               bimorphic  avgt   15  19.180 &#177; 0.398  ns/op
VIntCodingBench.testWrite3BytesBB             megamorphic  avgt   15  20.009 &#177; 0.592  ns/op
VIntCodingBench.testWrite3BytesDOP            monomorphic  avgt   15  16.094 &#177; 0.481  ns/op
VIntCodingBench.testWrite3BytesDOP              bimorphic  avgt   15  25.855 &#177; 0.873  ns/op
VIntCodingBench.testWrite3BytesDOP            megamorphic  avgt   15  26.087 &#177; 0.735  ns/op
VIntCodingBench.testWrite4BytesBB             monomorphic  avgt   15  10.252 &#177; 0.344  ns/op
VIntCodingBench.testWrite4BytesBB               bimorphic  avgt   15  18.760 &#177; 2.626  ns/op
VIntCodingBench.testWrite4BytesBB             megamorphic  avgt   15  19.677 &#177; 0.642  ns/op
VIntCodingBench.testWrite4BytesDOP            monomorphic  avgt   15  15.099 &#177; 0.317  ns/op
VIntCodingBench.testWrite4BytesDOP              bimorphic  avgt   15  22.329 &#177; 0.629  ns/op
VIntCodingBench.testWrite4BytesDOP            megamorphic  avgt   15  25.075 &#177; 0.973  ns/op
VIntCodingBench.testWrite5BytesBB             monomorphic  avgt   15  10.561 &#177; 0.354  ns/op
VIntCodingBench.testWrite5BytesBB               bimorphic  avgt   15  18.056 &#177; 0.582  ns/op
VIntCodingBench.testWrite5BytesBB             megamorphic  avgt   15  19.491 &#177; 0.598  ns/op
VIntCodingBench.testWrite5BytesDOP            monomorphic  avgt   15  16.228 &#177; 0.480  ns/op
VIntCodingBench.testWrite5BytesDOP              bimorphic  avgt   15  24.403 &#177; 0.744  ns/op
VIntCodingBench.testWrite5BytesDOP            megamorphic  avgt   15  25.119 &#177; 0.904  ns/op
VIntCodingBench.testWrite6BytesBB             monomorphic  avgt   15  12.688 &#177; 0.388  ns/op
VIntCodingBench.testWrite6BytesBB               bimorphic  avgt   15  19.904 &#177; 0.730  ns/op
VIntCodingBench.testWrite6BytesBB             megamorphic  avgt   15  21.964 &#177; 0.772  ns/op
VIntCodingBench.testWrite6BytesDOP            monomorphic  avgt   15  17.678 &#177; 0.797  ns/op
VIntCodingBench.testWrite6BytesDOP              bimorphic  avgt   15  24.909 &#177; 1.068  ns/op
VIntCodingBench.testWrite6BytesDOP            megamorphic  avgt   15  28.334 &#177; 0.732  ns/op
VIntCodingBench.testWrite7BytesBB             monomorphic  avgt   15  12.502 &#177; 0.410  ns/op
VIntCodingBench.testWrite7BytesBB               bimorphic  avgt   15  20.105 &#177; 0.653  ns/op
VIntCodingBench.testWrite7BytesBB             megamorphic  avgt   15  23.053 &#177; 0.923  ns/op
VIntCodingBench.testWrite7BytesDOP            monomorphic  avgt   15  18.053 &#177; 1.386  ns/op
VIntCodingBench.testWrite7BytesDOP              bimorphic  avgt   15  27.000 &#177; 0.889  ns/op
VIntCodingBench.testWrite7BytesDOP            megamorphic  avgt   15  30.684 &#177; 1.024  ns/op
VIntCodingBench.testWrite8BytesBB             monomorphic  avgt   15  12.383 &#177; 0.630  ns/op
VIntCodingBench.testWrite8BytesBB               bimorphic  avgt   15  19.600 &#177; 0.543  ns/op
VIntCodingBench.testWrite8BytesBB             megamorphic  avgt   15  20.995 &#177; 0.918  ns/op
VIntCodingBench.testWrite8BytesDOP            monomorphic  avgt   15  16.830 &#177; 0.372  ns/op
VIntCodingBench.testWrite8BytesDOP              bimorphic  avgt   15  25.022 &#177; 0.615  ns/op
VIntCodingBench.testWrite8BytesDOP            megamorphic  avgt   15  25.871 &#177; 0.845  ns/op
VIntCodingBench.testWrite9BytesBB             monomorphic  avgt   15  12.396 &#177; 0.604  ns/op
VIntCodingBench.testWrite9BytesBB               bimorphic  avgt   15  20.006 &#177; 0.586  ns/op
VIntCodingBench.testWrite9BytesBB             megamorphic  avgt   15  22.612 &#177; 0.670  ns/op
VIntCodingBench.testWrite9BytesDOP            monomorphic  avgt   15  18.393 &#177; 0.587  ns/op
VIntCodingBench.testWrite9BytesDOP              bimorphic  avgt   15  24.908 &#177; 0.714  ns/op
VIntCodingBench.testWrite9BytesDOP            megamorphic  avgt   15  29.258 &#177; 1.792  ns/op
VIntCodingBench.testWriteRandomLongBB         monomorphic  avgt   15  25.575 &#177; 0.933  ns/op
VIntCodingBench.testWriteRandomLongBB           bimorphic  avgt   15  33.336 &#177; 0.926  ns/op
VIntCodingBench.testWriteRandomLongBB         megamorphic  avgt   15  34.463 &#177; 2.112  ns/op
VIntCodingBench.testWriteRandomLongDOP        monomorphic  avgt   15  29.358 &#177; 0.785  ns/op
VIntCodingBench.testWriteRandomLongDOP          bimorphic  avgt   15  34.367 &#177; 1.122  ns/op
VIntCodingBench.testWriteRandomLongDOP        megamorphic  avgt   15  36.373 &#177; 0.995  ns/op
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h4&gt;&lt;a name=&quot;Baseline&quot;&gt;&lt;/a&gt;Baseline&lt;/h4&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Benchmark                                    (allocation)  Mode  Cnt   Score   Error  Units
VIntCodingBench.testComputeUnsignedVIntSize   monomorphic  avgt   15  16.237 &#177; 0.144  ns/op
VIntCodingBench.testComputeUnsignedVIntSize     bimorphic  avgt   15  16.273 &#177; 0.193  ns/op
VIntCodingBench.testComputeUnsignedVIntSize   megamorphic  avgt   15  16.251 &#177; 0.226  ns/op
VIntCodingBench.testWrite1ByteBB              monomorphic  avgt   15   8.722 &#177; 0.049  ns/op
VIntCodingBench.testWrite1ByteBB                bimorphic  avgt   15  17.095 &#177; 0.656  ns/op
VIntCodingBench.testWrite1ByteBB              megamorphic  avgt   15  17.856 &#177; 0.366  ns/op
VIntCodingBench.testWrite1ByteDOP             monomorphic  avgt   15  10.539 &#177; 0.304  ns/op
VIntCodingBench.testWrite1ByteDOP               bimorphic  avgt   15  19.000 &#177; 0.229  ns/op
VIntCodingBench.testWrite1ByteDOP             megamorphic  avgt   15  19.755 &#177; 0.332  ns/op
VIntCodingBench.testWrite2BytesBB             monomorphic  avgt   15  19.322 &#177; 0.125  ns/op
VIntCodingBench.testWrite2BytesBB               bimorphic  avgt   15  25.739 &#177; 0.445  ns/op
VIntCodingBench.testWrite2BytesBB             megamorphic  avgt   15  29.106 &#177; 0.706  ns/op
VIntCodingBench.testWrite2BytesDOP            monomorphic  avgt   15  25.940 &#177; 0.161  ns/op
VIntCodingBench.testWrite2BytesDOP              bimorphic  avgt   15  33.446 &#177; 0.527  ns/op
VIntCodingBench.testWrite2BytesDOP            megamorphic  avgt   15  37.912 &#177; 1.958  ns/op
VIntCodingBench.testWrite3BytesBB             monomorphic  avgt   15  22.309 &#177; 2.962  ns/op
VIntCodingBench.testWrite3BytesBB               bimorphic  avgt   15  26.560 &#177; 0.684  ns/op
VIntCodingBench.testWrite3BytesBB             megamorphic  avgt   15  30.398 &#177; 0.843  ns/op
VIntCodingBench.testWrite3BytesDOP            monomorphic  avgt   15  27.975 &#177; 1.135  ns/op
VIntCodingBench.testWrite3BytesDOP              bimorphic  avgt   15  34.763 &#177; 0.654  ns/op
VIntCodingBench.testWrite3BytesDOP            megamorphic  avgt   15  39.441 &#177; 0.284  ns/op
VIntCodingBench.testWrite4BytesBB             monomorphic  avgt   15  21.715 &#177; 0.365  ns/op
VIntCodingBench.testWrite4BytesBB               bimorphic  avgt   15  28.755 &#177; 0.317  ns/op
VIntCodingBench.testWrite4BytesBB             megamorphic  avgt   15  31.959 &#177; 0.522  ns/op
VIntCodingBench.testWrite4BytesDOP            monomorphic  avgt   15  27.525 &#177; 0.526  ns/op
VIntCodingBench.testWrite4BytesDOP              bimorphic  avgt   15  36.992 &#177; 0.201  ns/op
VIntCodingBench.testWrite4BytesDOP            megamorphic  avgt   15  39.074 &#177; 0.808  ns/op
VIntCodingBench.testWrite5BytesBB             monomorphic  avgt   15  21.620 &#177; 0.509  ns/op
VIntCodingBench.testWrite5BytesBB               bimorphic  avgt   15  27.592 &#177; 0.259  ns/op
VIntCodingBench.testWrite5BytesBB             megamorphic  avgt   15  31.718 &#177; 0.809  ns/op
VIntCodingBench.testWrite5BytesDOP            monomorphic  avgt   15  26.949 &#177; 0.189  ns/op
VIntCodingBench.testWrite5BytesDOP              bimorphic  avgt   15  34.916 &#177; 0.386  ns/op
VIntCodingBench.testWrite5BytesDOP            megamorphic  avgt   15  39.920 &#177; 1.518  ns/op
VIntCodingBench.testWrite6BytesBB             monomorphic  avgt   15  21.572 &#177; 0.435  ns/op
VIntCodingBench.testWrite6BytesBB               bimorphic  avgt   15  28.094 &#177; 0.450  ns/op
VIntCodingBench.testWrite6BytesBB             megamorphic  avgt   15  32.456 &#177; 0.488  ns/op
VIntCodingBench.testWrite6BytesDOP            monomorphic  avgt   15  27.655 &#177; 0.453  ns/op
VIntCodingBench.testWrite6BytesDOP              bimorphic  avgt   15  39.025 &#177; 0.517  ns/op
VIntCodingBench.testWrite6BytesDOP            megamorphic  avgt   15  39.899 &#177; 1.011  ns/op
VIntCodingBench.testWrite7BytesBB             monomorphic  avgt   15  21.973 &#177; 0.426  ns/op
VIntCodingBench.testWrite7BytesBB               bimorphic  avgt   15  27.559 &#177; 0.316  ns/op
VIntCodingBench.testWrite7BytesBB             megamorphic  avgt   15  31.988 &#177; 0.373  ns/op
VIntCodingBench.testWrite7BytesDOP            monomorphic  avgt   15  28.257 &#177; 0.205  ns/op
VIntCodingBench.testWrite7BytesDOP              bimorphic  avgt   15  37.111 &#177; 0.625  ns/op
VIntCodingBench.testWrite7BytesDOP            megamorphic  avgt   15  38.689 &#177; 0.214  ns/op
VIntCodingBench.testWrite8BytesBB             monomorphic  avgt   15  23.458 &#177; 0.456  ns/op
VIntCodingBench.testWrite8BytesBB               bimorphic  avgt   15  28.696 &#177; 0.137  ns/op
VIntCodingBench.testWrite8BytesBB             megamorphic  avgt   15  32.025 &#177; 0.448  ns/op
VIntCodingBench.testWrite8BytesDOP            monomorphic  avgt   15  28.777 &#177; 0.374  ns/op
VIntCodingBench.testWrite8BytesDOP              bimorphic  avgt   15  37.232 &#177; 0.374  ns/op
VIntCodingBench.testWrite8BytesDOP            megamorphic  avgt   15  39.832 &#177; 0.825  ns/op
VIntCodingBench.testWrite9BytesBB             monomorphic  avgt   15  22.873 &#177; 1.074  ns/op
VIntCodingBench.testWrite9BytesBB               bimorphic  avgt   15  28.377 &#177; 0.501  ns/op
VIntCodingBench.testWrite9BytesBB             megamorphic  avgt   15  31.409 &#177; 0.611  ns/op
VIntCodingBench.testWrite9BytesDOP            monomorphic  avgt   15  29.532 &#177; 1.390  ns/op
VIntCodingBench.testWrite9BytesDOP              bimorphic  avgt   15  39.124 &#177; 3.493  ns/op
VIntCodingBench.testWrite9BytesDOP            megamorphic  avgt   15  39.400 &#177; 0.439  ns/op
VIntCodingBench.testWriteRandomLongBB         monomorphic  avgt   15  34.258 &#177; 0.192  ns/op
VIntCodingBench.testWriteRandomLongBB           bimorphic  avgt   15  43.513 &#177; 0.411  ns/op
VIntCodingBench.testWriteRandomLongBB         megamorphic  avgt   15  42.713 &#177; 0.514  ns/op
VIntCodingBench.testWriteRandomLongDOP        monomorphic  avgt   15  38.191 &#177; 0.280  ns/op
VIntCodingBench.testWriteRandomLongDOP          bimorphic  avgt   15  48.820 &#177; 0.327  ns/op
VIntCodingBench.testWriteRandomLongDOP        megamorphic  avgt   15  51.459 &#177; 0.399  ns/op
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17447425" author="benedict" created="Mon, 22 Nov 2021 13:58:47 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Gerrrr&quot; class=&quot;user-hover&quot; rel=&quot;Gerrrr&quot;&gt;Gerrrr&lt;/a&gt;, I took a quick look to see if I could shave any further time and have the following &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/15215-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;suggestions&lt;/a&gt;. On my laptop at least the changes to &lt;tt&gt;ByteBuffer&lt;/tt&gt; result in ~1ns reduction (or about 6% improvement). I also took the liberty of modifying the &lt;tt&gt;DataOutputPlus&lt;/tt&gt; specification to use the top bytes of the register to permit the &lt;tt&gt;ByteBuffer&lt;/tt&gt; and &lt;tt&gt;DataOutputPlus&lt;/tt&gt; implementations to look approximately the same, and applied your original optimisation for VIntCoding to the default implementation of &lt;tt&gt;writeBytes&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;We should probably add a unit test or two to cover &lt;tt&gt;DataOutputPlus&lt;/tt&gt; vint coding and &lt;tt&gt;writeBytes&lt;/tt&gt; before we commit, but overall the patch is looking good.&lt;/p&gt;</comment>
                            <comment id="17447439" author="gerrrr" created="Mon, 22 Nov 2021 14:18:12 +0000"  >&lt;p&gt;Thanks for the review and the suggestions &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; ! This Wednesday I plan to work on read performance, applying your changes, and adding unit tests for new code branches. Hopefully, the patch is going to be ready by the end of the week.&lt;/p&gt;</comment>
                            <comment id="17449488" author="gerrrr" created="Fri, 26 Nov 2021 09:35:57 +0000"  >&lt;p&gt;While working on the read path I&apos;ve realized that it already has the optimization we discussed since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8630&quot; title=&quot;Faster sequential IO (on compaction, streaming, etc)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8630&quot;&gt;&lt;del&gt;CASSANDRA-8630&lt;/del&gt;&lt;/a&gt; - &lt;a href=&quot;https://github.com/apache/cassandra/blob/951d72cd929d1f6c9329becbdd7604a9e709587b/src/java/org/apache/cassandra/io/util/RebufferingInputStream.java#L239-L268&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/951d72cd929d1f6c9329becbdd7604a9e709587b/src/java/org/apache/cassandra/io/util/RebufferingInputStream.java#L239-L268&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Since the last update I added new test cases to &lt;tt&gt;VIntCodingTest&lt;/tt&gt; to cover buffered and unbuffered reads and writes as well as extended &lt;tt&gt;DataOutputTest&lt;/tt&gt; to cover &lt;tt&gt;DataOutputPlus#writeBytes&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Patches:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1343&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1344&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1346&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;To demonstrate the results I picked a single benchmark - &lt;tt&gt;testWriteRandomLongDOP&lt;/tt&gt; as it shows overall performance improvement and is relevant for all Cassandra versions. The results are for the megamorphic benchmark variation.&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13036644/13036644_testWriteRandomLongDOP_final.png&quot; width=&quot;800px&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; Can you please review the patch and run the CI?&lt;/p&gt;</comment>
                            <comment id="17450758" author="benedict" created="Mon, 29 Nov 2021 22:55:57 +0000"  >&lt;p&gt;Looks like a lot of failures: &lt;a href=&quot;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/207/workflows/a73f8193-6149-4d8c-87f4-289e4ad76aaf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/207/workflows/a73f8193-6149-4d8c-87f4-289e4ad76aaf&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17451023" author="gerrrr" created="Tue, 30 Nov 2021 10:23:57 +0000"  >&lt;p&gt;I&apos;ll fix test failures closer to the end of the week, probably on the weekend.&lt;/p&gt;</comment>
                            <comment id="17451029" author="benedict" created="Tue, 30 Nov 2021 10:40:22 +0000"  >&lt;p&gt;I suspect we just need a better unit test for the encode and decode methods, that test serialising and deserialising a sequence of random integers and verifies the sequence is intact, for each variant have implemented.&lt;/p&gt;</comment>
                            <comment id="17453616" author="gerrrr" created="Sun, 5 Dec 2021 14:14:34 +0000"  >&lt;p&gt;The issue was caused by the slow path in&#160;&lt;tt&gt;BufferedDataOutputStreamPlus#writeBytes&lt;/tt&gt; when the underlying buffer has less than 8 bytes remaining. Previously, this method fell back to &lt;tt&gt;writeSlow&lt;/tt&gt;. This was not correct because it writes N least significant bytes to the wire. As &lt;tt&gt;writeBytes&lt;/tt&gt; treats the register as an optimized version of a byte array, it should write N most significant bytes instead. I added a test case that isolates the issue and fixed it in all branches. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; can you please re-run the CI?&lt;/p&gt;</comment>
                            <comment id="17453947" author="benedict" created="Mon, 6 Dec 2021 11:13:02 +0000"  >&lt;p&gt;I&apos;ve re-run &lt;a href=&quot;https://app.circleci.com/pipelines/github/belliottsmith/cassandra?branch=15215-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt; and it looks mostly clean but there are some remaining issues. I&apos;m on holiday at the moment, and will get back to review and final sign off next week.&lt;/p&gt;</comment>
                            <comment id="17454582" author="gerrrr" created="Tue, 7 Dec 2021 11:01:26 +0000"  >&lt;p&gt;I&apos;ll fix the last test failures on the weekend. Enjoy your holiday &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17457638" author="gerrrr" created="Sat, 11 Dec 2021 15:45:54 +0000"  >&lt;p&gt;I looked into the most recent test failures and I am fairly convinced that none of them are caused by this patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/216/workflows/9b2ff75d-d2fd-47ad-a4d6-a407a649780c/jobs/5659/tests#failed-test-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CQLConnectionTest test failures &lt;/a&gt; - there are recent bug reports regarding this test suite failing in various ways - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16677&quot; title=&quot;Test Failure: Fix flaky ConnectionTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16677&quot;&gt;CASSANDRA-16677&lt;/a&gt; as an &quot;aggregate issue&quot; and a number of linked duplicates. One example is &lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1037/workflows/c728d370-49b9-41aa-bdfb-8c41cf0355d8/jobs/6577/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this build&lt;/a&gt; from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16949&quot; title=&quot;Fix flaky test org.apache.cassandra.transport.CQLConnectionTest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16949&quot;&gt;&lt;del&gt;CASSANDRA-16949&lt;/del&gt;&lt;/a&gt; that has exactly the same failures.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/216/workflows/418d4b46-8d8b-41df-ad80-06f377593caf/jobs/5646/tests#failed-test-0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;TestClientRequestMetrics&lt;/a&gt; - was also observed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15234?focusedCommentId=17454221&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17454221&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-15234?focusedCommentId=17454221&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17454221&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/216/workflows/418d4b46-8d8b-41df-ad80-06f377593caf/jobs/5637&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;MessagingServiceTest &lt;/a&gt; - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17033&quot; title=&quot;MessagingServiceTest listenOptionalSecureConnection and listenRequiredSecureConnection fail sporadically&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17033&quot;&gt;&lt;del&gt;CASSANDRA-17033&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17458399" author="benedict" created="Mon, 13 Dec 2021 13:49:13 +0000"  >&lt;p&gt;Thanks for checking, and apologies about that - the CQLConnectionTest failures looked like encoding/decoding problems so I assumed plausibly connected to this patch, as I hadn&apos;t seen them before.&lt;/p&gt;

&lt;p&gt;I&apos;ve rebased, and introduced one &lt;a href=&quot;https://github.com/belliottsmith/cassandra/commit/934fe98900b35c6a8639f1b6e0240b9a3aef36c9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;nit&lt;/a&gt; commit to use the (presumably more efficient) &lt;tt&gt;DataOutputPlus.writeBytes&lt;/tt&gt; as a fallback in &lt;tt&gt;BufferedDataOutputStreamPlus&lt;/tt&gt;. Once CI is green, assuming you&apos;re OK with this change, I&apos;ll merge to trunk.&lt;/p&gt;</comment>
                            <comment id="17459045" author="gerrrr" created="Tue, 14 Dec 2021 10:27:25 +0000"  >&lt;p&gt;No worries, CQLConnectionTest failures indeed looked suspicious. I agree with your commit and am looking forward to green CI and merge &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17468706" author="gerrrr" created="Tue, 4 Jan 2022 16:03:59 +0000"  >&lt;p&gt;I added &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; as a reviewer as he approved the PR to trunk. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; is there anything I can do to facilitate the merge?&lt;/p&gt;</comment>
                            <comment id="17469400" author="benedict" created="Wed, 5 Jan 2022 15:54:45 +0000"  >&lt;p&gt;Sorry &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Gerrrr&quot; class=&quot;user-hover&quot; rel=&quot;Gerrrr&quot;&gt;Gerrrr&lt;/a&gt; I&apos;ve been on leave for most of December (and still am). I&apos;ll get to it soon, I promise!&lt;/p&gt;</comment>
                            <comment id="17469401" author="benedict" created="Wed, 5 Jan 2022 15:55:10 +0000"  >&lt;p&gt;(In my opinion it&apos;s ready to go, just needs to be rebased, retested and merged)&lt;/p&gt;</comment>
                            <comment id="17485702" author="benedict" created="Wed, 2 Feb 2022 10:45:37 +0000"  >&lt;p&gt;Going to try and slowly nurse this to completion by CI&lt;/p&gt;</comment>
                            <comment id="17485753" author="benedict" created="Wed, 2 Feb 2022 12:19:03 +0000"  >&lt;p&gt;Seemingly clean CI runs (looperTest was an error on my part, and the other two are tests that fail on other branches). Committed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/228/workflows/15695a66-1233-4fd1-9a7d-63b59ab1242c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/228/workflows/15695a66-1233-4fd1-9a7d-63b59ab1242c&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/228/workflows/d6491609-e540-4ac6-b2e6-93c84fa73402&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/228/workflows/d6491609-e540-4ac6-b2e6-93c84fa73402&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17626840" author="aweisberg" created="Mon, 31 Oct 2022 20:45:21 +0000"  >&lt;p&gt;Maybe I am missing something, but I don&apos;t see where this &lt;a href=&quot;#L217&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;change&lt;/a&gt;] handles the case where the buffer doesn&apos;t have 8 bytes remaining? It looks like it would generate a runtime error if the amount remaining was &amp;lt; 8 but &amp;gt;= size and that is not so bad, but in the unusual situation where the space remaining is &amp;lt; size it will silently not write the value.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (size &amp;lt; 9)
{
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; limit = output.limit();
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; pos = output.position();
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (limit - pos &amp;gt;= size)
    {
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; shift = (8 - size) &amp;lt;&amp;lt; 3;
        &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; extraBytes = size - 1;
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; mask = (&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;)VIntCoding.encodeExtraBytesToRead(extraBytes) &amp;lt;&amp;lt; 56;
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; register = (value &amp;lt;&amp;lt; shift) | mask;
        output.putLong(pos, register);
        output.position(pos + size);
    }
}&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17626864" author="benedict" created="Mon, 31 Oct 2022 22:01:16 +0000"  >&lt;p&gt;Good catch. It looks like 1) this should probably have an else clause that invokes the slow path; 2) this is only used by &lt;tt&gt;TypeCodec.DurationCodes.serialize&lt;/tt&gt;, so the exposure is fortunately pretty small.&lt;/p&gt;</comment>
                            <comment id="17626872" author="gerrrr" created="Mon, 31 Oct 2022 22:41:56 +0000"  >&lt;p&gt;Nice catch! I&apos;ll publish a fix tomorrow in the morning.&lt;/p&gt;</comment>
                            <comment id="17627137" author="gerrrr" created="Tue, 1 Nov 2022 12:23:33 +0000"  >&lt;p&gt;Patch - &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...Gerrrr:cassandra:15215-fixup-trunk?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...Gerrrr:cassandra:15215-fixup-trunk?expand=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;CI (still running) - &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2052&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2052&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17627307" author="gerrrr" created="Tue, 1 Nov 2022 19:49:53 +0000"  >&lt;p&gt;CI completed and the failures do not seem to be related. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; could you please review?&lt;/p&gt;</comment>
                            <comment id="17628966" author="gerrrr" created="Fri, 4 Nov 2022 13:13:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; Would you have time to review the fix for the issue you found?&lt;/p&gt;</comment>
                            <comment id="17630398" author="gerrrr" created="Tue, 8 Nov 2022 12:51:08 +0000"  >&lt;p&gt;Bump. I think it is important to include the fix into the 4.1-rc.&#160;&lt;/p&gt;</comment>
                            <comment id="17632225" author="blerer" created="Fri, 11 Nov 2022 10:01:46 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Gerrrr&quot; class=&quot;user-hover&quot; rel=&quot;Gerrrr&quot;&gt;Gerrrr&lt;/a&gt;. The patch looks good to me.&lt;/p&gt;</comment>
                            <comment id="17632286" author="brandon.williams" created="Fri, 11 Nov 2022 12:03:36 +0000"  >&lt;p&gt;This would have better visibility had it been a new follow up ticket.&lt;/p&gt;</comment>
                            <comment id="17632518" author="gerrrr" created="Fri, 11 Nov 2022 19:00:05 +0000"  >&lt;p&gt;Committed &lt;a href=&quot;https://github.com/apache/cassandra/commit/5cd012736e4680bbb25928ee7fbcea4859878fff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5cd012736e4680bbb25928ee7fbcea4859878fff&lt;/a&gt; at cassandra-4.1 and trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13036644" name="testWriteRandomLongDOP_final.png" size="85323" author="Gerrrr" created="Fri, 26 Nov 2021 09:31:51 +0000"/>
                            <attachment id="13036159" name="writeUnsignedVInt_megamorphic_BB.png" size="123902" author="Gerrrr" created="Tue, 16 Nov 2021 16:18:12 +0000"/>
                            <attachment id="13036160" name="writeUnsignedVInt_megamorphic_DOP.png" size="129143" author="Gerrrr" created="Tue, 16 Nov 2021 16:18:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[Gerrrr]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12997" cascade-level="1"><![CDATA[Performance Bug/Regression]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12975"><![CDATA[Code Inspection]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z04pjc:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
        <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12350145">4.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/35dbcc2c2dbe1c826fd6ecd6e8357f0f5a9bab02&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;35dbcc2c2dbe1c826fd6ecd6e8357f0f5a9bab02&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra/commit/5cd012736e4680bbb25928ee7fbcea4859878fff&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5cd012736e4680bbb25928ee7fbcea4859878fff&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Added unit tests for new methods and benchmarks to show performance improvements.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>