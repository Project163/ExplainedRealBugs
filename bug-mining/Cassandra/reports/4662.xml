<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12676] Message coalescing regression</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12676</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The default in 2.2+ was to enable TIMEHORIZON message coalescing.  After reports of performance regressions after upgrading from 2.1 to 2.2/3.0 we have discovered the issue to be this default.&lt;/p&gt;

&lt;p&gt;We need to re-test our assumptions on this feature but in the meantime we should default back to disabled.&lt;/p&gt;

&lt;p&gt;Here is a performance run &lt;a href=&quot;http://cstar.datastax.com/graph?command=one_job&amp;amp;stats=9a26b5f2-7f48-11e6-92e7-0256e416528f&amp;amp;metric=op_rate&amp;amp;operation=2_user&amp;amp;smoothing=1&amp;amp;show_aggregates=true&amp;amp;xmin=0&amp;amp;xmax=508.86&amp;amp;ymin=0&amp;amp;ymax=91223&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;with and without message coalescing&lt;/a&gt; &lt;/p&gt;</description>
                <environment></environment>
        <key id="13006254">CASSANDRA-12676</key>
            <summary>Message coalescing regression</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jjirsa">Jeff Jirsa</assignee>
                                    <reporter username="tjake">T Jake Luciani</reporter>
                        <labels>
                    </labels>
                <created>Tue, 20 Sep 2016 18:13:39 +0000</created>
                <updated>Fri, 15 May 2020 08:00:16 +0000</updated>
                            <resolved>Fri, 3 Mar 2017 05:31:46 +0000</resolved>
                                        <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>17</watches>
                                                                                                                <comments>
                            <comment id="15507402" author="tjake" created="Tue, 20 Sep 2016 18:44:19 +0000"  >&lt;p&gt;If you wish to disable this on your cluster add:&lt;/p&gt;

&lt;p&gt;otc_coalescing_strategy: DISABLED&lt;/p&gt;

&lt;p&gt;To cassandra.yaml&lt;/p&gt;</comment>
                            <comment id="15597034" author="jjirsa" created="Sat, 22 Oct 2016 03:15:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; - make sense to go back to disabled by default for 4.0?&lt;/p&gt;</comment>
                            <comment id="15645408" author="tjake" created="Mon, 7 Nov 2016 20:49:15 +0000"  >&lt;p&gt;Yeah.&lt;/p&gt;</comment>
                            <comment id="15645473" author="tjake" created="Mon, 7 Nov 2016 21:13:35 +0000"  >&lt;p&gt;Hmm actually, since this entry isn&apos;t even in the yaml so is there an issue just changing the (hidden) default in 3.0.x 3.x?&lt;/p&gt;</comment>
                            <comment id="15646361" author="jjirsa" created="Tue, 8 Nov 2016 03:36:14 +0000"  >&lt;p&gt;3.x, maybe, but not 3.0. People who validate releases for prod clusters don&apos;t tend to enjoy hidden config changes mid-branch, especially for options not in the yaml.&lt;/p&gt;


</comment>
                            <comment id="15734002" author="jay.zhuang" created="Fri, 9 Dec 2016 01:59:54 +0000"  >&lt;p&gt;We saw huge performance gain by disabling coalescing on both 2.2.5 and 3.0.10 (about 50% average latency decrease on some clusters). I would suggest to disable it even in 3.0.x.&lt;br/&gt;
The attachment is test result for 5 nodes cluster with RF=3, quorum write: &lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12842470/result.html&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/secure/attachment/12842470/result.html&lt;/a&gt;&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; coalescing &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; disabled &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; timehorizon &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; latency mean &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 2.5 ms &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 3.4 ms (+36%) &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; P95 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 3.4 ms &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 4.3 ms (+26%) &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; P99 &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 5.3 ms &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; 5.8 ms (+9.4%) &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15734009" author="dikanggu" created="Fri, 9 Dec 2016 02:02:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt; interesting, what about the impact to read latency?&lt;/p&gt;</comment>
                            <comment id="15734456" author="jjirsa" created="Fri, 9 Dec 2016 06:13:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; - ok with this for a NEWS.txt entry?  Targeting 3.12 (so skipping 3.11 branch), which would of course include 4.0.&lt;/p&gt;
</comment>
                            <comment id="15735589" author="tjake" created="Fri, 9 Dec 2016 15:23:43 +0000"  >&lt;p&gt;+1 thx.  It might also be worth calling this our in the 3.0 branch NEWS.txt so people are aware of the regression&lt;/p&gt;</comment>
                            <comment id="15736131" author="jay.zhuang" created="Fri, 9 Dec 2016 19:44:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dikanggu&quot; class=&quot;user-hover&quot; rel=&quot;dikanggu&quot;&gt;dikanggu&lt;/a&gt; Read latency has similar impact, here is latency metrics from one of our cluster (P99): &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12842599/12842599_coalescing_disabled.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="15736166" author="jay.zhuang" created="Fri, 9 Dec 2016 19:55:20 +0000"  >&lt;p&gt;Another reason to disable coalescing is it&apos;s blocking small messages after the cluster running for serveral days: &lt;a href=&quot;https://lists.apache.org/thread.html/1439df9cd898ef78c866fa571f28ed1ba4caef889feb1530da941fdb@%3Cuser.cassandra.apache.org%3E&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://lists.apache.org/thread.html/1439df9cd898ef78c866fa571f28ed1ba4caef889feb1530da941fdb@%3Cuser.cassandra.apache.org%3E&lt;/a&gt;&lt;br/&gt;
We saw this issue for a few clusters, we cannot consistently reproduce the problem, as it&apos;s happened very randomly and took long time to happen. But after the coalescing is disabled, we never see such issue.&lt;/p&gt;</comment>
                            <comment id="15737380" author="jay.zhuang" created="Sat, 10 Dec 2016 06:59:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; one comment on the patch:&lt;br/&gt;
In 2.2, the default value for otc_coalescing_strategy is actually &apos;TIMEHORIZON&apos;. It was disabled &lt;b&gt;before&lt;/b&gt; 2.2.&lt;/p&gt;</comment>
                            <comment id="15847017" author="anguenot" created="Tue, 31 Jan 2017 16:08:39 +0000"  >&lt;p&gt;On our side, we observed a significant latency decrease disabling coalescing but that was not the &#8220;worst&#8221; issue.  &lt;/p&gt;

&lt;p&gt;As &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt; mentioned and outlined w/ the email thread in the comment above, when we went from 2.1.x to 2.2.x (and then 3.0.x), nodes, after some time, would start showing a very high numbers of pending writes and then stop responding having as an unexpected result to bring down a whole DC (RF=3) as soon as one (1) node in a DC would start displaying this behavior, although the two (2) other nodes were up and running, client queries, performed at local quorum, would just fail with 0 replicas acknowledging the reads.&lt;/p&gt;

&lt;p&gt;Stopping the one (1) failing node would make the client able to query at local quorum again and once the failing node got recycled and back in the ring, everything was back to normal. For another couple of days&#8230;&lt;/p&gt;

&lt;p&gt;Although not easily reproducible it was consistent and regularly happening: let&#8217;s say on a weekly interval in every DC.&lt;/p&gt;

&lt;p&gt;As soon as coalescing was disabled I have never seen that behavior ever again.&lt;/p&gt;

&lt;p&gt;I wanted to test again with the latest 3.0.10 before posting this, since we have been running with coalescing disabled w/ 3.0.x for a while now, and I can definitely still see that behavior happening in one if our DC, after a week or so, right after coalescing was enabled.&lt;/p&gt;

&lt;p&gt;If a patch  makes it through in a 3.0.x release at some point, I can certainly enable coalescing in a DC again and give some feedback &lt;/p&gt;

&lt;p&gt;Obviously, I could only suggest disabling coalescing in 2.2.x and 3.0.x branches by default in the meantime.&lt;/p&gt;</comment>
                            <comment id="15893764" author="jjirsa" created="Fri, 3 Mar 2017 05:31:46 +0000"  >&lt;p&gt;Committed in &lt;tt&gt;e11f75081727e650353ac12ec50f508fa9387d60&lt;/tt&gt; and merged up through trunk.&lt;/p&gt;

&lt;p&gt;I&apos;ve only changed NEWS.txt on 3.0:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;+   - In 2.1, the default for otc_coalescing_strategy was &apos;DISABLED&apos;.&lt;br/&gt;
 +     In 2.2 and 3.0, it was changed to &apos;TIMEHORIZON&apos;, but that value was shown&lt;br/&gt;
 +     to be a performance regression. The default for 3.11.0 and newer has&lt;br/&gt;
 +     been reverted to &apos;DISABLED&apos;. Users upgrading to Cassandra 3.0 should&lt;br/&gt;
 +     consider setting otc_coalescing_strategy to &apos;DISABLED&apos;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;And used a slightly different wording on 3.11 and trunk (in addition to actually changing the default:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;+   - In 2.1, the default for otc_coalescing_strategy was &apos;DISABLED&apos;.&lt;br/&gt;
 +     In 2.2 and 3.0, it was changed to &apos;TIMEHORIZON&apos;, but that value was shown&lt;br/&gt;
 +     to be a performance regression. The default for 3.11.0 and newer has&lt;br/&gt;
 +     been reverted to &apos;DISABLED&apos;. Users upgrading from Cassandra 2.2 or 3.0 should&lt;br/&gt;
 +     be aware that the default has changed.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="15893769" author="jjirsa" created="Fri, 3 Mar 2017 05:39:54 +0000"  >&lt;p&gt;Also &lt;a href=&quot;https://github.com/apache/cassandra/commit/ff170af2a2879e1b195f0ea9df540b83b07caad8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ninja&apos;d in a supplemental commit&lt;/a&gt; to update cassandra.yaml since this parameter was actually added/exposed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13090&quot; title=&quot;Coalescing strategy sleeps too much&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13090&quot;&gt;&lt;del&gt;CASSANDRA-13090&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="16129162" author="mbulman" created="Wed, 16 Aug 2017 17:57:17 +0000"  >&lt;p&gt;Thoughts on removing 3.0.12 from Fix Version, to make life easier for our future selves, since the default was not changed there?  That was my initial assumption before reading all of the comments and confirming through git spelunking&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12842496" name="12676.diff" size="1414" author="jjirsa" created="Fri, 9 Dec 2016 06:13:08 +0000"/>
                            <attachment id="12842599" name="coalescing_disabled.png" size="202657" author="jay.zhuang" created="Fri, 9 Dec 2016 19:01:56 +0000"/>
                            <attachment id="12842470" name="result.html" size="1496557" author="jay.zhuang" created="Fri, 9 Dec 2016 01:43:53 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jjirsa]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13102"><![CDATA[Docs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 13 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i33uqn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332360">2.2.x</customfieldvalue>
    <customfieldvalue id="12332541">3.0.x</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>