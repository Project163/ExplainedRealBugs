<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:36:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5113] RepairCallback breaks CL guarantees</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5113</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;RepairCallback does not validate the consistency level of the query. It seems that this was done on purpose as the comments there says:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;/**
 * The main difference between this and ReadCallback is, ReadCallback has a ConsistencyLevel
 * it needs to achieve.  Repair on the other hand is happy to repair whoever replies within the timeout.
 */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Concretely, the get() method of RepairCallback:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;waits for all endpoints, even if there is more than strictly required by the CL.&lt;/li&gt;
	&lt;li&gt;if it timeouts, doesn&apos;t check it and always return a response.&lt;/li&gt;
	&lt;li&gt;for some reason, it returns null unless there is strictly more than 1 response.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;All of that seems wrong to me. The result of RepairCallback is what is returned to the client in case of a digest mismatch on the first read. So we must ensure that the CL has been reached. Also, returning null where there is 1 response (or none) seems clearly wrong.&lt;/p&gt;

&lt;p&gt;In fact I don&apos;t think we need a special callback for this &quot;read all data&quot; phase as it is a &quot;normal&quot; read (the fact we do a first read with digests is just an &quot;optimization&quot;). The only difference between the two phases should be how we resolve the responses (in the first case we have digest and in the 2nd we don&apos;t) but that&apos;s handled by the resolver.&lt;/p&gt;

&lt;p&gt;So attaching a patch that removes RepairCallback and use ReadCallback instead.  I&apos;m also attaching a 2nd trivial patch that renames RowRepairResolver to RowDataResolver because I think it describe better what this actually do (i.e.  the main goal is to resolve a full data read to answer the right value to the client, repairing inconsistent nodes is secondary).&lt;/p&gt;

&lt;p&gt;The patch is against 1.1, because I think breaking CL guarantees is probably serious enough to warrant pushing this to 1.1.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12626061">CASSANDRA-5113</key>
            <summary>RepairCallback breaks CL guarantees</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Fri, 4 Jan 2013 16:25:19 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:20 +0000</updated>
                            <resolved>Mon, 7 Jan 2013 10:13:49 +0000</resolved>
                                        <fixVersion>1.2.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13544044" author="jbellis" created="Fri, 4 Jan 2013 17:27:55 +0000"  >&lt;p&gt;+1 on the fix.&lt;/p&gt;

&lt;p&gt;-0 on the rename; the only time we do full-data reads is for repairs so I don&apos;t really see an improvement there.&lt;/p&gt;

&lt;p&gt;-1 on committing to 1.1; this behavior has been present since at least 1.0 and probably longer, and changes to core StorageProxy code like this have a long track record of causing subtle regressions.&lt;/p&gt;</comment>
                            <comment id="13544065" author="slebresne" created="Fri, 4 Jan 2013 17:49:40 +0000"  >&lt;blockquote&gt;&lt;p&gt;the only time we do full-data reads is for repairs&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You kind of thouch my point, &quot;the only time we do full-data reads is for repairs&quot; is imho largely false. We do full-data reads in 2 places: # on a digest mismatch of an initial read (i.e. in SP.fetchRows) # on a digest mismatch in ReadCallback.maybeResolveForRepair, i.e.  asynchronously if we&apos;ve already responded to the client but have more response due to read_repair_chance kicking in.&lt;/p&gt;

&lt;p&gt;While in the 2nd case this is indeed &quot;for repairs&quot;, in the first case we first and foremost do the full-data read so we can compute the right/up-to-date value to return to the client. That&apos;s by far the most important use of the full-data read because that&apos;s where correctness is involved. The fact we use that occasion to compute diff and repair inconcistent nodes is secondary as it&apos;s after &quot;an optimization&quot;.&lt;/p&gt;

&lt;p&gt;So RowRepairResolver suggests repairing is the most important thing it does, but it&apos;s not.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;-1 on committing to 1.1; this behavior has been present since at least 1.0&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I can buy that. And for the record, the risk of breaking CL guarantees is actually pretty low as you need a digetst mistmatch and have a node die between the digest phase and the full-data read phase.&lt;/p&gt;

&lt;p&gt;One thing that has more chance to occurs with the current implementation is to get requests that take rpc_timeout seconds to return sometimes if read_repair_change &amp;gt; 0. Because in that case, and in the even of a mismatch, RepairCallback.get() will wait for all replica (even at QUORUM), so there is a real change that it&apos;ll wait until the timeout. But after that timeout it will almost always return the correct value, so it&apos;s just an inefficiency.&lt;/p&gt;

&lt;p&gt;I&apos;ll rebase the patches to 1.2.&lt;/p&gt;</comment>
                            <comment id="13544094" author="slebresne" created="Fri, 4 Jan 2013 18:18:08 +0000"  >&lt;p&gt;Alright, 1.2 rebased version attached (including the rename since as said above I do really like it &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;)&lt;/p&gt;</comment>
                            <comment id="13544117" author="jbellis" created="Fri, 4 Jan 2013 19:11:07 +0000"  >&lt;p&gt;+1 on both&lt;/p&gt;</comment>
                            <comment id="13545747" author="slebresne" created="Mon, 7 Jan 2013 10:13:49 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12563333" name="0001-Always-ensure-CL-after-a-digest-mismatch-1.2.txt" size="15384" author="slebresne" created="Fri, 4 Jan 2013 18:18:08 +0000"/>
                            <attachment id="12563308" name="0001-Always-ensure-CL-after-a-digest-mismatch.txt" size="15119" author="slebresne" created="Fri, 4 Jan 2013 16:25:39 +0000"/>
                            <attachment id="12563334" name="0002-Rename-RowRepairResolver-to-RowDataResolver-1.2.txt" size="29732" author="slebresne" created="Fri, 4 Jan 2013 18:18:08 +0000"/>
                            <attachment id="12563309" name="0002-Rename-RowRepairResolver-to-RowDataResolver.txt" size="30073" author="slebresne" created="Fri, 4 Jan 2013 16:25:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>302644</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 46 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i174hb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>249694</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>