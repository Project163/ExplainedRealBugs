<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:19:10 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16381] nodetool removenode error &#8220;Conflicting replica added&#8221;</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16381</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When testing elassandra on C* 4.0, integration tests with ccm systematically failed on removing a node with the following error &#8220;Conflicting replica added&#8221; . &lt;a href=&quot;https://github.com/strapdata/elassandra/blob/v6.8.4-strapdata/integ-test/test-cleanup-repair.sh#L289&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This integration test &lt;/a&gt;&#160;was ok with Elassandra based on Cassandra 3.11, and there is no changes in that test. Moreover, it seems there is no cassandra-test (dtest) for removing a node (there is only one removenode test for transient replication). The topology_test.py remove a node from the CCM cluster, but it does not call nodetool removenode.&lt;/p&gt;

&lt;p&gt;I wonder if we have a non-tested regression here in C 4.0 ?&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;++ ccm node1 nodetool status
++ awk &#8216;/127.0.0.3/ \{ print $7 }&#8217;
+ HOST_ID3=6d2e858f-dacc-4c7c-a626-14b45f6b3b94
+ ccm node3 stop
+ ccm node1 nodetool removenode 6d2e858f-dacc-4c7c-a626-14b45f6b3b94
Traceback (most recent call last):
&#160;&#160;File &#8220;/usr/local/bin/ccm&#8221;, line 4, in &amp;lt;module&amp;gt;
&#160;&#160;&#160;&#160;__import__(&#8216;pkg_resources&#8217;).run_script(&#8216;ccm==3.1.6&#8217;, &#8216;ccm&#8217;)
&#160;&#160;File &#8220;/System/Library/Frameworks/Python.framework/Versions/2.7/Extras/lib/python/pkg_resources/__init__.py&#8221;, line 742, in run_script
&#160;&#160;&#160;&#160;self.require(requires)[0].run_script(script_name, ns)
&#160;&#160;File &#8220;/System/Library/Frameworks/Python.framework/Versions/2.7/Extras/lib/python/pkg_resources/__init__.py&#8221;, line 1674, in run_script
&#160;&#160;&#160;&#160;exec(script_code, namespace, namespace)
&#160;&#160;File &#8220;/Library/Python/2.7/site-packages/ccm-3.1.6-py2.7.egg/EGG-INFO/scripts/ccm&#8221;, line 112, in &amp;lt;module&amp;gt;&#160;&#160;File &#8220;build/bdist.macosx-10.14-intel/egg/ccmlib/cmds/node_cmds.py&#8221;, line 233, in run
&#160;&#160;File &#8220;build/bdist.macosx-10.14-intel/egg/ccmlib/node.py&#8221;, line 848, in nodetool
&#160;&#160;File &#8220;build/bdist.macosx-10.14-intel/egg/ccmlib/node.py&#8221;, line 2131, in handle_external_tool_process
ccmlib.node.ToolError: Subprocess [&#8216;nodetool&#8217;, &#8216;-h&#8217;, &#8216;localhost&#8217;, &#8216;-p&#8217;, &#8216;7100&#8217;, &#8216;removenode&#8217;, &#8216;6d2e858f-dacc-4c7c-a626-14b45f6b3b94&#8217;] exited with non-zero status; exit status: 1;
stdout: nodetool: Conflicting replica added (expected unique ranges): Full(/127.0.0.1:7000,(4949329179655327935,6135417578204142297]); existing: Full(/127.0.0.1:7000,(4949329179655327935,6135417578204142297])
See &#8216;nodetool help&#8217; or &#8216;nodetool help &amp;lt;command&amp;gt;&#8217;.++ finish
++ echo &#8216;ERROR occurs, test failed&#8217;
ERROR occurs, test failed
++ &#8216;[&#8217; &#8216;!&#8217; -z &#8216;&#8217; &#8216;]&#8217;
++ exit 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13351820">CASSANDRA-16381</key>
            <summary>nodetool removenode error &#8220;Conflicting replica added&#8221;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mck">Michael Semb Wever</assignee>
                                    <reporter username="vroyer59">vincent royer</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Jan 2021 16:50:39 +0000</created>
                <updated>Wed, 2 Jun 2021 18:11:44 +0000</updated>
                            <resolved>Wed, 3 Mar 2021 07:16:53 +0000</resolved>
                                        <fixVersion>4.0-rc1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Bootstrap and Decommission</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17276742" author="brandon.williams" created="Mon, 1 Feb 2021 23:58:35 +0000"  >&lt;p&gt;I added a simple removenode test &lt;a href=&quot;https://github.com/driftx/cassandra-dtest/tree/CASSANDRA-16381&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and a patch that gets around the duplicate sources &lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-16381&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; which were coming from system_traces (for some reason.)  This works great... until you add any user defined data, as stress does.   This will cause streaming errors and then the hosts involved in streaming will also lose network connectivity to each other and begin dropping gossip syn messages.&lt;/p&gt;

&lt;p&gt;The area of code to modify to make the replicas distinct comes from transient replication, but the duplicates don&apos;t occur until &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15666&quot; title=&quot;Race condition when completing stream sessions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15666&quot;&gt;&lt;del&gt;CASSANDRA-15666&lt;/del&gt;&lt;/a&gt;.  I&apos;m not really sure what&apos;s going on here, could you take a look, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17277071" author="blerer" created="Tue, 2 Feb 2021 12:08:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; Sure &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17277953" author="blerer" created="Wed, 3 Feb 2021 12:06:15 +0000"  >&lt;p&gt;Looking into it more deeply. I had initially misunderstood the problem.&lt;/p&gt;</comment>
                            <comment id="17278064" author="brandon.williams" created="Wed, 3 Feb 2021 15:14:56 +0000"  >&lt;p&gt;Attaching the dtest dir from a failed run. You can see that a node not being removed is marked down but then quickly marked back up.  Also attaching logs from a manual test I did; there seems to be a timing component here, as in the manual test the node is marked down and never comes back up.&lt;/p&gt;</comment>
                            <comment id="17278073" author="beobal" created="Wed, 3 Feb 2021 15:28:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;a node not being removed is marked down but then quickly marked back up&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sounds similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16094&quot; title=&quot;Avoid marking shutting down nodes as up after receiving gossip shutdown message&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16094&quot;&gt;&lt;del&gt;CASSANDRA-16094&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17278075" author="brandon.williams" created="Wed, 3 Feb 2021 15:29:54 +0000"  >&lt;p&gt;But this is a node that is NOT being removed - it was never down.&lt;/p&gt;</comment>
                            <comment id="17278076" author="beobal" created="Wed, 3 Feb 2021 15:31:28 +0000"  >&lt;p&gt;ah sorry, I misread and thought that the node going DOWN/UP was not removed when it should have been&#160;&lt;br/&gt;
/me slides back into the shadows&lt;/p&gt;</comment>
                            <comment id="17286125" author="aholmber" created="Wed, 17 Feb 2021 20:11:55 +0000"  >&lt;p&gt;I&apos;ve been looking at this, but don&apos;t let that deter anyone else who wants to have a go. I&apos;m not previously knowledgable in these areas of the code.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;This will cause streaming errors and then the hosts involved in streaming will also lose network connectivity to each other and begin dropping gossip syn messages.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That doesn&apos;t match exactly what I&apos;ve seen here on trunk. We should see if we can corroborate. I&apos;ll describe my observations here:&lt;/p&gt;

&lt;p&gt;When running Brandon&apos;s simple test, intermittently (but consistently) we see removenode hang. When in this state, the remaining servers are still responsive to client traffic, but the nodetool command will hang forever (until the test times out). The remaining nodes continue attempting to reconnect to the node intended for removal. Meanwhile a previously queued SYN message to that node expires. I think the reconnect and message expiry are non-issues, assuming that would stop if the node removal completes. Will have to get back to that after figuring out the primary issue. On to that...&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;removenode&lt;/tt&gt; is hanging forever in &lt;a href=&quot;https://github.com/apache/cassandra/blob/e8a9d4203c81e622fc2418d2faf2593e2123161e/src/java/org/apache/cassandra/service/StorageService.java#L4732-L4735&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this loop&lt;/a&gt; on the coordinating node1 because it is never receiving the final &lt;tt&gt;REPLICATION_DONE_REQ&lt;/tt&gt; message sent by node2. Both nodes appear to complete their streaming sessions without error and send that message. We never see the one from node2 arrive at node1. At the same time, I&apos;m seeing gossip diverge between node1. node2. They eventually convict each other. The node2 streaming session complete message &lt;a href=&quot;https://github.com/apache/cassandra/blob/e8a9d4203c81e622fc2418d2faf2593e2123161e/src/java/org/apache/cassandra/service/StorageService.java#L3027-L3028&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;times out&lt;/a&gt; having never seen a response. The loop is exited because node1 is not &quot;alive&quot; immediately after the conviction.&lt;/p&gt;

&lt;p&gt;Current avenues of investigation:&lt;br/&gt;
1.) Look into why the replication done request is not being sent/received. Presently I think I see it being enqueued, but never serialized and sent.&lt;br/&gt;
2.) Understand gossip diverging at the end of the streaming session.&lt;/p&gt;</comment>
                            <comment id="17288680" author="aholmber" created="Mon, 22 Feb 2021 22:56:02 +0000"  >&lt;p&gt;The apparent network/messaging interruption was being caused by a deadlock of the OutboundConnection event loop thread and the streaming threads. I&apos;ll explain a bit more below, but for now I&apos;m going to offer the patch removing the duplicated replication tasks, which also removes the deadlock. We can decide in review if the other stuff warrants another ticket.&lt;/p&gt;

&lt;p&gt;The duplication was being caused because SS processes each change for [each key|https://github.com/apache/cassandra/blob/5ed5e84613ef0e9664a774493db7d2604e3596e0/src/java/org/apache/cassandra/service/StorageService.java#L3234-L3237} in the event &lt;tt&gt;EndpointState&lt;/tt&gt;, but that presently has keys for both &lt;tt&gt;STATUS_WITH_PORT&lt;/tt&gt; and the deprecated &lt;tt&gt;STATUS&lt;/tt&gt; (&lt;a href=&quot;https://github.com/apache/cassandra/blob/5ed5e84613ef0e9664a774493db7d2604e3596e0/src/java/org/apache/cassandra/service/StorageService.java#L3234-L3237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ref&lt;/a&gt;), so two replication tasks get kicked off for the same event.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/aholmberg/cassandra/pull/40&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/aholmberg/cassandra?branch=CASSANDRA-16381&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci&lt;/a&gt; running&lt;/p&gt;</comment>
                            <comment id="17288914" author="bereng" created="Tue, 23 Feb 2021 07:28:52 +0000"  >&lt;p&gt;You will have to rerun circle with MID config as it&apos;s just a wall of red now &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17289098" author="aholmber" created="Tue, 23 Feb 2021 14:08:42 +0000"  >&lt;p&gt;argh. I was in a rush and forgot the circle config. Thanks Berenguer. Will get back with that.&lt;br/&gt;
(another run is started at the same link)&lt;/p&gt;</comment>
                            <comment id="17289101" author="brandon.williams" created="Tue, 23 Feb 2021 14:14:12 +0000"  >&lt;p&gt;Jenkins running &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/395/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17289375" author="brandon.williams" created="Tue, 23 Feb 2021 21:52:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/395/testReport/junit/dtest-large-novnode.replication_test/TestReplication/test_network_topology/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This&lt;/a&gt; looks a bit suspect to me, though the code looks good and my dtest passed.&lt;/p&gt;</comment>
                            <comment id="17289409" author="aholmber" created="Tue, 23 Feb 2021 22:51:01 +0000"  >&lt;p&gt;This test is broken for 4.0, independent of the changes I&apos;m proposing here (it&apos;s regexing for trace messages that changed format). I&apos;ll open a ticket, but I would prefer not to block since it&apos;s known to be a test issue, and I&apos;ve manually verified the functionality that test is trying to characterize.&lt;/p&gt;</comment>
                            <comment id="17289411" author="brandon.williams" created="Tue, 23 Feb 2021 22:52:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;my dtest passed.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Scratch that, it never ran because I ran against the current dtests.&lt;/p&gt;</comment>
                            <comment id="17289673" author="bereng" created="Wed, 24 Feb 2021 05:47:38 +0000"  >&lt;p&gt;The networking topology failure is a known failure, correct.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aholmber&quot; class=&quot;user-hover&quot; rel=&quot;aholmber&quot;&gt;aholmber&lt;/a&gt; plenty of random commits got pushed to the PR, probably some git acrobatics gone wrong &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; Also seems the original commit is missing a test &lt;em&gt;if&lt;/em&gt; it&apos;s doable and you&apos;ll have to re-run ci bc the ci runs we have have those extra commits.&lt;/p&gt;</comment>
                            <comment id="17290036" author="aholmber" created="Wed, 24 Feb 2021 15:50:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;Bereng&lt;/a&gt; thanks for pointing that out. I rebased against the stuff coming in on apache/cassandra and forgot to update trunk on my fork. It&apos;s clean now.&lt;/p&gt;</comment>
                            <comment id="17290700" author="bereng" created="Thu, 25 Feb 2021 06:02:31 +0000"  >&lt;p&gt;Wall of red again. The cqlsh failures I can&apos;t tell. But the dtests failures upon the missing  &apos;parentRepairSessionsCount&apos; is bc you have to rebase both dtests and C* code. But that would bring you up to date with ci-cass imo which atm is also a wall of red.&lt;/p&gt;

&lt;p&gt;So I think our best bet here is to wait for ci-cass to be back to green-ish and then rebase bc there are too many things breaking the code going on at once.&lt;/p&gt;</comment>
                            <comment id="17290960" author="brandon.williams" created="Thu, 25 Feb 2021 14:48:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;The cqlsh failures I can&apos;t tell. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;These are currently known to fail after the driver change and are being worked on.&lt;/p&gt;</comment>
                            <comment id="17291277" author="aholmber" created="Thu, 25 Feb 2021 22:52:42 +0000"  >&lt;p&gt;I see Sam pushed some dtest changes today. I&apos;ve rebased both server PR and my dtest branch containing Brandon&apos;s test. CI running now.&lt;/p&gt;</comment>
                            <comment id="17291395" author="bereng" created="Fri, 26 Feb 2021 05:15:37 +0000"  >&lt;p&gt;Nah wall of red still on driver issues. Btw do you think adding a unit test is feasible?&lt;/p&gt;</comment>
                            <comment id="17291819" author="aholmber" created="Fri, 26 Feb 2021 17:23:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mck&quot; class=&quot;user-hover&quot; rel=&quot;mck&quot;&gt;mck&lt;/a&gt; had a good suggestion during review.  I&apos;m not in a position to be as responsive as I&apos;d like at this time, and he&apos;s offered to take the reins on this. Thanks Mick!&lt;/p&gt;</comment>
                            <comment id="17291854" author="michaelsembwever" created="Fri, 26 Feb 2021 18:20:15 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aholmber&quot; class=&quot;user-hover&quot; rel=&quot;aholmber&quot;&gt;aholmber&lt;/a&gt;. New patch is Adam&apos;s work, just with the filtering moved from &lt;tt&gt;StorageService&lt;/tt&gt; up to &lt;tt&gt;Gossiper&lt;/tt&gt;. I think this helps it be a bit more inclusive it catching the redundant application states on incoming endpoint changes.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;patches: &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...thelastpickle:mck/trunk_16381&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cassandra&lt;/a&gt;, &lt;a href=&quot;https://github.com/driftx/cassandra-dtest/commits/CASSANDRA-16381&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cassandra-dtest&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;ci-cassandra.a.o: &lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/424/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/424/badge/icon&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt;, and with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;&apos;s dtest:  &lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-dtest/438/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch-dtest/438/badge/icon&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</comment>
                            <comment id="17291953" author="michaelsembwever" created="Fri, 26 Feb 2021 22:52:51 +0000"  >&lt;p&gt;CI is a bit of a mess atm, e.g. topology_test.py::TestTopology::test_simple_removenode is working locally for me. But I think there&apos;s a fair few breakages here that I do need to look into tomorrow.&lt;/p&gt;</comment>
                            <comment id="17292086" author="michaelsembwever" created="Sat, 27 Feb 2021 10:10:09 +0000"  >&lt;p&gt;A consequence of this patch is that &lt;tt&gt;`nodetool gossipinfo`&lt;/tt&gt; will no longer list the deprecated application states on remote (4.0) endpoints. Gossipinfo will still list both versions of application states of the local endpoint (as that needs to be broadcasted so for &amp;lt;4.0 endpoints in a mix-version cluster). This required a &lt;a href=&quot;https://github.com/thelastpickle/cassandra-dtest/commit/6b63a1831000a462209978af1263a3ea32d38344&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fix&lt;/a&gt; in the snitch_test.py dtest.&lt;/p&gt;

&lt;p&gt;For example, this output from &lt;tt&gt;snitch_test.py::TestGossipingPropertyFileSnitch::test_prefer_local_reconnect_on_listen_address&lt;/tt&gt; called on node1 (127.0.0.3).&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;/127.0.0.4
  generation:1614418673
  heartbeat:88
  STATUS:75:NORMAL,0
  LOAD:18:75875.0
  SCHEMA:21:5a4d7919-7143-3e86-a586-ce62ee960249
  DC:11:dc1
  RACK:13:rack1
  RELEASE_VERSION:5:4.0-beta5-SNAPSHOT
  INTERNAL_IP:9:127.0.0.2
  RPC_ADDRESS:4:127.0.0.2
  NET_VERSION:1:12
  HOST_ID:2:92406fb2-63ba-4e4d-9228-bf14ed22d7c4
  RPC_READY:85:true
  INTERNAL_ADDRESS_AND_PORT:7:127.0.0.2:7000
  NATIVE_ADDRESS_AND_PORT:3:127.0.0.2:9042
  STATUS_WITH_PORT:74:NORMAL,0
  TOKENS:73:&amp;lt;hidden&amp;gt;
/127.0.0.3
  generation:1614418645
  heartbeat:117
  LOAD:96:105177.0
  SCHEMA:43:5a4d7919-7143-3e86-a586-ce62ee960249
  DC:11:dc1
  RACK:13:rack1
  RELEASE_VERSION:5:4.0-beta5-SNAPSHOT
  NET_VERSION:1:12
  HOST_ID:2:53cacd4a-7ed9-4efe-bbe3-de04701a9c74
  RPC_READY:35:true
  INTERNAL_ADDRESS_AND_PORT:7:127.0.0.1:7000
  NATIVE_ADDRESS_AND_PORT:3:127.0.0.1:9042
  STATUS_WITH_PORT:22:NORMAL,-9223372036854775808
  TOKENS:21:&amp;lt;hidden&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17292870" author="michaelsembwever" created="Mon, 1 Mar 2021 13:08:40 +0000"  >&lt;p&gt;There&apos;s another bug here, introduced with the transient replicas work, only visible when testing with vnodes.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;StorageServer.restoreReplicaCount(..)&lt;/tt&gt; can come up with a list of new replica token ranges where one of them is identical to an existing. This causes the error like&#8230;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.IllegalArgumentException: Conflicting replica added (expected unique ranges): Full(/127.0.0.2:7000,(-7412624036846214601,-4901911818908895437]); existing: Full(/127.0.0.2:7000,(-7412624036846214601,-4901911818908895437])
	at org.apache.cassandra.locator.RangesAtEndpoint$Builder.add(RangesAtEndpoint.java:212)
	at org.apache.cassandra.locator.RangesAtEndpoint$Builder.add(RangesAtEndpoint.java:189)
	at org.apache.cassandra.locator.ReplicaCollection$Builder.add(ReplicaCollection.java:154)
	at java.util.stream.ReduceOps$3ReducingSink.accept(ReduceOps.java:169)
	at java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:193)
	at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:175)
	at java.util.HashMap$KeySpliterator.forEachRemaining(HashMap.java:1556)
	at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
	at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
	at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708)
	at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
	at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:566)
	at org.apache.cassandra.service.StorageService.lambda$null$18(StorageService.java:3127)
	at java.util.Map.forEach(Map.java:630)
	at org.apache.cassandra.service.StorageService.lambda$restoreReplicaCount$19(StorageService.java:3119)
	at java.util.HashMap.forEach(HashMap.java:1289)
	at org.apache.cassandra.service.StorageService.restoreReplicaCount(StorageService.java:3117)
	at org.apache.cassandra.service.StorageService.handleStateRemoving(StorageService.java:2893)
	at org.apache.cassandra.service.StorageService.onChange(StorageService.java:2285)
	at org.apache.cassandra.service.StorageService.onJoin(StorageService.java:3236)
	at org.apache.cassandra.gms.Gossiper.handleMajorStateChange(Gossiper.java:1276)
	at org.apache.cassandra.gms.Gossiper.applyStateLocally(Gossiper.java:1394)
	at org.apache.cassandra.gms.GossipDigestAckVerbHandler.doVerb(GossipDigestAckVerbHandler.java:84)
        &#8230;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;A simple fix is to change the behaviour of &lt;tt&gt;RangesAtEndpoint.add(..)&lt;/tt&gt; from &lt;tt&gt;Conflict.NONE&lt;/tt&gt; to &lt;tt&gt;Conflict.DUPLICATE&lt;/tt&gt;, but I&apos;m not too sure if that is safe&#8230;&lt;/p&gt;</comment>
                            <comment id="17292879" author="brandon.williams" created="Mon, 1 Mar 2021 13:22:12 +0000"  >&lt;p&gt;Is this different from the one my &lt;a href=&quot;https://github.com/driftx/cassandra/commit/40a3ec5f5d6d3eb2677fa5b8a765719493312706&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;first patch&lt;/a&gt; tried to solve?&lt;/p&gt;</comment>
                            <comment id="17292885" author="michaelsembwever" created="Mon, 1 Mar 2021 13:36:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;&#8230; a patch that gets around the duplicate sources here &#8230;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I totally missed that you had already spotted this &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;! Yes, it is the same thing. &lt;/p&gt;</comment>
                            <comment id="17292976" author="michaelsembwever" created="Mon, 1 Mar 2021 15:47:43 +0000"  >&lt;p&gt;New patch, includes fix for deprecated ApplicationStates and for handling duplicated replicas collected in &lt;tt&gt;RangesAtEndpoint&lt;/tt&gt;.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;patches: &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...thelastpickle:mck/trunk_16381&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cassandra&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra-dtest/compare/trunk...thelastpickle:mck/trunk_16381&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cassandra-dtest&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;ci-cassandra.a.o: &lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/437/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/437/badge/icon&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt;,&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;UPDATE: CI results look good (unrelated).&lt;/p&gt;</comment>
                            <comment id="17293218" author="jhickey" created="Mon, 1 Mar 2021 22:53:14 +0000"  >&lt;p&gt;Hi, I stumbled upon this issue because I just ran into this live when trying to nodetool remove a DN node (EC2 instance failed healthcheck/terminated).&lt;/p&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;nodetool: Conflicting replica added (expected unique ranges): Full(/10.65.13.40:7000,(4964172795476831591,5638026500598693924]); existing: Full(/10.65.13.40:7000,(4964172795476831591,5638026500598693924])&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Commenting in case this info helps with patch priority. Version is 4.0-beta4, using vnodes.&lt;/p&gt;</comment>
                            <comment id="17293464" author="michaelsembwever" created="Tue, 2 Mar 2021 07:41:57 +0000"  >&lt;p&gt;Thanks for the report &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jhickey&quot; class=&quot;user-hover&quot; rel=&quot;jhickey&quot;&gt;jhickey&lt;/a&gt;. This ticket is urgent (and the ticket now marked as such) and is blocking the next release.&lt;/p&gt;</comment>
                            <comment id="17293689" author="michaelsembwever" created="Tue, 2 Mar 2021 13:17:16 +0000"  >&lt;p&gt;I&apos;ve bisected using the new dtest, and the duplicates bug goes back to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14404&quot; title=&quot;Transient Replication &amp;amp; Cheap Quorums: Decouple storage requirements from consensus group size using incremental repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14404&quot;&gt;CASSANDRA-14404&lt;/a&gt; and &lt;a href=&quot;https://github.com/thelastpickle/cassandra/commit/f7431b432875e334170ccdb19934d05545d2cebd#diff-a8ef260117550e1d260388e780f7197a624d7aba98af043100d31f40771117c1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;f7431b432875e334170ccdb19934d05545d2cebd&lt;/a&gt;. &lt;/p&gt;</comment>
                            <comment id="17293785" author="brandon.williams" created="Tue, 2 Mar 2021 15:43:12 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17294005" author="aholmber" created="Tue, 2 Mar 2021 21:39:49 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17294263" author="bereng" created="Wed, 3 Mar 2021 04:16:28 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17294335" author="michaelsembwever" created="Wed, 3 Mar 2021 07:16:53 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/64f54f9fb0ac1fe2920f44379326cf076ab8aab8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;64f54f9fb0ac1fe2920f44379326cf076ab8aab8&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17295554" author="aholmber" created="Thu, 4 Mar 2021 19:49:04 +0000"  >&lt;p&gt;Are the dtest changes still forthcoming? I saw the patch, but it appears to me that it was not merged on &lt;tt&gt;apache/cassandra-dtest&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17295562" author="brandon.williams" created="Thu, 4 Mar 2021 20:00:02 +0000"  >&lt;p&gt;I&apos;ve committed those.&lt;/p&gt;</comment>
                            <comment id="17295563" author="aholmber" created="Thu, 4 Mar 2021 20:01:32 +0000"  >&lt;p&gt;I see it. Thanks!&lt;/p&gt;</comment>
                            <comment id="17295879" author="michaelsembwever" created="Fri, 5 Mar 2021 08:51:31 +0000"  >&lt;p&gt;Thanks for catching that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aholmber&quot; class=&quot;user-hover&quot; rel=&quot;aholmber&quot;&gt;aholmber&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17355900" author="maedhroz" created="Wed, 2 Jun 2021 18:09:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;A simple fix is to change the behaviour of RangesAtEndpoint.add(..) from Conflict.NONE to Conflict.DUPLICATE, but I&apos;m not too sure if that is safe&#8230;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Did we ever figure out what about &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14404&quot; title=&quot;Transient Replication &amp;amp; Cheap Quorums: Decouple storage requirements from consensus group size using incremental repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14404&quot;&gt;CASSANDRA-14404&lt;/a&gt; started generating duplicates?&lt;/p&gt;

&lt;p&gt;(Aside: I&apos;m guessing this is one of the things we would have discovered in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14669&quot; title=&quot;Transient Replication: Confirm vnode support w/Transient Replication&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14669&quot;&gt;CASSANDRA-14669&lt;/a&gt;...)&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13365655">CASSANDRA-16525</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13019930" name="dtest.tar.bz2" size="10061609" author="brandon.williams" created="Wed, 3 Feb 2021 15:13:23 +0000"/>
                            <attachment id="13019931" name="node1.tar.bz2" size="36427" author="brandon.williams" created="Wed, 3 Feb 2021 15:13:28 +0000"/>
                            <attachment id="13019932" name="node2.tar.bz2" size="36114" author="brandon.williams" created="Wed, 3 Feb 2021 15:13:29 +0000"/>
                            <attachment id="13019933" name="node3.tar.bz2" size="26851" author="brandon.williams" created="Wed, 3 Feb 2021 15:13:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mck]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="13162" cascade-level="1"><![CDATA[API / Semantic Definition]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 23 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0migg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aholmber]]></customfieldvalue>
        <customfieldvalue><![CDATA[bereng]]></customfieldvalue>
        <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/64f54f9fb0ac1fe2920f44379326cf076ab8aab8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/64f54f9fb0ac1fe2920f44379326cf076ab8aab8&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;dtest offered by Brandon.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>