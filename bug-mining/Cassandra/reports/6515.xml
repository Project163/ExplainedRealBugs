<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:30:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19779] direct IO support is always evaluated to false upon the very first start of a node</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19779</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When I extract the distribution tarball and I want to use tools in tools/bin, there is this warn log visible every time for tools when they are started (does not happen on &quot;help&quot; command, obviously)&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN &#160;14:25:11,835 Unable to determine block size &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commit log directory: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;This is because we introduced this (1) in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18464&quot; title=&quot;Enable Direct I/O For CommitLog Files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18464&quot;&gt;&lt;del&gt;CASSANDRA-18464&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;What that does is that it will go and try to create a temporary file in commit log directory to get &quot;block size&quot; for a &quot;file store&quot; that file is in.&lt;/p&gt;

&lt;p&gt;The problem with that is that when we just extract a tarball and run the tools - Cassandra was never started - then such commit log directory does not exist yet, so it tries to create a temporary file in a non-existing directory, which fails, hence the log message.&lt;/p&gt;

&lt;p&gt;The fix is to check if commitlog dir exists and return / skip the resolution of block size if it does not.&lt;/p&gt;

&lt;p&gt;Another approach might be to check if this is executed in the context of a tool and skip it from resolution altogether. The problem with this is that not all tools we have in bin/log call DatabaseDescriptor.&lt;br/&gt;
toolInitialization() so we might combine these two.&lt;br/&gt;
(1) &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-5.0/src/java/org/apache/cassandra/config/DatabaseDescriptor.java#L1455-L1462&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-5.0/src/java/org/apache/cassandra/config/DatabaseDescriptor.java#L1455-L1462&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13586264">CASSANDRA-19779</key>
            <summary>direct IO support is always evaluated to false upon the very first start of a node</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="smiklosovic">Stefan Miklosovic</assignee>
                                    <reporter username="smiklosovic">Stefan Miklosovic</reporter>
                        <labels>
                    </labels>
                <created>Thu, 18 Jul 2024 12:53:12 +0000</created>
                <updated>Fri, 9 Aug 2024 09:30:44 +0000</updated>
                            <resolved>Mon, 5 Aug 2024 00:14:16 +0000</resolved>
                                        <fixVersion>5.0-rc2</fixVersion>
                    <fixVersion>5.0.1</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Legacy/Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="3600">1h</timespent>
                                <comments>
                            <comment id="17867022" author="smiklosovic" created="Thu, 18 Jul 2024 14:24:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/3428&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/3428&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17868097" author="smiklosovic" created="Tue, 23 Jul 2024 15:05:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bschoeni&quot; class=&quot;user-hover&quot; rel=&quot;bschoeni&quot;&gt;bschoeni&lt;/a&gt; would you mind to take a look at this?&lt;/p&gt;</comment>
                            <comment id="17868471" author="bschoeni" created="Wed, 24 Jul 2024 19:46:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; LGTM +1&lt;/p&gt;</comment>
                            <comment id="17868892" author="smiklosovic" created="Fri, 26 Jul 2024 08:46:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-19779&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19779&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java17_pre-commit_tests                         
  &#10003; j17_build                                        4m 20s
  &#10003; j17_cqlsh_dtests_py311                            7m 2s
  &#10003; j17_cqlsh_dtests_py311_vnode                     7m 26s
  &#10003; j17_cqlsh_dtests_py38                             7m 3s
  &#10003; j17_cqlsh_dtests_py38_vnode                      7m 31s
  &#10003; j17_cqlshlib_cython_tests                        7m 45s
  &#10003; j17_cqlshlib_tests                               6m 46s
  &#10003; j17_dtests                                      37m 29s
  &#10003; j17_unit_tests                                  13m 18s
  &#10003; j17_utests_latest                               12m 52s
  &#10003; j17_utests_oa                                   14m 34s
  &#10005; j17_dtests_latest                                35m 3s
      bootstrap_test.TestBootstrap test_consistent_range_movement_false_with_replica_down_should_succeed
  &#10005; j17_dtests_vnode                                 39m 0s
      bootstrap_test.TestBootstrap test_consistent_range_movement_false_with_rf1_should_succeed
  &#10005; j17_jvm_dtests                                   25m 8s
  &#10005; j17_jvm_dtests_latest_vnode                     26m 15s
      org.apache.cassandra.distributed.test.tcm.CMSPlacementAfterMoveTest testMoveToCMS                            
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4537/workflows/3ba4a6a6-86ed-4dbf-bc95-24ec4e3a7508&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_pre-commit_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17868896" author="smiklosovic" created="Fri, 26 Jul 2024 08:51:02 +0000"  >&lt;p&gt;failures seem to be just flakes&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19779&quot; title=&quot;direct IO support is always evaluated to false upon the very first start of a node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-19779&quot;&gt;&lt;del&gt;CASSANDRA-19779&lt;/del&gt;&lt;/a&gt;-5.0|https://github.com/instaclustr/cassandra/tree/CASSANDRA-19779-5.0]&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java17_pre-commit_tests                         
  &#10003; j17_build                                        3m 55s
  &#10003; j17_cqlsh_dtests_py311                           6m 26s
  &#10003; j17_cqlsh_dtests_py311_vnode                     6m 36s
  &#10003; j17_cqlsh_dtests_py38                             6m 0s
  &#10003; j17_cqlsh_dtests_py38_vnode                      6m 24s
  &#10003; j17_cqlshlib_cython_tests                        7m 46s
  &#10003; j17_cqlshlib_tests                               6m 31s
  &#10003; j17_dtests                                      34m 43s
  &#10003; j17_dtests_vnode                                34m 45s
  &#10003; j17_jvm_dtests                                   24m 1s
  &#10003; j17_jvm_dtests_latest_vnode                     14m 30s
  &#10003; j17_unit_tests                                   14m 4s
  &#10003; j17_utests_latest                               14m 46s
  &#10005; j17_dtests_latest                               33m 34s
      bootstrap_test.TestBootstrap test_decommissioned_wiped_node_can_join
  &#10005; j17_utests_oa                                   13m 10s
      org.apache.cassandra.cql3.validation.operations.CQLVectorTest sandwichBetweenUDTs
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4536/workflows/98064111-b82b-45c0-bc5f-e4d677c18ba3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_pre-commit_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17868944" author="smiklosovic" created="Fri, 26 Jul 2024 13:16:14 +0000"  >&lt;p&gt;I renamed this ticket because it is actually more serious than I was thinking. &lt;/p&gt;

&lt;p&gt;The problem is that when a node starts on the very first time, there are no directories yet in data/ dir (where commitlog, hints ... are). These directories are created AFTER the logic in DatabaseDescriptor.resolveCommitLogWriteDiskAccessMode(mode) is called. One can see this in the log when a node is started for the first time:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
WARN  [main] 2024-07-26 15:09:55,473 DatabaseDescriptor.java:1461 - Unable to determine block size &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; commit log directory: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That means &quot;directIOSupported&quot; will stay to be &quot;false&quot; because that commit log dir does not exist hence it means that this (2) will evaluate to &quot;legacy&quot; on the first boot.&lt;/p&gt;

&lt;p&gt;So when &quot;commitlog_disk_access_mode&quot; is set to &quot;auto&quot; on the first boot, then it will change it to &quot;legacy&quot; just because there is no commit log dir present. On the next boot, it will switch that to &quot;direct&quot;.&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/config/DatabaseDescriptor.java#L1463-L1470&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/config/DatabaseDescriptor.java#L1463-L1470&lt;/a&gt;&lt;br/&gt;
(2) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/config/DatabaseDescriptor.java#L1478&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/config/DatabaseDescriptor.java#L1478&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17869194" author="smiklosovic" created="Sun, 28 Jul 2024 19:14:56 +0000"  >&lt;p&gt;Good news is that I fixed it for cassandra.yaml, the default config there is &quot;legacy&quot;.&lt;/p&gt;

&lt;p&gt;The bad news is that it fails these tests while using &lt;b&gt;cassandra_latest.yaml&lt;/b&gt; profile&lt;/p&gt;

&lt;p&gt;org.apache.cassandra.repair.ConcurrentIrWithPreviewFuzzTest&lt;br/&gt;
org.apache.cassandra.repair.FailedAckTest&lt;br/&gt;
org.apache.cassandra.repair.FailingRepairFuzzTest&lt;br/&gt;
org.apache.cassandra.repair.HappyPathFuzzTest&lt;br/&gt;
org.apache.cassandra.repair.SlowMessageFuzzTest&lt;/p&gt;

&lt;p&gt;Exception it throws for all cases is&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        java.lang.UnsupportedOperationException
                at java.base/java.nio.file.FileStore.getBlockSize(FileStore.java:158)
                at org.apache.cassandra.io.util.FileUtils.getBlockSize(FileUtils.java:825)
                at org.apache.cassandra.db.commitlog.DirectIOSegment$DirectIOSegmentBuilder.&amp;lt;init&amp;gt;(DirectIOSegment.java:166)
                at org.apache.cassandra.db.commitlog.AbstractCommitLogSegmentManager.createSegmentBuilder(AbstractCommitLogSegmentManager.java:135)
                at org.apache.cassandra.db.commitlog.AbstractCommitLogSegmentManager.start(AbstractCommitLogSegmentManager.java:154)
                at org.apache.cassandra.db.commitlog.CommitLog.start(CommitLog.java:146)
                at org.apache.cassandra.db.commitlog.CommitLog.restartUnsafe(CommitLog.java:563)
                at org.apache.cassandra.ServerTestUtils.cleanupAndLeaveDirs(ServerTestUtils.java:148)
                at org.apache.cassandra.ServerTestUtils.prepareServer(ServerTestUtils.java:106)
                at org.apache.cassandra.cql3.CQLTester.prepareServer(CQLTester.java:360)
                at org.apache.cassandra.cql3.CQLTester.setUpClass(CQLTester.java:411)
                at org.apache.cassandra.cql3.CQLTester$InMemory.setUpClass(CQLTester.java:2876)
                at org.apache.cassandra.repair.FuzzTestBase.setUpClass(FuzzTestBase.java:280)
                at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
                at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
                at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The reason this is happening is that it uses &quot;InMemory.setUpClass&quot; (5th line from the bottom). That does this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        @BeforeClass
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; void setUpClass()
        {
            fs = FileSystems.newGlobalInMemoryFileSystem();
            CassandraRelevantProperties.IGNORE_MISSING_NATIVE_FILE_HINTS.setBoolean(&lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            FileSystems.maybeCreateTmp();

            CQLTester.setUpClass();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, when it is &quot;auto&quot;, previously, this failure was hidden, because commitlog dir was not created, hence &quot;directIOSupported&quot; was evaluated to false (the case described in the previous comment), so these tests have probably ever run with &quot;legacy&quot; only. So once we want to enable that, it does not play together, because here &quot;FileUtils.getBlockSize&quot; fails with UnsupportedOperationException because it is most probably not supported in &quot;FileSystems.newGlobalInMemoryFileSystem();&quot;.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; DirectIOSegmentBuilder(AbstractCommitLogSegmentManager segmentManager)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;(segmentManager, FileUtils.getBlockSize(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(segmentManager.storageDirectory)));
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I am trying to figure out what to do. This also means that we have never fuzz tested &quot;direct&quot; mode for cassandra_latest.yaml because the missing commitlog dir never triggered it.&lt;/p&gt;</comment>
                            <comment id="17869358" author="smiklosovic" created="Mon, 29 Jul 2024 13:42:43 +0000"  >&lt;p&gt;This patch just sets it forcibly to mmap.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-19779-5.0-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19779-5.0-2&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java17_pre-commit_tests                         
  &#10003; j17_build                                        4m 15s
  &#10003; j17_cqlsh_dtests_py311                          10m 48s
  &#10003; j17_cqlsh_dtests_py311_vnode                     6m 37s
  &#10003; j17_cqlsh_dtests_py38                            5m 55s
  &#10003; j17_cqlsh_dtests_py38_vnode                       6m 5s
  &#10003; j17_cqlshlib_cython_tests                        7m 38s
  &#10003; j17_cqlshlib_tests                               6m 35s
  &#10003; j17_dtests                                      33m 46s
  &#10003; j17_dtests_vnode                                34m 12s
  &#10003; j17_jvm_dtests                                  23m 47s
  &#10003; j17_jvm_dtests_latest_vnode                     14m 24s
  &#10003; j17_unit_tests                                  13m 40s
  &#10003; j17_utests_oa                                   13m 48s
  &#10005; j17_dtests_latest                                34m 2s
      bootstrap_test.TestBootstrap test_read_from_bootstrapped_node
  &#10005; j17_utests_latest                               14m 46s
      org.apache.cassandra.index.sasi.disk.OnDiskIndexTest testSparseMode
java17_separate_tests                            
java11_pre-commit_tests                         
java11_separate_tests                            
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4548/workflows/8c60f8ec-21c7-4680-adbb-60c7966f8395&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_pre-commit_tests&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4548/workflows/be9170aa-5445-43c6-a31a-c23542be0f6c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_separate_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17869516" author="smiklosovic" created="Tue, 30 Jul 2024 04:52:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-19779-5.0.0-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19779-5.0.0-2&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java17_pre-commit_tests                         
  &#10003; j17_build                                        3m 52s
  &#10003; j17_cqlsh_dtests_py311                            6m 9s
  &#10003; j17_cqlsh_dtests_py311_vnode                      6m 6s
  &#10003; j17_cqlsh_dtests_py38                            6m 25s
  &#10003; j17_cqlsh_dtests_py38_vnode                      6m 15s
  &#10003; j17_cqlshlib_cython_tests                         8m 4s
  &#10003; j17_cqlshlib_tests                               6m 21s
  &#10003; j17_dtests                                       33m 2s
  &#10003; j17_dtests_vnode                                 33m 4s
  &#10003; j17_jvm_dtests                                  23m 28s
  &#10003; j17_jvm_dtests_latest_vnode                     13m 50s
  &#10003; j17_unit_tests                                  13m 44s
  &#10003; j17_unit_tests_repeat                            2m 40s
  &#10003; j17_utests_latest                               14m 56s
  &#10003; j17_utests_latest_repeat                         2m 31s
  &#10003; j17_utests_oa                                   13m 56s
  &#10003; j17_utests_oa_repeat                             2m 19s
  &#10005; j17_dtests_latest                               32m 20s
      materialized_views_test.TestMaterializedViews test_resume_stopped_build
      read_failures_test.TestReadFailures test_tombstone_failure_v5                            
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4550/workflows/63182378-1426-4f8a-86f3-94bd10cfbf9d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_pre-commit_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17869579" author="smiklosovic" created="Tue, 30 Jul 2024 09:06:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-19779-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-19779-trunk&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java17_pre-commit_tests                         
  &#10003; j17_build                                         4m 2s
  &#10003; j17_cqlsh_dtests_py311                           6m 58s
  &#10003; j17_cqlsh_dtests_py311_vnode                     7m 13s
  &#10003; j17_cqlsh_dtests_py38                            6m 41s
  &#10003; j17_cqlsh_dtests_py38_vnode                      6m 58s
  &#10003; j17_cqlshlib_cython_tests                        7m 49s
  &#10003; j17_cqlshlib_tests                               6m 33s
  &#10003; j17_dtests                                      35m 10s
  &#10003; j17_dtests_latest                               36m 14s
  &#10003; j17_dtests_vnode                                 35m 9s
  &#10003; j17_unit_tests                                  13m 42s
  &#10003; j17_unit_tests_repeat                            3m 16s
  &#10003; j17_utests_latest                                14m 8s
  &#10003; j17_utests_latest_repeat                         2m 30s
  &#10003; j17_utests_oa                                   14m 15s
  &#10003; j17_utests_oa_repeat                             2m 31s
  &#10005; j17_jvm_dtests                                  25m 23s
      org.apache.cassandra.distributed.test.NativeTransportEncryptionOptionsTest testOptionalMtlsModeDoNotAllowNonSSLConnections
      org.apache.cassandra.distributed.test.NativeTransportEncryptionOptionsTest testEndpointVerificationEnabledIpNotInSAN
  &#10005; j17_jvm_dtests_latest_vnode                     25m 39s
      org.apache.cassandra.distributed.test.tcm.CMSPlacementAfterMoveTest testMoveToCMS                            
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/4554/workflows/588f442b-fb4d-4efd-9e48-4d16fb1c1da5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_pre-commit_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17869870" author="smiklosovic" created="Wed, 31 Jul 2024 10:56:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maxwellguo&quot; class=&quot;user-hover&quot; rel=&quot;maxwellguo&quot;&gt;maxwellguo&lt;/a&gt; anybody to review this as you are the reviewers of the &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18464&quot; title=&quot;Enable Direct I/O For CommitLog Files&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18464&quot;&gt;&lt;del&gt;CASSANDRA-18464&lt;/del&gt;&lt;/a&gt;? &lt;/p&gt;</comment>
                            <comment id="17869890" author="blambov" created="Wed, 31 Jul 2024 12:41:03 +0000"  >&lt;p&gt;Unsupported &lt;tt&gt;FileUtils.getBlockSize&lt;/tt&gt; means unsupported direct I/O as well, doesn&apos;t it? If not, I wonder if it makes sense to use a default block size of 4k instead of failing.&lt;/p&gt;</comment>
                            <comment id="17869894" author="smiklosovic" created="Wed, 31 Jul 2024 12:59:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; It doesnt fail, directIOSupported variable stays to be false. It throws only in case commitlog dir is null (which is understandable) or when we can not create a commit log directory if it does not exist (understandable too). In case we can not get block size, it will be caught and just warn logged and it will behave as it was before. &lt;/p&gt;</comment>
                            <comment id="17870121" author="maxwellguo" created="Thu, 1 Aug 2024 07:43:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; my pleasure . &lt;/p&gt;</comment>
                            <comment id="17870173" author="maxwellguo" created="Thu, 1 Aug 2024 11:07:36 +0000"  >
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
          &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; commitLogLocation = getCommitLogLocation();

            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (commitLogLocation == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ConfigurationException(&lt;span class=&quot;code-quote&quot;&gt;&quot;commitlog_directory must be specified&quot;&lt;/span&gt;, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);

            File commitLogLocationDir = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(commitLogLocation);
            PathUtils.createDirectoriesIfNotExists(commitLogLocationDir.toPath()); 
            directIOSupported = FileUtils.getBlockSize(commitLogLocationDir) &amp;gt; 0;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (IOError | ConfigurationException ex)
        {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I see &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/config/DatabaseDescriptor.java#L1930&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/config/DatabaseDescriptor.java#L1930&lt;/a&gt; just create commitlog and use the method is &quot;PathUtils.createDirectoriesIfNotExists&quot;. &lt;br/&gt;
1&#12289;That is to say you got create twice if file not exists. So I want to say we should logging the operation for create the dir .&lt;br/&gt;
2&#12289;I seem that I  have missed something in my last review, &lt;br/&gt;
In my mind, We should throw an exception if the user set the commitlog_disk_access_mode config to direct and directIOSupported set to false after the judgment below &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-quote&quot;&gt;&quot;FileUtils.getBlockSize(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; File(getCommitLogLocation())) &amp;gt; 0&quot;&lt;/span&gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We should throw this error just before the system starts, instead of waiting for the system to officially accept reading and writing. &lt;/p&gt;</comment>
                            <comment id="17870219" author="smiklosovic" created="Thu, 1 Aug 2024 15:23:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maxwellguo&quot; class=&quot;user-hover&quot; rel=&quot;maxwellguo&quot;&gt;maxwellguo&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;1) this is fine. I know about the existence of that. It does not matter it is at both places because the second creation of the same directory is no-op. We also can not just call the method which creates all directories in advance, because if we did that, at the time we would call DatabaseDescriptor.createAllDirectories(), this method would fail, because the values of the directories are not set yet. They are all resolved after applyConfig() is done. So the best solution is to just call this explicitly as I did and keep the rest untouched otherwise it gets messy pretty fast.&lt;/p&gt;

&lt;p&gt;2) We are changing the behavior here. If you want to change the behavior you need another ticket for that. This should not be part of this ticket.&lt;/p&gt;
</comment>
                            <comment id="17870320" author="maxwellguo" created="Fri, 2 Aug 2024 02:26:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;this is fine. I know about the existence of that. It does not matter it is at both places because the second creation of the same directory is no-op. We also can not just call the method which creates all directories in advance, because if we did that, at the time we would call DatabaseDescriptor.createAllDirectories(), this method would fail, because the values of the directories are not set yet. They are all resolved after applyConfig() is done. So the best solution is to just call this explicitly as I did and keep the rest untouched otherwise it gets messy pretty fast.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt; Thank you for your reply. I understand what you said and I agree with your current approach, and +1 on what you have done , I just think that we should add a line of log to explain why we created this commitlog directory here or left some comments on the code . &lt;/p&gt;

&lt;p&gt;I will create a ticket for part 2.&lt;/p&gt;</comment>
                            <comment id="17870441" author="smiklosovic" created="Fri, 2 Aug 2024 10:03:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; approved on the PR&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                            <outwardlinks description="causes">
                                        <issuelink>
            <issuekey id="13588323">CASSANDRA-19820</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13533105">CASSANDRA-18464</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="13163" cascade-level=""><![CDATA[Code]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12977"><![CDATA[Adhoc Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 14 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1qf2w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
        <customfieldvalue><![CDATA[maxwellguo]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12353513">5.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/5ab976d796471a1ecdf3596a148a3e4b8c1a982e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/5ab976d796471a1ecdf3596a148a3e4b8c1a982e&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;CI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>