<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8280] Cassandra crashing on inserting data over 64K into indexed strings</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8280</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;An attemtp to instert 65536 bytes in a field that is a primary index throws (correctly?) the cassandra.InvalidRequest exception. However, inserting the same data &lt;b&gt;in a indexed field that is not a primary index&lt;/b&gt; works just fine. &lt;/p&gt;

&lt;p&gt;However, Cassandra will crash on next commit and never recover. So I rated it as Critical as it can be used for DoS attacks.&lt;/p&gt;

&lt;p&gt;Reproduce: see the snippet below:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; uuid
from cassandra &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; ConsistencyLevel
from cassandra &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; InvalidRequest
from cassandra.cluster &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; Cluster
from cassandra.auth &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; PlainTextAuthProvider
from cassandra.policies &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; ConstantReconnectionPolicy
from cassandra.cqltypes &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; UUID
 
# DROP KEYSPACE IF EXISTS cs;
# CREATE KEYSPACE cs WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1};
# USE cs;
# CREATE TABLE test3 (name text, value uuid, sentinel text, PRIMARY KEY (name));
# CREATE INDEX test3_sentinels ON test3(sentinel);             
 
&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;CassandraDemo(object):
 
    def __init__(self):
        ips = [&lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;]
        ap = PlainTextAuthProvider(username=&lt;span class=&quot;code-quote&quot;&gt;&quot;cs&quot;&lt;/span&gt;, password=&lt;span class=&quot;code-quote&quot;&gt;&quot;cs&quot;&lt;/span&gt;)
        reconnection_policy = ConstantReconnectionPolicy(20.0, max_attempts=1000000)
        cluster = Cluster(ips, auth_provider=ap, protocol_version=3, reconnection_policy=reconnection_policy)
        self.session = cluster.connect(&lt;span class=&quot;code-quote&quot;&gt;&quot;cs&quot;&lt;/span&gt;)
 
    def exec_query(self, query, args):
        prepared_statement = self.session.prepare(query)
        prepared_statement.consistency_level = ConsistencyLevel.LOCAL_QUORUM
        self.session.execute(prepared_statement, args)
 
    def bug(self):
        k1 = UUID( str(uuid.uuid4()) )       
        long_string = &lt;span class=&quot;code-quote&quot;&gt;&quot;X&quot;&lt;/span&gt; * 65536
        query = &lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO test3 (name, value, sentinel) VALUES (?, ?, ?);&quot;&lt;/span&gt;
        args = (&lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;, k1, long_string)
 
        self.exec_query(query, args)
        self.session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;DROP KEYSPACE IF EXISTS cs_test&quot;&lt;/span&gt;, timeout=30)
        self.session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE KEYSPACE cs_test WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1}&quot;&lt;/span&gt;)
         
c = CassandraDemo()

#first run
c.bug()

#second run, Cassandra crashes with java.lang.AssertionError
c.bug()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And here is the cassandra log:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [MemtableFlushWriter:3] 2014-11-06 16:44:49,263 CassandraDaemon.java:153 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MemtableFlushWriter:3,5,main]
java.lang.AssertionError: 65536
        at org.apache.cassandra.utils.ByteBufferUtil.writeWithShortLength(ByteBufferUtil.java:290) ~[apache-cassandra-2.1.1.jar:2.1.1]
        at org.apache.cassandra.db.ColumnIndex$Builder.maybeWriteRowHeader(ColumnIndex.java:214) ~[apache-cassandra-2.1.1.jar:2.1.1]
        at org.apache.cassandra.db.ColumnIndex$Builder.add(ColumnIndex.java:201) ~[apache-cassandra-2.1.1.jar:2.1.1]
        at org.apache.cassandra.db.ColumnIndex$Builder.build(ColumnIndex.java:142) ~[apache-cassandra-2.1.1.jar:2.1.1]
        at org.apache.cassandra.io.sstable.SSTableWriter.rawAppend(SSTableWriter.java:233) ~[apache-cassandra-2.1.1.jar:2.1.1]
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:218) ~[apache-cassandra-2.1.1.jar:2.1.1]
        at org.apache.cassandra.db.Memtable$FlushRunnable.writeSortedContents(Memtable.java:354) ~[apache-cassandra-2.1.1.jar:2.1.1]
        at org.apache.cassandra.db.Memtable$FlushRunnable.runWith(Memtable.java:312) ~[apache-cassandra-2.1.1.jar:2.1.1]
        at org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48) ~[apache-cassandra-2.1.1.jar:2.1.1]
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[apache-cassandra-2.1.1.jar:2.1.1]
        at com.google.common.util.concurrent.MoreExecutors$SameThreadExecutorService.execute(MoreExecutors.java:297) ~[guava-16.0.jar:na]
        at org.apache.cassandra.db.ColumnFamilyStore$Flush.run(ColumnFamilyStore.java:1053) ~[apache-cassandra-2.1.1.jar:2.1.1]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_60]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) ~[na:1.7.0_60]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) ~[na:1.7.0_60]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Debian 7, Cassandra 2.1.1, java 1.7.0_60&lt;/p&gt;</environment>
        <key id="12754083">CASSANDRA-8280</key>
            <summary>Cassandra crashing on inserting data over 64K into indexed strings</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="crismar">Cristian Marinescu</reporter>
                        <labels>
                    </labels>
                <created>Mon, 10 Nov 2014 08:36:20 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:28 +0000</updated>
                            <resolved>Mon, 24 Nov 2014 12:20:55 +0000</resolved>
                                        <fixVersion>2.0.12</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="14204749" author="mshuler" created="Mon, 10 Nov 2014 13:14:50 +0000"  >&lt;p&gt;Thanks for the bug report - reproduced in 2.1.2 and current 2.1 branch HEAD.&lt;/p&gt;</comment>
                            <comment id="14204772" author="mshuler" created="Mon, 10 Nov 2014 13:36:41 +0000"  >&lt;p&gt;current ByteBufferUtil.java:290 was committed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6781&quot; title=&quot;ByteBuffer write() methods for serializing sstables&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6781&quot;&gt;&lt;del&gt;CASSANDRA-6781&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14206374" author="krummas" created="Tue, 11 Nov 2014 12:34:37 +0000"  >&lt;p&gt;assigning &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; as it seems to be a general 2i problem (and it exists in atleast 2.0)&lt;/p&gt;</comment>
                            <comment id="14214634" author="beobal" created="Mon, 17 Nov 2014 13:12:07 +0000"  >&lt;p&gt;There is already validation for this on the thrift path (from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3057&quot; title=&quot;secondary index on a column that has a value of size &amp;gt; 64k will fail on flush&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3057&quot;&gt;&lt;del&gt;CASSANDRA-3057&lt;/del&gt;&lt;/a&gt;), but it appears to have been overlooked for CQL. &lt;br/&gt;
Attaching separate patches for 2.0 &amp;amp; 2.1, mainly because CQLTester in 2.1 makes the unit test simpler but not easily mergeable.&lt;/p&gt;</comment>
                            <comment id="14220710" author="beobal" created="Fri, 21 Nov 2014 09:15:48 +0000"  >&lt;p&gt;My original patches didn&apos;t cover conditional updates, so I&apos;ve attached v2 of both. Also, because there&apos;s no easy way to execute conditional CQL in a unit test I&apos;ve written a dtest which is included in &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; pull request. The dtest kind of makes the unit test redundant, but it felt wrong to remove it so I&apos;ve left it in the patches.&lt;/p&gt;

&lt;p&gt;I should also note that in cases where the indexed column is a clustering component or partition key, we would already reject update with these oversized values. In 2.0 though, this results in an ServerError rather than an InvalidRequest so I&apos;ve added a little more validation to return a nicer error response.&lt;/p&gt;</comment>
                            <comment id="14220948" author="iamaleksey" created="Fri, 21 Nov 2014 14:14:36 +0000"  >&lt;p&gt;LGTM, with one last 2.0 nit - can you put the builder total size calculation logic into a method in ColumnNameBuilder?&lt;/p&gt;

&lt;p&gt;That, and you should include the extra 3 bytes per component in the calculation (2 for size, one for EOC).&lt;/p&gt;</comment>
                            <comment id="14221196" author="beobal" created="Fri, 21 Nov 2014 18:22:16 +0000"  >&lt;p&gt;ah yes, I&apos;d overlooked the length + EOC markers. v3 for 2.0 attached&lt;/p&gt;</comment>
                            <comment id="14221294" author="iamaleksey" created="Fri, 21 Nov 2014 19:18:24 +0000"  >&lt;p&gt;Looks to me like you don&apos;t need the partition key length check in ModificationStatement - the subsequent call to ThriftValidation.validateKey(cfm, key) will validate the length.&lt;/p&gt;

&lt;p&gt;Also, should override addUpdateForKey() in DeleteStatement, too.&lt;/p&gt;</comment>
                            <comment id="14221987" author="beobal" created="Sat, 22 Nov 2014 15:12:25 +0000"  >&lt;p&gt;Unfortunately, that check is required as CompositeType.Builder.build() uses ByteBufferUtil.writeWithShortLength so we never reach ThriftValidation.validateKey(cfm, key)&lt;/p&gt;</comment>
                            <comment id="14222084" author="iamaleksey" created="Sat, 22 Nov 2014 17:45:20 +0000"  >&lt;p&gt;Let me clarify. I meant we should do `keyBuilder.copy().add(val)` unconditionally, but only call the final `build()` (that used `ByteBufferUtil.writeWithShortLength()` if getLength() validates.&lt;/p&gt;

&lt;p&gt;And if we put our check there, then we no longer need the `ThriftValidation.validateKey()` call at all. And the subsequent call to `ThriftValidation.validateKey()` in `ModificationStatement#getMutations()`, either.&lt;/p&gt;</comment>
                            <comment id="14222138" author="beobal" created="Sat, 22 Nov 2014 19:43:31 +0000"  >&lt;p&gt;Well, ThriftValidation.validateKey() does more than simply check the length, so I think we&apos;d still need it. Also, we do potentially less work the way it is now because we only iterate over the builder components (in getLength()) once, rather than once per value.  &lt;/p&gt;</comment>
                            <comment id="14222191" author="iamaleksey" created="Sat, 22 Nov 2014 21:43:08 +0000"  >&lt;p&gt;Fair enough re: TV.validateKey() doing more than that (although the second call, in MS#getMutations(), is still redundant, but that&apos;s not an issue introduced by this patch).&lt;/p&gt;

&lt;p&gt;In that case you&apos;d need logic more complex than `baseSize + val.remaining()`, to account for extra 3 bytes, conditionally, for partition keys. I&apos;d rather we did some extra iteration (which in this case happens rarely and doesn&apos;t cost much, vs. extra complexity).&lt;/p&gt;

&lt;p&gt;Anyway, sorry, this is me extremely nit-picking for lack of things to do on Saturday. Feel free to ignore the minor things.&lt;/p&gt;</comment>
                            <comment id="14222861" author="beobal" created="Mon, 24 Nov 2014 10:29:53 +0000"  >&lt;p&gt;v4 of the 2.0 patch, which fixes the length check in MS.buildPartitionKeyNames &amp;amp; removes the redundant call to ThriftValidation.validateKey in MS.getMutations()&lt;/p&gt;</comment>
                            <comment id="14222937" author="iamaleksey" created="Mon, 24 Nov 2014 12:20:55 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12746668">CASSANDRA-8081</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12697698">CASSANDRA-6781</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12682844" name="8280-2.0-v2.txt" size="12850" author="samt" created="Fri, 21 Nov 2014 09:16:09 +0000"/>
                            <attachment id="12682925" name="8280-2.0-v3.txt" size="14590" author="samt" created="Fri, 21 Nov 2014 18:22:16 +0000"/>
                            <attachment id="12683307" name="8280-2.0-v4.txt" size="16117" author="samt" created="Mon, 24 Nov 2014 10:29:53 +0000"/>
                            <attachment id="12681907" name="8280-2.0.txt" size="10027" author="samt" created="Mon, 17 Nov 2014 15:01:22 +0000"/>
                            <attachment id="12682843" name="8280-2.1-v2.txt" size="7762" author="samt" created="Fri, 21 Nov 2014 09:16:09 +0000"/>
                            <attachment id="12681908" name="8280-2.1.txt" size="6994" author="samt" created="Mon, 17 Nov 2014 15:01:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2266n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327942">2.0.11</customfieldvalue>
    <customfieldvalue id="12326774">2.1.1</customfieldvalue>
    <customfieldvalue id="12328841">2.1.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>