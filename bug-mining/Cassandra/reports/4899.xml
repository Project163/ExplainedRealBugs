<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:09:41 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13043] UnavailabeException caused by counter writes forwarded to leaders without complete cluster view</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13043</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In version 3.9 of Cassandra, we get the following exceptions on the system.log whenever booting an agent. They seem to grow in number with each reboot. Any idea where they come from or what can we do about them? Note that the cluster is healthy (has sufficient live nodes).&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2/14/2016 12:39:47 PMINFO  10:39:47 Updating topology for /10.136.64.120
12/14/2016 12:39:47 PMINFO  10:39:47 Updating topology for /10.136.64.120
12/14/2016 12:39:47 PMWARN  10:39:47 Uncaught exception on thread Thread[CounterMutationStage-111,5,main]: {}
12/14/2016 12:39:47 PMorg.apache.cassandra.exceptions.UnavailableException: Cannot achieve consistency level LOCAL_QUORUM
12/14/2016 12:39:47 PM	at org.apache.cassandra.db.ConsistencyLevel.assureSufficientLiveNodes(ConsistencyLevel.java:313) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.service.AbstractWriteResponseHandler.assureSufficientLiveNodes(AbstractWriteResponseHandler.java:146) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.service.StorageProxy.performWrite(StorageProxy.java:1054) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.service.StorageProxy.applyCounterMutationOnLeader(StorageProxy.java:1450) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.db.CounterMutationVerbHandler.doVerb(CounterMutationVerbHandler.java:48) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:64) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_111]
12/14/2016 12:39:47 PM	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) [apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:109) [apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at java.lang.Thread.run(Thread.java:745) [na:1.8.0_111]
12/14/2016 12:39:47 PMWARN  10:39:47 Uncaught exception on thread Thread[CounterMutationStage-118,5,main]: {}
12/14/2016 12:39:47 PMorg.apache.cassandra.exceptions.UnavailableException: Cannot achieve consistency level LOCAL_QUORUM
12/14/2016 12:39:47 PM	at org.apache.cassandra.db.ConsistencyLevel.assureSufficientLiveNodes(ConsistencyLevel.java:313) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.service.AbstractWriteResponseHandler.assureSufficientLiveNodes(AbstractWriteResponseHandler.java:146) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.service.StorageProxy.performWrite(StorageProxy.java:1054) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.service.StorageProxy.applyCounterMutationOnLeader(StorageProxy.java:1450) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.db.CounterMutationVerbHandler.doVerb(CounterMutationVerbHandler.java:48) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:64) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_111]
12/14/2016 12:39:47 PM	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) [apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:109) [apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at java.lang.Thread.run(Thread.java:745) [na:1.8.0_111]
12/14/2016 12:39:47 PMWARN  10:39:47 Uncaught exception on thread Thread[CounterMutationStage-164,5,main]: {}
12/14/2016 12:39:47 PMorg.apache.cassandra.exceptions.UnavailableException: Cannot achieve consistency level LOCAL_QUORUM
12/14/2016 12:39:47 PM	at org.apache.cassandra.db.ConsistencyLevel.assureSufficientLiveNodes(ConsistencyLevel.java:313) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.service.AbstractWriteResponseHandler.assureSufficientLiveNodes(AbstractWriteResponseHandler.java:146) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.service.StorageProxy.performWrite(StorageProxy.java:1054) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.service.StorageProxy.applyCounterMutationOnLeader(StorageProxy.java:1450) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.db.CounterMutationVerbHandler.doVerb(CounterMutationVerbHandler.java:48) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:64) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_111]
12/14/2016 12:39:47 PM	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) [apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:109) [apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at java.lang.Thread.run(Thread.java:745) [na:1.8.0_111]
12/14/2016 12:39:47 PMWARN  10:39:47 Uncaught exception on thread Thread[CounterMutationStage-117,5,main]: {}
12/14/2016 12:39:47 PMorg.apache.cassandra.exceptions.UnavailableException: Cannot achieve consistency level LOCAL_QUORUM
12/14/2016 12:39:47 PM	at org.apache.cassandra.db.ConsistencyLevel.assureSufficientLiveNodes(ConsistencyLevel.java:313) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.service.AbstractWriteResponseHandler.assureSufficientLiveNodes(AbstractWriteResponseHandler.java:146) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.service.StorageProxy.performWrite(StorageProxy.java:1054) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.service.StorageProxy.applyCounterMutationOnLeader(StorageProxy.java:1450) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.db.CounterMutationVerbHandler.doVerb(CounterMutationVerbHandler.java:48) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:64) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_111]
12/14/2016 12:39:47 PM	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) ~[apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) [apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:109) [apache-cassandra-3.9.jar:3.9]
12/14/2016 12:39:47 PM	at java.lang.Thread.run(Thread.java:745) [na:1.8.0_111]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Debian&lt;/p&gt;</environment>
        <key id="13028063">CASSANDRA-13043</key>
            <summary>UnavailabeException caused by counter writes forwarded to leaders without complete cluster view</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ostefano">Stefano Ortolani</assignee>
                                    <reporter username="Antauri">Catalin Alexandru Zamfir</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Dec 2016 10:43:37 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:13 +0000</updated>
                            <resolved>Wed, 20 Sep 2017 19:29:11 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                                    <component>Legacy/Coordination</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16036707" author="ostefano" created="Mon, 5 Jun 2017 09:21:28 +0000"  >&lt;p&gt;Hi, I can confirm I have the same on C* 3.0.13.&lt;br/&gt;
As far as I understand it is connected to a substantial number of counter mutations in the commit log, and C* attempt to apply those mutations before all nodes are flagged as alive.&lt;/p&gt;

&lt;p&gt;Note that I am having this after restarting the node via &lt;tt&gt;nodetool drain&lt;/tt&gt;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [HANDSHAKE-/10.12.33.4] 2017-06-02 22:43:53,908 OutboundTcpConnection.java:537 - Handshaking version with /10.12.33.4
INFO  [GossipStage:1] 2017-06-02 22:43:54,345 StorageService.java:1991 - Node /10.12.33.8 state jump to NORMAL
WARN  [SharedPool-Worker-129] 2017-06-02 22:43:54,366 AbstractLocalAwareExecutorService.java:169 - Uncaught exception on thread Thread[SharedPool-Worker-129,5,main]: {}
org.apache.cassandra.exceptions.UnavailableException: Cannot achieve consistency level QUORUM
	at org.apache.cassandra.db.ConsistencyLevel.assureSufficientLiveNodes(ConsistencyLevel.java:334) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.service.AbstractWriteResponseHandler.assureSufficientLiveNodes(AbstractWriteResponseHandler.java:146) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.service.StorageProxy.performWrite(StorageProxy.java:1051) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.service.StorageProxy.applyCounterMutationOnLeader(StorageProxy.java:1447) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.CounterMutationVerbHandler.doVerb(CounterMutationVerbHandler.java:48) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:67) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_91]
	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) [apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [apache-cassandra-3.0.13.jar:3.0.13]
	at java.lang.Thread.run(Thread.java:745) [na:1.8.0_91]
WARN  [SharedPool-Worker-132] 2017-06-02 22:43:54,366 AbstractLocalAwareExecutorService.java:169 - Uncaught exception on thread Thread[SharedPool-Worker-132,5,main]: {}
org.apache.cassandra.exceptions.UnavailableException: Cannot achieve consistency level QUORUM
	at org.apache.cassandra.db.ConsistencyLevel.assureSufficientLiveNodes(ConsistencyLevel.java:334) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.service.AbstractWriteResponseHandler.assureSufficientLiveNodes(AbstractWriteResponseHandler.java:146) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.service.StorageProxy.performWrite(StorageProxy.java:1051) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.service.StorageProxy.applyCounterMutationOnLeader(StorageProxy.java:1447) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.db.CounterMutationVerbHandler.doVerb(CounterMutationVerbHandler.java:48) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:67) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_91]
	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:164) ~[apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:136) [apache-cassandra-3.0.13.jar:3.0.13]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [apache-cassandra-3.0.13.jar:3.0.13]
	at java.lang.Thread.run(Thread.java:745) [na:1.8.0_91]
WARN  [SharedPool-Worker-130] 2017-06-02 22:43:54,367 AbstractLocalAwareExecutorService.java:169 - Uncaught exception on thread Thread[SharedPool-Worker-130,5,main]: {}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16036783" author="ostefano" created="Mon, 5 Jun 2017 10:28:15 +0000"  >&lt;p&gt;Maybe a dev should rename the title as it&apos;s quite misleading right now :S&lt;/p&gt;</comment>
                            <comment id="16048886" author="ostefano" created="Wed, 14 Jun 2017 08:52:20 +0000"  >&lt;p&gt;Update: turned out the commitlog was a false flag. On all other nodes where I found this issue I had no replayed mutations.&lt;br/&gt;
The missed QUORUMs were client requests being served before the node had full visibility over the cluster. &lt;/p&gt;

&lt;p&gt;However, there two things that are weird:&lt;/p&gt;

&lt;p&gt;1) It&apos;s always about a counter mutation (and the distribution of queries is heavily skewed in favour of non-counter queries).&lt;br/&gt;
2) The exception happens while the node is updating the topology and before the gossip settles (which is weird since I thought client requests were not allowed until then.&lt;br/&gt;
3) Every single time I see that error at node restart, a client fails with the following message:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR - Unexpected exception (Error from server: code=1500 [Replica(s) failed to execute write] message=&quot;Operation failed - received 0 responses and 1 failures&quot; info={&apos;failures&apos;: 1, &apos;received_responses&apos;: 0, &apos;required_responses&apos;: 1, &apos;consistency&apos;: &apos;ONE&apos;})
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16062950" author="ostefano" created="Mon, 26 Jun 2017 11:22:59 +0000"  >&lt;p&gt;Based on my analysis the request is coming from another node (and not from a client), apparently the coordinator. I don&apos;t understand why the replica node (the node where this exception is triggered) is checking for Consistency Level though, but I guess it might be a corner case of how counters are handled. &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;, I have been told you might have some more insights here re how counters are handled?&lt;/p&gt;

&lt;p&gt;I guess an easy solution would be to delay requests from other nodes.&lt;br/&gt;
Would that make sense/being feasible?&lt;/p&gt;</comment>
                            <comment id="16063205" author="iamaleksey" created="Mon, 26 Jun 2017 14:57:55 +0000"  >&lt;p&gt;I&apos;ll try to help out if you poke me again after July 10th; currently on vacation, sorry.&lt;/p&gt;</comment>
                            <comment id="16087188" author="ostefano" created="Fri, 14 Jul 2017 11:11:59 +0000"  >&lt;p&gt;Seems like the more connections the worse it is (which would make sense). Last node restart produced &amp;gt; 30 Exceptions, which in turn cause 20 independent queries at QUORUM level to fail :/&lt;/p&gt;</comment>
                            <comment id="16092977" author="ostefano" created="Wed, 19 Jul 2017 12:11:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; did you manage to give it a look by any chance?&lt;/p&gt;</comment>
                            <comment id="16098619" author="iamaleksey" created="Mon, 24 Jul 2017 16:05:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ostefano&quot; class=&quot;user-hover&quot; rel=&quot;ostefano&quot;&gt;ostefano&lt;/a&gt; Will try to find the time this week. Regarding commit log, you were correct - it was a red herring. Since 2.1, commitlog only stores the result of the counter update, and replay is strictly local, unaffected by the state of the rest of the cluster.&lt;/p&gt;</comment>
                            <comment id="16099896" author="ostefano" created="Tue, 25 Jul 2017 11:33:55 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;. If need be, I can assist in testing patches.&lt;/p&gt;</comment>
                            <comment id="16118625" author="iamaleksey" created="Tue, 8 Aug 2017 16:51:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;I don&apos;t understand why the replica node (the node where this exception is triggered) is checking for Consistency Level though, but I guess it might be a corner case of how counters are handled.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The coordinator for the counter write - the initial point of contact - will pick the leader first, the node will end up owning the write. The leader would perform the blocking read before write, then propagate the applied change to the rest of the replica set.&lt;/p&gt;

&lt;p&gt;Even if the coordinator is a replica itself, it might still elect another one as a leader - to balance the load.&lt;/p&gt;

&lt;p&gt;Picking the leader is pretty simplistic. We pick a random node in the local DC, if any. If none, we just go and pick the closest replica to the coordinator, as measured by the snitch.&lt;/p&gt;

&lt;p&gt;As for checking for consistency level, we do it twice. Once on the coordinator, to allow a faster response if we know in advance that we cannot fulfil the CL, and then again on the leader itself, as part of &lt;tt&gt;StorageProxy.performWrite()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;So, yes,&lt;br/&gt;
1) Availability check happens on the leader, but also on the coordinator, before that.&lt;br/&gt;
2) The leader is getting the requests forwarded from the coordinator, not the client, explaining why despite the node not yet listening for native protocol clients can still trigger the UE.&lt;/p&gt;
</comment>
                            <comment id="16118638" author="iamaleksey" created="Tue, 8 Aug 2017 17:02:45 +0000"  >&lt;p&gt;There also seems to be a potential edge-case bug with local consistency levels and leader picking, but overall this is some very old code that probably needs another look (&lt;tt&gt;StoraProxy&lt;/tt&gt; counters related methods). &lt;/p&gt;</comment>
                            <comment id="16118667" author="iamaleksey" created="Tue, 8 Aug 2017 17:18:55 +0000"  >&lt;p&gt;I&apos;ll happily review a patch if you fix counter leader election, but will unlikely fix it myself soon, sorry.&lt;/p&gt;</comment>
                            <comment id="16125561" author="ostefano" created="Mon, 14 Aug 2017 11:30:32 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;, thx for the explanation! Sure I will give it a go. I might need some assistance/have questions though. Can I bother you in IRC if I get stuck?&lt;/p&gt;</comment>
                            <comment id="16125679" author="iamaleksey" created="Mon, 14 Aug 2017 13:28:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can I bother you in IRC if I get stuck?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sure.&lt;/p&gt;</comment>
                            <comment id="16141592" author="ostefano" created="Fri, 25 Aug 2017 13:16:14 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;, I am having some difficulties reproducing it.&lt;/p&gt;

&lt;p&gt;I am bootstrapping 3 nodes via cassandra-dtest, and updating the same counter 30000 times in three different phases.&lt;br/&gt;
During each phase I pick a node, stop it, and start it without waiting (&lt;tt&gt;no_wait=True, wait_other_notice=False&lt;/tt&gt;).&lt;br/&gt;
This while I keep inserting. Unfortunately no luck.&lt;/p&gt;

&lt;p&gt;I have also been trying byteman as well, with the idea of slowing down how quickly the starting node becomes aware of the topology.&lt;br/&gt;
Unfortunately it seems I am either able to start the node without waiting, or submit a rule with byteman.&lt;br/&gt;
If I don&apos;t want wait for the node to start, the rule submission fails; while if I wait, the rule doesn&apos;t trigger because the node is already up and running.&lt;/p&gt;

&lt;p&gt;Any suggestion how to proceed?&lt;/p&gt;</comment>
                            <comment id="16149262" author="ostefano" created="Thu, 31 Aug 2017 17:01:49 +0000"  >&lt;p&gt;Some updates: added to ccm the ability to send a byteman rule when restarting a node (&lt;a href=&quot;https://github.com/ostefano/ccm/tree/startup_byteman&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ostefano/ccm/tree/startup_byteman&lt;/a&gt;). Originally it was only possible to submit a rule &lt;em&gt;after&lt;/em&gt; the node started, which made reproducing this race quite impossible.&lt;/p&gt;

&lt;p&gt;With that I could finally reproduce the bug. Here you can my branch with a new DTEST exercising the bug: &lt;a href=&quot;https://github.com/ostefano/cassandra-dtest/tree/CASSANDRA-13043&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ostefano/cassandra-dtest/tree/CASSANDRA-13043&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Attached you can find a patch fixing the bug by removing nodes that are not RPC ready from a leader election. Also, I fixed the corner case where the CL required is local and the current DC does not have available nodes.&lt;/p&gt;

&lt;p&gt;Here you can find the commit: &lt;a href=&quot;https://github.com/ostefano/cassandra/commit/91cc9b4398009a3cee3004bc11a047c056fda6a6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ostefano/cassandra/commit/91cc9b4398009a3cee3004bc11a047c056fda6a6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;update: unit tests are passing&lt;/p&gt;</comment>
                            <comment id="16167885" author="iamaleksey" created="Fri, 15 Sep 2017 13:49:41 +0000"  >&lt;p&gt;This should be correct as is, but I have one nit and one minor issue with it.&lt;/p&gt;

&lt;p&gt;Nit: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;endpoints.removeIf((InetAddress endpoint) -&amp;gt; !StorageService.instance.isRpcReady(endpoint));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;would be written more commonly in C* as&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;endpoints.removeIf(endpoint -&amp;gt; !StorageService.instance.isRpcReady(endpoint));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Issue: you are modifying in-place a collection returned from a method, that you didn&apos;t create and pass yourself. This works now, but could end up badly some day if we changed &lt;tt&gt;StorageService.getLiveNaturalEndpoints()&lt;/tt&gt; to return a mutable view, for example. I would either create a copy, or, better yet, create and overload of &lt;tt&gt;getLiveNaturalEndpoints()&lt;/tt&gt; that takes a collection to use as an argument, then mutate that.&lt;/p&gt;</comment>
                            <comment id="16167923" author="ostefano" created="Fri, 15 Sep 2017 14:18:03 +0000"  >&lt;p&gt;Thanks a lot for the feedback!&lt;/p&gt;

&lt;p&gt;I am submitting a new patch &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12887351/12887351_13043-3.0.patch&quot; title=&quot;13043-3.0.patch attached to CASSANDRA-13043&quot;&gt;13043-3.0.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16167939" author="iamaleksey" created="Fri, 15 Sep 2017 14:28:27 +0000"  >&lt;p&gt;Should probably use the new method inside &lt;tt&gt;StorageService.getLiveNaturalEndpoints(Keyspace keyspace, RingPosition pos)&lt;/tt&gt; so that you don&apos;t duplicate the logic.&lt;/p&gt;</comment>
                            <comment id="16167997" author="ostefano" created="Fri, 15 Sep 2017 15:10:28 +0000"  >&lt;p&gt;Fixed. Below the three branches with the patch applied:&lt;/p&gt;

&lt;p&gt;3.0: &lt;a href=&quot;https://github.com/ostefano/cassandra/tree/13043-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ostefano/cassandra/tree/13043-3.0&lt;/a&gt;&lt;br/&gt;
3.11: &lt;a href=&quot;https://github.com/ostefano/cassandra/tree/13043-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ostefano/cassandra/tree/13043-3.11&lt;/a&gt;&lt;br/&gt;
4.0: &lt;a href=&quot;https://github.com/ostefano/cassandra/tree/13043-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/ostefano/cassandra/tree/13043-4.0&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16168006" author="iamaleksey" created="Fri, 15 Sep 2017 15:13:50 +0000"  >&lt;p&gt;Thanks. Queued up dtests runs on Jenkins.&lt;/p&gt;</comment>
                            <comment id="16173722" author="iamaleksey" created="Wed, 20 Sep 2017 19:28:51 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/36bdc253193318ceaf5beb9bc5e869f6af590cb1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;36bdc253193318ceaf5beb9bc5e869f6af590cb1&lt;/a&gt; to 3.0 and merged up with 3.11 and trunk.&lt;/p&gt;

&lt;p&gt;The dtest no longer applies cleanly. Care to rebase so I can commit? Thanks.&lt;/p&gt;</comment>
                            <comment id="16173739" author="ostefano" created="Wed, 20 Sep 2017 19:46:13 +0000"  >&lt;p&gt;Weird, riptano&apos;s last commit on master is from Jul 13th, the commit should apply cleanly.&lt;br/&gt;
Maybe I am missing something?&lt;/p&gt;</comment>
                            <comment id="16173760" author="iamaleksey" created="Wed, 20 Sep 2017 20:10:26 +0000"  >&lt;p&gt;The last commit to apache/cassandra-dtest is from 2 days ago. It&apos;s where the dtests live now.&lt;/p&gt;</comment>
                            <comment id="16173769" author="ostefano" created="Wed, 20 Sep 2017 20:19:02 +0000"  >&lt;p&gt;That explains &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; done&lt;/p&gt;</comment>
                            <comment id="16174601" author="iamaleksey" created="Thu, 21 Sep 2017 11:30:31 +0000"  >&lt;p&gt;Committed the dtest as &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/db1d058af51eafa36151a9eb818f5196bc632767&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;db1d058af51eafa36151a9eb818f5196bc632767&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Having already committed the patch, I do have one concern. A node only advertises that it&apos;s rpc-ready if native protocol is enabled. Which won&apos;t always be true:&lt;/p&gt;

&lt;p&gt;1. You might have a thrift-only user&lt;br/&gt;
2. You may have a setup with dedicated coordinator nodes, in which storage nodes don&apos;t even bother listening to clients, and have that disabled&lt;/p&gt;

&lt;p&gt;Admittedly both of those are rare, but I&apos;m worried that using &lt;tt&gt;RPC_READY&lt;/tt&gt; as a proxy for &apos;has some view of the cluster&apos; might break things for some niche use cases. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;, what would you do?&lt;/p&gt;</comment>
                            <comment id="16174690" author="slebresne" created="Thu, 21 Sep 2017 12:53:01 +0000"  >&lt;p&gt;To me, it sounds like the problem we have is that we move endpoints from &apos;pending&apos; to &apos;natural&apos; endpoints too quickly after bootstrap, before the node is actually fully ready, and that this is what we should be fixing (basically, &lt;tt&gt;getLiveNaturalEndpoints&lt;/tt&gt; shouldn&apos;t return node that are note truly ready, and not knowing the ring yet is not ready to me). Maybe counters are the only case where this is a problem today, but hand-fixing it only there feels like we&apos;ll run into other problems like that in the future. That being said, the whole boostrap/gossip-settling code is not the part I&apos;, the most confortable with so I don&apos;t know how easy fixing that is (or if it&apos;s even possible/reasonable to do in 3.x).&lt;/p&gt;

&lt;p&gt;Other than that, I agree with you concern. If we want to stick with the current approach at least as far 3.x goes for simplicity, then maybe we can simply advertise rpc-ready at the end of &lt;tt&gt;CassandraDaemon.start&lt;/tt&gt; but in all case? In fact, I&apos;m not sure why we only set it for the native protocol, and that might simply be an oversight. At the very least, thrift is literally referred to &quot;rpc&quot; in the yaml, so not setting &lt;tt&gt;RPC_READY&lt;/tt&gt; for it feels wrong. And going a step further, if you have explicitly asked to not start any of the client server, then it wouldn&apos;t be a lie to set &lt;tt&gt;RPC_READY&lt;/tt&gt; at the end of &lt;tt&gt;start()&lt;/tt&gt; in the sense of &quot;every RPC servers you asked us to start is ready&quot;. Anyway, maybe someone rely on this being only set for the native protocol, I genuinely have no clue.&lt;/p&gt;</comment>
                            <comment id="16174886" author="iamaleksey" created="Thu, 21 Sep 2017 14:58:36 +0000"  >&lt;p&gt;Agreed on both accounts. And unfortunately I&apos;m just as uncomfortable with bootstrap/gossip myself to make a change there.&lt;/p&gt;

&lt;p&gt;Will file a JIRA to start advertising &lt;tt&gt;RPC_READY&lt;/tt&gt; for Thrift, at least, and unconditionally, potentially.&lt;/p&gt;

&lt;p&gt;Thanks for your feedback.&lt;/p&gt;</comment>
                            <comment id="16183235" author="iamaleksey" created="Wed, 27 Sep 2017 20:43:46 +0000"  >&lt;p&gt;Filed &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13914&quot; title=&quot;Advertise RPC_READY for both native protocol and Thrift&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13914&quot;&gt;CASSANDRA-13914&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16477739" author="githubbot" created="Wed, 16 May 2018 17:05:48 +0000"  >&lt;p&gt;Github user aweisberg commented on a diff in the pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/224#discussion_r188452737&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/224#discussion_r188452737&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &amp;#8212; Diff: src/java/org/apache/cassandra/service/StorageProxy.java &amp;#8212;&lt;br/&gt;
    @@ -1526,38 +1529,37 @@ protected Verb verb()&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;is unclear we want to mix those latencies with read latencies, so this&lt;/li&gt;
	&lt;li&gt;may be a bit involved.&lt;br/&gt;
          */&lt;/li&gt;
&lt;/ul&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;private static InetAddressAndPort findSuitableEndpoint(String keyspaceName, DecoratedKey key, String localDataCenter, ConsistencyLevel cl) throws UnavailableException&lt;br/&gt;
    +    private static Replica findSuitableReplica(String keyspaceName, DecoratedKey key, String localDataCenter, ConsistencyLevel cl) throws UnavailableException&lt;br/&gt;
         {&lt;br/&gt;
             Keyspace keyspace = Keyspace.open(keyspaceName);&lt;br/&gt;
             IEndpointSnitch snitch = DatabaseDescriptor.getEndpointSnitch();&lt;/li&gt;
	&lt;li&gt;List&amp;lt;InetAddressAndPort&amp;gt; endpoints = new ArrayList&amp;lt;&amp;gt;();&lt;/li&gt;
	&lt;li&gt;StorageService.instance.getLiveNaturalEndpoints(keyspace, key, endpoints);&lt;br/&gt;
    +        ReplicaList replicas = StorageService.instance.getLiveNaturalReplicas(keyspace, key);&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;             // &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13043&quot; title=&quot;UnavailabeException caused by counter writes forwarded to leaders without complete cluster view&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13043&quot;&gt;&lt;del&gt;CASSANDRA-13043&lt;/del&gt;&lt;/a&gt;: filter out those endpoints not accepting clients yet, maybe because still bootstrapping&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;endpoints.removeIf(endpoint -&amp;gt; !StorageService.instance.isRpcReady(endpoint));&lt;br/&gt;
    +        replicas = replicas.filter(replica -&amp;gt; StorageService.instance.isRpcReady(replica.getEndpoint()));
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;
		&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
			&lt;li&gt;End diff &amp;#8211;&lt;/li&gt;
		&lt;/ul&gt;
		&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;    if isRpcReady were static you could avoid allocating the lambda.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13118687">CASSANDRA-14028</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13105562">CASSANDRA-13914</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12887351" name="13043-3.0.patch" size="4114" author="ostefano" created="Fri, 15 Sep 2017 14:18:53 +0000"/>
                            <attachment id="12885144" name="patch.diff" size="1904" author="ostefano" created="Sun, 3 Sep 2017 15:53:36 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ostefano]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i37l4f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12340362">3.0.14</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>