<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:18:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2072] Race condition during decommission</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2072</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Occasionally when decommissioning a node, there is a race condition that occurs where another node will never remove the token and thus propagate it again with a state of down.  With &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1900&quot; title=&quot;Make removetoken force always work&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1900&quot;&gt;&lt;del&gt;CASSANDRA-1900&lt;/del&gt;&lt;/a&gt; we can solve this, but it shouldn&apos;t occur in the first place.&lt;/p&gt;

&lt;p&gt;Given nodes A, B, and C, if you decommission B it will stream to A and C.  When complete, B will decommission and receive this stacktrace:&lt;/p&gt;

&lt;p&gt;ERROR 00:02:40,282 Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-5,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.util.concurrent.RejectedExecutionException: ThreadPoolExecutor has shut down&lt;br/&gt;
        at org.apache.cassandra.concurrent.DebuggableThreadPoolExecutor$1.rejectedExecution(DebuggableThreadPoolExecutor.java:62)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:767)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:658)&lt;br/&gt;
        at org.apache.cassandra.net.MessagingService.receive(MessagingService.java:387)&lt;br/&gt;
        at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:91&lt;/p&gt;

&lt;p&gt;At this point A will show it is removing B&apos;s token, but C will not and instead its failure detector will report that B is dead, and nodetool ring on C shows B in a leaving/down state.  In another gossip round, C will propagate this state back to A.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12497003">CASSANDRA-2072</key>
            <summary>Race condition during decommission</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Fri, 28 Jan 2011 00:06:20 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:08 +0000</updated>
                            <resolved>Thu, 3 Feb 2011 20:17:22 +0000</resolved>
                                        <fixVersion>0.7.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12988218" author="brandon.williams" created="Fri, 28 Jan 2011 20:28:54 +0000"  >&lt;p&gt;Here is what is happening:&lt;/p&gt;

&lt;p&gt;B sends LEFT to C, C calls removeEndpoint and drops the endpoint state.  B never gets to send to A (because it only waits 2s to announce, which can be just one round) and A still thinks it&apos;s LEAVING.  C sees B in a gossip digest from A, and  not knowing anything about it, calls requestAll, but A refuses to tell C anything about it because A has B in justRemovedEndpoints.  Eventually, QUARANTINE_DELAY expires and A unhelpfully propagates the LEAVING state back to C.&lt;/p&gt;

&lt;p&gt;The obvious solution here is that B should announce LEFT for RING_DELAY, simply because it&apos;s the right thing to do as opposed to a one-off delay of 2 seconds.&lt;/p&gt;

&lt;p&gt;However, this exposes a more subtle problem.  When removeEndpoint is called, we drop the state right away and track the endpoint in justRemovedEndpoints.  Instead, we should hold on to the state so it is still propagated in further gossip digests, and expire it when we expire justRemovedEndpoints.&lt;/p&gt;

&lt;p&gt;Either of these changes is technically enough to solve this issue, but both together add an extra safeguard.  Changing where we expire the endpoint state is the more impacting of the two, however the gossip generation and version checks always prevent any negative consequences from doing this.&lt;/p&gt;</comment>
                            <comment id="12990212" author="gdusbabek" created="Thu, 3 Feb 2011 18:15:17 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12990279" author="brandon.williams" created="Thu, 3 Feb 2011 20:17:22 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="12990297" author="hudson" created="Thu, 3 Feb 2011 20:47:49 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #244 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/244/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/244/&lt;/a&gt;)&lt;br/&gt;
    Fix race condition during decommission by announcing for RING_DELAY and&lt;br/&gt;
not removing endpoint state until removing the ep from&lt;br/&gt;
justRemovedEndpoints.&lt;br/&gt;
Patch by brandonwilliams, reviewed by gdusbabek for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2072&quot; title=&quot;Race condition during decommission&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2072&quot;&gt;&lt;del&gt;CASSANDRA-2072&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12469696" name="0001-announce-having-left-the-ring-for-RING_DELAY-on-deco.patch" size="1184" author="brandon.williams" created="Fri, 28 Jan 2011 20:28:54 +0000"/>
                            <attachment id="12469697" name="0002-Improve-TRACE-logging-for-Gossiper.patch" size="4335" author="brandon.williams" created="Fri, 28 Jan 2011 20:28:54 +0000"/>
                            <attachment id="12469851" name="0003-Remove-endpoint-state-when-expiring-justRemovedEndpo.patch" size="2118" author="brandon.williams" created="Mon, 31 Jan 2011 19:44:51 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20427</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 42 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g95j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92913</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>gdusbabek</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[gdusbabek]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>