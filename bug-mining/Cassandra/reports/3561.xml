<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:53:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8940] Inconsistent select count and select distinct</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8940</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When performing &lt;tt&gt;select count( * ) from ...&lt;/tt&gt; I expect the results to be consistent over multiple query executions if the table at hand is not written to / deleted from in the mean time. However, in my set-up it is not. The counts returned vary considerable (several percent). The same holds for &lt;tt&gt;select distinct partition-key-columns from ...&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I have a table in a keyspace with replication_factor = 1 which is something like:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE tbl (
    id frozen&amp;lt;id_type&amp;gt;,
    bucket bigint,
    offset &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
    value &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;,
    PRIMARY KEY ((id, bucket), offset)
)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The frozen udt is:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TYPE id_type (
    tags map&amp;lt;text, text&amp;gt;
);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The table contains around 35k rows (I&apos;m not trying to be funny here ...). The consistency level for the queries was ONE.&lt;/p&gt;</description>
                <environment>&lt;p&gt;2.1.2&lt;/p&gt;</environment>
        <key id="12780906">CASSANDRA-8940</key>
            <summary>Inconsistent select count and select distinct</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="frensjan">Frens Jan Rumph</reporter>
                        <labels>
                    </labels>
                <created>Tue, 10 Mar 2015 16:23:01 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:18 +0000</updated>
                            <resolved>Fri, 15 May 2015 15:02:08 +0000</resolved>
                                        <fixVersion>2.0.16</fixVersion>
                    <fixVersion>2.1.6</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="14357150" author="frensjan" created="Wed, 11 Mar 2015 16:39:12 +0000"  >&lt;p&gt;For completeness sake I also tested with CL=QUORUM and ALL which as one would expect with RF=1 yields the same inconsistent results.&lt;/p&gt;</comment>
                            <comment id="14388559" author="blerer" created="Tue, 31 Mar 2015 14:07:01 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frensjan&quot; class=&quot;user-hover&quot; rel=&quot;frensjan&quot;&gt;frensjan&lt;/a&gt; I tried to reproduce your problem but without success. The problem might be triggered by some specific data that are in your table.&lt;br/&gt;
Could you investigate on your side and come up with a way for me to reproduce your problem?&lt;/p&gt;</comment>
                            <comment id="14487315" author="blerer" created="Thu, 9 Apr 2015 12:53:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frensjan&quot; class=&quot;user-hover&quot; rel=&quot;frensjan&quot;&gt;frensjan&lt;/a&gt; any update on your side?&lt;/p&gt;</comment>
                            <comment id="14492700" author="frensjan" created="Mon, 13 Apr 2015 17:29:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;, sorry for the delay ... been a bit busy past few weeks.&lt;/p&gt;

&lt;p&gt;I&apos;ve whipped up a script which should reproduce my problems: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; cassandra.cluster
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; cassandra.concurrent

&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; string
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; sys


def setup_schema(session):
	print(&lt;span class=&quot;code-quote&quot;&gt;&quot;setting up schema&quot;&lt;/span&gt;)

	session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;CREATE KEYSPACE IF NOT EXISTS count_test WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: 1};&quot;&lt;/span&gt;)
	session.set_keyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;count_test&quot;&lt;/span&gt;)

	session.execute(&quot;&quot;&quot;
		CREATE TABLE IF NOT EXISTS tbl (
			id text,
			bucket bigint,
			offset &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
			value &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt;,
			PRIMARY KEY ((id, bucket), offset)
		)
	&quot;&quot;&quot;)


def insert_test_data(session):
	# setup parameters &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; the inserts
	ids = string.lowercase[:5]
	bucket_count = 10
	offset_count = 10000

	print(&lt;span class=&quot;code-quote&quot;&gt;&apos;inserting data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; %s ids, %s buckets and %s offsets&apos;&lt;/span&gt; % (len(ids), bucket_count, offset_count))

	# clear the table
	session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;TRUNCATE tbl;&quot;&lt;/span&gt;)

	# prepare the insert
	insert = session.prepare(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO tbl (id, bucket, offset, value) VALUES (?, ?, ?, ?)&quot;&lt;/span&gt;)

	# insert a CQL row &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; each tag, bucket and offset
	inserts = [
		(insert, (t, b, o, 0))
		&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; t in ids
		&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; b in xrange(bucket_count)
		&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; o in xrange(offset_count)
	]
	_ = cassandra.concurrent.execute_concurrent(session, inserts)

	&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; len(inserts)


&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; __name__ == &lt;span class=&quot;code-quote&quot;&gt;&apos;__main__&apos;&lt;/span&gt;:
	contact_points = sys.argv[1:]
	print(&lt;span class=&quot;code-quote&quot;&gt;&apos;connecting to %s&apos;&lt;/span&gt; % &lt;span class=&quot;code-quote&quot;&gt;&apos;, &apos;&lt;/span&gt;.join(contact_points))
	session = cassandra.cluster.Cluster(contact_points).connect()

	&lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;:
		setup_schema(session)
		inserted = insert_test_data(session)
		print(&lt;span class=&quot;code-quote&quot;&gt;&quot;inserted %s rows&quot;&lt;/span&gt; % inserted)

		&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; count in (session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT count(*) FROM tbl&quot;&lt;/span&gt;, timeout=120) &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; _ in range(10)):
			print(&lt;span class=&quot;code-quote&quot;&gt;&apos;queried count was %s%s&apos;&lt;/span&gt; % (count[0].count, &lt;span class=&quot;code-quote&quot;&gt;&apos;&apos; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; count[0].count == inserted &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &apos;&lt;/span&gt; (fail)&apos;))
	&lt;span class=&quot;code-keyword&quot;&gt;finally&lt;/span&gt;:
		session.shutdown()
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In my setup this yields (on a particular run):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;setting up schema
inserting data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 5 ids, 10 buckets and 1000 offsets
inserted 50000 rows
queried count was 50000
queried count was 49396 (fail)
queried count was 49918 (fail)
queried count was 50000
queried count was 50000
queried count was 50000
queried count was 49993 (fail)
queried count was 48997 (fail)
queried count was 49772 (fail)
queried count was 49551 (fail)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;As you can see the counts vary. The number of failures seem to be correlated to the number of rows in the cluster. E.g. with only 1000 rows there are no wrong counts.&lt;/p&gt;

&lt;p&gt;As for my set-up: I&apos;m using a three node cluster (cas-1, cas-2 and cas-3) which run on Vagrant + LXC. I planned on writing a script using CCM to be portable, but I wasn&apos;t able to reproduce the results with CCM! I&apos;ve tried both Cassandra 2.1.2 and 2.1.4 with CCM. That was rather disappointing. Or looking at it differently ... it might be considered a clue to where things go wrong ...&lt;/p&gt;

&lt;p&gt;Any of this ring a bell? Do you perhaps have pointers for me to dig deeper?&lt;/p&gt;</comment>
                            <comment id="14493778" author="blerer" created="Tue, 14 Apr 2015 08:22:39 +0000"  >&lt;p&gt;Thanks for the script &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frensjan&quot; class=&quot;user-hover&quot; rel=&quot;frensjan&quot;&gt;frensjan&lt;/a&gt;.&lt;br/&gt;
I will look into the issue this week.&lt;/p&gt;</comment>
                            <comment id="14495750" author="frensjan" created="Wed, 15 Apr 2015 06:42:55 +0000"  >&lt;p&gt;Great &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;As I said before, I had issues reproducing my issue with CCM. The set-up in which I could reproduce it was built on Vagrant + LXC ... which I didn&apos;t want to bother you with &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; So I put some effort in a more general set-up based on Vagrant + Virtualbox, see the attached files.&lt;/p&gt;

&lt;p&gt;The vagrant file creates a 3 node cluster on CentOS 7 with Cassandra 2.1 (2.1.4 at the time of writing ... depends on the packaging by datastax, so might bump in the future on a new patch version).&lt;/p&gt;

&lt;p&gt;At first I thought I had the same issue as with trying to use CCM, but apparently I needed to increase the number of rows written from 50k to 500k (with 5 ids, 10 buckets each (so 50 partitions) and 100k rows per partition).&lt;/p&gt;

&lt;p&gt;Example output from my setup:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;connecting to 192.168.33.11, 192.168.33.12, 192.168.33.13
setting up schema
inserting data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 5 ids, 10 buckets and 10000 offsets
inserted 500000 rows
queried count was 494495 (fail)
queried count was 493530 (fail)
queried count was 494604 (fail)
queried count was 490000 (fail)
queried count was 500000
queried count was 494382 (fail)
queried count was 494204 (fail)
queried count was 494625 (fail)
queried count was 500000
queried count was 494758 (fail)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note that I have slightly modified the script to accept contact points for &lt;tt&gt;cassandra.cluster.Cluster(...)&lt;/tt&gt; and also increased the number of rows inserted as mentioned before. So it can be executed with e.g. &lt;tt&gt;python2 test.py 192.168.33.11 192.168.33.12 192.168.33.13&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I haven&apos;t had the time do something like a proper sweep of the variables, but I tried a configuration with 5 ids, 1 bucket per id (so 5 unique partition keys) and 100k rows per partition which also seems to fail, but in a perhaps interesting different way, for example:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;setting up schema
inserting data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 5 ids, 1 buckets and 100000 offsets
inserted 500000 rows
queried count was 500000
queried count was 500000
queried count was 403172 (fail)
queried count was 500000
queried count was 500000
queried count was 302821 (fail)
queried count was 500000
queried count was 500000
queried count was 304049 (fail)
queried count was 500000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;With 5 ids, 100 bucket per id and 1k rows per partition - in my set-up - things do seem to pan out better, only one failure out of ten (in a particular run):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;connecting to 192.168.33.11, 192.168.33.12, 192.168.33.13
setting up schema
inserting data &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 5 ids, 100 buckets and 1000 offsets
inserted 500000 rows
queried count was 500000
queried count was 500000
queried count was 500000
queried count was 500000
queried count was 500000
queried count was 498740 (fail)
queried count was 500000
queried count was 500000
queried count was 500000
queried count was 500000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14507719" author="blerer" created="Wed, 22 Apr 2015 19:22:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frensjan&quot; class=&quot;user-hover&quot; rel=&quot;frensjan&quot;&gt;frensjan&lt;/a&gt; After installing Vagrant, VirtualBox, making sure that Cygwin add all the required modules and going around a bug in Vagrant, I manage to have everything running. Unfortunatly, I could not reproduce the problem on my machine &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
I tried with all combinations of ids, buckets  and offsets that you suggested but without success. The count was always the good one.&lt;/p&gt;

&lt;p&gt;I tried with CCM just in case but it was also working fine.&lt;/p&gt;

&lt;p&gt;I have really no ideas of where the problem might come from and why it does not appear on my environment.&lt;/p&gt;

&lt;p&gt;As you can reproduce it on your environment, it would be interesting if you could enable tracing (&lt;a href=&quot;http://www.datastax.com/dev/blog/tracing-in-cassandra-1-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.datastax.com/dev/blog/tracing-in-cassandra-1-2&lt;/a&gt;) and get me a trace of when the count fail and when it succeed. It could help me to pinpoint where the problem might come from.&lt;/p&gt;

&lt;p&gt;Thanks a lot for having spent your time in creating all those the scripts. It worked very well (outside of my windows issues).&lt;/p&gt;</comment>
                            <comment id="14507981" author="frensjan" created="Wed, 22 Apr 2015 21:47:48 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt;Wow, thanks a lot for all the trouble you&apos;ve been through!&lt;/p&gt;

&lt;p&gt;Weirdest thing that you aren&apos;t able to reproduce the issue. It might give a clue though. I assume you are running the scripts from your host machine? If so it might be more of a client then a server related issue. Could you by any chance run the script from one of the nodes if you haven&apos;t done so already?&lt;/p&gt;

&lt;p&gt;If you place the script in &lt;tt&gt;test.py&lt;/tt&gt; next to the &lt;tt&gt;Vagrantfile&lt;/tt&gt; you should be able to do something like (as root / with sudo):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;curl https:&lt;span class=&quot;code-comment&quot;&gt;//bootstrap.pypa.io/get-pip.py | python
&lt;/span&gt;pip install cassandra-driver
cd /vagrant
python test.py cas-1 cas-2 cas-3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have attached to csv dumps from &lt;tt&gt;system_traces.events&lt;/tt&gt;:&lt;br/&gt;
7b74fb00-e935-11e4-b10c-317579db7eb4.csv which counted to 494453&lt;br/&gt;
8d5899d0-e935-11e4-847b-2d06da75a6cd.csv which counted to 494833&lt;/p&gt;

&lt;p&gt;I wasn&apos;t able to count to the 500000 rows which were in the table with tracing enabled ... perhaps looking at differences between the traces reveals something?&lt;/p&gt;

&lt;p&gt;The traces were generated from the script running from one of the Vagrant nodes by the way.&lt;/p&gt;

&lt;p&gt;Cheers,&lt;br/&gt;
Frens Jan&lt;/p&gt;</comment>
                            <comment id="14508970" author="blerer" created="Thu, 23 Apr 2015 12:28:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frensjan&quot; class=&quot;user-hover&quot; rel=&quot;frensjan&quot;&gt;frensjan&lt;/a&gt; After destroying my environment and creating it, I am able to reproduce the problem by using the client from my own machine. Which look weird to me.&lt;/p&gt;

&lt;p&gt;Do you have this problem on real hardware or only on virtual machines?&lt;/p&gt;</comment>
                            <comment id="14509043" author="frensjan" created="Thu, 23 Apr 2015 13:29:15 +0000"  >&lt;p&gt;@&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;, peculiar to say the least! I haven&apos;t got any Cassandra nodes on bare metal, VM / container only. I wasn&apos;t able to reproduce using CCM on my laptop. But maybe it&apos;s dependent on the number of rows / overhead of a VM / container / network / ...? I you would substantially reduce the row counts in my test script, things would probably be just fine. I haven&apos;t had issues with counting say a 1000 rows.&lt;/p&gt;</comment>
                            <comment id="14509369" author="blerer" created="Thu, 23 Apr 2015 17:06:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frensjan&quot; class=&quot;user-hover&quot; rel=&quot;frensjan&quot;&gt;frensjan&lt;/a&gt; I will continue investigating the problem. Jonathan had a good idea to find out the root of the problem. I will try it.&lt;/p&gt;</comment>
                            <comment id="14509603" author="frensjan" created="Thu, 23 Apr 2015 19:05:43 +0000"  >&lt;p&gt;Great. If there&apos;s anything I can help with, let me know.&lt;/p&gt;</comment>
                            <comment id="14516797" author="blerer" created="Tue, 28 Apr 2015 10:48:37 +0000"  >&lt;p&gt;When performing a count operation, Cassandra request all the needed data from all the replicas and count them on the coordinator. As the count is a straight forward operation, my guess was that the problem was coming from the returned data. &lt;br/&gt;
To verify that idea, I build a program that does a select all query and analyse the results as well as some extra informations.&lt;/p&gt;

&lt;p&gt;I did multiple runs to try to have proper metrics.&lt;/p&gt;

&lt;p&gt;Here is the output of my latest run with 5 ids, 100 buckets and 1000 offsets.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Connected to cluster: Test Cluster
Datatacenter: datacenter1; Host: /192.168.33.12; Rack: rack1
Datatacenter: datacenter1; Host: /192.168.33.11; Rack: rack1
----------------------------------------
Missing range: [479-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:d, bucket:23 with count: 442479 (coordinator: /192.168.33.11:9042 replica: /192.168.33.11:9042)
Next row (coordinator: /192.168.33.11:9042 replica: /192.168.33.11:9042)
total count: 499479
----------------------------------------
Missing range: [340-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:d, bucket:23 with count: 442340 (coordinator: /192.168.33.11:9042 replica: /192.168.33.11:9042)
Next row (coordinator: /192.168.33.11:9042 replica: /192.168.33.11:9042)
total count: 499340
----------------------------------------
total count: 500000
----------------------------------------
Missing range: [858-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:a, bucket:44 with count: 254858 (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
Next row (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
Missing range: [885-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:c, bucket:38 with count: 404743 (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
Next row (coordinator: /192.168.33.12:9042 replica: /192.168.33.11:9042)
total count: 498743
----------------------------------------
Missing range: [408-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:a, bucket:3 with count: 69408 (coordinator: /192.168.33.11:9042 replica: /192.168.33.11:9042)
Next row (coordinator: /192.168.33.11:9042 replica: /192.168.33.11:9042)
total count: 491408
----------------------------------------
total count: 500000
----------------------------------------
total count: 500000
----------------------------------------
total count: 500000
----------------------------------------
total count: 500000
----------------------------------------
total count: 500000
----------------------------------------
Missing range: [152-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:d, bucket:68 with count: 154152 (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
Next row (coordinator: /192.168.33.12:9042 replica: /192.168.33.11:9042)
Missing range: [1-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:e, bucket:23 with count: 390153 (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
Next row (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
total count: 497153
----------------------------------------
total count: 500000
----------------------------------------
total count: 500000
----------------------------------------
Missing range: [905-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:b, bucket:93 with count: 253905 (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
Next row (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
Missing range: [680-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:a, bucket:44 with count: 254585 (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
Next row (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
total count: 498585
----------------------------------------
Missing range: [968-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:a, bucket:42 with count: 268968 (coordinator: /192.168.33.11:9042 replica: /192.168.33.11:9042)
Next row (coordinator: /192.168.33.11:9042 replica: /192.168.33.11:9042)
total count: 499968
----------------------------------------
Missing range: [635-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:c, bucket:75 with count: 59635 (coordinator: /192.168.33.11:9042 replica: /192.168.33.11:9042)
Next row (coordinator: /192.168.33.11:9042 replica: /192.168.33.12:9042)
total count: 496635
----------------------------------------
Missing range: [805-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:a, bucket:44 with count: 254805 (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
Next row (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
total count: 498805
----------------------------------------
Missing range: [373-999] &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; key: id:d, bucket:68 with count: 154373 (coordinator: /192.168.33.12:9042 replica: /192.168.33.12:9042)
Next row (coordinator: /192.168.33.12:9042 replica: /192.168.33.11:9042)
total count: 499373
----------------------------------------
total count: 500000
----------------------------------------
total count: 500000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The result show that the missing data are always at the end of a partition (e.g. the partition is being truncated at a random position). In all the experiences that I have run, Cassandra has never lost data in the middle of a partition.&lt;/p&gt;

&lt;p&gt;Everytime that some data were lost, the data was located on the coordinator node. The data of the next partition were coming either form the same node or from another one. &lt;/p&gt;

&lt;p&gt;There seems to be no link between the failure and the automatic paging as the problem was not specially occuring at the page boundaries. &lt;/p&gt;
</comment>
                            <comment id="14516949" author="frensjan" created="Tue, 28 Apr 2015 12:25:53 +0000"  >&lt;p&gt;Thanks for the update. I guess you are on to something. Again, if there&apos;s anything I can help with. I&apos;m happy to pitch in.&lt;/p&gt;

&lt;p&gt;(a bit of topic): I wasn&apos;t aware that Cassandra performs the count on the coordinator. I wonder why one couldn&apos;t push the count operator to the replicas involved. I see that aggregate functions in Cassandra trunk are implemented in a similar fashion. A pity if you ask me.&lt;/p&gt;

&lt;p&gt;As I understand it, select count queries operate on top of normal select all queries. Does this mean that this &apos;skipping&apos; of rows might also be a problem in other cases? Or is it only a problem because the result set is processed/paged on a Cassandra node and not in a driver?&lt;/p&gt;</comment>
                            <comment id="14516985" author="blerer" created="Tue, 28 Apr 2015 12:59:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Thanks for the update. I guess you are on to something. Again, if there&apos;s anything I can help with. I&apos;m happy to pitch in.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks for the offer &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. For the moment, I am just digging.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;(a bit of topic): I wasn&apos;t aware that Cassandra performs the count on the coordinator. I wonder why one couldn&apos;t push the count operator to the replicas involved. I see that aggregate functions in Cassandra trunk are implemented in a similar fashion. A pity if you ask me.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The advantage of this approach was that the consistency problem was already solve. The coordinator was guaranty to have the latest data. &lt;br/&gt;
The plan was to deliver that initial version first and to make it better in the future. If you are interested in it, you can follow &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8826&quot; title=&quot;Distributed aggregates&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8826&quot;&gt;CASSANDRA-8826&lt;/a&gt;. &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;As I understand it, select count queries operate on top of normal select all queries. Does this mean that this &apos;skipping&apos; of rows might also be a problem in other cases? Or is it only a problem because the result set is processed/paged on a Cassandra node and not in a driver?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The &apos;skipping&apos; of row might apparently be a problem for queries requesting data from more that one partition. I do not know yet the extends of the problem.&lt;/p&gt;</comment>
                            <comment id="14535458" author="blerer" created="Fri, 8 May 2015 20:37:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frensjan&quot; class=&quot;user-hover&quot; rel=&quot;frensjan&quot;&gt;frensjan&lt;/a&gt;, you did not succeed to reproduce the problem with ccm because by default ccm disable &lt;tt&gt;vnodes&lt;/tt&gt;. This means that the data will be distributed on only 3 contiguous ranges and the &lt;tt&gt;StoreProxy&lt;/tt&gt; will have to perform at most 2 requests.&lt;/p&gt;

&lt;p&gt;If the ccm cluster is created with the &lt;tt&gt;vnodes&lt;/tt&gt; option. The data will be distributed over 256 * 3 = 768 ranges and the problem is easily reproducible.&lt;/p&gt;

&lt;p&gt;In our scenario, for each page of data (5000 cql rows), the &lt;tt&gt;StoreProxy&lt;/tt&gt; will initially send a first request and check if enough results are returned. If not enough result have been returned it will guess based on the amount of data returned for the first range how much more range it needs to query and will query them in parallel.&lt;/p&gt;

&lt;p&gt;In the worst case, where no result have been found in the first range, the &lt;tt&gt;StoreProxy&lt;/tt&gt; will assume that we only have a small amount of data per range and will issue 767 concurrent requests to get the remaining data.     &lt;br/&gt;
A third of those request will target some ranges of data located on the coordinator node. &lt;/p&gt;

&lt;p&gt;Cassandra will optimise those requests by not serializing and deserializing them.&lt;/p&gt;

&lt;p&gt;The problem was that the &lt;tt&gt;SliceQueryFilter&lt;/tt&gt; which is part of the request and which is used to filter out the data ended up being shared between the threads while it should not have been as it is mutable.  &lt;/p&gt;

&lt;p&gt;I described worst case scenario but the problem could occurs with a smaller amount of concurrent requests.&lt;/p&gt;</comment>
                            <comment id="14535507" author="blerer" created="Fri, 8 May 2015 20:56:41 +0000"  >&lt;p&gt;The patch makes sure that we clone properly &lt;tt&gt;SliceQueryFilter&lt;/tt&gt; within the &lt;tt&gt;forSubRange&lt;/tt&gt; method of &lt;tt&gt;PagedRangeCommand&lt;/tt&gt; and &lt;tt&gt;RangeSliceCommand&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="14535542" author="blerer" created="Fri, 8 May 2015 21:13:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; could you review?&lt;/p&gt;</comment>
                            <comment id="14537524" author="frensjan" created="Mon, 11 May 2015 03:46:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;, great that you found this out and resolved the matter!&lt;/p&gt;</comment>
                            <comment id="14537825" author="blerer" created="Mon, 11 May 2015 11:20:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frensjan&quot; class=&quot;user-hover&quot; rel=&quot;frensjan&quot;&gt;frensjan&lt;/a&gt; Thank to you for your help.&lt;/p&gt;</comment>
                            <comment id="14545625" author="iamaleksey" created="Fri, 15 May 2015 15:01:48 +0000"  >&lt;p&gt;Committed to 2.0 in &lt;tt&gt;d4755287a35362a8728ef6929a5d30644788d9e7&lt;/tt&gt; and merged upwards, thanks.&lt;/p&gt;

&lt;p&gt;(FTR, a regression test is missing because our current infrastructure doesn&apos;t really allow us to write a proper one for this ticket).&lt;/p&gt;</comment>
                            <comment id="14559626" author="jbellis" created="Tue, 26 May 2015 18:59:31 +0000"  >&lt;p&gt;Should we also open a ticket to bound the number of concurrent requests we generate?  Hitting every vnode all at once sounds like a bad idea.&lt;/p&gt;</comment>
                            <comment id="14620888" author="thobbs" created="Thu, 9 Jul 2015 17:27:33 +0000"  >&lt;blockquote&gt;&lt;p&gt;Should we also open a ticket to bound the number of concurrent requests we generate? Hitting every vnode all at once sounds like a bad idea.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed.  I&apos;ve created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9772&quot; title=&quot;Bound the number of concurrent range requests&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9772&quot;&gt;CASSANDRA-9772&lt;/a&gt; to address this.&lt;/p&gt;</comment>
                            <comment id="15184697" author="mlemnaru" created="Tue, 8 Mar 2016 09:12:18 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frensjan&quot; class=&quot;user-hover&quot; rel=&quot;frensjan&quot;&gt;frensjan&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; I have a question regarding this if I may and didn&apos;t know where else to put it. We are currently implementing a solution which has Cassandra as a DB and we chose to go with Cassandra 3.3. &lt;/p&gt;

&lt;p&gt;Unfortunately when doing some tests we found out that this issue is reproducible in 3.3 and as I see this it&apos;s is not planned to port the fix for this to 3.3+ as well. Am I assuming correctly ? Will this issue be ported to 3.3 in the future as well ?&lt;/p&gt;

&lt;p&gt;We plan to go in production in 3-5 months time , did we make a poor decision in going with Cassandra 3.3 ? Should we go with 2.2 instead ? &lt;/p&gt;

&lt;p&gt;Thank you for all your help&lt;br/&gt;
Btw , great job on this one.&lt;/p&gt;

&lt;p&gt;Thanks &lt;br/&gt;
Mircea &lt;/p&gt;</comment>
                            <comment id="15184718" author="blerer" created="Tue, 8 Mar 2016 09:34:39 +0000"  >&lt;p&gt;Mircea, my guess is that the issue that you are hitting is a different/new one.&lt;br/&gt;
The code in 3.3 is different than one of 2.1 so the root cause of the problem cannot be the same.&lt;br/&gt;
If you could open a new JIRA ticket describing your problem and how it could be reproduced, it would be great.&lt;br/&gt;
Feel free to assign it to me.&lt;/p&gt;</comment>
                            <comment id="15184746" author="mlemnaru" created="Tue, 8 Mar 2016 10:21:22 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;. I have created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11314&quot; title=&quot;Inconsistent select count(*)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11314&quot;&gt;&lt;del&gt;CASSANDRA-11314&lt;/del&gt;&lt;/a&gt; to track the issue we found. It&apos;s still unassigned as I do not have permissions to assign issues.&lt;/p&gt;

&lt;p&gt;If there is anything else I can help to debug that issue ,please let me know. &lt;/p&gt;

&lt;p&gt;Thanks&lt;br/&gt;
Mircea&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12727353" name="7b74fb00-e935-11e4-b10c-317579db7eb4.csv" size="8102445" author="frensjan" created="Wed, 22 Apr 2015 21:48:17 +0000"/>
                            <attachment id="12731594" name="8940.txt" size="2998" author="blerer" created="Fri, 8 May 2015 20:56:41 +0000"/>
                            <attachment id="12727354" name="8d5899d0-e935-11e4-847b-2d06da75a6cd.csv" size="711006" author="frensjan" created="Wed, 22 Apr 2015 21:48:17 +0000"/>
                            <attachment id="12725503" name="Vagrantfile" size="740" author="frensjan" created="Wed, 15 Apr 2015 06:42:55 +0000"/>
                            <attachment id="12725501" name="install_cassandra.sh" size="666" author="frensjan" created="Wed, 15 Apr 2015 06:42:55 +0000"/>
                            <attachment id="12725502" name="setup_hosts.sh" size="308" author="frensjan" created="Wed, 15 Apr 2015 06:42:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 37 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i26l7b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329670">2.0.14</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>