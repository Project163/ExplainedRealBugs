<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:53:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9299] Fix counting of tombstones towards TombstoneOverwhelmingException</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9299</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6042&quot; title=&quot;Add WARN when there are a lot of tombstones in a query&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6042&quot;&gt;&lt;del&gt;CASSANDRA-6042&lt;/del&gt;&lt;/a&gt; introduced warning on too many tombstones scanned, then &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6117&quot; title=&quot;Avoid death-by-tombstone by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6117&quot;&gt;&lt;del&gt;CASSANDRA-6117&lt;/del&gt;&lt;/a&gt; introduced a hard TombstoneOverwhelmingException condition.&lt;/p&gt;

&lt;p&gt;However, at least &lt;tt&gt;SliceQuerFilter.collectReducedColumn()&lt;/tt&gt; seems to have the logic wrong. Cells that are covered by a range tombstone or a partition high level deletion, still count towards &lt;tt&gt;ColumnCounter&lt;/tt&gt;&apos;s &lt;tt&gt;ignored&lt;/tt&gt; register.&lt;/p&gt;

&lt;p&gt;Thus it&apos;s possible to have an otherwise healthy (though large) dropped partition read cause an exception that shouldn&apos;t be there.&lt;/p&gt;

&lt;p&gt;The only things that should count towards the exception are cell tombstones and range tombstones (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8527&quot; title=&quot;Account for range tombstones wherever we account for tombstones&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8527&quot;&gt;&lt;del&gt;CASSANDRA-8527&lt;/del&gt;&lt;/a&gt;), but never ever live cells shadowed by any kind of tombstone.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12827284">CASSANDRA-9299</key>
            <summary>Fix counting of tombstones towards TombstoneOverwhelmingException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 May 2015 13:31:30 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:12 +0000</updated>
                            <resolved>Tue, 12 May 2015 18:36:28 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.6</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14537355" author="iamaleksey" created="Sun, 10 May 2015 20:35:37 +0000"  >&lt;p&gt;Attached three patches - for 2.0, 2.1, and trunk, respectively, and pushed to three branches for cassci to do its thing later:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/9299-2.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iamaleksey/cassandra/commits/9299-2.0&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/9299-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iamaleksey/cassandra/commits/9299-2.1&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/9299-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iamaleksey/cassandra/commits/9299-trunk&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The 2.0 patch is the most conservative and changes as little as possible - the only correction there is that cells shadowed by a range tombstone or a partition tombstone won&apos;t count towards the warning and the exception.&lt;/p&gt;

&lt;p&gt;So removing a whole partition of cells in one go, or removing a map with 100k elements, will no longer trigger TOE.&lt;/p&gt;

&lt;p&gt;The 2.1 patch goes slightly further, and short-circuits &lt;tt&gt;SliceQueryFilter.collectReducedColumns()&lt;/tt&gt; logic if we stumble upon a tombstone past its gc grace, or, say, an expired TTL column with gc grace for the table set to 0.&lt;/p&gt;

&lt;p&gt;The trunk patch goes slightly further still and gets rid of one redundant column tester pass over the range tombstones in &lt;tt&gt;container.maybeAppendColumn()&lt;/tt&gt; call, relying instead on the result of the &lt;tt&gt;columnCounter.count()&lt;/tt&gt; test.&lt;/p&gt;</comment>
                            <comment id="14537361" author="iamaleksey" created="Sun, 10 May 2015 20:44:28 +0000"  >&lt;p&gt;Why I think the change is justified: the purpose of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6042&quot; title=&quot;Add WARN when there are a lot of tombstones in a query&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6042&quot;&gt;&lt;del&gt;CASSANDRA-6042&lt;/del&gt;&lt;/a&gt; and later &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6117&quot; title=&quot;Avoid death-by-tombstone by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6117&quot;&gt;&lt;del&gt;CASSANDRA-6117&lt;/del&gt;&lt;/a&gt; was to help us avoid OOMs in scenarios where we have to scan through &lt;b&gt;and accumulate&lt;/b&gt; cells that aren&apos;t live - to do a digest of them, or to return them to a coordinator, or to return them to a client. It only makes sense that cells that don&apos;t get retained in memory for those actions to happen should not count towards the exception.&lt;/p&gt;

&lt;p&gt;It could be said that extra scanning also causes issues for the client, and that&apos;s true, but it is a different issue, and should be handled in a separate ticket. Additionally, all redundantly read cells should be counted for that purpose - shadowed by partition tombstone, overwritten by a newer live cell, etc.&lt;/p&gt;

&lt;p&gt;The current counting logic is a mix of both of these, and does counting either badly, and must be split.&lt;/p&gt;</comment>
                            <comment id="14540076" author="iamaleksey" created="Tue, 12 May 2015 15:45:26 +0000"  >&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/iamaleksey/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/iamaleksey/&lt;/a&gt; has the same non-flaky tests failing as mainline branches have, so no regressions have been introduced.&lt;/p&gt;</comment>
                            <comment id="14540279" author="thobbs" created="Tue, 12 May 2015 17:23:41 +0000"  >&lt;p&gt;+1 overall, with just a couple of minor comments.  In the 2.1 patch, this comment should say &quot;will be immediately discarded&quot; instead of &quot;will &lt;em&gt;not&lt;/em&gt; be immediately discarded&quot;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-comment&quot;&gt;// An expired tombstone will not be immediately discarded in memory, and needn&apos;t be counted.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Also, the &lt;tt&gt;paging_test.TestPagingWithDeletions.test_failure_threshold_deletions()&lt;/tt&gt; dtest needs to be updated, since it&apos;s relying on partition-level deletions triggering the failure threshold.&lt;/p&gt;</comment>
                            <comment id="14540428" author="iamaleksey" created="Tue, 12 May 2015 18:35:54 +0000"  >&lt;p&gt;Thanks, committed as &lt;tt&gt;bed42c2104ebaac83da4292703c08a5c963e062c&lt;/tt&gt;, with the comment fixed in 2.1 and trunk.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;paging_test.TestPagingWithDeletions.test_failure_threshold_deletions()&lt;/tt&gt; was already failing, although for a different reason, so I haven&apos;t noticed it at first. Anyway, updated the test as well in &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/commit/9374d07da2b54a42360106d740690b2e4a832803&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/commit/9374d07da2b54a42360106d740690b2e4a832803&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="14611812" author="nihn" created="Thu, 2 Jul 2015 11:32:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tuxslayer&quot; class=&quot;user-hover&quot; rel=&quot;tuxslayer&quot;&gt;tuxslayer&lt;/a&gt; after upgrading Cassandra to 2.1.6 we stop receiving tombstones warnings. I lowered tombstone_warn_threshold for tests and it seems that only system tombstones are reported (keys like system, system_traces), is it related to your change, if so is there way to restore tombstone reporting for no system keys?&lt;/p&gt;</comment>
                            <comment id="14611816" author="iamaleksey" created="Thu, 2 Jul 2015 11:38:21 +0000"  >&lt;blockquote&gt;&lt;p&gt;is it related to your change, if so is there way to restore tombstone reporting for no system keys?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;System keyspaces/tables are not special cased, it&apos;s just that in your case they are the only ones with something to report (I&apos;m assuming one of them is system.schema_columns). In that case you are fine.&lt;/p&gt;</comment>
                            <comment id="14611823" author="nihn" created="Thu, 2 Jul 2015 11:45:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; Thanks for reply but it&apos;s strange because before 2.1.6 we were receiving reports with few thousands of tombstones and after there are none.&lt;/p&gt;</comment>
                            <comment id="14611869" author="iamaleksey" created="Thu, 2 Jul 2015 12:17:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;but it&apos;s strange because before 2.1.6 we were receiving reports with few thousands of tombstones and after there are none.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Before 2.1.6 tombstones were being counted wrongly (overcounted), that&apos;s all.&lt;/p&gt;</comment>
                            <comment id="14611886" author="nihn" created="Thu, 2 Jul 2015 12:35:36 +0000"  >&lt;p&gt;Ok then, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12828076">CASSANDRA-9326</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12845309">CASSANDRA-9815</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12822738">CASSANDRA-9221</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12731815" name="9299-2.0.txt" size="12247" author="aleksey" created="Sun, 10 May 2015 20:25:22 +0000"/>
                            <attachment id="12731816" name="9299-2.1.txt" size="14220" author="aleksey" created="Sun, 10 May 2015 20:25:31 +0000"/>
                            <attachment id="12731817" name="9299-trunk.txt" size="18253" author="aleksey" created="Sun, 10 May 2015 20:25:43 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 20 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2eavr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>