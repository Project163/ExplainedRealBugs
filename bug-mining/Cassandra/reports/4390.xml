<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:04:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11427] Range slice queries CL &gt; ONE trigger read-repair of purgeable tombstones</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11427</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Range queries will trigger read repairs for purgeable tombstones on hosts that already compacted given tombstones. Clusters with periodical jobs for scanning data ranges will likely see tombstones ressurected through RRs just to have them compacted again later at the destination host.&lt;/p&gt;

&lt;p&gt;Executing range queries (e.g. for reading token ranges) will compare the actual data instead of using digests when executed with CL &amp;gt; ONE. Responses will be consolidated by &lt;tt&gt;RangeSliceResponseResolver.Reducer&lt;/tt&gt;, where the result of &lt;tt&gt;RowDataResolver.resolveSuperset&lt;/tt&gt; is used as the reference version for the results. &lt;tt&gt;RowDataResolver.scheduleRepairs&lt;/tt&gt; will then send the superset to all nodes that returned a different result before. &lt;/p&gt;

&lt;p&gt;Unfortunately this does also involve cases where the superset is just made up of purgeable tombstone(s) that already have been compacted on the other nodes. In this case a read-repair will be triggered for transfering the purgeable tombstones to all other nodes nodes that returned an empty result.&lt;/p&gt;

&lt;p&gt;The issue can be reproduced with the provided dtest or manually using the following steps:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;create keyspace test1 with replication = { &apos;class&apos; : &apos;SimpleStrategy&apos;, &apos;replication_factor&apos; : 2 };
use test1;
create table test1 ( a text, b text, primary key(a, b) ) WITH compaction = {&apos;class&apos;: &apos;SizeTieredCompactionStrategy&apos;, &apos;enabled&apos;: &apos;false&apos;} AND dclocal_read_repair_chance = 0 AND gc_grace_seconds = 0;

delete from test1 where a = &apos;a&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ccm flush;
ccm node2 compact;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;use test1;
consistency all;
tracing on;
select * from test1;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment></environment>
        <key id="12953277">CASSANDRA-11427</key>
            <summary>Range slice queries CL &gt; ONE trigger read-repair of purgeable tombstones</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="spod">Stefan Podkowinski</assignee>
                                    <reporter username="spod">Stefan Podkowinski</reporter>
                        <labels>
                    </labels>
                <created>Thu, 24 Mar 2016 16:33:12 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:38 +0000</updated>
                            <resolved>Tue, 3 May 2016 10:50:36 +0000</resolved>
                                        <fixVersion>2.2.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15217871" author="spodxx@gmail.com" created="Wed, 30 Mar 2016 12:13:48 +0000"  >&lt;p&gt;Proposed patch added (2.1 + 2.2).&lt;/p&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-11427-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-11427-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-11427-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-11427-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-11427-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-11427-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15226316" author="slebresne" created="Tue, 5 Apr 2016 14:07:20 +0000"  >&lt;p&gt;The patch works but it has 2 small inefficiencies:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;it purges on the coordinator, but there is no point for purgeable tombstones to leave the replicas in the first place.&lt;/li&gt;
	&lt;li&gt;single partition queries already do that filtering on replicas (in &lt;tt&gt;ColumnFamilyStore.getColumnFamily(QueryFilter)&lt;/tt&gt;), and since &lt;tt&gt;scheduleRepairs()&lt;/tt&gt; is shared by single partition and range queries, that adds unecessary work for single partition ones.&lt;br/&gt;
Overall, I think it would be better (and actually slightly easier) to just call &lt;tt&gt;removeDeletedCF&lt;/tt&gt; in &lt;tt&gt;ColumnFamilyStore.filter(AbstractScanIterator, ExtendedFilter)&lt;/tt&gt;.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;But I would also note that:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;3.0 is not affected&lt;/li&gt;
	&lt;li&gt;this only concerns partition and range tombstones, so this is imo a fairly minor efficiency problem, not a correction issue. So in particular, this doesn&apos;t met the &quot;critical issues only&quot; bar for 2.1.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;So that I wonder if it&apos;s worth taking any risk just for 2.2. Not too opposed to it though if someone cares deeply.&lt;/p&gt;</comment>
                            <comment id="15232007" author="spodxx@gmail.com" created="Fri, 8 Apr 2016 10:48:42 +0000"  >&lt;p&gt;I&apos;ve now created &lt;tt&gt;11427-2.2_v2.patch&lt;/tt&gt; by purging tombstones in &lt;tt&gt;ColumnFamilyStore.filter&lt;/tt&gt; as suggested. I agree that it&apos;s easier and more efficient, just wondering why it already hasn&apos;t been done there. Tests look good, WDYT &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt;?&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/spodkowinski/cassandra/tree/CASSANDRA-11427-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-11427-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/spodkowinski/job/spodkowinski-CASSANDRA-11427-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15253550" author="spodxx@gmail.com" created="Fri, 22 Apr 2016 08:45:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;this only concerns partition and range tombstones, so this is imo a fairly minor efficiency problem, not a correction issue.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Although the performance overhead implied by this bug should be fairly low in most cases, it&apos;s leaving people confused why these read repairs happen in first place. If you have some monitoring in place telling you the system constantly has to read repair data, you should get to investigate. That&apos;s what I did.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;So that I wonder if it&apos;s worth taking any risk just for 2.2. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Any tests I can add to reduce the risks of possible side effects?&lt;/p&gt;</comment>
                            <comment id="15268516" author="slebresne" created="Tue, 3 May 2016 10:50:26 +0000"  >&lt;p&gt;Alright. It&apos;s been there forever and you&apos;re the first to bring it up so I don&apos;t entirely buy that it confuses people that much, but it does bring consistency between single partition and range queries and isn&apos;t very risky, so went ahead and committed to 2.2. Thanks.&lt;/p&gt;</comment>
                            <comment id="15425932" author="michaelsembwever" created="Thu, 18 Aug 2016 05:42:25 +0000"  >&lt;p&gt;This issue was rolled back in 2.2.8, via this commit &lt;a href=&quot;https://github.com/apache/cassandra/commit/f28631e0cf1bc6cb6a1bdf7a4fa1f4af720a77b6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/f28631e0cf1bc6cb6a1bdf7a4fa1f4af720a77b6&lt;/a&gt; (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12351&quot; title=&quot;IllegalStateException: empty rows returned when reading system.schema_keyspaces&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12351&quot;&gt;&lt;del&gt;CASSANDRA-12351&lt;/del&gt;&lt;/a&gt; for more info).&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12993849">CASSANDRA-12351</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12796065" name="11427-2.1.patch" size="5273" author="spod" created="Wed, 30 Mar 2016 12:14:07 +0000"/>
                            <attachment id="12797706" name="11427-2.2_v2.patch" size="1704" author="spod" created="Fri, 8 Apr 2016 10:49:52 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[spod]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 13 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2v64n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>