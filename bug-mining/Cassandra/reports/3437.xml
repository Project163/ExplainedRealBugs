<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8559] OOM caused by large tombstone warning.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8559</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When running with high amount of tombstones the error message generation from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6117&quot; title=&quot;Avoid death-by-tombstone by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6117&quot;&gt;&lt;del&gt;CASSANDRA-6117&lt;/del&gt;&lt;/a&gt; can lead to out of memory situation with the default setting.&lt;/p&gt;

&lt;p&gt;Attached a heapdump viewed in visualvm showing how this construct created two 777mb strings to print the error message for a read query and then crashed OOM.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (respectTombstoneThresholds() &amp;amp;&amp;amp; columnCounter.ignored() &amp;gt; DatabaseDescriptor.getTombstoneWarnThreshold())
        {
            StringBuilder sb = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder();
            CellNameType type = container.metadata().comparator;
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (ColumnSlice sl : slices)
            {
                &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; sl != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;

                sb.append(&lt;span class=&quot;code-quote&quot;&gt;&apos;[&apos;&lt;/span&gt;);
                sb.append(type.getString(sl.start));
                sb.append(&lt;span class=&quot;code-quote&quot;&gt;&apos;-&apos;&lt;/span&gt;);
                sb.append(type.getString(sl.finish));
                sb.append(&lt;span class=&quot;code-quote&quot;&gt;&apos;]&apos;&lt;/span&gt;);
            }

            logger.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;Read {} live and {} tombstoned cells in {}.{} (see tombstone_warn_threshold). {} columns was requested, slices={}, delInfo={}&quot;&lt;/span&gt;,
                        columnCounter.live(), columnCounter.ignored(), container.metadata().ksName, container.metadata().cfName, count, sb, container.deletionInfo());
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment>&lt;p&gt;2.0.11 / 2.1&lt;/p&gt;</environment>
        <key id="12764841">CASSANDRA-8559</key>
            <summary>OOM caused by large tombstone warning.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="dominicletz">Dominic Letz</reporter>
                        <labels>
                            <label>tombstone</label>
                    </labels>
                <created>Mon, 5 Jan 2015 05:19:50 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:24 +0000</updated>
                            <resolved>Sun, 22 Mar 2015 11:35:56 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14264497" author="benedict" created="Mon, 5 Jan 2015 11:22:04 +0000"  >&lt;p&gt;This suggests you are &lt;em&gt;requesting&lt;/em&gt; some gigantic (or huge number) of slices in your query? It is still a bug that we try to print them all, but I suspect you have something funky going on with your query as well.&lt;/p&gt;</comment>
                            <comment id="14264532" author="slebresne" created="Mon, 5 Jan 2015 12:07:04 +0000"  >&lt;p&gt;I would have suspected that it&apos;s the &lt;tt&gt;deletionInfo()&lt;/tt&gt; that is big, and I&apos;m not sure why we print that tbh (not only can it be rather big, even if you don&apos;t really do anything wrong, but I&apos;m also not entirely sure what kind of insights they are supposed to provide in that case). So I simply suggest we remove that part&lt;/p&gt;

&lt;p&gt;The slices however are here to allow the user to identify the query that does trigger the warning and so I think we should keep them. We could of course limit the size of the message we create for them, but tbh, I can&apos;t really imagine a real life situation where those could be a problem (and if I&apos;m wrong here and it&apos;s indeed the slices themselves that makes it OOM, I do am really curious why you need such a crazy query) so I&apos;m not sure how much it&apos;s worth bothering.&lt;/p&gt;</comment>
                            <comment id="14264538" author="dominicletz" created="Mon, 5 Jan 2015 12:13:14 +0000"  >&lt;p&gt;Both is true, there are huge gaps filled with many tombstones that do that to the query and we like the error message that warns us about that and helps us fixing that issue. But in this case the error message was the issue. &lt;/p&gt;</comment>
                            <comment id="14265596" author="dominicletz" created="Tue, 6 Jan 2015 02:48:43 +0000"  >&lt;p&gt;To qualify that a bit more, you are right &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; the deletionInfo() is the big one and the fragment seen in the screenshot shows what is generated in DeletionInfo.toString(), and the second 700mb string is what is generated from rangesAsString() and copied into the first.&lt;/p&gt;

&lt;p&gt;So the huge dump is rather generated here in DeletionInfo: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; rangesAsString()
    {
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; !ranges.isEmpty();
        StringBuilder sb = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; StringBuilder();
        CType type = (CType)ranges.comparator();
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; type != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
        Iterator&amp;lt;RangeTombstone&amp;gt; iter = rangeIterator();
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iter.hasNext())
        {
            RangeTombstone i = iter.next();
            sb.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;[&quot;&lt;/span&gt;);
            sb.append(type.getString(i.min)).append(&lt;span class=&quot;code-quote&quot;&gt;&quot;-&quot;&lt;/span&gt;);
            sb.append(type.getString(i.max)).append(&lt;span class=&quot;code-quote&quot;&gt;&quot;, &quot;&lt;/span&gt;);
            sb.append(i.data);
            sb.append(&lt;span class=&quot;code-quote&quot;&gt;&quot;]&quot;&lt;/span&gt;);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; sb.toString();
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Should this be limited to a maximum (e.g. 1000 ranges?)&lt;/p&gt;</comment>
                            <comment id="14265647" author="dominicletz" created="Tue, 6 Jan 2015 03:43:34 +0000"  >&lt;p&gt;Attaching stacktrace of the very crash (Cassandra 2.0.11). It shows that the crash is actually in DeletionInfo.toString(). &lt;/p&gt;</comment>
                            <comment id="14274917" author="dominicletz" created="Tue, 13 Jan 2015 08:43:04 +0000"  >&lt;p&gt;Added a variable tombstone_warn_message_len to limit the length of the generated string representation of DeletionInfo. I&apos;m not completely happy with the naming of the variable as it really only affects DeletionInfo::toString(). Food for thought.&lt;/p&gt;</comment>
                            <comment id="14305113" author="jblangston@datastax.com" created="Wed, 4 Feb 2015 14:14:04 +0000"  >&lt;p&gt;I have seen another user hit this. In this case, the log message was triggered by a bad query and an even worse data model, but it&apos;s too easy for new users to Cassandra to stumble across this. If someone shoots themselves in the foot, we should try not to blow their whole leg off.  So I&apos;m +1 on having a limit to the amount of information we log.&lt;/p&gt;</comment>
                            <comment id="14354244" author="iamaleksey" created="Tue, 10 Mar 2015 03:59:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dominicletz&quot; class=&quot;user-hover&quot; rel=&quot;dominicletz&quot;&gt;dominicletz&lt;/a&gt; I don&apos;t think this deserves its own config parameter. What Sylvain suggested, and what I agree we should do, is to simply stop including &lt;tt&gt;delInfo=&lt;/tt&gt; / &lt;tt&gt;container.deletionInfo()&lt;/tt&gt; in &lt;tt&gt;logger.warn()&lt;/tt&gt; call in &lt;tt&gt;SliceQueryFilter#collectReducedColumns()&lt;/tt&gt;. Do you want to write a v2 patch to do just that?&lt;/p&gt;</comment>
                            <comment id="14364559" author="iamaleksey" created="Tue, 17 Mar 2015 04:50:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; Can you please review?&lt;/p&gt;</comment>
                            <comment id="14366881" author="beobal" created="Wed, 18 Mar 2015 09:36:42 +0000"  >&lt;p&gt;+1 LGTM&lt;/p&gt;</comment>
                            <comment id="14374884" author="iamaleksey" created="Sun, 22 Mar 2015 11:35:56 +0000"  >&lt;p&gt;Thanks, committed.&lt;/p&gt;</comment>
                            <comment id="14535252" author="aweisberg" created="Fri, 8 May 2015 18:52:23 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; What&apos;s the data model or queries that cause this? Are they worth including in our testing process?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12671497">CASSANDRA-6117</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12704998" name="8559.txt" size="1058" author="aleksey" created="Tue, 17 Mar 2015 04:50:08 +0000"/>
                            <attachment id="12690007" name="Selection_048.png" size="105880" author="dominicletz" created="Mon, 5 Jan 2015 05:19:50 +0000"/>
                            <attachment id="12691886" name="cassandra-2.0.11-8559.txt" size="4716" author="dominicletz" created="Tue, 13 Jan 2015 08:43:04 +0000"/>
                            <attachment id="12690243" name="stacktrace.log" size="3540" author="dominicletz" created="Tue, 6 Jan 2015 03:43:34 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23xz3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327942">2.0.11</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>samt</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325023">2.0.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>