<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:33:59 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-20692] Direct IO commit log does not flush data safely</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-20692</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maxwellguo&quot; class=&quot;user-hover&quot; rel=&quot;maxwellguo&quot;&gt;maxwellguo&lt;/a&gt; spotted this a few days ago.&lt;/p&gt;

&lt;p&gt;The commit log is not safe as currently written with Direct IO. It writes to the file, but doesn&apos;t sync the metadata on flush. That means the commit log may claim it has flushed (and made durable) the data, but the filesystem journal has not been flushed so the file length could be wrong and could truncate the file on restart.&lt;/p&gt;

&lt;p&gt;Additionally Direct IO doesn&apos;t actually make data durable on disk (emit write barriers) it just bypasses the page cache. &lt;a href=&quot;https://man7.org/linux/man-pages/man2/open.2.html#:~:text=The%20O_DIRECT%20flag,for%20further%20discussion.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;It doesn&apos;t even guarantee the disk transaction is complete.&lt;/a&gt; If the disk cache is volatile then it can lose metadata and data.&lt;/p&gt;

&lt;p&gt;It can probably be fixed pretty trivially by opening the file with &lt;tt&gt;D_SYNC&lt;/tt&gt; because the commit log writes up to the entire segment when it flushes so there is no issue with needing to add buffering to avoid too many small writes.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=amit_pawar&quot; class=&quot;user-hover&quot; rel=&quot;amit_pawar&quot;&gt;amit_pawar&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jlewandowski&quot; class=&quot;user-hover&quot; rel=&quot;jlewandowski&quot;&gt;jlewandowski&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13619715">CASSANDRA-20692</key>
            <summary>Direct IO commit log does not flush data safely</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maxwellguo">guo Maxwell</assignee>
                                    <reporter username="aweisberg">Ariel Weisberg</reporter>
                        <labels>
                    </labels>
                <created>Fri, 30 May 2025 19:26:40 +0000</created>
                <updated>Tue, 17 Jun 2025 16:08:26 +0000</updated>
                            <resolved>Tue, 17 Jun 2025 16:06:37 +0000</resolved>
                                        <fixVersion>5.0.5</fixVersion>
                    <fixVersion>6.x</fixVersion>
                                    <component>Local/Commit Log</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17955455" author="maxwellguo" created="Sun, 1 Jun 2025 01:48:52 +0000"  >&lt;p&gt;I take this ticket.&lt;/p&gt;</comment>
                            <comment id="17956136" author="maxwellguo" created="Wed, 4 Jun 2025 15:10:42 +0000"  >&lt;p&gt;I made a pr for trunk : &lt;a href=&quot;https://github.com/apache/cassandra/pull/4195&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/4195&lt;/a&gt; , let me run the &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/295/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ut&lt;/a&gt; here.&lt;br/&gt;
and I will prepare a pr for 5.0 if this pr is ok.&lt;br/&gt;
I  did a test locally on my mac (one c* node) use cassandra-stress just want to see if direct io can make any difference for cassandra &apos; write. &lt;br/&gt;
my test cases are very simple ,client command :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
./cassandra-stress write duration=10m -rate threads=10 -graph file=/tmp/graph_mmap_wal.html title=mmap_wal_graph
./cassandra-stress write duration=10m -rate threads=10 -graph file=/tmp/graph_direct_wal.html title=direct_wal_graph
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I flushed the node when I finished test every time(I did two rounds of test). The result seems to be ok , the tps for direct io mode is better than mmap&#12290;&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076828/13076828_SCR-20250604-txwj.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;  &lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13076829/13076829_SCR-20250604-txzv.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17956265" author="maxwellguo" created="Thu, 5 Jun 2025 06:34:12 +0000"  >&lt;p&gt;ping &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt;, Would you mind taking a look?&lt;/p&gt;</comment>
                            <comment id="17959769" author="aweisberg" created="Wed, 11 Jun 2025 15:53:21 +0000"  >&lt;p&gt;FYI I believe MacOS ignores O_DIRECT, but I couldn&apos;t confirm just found hearsay information when I did a quick Google.&lt;/p&gt;</comment>
                            <comment id="17979270" author="aweisberg" created="Mon, 16 Jun 2025 15:52:49 +0000"  >&lt;p&gt;Tests look good. +1&lt;/p&gt;</comment>
                            <comment id="17979344" author="maxwellguo" created="Tue, 17 Jun 2025 02:19:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/4203&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0 -pr &lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch-5/307/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0-test&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;5.0&apos;ci result seems to be ok. &lt;/p&gt;</comment>
                            <comment id="17980150" author="maxwellguo" created="Tue, 17 Jun 2025 16:02:55 +0000"  >&lt;p&gt;committed as 8de4c9250eeba3b80e8f7132ab529906ce8040f6, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310460">
                    <name>Child-Issue</name>
                                                                <inwardlinks description="is a child of">
                                        <issuelink>
            <issuekey id="13161590">CASSANDRA-14466</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13076828" name="SCR-20250604-txwj.png" size="327085" author="maxwellguo" created="Wed, 4 Jun 2025 15:10:08 +0000"/>
                            <attachment id="13076829" name="SCR-20250604-txzv.png" size="324804" author="maxwellguo" created="Wed, 4 Jun 2025 15:10:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maxwellguo]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="13161" cascade-level="1"><![CDATA[Unrecoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12975"><![CDATA[Code Inspection]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            21 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1w4k0:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12353816">5.0-beta1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/8de4c9250eeba3b80e8f7132ab529906ce8040f6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/8de4c9250eeba3b80e8f7132ab529906ce8040f6&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;ut&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>