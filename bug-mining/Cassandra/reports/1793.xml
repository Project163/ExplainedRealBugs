<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:35:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4644] Compaction error with Cassandra 1.1.4 and LCS</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4644</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In our 1.1.4 testcluster of 3 nodes with RF=3, KS=1, and CF=5, we are getting an asserting error when running &apos;nodetool compact highscores leaderboard&apos;. This stops compactions on the &apos;leaderboard&apos; CF summing up to 11835 pending compactions. This error is seen only one one node. &lt;/p&gt;

&lt;p&gt;The SSTables have originally been created on a 1.1.2 cluster with STCS and then copied to the testcluster also with 1.1.2. Repair, cleanup, compact were OK with STCS. Next, we changed to LCS and did again repair, cleanup, compact with success. &lt;/p&gt;

&lt;p&gt;Then we started to use this LCS-based testcluster intensively and created lots of data and also large keys with millions of columns. &lt;/p&gt;

&lt;p&gt;The assertion error in system.log :&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:8&amp;#93;&lt;/span&gt; 2012-09-11 14:20:45,043 CompactionController.java (line 172) Compacting large row highscores/leaderboard:4c422d64626331353166372d363464612d343235342d396130322d6535616365343337373532332d676c6f62616c2d30 (72589650 bytes) incrementally&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:8&amp;#93;&lt;/span&gt; 2012-09-11 14:20:50,336 AbstractCassandraDaemon.java (line 135) Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:8,1,RMI Runtime&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError&lt;br/&gt;
        at org.apache.cassandra.db.compaction.LeveledManifest.promote(LeveledManifest.java:214)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.LeveledCompactionStrategy.handleNotification(LeveledCompactionStrategy.java:158)&lt;br/&gt;
        at org.apache.cassandra.db.DataTracker.notifySSTablesChanged(DataTracker.java:531)&lt;br/&gt;
        at org.apache.cassandra.db.DataTracker.replaceCompactedSSTables(DataTracker.java:254)&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore.replaceCompactedSSTables(ColumnFamilyStore.java:992)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:200)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.LeveledCompactionTask.execute(LeveledCompactionTask.java:50)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager$6.runMayThrow(CompactionManager.java:288)&lt;br/&gt;
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:441)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Cassandra 1.1.4, Ubuntu Lucid (2.6.32-346), Amazon EC2 m1.xlarge&lt;/p&gt;</environment>
        <key id="12607073">CASSANDRA-4644</key>
            <summary>Compaction error with Cassandra 1.1.4 and LCS</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="5">Cannot Reproduce</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="rvanderleeden">Rudolf VanderLeeden</reporter>
                        <labels>
                    </labels>
                <created>Tue, 11 Sep 2012 14:48:00 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:27 +0000</updated>
                            <resolved>Mon, 17 Sep 2012 17:38:25 +0000</resolved>
                                        <fixVersion>1.1.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13453098" author="omid" created="Tue, 11 Sep 2012 15:25:56 +0000"  >&lt;blockquote&gt;
&lt;p&gt;The SSTables have originally been created on a 1.1.2 cluster with STCS and then copied to the testcluster also with 1.1.2. Repair, cleanup, compact were OK with STCS. &lt;em&gt;Next, we changed to LCS&lt;/em&gt; and did again repair, cleanup, compact with success.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Just to double-check, as you mentioned in the mailing list, you upgraded to 1.1.4 before changing to LCS, right?&lt;/p&gt;</comment>
                            <comment id="13453156" author="rvanderleeden" created="Tue, 11 Sep 2012 16:29:12 +0000"  >&lt;p&gt;Sorry, I forgot to mention the 1.1.4 upgrade step. It should read: &lt;br/&gt;
(1) The SSTables have originally been created on a 1.1.2 cluster with STCS and then copied to the testcluster also with 1.1.2. Repair, cleanup, compact were OK with STCS. &lt;br/&gt;
(2) Upgrade to 1.1.4&lt;br/&gt;
(3) We changed to LCS and did again repair, cleanup, compact, also with success.&lt;/p&gt;</comment>
                            <comment id="13454362" author="rvanderleeden" created="Wed, 12 Sep 2012 21:11:03 +0000"  >&lt;p&gt;Maybe, the following debug lines help to find the cause:&lt;br/&gt;
DEBUG 20:59:47,207 Deleted /mnt/cassandra/data/highscores/leaderboard/highscores-leaderboard-he-18148&lt;br/&gt;
DEBUG 20:59:47,207 L0 contains 4422 SSTables (62004030662 bytes) in Manifest@451835319&lt;br/&gt;
DEBUG 20:59:47,207 L1 contains 14 SSTables (258039196 bytes) in Manifest@451835319&lt;br/&gt;
DEBUG 20:59:47,208 L2 contains 33 SSTables (508660830 bytes) in Manifest@451835319&lt;br/&gt;
DEBUG 20:59:47,208 L3 contains 360 SSTables (3536343071 bytes) in Manifest@451835319&lt;br/&gt;
DEBUG 20:59:47,209 L4 contains 1813 SSTables (32410447712 bytes) in Manifest@451835319&lt;br/&gt;
DEBUG 20:59:47,209 Replacing &lt;span class=&quot;error&quot;&gt;&amp;#91;leaderboard-18148(L1), &amp;#93;&lt;/span&gt;&lt;br/&gt;
DEBUG 20:59:47,209 Adding &lt;span class=&quot;error&quot;&gt;&amp;#91;leaderboard-21505(L-1), &amp;#93;&lt;/span&gt; at L2&lt;br/&gt;
ERROR 20:59:47,209 Exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:5,1,RMI Runtime&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError&lt;/p&gt;</comment>
                            <comment id="13455295" author="jbellis" created="Thu, 13 Sep 2012 21:12:19 +0000"  >&lt;p&gt;You need to run the &lt;b&gt;offline&lt;/b&gt; scrub (&lt;tt&gt;bin/sstablescrub&lt;/tt&gt;) to fix the sstable overlapping problem from early 1.1 releases.  (Running with -m to just check for overlaps between sstables should be fine, since you already scrubbed online which will catch out-of-order within an sstable.)&lt;/p&gt;</comment>
                            <comment id="13455332" author="jbellis" created="Thu, 13 Sep 2012 21:33:30 +0000"  >&lt;p&gt;Attachment adds sendBackToL0 code to promote, to fix this transparently instead of requiring offline scrub.&lt;/p&gt;

&lt;p&gt;Not really a huge win since you still need scrub (off-or-online) to catch out-of-order rows within an sstable, but may help with some of the confusion around this.&lt;/p&gt;</comment>
                            <comment id="13455643" author="omid" created="Fri, 14 Sep 2012 07:37:54 +0000"  >&lt;p&gt;@Jonathan: compaction strategy was changed to LCS after upgrading to 1.1.4 so it looks like even with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4321&quot; title=&quot;stackoverflow building interval tree &amp;amp; possible sstable corruptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4321&quot;&gt;&lt;del&gt;CASSANDRA-4321&lt;/del&gt;&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4411&quot; title=&quot;Assertion with LCS compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4411&quot;&gt;&lt;del&gt;CASSANDRA-4411&lt;/del&gt;&lt;/a&gt; fixes, sstables are wrongly leveled. The patch will temporarily work around the problem though.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;since you already scrubbed online which will catch out-of-order within an sstable&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Online scrub can&apos;t fix out-of-order sstables since they won&apos;t be loaded in the first place, unless it has somehow has escaped from IntervalTree&apos;s assumption that sstables are sorted. &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt;&lt;/p&gt;


&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4321?focusedCommentId=13295704&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13295704&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-4321?focusedCommentId=13295704&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13295704&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13455789" author="jbellis" created="Fri, 14 Sep 2012 13:48:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;Online scrub can&apos;t fix out-of-order sstables &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, but it fixes rows that are out of order &lt;b&gt;within&lt;/b&gt; a given sstable.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;compaction strategy was changed to LCS after upgrading to 1.1.4 so it looks like even with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4321&quot; title=&quot;stackoverflow building interval tree &amp;amp; possible sstable corruptions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4321&quot;&gt;&lt;del&gt;CASSANDRA-4321&lt;/del&gt;&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4411&quot; title=&quot;Assertion with LCS compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4411&quot;&gt;&lt;del&gt;CASSANDRA-4411&lt;/del&gt;&lt;/a&gt; fixes, sstables are wrongly leveled&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I see.&lt;/p&gt;</comment>
                            <comment id="13456137" author="rvanderleeden" created="Fri, 14 Sep 2012 21:03:43 +0000"  >&lt;p&gt;Following the hint of Johathan I did the following:&lt;/p&gt;

&lt;p&gt;(1) nodetool scrub  (online)  ==&amp;gt; (3h:36m) OK&lt;br/&gt;
(2) sstablescrub -m (offline) ==&amp;gt; (5m)  For 5 SSTables there is a message like:&lt;br/&gt;
    Sending SSTableReader(path=&apos;XXX-Data.db&apos;) back to L0 to fix intra-level overlapping&lt;br/&gt;
(3) nodetool compact  ==&amp;gt; (10h:15m) OK&lt;/p&gt;

&lt;p&gt;Result: All 11737 SSTables have been successfully compacted to 4357 files.&lt;br/&gt;
(I did NOT install the patch).&lt;/p&gt;

&lt;p&gt;It looks like everything is fine now. Thanks for your help!&lt;/p&gt;
</comment>
                            <comment id="13457147" author="slebresne" created="Mon, 17 Sep 2012 16:55:59 +0000"  >&lt;p&gt;Regarding Jonathan&apos;s patch: that&apos;s a good idea though the condition in the patch is reversed. It should be:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if (previous != null &amp;amp;&amp;amp; current.first.compareTo(previous.last) &amp;lt;= 0)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;(i.e. we send back if the new start is smaller than that the previous end).&lt;/p&gt;

&lt;p&gt;Other than that, lgtm.&lt;/p&gt;</comment>
                            <comment id="13457180" author="jbellis" created="Mon, 17 Sep 2012 17:38:25 +0000"  >&lt;p&gt;Committed with &amp;lt;= fix.&lt;/p&gt;

&lt;p&gt;(Marking this issue &quot;can&apos;t reproduce&quot; referring to the original report of overlapping sstables caused by 1.1.4.)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12545059" name="4644.txt" size="4626" author="jbellis" created="Thu, 13 Sep 2012 21:34:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>256312</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 10 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gy1b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96944</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>