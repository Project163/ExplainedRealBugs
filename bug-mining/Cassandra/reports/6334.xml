<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:28:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18317] Properly synchronize CQLSSTableWriter#build on the Schema.instance</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18317</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The &lt;tt&gt;CQLSSTableWriter#build&lt;/tt&gt; method should properly synchronize on the &lt;tt&gt;Schema.instance&lt;/tt&gt; class to prevent concurrent Schema operations fail, &lt;span class=&quot;error&quot;&gt;&amp;#91;when the offline tool also updates schema&amp;#93;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;For example, a table creation operation, which modifies the keyspaces tables metadata, might end up missing the update when a concurrent call to the &lt;tt&gt;CQLSSTableWriter#build&lt;/tt&gt; method is accessing the &lt;tt&gt;Schema&lt;/tt&gt; instance.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13527872">CASSANDRA-18317</key>
            <summary>Properly synchronize CQLSSTableWriter#build on the Schema.instance</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="frankgh">Francisco Guerrero</assignee>
                                    <reporter username="frankgh">Francisco Guerrero</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Mar 2023 19:32:21 +0000</created>
                <updated>Fri, 27 Oct 2023 18:56:39 +0000</updated>
                            <resolved>Tue, 10 Oct 2023 08:58:11 +0000</resolved>
                                        <fixVersion>4.0.12</fixVersion>
                                    <component>Tool/bulk load</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="8400">2h 20m</timespent>
                                <comments>
                            <comment id="17698717" author="frankgh" created="Fri, 10 Mar 2023 03:41:43 +0000"  >&lt;p&gt;The issue seems to be resolved in trunk, I&apos;ve added a PR against trunk with only the unit tests, but it is still desirable to fix this in 4.0 and 4.1&lt;br/&gt;
PR (trunk) : &lt;a href=&quot;https://github.com/apache/cassandra/pull/2207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2207&lt;/a&gt;&lt;br/&gt;
CI  (trunk) : &lt;a href=&quot;https://app.circleci.com/pipelines/github/frankgh/cassandra/119&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/frankgh/cassandra/119&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;PR (4.0) : &lt;a href=&quot;https://github.com/apache/cassandra/pull/2208&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2208&lt;/a&gt;&lt;br/&gt;
CI  (4.0) : &lt;a href=&quot;https://app.circleci.com/pipelines/github/frankgh/cassandra/118&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/frankgh/cassandra/118&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17699071" author="frankgh" created="Fri, 10 Mar 2023 18:20:42 +0000"  >&lt;p&gt;4.1 is similar to trunk (not 4.0) so cherry-picked from trunk into 4.1&lt;/p&gt;

&lt;p&gt;PR (4.1) : &lt;a href=&quot;https://github.com/apache/cassandra/pull/2211&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2211&lt;/a&gt;&lt;br/&gt;
CI  (4.1) : &lt;a href=&quot;https://app.circleci.com/pipelines/github/frankgh/cassandra/121&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/frankgh/cassandra/121&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17704527" author="ifesdjeen" created="Fri, 24 Mar 2023 09:01:35 +0000"  >&lt;p&gt;I agree that adding &lt;tt&gt;synchronized&lt;/tt&gt; fixes the issue, but I think the core of the problem is that &lt;tt&gt;Schema#load&lt;/tt&gt; is not atomic in 4.0 and we should probably disallow it and switch to &lt;tt&gt;cas&lt;/tt&gt; or an interface similar to what is available in trunk with transformations (see &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/io/sstable/CQLSSTableWriter.java#L565&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/io/sstable/CQLSSTableWriter.java#L565&lt;/a&gt;). This way, all users of schema loading will not be able to overwrite anything written by someone else. An alternative to CAS can be an interface that allows your transformation code to run inside of synchronised block of schema load. Ive put rough prototypes of both ideas just to explore them &lt;a href=&quot;https://github.com/ifesdjeen/cassandra/tree/alter-example&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. I am weakly leaning to the second variant, as it is closer to trunk. But in general, I think that load in its current form should go away in 4.0 as well, and if we fix it by wrapping cql writer schema loading in a synchronised block, we are only fixing it for the cql writer, while leaving a possibility for other users of schema loading to overwrite keyspaces other users wrote.&lt;/p&gt;

&lt;p&gt;Thank you for spotting this issue.&lt;/p&gt;</comment>
                            <comment id="17751155" author="frankgh" created="Fri, 4 Aug 2023 15:41:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; thanks for looking into this and thanks for your ideas. I have reviewed carefully the ideas, and it makes a lot of sense. I am okay to go with either approach, however I feel like bringing this change into 4.0 might be more than what we want to do for a branch that is not actively being developed. Especially considering this is no longer an issue in 4.1 and 5.0. I&apos;m +0 on the CAS approaches you propose, but if you feel it&apos;s worth making this change in 4.0, I can go ahead and apply your suggestions to the PR. Let me know what your thoughts are on this.&lt;/p&gt;</comment>
                            <comment id="17762299" author="ifesdjeen" created="Wed, 6 Sep 2023 07:37:07 +0000"  >&lt;p&gt;Sorry for the dealay. Sure, I do not mind going forward with the &lt;tt&gt;synchronised&lt;/tt&gt; fix, even though I believe that the above fragment should mostly do the job modulo potential test fixes. It was just a suggestion from my side. &lt;/p&gt;</comment>
                            <comment id="17762711" author="frankgh" created="Thu, 7 Sep 2023 12:21:44 +0000"  >&lt;p&gt;Thanks for looking at it again &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;. Branch 5.0 has been created after I submitted the patches. Here&apos;s the PR for 5.0:&lt;/p&gt;

&lt;p&gt;PR (5.0): &lt;a href=&quot;https://github.com/apache/cassandra/pull/2675&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2675&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17773444" author="yifanc" created="Mon, 9 Oct 2023 18:25:43 +0000"  >&lt;p&gt;+1 on the fix patch in 4.0 and the test addition patches in the other branches. Thank you!&lt;/p&gt;</comment>
                            <comment id="17773524" author="maxwellguo" created="Tue, 10 Oct 2023 03:57:35 +0000"  >&lt;p&gt;+1 , and I think the CHANGE.txt need to update too. &lt;/p&gt;</comment>
                            <comment id="17773607" author="ifesdjeen" created="Tue, 10 Oct 2023 08:58:11 +0000"  >&lt;p&gt;Committed to 4.0 with &lt;a href=&quot;https://github.com/apache/cassandra/commit/26c374da4f03e4a6b64e414805cd92f3eb0a36c6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;26c374da4f03e4a6b64e414805cd92f3eb0a36c6 &lt;/a&gt;, and merged up to &lt;a href=&quot;https://github.com/apache/cassandra/commit/26c374da4f03e4a6b64e414805cd92f3eb0a36c6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.1&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra/commit/8b941a6bdc826207e18a08c09e2ee4166f6e6d0d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5.0&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/commit/4b84c4332c3043b31fd33c4d8dc2d7f2771c90da&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Not specifying fix versions above 4.0.x since this is a testonly commit for those branches.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[frankgh]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="13161" cascade-level="1"><![CDATA[Unrecoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 5 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1gh28:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
        <customfieldvalue><![CDATA[maxwellguo]]></customfieldvalue>
        <customfieldvalue><![CDATA[yifanc]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/26c374da4f03e4a6b64e414805cd92f3eb0a36c6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/26c374da4f03e4a6b64e414805cd92f3eb0a36c6&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Added unit tests that surface the issue.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>