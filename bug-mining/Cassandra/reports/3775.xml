<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:57:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10181] Deadlock flushing tables with CUSTOM indexes</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10181</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In 3.0, if a table with a CUSTOM secondary index is force flushed, Cassandra will deadlock while attempting to perform a blocking flush on the tables backing the secondary indexes.&lt;/p&gt;

&lt;p&gt;The basic problem is that the base table&apos;s post-flush task ends up waiting on the post-flush task for the secondary index to complete.  However, since the post-flush executor is single-threaded, this results in a deadlock.&lt;/p&gt;

&lt;p&gt;Here&apos;s the partial stacktrace for the base table part of this (line numbers may not be 100% accurate):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.cassandra.db.ColumnFamilyStore.forceBlockingFlush(ColumnFamilyStore.java:927)
	at org.apache.cassandra.index.internal.CustomIndex.lambda$getBlockingFlushTask$0(VertexCentricIndex.java:114)
	at org.apache.cassandra.index.internal.CustomIndex$$Lambda$95/057902870.call(Unknown Source)
	at java.util.concurrent.FutureTask.run(FutureTask.java:266)
	at com.google.common.util.concurrent.MoreExecutors$DirectExecutorService.execute(MoreExecutors.java:299)
	at java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:134)
	at com.google.common.util.concurrent.AbstractListeningExecutorService.submit(AbstractListeningExecutorService.java:58)
	at com.google.common.util.concurrent.AbstractListeningExecutorService.submit(AbstractListeningExecutorService.java:37)
	at org.apache.cassandra.index.SecondaryIndexManager.lambda$executeAllBlocking$39(SecondaryIndexManager.java:896)
	at org.apache.cassandra.index.SecondaryIndexManager$$Lambda$94/25774682.accept(Unknown Source)
	at java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1374)
	at java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:580)
	at org.apache.cassandra.index.SecondaryIndexManager.executeAllBlocking(SecondaryIndexManager.java:893)
	at org.apache.cassandra.index.SecondaryIndexManager.flushIndexesBlocking(SecondaryIndexManager.java:346)
	at org.apache.cassandra.index.SecondaryIndexManager.flushAllCustomIndexesBlocking(SecondaryIndexManager.java:358)
	at org.apache.cassandra.db.ColumnFamilyStore$PostFlush.run(ColumnFamilyStore.java:960)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;First, note that the base of this stacktrace is in CFS$PostFlush.run(), which means it&apos;s running on the post-flush executor.  When &lt;tt&gt;CFS.forceBlockingFlush()&lt;/tt&gt; is called on the secondary index table, we end up blocking on another task that&apos;s submitted to the post-flush executor.  Since that executor is single-threaded and is already running the base table task, this results in deadlock.&lt;/p&gt;

&lt;p&gt;The attached patch includes a unit test and custom secondary index class (basically just KeysIndex) to reproduce the issue.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12858725">CASSANDRA-10181</key>
            <summary>Deadlock flushing tables with CUSTOM indexes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="thobbs">Tom Hobbs</reporter>
                        <labels>
                    </labels>
                <created>Tue, 25 Aug 2015 18:46:42 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:58 +0000</updated>
                            <resolved>Wed, 26 Aug 2015 08:35:25 +0000</resolved>
                                        <fixVersion>3.0 beta 2</fixVersion>
                                    <component>Legacy/CQL</component>
                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14712014" author="beobal" created="Tue, 25 Aug 2015 21:31:07 +0000"  >&lt;p&gt;I think this has always been an issue, it probably hasn&apos;t been a problem until now as we enforced a check in &lt;tt&gt;SIM#addIndexedColumn&lt;/tt&gt; that a custom index didn&apos;t extend &lt;tt&gt;AbstractSimplePerColumnSecondaryIndex&lt;/tt&gt;. Aside from that though, I think if one had been sufficiently motivated to write one, I think a CFS backed custom index would have deadlocked earlier versions too. &lt;/p&gt;

&lt;p&gt;In the linked branch, I&apos;ve modified the post flush task to force flush non-CFS backed indexes, rather than all custom indexes. I was expected to have to modify &lt;tt&gt;CFS#concatWithIndexes&lt;/tt&gt; to so that it would include CFS backed custom indexes in the actual flush task but it was already doing so, which is another latent bug (although now it&apos;s actually the right thing to do). The branch is built on your patch from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10180&quot; title=&quot;Secondary index tables are flushed twice&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10180&quot;&gt;&lt;del&gt;CASSANDRA-10180&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Patches:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/10181-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 branch&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/10181-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk branch&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;CI Tests:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-10181-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 testall&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-10181-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 dtest&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-10181-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk testall&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/beobal/job/beobal-10181-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk dtest&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14712042" author="thobbs" created="Tue, 25 Aug 2015 21:52:27 +0000"  >&lt;p&gt;Assuming the test results look good when they complete, +1 from me on the code changes.&lt;/p&gt;</comment>
                            <comment id="14712702" author="beobal" created="Wed, 26 Aug 2015 08:35:25 +0000"  >&lt;p&gt;Thanks, committed to 3.0 in &lt;tt&gt;715c1513c322ea627163027c65785ea99f7d526d&lt;/tt&gt;.&lt;br/&gt;
There was an error with one of the index utests on the 3.0 branch, but I&apos;ve run it 10x locally without reproing, and it didn&apos;t appear in the trunk testall run. &lt;br/&gt;
There was also a pig test which timed out on the 3.0 branch (&lt;tt&gt;CqlTableTest&lt;/tt&gt;). This appears not to have run on either the 10181-trunk or the mainline 3.0/trunk branches. When I run that test locally, I see the same timeout on both my 10181-3.0 and mainline 3.0 branches. The test log is full of errors being thrown from the driver, but it&apos;s unclear what the root cause of those are. I&apos;ll open a separate ticket to look into that.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12752287" name="flush-deadlock-repro.txt" size="29495" author="thobbs" created="Tue, 25 Aug 2015 18:46:42 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 12 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2jcwn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>