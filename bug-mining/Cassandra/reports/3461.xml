<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:50 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9070] Race in cancelling compactions</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9070</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;seems we might have a race situation when cancelling compactions&lt;/p&gt;

&lt;p&gt;currently we do the following to ensure that we don&apos;t start any new compactions when we try to do markAllCompacting()&lt;/p&gt;

&lt;ol&gt;
	&lt;li&gt;pause compactions - this makes sure we don&apos;t create any new compaction tasks from the compaction strategies&lt;/li&gt;
	&lt;li&gt;cancel any ongoing compactions - compactions register themselves with the CompactionMetrics and then, when cancelling we get all compactions here, and tell them to stop&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Problem is that there is a window between when the CompactionTask is created and when it is registered in CompactionMetrics meaning with a bit of bad luck, we could have a situation like this:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;we finish a compaction and create a new CompactionTask from the compaction strategy&lt;/li&gt;
	&lt;li&gt;we pause the compaction strategies to not create any new CompactionTasks&lt;/li&gt;
	&lt;li&gt;we cancel all ongoing compactions&lt;/li&gt;
	&lt;li&gt;The CompactionTask created in #1 above registers itself in CompactionMetrics and misses that it should be cancelled&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="12786683">CASSANDRA-9070</key>
            <summary>Race in cancelling compactions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                    </labels>
                <created>Mon, 30 Mar 2015 12:01:36 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:16 +0000</updated>
                            <resolved>Wed, 1 Apr 2015 12:44:07 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14388280" author="krummas" created="Tue, 31 Mar 2015 09:06:41 +0000"  >&lt;p&gt;attaching tiny hack to check if we are paused before starting the compaction&lt;/p&gt;</comment>
                            <comment id="14388695" author="yukim" created="Tue, 31 Mar 2015 15:20:58 +0000"  >&lt;p&gt;I think there is still a chance that &lt;tt&gt;ColumnFamilyStore#markAllCompacting()&lt;/tt&gt; can throw AE after this patch.&lt;br/&gt;
If &lt;tt&gt;CompactionTask&lt;/tt&gt; is already queued with &apos;marked&apos; SSTables, those SSTables are not unmarked until the task actually runs.&lt;/p&gt;

&lt;p&gt;If we really want to cancel all the things, we need to cancel all the task in the queue and release resources associated with.&lt;/p&gt;</comment>
                            <comment id="14388874" author="krummas" created="Tue, 31 Mar 2015 17:20:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;If CompactionTask is already queued with &apos;marked&apos; SSTables&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think that would still work (unless I misunderstood you comment) - for background compactions we queue up BackgroundCompactionTasks and don&apos;t actually ask for the compaction task until the BGTask executes, and any other compactions would start executing and throw CompactionException since we are paused and release any sstables they have&lt;/p&gt;</comment>
                            <comment id="14388934" author="yukim" created="Tue, 31 Mar 2015 17:47:13 +0000"  >&lt;p&gt;You are right. It&apos;s &lt;tt&gt;BackgroundCompactionTask&lt;/tt&gt; that&apos;s queued.&lt;br/&gt;
Cancelling minor compaction seems good with the patch.&lt;br/&gt;
+1.&lt;/p&gt;</comment>
                            <comment id="14390488" author="krummas" created="Wed, 1 Apr 2015 12:44:07 +0000"  >&lt;p&gt;committed, thanks&lt;/p&gt;</comment>
                            <comment id="14519849" author="philipthompson" created="Wed, 29 Apr 2015 18:03:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;, is it feasible to add a unit test for this?&lt;/p&gt;</comment>
                            <comment id="14519874" author="krummas" created="Wed, 29 Apr 2015 18:19:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=philipthompson&quot; class=&quot;user-hover&quot; rel=&quot;philipthompson&quot;&gt;philipthompson&lt;/a&gt; I would be really hard as I was never really able to reproduce this, I&apos;ll have a closer look tomorrow&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12708389" name="0001-check-if-we-are-paused-before-starting-compaction.patch" size="1103" author="marcuse" created="Tue, 31 Mar 2015 09:06:41 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 29 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i27j87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>