<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:00:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10979] LCS doesn&apos;t do L0 STC on new tables while an L0-&gt;L1 compaction is in progress</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10979</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Reading code from &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.1/src/java/org/apache/cassandra/db/compaction/LeveledManifest.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-2.1/src/java/org/apache/cassandra/db/compaction/LeveledManifest.java&lt;/a&gt; and comparing with behavior shown in &lt;a href=&quot;https://gist.github.com/autocracy/c95aca6b00e42215daaf&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/autocracy/c95aca6b00e42215daaf&lt;/a&gt;, the following happens:&lt;/p&gt;

&lt;p&gt;Score for L1,L2,and L3 is all &amp;lt; 1 (paste shows 20/10 and 200/100, due to incremental repair).&lt;/p&gt;

&lt;p&gt;Relevant code from here is&lt;/p&gt;

&lt;p&gt;    if (Sets.intersection(l1overlapping, compacting).size() &amp;gt; 0)&lt;br/&gt;
        return Collections.emptyList();&lt;/p&gt;

&lt;p&gt;Since there will be overlap between what is compacting and L1 (in my case, pushing over 1,000 tables in to L1 from L0 SCTS), I get a pile up of 1,000 smaller tables in L0 while awaiting the transition from L0 to L1 and destroy my performance.&lt;/p&gt;

&lt;p&gt;Requested outcome is to continue to perform SCTS on non-compacting L0 tables.&lt;/p&gt;</description>
                <environment>&lt;p&gt;2.1.11 / 4.8.3 DSE.&lt;/p&gt;</environment>
        <key id="12928185">CASSANDRA-10979</key>
            <summary>LCS doesn&apos;t do L0 STC on new tables while an L0-&gt;L1 compaction is in progress</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="carlyeks">Carl Yeksigian</assignee>
                                    <reporter username="autocracy">Jeff Ferland</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>lcs</label>
                            <label>leveled</label>
                    </labels>
                <created>Thu, 7 Jan 2016 00:29:49 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:58 +0000</updated>
                            <resolved>Fri, 22 Jan 2016 06:36:14 +0000</resolved>
                                        <fixVersion>2.1.14</fixVersion>
                    <fixVersion>2.2.5</fixVersion>
                    <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.3</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="15087919" author="autocracy" created="Thu, 7 Jan 2016 19:24:38 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;src/java/org/apache/cassandra/db/compaction/LeveledManifest.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/src/java/org/apache/cassandra/db/compaction/LeveledManifest.java b/src/java/org/apache/cassandra/db/compaction/LeveledManifest.java
index 1e67a9e..ed45a63 100644
--- a/src/java/org/apache/cassandra/db/compaction/LeveledManifest.java
+++ b/src/java/org/apache/cassandra/db/compaction/LeveledManifest.java
@@ -602,6 +602,8 @@ &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;LeveledManifest
                 candidates = Sets.union(candidates, l1overlapping);
             }
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (candidates.size() &amp;lt; 2)
+                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!DatabaseDescriptor.getDisableSTCSInL0() &amp;amp;&amp;amp; remaining.size() &amp;gt; MAX_COMPACTING_L0)
+                    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; getSSTablesForSTCS(remaining)
                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Collections.emptyList();
             &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                 &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; candidates;

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15088139" author="autocracy" created="Thu, 7 Jan 2016 21:24:26 +0000"  >&lt;p&gt;Debug logging using the current (unpatched) code: &lt;a href=&quot;https://gist.github.com/autocracy/346afa253175af475770&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/autocracy/346afa253175af475770&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15088274" author="sebastian.estevez@datastax.com" created="Thu, 7 Jan 2016 22:32:13 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; I mentioned this briefly this morning over chat but now we have more information. Specifically we observe a large L0 to L1 compaction that blocks additional L0 STCS compactions, probably because the remaining L0 sstables overlap compactingL0. &lt;/p&gt;

&lt;p&gt;You can see in the log above that &lt;blockquote&gt;&lt;p&gt;L0 is too far behind, performing size-tiering there first&lt;/p&gt;&lt;/blockquote&gt; does not appear. What do you think?&lt;/p&gt;</comment>
                            <comment id="15089409" author="carlyeks" created="Fri, 8 Jan 2016 16:02:00 +0000"  >&lt;p&gt;Because we will drop out of the method early due to the overlapping L1 sstables at &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.1/src/java/org/apache/cassandra/db/compaction/LeveledManifest.java#L598&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;L598&lt;/a&gt;, this won&apos;t return the proper set of sstables. We also need to make sure that we are returning a &lt;tt&gt;CompactionCandidate&lt;/tt&gt; which will compact to L0, otherwise we will create overlapping sstables in L1.&lt;/p&gt;

&lt;p&gt;I&apos;ve attached a new patch which factors out the selection of the STCS compaction, and if we don&apos;t select anything in L0 to compact, we will check to see if we should perform an STCS compaction.&lt;/p&gt;</comment>
                            <comment id="15093818" author="krummas" created="Tue, 12 Jan 2016 12:31:45 +0000"  >&lt;p&gt;This LGTM, could you push a branch so we get the test runs in?&lt;/p&gt;

&lt;p&gt;And, should we really target 2.1 for this?&lt;/p&gt;</comment>
                            <comment id="15094277" author="carlyeks" created="Tue, 12 Jan 2016 16:57:45 +0000"  >&lt;p&gt;I pushed them; forgot to link the tests here.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/carlyeks/cassandra/tree/ticket/10979/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/carlyeks/job/carlyeks-ticket-10979-trunk-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/carlyeks/job/carlyeks-ticket-10979-trunk-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Good point on not targeting 2.1; since this is an improvement and not a bugfix, we should only target trunk for this fix.&lt;/p&gt;</comment>
                            <comment id="15094350" author="autocracy" created="Tue, 12 Jan 2016 17:31:16 +0000"  >&lt;p&gt;The problem I&apos;ve got and why I considered it a bug is that the behavior as it is right now doesn&apos;t appear to be as it was intended, and particularly negative for me is that it destroys performance of my cluster by an order of magnitude with LCS tables during a repair as potentially thousands of tables build up in L0.&lt;/p&gt;</comment>
                            <comment id="15095112" author="JIRAUSER308715" created="Tue, 12 Jan 2016 22:33:57 +0000"  >&lt;p&gt;Agree with Jeff here. This seems like a bug in the intended behavior that we should at least fix in 2.2+, since it&apos;s not a critical bug fix to go in 2.1.&lt;/p&gt;</comment>
                            <comment id="15095881" author="krummas" created="Wed, 13 Jan 2016 09:40:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=autocracy&quot; class=&quot;user-hover&quot; rel=&quot;autocracy&quot;&gt;autocracy&lt;/a&gt; have you confirmed that the patch fixes your issue?&lt;/p&gt;

&lt;p&gt;I would assume that any slowdown after incremental repair is due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10831&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-10831&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15096481" author="carlyeks" created="Wed, 13 Jan 2016 16:28:59 +0000"  >&lt;p&gt;I&apos;m fine with this going in 2.2 as it&apos;s not an intrusive fix, but I also think this is more of an improvement than a bug fix.&lt;/p&gt;

&lt;p&gt;While this will reduce the number of sstables on a read when L0 is backed up, the problem remains that L0 cannot keep up with the amount of incoming data. Once we finish the L0-&amp;gt;L1 compaction, we will be running the L0 STCS since we will have a level that is oversized which will also cause us to check L0 again.&lt;/p&gt;</comment>
                            <comment id="15098279" author="autocracy" created="Thu, 14 Jan 2016 15:48:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sebastian.estevez%40datastax.com&quot; class=&quot;user-hover&quot; rel=&quot;sebastian.estevez@datastax.com&quot;&gt;sebastian.estevez@datastax.com&lt;/a&gt;: Can you cut a build of DSE 4.8.4 with this patch added? I&apos;ll try my best to test within a week.&lt;/p&gt;</comment>
                            <comment id="15109177" author="autocracy" created="Wed, 20 Jan 2016 19:01:25 +0000"  >&lt;p&gt;Applied the patch to a node that had just come up from streaming and was 700+ tables in L0. After restart, observed that as L0 was shifted into L1, L0 continued to compact new tables to prevent the extreme growth of tables.&lt;/p&gt;

&lt;p&gt;Thank you. Again still requesting a merge into 2.1 since streaming and repair with LCS are practically broken for us without this patch.&lt;/p&gt;</comment>
                            <comment id="15109648" author="carlyeks" created="Wed, 20 Jan 2016 22:50:10 +0000"  >&lt;p&gt;I&apos;ve rebased and pushed up new 2.2-trunk branches.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.3&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/carlyeks/cassandra/tree/ticket/10979/2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/carlyeks/cassandra/tree/ticket/10979/3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/carlyeks/cassandra/tree/ticket/10979/3.3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/carlyeks/cassandra/tree/ticket/10979/trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/carlyeks/job/carlyeks-ticket-10979-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/carlyeks/job/carlyeks-ticket-10979-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/carlyeks/job/carlyeks-ticket-10979-3.3-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/carlyeks/job/carlyeks-ticket-10979-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/carlyeks/job/carlyeks-ticket-10979-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/carlyeks/job/carlyeks-ticket-10979-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/carlyeks/job/carlyeks-ticket-10979-3.3-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/carlyeks/job/carlyeks-ticket-10979-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15112006" author="krummas" created="Fri, 22 Jan 2016 06:36:14 +0000"  >&lt;p&gt;committed to 2.2+ - &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=autocracy&quot; class=&quot;user-hover&quot; rel=&quot;autocracy&quot;&gt;autocracy&lt;/a&gt;, the 2.1 patch still applies if you can&apos;t upgrade to 2.2&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12781237" name="10979-2.1.txt" size="2808" author="carlyeks" created="Fri, 8 Jan 2016 16:02:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 43 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2qymf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>