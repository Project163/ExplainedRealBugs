<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:46:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7059] Range query with strict bound on clustering column can return less results than required for compact tables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7059</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;What&apos;s wrong:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE test (
    k int,
    v int,
    PRIMARY KEY (k, v)
) WITH COMPACT STORAGE;

INSERT INTO test(k, v) VALUES (0, 0);
INSERT INTO test(k, v) VALUES (0, 1);
INSERT INTO test(k, v) VALUES (1, 0);
INSERT INTO test(k, v) VALUES (1, 1);
INSERT INTO test(k, v) VALUES (2, 0);
INSERT INTO test(k, v) VALUES (2, 1);

SELECT * FROM test WHERE v &amp;gt; 0 LIMIT 3 ALLOW FILTERING;

 k | v
---+---
 1 | 1
 0 | 1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;That last query should return 3 results.&lt;/p&gt;

&lt;p&gt;The problem lies into how we deal with &apos;strict greater than&apos; (&lt;tt&gt;&amp;gt;&lt;/tt&gt;) for &quot;wide&quot; compact storage table. Namely, for those tables, we internally only support inclusive bounds (for CQL3 tables this is not a problem as we deal with this using the &apos;end-of-component&apos; of the CompositeType encoding). So we &quot;compensate&quot; by asking one more result than asked by the user, and we trim afterwards if that was unnecessary. This works fine for per-partition queries, but don&apos;t for &quot;range&quot; queries since we potentially would have to ask for &lt;tt&gt;X&lt;/tt&gt; more results where &lt;tt&gt;X&lt;/tt&gt; is the number of partition fetched, but we don&apos;t know &lt;tt&gt;X&lt;/tt&gt; beforehand.&lt;/p&gt;

&lt;p&gt;I&apos;ll note that:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;this has always be there&lt;/li&gt;
	&lt;li&gt;this only (potentially) affect compact tables&lt;/li&gt;
	&lt;li&gt;this only affect range queries that have a strict bound on the clustering column (this means only &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt;) queries in particular.&lt;/li&gt;
	&lt;li&gt;this only matters if a &lt;tt&gt;LIMIT&lt;/tt&gt; is set on the query.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;As for fixes, it&apos;s not entirely trivial. The &quot;right&quot; fix would probably be to start supporting non-inclusive bound internally, but that&apos;s far from a small fix and is &quot;at best&quot; a 2.1 fix (since we&apos;ll have to make a messaging protocol change to ship some additional info for SliceQueryFilter). Also, this might be a lot of work for something that only affect some &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; queries on compact tables.&lt;/p&gt;

&lt;p&gt;Another (somewhat simpler) solution might be to detect when we have this kind of queries and use a pager with no limit. We would then query a first page using the user limit (plus some smudge factor to avoid being inefficient too often) and would continue paging unless either we&apos;ve exhausted all results or we can prove that post-processing we do have enough results to satisfy the user limit.  This does mean in some case we might do 2 or more internal queries, but in practice we can probably make that case very rare, and since the query is an &lt;tt&gt;ALLOW FILTERING&lt;/tt&gt; one, the user is somewhat warned that the query may not be terribly efficient.&lt;/p&gt;

&lt;p&gt;Lastly, we could always start by disallowing the kind of query that is potentially problematic (until we have a proper fix), knowing that users can work around that by either using non-strict bounds or removing the &lt;tt&gt;LIMIT&lt;/tt&gt;, whichever makes the most sense in their case. In 1.2 in particular, we don&apos;t have the query pagers, so the previous solution I describe would be a bit of a mess to implement.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12709527">CASSANDRA-7059</key>
            <summary>Range query with strict bound on clustering column can return less results than required for compact tables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Apr 2014 09:30:30 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:48 +0000</updated>
                            <resolved>Thu, 26 Jun 2014 08:13:18 +0000</resolved>
                                        <fixVersion>2.0.9</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13983089" author="christianmovi" created="Mon, 28 Apr 2014 15:14:01 +0000"  >&lt;p&gt;Is it possible that &quot;allow filtering&quot; is generally not allowed for compact storage tables? (due to this ticket?)&lt;/p&gt;</comment>
                            <comment id="13992866" author="slebresne" created="Thu, 8 May 2014 15:56:17 +0000"  >&lt;p&gt;As explained above, fixing this properly is actually pretty hard. Also, the cases affected feels narrow enough that we might want to think twice before adding too much complexity to solve this. But, without excluding any better solution later, I think that the first thing we should do is start refusing queries that we know might return broken results: correction should come first and we known we&apos;re not correct. So attaching a relatively trivial patch that does just that. If we agree on that first step I&apos;ll make sure to put the proper warnings in the NEWS file too.&lt;/p&gt;</comment>
                            <comment id="13992868" author="slebresne" created="Thu, 8 May 2014 15:57:49 +0000"  >&lt;p&gt;The attached patch is against 2.0. It likely apply to 1.2 as well and I&apos;m fine committing it there too, though since it&apos;s unclear how many 1.2 release we&apos;ll still have, I&apos;m happy to leave it alone too.&lt;/p&gt;</comment>
                            <comment id="14041478" author="iamaleksey" created="Mon, 23 Jun 2014 23:27:29 +0000"  >&lt;p&gt;Can you please rebase? Thanks.&lt;/p&gt;</comment>
                            <comment id="14043535" author="slebresne" created="Wed, 25 Jun 2014 14:28:35 +0000"  >&lt;p&gt;Rebased patch attached&lt;/p&gt;</comment>
                            <comment id="14044176" author="iamaleksey" created="Wed, 25 Jun 2014 23:38:09 +0000"  >&lt;p&gt;LGTM, +1&lt;/p&gt;</comment>
                            <comment id="14044447" author="slebresne" created="Thu, 26 Jun 2014 08:13:18 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="14056632" author="tjake" created="Wed, 9 Jul 2014 19:20:04 +0000"  >&lt;p&gt;Apparently this change breaks the CqlPagingRecordReader.  Can &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=alexliu68&quot; class=&quot;user-hover&quot; rel=&quot;alexliu68&quot;&gt;alexliu68&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; can you add a unit/integration test for this?  The BatchTest could serve as a prototype since it starts an embedded c* &lt;/p&gt;
</comment>
                            <comment id="14058967" author="alexliu68" created="Fri, 11 Jul 2014 16:36:52 +0000"  >&lt;p&gt;I got the following error for pig-test on 2.1 branch for a counter CF&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;create column family CC with &quot; +
                       &lt;span class=&quot;code-quote&quot;&gt;&quot;key_validation_class = UTF8Type and &quot;&lt;/span&gt; +
                       &lt;span class=&quot;code-quote&quot;&gt;&quot;default_validation_class=CounterColumnType &quot;&lt;/span&gt; +
                       &quot;and comparator=UTF8Type;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The cal query is &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM &lt;span class=&quot;code-quote&quot;&gt;&quot;CC&quot;&lt;/span&gt; WHERE token(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;) = token(?)  AND &lt;span class=&quot;code-quote&quot;&gt;&quot;column1&quot;&lt;/span&gt;  &amp;gt; ?  LIMIT 1000 ALLOW FILTERING
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    [junit] java.lang.RuntimeException
    [junit] 	at org.apache.cassandra.hadoop.cql3.CqlPagingRecordReader$RowIterator.executeQuery(CqlPagingRecordReader.java:665)
    [junit] 	at org.apache.cassandra.hadoop.cql3.CqlPagingRecordReader$RowIterator.computeNext(CqlPagingRecordReader.java:366)
    [junit] 	at org.apache.cassandra.hadoop.cql3.CqlPagingRecordReader$RowIterator.computeNext(CqlPagingRecordReader.java:289)
    [junit] 	at com.google.common.collect.AbstractIterator.tryToComputeNext(AbstractIterator.java:143)
    [junit] 	at com.google.common.collect.AbstractIterator.hasNext(AbstractIterator.java:138)
    [junit] 	at org.apache.cassandra.hadoop.cql3.CqlPagingRecordReader.getProgress(CqlPagingRecordReader.java:195)
    [junit] 	at org.apache.pig.backend.hadoop.executionengine.mapReduceLayer.PigRecordReader.getProgress(PigRecordReader.java:169)
    [junit] 	at org.apache.hadoop.mapred.MapTask$NewTrackingRecordReader.getProgress(MapTask.java:514)
    [junit] 	at org.apache.hadoop.mapred.MapTask$NewTrackingRecordReader.nextKeyValue(MapTask.java:539)
    [junit] 	at org.apache.hadoop.mapreduce.MapContext.nextKeyValue(MapContext.java:67)
    [junit] 	at org.apache.hadoop.mapreduce.Mapper.run(Mapper.java:143)
    [junit] 	at org.apache.hadoop.mapred.MapTask.runNewMapper(MapTask.java:764)
    [junit] 	at org.apache.hadoop.mapred.MapTask.run(MapTask.java:370)
    [junit] 	at org.apache.hadoop.mapred.LocalJobRunner$Job.run(LocalJobRunner.java:212)
    [junit] Caused by: InvalidRequestException(why:The query requests a restriction of rows with a strict bound (column1 &amp;gt; ?) over a range of partitions. This is not supported by the underlying storage engine &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; COMPACT tables &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; a LIMIT is provided. Please either make the condition non strict (column1 &amp;gt;= ?) or remove the user LIMIT)
    [junit] 	at org.apache.cassandra.thrift.Cassandra$prepare_cql3_query_result$prepare_cql3_query_resultStandardScheme.read(Cassandra.java:52282)
    [junit] 	at org.apache.cassandra.thrift.Cassandra$prepare_cql3_query_result$prepare_cql3_query_resultStandardScheme.read(Cassandra.java:52259)
    [junit] 	at org.apache.cassandra.thrift.Cassandra$prepare_cql3_query_result.read(Cassandra.java:52198)
    [junit] 	at org.apache.thrift.TServiceClient.receiveBase(TServiceClient.java:78)
    [junit] 	at org.apache.cassandra.thrift.Cassandra$Client.recv_prepare_cql3_query(Cassandra.java:1797)
    [junit] 	at org.apache.cassandra.thrift.Cassandra$Client.prepare_cql3_query(Cassandra.java:1783)
    [junit] 	at org.apache.cassandra.hadoop.cql3.CqlPagingRecordReader$RowIterator.prepareQuery(CqlPagingRecordReader.java:605)
    [junit] 	at org.apache.cassandra.hadoop.cql3.CqlPagingRecordReader$RowIterator.executeQuery(CqlPagingRecordReader.java:635)
    [junit] 	... 13 more
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14059600" author="appodictic" created="Sat, 12 Jul 2014 02:26:43 +0000"  >&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; WHERE token(&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;) = token(?)  
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I do not understand how any of these work under RP because the relationship from keys to tokens is many to one? If there are 1000 keys that map to the same token how do we page them. I think only paging keys is logically possible and always correct?&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12652429" name="7059.txt" size="4580" author="slebresne" created="Wed, 25 Jun 2014 14:28:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>387849</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 19 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ut9z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>388110</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12323243">1.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>