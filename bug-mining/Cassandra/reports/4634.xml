<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:06:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12539] Empty CommitLog prevents restart</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12539</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;A node just crashed (known cause: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11594&quot; title=&quot;Too many open files on directories&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11594&quot;&gt;&lt;del&gt;CASSANDRA-11594&lt;/del&gt;&lt;/a&gt;) but to my surprise (unlike other time) restarting simply fails.&lt;/p&gt;

&lt;p&gt;Checking the logs showed:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [main] 2016-08-25 17:05:22,611 JVMStabilityInspector.java:82 - Exiting due to error while processing commit log during initialization.
org.apache.cassandra.db.commitlog.CommitLogReplayer$CommitLogReplayException: Could not read commit log descriptor in file /data/cassandra/commitlog/CommitLog-6-1468235564433.log
	at org.apache.cassandra.db.commitlog.CommitLogReplayer.handleReplayError(CommitLogReplayer.java:650) [apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.commitlog.CommitLogReplayer.recover(CommitLogReplayer.java:327) [apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.commitlog.CommitLogReplayer.recover(CommitLogReplayer.java:148) [apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:181) [apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:161) [apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:289) [apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:557) [apache-cassandra-3.0.8.jar:3.0.8]
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:685) [apache-cassandra-3.0.8.jar:3.0.8]
INFO  [main] 2016-08-25 17:08:56,944 YamlConfigurationLoader.java:85 - Configuration location: file:/etc/cassandra/cassandra.yaml
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Deleting the empty file fixes the problem.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13000088">CASSANDRA-12539</key>
            <summary>Empty CommitLog prevents restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="ostefano">Stefano Ortolani</reporter>
                        <labels>
                    </labels>
                <created>Thu, 25 Aug 2016 17:15:24 +0000</created>
                <updated>Wed, 15 Oct 2025 09:48:59 +0000</updated>
                            <resolved>Fri, 10 Feb 2017 10:57:27 +0000</resolved>
                                        <fixVersion>2.2.9</fixVersion>
                    <fixVersion>3.0.11</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="15437690" author="ostefano" created="Thu, 25 Aug 2016 21:17:36 +0000"  >&lt;p&gt;Maybe related to: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11995&quot; title=&quot;Commitlog replaced with all NULs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11995&quot;&gt;&lt;del&gt;CASSANDRA-11995&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="15614667" author="anithrak" created="Fri, 28 Oct 2016 07:52:58 +0000"  >&lt;p&gt;It looks like a crash while writing the logfile can lead to a zero byte file. The following patch, which causes a crash after creating the buffer but before writing the header, produces a commit log full of zeros. This leads to the error described above when it tries to replay the commit log. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;diff --git a/src/java/org/apache/cassandra/db/commitlog/CommitLogSegment.java b/src/java/org/apache/cassandra/db/commitlog/CommitLogSegment.java
index 0a03c3c..20cddf8 100644
--- a/src/java/org/apache/cassandra/db/commitlog/CommitLogSegment.java
+++ b/src/java/org/apache/cassandra/db/commitlog/CommitLogSegment.java
@@ -153,6 +153,7 @@ public abstract class CommitLogSegment
         descriptor = new CommitLogDescriptor(id, commitLog.configuration.getCompressorClass());
         logFile = new File(commitLog.location, descriptor.fileName());
 +        logger.error(&quot;location=&quot;+descriptor.fileName());
         try
         {
             channel = FileChannel.open(logFile.toPath(), StandardOpenOption.WRITE, StandardOpenOption.READ, StandardOpenOption.CREATE);
@@ -164,6 +165,9 @@ public abstract class CommitLogSegment
         }
 
         buffer = createBuffer(commitLog);
+        if (true) {
+          throw new IllegalArgumentException(&quot;Here!&quot;);
+        }
         // write the header
         CommitLogDescriptor.writeHeader(buffer, descriptor);
         endOfBuffer = buffer.capacity();
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15614670" author="anithrak" created="Fri, 28 Oct 2016 07:53:28 +0000"  >&lt;p&gt;The following patch seems to fix the issue&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;diff --git a/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java b/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java
index af8efb4..8f11d13 100644
--- a/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java
+++ b/src/java/org/apache/cassandra/db/commitlog/CommitLogReplayer.java
@@ -226,7 +226,7 @@ public class CommitLogReplayer
         {
             if (end != 0 || filecrc != 0)
             {
-                handleReplayError(false,
+                handleReplayError(tolerateTruncation,
                                   &quot;Encountered bad header at position %d of commit log %s, with invalid CRC. &quot; +
                                   &quot;The end of segment marker should be zero.&quot;,
                                   offset, reader.getPath());
@@ -345,6 +345,14 @@ public class CommitLogReplayer
                 return;
             }
 
+
+            int currentFilePointer = (int) reader.getFilePointer();
+            if (readSyncMarker(desc, currentFilePointer, reader, true) &amp;lt; 0) {
+                logger.info(&quot;Skipping empty logfile {}&quot;, file.getName());
+                return;
+            }
+            reader.seek(currentFilePointer);
+
             final long segmentId = desc.id;
             try
             {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15615311" author="blerer" created="Fri, 28 Oct 2016 12:58:11 +0000"  >&lt;p&gt;What happened is that the node crashed while a new commit log segment why Cassandra was trying to get a new file pointer to resize the commit log segment.&lt;br/&gt;
Neverthess, it is the expected behaviour that Cassandra should not start if some commitlog segments are empty (there are some tests that check that behaviour).&lt;br/&gt;
An empty commitlog is a sign of a problem but Cassandra as no way to determine the root cause of the problem that is why it will not start and notify the administrator. &lt;/p&gt;
</comment>
                            <comment id="15616594" author="anithrak" created="Fri, 28 Oct 2016 21:10:54 +0000"  >&lt;p&gt;There seems to be a very easy way to reproduce this condition - so it seems like Cassandra should be able to handle this case without needing manual intervention at each occurrence. Especially when it gets deployed in an enterprise setting, when services are expected to auto heal. &lt;/p&gt;</comment>
                            <comment id="15621732" author="blerer" created="Mon, 31 Oct 2016 09:40:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;There seems to be a very easy way to reproduce this condition&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Which condition? Having an empty commit log segment?&lt;br/&gt;
An empty commit log segment can occurs for different reasons. Running out of file pointers is only one of them. Cassandra has no way to know that it has an empty commit log segment because it run out of file pointers before crashing. An empty commit log segment might have been caused by another problem were you actually lost some data. In this case, you will actually want to be notify of the problem.&lt;/p&gt;

&lt;p&gt;Now, the real problem here is not that Cassandra does not ignore empty commit log in startup. It is that it should not create an empty commit log in this corner case. I will look at what I can do about it. &lt;/p&gt;

</comment>
                            <comment id="15858248" author="blerer" created="Wed, 8 Feb 2017 17:11:02 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:12539-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-12539-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-12539-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:12539-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-12539-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-12539-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:12539-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-12539-3.11-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-12539-3.11-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:12539-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-12539-trunk-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/blerer/job/blerer-12539-trunk-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The patches for 2.2 and 3.0 are the same and the patches for 3.11 and trunk arethe same.&lt;/p&gt;

&lt;p&gt;The patch removes the use of &lt;tt&gt;RandomAccessFile&lt;/tt&gt; to resize the commitlog segment file.&lt;br/&gt;
As we do not recycle the CommitLog files in 2.2, it is not needed anymore. The creation of the &lt;tt&gt;MappedByteBuffer&lt;/tt&gt; will automatically set the size of the file to &lt;tt&gt;DatabaseDescriptor.getCommitLogSegmentSize()&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;By not using an extra file pointer with the &lt;tt&gt;RandomAccessFile&lt;/tt&gt;, we avoid the problem that had cause the empty commit log (which was running out of file pointers when resizing the file segement).&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JoshuaMcKenzie&quot; class=&quot;user-hover&quot; rel=&quot;JoshuaMcKenzie&quot;&gt;JoshuaMcKenzie&lt;/a&gt; do you want to review it? &lt;/p&gt;</comment>
                            <comment id="15858384" author="jmckenzie" created="Wed, 8 Feb 2017 18:50:52 +0000"  >&lt;p&gt;Sure - should be able to get to this tomorrow.&lt;/p&gt;</comment>
                            <comment id="15860269" author="jmckenzie" created="Thu, 9 Feb 2017 21:53:51 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15861101" author="blerer" created="Fri, 10 Feb 2017 10:57:27 +0000"  >&lt;p&gt;Committed into 2.2 at 7680aebf10c34b05a24bdc925196038818ec5126 and merged into 3.0, 3.11 and trunk &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 40 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i32sqn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>joshuamckenzie</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[joshuamckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>