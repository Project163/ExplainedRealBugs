<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:12:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14843] Drop/add column name with different Kind can result in corruption</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14843</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;While we have always imposed that the type of any column name remains consistent, we have not done the same for its kind.  If a column&#8217;s kind is changed via Drop/Add, the SerializationHeader&#8217;s column sets will be interpreted incorrectly, and may either lead to CorruptSSTableException or silent data corruption.&lt;/p&gt;

&lt;p&gt;The problem occurs in SerializationHeader.Component.toHeader().  In this method, we lookup columns from the metadata only by name, ignoring the static status.  If a column of the same name but different kind to our dropped column exists in the schema, we will only add this column to the list of fields we expect.  So we will be missing a column from our set of expected static columns.  We will also add the regular variant to the set of regular columns present, which it may not be.&lt;/p&gt;

&lt;p&gt;There are a number of ways this can play out:&lt;/p&gt;

&lt;p&gt;1) There are no other static columns in the affected sstables.  In this case we will incorrectly treat the table as containing no static data, so we will not attempt to read any static row.  This leaves a static row to be read as the first regular row, and will throw the exception in the description.&lt;br/&gt;
1a) If for some reason the static row is absent - say, it has expired - then depending on lexicographical ordering, and if the sstable did not contain any instance of the regular variant, we may misattribute column data.  This will probably result in corruption exceptions, but if the columns were of the same type it could be undetectable.&lt;br/&gt;
2) There are other static columns on the table, and in the affected sstables.  In this case, the row will be correctly treated as a static row, but depending on the dropped column&#8217;s lexicographical position relative to these, it may result in column data being misattributed to other columns.  This &lt;b&gt;could&lt;/b&gt; be undetectable corruption, if the column types were the same.&lt;br/&gt;
3) Either of these above scenario could be replayed with the static/regular relations replaced.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14591&quot; title=&quot;Throw exception if Columns serialized subset encode more columns than possible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14591&quot;&gt;&lt;del&gt;CASSANDRA-14591&lt;/del&gt;&lt;/a&gt; would protect against 1a and 2.&lt;/p&gt;

&lt;p&gt;Probably the safest and correct fix is to prevent adding a column back with a different kind to the original, however this would require storing more metadata about dropped columns.  This is probably viable for 4.0, but for 3.0 perhaps too invasive. &lt;/p&gt;

&lt;p&gt;It is quite easy to make this particular method safe against this particular corruption.  However it is hard to be certain there aren&#8217;t other places where assumptions were made about a name being of only one kind.  There are only a handful of places that &lt;b&gt;should&lt;/b&gt; need to be of concern, specifically those places that invoke CFMetaData.getDroppedColumn, so we should be fairly confident that - if these call sites are safe - we are now insulated.  This might suffice for 3.0.  Thoughts?&lt;/p&gt;</description>
                <environment></environment>
        <key id="13193916">CASSANDRA-14843</key>
            <summary>Drop/add column name with different Kind can result in corruption</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Oct 2018 16:44:53 +0000</created>
                <updated>Fri, 2 Aug 2019 02:44:55 +0000</updated>
                            <resolved>Thu, 29 Nov 2018 14:56:33 +0000</resolved>
                                        <fixVersion>3.0.18</fixVersion>
                                    <component>CQL/Semantics</component>
                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="16662569" author="iamaleksey" created="Wed, 24 Oct 2018 17:12:45 +0000"  >&lt;p&gt;Yep.&lt;/p&gt;

&lt;p&gt;Too invasive for 3.0, but trivial to prevent re-addition of columns with a different kind in 4.0, as we do store the kind of dropped columns in 4.0 since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9425&quot; title=&quot;Make node-local schema fully immutable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9425&quot;&gt;&lt;del&gt;CASSANDRA-9425&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="16700911" author="benedict" created="Tue, 27 Nov 2018 19:39:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/14843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 patch&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/belliottsmith/cassandra/tree/14843&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16703045" author="beobal" created="Thu, 29 Nov 2018 11:18:32 +0000"  >&lt;p&gt;+1 - there&apos;s an additional/unexpected dtest failure in &lt;tt&gt;putget_test.py::TestPutGet::test_wide_slice&lt;/tt&gt;, but I&apos;ve observed this failing on 3.0 yesterday, so I&apos;m planning to investigate that separately.&lt;/p&gt;</comment>
                            <comment id="16703301" author="benedict" created="Thu, 29 Nov 2018 14:56:33 +0000"  >&lt;p&gt;Thanks.  Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/4b1f40d5382638bf3913293b713d5d22b57c844d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4b1f40d5382638bf3913293b713d5d22b57c844d&lt;/a&gt; to 3.0 and up.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13207412">CASSANDRA-14948</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12986" cascade-level="1"><![CDATA[Recoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12966"><![CDATA[Challenging]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12972"><![CDATA[Fuzz Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 50 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3zlfr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>