<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:01:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11301] Non-obsoleting compaction operations over compressed files can impose rate limit on normal reads</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11301</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Broken by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9240&quot; title=&quot;Performance issue after a restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9240&quot;&gt;&lt;del&gt;CASSANDRA-9240&lt;/del&gt;&lt;/a&gt;; the rate limiting reader passes the ICompressedFile interface to its parent, which uses this to attach an &quot;owner&quot; - which means the reader gets recycled on close, i.e. pooled, for normal use. If the compaction were to replace the sstable there would be no problem, which is presumably why this hasn&apos;t been encountered frequently. However validation compactions on long lived sstables would permit these rate limited readers to accumulate.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12946606">CASSANDRA-11301</key>
            <summary>Non-obsoleting compaction operations over compressed files can impose rate limit on normal reads</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                    </labels>
                <created>Thu, 3 Mar 2016 17:08:02 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:40 +0000</updated>
                            <resolved>Thu, 10 Mar 2016 10:23:26 +0000</resolved>
                                        <fixVersion>2.2.6</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="15178546" author="christianmovi" created="Thu, 3 Mar 2016 20:16:24 +0000"  >&lt;p&gt;Benedict: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9240&quot; title=&quot;Performance issue after a restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9240&quot;&gt;&lt;del&gt;CASSANDRA-9240&lt;/del&gt;&lt;/a&gt; does not specify 2.1 as fixVersion. Am I correct to assume that 2.1 should not be affected by this?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=luxifer&quot; class=&quot;user-hover&quot; rel=&quot;luxifer&quot;&gt;luxifer&lt;/a&gt;: Didn&apos;t you say that our 2.1 installation is also affected? Did you test with setcompactionthroughput?&lt;/p&gt;</comment>
                            <comment id="15178551" author="benedict" created="Thu, 3 Mar 2016 20:20:06 +0000"  >&lt;p&gt;I did not look too closely as I don&apos;t work actively on the project at the moment, however I don&apos;t think 2.1 should be affected.&lt;/p&gt;</comment>
                            <comment id="15179421" author="luxifer" created="Fri, 4 Mar 2016 06:20:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=christianmovi&quot; class=&quot;user-hover&quot; rel=&quot;christianmovi&quot;&gt;christianmovi&lt;/a&gt;: I saw similar symptoms on that particular cluster and increasing the compaction throughput seemed to help. Then again, the symptoms are elusive even on 2.2, where this is confirmed and I did not create a thread dump. If it happens again I will do that (if I get on it in time) and we&apos;ll see.&lt;/p&gt;</comment>
                            <comment id="15186596" author="stefania" created="Wed, 9 Mar 2016 06:18:29 +0000"  >&lt;p&gt;I can see what the problem described by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; is, and from code inspection it should only affect 2.2 since prior to that the throttled compressed reader was created without an owner and in 3.0+ the reader&apos;s pool has been removed. The patch below should fix the issue in principle, but I have not been able to reproduce the problem locally. &lt;/p&gt;

&lt;p&gt;I tried comparing &lt;tt&gt;cassandra-stress&lt;/tt&gt; read rates for 1M entries using 50 or 100 threads before and after a repair with very low compaction throughput. I also tried a verify operation. I was expecting the rate to drop but I saw no difference - presumably there are non-rate-limited readers also available in the cache.&lt;/p&gt;

&lt;p&gt;Does anyone have a reliable way to reproduce this or a safe environment where to test the patch?&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/11301-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-11301-2.2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-11301-2.2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15186845" author="benedict" created="Wed, 9 Mar 2016 09:36:24 +0000"  >&lt;p&gt;I would suggest simply corroborating via unit test that prior to this patch recycling a throttled reader permits getting one from the pool, and with the patch this does not happen.&lt;/p&gt;

&lt;p&gt;A live running system would be able to accumulate many such throttled readers over a long enough time, and over many sstables.  If you were to perform a stress workload with tiny tiny sstables (a few MB), no auto compaction, followed by several validation compactions and a compaction throughput of 1MB you&apos;d probably elicit the bug directly, but that&apos;s all probably a lot of wasted effort.&lt;/p&gt;</comment>
                            <comment id="15186860" author="christianmovi" created="Wed, 9 Mar 2016 09:44:55 +0000"  >&lt;p&gt;I don&apos;t know if it helps:&lt;/p&gt;

&lt;p&gt;We saw these throttled reads when we had repair running with -pr on. We turned primary-range off, and now this issues is gone.&lt;/p&gt;

&lt;p&gt;btw: With the -pr flag enabled, we had easily 50-100 concurrent validations running concurrently for some reason (Without -pr its back to a single validation). Maybe the issue requires such a high amount of concurrent compactions/validations?  &lt;/p&gt;</comment>
                            <comment id="15186876" author="benedict" created="Wed, 9 Mar 2016 09:56:35 +0000"  >&lt;p&gt;Thanks.  That likely just corroborates the &quot;many&quot; requirement - it&apos;s unlikely the actively running repairs matter, but the total number that are run over a given set of sstables.&lt;/p&gt;

&lt;p&gt;Stefania&apos;s patch is very minor, so you should be perfectly safe to roll it out to your cluster if you want to restore your prior repair behaviour and corroborate everything works.&lt;/p&gt;</comment>
                            <comment id="15188838" author="stefania" created="Thu, 10 Mar 2016 07:24:30 +0000"  >&lt;p&gt;It turns out there is an expiry time of 512 milliseconds on the cache entries, so I&apos;ve opted for the unit test.&lt;/p&gt;

&lt;p&gt;Provided we don&apos;t stop with a breakpoint, the unit test fails without the patch and passes with the patch applied. I&apos;ve also cleaned up a &lt;tt&gt;FileNotFoundException&lt;/tt&gt; that was not thrown any longer. The patch should be committed to 2.2 only. I&apos;m going to look for a reviewer on IRC.&lt;/p&gt;
</comment>
                            <comment id="15189027" author="krummas" created="Thu, 10 Mar 2016 10:23:26 +0000"  >&lt;p&gt;+1, committed&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                                                <inwardlinks description="is broken by">
                                        <issuelink>
            <issuekey id="12823903">CASSANDRA-9240</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 36 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2u3xb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>