<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:44:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6916] Preemptive opening of compaction result</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6916</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6812&quot; title=&quot;Iterative Memtable-&amp;gt;SSTable Replacement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6812&quot;&gt;CASSANDRA-6812&lt;/a&gt;, but a little simpler: when compacting, we mess quite badly with the page cache. One thing we can do to mitigate this problem is to use the sstable we&apos;re writing before we&apos;ve finished writing it, and to drop the regions from the old sstables from the page cache as soon as the new sstables have them (even if they&apos;re only written to the page cache). This should minimise any page cache churn, as the old sstables must be larger than the new sstable, and since both will be in memory, dropping the old sstables is at least as good as dropping the new.&lt;/p&gt;

&lt;p&gt;The approach is quite straight-forward. Every X MB written:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;grab flushed length of index file;&lt;/li&gt;
	&lt;li&gt;grab second to last index summary record, after excluding those that point to positions after the flushed length;&lt;/li&gt;
	&lt;li&gt;open index file, and check that our last record doesn&apos;t occur outside of the flushed length of the data file (pretty unlikely)&lt;/li&gt;
	&lt;li&gt;Open the sstable with the calculated upper bound&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Some complications:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;must keep running copy of compression metadata for reopening with&lt;/li&gt;
	&lt;li&gt;we need to be able to replace an sstable with itself but a different lower bound&lt;/li&gt;
	&lt;li&gt;we need to drop the old page cache only when readers have finished&lt;/li&gt;
&lt;/ol&gt;

</description>
                <environment></environment>
        <key id="12703231">CASSANDRA-6916</key>
            <summary>Preemptive opening of compaction result</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="benedict">Benedict Elliott Smith</reporter>
                        <labels>
                            <label>performance</label>
                    </labels>
                <created>Mon, 24 Mar 2014 16:06:32 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:50 +0000</updated>
                            <resolved>Thu, 15 May 2014 06:19:32 +0000</resolved>
                                        <fixVersion>2.1 beta2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13945281" author="benedict" created="Mon, 24 Mar 2014 16:10:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/6916-preempive-open-compact&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Here&lt;/a&gt; is a patch that adds this functionality, and also drops support for preheating page cache or dropping the page cache on writes, since they are no longer likely to provide any benefit above the standard behaviour with this patch.&lt;/p&gt;</comment>
                            <comment id="13963040" author="krummas" created="Tue, 8 Apr 2014 14:35:17 +0000"  >&lt;p&gt;In general the patch looks good, a few comments;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Can we get some benchmarks done if this is worth it? I know intuitively it feels like it would be a big win, not only for the page cache, but also since we get to only read one sstable for the compacted keys, but still would be nice to have some evidence. I guess we could also do this to find a good default value for sstable_preemptive_open_interval_in_mb&lt;/li&gt;
	&lt;li&gt;Problem with fully expired sstables in CompactionTask, we need to replace &quot;toCompact&quot; instead of &quot;actuallyCompact&quot;.&lt;/li&gt;
	&lt;li&gt;KeyCacheTest fails (not had time to look deeper into it)&lt;/li&gt;
	&lt;li&gt;A few comments around the replaceReader/replaceCompacted... and related in CompactionTask would be helpful, a bit harder to grasp now that we start using the compacted sstables earlier and then call DataTracker.replace(...) with an empty list.&lt;/li&gt;
	&lt;li&gt;In SSTR.cloneWithNewStart(..),  CLibrary.trySkipCache(dfile.path, 0, 0); is called when newStart &amp;gt; last, is that on purpose? I guess we could drop the page cache for the whole file in this case?&lt;/li&gt;
	&lt;li&gt;In MMappedSegmentedFile, line 199, it looks like that ternary expression is not really needed since we add raf.length() in boundaries above?&lt;/li&gt;
	&lt;li&gt;Preheat comment left in CompactionTask&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;We could probably do the same thing for the rest of the compactions (upgradesstables, scrub, etc)? Lets do that in a followup ticket (if at all)&lt;/p&gt;</comment>
                            <comment id="13963147" author="benedict" created="Tue, 8 Apr 2014 16:33:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;I know intuitively it feels like it would be a big win, not only for the page cache, but also since we get to only read one sstable for the compacted keys, but still would be nice to have some evidence.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It would also be interesting to test this patch out against a constrained memory scenario, and see how well it behaves, as it should occupy much less memory at any given moment during a compaction. However, I think for the moment confirming we get the expected outcome of fixing &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6746&quot; title=&quot;Reads have a slow ramp up in speed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6746&quot;&gt;&lt;del&gt;CASSANDRA-6746&lt;/del&gt;&lt;/a&gt; is enough in my book. I&apos;ll ask Ryan to run that test once I&apos;ve addressed your points below.&lt;/p&gt;

&lt;blockquote&gt;
&lt;ol&gt;
	&lt;li&gt;Problem with fully expired sstables in CompactionTask, we need to replace &quot;toCompact&quot; instead of &quot;actuallyCompact&quot;.&lt;/li&gt;
	&lt;li&gt;KeyCacheTest fails (not had time to look deeper into it)&lt;/li&gt;
	&lt;li&gt;A few comments around the replaceReader/replaceCompacted... and related in CompactionTask would be helpful, a bit harder to grasp now that we start using the compacted sstables earlier and then call DataTracker.replace(...) with an empty list.&lt;/li&gt;
	&lt;li&gt;In MMappedSegmentedFile, line 199, it looks like that ternary expression is not really needed since we add raf.length() in boundaries above?&lt;/li&gt;
	&lt;li&gt;Preheat comment left in CompactionTask&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;

&lt;p&gt;Good points, thanks. I&apos;ll check the failing test.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In SSTR.cloneWithNewStart(..), CLibrary.trySkipCache(dfile.path, 0, 0); is called when newStart &amp;gt; last, is that on purpose? I guess we could drop the page cache for the whole file in this case?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s the idea, yes. A parameter of 0 indicates to drop the whole file.&lt;/p&gt;</comment>
                            <comment id="13963155" author="jbellis" created="Tue, 8 Apr 2014 16:44:13 +0000"  >&lt;blockquote&gt;&lt;p&gt;We could probably do the same thing for the rest of the compactions (upgradesstables, scrub, etc)? Lets do that in a followup ticket (if at all)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What stops us from generalizing to an API of &lt;tt&gt;new SSTableWriter(List&amp;lt;SSTR&amp;gt; sstablesToReplace&lt;/tt&gt; ?&lt;/p&gt;</comment>
                            <comment id="13963159" author="benedict" created="Tue, 8 Apr 2014 16:47:56 +0000"  >&lt;p&gt;Probably nothing - it looks like an eminently sensible idea. I&apos;ll give it a go for my next version and let you know if it goes pear shaped &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;FTR, if possible, I&apos;ll probably extend SSTableWriter to an SSTableRewriter, to keep the functionality separate.&lt;/p&gt;</comment>
                            <comment id="13963873" author="krummas" created="Wed, 9 Apr 2014 06:41:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;What stops us from generalizing &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Sounds good, i just figured we should spend some time on benchmarking before doing that, to make sure it is not wasted if the benchmarks don&apos;t show any improvements.&lt;/p&gt;</comment>
                            <comment id="13963914" author="krummas" created="Wed, 9 Apr 2014 07:43:48 +0000"  >&lt;blockquote&gt;&lt;p&gt;That&apos;s the idea, yes. A parameter of 0 indicates to drop the whole file.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;trySkipCache with a string path does &quot;while (len &amp;gt; 0)&quot; - and with len = 0, it won&apos;t do anything (unless my caffeine levels are too low and I miss something obvious)&lt;/p&gt;

&lt;p&gt;also realized now that we need to close the RandomAccessFile in CLibrary.trySkipCache(String path, long offset, long len)&lt;/p&gt;</comment>
                            <comment id="13963919" author="benedict" created="Wed, 9 Apr 2014 07:59:50 +0000"  >&lt;p&gt;doh. Yes, I should be passing the 0 straght through! Good spots.&lt;/p&gt;</comment>
                            <comment id="13974842" author="benedict" created="Sat, 19 Apr 2014 12:29:30 +0000"  >&lt;p&gt;Uploaded a new version &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/6916v3-preempive-open-compact&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. Introduced a new SSTableRewriter that we now use in scrub, upgrade, clean, compaction and anti-compaction. On the whole I think this actually makes the code in these classes a little neater. Also added code to smoothly transfer key cache items over at the same time.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enigmacurry&quot; class=&quot;user-hover&quot; rel=&quot;enigmacurry&quot;&gt;enigmacurry&lt;/a&gt; could you try this patch out against &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6746&quot; title=&quot;Reads have a slow ramp up in speed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6746&quot;&gt;&lt;del&gt;CASSANDRA-6746&lt;/del&gt;&lt;/a&gt;? Would be interested to see for a mixed workload as well...&lt;/p&gt;</comment>
                            <comment id="13975701" author="enigmacurry" created="Mon, 21 Apr 2014 16:43:58 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Fantastic! &lt;a href=&quot;http://riptano.github.io/cassandra_performance/graph/graph.html?stats=stats.6916v3-preempive-open-compact.json&amp;amp;metric=op_rate&amp;amp;operation=read&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://riptano.github.io/cassandra_performance/graph/graph.html?stats=stats.6916v3-preempive-open-compact.json&amp;amp;metric=op_rate&amp;amp;operation=read&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Working on a mixed load now.&lt;/p&gt;</comment>
                            <comment id="13975724" author="benedict" created="Mon, 21 Apr 2014 17:08:00 +0000"  >&lt;p&gt;Great! any chance you could upload the logs for the last run? pretty happy it&apos;s faster for writes but would like to see what the explanation of the bigger drop in throughput was.&lt;/p&gt;</comment>
                            <comment id="13975740" author="enigmacurry" created="Mon, 21 Apr 2014 17:22:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; logs attached: 6916v3-preempive-open-compact.logs.gz&lt;/p&gt;</comment>
                            <comment id="13975753" author="tjake" created="Mon, 21 Apr 2014 17:28:30 +0000"  >&lt;p&gt;Just for historical purposes we tried a different approach in 0.7 &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1902&quot; title=&quot;Migrate cached pages during compaction&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1902&quot;&gt;&lt;del&gt;CASSANDRA-1902&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13976029" author="enigmacurry" created="Mon, 21 Apr 2014 21:02:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Yea, this is killer. Here&apos;s a mixed read/write workload:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://riptano.github.io/cassandra_performance/graph_v3/graph.html?stats=stats.6916v3-preempive-open-compact.mixed.2.json&amp;amp;metric=op_rate&amp;amp;operation=mixed&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://riptano.github.io/cassandra_performance/graph_v3/graph.html?stats=stats.6916v3-preempive-open-compact.mixed.2.json&amp;amp;metric=op_rate&amp;amp;operation=mixed&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Logs are attached as: 6916v3-preempive-open-compact.mixed.2.logs.tar.gz&lt;/p&gt;</comment>
                            <comment id="13976140" author="benedict" created="Mon, 21 Apr 2014 22:48:01 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enigmacurry&quot; class=&quot;user-hover&quot; rel=&quot;enigmacurry&quot;&gt;enigmacurry&lt;/a&gt;. Could I get the logs for the no-patch run for writes as well to compare against?&lt;/p&gt;

&lt;p&gt;Also, could we do one last test comparing patch against version with both populate page cache properties set to true? Since this is effectively the &quot;regression&quot; we&apos;re competing with, just want to check we still perform as well.&lt;/p&gt;</comment>
                            <comment id="13976143" author="benedict" created="Mon, 21 Apr 2014 22:53:50 +0000"  >&lt;p&gt;It&apos;s worth noting for other viewers of this ticket that this patch seems to reduce worst write latency quite noticeably, which is a nice side effect. I&apos;m guessing this is because the OS has more buffer cache to play with to keep IO scheduled effectively.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; wdyt of the new patch?&lt;/p&gt;</comment>
                            <comment id="13976151" author="enigmacurry" created="Mon, 21 Apr 2014 23:02:48 +0000"  >&lt;p&gt;Logs for the write,mixed run on stock 2.1: 6916-stock2_1.mixed.logs.tar.gz&lt;/p&gt;</comment>
                            <comment id="13976157" author="benedict" created="Mon, 21 Apr 2014 23:08:38 +0000"  >&lt;p&gt;Thanks, everything looks good to me. Once we double check against stock 2.1 with populate page cache enabled to check there&apos;s no surprises, I&apos;m happy to commit.&lt;/p&gt;</comment>
                            <comment id="13976389" author="enigmacurry" created="Tue, 22 Apr 2014 04:58:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; here&apos;s the last test you wanted:&lt;/p&gt;

&lt;p&gt;Testplan:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Set preheat_kernel_page_cache:true in yaml.&lt;/li&gt;
	&lt;li&gt;Startup C*, create the keyspace and CFs stress would, modifying populate_io_cache_on_flush to true.&lt;/li&gt;
	&lt;li&gt;Regular stress write (same as other tests above)&lt;/li&gt;
	&lt;li&gt;mixed stress write (same as other tests above)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You had told me offline that those settings were not applicable to your patch, but I went ahead and tried them anyway, apples to apples. Results with those settings for both stock 2.1 and your patched version:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://riptano.github.io/cassandra_performance/graph_v3/graph.html?stats=stats.6916v3-preempive-open-compact.mixed.cache_tweaks.2.json&amp;amp;metric=op_rate&amp;amp;operation=mixed&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://riptano.github.io/cassandra_performance/graph_v3/graph.html?stats=stats.6916v3-preempive-open-compact.mixed.cache_tweaks.2.json&amp;amp;metric=op_rate&amp;amp;operation=mixed&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I noticed that on your branch I got several timeouts during the mixed operation. The second trial I tried (green line) timed out completely midway through the mixed operation. Check out the max latencies metric on that graph.&lt;/p&gt;

&lt;p&gt;However, doing the original test you wanted me to do, which is setting populate_io_cache_on_flush:true and preheat_kernel_page_cache:true ONLY on stock 2.1, comparing to your branch without those settings, I get:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://riptano.github.io/cassandra_performance/graph_v3/graph.html?stats=stats.6916v3-preempive-open-compact.mixed.cache_tweaks.3.json&amp;amp;metric=op_rate&amp;amp;operation=mixed&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://riptano.github.io/cassandra_performance/graph_v3/graph.html?stats=stats.6916v3-preempive-open-compact.mixed.cache_tweaks.3.json&amp;amp;metric=op_rate&amp;amp;operation=mixed&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Which still shows slightly better that stock. So, it does appear that those settings still affect something.&lt;/p&gt;

&lt;p&gt;New logs:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;stock C* 2.1 with cache settings on : 6916-stock2_1.mixed.cache_tweaks.tar.gz&lt;/li&gt;
	&lt;li&gt;6916v3-premptive-open-compact with cache settings on: 6916v3-premptive-open-compact.mixed.cache_tweaks.2.tar.gz&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;There&apos;s some interesting errors in that second set of logs, worth checking out.&lt;/p&gt;

&lt;p&gt;Furthermore, I hadn&apos;t realized when testing &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6746&quot; title=&quot;Reads have a slow ramp up in speed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6746&quot;&gt;&lt;del&gt;CASSANDRA-6746&lt;/del&gt;&lt;/a&gt; that we could actually fare well with the existing options like this, just that they weren&apos;t on by default. It would be great though if the default settings made this test pass, which your branch does.&lt;/p&gt;</comment>
                            <comment id="13976585" author="benedict" created="Tue, 22 Apr 2014 09:29:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=enigmacurry&quot; class=&quot;user-hover&quot; rel=&quot;enigmacurry&quot;&gt;enigmacurry&lt;/a&gt;: 6916v3 should crash if you set the preheat_kernel_page_cache property to true (just tested this locally). Setting the populate_io_cache_on_flush property of the CF would probably work but simply have no effect. Are you sure you were running the correct branch?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Furthermore, I hadn&apos;t realized when testing &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6746&quot; title=&quot;Reads have a slow ramp up in speed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6746&quot;&gt;&lt;del&gt;CASSANDRA-6746&lt;/del&gt;&lt;/a&gt; that we could actually fare well with the existing options like this&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The problem is that we consider the default to be better at preventing dramatic page cache churn during compaction, which this should continue to deliver but without the downsides.&lt;/p&gt;

&lt;p&gt;The errors look plausible - but could we confirm we&apos;re running the correct (v3) branch given it didn&apos;t crash with the preheat setting in the yaml?&lt;/p&gt;</comment>
                            <comment id="13976788" author="krummas" created="Tue, 22 Apr 2014 13:50:38 +0000"  >&lt;p&gt;new patch comments;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;cleanup is broken, first the log message causes npe since newSstable is null, secondly, an immutableSet is passed as rewriting to SSTableRewriter, causing moveStarts to fail since it calls removeAll on that set. Both fixed here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/bes/6916-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/bes/6916-2&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;a bit of javadoc around moveStarts could be helpful, just looking at the api now makes it feel like we are moving the start of newReader&lt;/li&gt;
	&lt;li&gt;when doing anticompaction, should we not clean up old readers? (repairedSSTableWriter.finish(false, repairedAt)&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;do we need to move starts back in SSTableRewriter.resetAndTruncate()? If we resetAndTruncate right after doing early opening, i think we could create a gap between the start in the compacting file and the end in the written one&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13976895" author="benedict" created="Tue, 22 Apr 2014 15:11:29 +0000"  >&lt;blockquote&gt;&lt;p&gt;when doing anticompaction, should we not clean up old readers? (repairedSSTableWriter.finish(false, repairedAt)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We have two writers open with the &lt;b&gt;same&lt;/b&gt; readers here, so we only close the readers when we finish the second writer. It&apos;s a bit clunky, I know, but it&apos;s not a common occurrence to be rewriting into two places. I&apos;ll add comments.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;do we need to move starts back in SSTableRewriter.resetAndTruncate()? If we resetAndTruncate right after doing early opening, i think we could create a gap between the start in the compacting file and the end in the written one&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We always open before performing any append, and open with exclusive upper bounds, i.e. we should only ever truncate back to a position we&apos;re still safe at. That said, this is definitely worthy of a comment or two.&lt;/p&gt;

&lt;p&gt;I&apos;ve copied your tweaks and also added another fix: wasn&apos;t dealing with marking compacted correctly everywhere. Need to mark the compaction finished before deleting the old files, and mark the preemptively opened reader as compacting before adding it to the live set to avoid it being compacted before it&apos;s written (this was in the earlier patches but dropped out somewhere along the way) &lt;/p&gt;

&lt;p&gt;Also, I left the new HashSet() inside of the Rewriter out, as I want the provided set to be mutable, so that the users of the rewriter can have access to the currently extant versions. It&apos;s not actually necessary anywhere, but I think it will prevent future surprises.&lt;/p&gt;

&lt;p&gt;I&apos;ve uploaded to the repository, but intend to add some comments to the places we mentioned. The functional stuff should be static now, if you&apos;re happy with it.&lt;/p&gt;</comment>
                            <comment id="13976899" author="enigmacurry" created="Tue, 22 Apr 2014 15:14:37 +0000"  >&lt;p&gt;doh! I am using the right branch, but I was wrong about using the preheat_kernel_page_cache setting on it. My test harness was trying to be smart by introspecting Config.java to prevalidate config settings, and it simply tossed the setting out when it saw that it wasn&apos;t going to work. I either need to remove that bit of code, or remember why I thought it was a good idea in the first place, so I don&apos;t confuse myself like this again!&lt;/p&gt;

&lt;p&gt;The timeouts I was seeing appear to be entirely related to the populate_io_cache_on_flush setting on the CF. Which, appears to be gone in the latest version of your branch, and I&apos;ve retested and saw no timeouts, so I think we&apos;re good.&lt;/p&gt;</comment>
                            <comment id="13976903" author="benedict" created="Tue, 22 Apr 2014 15:20:05 +0000"  >&lt;p&gt;I think the timeouts were actually caused by my not updating FileCacheService (and there being a race condition or two in there that were exacerbated by this change) - I&apos;ve fixed these in my branch now, so that&apos;s probably why everything looks good &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13977937" author="krummas" created="Wed, 23 Apr 2014 07:30:11 +0000"  >&lt;p&gt;ok, i&apos;m happy with the functionality now, few last comments;&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Seems we are caching the keys twice, both in SSTableRewriter.maybeReopenEarly and moveStarts&lt;/li&gt;
	&lt;li&gt;We should perhaps invalidate the new keys cached when aborting the SSTRW&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13978064" author="benedict" created="Wed, 23 Apr 2014 10:58:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;We should perhaps invalidate the new keys cached when aborting the SSTRW&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I&apos;m not convinced the complexity is really worth it; aborting only happens when something goes wrong, and I want to simply clean up my resources as quickly and safely as possible... walking through the readers, looking up their cache keys and swapping them back seems to me to be quite an expensive cleanup operation that might leave us failing to cleanup resources properly. I don&apos;t feel too strongly either way though.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Seems we are caching the keys twice, both in SSTableRewriter.maybeReopenEarly and moveStarts&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good spot!&lt;/p&gt;

&lt;p&gt;Okay, just uploaded a new version with that fixed, increased comments and also better encapsulation of mark() and resetAndTruncate() within a new tryAppend method, which more easily enapsulates/demonstrates the safety of the operation&lt;/p&gt;</comment>
                            <comment id="13978231" author="benedict" created="Wed, 23 Apr 2014 14:18:39 +0000"  >&lt;p&gt;Rebased, squashed and pushed to &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/6916-final&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;6916-final&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13978239" author="krummas" created="Wed, 23 Apr 2014 14:29:56 +0000"  >&lt;p&gt;committed!&lt;/p&gt;</comment>
                            <comment id="13978319" author="tjake" created="Wed, 23 Apr 2014 15:40:59 +0000"  >&lt;p&gt;This is a really interesting ticket!  I&apos;m just looking at the final patch and wondering about how this works with leveled compaction.  Aren&apos;t the sstables being merged from the previous level updated with the new level at the end of compaction?  &lt;/p&gt;

&lt;p&gt;What level does the partial sstable read use?  Are these considered part of level 0 till they are fully written? &lt;/p&gt;

&lt;p&gt;More generally, is there a stress test we have that uses wide rows? I think it&apos;s important we stress both as Leveled is becoming more widely used.&lt;/p&gt;
</comment>
                            <comment id="13978330" author="benedict" created="Wed, 23 Apr 2014 15:48:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;What level does the partial sstable read use? Are these considered part of level 0 till they are fully written?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It doesn&apos;t - it just relies on being present in the interval tree. It doesn&apos;t need a level except for purposes of compaction, which is a bit premature when it&apos;s not even finished yet &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;More generally, is there a stress test we have that uses wide rows?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, if by wide you mean CQL composite keys - this is something I want to address very soon. It&apos;s a pretty simple addition to the current stress tool, and there have been a number of tickets recently where it would have been very helpful. You&apos;re welcome to take a look at it yourself. In this instance I don&apos;t think it would make a real difference though.&lt;/p&gt;</comment>
                            <comment id="13979872" author="iamaleksey" created="Thu, 24 Apr 2014 15:56:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;if by wide you mean CQL composite keys&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;By wide we usually mean just partitions with a metric ton of cells, composite or not.&lt;/p&gt;</comment>
                            <comment id="13980001" author="benedict" created="Thu, 24 Apr 2014 17:41:12 +0000"  >&lt;p&gt;Missed in if (offline) test in CompactionTask to ensure offline split works. Not totally sure why it didn&apos;t break before this patch though, but either way was an oversight. Attaching fix that also adds class level javadoc to SSTableRewriter&lt;/p&gt;</comment>
                            <comment id="13980733" author="krummas" created="Fri, 25 Apr 2014 06:24:08 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13993833" author="benedict" created="Fri, 9 May 2014 19:05:00 +0000"  >&lt;p&gt;Spotted a bug in abort() - we close the bloom filter when aborting an SSTableWriter but now we may already have it opened for read. Attaching simple fix to ensure we only close the BF if we haven&apos;t sent a reference elsewhere&lt;/p&gt;</comment>
                            <comment id="13996177" author="krummas" created="Tue, 13 May 2014 08:10:37 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13998028" author="benedict" created="Wed, 14 May 2014 21:17:25 +0000"  >&lt;p&gt;One more bug: this breaks snapshots, as they think each SSTableReader is backed by an immutable file on disk. Attaching simple patch that skips those readers that are &quot;isOpenEarly&quot;&lt;/p&gt;</comment>
                            <comment id="13998488" author="krummas" created="Thu, 15 May 2014 06:19:32 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12773467">CASSANDRA-8764</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12842029">CASSANDRA-9699</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12712465">CASSANDRA-7167</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12772826">CASSANDRA-8750</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12696354">CASSANDRA-6746</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12749501">CASSANDRA-8157</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12770094">CASSANDRA-8683</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12833681">CASSANDRA-9508</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12972422">CASSANDRA-11886</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13093731">CASSANDRA-13752</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12745266">CASSANDRA-8034</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12745996">CASSANDRA-8061</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12752581">CASSANDRA-8248</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12763538">CASSANDRA-8535</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12776122">CASSANDRA-8832</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12830048">CASSANDRA-9396</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12873053">CASSANDRA-10357</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12905207">CASSANDRA-10534</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12954802">CASSANDRA-11468</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12773525">CASSANDRA-8766</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12772826">CASSANDRA-8750</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12696354">CASSANDRA-6746</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                            <outwardlinks description="depends upon">
                                        <issuelink>
            <issuekey id="12703162">CASSANDRA-6912</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12706892">CASSANDRA-6987</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12699261">CASSANDRA-6812</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12641181" name="6916-stock2_1.mixed.cache_tweaks.tar.gz" size="45674" author="enigmacurry" created="Tue, 22 Apr 2014 04:58:38 +0000"/>
                            <attachment id="12641136" name="6916-stock2_1.mixed.logs.tar.gz" size="45432" author="enigmacurry" created="Mon, 21 Apr 2014 23:02:48 +0000"/>
                            <attachment id="12644164" name="6916.fix.txt" size="1505" author="benedict" created="Fri, 9 May 2014 19:10:43 +0000"/>
                            <attachment id="12644889" name="6916.fix2.txt" size="7814" author="benedict" created="Wed, 14 May 2014 21:17:49 +0000"/>
                            <attachment id="12641762" name="6916.fixup.txt" size="3656" author="benedict" created="Thu, 24 Apr 2014 17:41:36 +0000"/>
                            <attachment id="12641085" name="6916v3-preempive-open-compact.logs.gz" size="40671" author="enigmacurry" created="Mon, 21 Apr 2014 17:24:40 +0000"/>
                            <attachment id="12641119" name="6916v3-preempive-open-compact.mixed.2.logs.tar.gz" size="43131" author="enigmacurry" created="Mon, 21 Apr 2014 21:02:16 +0000"/>
                            <attachment id="12641182" name="6916v3-premptive-open-compact.mixed.cache_tweaks.2.tar.gz" size="47622" author="enigmacurry" created="Tue, 22 Apr 2014 04:58:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>381569</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 27 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1tqnz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>381844</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>