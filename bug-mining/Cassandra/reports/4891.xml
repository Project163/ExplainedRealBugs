<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:09:36 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12872] Fix short read protection when more than one row is missing</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12872</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We are seeing an issue with paging reads missing some small number of columns when we do paging/limit reads. We get this on a single DC cluster itself when both reads and writes are happening with QUORUM. Paging/limit reads see this issue. I have attached the ccm based script which reproduces the problem.&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Keyspace RF - 3&lt;/li&gt;
	&lt;li&gt;Table (id int, course text, marks int, primary key(id, course))&lt;/li&gt;
	&lt;li&gt;replicas for partition key 1 - r1, r2 and r3&lt;/li&gt;
	&lt;li&gt;insert (1, &apos;1&apos;, 1) ,  (1, &apos;2&apos;, 2),  (1, &apos;3&apos;, 3),  (1, &apos;4&apos;, 4),  (1, &apos;5&apos;, 5) - succeeded on all 3 replicas&lt;/li&gt;
	&lt;li&gt;insert (1, &apos;6&apos;, 6) succeeded on r1 and r3, failed on r2&lt;/li&gt;
	&lt;li&gt;delete (1, &apos;2&apos;), (1, &apos;3&apos;), (1, &apos;4&apos;), (1, &apos;5&apos;) succeeded on r1 and r2, failed on r3&lt;/li&gt;
	&lt;li&gt;insert (1, &apos;7&apos;, 7) succeeded on r1 and r2, failed on r3&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Local data on 3 nodes looks like as below now&lt;/p&gt;

&lt;p&gt;r1: (1, &apos;1&apos;, 1), tombstone(2-5 records), (1, &apos;6&apos;, 6), (1, &apos;7&apos;, 7)&lt;br/&gt;
r2: (1, &apos;1&apos;, 1), tombstone(2-5 records), (1, &apos;7&apos;, 7)&lt;br/&gt;
r3: (1, &apos;1&apos;, 1),  (1, &apos;2&apos;, 2),  (1, &apos;3&apos;, 3),  (1, &apos;4&apos;, 4),  (1, &apos;5&apos;, 5), (1, &apos;6&apos;, 6)&lt;/p&gt;

&lt;p&gt;If we do a paging read with page_size 2, and if it gets data from r2 and r3, then it will only get the data (1, &apos;1&apos;, 1) and (1, &apos;7&apos;, 7) skipping record 6. This problem would happen if the same query is not doing paging but limit set to 2 records.&lt;/p&gt;

&lt;p&gt;Resolution code for reads works same for paging queries and normal queries. Co-ordinator shouldn&apos;t respond back to client with records/columns that it didn&apos;t have complete visibility on all required replicas (in this case 2 replicas). In above case, it is sending back record (1, &apos;7&apos;, 7) back to client, but its visibility on r3 is limited up to (1, &apos;2&apos;, 2) and it is relying on just r2 data to assume (1, &apos;6&apos;, 6) doesn&apos;t exist, which is wrong. End of the resolution all it can conclusively say any thing about is (1, &apos;1&apos;,  and the other one is that we  and and and and and and the and the and the and d and the other is and 1), which exists and (1, &apos;2&apos;, 2), which is deleted.&lt;/p&gt;

&lt;p&gt;Ideally we should have different resolution implementation for paging/limit queries.&lt;/p&gt;

&lt;p&gt;We could reproduce this on 2.0.17, 2.1.16 and 3.0.9.&lt;/p&gt;

&lt;p&gt;Seems like 3.0.9 we have ShortReadProtection transformation on list queries. I assume that is to protect against the cases like above. But, we can reproduce the issue in 3.0.9 as well.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13017430">CASSANDRA-12872</key>
            <summary>Fix short read protection when more than one row is missing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="mgvbhaskar">Bhaskar Muppana</reporter>
                        <labels>
                            <label>Correctness</label>
                    </labels>
                <created>Wed, 2 Nov 2016 21:50:45 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:15 +0000</updated>
                            <resolved>Fri, 15 Sep 2017 16:34:42 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                                    <component>Legacy/Coordination</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>18</watches>
                                                                                                                <comments>
                            <comment id="16165477" author="iamaleksey" created="Wed, 13 Sep 2017 23:38:10 +0000"  >&lt;p&gt;A minimal dtest reproducing the issue &lt;a href=&quot;https://github.com/iamaleksey/cassandra-dtest/commits/12872&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13794&quot; title=&quot;Fix short read protection logic for querying more rows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13794&quot;&gt;&lt;del&gt;CASSANDRA-13794&lt;/del&gt;&lt;/a&gt; changes make it pass, but unfortunately the bug itself is still here - it&apos;s just masked by min(limit, 16) optimisation in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13794&quot; title=&quot;Fix short read protection logic for querying more rows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13794&quot;&gt;&lt;del&gt;CASSANDRA-13794&lt;/del&gt;&lt;/a&gt; branch.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; I&apos;m close-ish to completion here. Mind if I take over? It&apos;s a bit time-sensitive. If you do mind and/or have something in progress, feel free to take it back.&lt;/p&gt;</comment>
                            <comment id="16165912" author="blerer" created="Thu, 14 Sep 2017 07:52:10 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; I do not mind at all. You can take more if you want too &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16166455" author="iamaleksey" created="Thu, 14 Sep 2017 15:29:46 +0000"  >&lt;p&gt;Fixed branches: &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/12872-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/12872-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;, and &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/12872-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Will link to circle and dtest runs a bit later (Jenkins is being a bit unresponsive).&lt;/p&gt;

&lt;p&gt;The problem is caused by us applying the counter transformation in an incorrect order: before extending the partition for &lt;tt&gt;moreContents()&lt;/tt&gt; instead of after. And &lt;b&gt;obviously&lt;/b&gt; only the transformations applied after extension will be applied upon re-extension, to the next element. Because it makes the most sense.&lt;/p&gt;

&lt;p&gt;This causes us skipping an increment of the counter, which in turn causes SRP deciding to not proceed with fetching more rows, triggering this early return:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (lastCount == counter.counted() || !counter.isDoneForPartition())
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The patch simply moves counter application to the correct spot, and the new dtest passes (as do the older ones).&lt;/p&gt;</comment>
                            <comment id="16166473" author="iamaleksey" created="Thu, 14 Sep 2017 15:41:20 +0000"  >&lt;p&gt;In effect, SRP only works correctly on the first call to &lt;tt&gt;moreContents()&lt;/tt&gt;. And given that because of a logical bug (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13794&quot; title=&quot;Fix short read protection logic for querying more rows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13794&quot;&gt;&lt;del&gt;CASSANDRA-13794&lt;/del&gt;&lt;/a&gt;) we only fetch one extra row at a time, SRP doesn&apos;t work correctly for most cases at all.&lt;/p&gt;</comment>
                            <comment id="16166501" author="iamaleksey" created="Thu, 14 Sep 2017 15:54:20 +0000"  >&lt;p&gt;The reason our existing dtests never caught it is that all of them only require getting one extra row at most, if anyone&apos;s curious.&lt;/p&gt;</comment>
                            <comment id="16166781" author="benedict" created="Thu, 14 Sep 2017 18:28:04 +0000"  >&lt;p&gt;&lt;del&gt;nit: the comment suggests we will not apply the transformations &quot;correctly&quot; to future partitions; in reality, the new transformation will be applied just fine, we will just begin accumulating the old ones.  Since it was the counter transformation preceding MoreRows, this meant we began double, triple, etc. counting each time we extended.  Had it been the &quot;protection&quot; transformation this would have just meant a transient memory leak (of sorts) and a modest incremental CPU burden.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;My bad, I&apos;m forgetting which way around extensions work (it&apos;s been a while, even if I did write them).  In which case I would elide &quot;correctly&quot; as they won&apos;t be applied at all&lt;/p&gt;

&lt;p&gt;Also, grammatically, we&apos;re not &quot;extending MoreRows&quot; we&apos;re extending &quot;partition&quot; &lt;em&gt;with&lt;/em&gt; MoreRows &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16168131" author="iamaleksey" created="Fri, 15 Sep 2017 16:33:43 +0000"  >&lt;p&gt;Thanks, committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/9ea61305ec30a476f48320c06f56d8d67000bbbe&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;9ea61305ec30a476f48320c06f56d8d67000bbbe&lt;/a&gt; and merged with 3.11 and trunk, with grammar corrected. Or altered, anyway. dtest committed as &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/9119cdfe921a2f39a315badd58900a12409d506e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;9119cdfe921a2f39a315badd58900a12409d506e&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;All unit tests are passing, although a few flaked out on CircleCI and had to be rerun locally. &lt;tt&gt;CommitLogSegmentManagerTest&lt;/tt&gt; in 3.0, &lt;tt&gt;DeleteTest&lt;/tt&gt;, &lt;tt&gt;PreparedStatementsTest&lt;/tt&gt;, and &lt;tt&gt;RemoveTest&lt;/tt&gt; on 3.11, and &lt;tt&gt;ViewTest&lt;/tt&gt; in 4.0. Links to runs: &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/30&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/31&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;, &lt;a href=&quot;https://circleci.com/gh/iamaleksey/cassandra/32&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;On dtests front, there is one new legit failure - in &lt;tt&gt;consistency_test.py:TestConsistency.test_13747&lt;/tt&gt;. Fixing the bug with counting exposed yet another bug in SRP and potentially an orthogonal issue with the read path. It has to do with how we handle &lt;tt&gt;EMPTY&lt;/tt&gt; clustering and bounds. See &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13880&quot; title=&quot;Fix short read protection for tables with no clustering columns&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13880&quot;&gt;&lt;del&gt;CASSANDRA-13880&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

</comment>
                    </comments>
                    <attachments>
                            <attachment id="12836670" name="limiterr-reproduce.sh" size="2419" author="mgvbhaskar" created="Wed, 2 Nov 2016 21:50:46 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 9 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i35rhz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332830">2.0.17</customfieldvalue>
    <customfieldvalue id="12337740">2.1.16</customfieldvalue>
    <customfieldvalue id="12337349">3.0.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>