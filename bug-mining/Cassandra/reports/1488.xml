<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:29:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3537] ExpiringMap timer is not exception-proof</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3537</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I have 4 cassandra nodes ,and I put about 30G data to db for every nodes . It&apos;s just 4 days before I start the cluster ,but now every 4 nodes have the same problem ,JVM heap is full  ,and  GC take no effect ,There must be some memory leak . Jmap the memory as follow:&lt;/p&gt;

&lt;p&gt;Object Histogram:&lt;/p&gt;

&lt;p&gt;num 	  #instances	#bytes	Class description&lt;br/&gt;
--------------------------------------------------------------------------&lt;br/&gt;
1:		15793606	758093088	java.nio.HeapByteBuffer&lt;br/&gt;
2:		2153811	320138208	java.lang.Object[]&lt;br/&gt;
3:		6163192	197222144	org.apache.cassandra.db.Column&lt;br/&gt;
4:		2543836	175890256	int[]&lt;br/&gt;
5:		2168816	155397192	long[]&lt;br/&gt;
6:		2078123	116374888	org.cliffc.high_scale_lib.ConcurrentAutoTable$CAT&lt;br/&gt;
7:		1847111	73884440	java.math.BigInteger&lt;br/&gt;
8:		1234243	59243664	java.util.Hashtable&lt;br/&gt;
9:		1770829	58233000	char[]&lt;br/&gt;
10:		1770627	56660064	java.lang.String&lt;br/&gt;
11:		1665886	39981264	org.apache.cassandra.db.DecoratedKey&lt;br/&gt;
12:		692706	38791536	org.cliffc.high_scale_lib.NonBlockingHashMap$CHM&lt;br/&gt;
13:		1234274	37172088	java.util.Hashtable$Entry[]&lt;br/&gt;
14:		1133541	36273312	java.net.Inet4Address&lt;br/&gt;
15:		738528	35449344	org.apache.cassandra.service.ReadCallback&lt;br/&gt;
16:		2078118	33249888	org.cliffc.high_scale_lib.Counter&lt;br/&gt;
17:		1373886	32973264	org.apache.cassandra.db.ReadResponse&lt;br/&gt;
18:		1234023	29616552	org.apache.cassandra.net.Message&lt;br/&gt;
19:		1234019	29616456	org.apache.cassandra.net.Header&lt;br/&gt;
20:		1846185	29538960	org.apache.cassandra.dht.BigIntegerToken&lt;br/&gt;
21:		891378	28524096	org.apache.cassandra.utils.ExpiringMap$CacheableObject&lt;br/&gt;
22:		692706	27708240	org.cliffc.high_scale_lib.NonBlockingHashMap&lt;br/&gt;
23:		1148252	27558048	java.util.Collections$SynchronizedSet&lt;br/&gt;
24:		541977	26014896	org.apache.cassandra.db.SliceFromReadCommand&lt;br/&gt;
25:		998001	23952024	java.util.concurrent.ConcurrentSkipListMap$Node&lt;br/&gt;
26:		928792	22291008	java.util.ArrayList&lt;br/&gt;
27:		692715	22166880	java.util.concurrent.atomic.AtomicReferenceFieldUpdater$AtomicReferenceFieldUpdaterImpl&lt;br/&gt;
28:		891378	21393072	org.apache.cassandra.net.CallbackInfo&lt;br/&gt;
29:		1148247	18371952	java.util.Hashtable$KeySet&lt;br/&gt;
30:		731859	17564616	org.apache.cassandra.db.Row&lt;br/&gt;
31:		529991	16959712	org.apache.cassandra.db.ArrayBackedSortedColumns&lt;br/&gt;
32:		691425	16594200	org.apache.cassandra.db.AbstractColumnContainer$DeletionInfo&lt;br/&gt;
33:		648580	15565920	org.apache.cassandra.db.filter.QueryPath&lt;br/&gt;
34:		648338	15560112	org.apache.cassandra.service.RowDigestResolver&lt;br/&gt;
35:		971376	15542016	java.util.concurrent.atomic.AtomicInteger&lt;br/&gt;
36:		837418	13398688	org.apache.cassandra.utils.SimpleCondition&lt;br/&gt;
37:		535614	12854736	org.apache.cassandra.db.ColumnFamily&lt;br/&gt;
38:		725634	11610144	java.util.concurrent.atomic.AtomicReference&lt;br/&gt;
39:		195117	9365616	org.apache.cassandra.db.ThreadSafeSortedColumns&lt;br/&gt;
40:		281921	9021472	java.util.concurrent.ConcurrentSkipListMap$HeadIndex&lt;br/&gt;
41:		277679	8885728	java.util.concurrent.locks.ReentrantLock$NonfairSync&lt;br/&gt;
42:		314424	7546176	java.util.concurrent.ConcurrentSkipListMap$Index&lt;br/&gt;
43:		275186	6604464	java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject&lt;br/&gt;
44:		270280	6486720	java.util.concurrent.LinkedBlockingQueue$Node&lt;br/&gt;
45:		219553	5269272	org.apache.cassandra.io.sstable.IndexSummary$KeyPosition&lt;br/&gt;
46:		106436	5108928	java.util.TreeMap&lt;br/&gt;
47:		122185	4887400	org.apache.cassandra.db.ExpiringColumn&lt;br/&gt;
48:		189968	4559232	org.apache.cassandra.db.SuperColumn&lt;br/&gt;
49:		275659	4410544	java.util.concurrent.locks.ReentrantLock&lt;br/&gt;
50:		90213	4330224	java.util.concurrent.LinkedBlockingQueue&lt;br/&gt;
51:		107026	4281040	java.util.TreeMap$Entry&lt;br/&gt;
52:		30501	4222056	* ConstMethodKlass&lt;/p&gt;</description>
                <environment>&lt;p&gt;&#24403;&#21069;&#22534;&#22823;&#23567;:&#160;&lt;br/&gt;
5,815,955 Kb&lt;br/&gt;
&#22534;&#22823;&#23567;&#30340;&#26368;&#22823;&#20540;:&#160;&lt;br/&gt;
6,045,696 Kb&lt;br/&gt;
&#20998;&#37197;&#30340;&#20869;&#23384;:&#160;&lt;br/&gt;
6,045,696 Kb&lt;br/&gt;
&#26242;&#25346;&#32467;&#26463;&#25805;&#20316;:&#160;&lt;br/&gt;
0 &#20010;&#23545;&#35937;&lt;br/&gt;
&#22403;&#22334;&#25910;&#38598;&#22120;:&#160;&lt;br/&gt;
Name = &apos;ParNew&apos;, Collections = 3,294, Total time spent = 2 minutes&lt;br/&gt;
&#22403;&#22334;&#25910;&#38598;&#22120;:&#160;&lt;br/&gt;
Name = &apos;ConcurrentMarkSweep&apos;, Collections = 5,909, Total time spent = 2 hours 17 minutes&lt;/p&gt;

&lt;p&gt;&#25805;&#20316;&#31995;&#32479;:&#160;&lt;br/&gt;
Linux 2.6.32.12-0.7-default&lt;br/&gt;
&#20307;&#31995;&#32467;&#26500;:&#160;&lt;br/&gt;
amd64&lt;br/&gt;
&#22788;&#29702;&#22120;&#30340;&#25968;&#30446;:&#160;&lt;br/&gt;
16&lt;br/&gt;
&#20998;&#37197;&#30340;&#34394;&#25311;&#20869;&#23384;:&#160;&lt;br/&gt;
42,748,416 Kb&lt;br/&gt;
&#29289;&#29702;&#20869;&#23384;&#24635;&#37327;:&#160;&lt;br/&gt;
24,568,836 Kb&lt;br/&gt;
&#21487;&#29992;&#29289;&#29702;&#20869;&#23384;:&#160;&lt;br/&gt;
&#160;7,136,380 Kb&lt;br/&gt;
&#20132;&#25442;&#31354;&#38388;&#24635;&#37327;:&#160;&lt;br/&gt;
&#160;2,104,472 Kb&lt;br/&gt;
&#21487;&#29992;&#20132;&#25442;&#31354;&#38388;:&#160;&lt;br/&gt;
&#160;1,970,800 Kb&lt;/p&gt;

&lt;p&gt;VM &#21442;&#25968;:&#160;&lt;br/&gt;
-ea -XX:+UseThreadPriorities -XX:ThreadPriorityPolicy=42 -Xms6G -Xmx6G -Xmn2400M -XX:+HeapDumpOnOutOfMemoryError -Xss128k -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+CMSParallelRemarkEnabled -XX:SurvivorRatio=8 -XX:MaxTenuringThreshold=1 -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -Djava.net.preferIPv4Stack=true -Dcom.sun.management.jmxremote.port=9000 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false -Dpasswd.properties=/opt/obs/cassandra/conf/passwd.properties -Dpasswd.mode=MD5 -Dlog4j.configuration=log4j-server.properties -Dlog4j.defaultInitOverride=true &lt;br/&gt;
&#31867;&#36335;&#24452;:&#160;&lt;br/&gt;
/opt/obs/cassandra/conf:/opt/obs/cassandra/build/classes/main:/opt/obs/cassandra/build/classes/thrift:/opt/obs/cassandra/lib/antlr-3.2.jar:/opt/obs/cassandra/lib/apache-cassandra-1.0.0.jar:/opt/obs/cassandra/lib/apache-cassandra-clientutil-1.0.0.jar:/opt/obs/cassandra/lib/apache-cassandra-thrift-1.0.0.jar:/opt/obs/cassandra/lib/avro-1.4.0-fixes.jar:/opt/obs/cassandra/lib/avro-1.4.0-sources-fixes.jar:/opt/obs/cassandra/lib/cassandra_simple_authentication.jar:/opt/obs/cassandra/lib/commons-cli-1.1.jar:/opt/obs/cassandra/lib/commons-codec-1.2.jar:/opt/obs/cassandra/lib/commons-lang-2.4.jar:/opt/obs/cassandra/lib/compress-lzf-0.8.4.jar:/opt/obs/cassandra/lib/concurrentlinkedhashmap-lru-1.2.jar:/opt/obs/cassandra/lib/guava-r08.jar:/opt/obs/cassandra/lib/high-scale-lib-1.1.2.jar:/opt/obs/cassandra/lib/jackson-core-asl-1.4.0.jar:/opt/obs/cassandra/lib/jackson-mapper-asl-1.4.0.jar:/opt/obs/cassandra/lib/jamm-0.2.5.jar:/opt/obs/cassandra/lib/jline-0.9.94.jar:/opt/obs/cassandra/lib/json-simple-1.1.jar:/opt/obs/cassandra/lib/libthrift-0.6.jar:/opt/obs/cassandra/lib/log4j-1.2.16.jar:/opt/obs/cassandra/lib/servlet-api-2.5-20081211.jar:/opt/obs/cassandra/lib/slf4j-api-1.6.1.jar:/opt/obs/cassandra/lib/slf4j-log4j12-1.6.1.jar:/opt/obs/cassandra/lib/snakeyaml-1.6.jar:/opt/obs/cassandra/lib/snappy-java-1.0.3.jar&lt;/p&gt;</environment>
        <key id="12533074">CASSANDRA-3537</key>
            <summary>ExpiringMap timer is not exception-proof</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="jonma">MaHaiyang</reporter>
                        <labels>
                    </labels>
                <created>Tue, 29 Nov 2011 07:24:55 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:45 +0000</updated>
                            <resolved>Fri, 24 Feb 2012 15:26:26 +0000</resolved>
                                        <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13159140" author="jbellis" created="Tue, 29 Nov 2011 07:34:24 +0000"  >&lt;p&gt;Reduce the memtable_total_space_in_mb setting.&lt;/p&gt;</comment>
                            <comment id="13159742" author="jonma" created="Wed, 30 Nov 2011 02:00:00 +0000"  >&lt;p&gt;Thank u very much . But I have a test tonight  ,I changed my 4 cassandra nodes&apos;  max heap size and memtable_total_space_in_mb setting as follow:&lt;br/&gt;
node A: heap size :6G  , memtable_total_space_in_mb = 1G (as you say ,I reduce the memtable_total_space_in_mb setting)&lt;br/&gt;
node B: 8G   ,  default ;&lt;br/&gt;
node C: 5G   ,  default ;&lt;br/&gt;
node D: 8G   ,  1G  ;&lt;br/&gt;
Then I restart the cluster, and begin to push data to it . This morning I have a frustrated test result ,  node A heap is full  ,node B OK , node C OK , node D heap is full . &lt;/p&gt;

&lt;p&gt;I don&apos;t know how to explain it .&lt;/p&gt;
</comment>
                            <comment id="13159747" author="jbellis" created="Wed, 30 Nov 2011 02:11:43 +0000"  >&lt;p&gt;what liveRatio is being logged for your workload?&lt;/p&gt;

&lt;p&gt;can you reproduce using a synthetic Stress workload?  (stress tool available w/ source distribution)&lt;/p&gt;</comment>
                            <comment id="13159801" author="jonma" created="Wed, 30 Nov 2011 03:50:05 +0000"  >&lt;p&gt;In system.log ,I find this : &lt;br/&gt;
&amp;lt;164&amp;gt; 4 2011-11-29T15:29:57.890714+00:00   WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;MutationStage:10&amp;#93;&lt;/span&gt; 2011-11-29 15:29:57,890 Memtable.java (line 142) MemoryMeter uninitialized (jamm not specified as java agent); assuming liveRatio of 10.0.  Usually this means cassandra-env.sh disabled jamm because you are using a buggy JRE; upgrade to the Sun JRE instead .&lt;/p&gt;

&lt;p&gt;I have no idea this will affect the test result ,or not . But all of my 4 cassandra nodes have the same log . I checked my system physical memory size : node A: 16 G ,ulimit -v :14G   node B:  32G , ulimit 28G ,  node C :48G ,ulimit -v 42G  node D:24G ulimit -v 21G , &lt;/p&gt;

&lt;p&gt;The ulimit -v setting will result the problem ?&lt;/p&gt;

&lt;p&gt;ps : There is another java application run on my machine  . It result the log WARN .&lt;br/&gt;
 I haven&apos;t use Stress as workload ,I use a workload like YCSB based on Hector .&lt;br/&gt;
 There are 8 user CF in the system.&lt;/p&gt;



</comment>
                            <comment id="13159821" author="jbellis" created="Wed, 30 Nov 2011 05:02:56 +0000"  >&lt;p&gt;You should upgrade to the Sun/Oracle JVM as it suggests.&lt;/p&gt;</comment>
                            <comment id="13159826" author="jonma" created="Wed, 30 Nov 2011 05:17:05 +0000"  >&lt;p&gt;In fact ,my jvm is Sun JVM, Java HotSpot(TM) 64-Bit Server VM  19.1-b02 .&lt;/p&gt;</comment>
                            <comment id="13159835" author="jbellis" created="Wed, 30 Nov 2011 05:32:44 +0000"  >&lt;p&gt;Then you&apos;ll have to come up with an alternative explanation for why jamm isn&apos;t being used.&lt;/p&gt;</comment>
                            <comment id="13159841" author="jonma" created="Wed, 30 Nov 2011 05:45:08 +0000"  >
&lt;p&gt;If I terminate the another java application ,it will not have the log WARN .&lt;br/&gt;
I think I should terminate the another java application first , then do a new test again.  Thanks.&lt;br/&gt;
========================================&lt;br/&gt;
ps : There is another java application run on my machine . It result the log WARN .&lt;br/&gt;
I haven&apos;t use Stress as workload ,I use a workload like YCSB based on Hector .&lt;br/&gt;
.......&lt;/p&gt;</comment>
                            <comment id="13161363" author="jonma" created="Fri, 2 Dec 2011 02:04:25 +0000"  >&lt;p&gt;After  I set jamm correctly , I do a new test , and haven&apos;t find the memory problem in 20 hours  .But I could&apos;t confirm it&apos;s  &quot;jamm not specified as java agent&quot;  result the heap problem . I analysised the dump memory info of the node which had the heap problem , they nearly have the same thing :  too many Message objects and ralated objects like below,although I have stoped reading and writing data for a few minutes and  empty all memtables  .&lt;br/&gt;
#instances	#bytes	Class description&lt;br/&gt;
---------------------------------------------&lt;br/&gt;
900654	21615696	org.apache.cassandra.net.Message&lt;br/&gt;
900653	21615672	org.apache.cassandra.net.Header&lt;br/&gt;
341351	16384848	org.apache.cassandra.service.ReadCallback&lt;br/&gt;
338502	13540080	org.apache.cassandra.db.RangeSliceCommand&lt;br/&gt;
338500	10832000	org.apache.cassandra.thrift.SliceRange&lt;br/&gt;
338502	8124048	org.apache.cassandra.thrift.SlicePredicate&lt;br/&gt;
343328	5493248	org.apache.cassandra.utils.SimpleCondition&lt;/p&gt;


&lt;p&gt;Is there someone can tell me ,whether there are some relationship between &quot;jamm not specified as java agent&quot; and so many &lt;br/&gt;
objects like above  ?&lt;/p&gt;
</comment>
                            <comment id="13161451" author="jonma" created="Fri, 2 Dec 2011 06:45:50 +0000"  >&lt;p&gt;Heap memory can not be GC again in my lasted test , although I have set jamm correctly . Jmap the memory ,find the same thing  ,too many Message objects and ralated objects  in the memory ! &lt;br/&gt;
I have empty all memtables ,in normal condition , heap memory used not more than 0.5G ,but now more than 2.8G . I think only memory leak will result this .&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-xml&quot;&gt; 
Object Histogram:

num 	  #instances	#bytes	Class description
--------------------------------------------------------------------------
1:		9101138	927302160	byte[]
2:		9998059	479906832	java.nio.HeapByteBuffer
3:		875398	221844128	long[]
4:		4302698	137686336	org.apache.cassandra.db.Column
5:		869859	137476712	java.lang.Object[]
6:		1794458	101193096	int[]
7:		1515578	60623120	java.math.BigInteger
8:		834628	46739168	org.cliffc.high_scale_lib.ConcurrentAutoTable$CAT
9:		1644330	39463920	java.util.concurrent.ConcurrentSkipListMap$Node
10:		1461787	35082888	org.apache.cassandra.db.DecoratedKey
11:		513576	24651648	java.util.Hashtable
12:		741037	24559960	char[]
13:		1512396	24198336	org.apache.cassandra.dht.BigIntegerToken
14:		741097	23715104	java.lang.String
15:		732184	17572416	org.apache.cassandra.io.sstable.IndexSummary$KeyPosition
16:		513594	15637344	java.util.Hashtable$Entry[]
17:		278209	15579704	org.cliffc.high_scale_lib.NonBlockingHashMap$CHM
18:		462641	14804512	java.net.Inet4Address
19:		578801	13891224	java.util.concurrent.ConcurrentSkipListMap$Index
20:		834627	13354032	org.cliffc.high_scale_lib.Counter
21:		556415	13353960	org.apache.cassandra.db.ReadResponse
22:		267483	12839184	org.apache.cassandra.service.ReadCallback
23:		513250	12318000	org.apache.cassandra.net.Message
24:		513248	12317952	org.apache.cassandra.net.Header
25:		501596	12038304	org.apache.cassandra.db.AbstractColumnContainer$DeletionInfo
26:		244644	11742912	org.apache.cassandra.db.ThreadSafeSortedColumns
27:		365024	11680768	java.util.concurrent.ConcurrentSkipListMap$HeadIndex
28:		464800	11155200	java.util.Collections$SynchronizedSet
29:		278209	11128360	org.cliffc.high_scale_lib.NonBlockingHashMap
30:		342741	10967712	org.apache.cassandra.utils.ExpiringMap$CacheableObject
31:		199478	9574944	org.apache.cassandra.db.SliceFromReadCommand
32:		278218	8902976	java.util.concurrent.atomic.AtomicReferenceFieldUpdater$AtomicReferenceFieldUpdaterImpl
33:		348179	8356296	org.apache.cassandra.db.ColumnFamily
34:		342741	8225784	org.apache.cassandra.net.CallbackInfo
35:		255241	8167712	org.apache.cassandra.db.ArrayBackedSortedColumns
36:		334724	8033376	java.util.ArrayList
37:		499963	7999408	java.util.concurrent.atomic.AtomicReference
38:		319779	7674696	org.apache.cassandra.db.Row
39:		187484	7499360	org.apache.cassandra.db.Memtable$6
40:		464794	7436704	java.util.Hashtable$KeySet
41:		187496	5999872	java.util.TreeMap$KeyIterator
42:		372748	5963968	java.util.concurrent.atomic.AtomicInteger
43:		236877	5685048	org.apache.cassandra.db.filter.QueryPath
44:		236733	5681592	org.apache.cassandra.service.RowDigestResolver
45:		300385	4806160	org.apache.cassandra.utils.SimpleCondition
46:		30726	4245920	* ConstMethodKlass
47:		30726	3696240	* MethodKlass
48:		151726	3641424	org.apache.cassandra.db.SuperColumn
49:		3134	3350536	* ConstantPoolKlass
50:		95622	3059904	java.util.concurrent.locks.ReentrantLock$NonfairSync
51:		45910	2497952	* SymbolKlass
52:		3134	2276040	* InstanceKlassKlass
53:		94544	2269056	java.util.concurrent.LinkedBlockingQueue$Node
54:		93130	2235120	java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject
55:		133398	2134368	java.util.concurrent.ConcurrentSkipListMap$Values
56:		2813	2099368	* ConstantPoolCacheKlass
57:		37698	1809504	java.util.TreeMap
58:		37783	1511320	java.util.TreeMap$Entry
59:		93602	1497632	java.util.concurrent.locks.ReentrantLock
60:		30768	1476864	java.util.concurrent.LinkedBlockingQueue
61:		85156	1362496	java.util.concurrent.ConcurrentSkipListMap$EntrySet
62:		41451	1326432	org.apache.cassandra.service.RowRepairResolver
63:		41141	1316512	java.util.concurrent.ConcurrentHashMap$HashEntry
64:		32885	1315400	org.apache.cassandra.service.WriteResponseHandler
65:		3110	1277672	* MethodDataKlass
66:		39780	1272960	com.googlecode.concurrentlinkedhashmap.ConcurrentLinkedHashMap$Node
67:		31556	1262240	org.apache.cassandra.net.AsyncResult
68:		30745	1229800	org.apache.cassandra.db.RangeSliceCommand
69:		37628	1204096	org.apache.cassandra.db.SliceByNamesReadCommand
70:		44528	1068672	com.googlecode.concurrentlinkedhashmap.ConcurrentLinkedHashMap$WeightedValue
71:		31974	1023168	java.util.concurrent.locks.AbstractQueuedSynchronizer$Node
72:		41435	994440	org.apache.cassandra.service.AsyncRepairCallback
73:		30821	986272	org.apache.cassandra.thrift.SliceRange
74:		30756	984192	java.util.RandomAccessSubList
75:		30745	983840	org.apache.cassandra.service.RangeSliceResponseResolver
76:		29115	931680	org.apache.cassandra.db.DeletedColumn
77:		21676	867040	org.apache.cassandra.db.ExpiringColumn
78:		35339	848136	java.lang.Long
79:		35204	844896	org.apache.cassandra.utils.Pair
80:		30924	742176	java.util.BitSet
81:		30821	739704	org.apache.cassandra.thrift.SlicePredicate
82:		30787	738888	org.apache.cassandra.dht.Bounds
83:		37673	602768	java.util.TreeSet
84:		37654	602464	java.util.TreeMap$KeySet
85:		31598	505568	java.util.concurrent.atomic.AtomicBoolean
86:		6575	420800	java.nio.DirectByteBufferR
87:		2004	416400	java.util.concurrent.ConcurrentHashMap$HashEntry[]
88:		3433	357032	java.lang.Class
89:		8976	287232	java.lang.ref.WeakReference
90:		4999	269008	short[]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; </comment>
                            <comment id="13162569" author="jonma" created="Mon, 5 Dec 2011 03:02:19 +0000"  >&lt;p&gt;I spend a whole week analyse this problem , Now I find this problem is only caused by &lt;font color=&quot;red&quot;&gt; &lt;br/&gt;
the cache in ExpiringMap &lt;/font&gt; &lt;br/&gt;
 which is a NonBlockingHashMap . Why this cache can make the heap memory full and never be GC ?&lt;/p&gt;</comment>
                            <comment id="13162617" author="jbellis" created="Mon, 5 Dec 2011 05:55:22 +0000"  >&lt;p&gt;That is where callbacks for ongoing requests are stored.&lt;/p&gt;</comment>
                            <comment id="13162624" author="jonma" created="Mon, 5 Dec 2011 06:19:23 +0000"  >&lt;p&gt;Yes. &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;ExpiringMap.java&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;/**
     *
     * @param expiration the TTL &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; objects in the cache in milliseconds
     */
    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; ExpiringMap(&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; expiration, &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; Function&amp;lt;Pair&amp;lt;K,V&amp;gt;, ?&amp;gt; postExpireHook)
    {
        ....
        timer = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Timer(&lt;span class=&quot;code-quote&quot;&gt;&quot;EXPIRING-MAP-TIMER-&quot;&lt;/span&gt; + (++counter), &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
        TimerTask task = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TimerTask()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void run()
            {
                &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; start = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.currentTimeMillis();
                &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Map.Entry&amp;lt;K, CacheableObject&amp;lt;V&amp;gt;&amp;gt; entry : cache.entrySet())
                {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (entry.getValue().isReadyToDie(start))
                    {
                        cache.remove(entry.getKey());
                        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (postExpireHook != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
                            postExpireHook.apply(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Pair&amp;lt;K, V&amp;gt;(entry.getKey(), entry.getValue().getValue()));
                    }
                }
            }
        };
        timer.schedule(task, expiration / 2, expiration / 2);
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;The code above exist a bug . If a exception occured in the run method ,the timer will be killed and no longer to expire the value in cache .&lt;br/&gt;
I find that if there is no &quot;EXPIRING-MAP-TIMER- x&quot; thread in the memory  when there is a  heap problem , and if there is a &quot;EXPIRING-MAP-TIMER- x&quot; thread in the memory   there is no heap problem .&lt;/p&gt;</comment>
                            <comment id="13162789" author="jbellis" created="Mon, 5 Dec 2011 14:10:22 +0000"  >&lt;p&gt;That&apos;s true, but unless you&apos;re seeing exceptions in the log it should be a non-issue.&lt;/p&gt;</comment>
                            <comment id="13163533" author="jonma" created="Tue, 6 Dec 2011 11:36:14 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Jonathan Ellis added a comment - 05/Dec/11 14:10 &lt;br/&gt;
That&apos;s true, but unless you&apos;re seeing exceptions in the log it should be a non-issue.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;2011-12-06 06:50:23,383 AbstractCassandraDaemon.java (line 133) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;EXPIRING-MAP-TIMER-1,5,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError: /xxx.xxx.xx.xx&lt;br/&gt;
      at org.apache.cassandra.service.StorageProxy.scheduleLocalHint(StorageProxy.java:337)&lt;br/&gt;
      at org.apache.cassandra.net.MessagingService.scheduleMutationHint(MessagingService.java:199)&lt;br/&gt;
      at org.apache.cassandra.net.MessagingService.access$500(MessagingService.java:62)&lt;br/&gt;
      at org.apache.cassandra.net.MessagingService$2.apply(MessagingService.java:173)&lt;br/&gt;
      at org.apache.cassandra.net.MessagingService$2.apply(MessagingService.java:150)&lt;br/&gt;
      at org.apache.cassandra.utils.ExpiringMap$1.run(ExpiringMap.java:89)&lt;br/&gt;
      at java.util.TimerThread.mainLoop(Timer.java:512)&lt;br/&gt;
      at java.util.TimerThread.run(Timer.java:462)&lt;/p&gt;</comment>
                            <comment id="13163589" author="jbellis" created="Tue, 6 Dec 2011 13:35:51 +0000"  >&lt;p&gt;That&apos;s &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3440&quot; title=&quot;local writes timing out cause attempt to hint to self&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3440&quot;&gt;&lt;del&gt;CASSANDRA-3440&lt;/del&gt;&lt;/a&gt;, you should upgrade.&lt;/p&gt;</comment>
                            <comment id="13164112" author="jonma" created="Wed, 7 Dec 2011 03:38:01 +0000"  >&lt;p&gt;Thanks very much . Helps a lot .&lt;/p&gt;</comment>
                            <comment id="13213522" author="slebresne" created="Wed, 22 Feb 2012 10:59:15 +0000"  >&lt;p&gt;Simple patch attached to make expiring map more exception proof.&lt;/p&gt;</comment>
                            <comment id="13213530" author="jonma" created="Wed, 22 Feb 2012 11:15:24 +0000"  >
&lt;blockquote&gt;
&lt;p&gt;Simple patch attached to make expiring map more exception proof.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Please catch Throwable  , not just only catch Exception. It may have Errors in try-catch block.&lt;/p&gt;</comment>
                            <comment id="13213670" author="jbellis" created="Wed, 22 Feb 2012 14:51:39 +0000"  >&lt;p&gt;catching Throwable or Error is generally Bad because most Errors are not recoverable. OutOfMemoryError is the most common. We have a global exception hook set up to shut down the process for those.&lt;/p&gt;</comment>
                            <comment id="13213763" author="jbellis" created="Wed, 22 Feb 2012 17:00:49 +0000"  >&lt;p&gt;v2 attached that address this for DSTPE in general.  Also fixes a double-log of RuntimeExceptions from ThreadPoolExecutor in our DTPE afterExecute code.&lt;/p&gt;

&lt;p&gt;The culprit for this last part is this fragment from TPE.runTask:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;.               &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
                    task.run();
                    ran = &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;;
                    afterExecute(task, &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;);
                    ++completedTasks;
                } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (RuntimeException ex) {
                    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!ran)
                        afterExecute(task, ex);
                    &lt;span class=&quot;code-keyword&quot;&gt;throw&lt;/span&gt; ex;
                }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That is, for &quot;raw&quot; exceptions thrown by the Task (and not wrapped inside FutureTask), runTask will already re-throw the exception, allowing our default uncaught exception handler to log it.  So we don&apos;t want to double-log that in DTPE.&lt;/p&gt;</comment>
                            <comment id="13213798" author="slebresne" created="Wed, 22 Feb 2012 17:59:14 +0000"  >&lt;p&gt;I like the idea of using DSTPE. I&apos;m not sure I understand why LoggingScheduledFuture is useful though. STPE already wraps runnables into FutureTask, which catches Throwable and turn them into ExecutionException. So DSTPE.afterExecute() should already get everything.&lt;/p&gt;

&lt;p&gt;However, I think we may need the kind of wrapper LoggingScheduledFuture implements for DPTE, since if we use the TPE.execute() method (which we do), then the runnable is not wrapped by a FutureTask and thrown exception will be thrown in TPE.runTask. And since TPE.runTask only catches RuntimeException...&lt;/p&gt;

&lt;p&gt;As a side note, I notice your patch is against 1.1 which I&apos;m good with but we may want to change the fix version then.&lt;/p&gt;</comment>
                            <comment id="13213893" author="jbellis" created="Wed, 22 Feb 2012 19:24:02 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;m not sure I understand why LoggingScheduledFuture is useful though&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The problem I&apos;m trying to solve is, the core of STPE.ScheduledFutureTask:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;.       &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void runPeriodic() {
            &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; ok = ScheduledFutureTask.&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.runAndReset();
            &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; down = isShutdown();
            &lt;span class=&quot;code-comment&quot;&gt;// Reschedule &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; not cancelled and not shutdown or policy allows
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ok &amp;amp;&amp;amp; (!down ||
                       (getContinueExistingPeriodicTasksAfterShutdownPolicy() &amp;amp;&amp;amp;
                        !isStopped()))) {
                &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; p = period;
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (p &amp;gt; 0)
                    time += p;
                &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
                    time = triggerTime(-p);
                ScheduledThreadPoolExecutor.&lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;.getQueue().add(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
            }
            &lt;span class=&quot;code-comment&quot;&gt;// This might have been the &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; executed delayed
&lt;/span&gt;            &lt;span class=&quot;code-comment&quot;&gt;// task.  Wake up threads to check.
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (down)
                interruptIdleWorkers();
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;In other words, &quot;If any execution of the task encounters an exception, subsequent executions are suppressed.&quot;&lt;/p&gt;

&lt;p&gt;That said, you&apos;re right that a second wrapper doesn&apos;t solve this problem.  Not sure what to do here.  Use reflection to reach into the SFT in afterExecute, and re-schedule the original Runnable?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;if we use the TPE.execute() method (which we do), then the runnable is not wrapped by a FutureTask and thrown exception will be thrown in TPE.runTask&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s fine though, since TPE.execute is inherently non-repeating.&lt;/p&gt;</comment>
                            <comment id="13214515" author="slebresne" created="Thu, 23 Feb 2012 09:48:14 +0000"  >&lt;blockquote&gt;&lt;p&gt;In other words, &quot;If any execution of the task encounters an exception, subsequent executions are suppressed.&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I see.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Use reflection to reach into the SFT in afterExecute, and re-schedule the original Runnable?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That would be one option I suppose. Another would be to override all the schedule() method to wrap the runnable into a wrapper that would resubmit the task on exception (we would avoid reflection, not sure it&apos;s simpler though).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;That&apos;s fine though, since TPE.execute is inherently non-repeating.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;True.&lt;/p&gt;</comment>
                            <comment id="13214667" author="jbellis" created="Thu, 23 Feb 2012 14:14:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;Another would be to override all the schedule() method to wrap the runnable &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s going to require reflection as well since SFT is private. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13214675" author="slebresne" created="Thu, 23 Feb 2012 14:23:50 +0000"  >&lt;p&gt;No I meant that we would wrap the initial Runnable into another Runnable that catches every exception of the first one and log them. In other words, as far as STPE is concerned, our runnable would never ever fail (and thus would never be suppressed).&lt;/p&gt;</comment>
                            <comment id="13214880" author="jbellis" created="Thu, 23 Feb 2012 17:46:46 +0000"  >&lt;p&gt;That makes sense.  v4 attached with this approach.&lt;/p&gt;</comment>
                            <comment id="13214881" author="jbellis" created="Thu, 23 Feb 2012 17:47:16 +0000"  >&lt;p&gt;(And yes, I think this should target 1.1 instead of 1.0.9 since messing with executors scares me a bit.)&lt;/p&gt;</comment>
                            <comment id="13215537" author="slebresne" created="Fri, 24 Feb 2012 09:59:54 +0000"  >&lt;p&gt;+1 (nit: the overriden schedule method misses their @Override)&lt;/p&gt;</comment>
                            <comment id="13215672" author="jbellis" created="Fri, 24 Feb 2012 15:26:26 +0000"  >&lt;p&gt;Added @Override and committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12515612" name="3537-v2.txt" size="10639" author="jbellis" created="Wed, 22 Feb 2012 17:00:49 +0000"/>
                            <attachment id="12515768" name="3537-v4.txt" size="10116" author="jbellis" created="Thu, 23 Feb 2012 17:46:46 +0000"/>
                            <attachment id="12515573" name="3537.txt" size="1712" author="slebresne" created="Wed, 22 Feb 2012 10:59:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>218802</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 39 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gl4n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94853</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>