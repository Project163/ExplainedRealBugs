<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5746] HHOM.countPendingHints is a trap for the unwary</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5746</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;countPendingHints can OOM the server fairly easily since it does a per-target seq scan without paging.&lt;/p&gt;

&lt;p&gt;More generally, countPendingHints is far too slow to be useful for routine monitoring.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12657166">CASSANDRA-5746</key>
            <summary>HHOM.countPendingHints is a trap for the unwary</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="jbellis">Jonathan Ellis</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Jul 2013 22:54:18 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:10 +0000</updated>
                            <resolved>Thu, 18 Jul 2013 20:27:56 +0000</resolved>
                                        <fixVersion>2.0 beta 2</fixVersion>
                                    <component>Legacy/Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13705205" author="jbellis" created="Wed, 10 Jul 2013 22:58:46 +0000"  >&lt;p&gt;If we want it to be fast enough for monitoring use, we need to denormalize the count.  So the question is, do we use a Counters table, a normal int table with manual lock-and-read-before-write, or just one-off it with AtomicInteger and sync to disk occasionally? &lt;/p&gt;

&lt;p&gt;Personally I&apos;d be inclined towards the last; it&apos;s okay if under- or over-count (because of periodic CL sync for instance), as long as we reliably distinguish between zero and non-zero hints for a given target.  We could sanity check that with an approach like listEndpointsPendingHints on startup, which would be fairly low-overhead.&lt;/p&gt;</comment>
                            <comment id="13710088" author="thobbs" created="Tue, 16 Jul 2013 19:00:54 +0000"  >&lt;p&gt;Doesn&apos;t the TTL on hints cells complicate all of those strategies?  I can&apos;t think of a cheap way to schedule all of those future decrements to a counter.&lt;/p&gt;

&lt;p&gt;Instead, I suppose we could recount on demand if the time since the last count is greater than the smallest TTL we&apos;ve seen, but without throttling of some sort recounts would still happen frequently under some circumstances.&lt;/p&gt;

&lt;p&gt;Alternatively, it seems like a fair amount of work, but perhaps a get_range_counts() implementation with internal auto-paging (like get_count) is a decent option?&lt;/p&gt;</comment>
                            <comment id="13710126" author="jbellis" created="Tue, 16 Jul 2013 19:34:01 +0000"  >&lt;p&gt;What if we redefine the problem to be &quot;how many hints have I generated for node X?&quot; and get rid of countPendingHints entirely?&lt;/p&gt;

&lt;p&gt;ISTM that&apos;s a more important indicator of cluster health than how many hints X expects to get when he comes back up.  I can live without that.&lt;/p&gt;</comment>
                            <comment id="13710160" author="thobbs" created="Tue, 16 Jul 2013 20:07:01 +0000"  >&lt;p&gt;&amp;gt; What if we redefine the problem to be &quot;how many hints have I generated for node X?&quot; and get rid of countPendingHints entirely?&lt;/p&gt;

&lt;p&gt;That seems like a reasonable replacement metric for most purposes, but I can see where countPendingHints() might still be useful.  However, in its current state, it seems too dangerous to leave in.  Maybe pull it out in this ticket and open a new ticket for a better implementation if there&apos;s interest?&lt;/p&gt;

&lt;p&gt;I&apos;m assuming we don&apos;t want to persist this one to disk. (Most RRD-style metric systems handle normally monotonically increasing metrics resetting to 0 occasionally, so just counting hints created since the node has been up should be fine.)&lt;/p&gt;</comment>
                            <comment id="13710191" author="jbellis" created="Tue, 16 Jul 2013 20:33:53 +0000"  >&lt;p&gt;Sounds good to me.  Let&apos;s try to get this into b2 so we don&apos;t rip it out of a stable release.&lt;/p&gt;</comment>
                            <comment id="13711639" author="thobbs" created="Wed, 17 Jul 2013 21:20:22 +0000"  >&lt;p&gt;0001 removes countPendingHints().&lt;/p&gt;

&lt;p&gt;0002 adds a per-endpoint count through the new metrics system. I made HHOM.hintFor() non-static, as I couldn&apos;t see why the singleton couldn&apos;t be used.  Let me know if there was some motivation for that.&lt;/p&gt;</comment>
                            <comment id="13712775" author="jbellis" created="Thu, 18 Jul 2013 20:27:57 +0000"  >&lt;p&gt;LGTM, committed.  (Tweaked to use LoadingCache.getUnchecked instead of manually throwing RTE ourselves, also in the existing incrPastWindow.)&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12592857" name="0001-Remove-HHOM.countPendingHints.patch" size="2332" author="thobbs" created="Wed, 17 Jul 2013 21:20:22 +0000"/>
                            <attachment id="12592858" name="0002-Report-created-hint-count-by-endpoint.patch" size="4811" author="thobbs" created="Wed, 17 Jul 2013 21:20:22 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>337389</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 18 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1m713:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>337712</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>