<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:41:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5981] Netty frame length exception when storing data to Cassandra using binary protocol</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5981</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Using Cassandra 1.2.8, I am running into an issue where when I send a large amount of data using the binary protocol, I get the following netty exception in the Cassandra log file:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;ERROR 09:08:35,845 Unexpected exception during request&lt;br/&gt;
org.jboss.netty.handler.codec.frame.TooLongFrameException: Adjusted frame length exceeds 268435456: 292413714 - discarded&lt;br/&gt;
        at org.jboss.netty.handler.codec.frame.LengthFieldBasedFrameDecoder.fail(LengthFieldBasedFrameDecoder.java:441)&lt;br/&gt;
        at org.jboss.netty.handler.codec.frame.LengthFieldBasedFrameDecoder.failIfNecessary(LengthFieldBasedFrameDecoder.java:412)&lt;br/&gt;
        at org.jboss.netty.handler.codec.frame.LengthFieldBasedFrameDecoder.decode(LengthFieldBasedFrameDecoder.java:372)&lt;br/&gt;
        at org.apache.cassandra.transport.Frame$Decoder.decode(Frame.java:181)&lt;br/&gt;
        at org.jboss.netty.handler.codec.frame.FrameDecoder.callDecode(FrameDecoder.java:422)&lt;br/&gt;
        at org.jboss.netty.handler.codec.frame.FrameDecoder.messageReceived(FrameDecoder.java:303)&lt;br/&gt;
        at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:268)&lt;br/&gt;
        at org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:255)&lt;br/&gt;
        at org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:84)&lt;br/&gt;
        at org.jboss.netty.channel.socket.nio.AbstractNioWorker.processSelectedKeys(AbstractNioWorker.java:472)&lt;br/&gt;
        at org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:333)&lt;br/&gt;
        at org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:35)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I am using the Datastax driver and using CQL to execute insert queries. The query that is failing is using atomic batching executing a large number of statements (~55).&lt;/p&gt;

&lt;p&gt;Looking into the code a bit, I saw that in the org.apache.cassandra.transport.Frame$Decoder class, the MAX_FRAME_LENGTH is hard coded to 256 mb.&lt;/p&gt;

&lt;p&gt;Is this something that should be configurable or is this a hard limit that will prevent batch statements of this size from executing for some reason?&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux, Java 7&lt;/p&gt;</environment>
        <key id="12667327">CASSANDRA-5981</key>
            <summary>Netty frame length exception when storing data to Cassandra using binary protocol</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="jsweeney">Justin Sweeney</reporter>
                        <labels>
                    </labels>
                <created>Fri, 6 Sep 2013 13:52:58 +0000</created>
                <updated>Wed, 8 Mar 2023 21:19:38 +0000</updated>
                            <resolved>Mon, 4 Nov 2013 15:13:45 +0000</resolved>
                                        <fixVersion>2.0.3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13760236" author="jbellis" created="Fri, 6 Sep 2013 14:46:25 +0000"  >&lt;p&gt;CQL is not meant to be a bulk load protocol.  Use sstableloader / AbstractSSTableSimpleWriter for that.&lt;/p&gt;

&lt;p&gt;That said, we should turn this into an InvalidRequestException instead of erroring out internally.&lt;/p&gt;</comment>
                            <comment id="13760243" author="slebresne" created="Fri, 6 Sep 2013 14:58:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;Is this something that should be configurable or is this a hard limit that will prevent batch statements of this size from executing for some reason?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sending a message of more than 256mb is a fairly bad idea tbh. Cassandra is just not optimized for that kind of huge request and so you will run into problems and get bad performance if you try to do even if we were lifting the hard coded limit. In fact, the only reason for this limit is to protect the server from OOM if the client sends something clearly wrong.&lt;/p&gt;

&lt;p&gt;That being said, I&apos;m not totally opposed to making the limit configurable. But more because I think most people may want to make it lower rather than higher.&lt;/p&gt;</comment>
                            <comment id="13760407" author="jsweeney" created="Fri, 6 Sep 2013 17:42:52 +0000"  >&lt;p&gt;Thank you for taking a look into this, I agree 256mb is certainly too large, just something I ran into with using atomic batches. I&apos;ll be ensuring we aren&apos;t sending data this big going forward, but I think making the limit configurable would be useful. It seems to me to be similar to the thrift max message limit, which can be configured in the cassandra.yaml. Regardless, I appreciate the quick response.&lt;/p&gt;</comment>
                            <comment id="13768339" author="slebresne" created="Mon, 16 Sep 2013 14:17:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;That said, we should turn this into an InvalidRequestException instead of erroring out internally&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree and that&apos;s why there is a &apos;catch (TooLongFrameException)&apos; in the Frame decoding code. But it appears that instead of throwing an exception the normal way (like it does for corrupted frames for instance), Netty instead fires the exceptionCaught callback directly so that catch was bypassed. Anyway, attaching patch that fixes that. The initial code was throwing a ProtocolException but I do agree an InvalidRequestException is probably more appropriate: after all a ProtocolException also close the connection which is not necessary here.  However, this required a few minor changes in Frame as we were not using Netty&apos;s LengthFieldBasedFrameDecoder.&lt;/p&gt;

&lt;p&gt;As for making the max frame length configurable, I&apos;m not necessarily against the idea. But as said above, more so than people can set it lower than the default if they want a more strict protection against badly behaving clients.  Attaching patch for that too.&lt;/p&gt;</comment>
                            <comment id="13770091" author="jbellis" created="Tue, 17 Sep 2013 22:32:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dln&quot; class=&quot;user-hover&quot; rel=&quot;dln&quot;&gt;dln&lt;/a&gt; can you review?&lt;/p&gt;</comment>
                            <comment id="13771999" author="jbellis" created="Thu, 19 Sep 2013 16:14:09 +0000"  >&lt;p&gt;Oops, wrong Daniel.  Meant &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danielnorberg&quot; class=&quot;user-hover&quot; rel=&quot;danielnorberg&quot;&gt;danielnorberg&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13778587" author="danielnorberg" created="Thu, 26 Sep 2013 09:05:00 +0000"  >&lt;p&gt;When handling the TooLongFrameException and sending an ErrorMessage reply with the InvalidRequestException without closing the connection, where is the stream id set on the ErrorMessage? I assume that without the stream id set and the connection still open, the client will be unable to infer that the request failed.&lt;/p&gt;</comment>
                            <comment id="13778641" author="slebresne" created="Thu, 26 Sep 2013 10:35:27 +0000"  >&lt;p&gt;Right, you&apos;re correct, the patch doesn&apos;t preserve the stream id correctly.&lt;/p&gt;

&lt;p&gt;However, I have to say that I&apos;m not too sure what&apos;s the easiest way to make that work correctly with Netty currently. To be able to use the stream id we&apos;ve need to be able to start decoding the frame header before LengthFieldBasedFrameDecoder triggers the TooLongFrameException, but I don&apos;t know how to do that without knowing if LFBFD is in it&apos;s &quot;discardingTooLongFrame&quot; mode, and that&apos;s not exposed currently. Meaning that the only solutions I see so far are:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;push some feature request to netty so that LengthFieldBasedFrameDecoder exposes it&apos;s currently private discardingTooLongFrame field. Don&apos;t know if they&apos;ll be up for it and how quickly that&apos;d get released.&lt;/li&gt;
	&lt;li&gt;recode LengthFieldBasedFramedDecoder ourselves instead of using the netty one. Not the end of the world, it&apos;s not like it&apos;s a lot of code, but still a bit annoying in principle.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danielnorberg&quot; class=&quot;user-hover&quot; rel=&quot;danielnorberg&quot;&gt;danielnorberg&lt;/a&gt; Seeing any other simple solution that I would have missed?&lt;/p&gt;</comment>
                            <comment id="13778704" author="danielnorberg" created="Thu, 26 Sep 2013 12:26:07 +0000"  >&lt;p&gt;Right, that&apos;s annoying.&lt;/p&gt;

&lt;p&gt;I&apos;d be tempted to actually close the connection immediately. It doesn&apos;t seem very attractive to read and discard that huge frame, potentially using up a lot of bandwidth doing only that. IMO better to prioritize well behaved clients and let the offending client reconnect.&lt;/p&gt;

&lt;p&gt;If you still want to keep the connection open and fail the request nicely I&apos;d probably go for implementing a custom frame decoder.&lt;/p&gt;
</comment>
                            <comment id="13778731" author="slebresne" created="Thu, 26 Sep 2013 12:51:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;d be tempted to actually close the connection immediately.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That was the initial intent, but now I feel closing the connection in that case is too harsh. If we do allows to configure the max frame length (reasonable if only because some may want to lower it from the relatively high default) then client libraries can&apos;t valid frame size on their side and this become a end-user error. And closing the connection on a end-user error feels wrong (especially because it potentially cuts other unrelated streams on that connection).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;I&apos;d probably go for implementing a custom frame decoder&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed, that&apos;s probably the simpler. I&apos;ll work that out.&lt;/p&gt;</comment>
                            <comment id="13783773" author="slebresne" created="Wed, 2 Oct 2013 09:34:38 +0000"  >&lt;p&gt;Alright, attaching a v2 (that includes making the &quot;max frame length configurable&quot; patch) that rewrite the Frame decoder to handle the frame slightly more manually to allow us to do what we want. This mostly mimick the code of Netty LengthFieldBasedFrameDecoder, though a bit simplified since adapted to just what we need. I&apos;ll note that this patch is against the 2.0 branch: I&apos;ve been able to run the java driver tests with that patch so we should be good but this still is not entirely trivial a change so I&apos;m starting to wonder if it&apos;s worth pushing it in 1.2, especially given that the current behavior (having the error logged server side) is not really a big deal.&lt;/p&gt;</comment>
                            <comment id="13783856" author="jbellis" created="Wed, 2 Oct 2013 11:52:39 +0000"  >&lt;p&gt;Agreed on the 2.0 call.&lt;/p&gt;</comment>
                            <comment id="13788851" author="jbellis" created="Tue, 8 Oct 2013 02:39:03 +0000"  >&lt;p&gt;How does v2 look &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=danielnorberg&quot; class=&quot;user-hover&quot; rel=&quot;danielnorberg&quot;&gt;danielnorberg&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13800755" author="jbellis" created="Mon, 21 Oct 2013 15:49:53 +0000"  >&lt;p&gt;Hmm, timeout on that request.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=norman&quot; class=&quot;user-hover&quot; rel=&quot;norman&quot;&gt;norman&lt;/a&gt;, could you review v2?&lt;/p&gt;</comment>
                            <comment id="13806141" author="danielnorberg" created="Sat, 26 Oct 2013 17:17:33 +0000"  >&lt;p&gt;Looks to me like it might discard too much data if buffer.readableBytes() &amp;gt; MAX_FRAME_LENGTH. Unless I&apos;m mistaken this problem is also present in the original LengthFieldBasedFrameDecoder though. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=norman&quot; class=&quot;user-hover&quot; rel=&quot;norman&quot;&gt;norman&lt;/a&gt;, what do you say? Admittedly it&apos;s a corner case that&apos;s unlikely to be encountered in production.&lt;/p&gt;

&lt;p&gt;Are there any tests for the dropping of too large requests?&lt;/p&gt;

&lt;p&gt;Apart from this it looks good to me.&lt;/p&gt;</comment>
                            <comment id="13806785" author="slebresne" created="Mon, 28 Oct 2013 14:12:05 +0000"  >&lt;p&gt;I believe you&apos;re right. I suppose there is no reason to ever get into that case if you don&apos;t pick and unreasonably low max frame size, but there&apos;s no hurt in being careful so attaching v3 that make sure we don&apos;t discard too much.&lt;/p&gt;

&lt;p&gt;And no, there isn&apos;t really a test in Cassandra for dropping large message because well, we don&apos;t really have any test for the native protocol so far. That being said, I do have a test for it in the java driver tests (though i&apos;ll need to commit it).&lt;/p&gt;</comment>
                            <comment id="13812466" author="danielnorberg" created="Sun, 3 Nov 2013 20:06:01 +0000"  >&lt;p&gt;Looks good, thumbs up.&lt;/p&gt;</comment>
                            <comment id="13812892" author="slebresne" created="Mon, 4 Nov 2013 15:13:45 +0000"  >&lt;p&gt;Alright, committed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12603333" name="0001-Correctly-catch-frame-too-long-exceptions.txt" size="7064" author="slebresne" created="Mon, 16 Sep 2013 14:17:38 +0000"/>
                            <attachment id="12603334" name="0002-Allow-to-configure-the-max-frame-length.txt" size="3870" author="slebresne" created="Mon, 16 Sep 2013 14:17:38 +0000"/>
                            <attachment id="12606272" name="5981-v2.txt" size="12321" author="slebresne" created="Wed, 2 Oct 2013 09:34:38 +0000"/>
                            <attachment id="12610561" name="5981-v3.txt" size="12336" author="slebresne" created="Mon, 28 Oct 2013 14:12:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>347264</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 3 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nvqf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>347563</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>danielnorberg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[danielnorberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324785">1.2.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>