<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:29:58 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3989] nodetool cleanup/scrub/upgradesstables promotes all sstables to next level (LeveledCompaction)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3989</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;1.0.7 + LeveledCompactionStrategy&lt;br/&gt;
If you run nodetool cleanup, scrub, or upgradesstables, Cassandra execute compaction for each sstable. During the compaction, it put the new sstable to next level of the original sstable. If you run cleanup many times, sstables will reached to the highest level, and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3608&quot; title=&quot;nodetool cleanup fails on LeveledCompactionStrategy tables with ArrayIndexOutOfBoundsException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3608&quot;&gt;&lt;del&gt;CASSANDRA-3608&lt;/del&gt;&lt;/a&gt; will happens at next cleanup.&lt;/p&gt;

&lt;p&gt;Reproduce procedure:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;create column family CF1 with compaction_strategy=LeveledCompactionStrategy and compaction_strategy_options=
{sstable_size_in_mb: 5}
&lt;p&gt;;&lt;/p&gt;&lt;/li&gt;
	&lt;li&gt;Insert some data into CF1.&lt;/li&gt;
	&lt;li&gt;nodetool flush&lt;/li&gt;
	&lt;li&gt;Verify the sstable is created at L1 in CF1.json&lt;/li&gt;
	&lt;li&gt;nodetool cleanup&lt;/li&gt;
	&lt;li&gt;Verify sstable in L1 is removed and new sstable is created at L2 in CF1.json&lt;/li&gt;
	&lt;li&gt;repeat nodetool cleanup some times&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment>&lt;p&gt;RHEL6&lt;/p&gt;</environment>
        <key id="12544881">CASSANDRA-3989</key>
            <summary>nodetool cleanup/scrub/upgradesstables promotes all sstables to next level (LeveledCompaction)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="makiw">Maki Watanabe</reporter>
                        <labels>
                            <label>lcs</label>
                    </labels>
                <created>Fri, 2 Mar 2012 03:21:57 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:38 +0000</updated>
                            <resolved>Wed, 7 Mar 2012 17:39:52 +0000</resolved>
                                        <fixVersion>1.0.9</fixVersion>
                    <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13220647" author="makiw" created="Fri, 2 Mar 2012 03:30:55 +0000"  >&lt;p&gt;Fix LeveledManifest.promote will not promote sstables to next level if the number of source sstables (removed) is one.&lt;/p&gt;</comment>
                            <comment id="13221136" author="jbellis" created="Fri, 2 Mar 2012 18:36:26 +0000"  >&lt;p&gt;Nice bug hunting.  Committed a lightly edited version of your fix: &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commitdiff;h=53fb52ac713e5471edd988b59cbd75f202a4f57b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commitdiff;h=53fb52ac713e5471edd988b59cbd75f202a4f57b&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="13222995" author="makiw" created="Tue, 6 Mar 2012 05:05:57 +0000"  >&lt;p&gt;Johathan, &lt;br/&gt;
This fix has a problem. If you have only one Level 0 sstable, and there are no Level 1 sstables involved in the compaction, promote method will chooses 0 as newLevel, and it causes assertion.&lt;br/&gt;
Should I create a new ticket?&lt;/p&gt;</comment>
                            <comment id="13223009" author="jbellis" created="Tue, 6 Mar 2012 05:53:42 +0000"  >&lt;p&gt;No, let&apos;s reopen this one&lt;/p&gt;</comment>
                            <comment id="13223924" author="makiw" created="Wed, 7 Mar 2012 02:47:52 +0000"  >&lt;p&gt;Another problem with the fix.&lt;br/&gt;
In following condition, the background compaction task start looping.&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;No L0 sstable&lt;/li&gt;
	&lt;li&gt;Enough number of L1 sstables, exceed L1 capacity (compaction score &amp;gt; 1.1)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It seems the background task try to promote sstables to reduce compaction score, but it can&apos;t by this fix, then it will compact each L1 sstables forever.&lt;/p&gt;</comment>
                            <comment id="13224001" author="makiw" created="Wed, 7 Mar 2012 05:55:24 +0000"  >&lt;p&gt;It is more complicated than I first thought.&lt;br/&gt;
getCandidatesFor(int level) returns next compaction candidates for the level by:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;sort the generations and find a sstable where we left off last time&lt;/li&gt;
	&lt;li&gt;and then find overlappng sstables from next level&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;So if we add a new sstable into same level, getCompactionCandidates won&apos;t return empty, and then getNextBackgoundTask returns non-null task forever.&lt;br/&gt;
I think we should better to back out the fix and look for better strategy to resolve the issue.&lt;/p&gt;</comment>
                            <comment id="13224324" author="slebresne" created="Wed, 7 Mar 2012 13:28:03 +0000"  >&lt;p&gt;I agree, the committed fix does more harm than it helps so I reverted it.&lt;br/&gt;
I&apos;m trying some other approach so will hopefully attach another version soon.&lt;/p&gt;</comment>
                            <comment id="13224331" author="slebresne" created="Wed, 7 Mar 2012 13:38:44 +0000"  >&lt;p&gt;Attaching another approach that makes the compaction type available to the leveled compaction that for cleanup, scrub and upgradeSSTables simply replace the old sstable by the new one (without changing level or anything else). The rational is those operation don&apos;t really &quot;change&quot; the sstable content and should simply &quot;replace&quot; sstables.&lt;/p&gt;</comment>
                            <comment id="13224509" author="jbellis" created="Wed, 7 Mar 2012 17:16:02 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13224536" author="slebresne" created="Wed, 7 Mar 2012 17:39:52 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="13224979" author="scode" created="Thu, 8 Mar 2012 04:25:52 +0000"  >&lt;p&gt;Hmm, Does this address the case from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3952&quot; title=&quot;avoid quadratic startup time in LeveledManifest&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3952&quot;&gt;&lt;del&gt;CASSANDRA-3952&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;I think this might happen whenever there is exactly one sstable in L0 that is large enough for the score for L0 to be &amp;gt; 1, and if L1 is full (so that skipLevels doesn&apos;t promote).&lt;/p&gt;

&lt;p&gt;It&apos;s possible the sstables I had lying around from sized-tiered compaction combined with my write load conspired to trigger this case.&lt;/p&gt;&lt;/blockquote&gt;</comment>
                            <comment id="13224984" author="scode" created="Thu, 8 Mar 2012 04:37:27 +0000"  >&lt;p&gt;Sorry, I think I just pulled before merge-to-trunk and was still looking at a trunk containing the original version of the patch.&lt;/p&gt;</comment>
                            <comment id="13229870" author="makiw" created="Thu, 15 Mar 2012 04:05:15 +0000"  >&lt;p&gt;Removed first patch file I attached here because it is harmful.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12517399" name="3989.txt" size="19478" author="slebresne" created="Wed, 7 Mar 2012 13:38:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>230067</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 36 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gqnz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95750</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>