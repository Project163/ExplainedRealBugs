<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14649] Index summaries fail when their size gets &gt; 2G and use more space than necessary</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14649</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After building a summary, &lt;tt&gt;IndexSummaryBuilder&lt;/tt&gt; tries to trim the memory writers by calling &lt;tt&gt;SafeMemoryWriter.setCapacity(capacity())&lt;/tt&gt;. Instead of trimming, this ends up allocating at least as much extra space and failing&#160;the &lt;tt&gt;Buffer.position()&lt;/tt&gt; call when the size is greater than &lt;tt&gt;Integer.MAX_VALUE&lt;/tt&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13179350">CASSANDRA-14649</key>
            <summary>Index summaries fail when their size gets &gt; 2G and use more space than necessary</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blambov">Branimir Lambov</assignee>
                                    <reporter username="blambov">Branimir Lambov</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Aug 2018 13:13:55 +0000</created>
                <updated>Tue, 7 Mar 2023 11:52:23 +0000</updated>
                            <resolved>Tue, 21 Aug 2018 08:58:53 +0000</resolved>
                                        <fixVersion>2.2.14</fixVersion>
                    <fixVersion>3.0.18</fixVersion>
                    <fixVersion>3.11.4</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16582504" author="blambov" created="Thu, 16 Aug 2018 13:24:24 +0000"  >&lt;p&gt;Patch uploaded here:&#160;&lt;a href=&quot;https://github.com/blambov/cassandra/tree/14649&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/blambov/cassandra/tree/14649&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16582586" author="benedict" created="Thu, 16 Aug 2018 14:09:47 +0000"  >&lt;p&gt;I think this patch is also broken.&lt;/p&gt;

&lt;p&gt;Previously, the logical trim invoked &lt;tt&gt;setCapacity(length())&lt;/tt&gt;, which I can see is buggy for a size &amp;gt; 2GiB (but is otherwise consistent).  Now, it seems to be invoking &lt;tt&gt;setCapacity(capacity())&lt;/tt&gt;, which is surely a no-op?&lt;/p&gt;

&lt;p&gt;It seems that there&apos;s a bunch of bugs here, and that really we should be:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;fix &lt;tt&gt;length&lt;/tt&gt; to work for sizes &amp;gt; 2GiB&lt;/li&gt;
	&lt;li&gt;implement &lt;tt&gt;trim&lt;/tt&gt; as &lt;tt&gt;resizeTo(length())&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;rename &lt;tt&gt;reallocate&lt;/tt&gt; to something like &lt;tt&gt;ensureCapacity&lt;/tt&gt;, to avoid this kind of misuse mistake in future&lt;/li&gt;
&lt;/ol&gt;

</comment>
                            <comment id="16582619" author="blambov" created="Thu, 16 Aug 2018 14:45:24 +0000"  >&lt;p&gt;Right, I messed it up too... I can&apos;t see any problems with &lt;tt&gt;length&lt;/tt&gt;, though.&lt;/p&gt;

&lt;p&gt;Updated patch to address the other comments and also added size checking to the test.&lt;/p&gt;</comment>
                            <comment id="16582769" author="benedict" created="Thu, 16 Aug 2018 16:19:20 +0000"  >&lt;p&gt;You&apos;re right, I was just assuming &lt;tt&gt;length()&lt;/tt&gt; was inherited from &lt;tt&gt;DataOutputBuffer&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I realise &lt;tt&gt;ensureCapacity&lt;/tt&gt; was a terrible suggestion, but &lt;tt&gt;ensureHeadroom&lt;/tt&gt; might be clearer than &lt;tt&gt;expandToFit&lt;/tt&gt; since it might be that you&apos;re trying to fit N total, not N extra.&lt;/p&gt;

&lt;p&gt;But no strong feeling, and +1 either way.&lt;/p&gt;</comment>
                            <comment id="16582965" author="jjirsa" created="Thu, 16 Aug 2018 19:18:55 +0000"  >&lt;p&gt;Safe to relate to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12014&quot; title=&quot;IndexSummary &amp;gt; 2G causes an assertion error&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12014&quot;&gt;&lt;del&gt;CASSANDRA-12014&lt;/del&gt;&lt;/a&gt; (haven&apos;t read the patch, just sounds familiar)? &lt;/p&gt;</comment>
                            <comment id="16586017" author="blambov" created="Mon, 20 Aug 2018 14:36:24 +0000"  >&lt;p&gt;CircleCI doesn&apos;t seem to like the new test but AFAICT is otherwise fine: &lt;a href=&quot;https://circleci.com/gh/blambov/workflows/cassandra/tree/14649-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/blambov/workflows/cassandra/tree/14649-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/blambov/workflows/cassandra/tree/14649-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&#160;&lt;a href=&quot;https://circleci.com/gh/blambov/workflows/cassandra/tree/14649-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Should I remove the &amp;gt;2G test, or is there something I need to set up to be able to run tests needing more memory?&lt;/p&gt;</comment>
                            <comment id="16586097" author="benedict" created="Mon, 20 Aug 2018 15:36:51 +0000"  >&lt;p&gt;I think you need to set yourself up on a CircleCI account that supports larger instances, then modify the .circleci/config.yml&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/belliottsmith/cassandra/commit/b1cbd819274e3095f348402bca257ad4e6765f22&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;For example&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16587147" author="blambov" created="Tue, 21 Aug 2018 08:27:28 +0000"  >&lt;p&gt;I realized we still have a problem if the size grows by over 2G, i.e. if it becomes &amp;gt;4G and needs to grow. Pushed another commit to fix and test this and limit the test size if there isn&apos;t enough memory: &lt;a href=&quot;https://github.com/blambov/cassandra/commit/65798672eff79bd1c97b960ed965f0e908f6c23e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;new commit&lt;/a&gt; &lt;a href=&quot;https://github.com/blambov/cassandra/tree/14649-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/blambov/workflows/cassandra/tree/14649-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16587178" author="benedict" created="Tue, 21 Aug 2018 08:50:32 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;I do wonder if we should revisit requiring linear memory for all of this, but&#160;really we should probably instead revisit if such huge sstables are a good idea.&lt;/p&gt;</comment>
                            <comment id="16587183" author="blambov" created="Tue, 21 Aug 2018 08:58:39 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/49adbe7e0f0c8a83f3b843b65612528498b5c9a5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;49adbe7e0f0c8a83f3b843b65612528498b5c9a5&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13228110">CASSANDRA-15084</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 13 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3x467:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332541">3.0.x</customfieldvalue>
    <customfieldvalue id="12339541">3.11.x</customfieldvalue>
    <customfieldvalue id="12351720">5.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332983">2.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>