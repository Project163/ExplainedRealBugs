<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:54:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9558] Cassandra-stress regression in 2.2</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9558</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We are seeing some regression in performance when using cassandra-stress 2.2. You can see the difference at this url:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://riptano.github.io/cassandra_performance/graph_v5/graph.html?stats=stress_regression.json&amp;amp;metric=op_rate&amp;amp;operation=1_write&amp;amp;smoothing=1&amp;amp;show_aggregates=true&amp;amp;xmin=0&amp;amp;xmax=108.57&amp;amp;ymin=0&amp;amp;ymax=168147.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://riptano.github.io/cassandra_performance/graph_v5/graph.html?stats=stress_regression.json&amp;amp;metric=op_rate&amp;amp;operation=1_write&amp;amp;smoothing=1&amp;amp;show_aggregates=true&amp;amp;xmin=0&amp;amp;xmax=108.57&amp;amp;ymin=0&amp;amp;ymax=168147.1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The cassandra version of the cluster doesn&apos;t seem to have any impact. &lt;/p&gt;

&lt;p&gt;//cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12835794">CASSANDRA-9558</key>
            <summary>Cassandra-stress regression in 2.2</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="andrew.tolbert">Andy Tolbert</assignee>
                                    <reporter username="aboudreault">Alan Boudreault</reporter>
                        <labels>
                            <label>stress</label>
                    </labels>
                <created>Fri, 5 Jun 2015 18:07:58 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:08 +0000</updated>
                            <resolved>Thu, 25 Jun 2015 18:39:47 +0000</resolved>
                                        <fixVersion>2.2.0 rc2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14574945" author="aboudreault" created="Fri, 5 Jun 2015 18:08:43 +0000"  >&lt;p&gt;I am currently bisecting this issue. We reproduced it on a c3.8xlarge cluster and it is currently hard to reproduce locally.&lt;/p&gt;</comment>
                            <comment id="14575091" author="aboudreault" created="Fri, 5 Jun 2015 19:47:49 +0000"  >&lt;p&gt;Comparison of cassandra-stress 2.1 and 2.2.&lt;/p&gt;

&lt;p&gt;2.1 is using thrift and 2.2 is using CQL, which could lead to an issue in the java-driver.&lt;/p&gt;</comment>
                            <comment id="14575092" author="enigmacurry" created="Fri, 5 Jun 2015 19:49:47 +0000"  >&lt;p&gt;AFAIK the only use of thrift in the 2.1 run was for the schema creation, which was recently modified in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9374&quot; title=&quot;Remove thrift dependency in stress schema creation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9374&quot;&gt;&lt;del&gt;CASSANDRA-9374&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14575158" author="tjake" created="Fri, 5 Jun 2015 20:11:36 +0000"  >&lt;p&gt;My guess is it&apos;s &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9493&quot; title=&quot;Integrate snapshot 2.2rc Java Driver&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9493&quot;&gt;&lt;del&gt;CASSANDRA-9493&lt;/del&gt;&lt;/a&gt; &lt;/p&gt;

&lt;p&gt;This is the java driver used by stress.  the last time I tried it the performance was much lower in stress because the driver uses a single connection to send many messages, vs multiple connections.&lt;/p&gt;</comment>
                            <comment id="14575162" author="aboudreault" created="Fri, 5 Jun 2015 20:12:56 +0000"  >&lt;p&gt;yeah, I am currently working with Andy to confirm the java-driver is the cause. &lt;/p&gt;</comment>
                            <comment id="14575241" author="andrew.tolbert" created="Fri, 5 Jun 2015 21:20:51 +0000"  >&lt;p&gt;Just confirming that this is very likely the java driver.  I went back to cassandra-2.1 branch and built it with driver 2.2.0-rc1-SNAPSHOT and noticed the same performance degradation.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; is on point in that this is likely caused by the driver only using a single connection.  To get around this we could force protocol version 2 in the driver in the stress tool, it&apos;s not ideal but worth a try.  I&apos;ll attach some performance numbers shortly.&lt;/p&gt;</comment>
                            <comment id="14575273" author="andrew.tolbert" created="Fri, 5 Jun 2015 21:39:38 +0000"  >&lt;p&gt;Attached &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12738062/12738062_CASSANDRA-9558-ProtocolV2.patch&quot; title=&quot;CASSANDRA-9558-ProtocolV2.patch attached to CASSANDRA-9558&quot;&gt;CASSANDRA-9558-ProtocolV2.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; which forces protocol version 2 in the stress tests.  Alternatively we could use a separate driver jar for stress.&lt;/p&gt;

&lt;p&gt;Obviously this is not ideal, but it will force the java-driver to use a dynamic pool size implementation with 2 core and 8 max connections.  After applying write ops went from 90274/s to 141773/s which seems more in line with the results expected based on the results in the description.   I&apos;ll log a java-driver issue to allow dynamic pool sizing with protocol version 3+ as these results demonstrate that using only 1 connection per host has a noticeable impact.&lt;/p&gt;</comment>
                            <comment id="14575277" author="aboudreault" created="Fri, 5 Jun 2015 21:40:41 +0000"  >&lt;p&gt;I confirm what Andy said. I also tested on my dev cluster. I attached logs of stress 2.1 with java-driver 2.0.9.2 AND 2.2-SNAPSHOT.&lt;/p&gt;</comment>
                            <comment id="14575288" author="aboudreault" created="Fri, 5 Jun 2015 21:47:41 +0000"  >&lt;p&gt;Attaching the result using Andy&apos;s patch. &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12738068/12738068_stress-2.1-java-driver-2.2%2BPATCH.log&quot; title=&quot;stress-2.1-java-driver-2.2+PATCH.log attached to CASSANDRA-9558&quot;&gt;stress-2.1-java-driver-2.2+PATCH.log&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="14575304" author="aboudreault" created="Fri, 5 Jun 2015 22:00:55 +0000"  >&lt;p&gt;Here&apos;s the log of stress 2.2 with java driver 2.2 stock and with the patch to force protocole v2. There is an improvement but not comparable to the performance we had with 2.1&lt;/p&gt;</comment>
                            <comment id="14575318" author="andrew.tolbert" created="Fri, 5 Jun 2015 22:02:59 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aboudreault&quot; class=&quot;user-hover&quot; rel=&quot;aboudreault&quot;&gt;aboudreault&lt;/a&gt;!  &lt;/p&gt;

&lt;p&gt;For reference, &lt;a href=&quot;https://datastax-oss.atlassian.net/browse/JAVA-738&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JAVA-738&lt;/a&gt; was previously opened to evaluate the pool implementation for protocol version 3+.  I&apos;ve also opened up &lt;a href=&quot;https://datastax-oss.atlassian.net/browse/JAVA-802&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JAVA-802&lt;/a&gt; to ensure we incorporate testing java-driver RCs with cassandra-stress to ensure there is no performance regression as part of the test/release process.   I&apos;ll continue doing a performance evaluation of the driver with cassandra-stress to see if anything obvious sticks out on the driver side.&lt;/p&gt;</comment>
                            <comment id="14575467" author="andrew.tolbert" created="Sat, 6 Jun 2015 00:41:11 +0000"  >&lt;p&gt;It could be that all it would take to get the stress tool back to where it is in cassandra-2.1 is to simply place cassandra-driver-core-2.0.9.2.jar into tools/lib/ much like it is on the &lt;a href=&quot;https://github.com/apache/cassandra/tree/cassandra-2.1/tools/lib&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;cassandra-2.1&lt;/a&gt; branch.  I&apos;ve tried this in my environment and see a ~15-20% improvement over &apos;cassandra-2.2 w/ the patch to force protocol v2&apos;.  &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aboudreault&quot; class=&quot;user-hover&quot; rel=&quot;aboudreault&quot;&gt;aboudreault&lt;/a&gt;, when you have a chance could you try this and let me know how it goes?  All it should take it placing cassandra-driver-core-2.0.9.2 in tools/lib/.&lt;/p&gt;

&lt;p&gt;I&apos;ve done some investigation and it looks like the regression is present between java-driver 2.1.5 and 2.1.6 (also observed in 2.0.9.2 and 2.0.10 so it probably stems from there), I&apos;ll continue investigating.  I observe very similar performance with java-driver 2.1.5 /w proto v2 and 2.0.9.2.&lt;/p&gt;</comment>
                            <comment id="14575616" author="andrew.tolbert" created="Sat, 6 Jun 2015 06:39:03 +0000"  >&lt;p&gt;Think I&apos;ve gotten to the bottom of this.  Attached is &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12738147/12738147_CASSANDRA-9558-2.patch&quot; title=&quot;CASSANDRA-9558-2.patch attached to CASSANDRA-9558&quot;&gt;CASSANDRA-9558-2.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; (should apply cleanly on both cassandra-2.2 and trunk) which does the following:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Forces Protocol Version to V2 in driver client used by cassandra-stress.  This is necessary to enable the driver to use more 1 connection per host (explanation above).&lt;/li&gt;
	&lt;li&gt;Explicitly set core connections to 8 from 2.   The previous java-driver used for cassandra-stress, 2.0.9.2, was set up to use 8 core connections to get around a pool growth/shrinking issue introduced in an earlier version which has since been fixed.  It turns out more connections = better performance in a high stress scenario.  When using default settings, the size of the pool grows to about 3-4 to meet the number of simultaneous requests I&apos;d expect to see in this configuration w/ 300 threads.&lt;/li&gt;
	&lt;li&gt;Remove netty-3.9.0.Final.jar from tools/lib as both C* and stress tool are using a shaded version of the driver which provides netty itself, so this is no longer needed.   Also removed references to tools/lib from build.xml as this directory is now empty.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;With these changes I am now seeing comparable if not slightly better performance than the stress tool on cassandra-2.1 using driver 2.0.9.2.  Here&apos;s a sampling of the results I&apos;ve captures (attached as &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12738143/12738143_atolber-CASSANDRA-9558-stress.tgz&quot; title=&quot;atolber-CASSANDRA-9558-stress.tgz attached to CASSANDRA-9558&quot;&gt;atolber-CASSANDRA-9558-stress.tgz&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;).&lt;/p&gt;

&lt;p&gt;I also ran with 4, 16 and 32 core connections.    There was a slight improvement at 16, but a degradation at 32.   It might interesting to make this option configurable in the future, but I think 8 is a happy medium for now and decided to stick to it to operate similarly to stress on the 2.1 branch.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Description&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;write ops rate&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.0.9.2 driver&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;cassandra-2.1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;136579&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.0.9.2 driver&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;138659&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2.0-rc1&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;74100&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2.0-rc1 proto v2, 4 core connections&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;127211&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2.0-rc1 proto v2, 8 core connections&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;142450&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2.0-rc1 proto v2, 8 core connections, driver coalescing disabled&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;82643&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2.0-rc1 proto v2, 16 core connections&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;144077&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;2.2.0-rc1 proto v2, 32 core connections&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;129678&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="14575620" author="andrew.tolbert" created="Sat, 6 Jun 2015 07:05:30 +0000"  >&lt;p&gt;Reattached patch &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12738147/12738147_CASSANDRA-9558-2.patch&quot; title=&quot;CASSANDRA-9558-2.patch attached to CASSANDRA-9558&quot;&gt;CASSANDRA-9558-2.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; with two slight fixes (revert accidental removal of whitespace, include full index in deleted file as wouldn&apos;t apply otherwise).&lt;/p&gt;</comment>
                            <comment id="14575633" author="andrew.tolbert" created="Sat, 6 Jun 2015 08:08:19 +0000"  >&lt;p&gt;After doing some testing realized that I had made a mistake in the build.xml where the stress.jar was no longer being included from build/tools/lib.  Recorrected &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12738147/12738147_CASSANDRA-9558-2.patch&quot; title=&quot;CASSANDRA-9558-2.patch attached to CASSANDRA-9558&quot;&gt;CASSANDRA-9558-2.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;.&lt;/p&gt;</comment>
                            <comment id="14575697" author="benedict" created="Sat, 6 Jun 2015 11:49:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/datastax/java-driver/blob/2.1/driver-core/src/main/java/com/datastax/driver/core/Connection.java#L887&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; may be the problem&lt;/p&gt;

&lt;p&gt;This logic makes sense on the server-side, since there is likely more useful work for the server to do in the meantime, but on the client we&apos;re just delaying the server from getting started on processing our requests. We should be batching, but not delaying. i.e. flushing as soon as we have written all pending messages.&lt;/p&gt;</comment>
                            <comment id="14575808" author="andrew.tolbert" created="Sat, 6 Jun 2015 16:27:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;This logic makes sense on the server-side, since there is likely more useful work for the server to do in the meantime, but on the client we&apos;re just delaying the server from getting started on processing our requests. We should be batching, but not delaying. i.e. flushing as soon as we have written all pending messages.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;One motivation for coalescing/batching on the driver side is that in Netty 4.0 &lt;a href=&quot;http://netty.io/wiki/new-and-noteworthy-in-4.0.html#wiki-h4-20&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;channel.write no longer implicitly flushes&lt;/a&gt; and it now must be explicit.  We found during testing that if you explicitly flush outside of the netty event loop there is sizable performance cost.  I added a row to my table in the previous comment showing the op rate degrading with coalescing disabled via -Dcom.datastax.driver.DISABLE_COALESCING=true (also see attached &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12738178/12738178_atolber-trunk-driver-coalescing-disabled.txt&quot; title=&quot;atolber-trunk-driver-coalescing-disabled.txt attached to CASSANDRA-9558&quot;&gt;atolber-trunk-driver-coalescing-disabled.txt&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;).  &lt;/p&gt;

&lt;p&gt;That being said, if there is a more optimal way of doing this I think we should look into it.  I think it would be interesting to see how things perform if the driver simply submits a flush on the event loop and see what netty does for us (I&apos;ll try this out) compared to coalescing or flushing outside the event loop.  If there is no perceived benefit of coalescing vs. submitting a flush in the event loop we could consider changing the default behavior or removing the functionality.  (EDIT: Evidently this is exactly what writeAndFlush does which is what the driver is using when coalescing is disabled, but i&apos;ll keep exploring alternatives)&lt;/p&gt;

&lt;p&gt;I think with my findings in my &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9558?focusedCommentId=14575616&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14575616&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;previous comment&lt;/a&gt;, this issue should be resolved by downgrading the protocol version to v2 (until the driver is updated to support connection sizing with v3+) and setting core connections per host to 8. &lt;/p&gt;</comment>
                            <comment id="14575851" author="snazy" created="Sat, 6 Jun 2015 17:54:23 +0000"  >&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=norman&quot; class=&quot;user-hover&quot; rel=&quot;norman&quot;&gt;norman&lt;/a&gt; (added Norman in the loop - maybe he has some insights to what&apos;s possible with Netty &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; )&lt;/p&gt;</comment>
                            <comment id="14577316" author="aboudreault" created="Mon, 8 Jun 2015 15:10:05 +0000"  >&lt;p&gt;I confirm that with the last patch provided by Andy &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12738147/12738147_CASSANDRA-9558-2.patch&quot; title=&quot;CASSANDRA-9558-2.patch attached to CASSANDRA-9558&quot;&gt;CASSANDRA-9558-2.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;, we are back at the same performance we had with cassandra-2.1 using java-driver 2.0. Thanks Andy!&lt;/p&gt;</comment>
                            <comment id="14577606" author="benedict" created="Mon, 8 Jun 2015 18:28:04 +0000"  >&lt;blockquote&gt;&lt;p&gt;Evidently this is exactly what writeAndFlush does which is what the driver is using when coalescing is disabled, but i&apos;ll keep exploring alternatives&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But it&apos;s not a choice between the two. There should absolutely be coalescing, and it should never be disabled. The question is if we should artificially delay our messages in order to coalesce more of them. On a client I cannot see it making sense to do so: on the server, we expect the server to have other useful work to do, to produce more responses that can be coalesced together. On a client, however, we should not make that assumption: if the client is synchronously waiting for a result, we&apos;re pointlessly delaying them (and cannot know if this is the case), whereas if they are asynchronously producing work, this will accumulate or not, completely independent of our delay, and after the first potentially more costly message the costs will reach a steady state, that the delay is unlikely to have any positive effect on.&lt;/p&gt;

&lt;p&gt;The main idea of it on the server is that it permits the server to exhaust its current burst of messages (if possible), so that all messages that would naturally be grouped given the chance can be.&lt;/p&gt;

&lt;p&gt;That all said, some basic back-of-envelope maths suggest this cannot sufficiently account for the problem in this case. That doesn&apos;t mean we shouldn&apos;t change it though, but it is unlikely to explain this ticket.&lt;/p&gt;

&lt;p&gt;We should really try to profile the client and server, to establish which is the bottleneck, and where. It should not be the case that we need multiple threads to deal with this workload: we&apos;re effectively batching up to 300 of these messages together, with a single point-to-point high-bandwidth TCP connection. The fact that this cannot cope with more than 7MB/s is crazy. There is maximal amortization of costs. It is possible we&apos;re hitting another weird issue with interrupt queues in AWS.&lt;/p&gt;</comment>
                            <comment id="14581076" author="iamaleksey" created="Wed, 10 Jun 2015 21:00:51 +0000"  >&lt;p&gt;Strictly speaking, is it actually a blocker for rc2, or should it go into 2.2.x?&lt;/p&gt;</comment>
                            <comment id="14581085" author="aboudreault" created="Wed, 10 Jun 2015 21:06:53 +0000"  >&lt;p&gt;maybe not a blocker for rc2... but I think this one is important for 2.2.0. What others think?&lt;/p&gt;</comment>
                            <comment id="14581086" author="iamaleksey" created="Wed, 10 Jun 2015 21:08:01 +0000"  >&lt;p&gt;Think of rc2 as 2.2.0. RCs are not betas.&lt;/p&gt;</comment>
                            <comment id="14581193" author="benedict" created="Wed, 10 Jun 2015 22:54:55 +0000"  >&lt;p&gt;Is this issue only appearing on EC2? Or is it more widespread?&lt;/p&gt;

&lt;p&gt;If we&apos;re seeing a tanking of performance across the board, it probably is pretty urgent. If it&apos;s isolated to e.g. non-private EC2 networks , we can take our time over it.&lt;/p&gt;</comment>
                            <comment id="14581323" author="aboudreault" created="Thu, 11 Jun 2015 01:36:48 +0000"  >&lt;p&gt;I&apos;ll get back to you tomorrow about that. I will test on gce and locally.&lt;/p&gt;</comment>
                            <comment id="14582096" author="aboudreault" created="Thu, 11 Jun 2015 15:36:32 +0000"  >&lt;p&gt;On GCE, I&apos;m seeing 80k op/s (cassandra-stress 2.1) versus 55k op/s (cassandra-stress 2.2).&lt;/p&gt;

&lt;p&gt;Locally I&apos;m only seeing a difference of ~6k op/s (48k op/s for 2.1 versus 42k op/s for 2.2), but I am mostly CPU-limited on my laptop and cannot fully benefit of the 300 threads.&lt;/p&gt;</comment>
                            <comment id="14585397" author="jbellis" created="Mon, 15 Jun 2015 03:21:42 +0000"  >&lt;p&gt;I&apos;m setting priority to Major because if push comes to shove we can release 2.2 and tell people &quot;use the 2.1 stress if you really need it.&quot;&lt;/p&gt;</comment>
                            <comment id="14593780" author="norman" created="Fri, 19 Jun 2015 18:54:29 +0000"  >&lt;p&gt;Sorry for been late to the party, but it somehow got lost in my inbox &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;So from a netty standpoint your are right flushing from outside the EventLoop is &quot;pretty expensive&quot; as it will need to wakeup the selector if it is not already woken up and processing stuff. &lt;/p&gt;

&lt;p&gt;So the best thing you can do is either always write / flush etc from within the EventLoop or try to minimize the flushes from outside the EventLoop. That said if you point me to the place in your code where you do the flush and the other stuff I&apos;m happy to have a look and see if I can give you some idea how to improve. &lt;/p&gt;

&lt;p&gt;Just let me know!&lt;/p&gt;</comment>
                            <comment id="14598389" author="omichallat" created="Tue, 23 Jun 2015 21:22:06 +0000"  >&lt;p&gt;This is without Andy&apos;s patch, right?&lt;/p&gt;</comment>
                            <comment id="14598421" author="omichallat" created="Tue, 23 Jun 2015 21:38:46 +0000"  >&lt;p&gt;I ran tests on physical hardware that confirm that the number of connections is a major factor. As was explained before, 2.1.x versions of the driver are currently forcing a single connection per host when protocol v3 is in use. &lt;a href=&quot;https://datastax-oss.atlassian.net/browse/JAVA-738&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;JAVA-738&lt;/a&gt; (scheduled for 2.1.7 and 2.2.0-rc2) will make the pool size dynamic again.&lt;br/&gt;
Running cassandra-stress with driver 2.1.6 and protocol v3 (1 connection), I get a performance hit of about 25%. &lt;br/&gt;
Switching to a 2.1.7 snapshot with protocol v3 and 8 connections per host, I&apos;m back to the same as 2.0.x driver / protocol v2.&lt;/p&gt;</comment>
                            <comment id="14598451" author="omichallat" created="Tue, 23 Jun 2015 21:53:21 +0000"  >&lt;p&gt;Coalescing is handled by &lt;a href=&quot;https://github.com/datastax/java-driver/blob/2.0/driver-core/src/main/java/com/datastax/driver/core/Connection.java#L825&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Connection.Flusher&lt;/a&gt; in the driver, it&apos;s scheduled on the event loop.&lt;/p&gt;

&lt;p&gt;Based on Benedict&apos;s feedback, I&apos;m experimenting with &lt;a href=&quot;https://github.com/datastax/java-driver/commit/9ab18c454f67175904af98377454ba60e7fa9958&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;these changes&lt;/a&gt; to avoid artificially delaying message, but I&apos;m not observing a significant difference yet, at least in the context of cassandra-stress tests.&lt;/p&gt;</comment>
                            <comment id="14598550" author="benedict" created="Tue, 23 Jun 2015 23:09:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;That all said, some basic back-of-envelope maths suggest this cannot sufficiently account for the problem in this case&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It was a lengthy message but I already realised this could not explain it. Should have highlighted it more, sorry.&lt;/p&gt;

&lt;p&gt;I wonder if we could try playing with the &lt;tt&gt;ethtool -c&lt;/tt&gt; settings on the C&amp;#42; server, to see if reducing the number of interrupts can help (by e.g. raising the rx-usecs setting). &lt;/p&gt;

&lt;p&gt;What size cluster are these tests being run against, for reference? If it&apos;s a single node, I&apos;m not actually very worried or perturbed by a reduction, although we should probably try to mitigate the issue for benchmark purposes.&lt;/p&gt;</comment>
                            <comment id="14600116" author="tjake" created="Wed, 24 Jun 2015 20:47:40 +0000"  >&lt;p&gt;So can we go with a patch that changes the defaults for stress to use v2 and 8 connections in the pool?&lt;/p&gt;</comment>
                            <comment id="14600135" author="benedict" created="Wed, 24 Jun 2015 20:56:56 +0000"  >&lt;p&gt;The reason I ask about the size of the cluster this is being tested on, is this worsens performance as the cluster grows, as we coalesce fewer messages. So this could be improving our benchmark performance at the expense of real-world performance.&lt;/p&gt;</comment>
                            <comment id="14601698" author="tjake" created="Thu, 25 Jun 2015 18:39:47 +0000"  >&lt;p&gt;Going with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=andrew.tolbert&quot; class=&quot;user-hover&quot; rel=&quot;andrew.tolbert&quot;&gt;andrew.tolbert&lt;/a&gt;&apos;s patch for now. We can upgrade to v3 protocol once the default pooling is addressed.&lt;/p&gt;</comment>
                            <comment id="14602554" author="benedict" created="Fri, 26 Jun 2015 08:21:39 +0000"  >&lt;p&gt;Can we answer my question before forging ahead and changing any default pooling settings? Like I say, it&apos;s not at all necessarily a &lt;b&gt;bug&lt;/b&gt;. It is quite likely that this configuration improves throughput for many normal cluster configurations, and has negative implications only for very small clusters with only a handful of clients. We want the fewest connections we can get away with; perhaps, the client should automatically scale the connections based on throughput or cluster size.&lt;/p&gt;

&lt;p&gt;We haven&apos;t undertaken sufficient investigation to say with certainty, but it seems that what we are doing here is increasing the CPU &lt;em&gt;overhead&lt;/em&gt; per operation in order to &lt;em&gt;saturate&lt;/em&gt; the processing capacity of each box. However when there are more machines, or more simulated clients, this increased overhead is highly likely to reduce throughput.&lt;/p&gt;

&lt;p&gt;What we should probably do on our end is implement &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8466&quot; title=&quot;Stress support for treating clients as truly independent entities (separate driver instance)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8466&quot;&gt;CASSANDRA-8466&lt;/a&gt;, since this is how a majority of users really use their clusters: many clients, not one client with many connections in the Java driver. In the meantime the proposed patch for ourselves is fine, but I want to avoid us making the real world worse by changing the driver back.&lt;/p&gt;</comment>
                            <comment id="14614774" author="omichallat" created="Mon, 6 Jul 2015 09:31:06 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pingtimeout&quot; class=&quot;user-hover&quot; rel=&quot;pingtimeout&quot;&gt;pingtimeout&lt;/a&gt; found the bottleneck in the driver&apos;s code. The culprit is this line in the flusher code:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (&lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; != (flush = queued.poll())) {
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;In the driver, producers for this queue are application threads flushing their queries; the consumer is the Netty event loop, which executes the flusher code. What happens in stress tests is that we have many producers constantly enqueuing new messages, so the consumer ends up spinning a lot in this loop, which delays messages. This explains why it works better with more connections: more connections = more event loops = more queues = less pressure on each queue.&lt;/p&gt;

&lt;p&gt;The workaround is to add a limit to the maximum number of messages that can be flushed in one go. We&apos;re experimenting with this right now, it will go into 2.1.7 and 2.0.11.&lt;/p&gt;

&lt;p&gt;The problem does not exist with Cassandra because it&apos;s a server, both the producer and the consumer is the event loop.&lt;/p&gt;</comment>
                            <comment id="14614813" author="benedict" created="Mon, 6 Jul 2015 10:06:19 +0000"  >&lt;blockquote&gt;&lt;p&gt;The problem does not exist with Cassandra because it&apos;s a server, both the producer and the consumer is the event loop.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;They aren&apos;t, but there is a bound on the number of concurrent connections we can be processing requests for on the server, and so the queue size must itself be bounded. &lt;/p&gt;

&lt;p&gt;I would also suggest imposing a user-configurable bound on the size of your queues in the driver (or the total number of not-yet-sent messages), as there can be a multitude of reasons for the message queues to back up, and that&apos;s independently bad for the health of the application process. That wouldn&apos;t solve this problem, but it would have likely helped a great deal, and is something to consider as well (especially as we may start blocking receipt of messages to cope with cluster overload, which would translate to a growing application send buffer).&lt;/p&gt;

&lt;p&gt;Either way, good catch. Looks like the fix should be simple (let&apos;s hope it brings throughput right back up).&lt;/p&gt;</comment>
                            <comment id="14618242" author="omichallat" created="Wed, 8 Jul 2015 08:57:14 +0000"  >&lt;p&gt;Turns out that this doesn&apos;t explain the performance differences (I made a mistake in my early tests which led me to believe so). We&apos;re still profiling the driver, I&apos;ll report back when we find something.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12738025" name="2.1.log" size="87207" author="aboudreault" created="Fri, 5 Jun 2015 19:47:49 +0000"/>
                            <attachment id="12738026" name="2.2.log" size="87624" author="aboudreault" created="Fri, 5 Jun 2015 19:47:49 +0000"/>
                            <attachment id="12738147" name="CASSANDRA-9558-2.patch" size="3539" author="andrew.tolbert" created="Sat, 6 Jun 2015 08:08:19 +0000"/>
                            <attachment id="12738062" name="CASSANDRA-9558-ProtocolV2.patch" size="1259" author="andrew.tolbert" created="Fri, 5 Jun 2015 21:39:38 +0000"/>
                            <attachment id="12738143" name="atolber-CASSANDRA-9558-stress.tgz" size="10425" author="andrew.tolbert" created="Sat, 6 Jun 2015 06:39:03 +0000"/>
                            <attachment id="12738178" name="atolber-trunk-driver-coalescing-disabled.txt" size="11908" author="andrew.tolbert" created="Sat, 6 Jun 2015 16:27:15 +0000"/>
                            <attachment id="12738064" name="stress-2.1-java-driver-2.0.9.2.log" size="4565" author="aboudreault" created="Fri, 5 Jun 2015 21:40:41 +0000"/>
                            <attachment id="12738068" name="stress-2.1-java-driver-2.2+PATCH.log" size="5861" author="aboudreault" created="Fri, 5 Jun 2015 21:47:41 +0000"/>
                            <attachment id="12738065" name="stress-2.1-java-driver-2.2.log" size="8097" author="aboudreault" created="Fri, 5 Jun 2015 21:40:41 +0000"/>
                            <attachment id="12738071" name="stress-2.2-java-driver-2.2+PATCH.log" size="5957" author="aboudreault" created="Fri, 5 Jun 2015 22:00:55 +0000"/>
                            <attachment id="12738070" name="stress-2.2-java-driver-2.2.log" size="8193" author="aboudreault" created="Fri, 5 Jun 2015 22:00:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[andrew.tolbert]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 19 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fp33:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324945">2.2.0 beta 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aboudreault</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>