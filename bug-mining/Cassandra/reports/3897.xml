<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:58:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10501] Failure to start up Cassandra when temporary compaction files are not all renamed after kill/crash (FSReadError)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10501</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have seen an issue intermittently but repeatedly over the last few months where, after exiting the Cassandra process, it fails to start with an FSReadError (stack trace below). The FSReadError refers to a &apos;statistics&apos; file for a  that doesn&apos;t exist, though a corresponding temporary file does exist (eg. there is no /media/data/cassandraDB/data/clusteradmin/singleton_token-01a92ed069b511e59b2c53679a538c14/clusteradmin-singleton_token-ka-9-Statistics.db file, but there is a /media/data/cassandraDB/data/clusteradmin/singleton_token-01a92ed069b511e59b2c53679a538c14/clusteradmin-singleton_token-tmp-ka-9-Statistics.db file.)&lt;/p&gt;

&lt;p&gt;We tracked down the issue to the fact that the process exited with leftover compactions and some of the &apos;tmp&apos; files for the SSTable had been renamed to final files, but not all of them - the issue happens if the &apos;Statistics&apos; file is not renamed but others are. The scenario we&apos;ve seen on the last two occurrences involves the &apos;CompressionInfo&apos; file being a final file while all other files for the SSTable generation were left with &apos;tmp&apos; names.&lt;/p&gt;

&lt;p&gt;When this occurs, Cassandra cannot start until the file issue is resolved; we&apos;ve worked around it by deleting the SSTable files from the same generation, both final and tmp, which at least allows Cassandra to start. Renaming all files to either tmp or final names would also work.&lt;/p&gt;

&lt;p&gt;We&apos;ve done some debugging in Cassandra and have been unable to cause the issue without renaming the files manually. The rename code at SSTableWriter.rename() looks like it could result in this if the process exits in the middle of the rename, but in every occurrence we&apos;ve debugged through, the Set of components is ordered and Statistics is the first file renamed.&lt;/p&gt;

&lt;p&gt;However the comments in SSTableWriter.rename() suggest that the &apos;Data&apos; file is meant to be used as meaning the files were completely renamed. The method ColumnFamilyStore. removeUnfinishedCompactionLeftovers(), however, will proceed assuming the compaction is complete if any of the component files has a final name, and will skip temporary files when reading the list. If the &apos;Statistics&apos; file is temporary then it won&apos;t be read, and the defaults does not include a list of ancestors, leading to the NullPointerException.&lt;/p&gt;

&lt;p&gt;It appears that ColumnFamilyStore. removeUnfinishedCompactionLeftovers() should perhaps either ensure that all &apos;tmp&apos; files are properly renamed before it uses them, or skip SSTable files that don&apos;t have either the &apos;Data&apos; or &apos;Statistics&apos; file in final form.&lt;/p&gt;

&lt;p&gt;Stack trace: &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;FSReadError in Failed to remove unfinished compaction leftovers (file: /media/data/cassandraDB/data/clusteradmin/singleton_token-01a92ed069b511e59b2c53679a538c14/clusteradmin-singleton_token-ka-9-Statistics.db).  See log &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; details.
        at org.apache.cassandra.db.ColumnFamilyStore.removeUnfinishedCompactionLeftovers(ColumnFamilyStore.java:617)
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:302)
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:536)
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:625)
Caused by: java.lang.NullPointerException
        at org.apache.cassandra.db.ColumnFamilyStore.removeUnfinishedCompactionLeftovers(ColumnFamilyStore.java:609)
        ... 3 more
Exception encountered during startup: java.lang.NullPointerException
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Cassandra 2.1.6&lt;br/&gt;
Redhat Linux&lt;/p&gt;</environment>
        <key id="12903904">CASSANDRA-10501</key>
            <summary>Failure to start up Cassandra when temporary compaction files are not all renamed after kill/crash (FSReadError)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="matroy">Mathieu Roy</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>triage</label>
                    </labels>
                <created>Fri, 9 Oct 2015 21:28:26 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:53 +0000</updated>
                            <resolved>Tue, 27 Oct 2015 11:13:15 +0000</resolved>
                                        <fixVersion>2.1.12</fixVersion>
                    <fixVersion>2.2.4</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14966419" author="fredderf" created="Wed, 21 Oct 2015 08:16:09 +0000"  >&lt;p&gt;We have seen the same issue. The question I have if its safe to remove all files from the same generation without loosing data in that scenario? At least Cassandra starts after doing that.&lt;/p&gt;</comment>
                            <comment id="14969168" author="krummas" created="Thu, 22 Oct 2015 13:38:17 +0000"  >&lt;p&gt;Looks like the reason is that if we have renamed a single sstable component, we will enter &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.1/src/java/org/apache/cassandra/db/ColumnFamilyStore.java#L647&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; loop and get the exception.&lt;/p&gt;

&lt;p&gt;It should be safe to remove the files from the generation mentioned in the FSReadError until we have a fix out.&lt;/p&gt;</comment>
                            <comment id="14969226" author="fredderf" created="Thu, 22 Oct 2015 14:23:58 +0000"  >&lt;p&gt;Is it safe to remove the files from the generation even in an single-node cluster scenario without data-loss?&lt;/p&gt;</comment>
                            <comment id="14970565" author="krummas" created="Fri, 23 Oct 2015 06:59:59 +0000"  >&lt;p&gt;patch for this here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/10501&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/10501&lt;/a&gt; - just ignore the sstable if it does not have the data component in removeUnfinishedCompactionLeftovers&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Fredderf&quot; class=&quot;user-hover&quot; rel=&quot;Fredderf&quot;&gt;Fredderf&lt;/a&gt; yup, it should be safe.&lt;/p&gt;</comment>
                            <comment id="14974376" author="fredderf" created="Mon, 26 Oct 2015 15:23:26 +0000"  >&lt;p&gt;Will this one be included in 2.1.12?&lt;/p&gt;</comment>
                            <comment id="14974967" author="yukim" created="Mon, 26 Oct 2015 20:24:20 +0000"  >&lt;p&gt;Patch looks good to me though can you run tests on cassci to make sure it doesn&apos;t broke anything?&lt;/p&gt;</comment>
                            <comment id="14976221" author="krummas" created="Tue, 27 Oct 2015 11:03:23 +0000"  >&lt;p&gt;tests look very similar, will commit:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10501_2-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10501_2-testall/&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10501_2-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://cassci.datastax.com/view/Dev/view/krummas/job/krummas-marcuse-10501_2-dtest/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14976235" author="krummas" created="Tue, 27 Oct 2015 11:13:15 +0000"  >&lt;p&gt;committed to 2.1 and 2.2 - this is rewritten in 3.0 so I don&apos;t think this is an issue there&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12903735">CASSANDRA-10497</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12916632">CASSANDRA-10780</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 4 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2mu9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332265">2.1.6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>