<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13651] Large amount of CPU used by epoll_wait(.., .., .., 0)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13651</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I was trying to profile Cassandra under my workload and I kept seeing this backtrace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;epollEventLoopGroup-2-3 State: RUNNABLE CPU usage on sample: 240ms
io.netty.channel.epoll.Native.epollWait0(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) Native.java (&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;)
io.netty.channel.epoll.Native.epollWait(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, EpollEventArray, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;) Native.java:111
io.netty.channel.epoll.EpollEventLoop.epollWait(&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt;) EpollEventLoop.java:230
io.netty.channel.epoll.EpollEventLoop.run() EpollEventLoop.java:254
io.netty.util.concurrent.SingleThreadEventExecutor$5.run() SingleThreadEventExecutor.java:858
io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run() DefaultThreadFactory.java:138
java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run() &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At fist I though that the profiler might not be able to profile native code properly, but I wen&apos;t further and I realized that most of the CPU was used by &lt;tt&gt;epoll_wait()&lt;/tt&gt; calls with a timeout of zero.&lt;/p&gt;

&lt;p&gt;Here is the output of perf on this system, which confirms that most of the overhead was with timeout == 0.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Samples: 11M of event &lt;span class=&quot;code-quote&quot;&gt;&apos;syscalls:sys_enter_epoll_wait&apos;&lt;/span&gt;, Event count (approx.): 11594448
Overhead  Trace output                                                                                                                                                                                           &#9670;
  90.06%  epfd: 0x00000047, events: 0x7f5588c0c000, maxevents: 0x00002000, timeout: 0x00000000                                                                                                                   &#9618;
   5.77%  epfd: 0x000000b5, events: 0x7fca419ef000, maxevents: 0x00001000, timeout: 0x00000000                                                                                                                   &#9618;
   1.98%  epfd: 0x000000b5, events: 0x7fca419ef000, maxevents: 0x00001000, timeout: 0x000003e8                                                                                                                   &#9618;
   0.04%  epfd: 0x00000003, events: 0x2f6af77b9c00, maxevents: 0x00000020, timeout: 0x00000000                                                                                                                   &#9618;
   0.04%  epfd: 0x0000002b, events: 0x121ebf63ac00, maxevents: 0x00000040, timeout: 0x00000000                                                                                                                   &#9618;
   0.03%  epfd: 0x00000026, events: 0x7f51f80019c0, maxevents: 0x00000020, timeout: 0x00000000                                                                                                                   &#9618;
   0.02%  epfd: 0x00000003, events: 0x7fe4d80019d0, maxevents: 0x00000020, timeout: 0x00000000
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Running this time with perf record -ag for call traces:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# Children      Self       sys       usr  Trace output                                                                        
# ........  ........  ........  ........  ....................................................................................
#
     8.61%     8.61%     0.00%     8.61%  epfd: 0x000000a7, events: 0x7fca452d6000, maxevents: 0x00001000, timeout: 0x00000000
            |
            ---0x1000200af313
               |          
                --8.61%--0x7fca6117bdac
                          0x7fca60459804
                          epoll_wait

     2.98%     2.98%     0.00%     2.98%  epfd: 0x000000a7, events: 0x7fca452d6000, maxevents: 0x00001000, timeout: 0x000003e8
            |
            ---0x1000200af313
               0x7fca6117b830
               0x7fca60459804
               epoll_wait
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That looks like a lot of CPU used to wait for nothing. I&apos;m not sure if pref reports a per-CPU percentage or a per-system percentage, but that would be still be 10% of the total CPU usage of Cassandra at the minimum.&lt;/p&gt;

&lt;p&gt;I went further and found the code of all that: We schedule a lot of &lt;tt&gt;Message::Flusher&lt;/tt&gt; with a deadline of 10 usec (5 per messages I think) but netty+epoll only support timeouts above the milliseconds and will convert everything bellow to 0.&lt;/p&gt;

&lt;p&gt;I added some traces to netty (4.1):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;diff --git a/transport-&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;-epoll/src/main/java/io/netty/channel/epoll/EpollEventLoop.java b/transport-&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;-epoll/src/main/java/io/netty/channel/epoll/EpollEventLoop.java
index 909088fde..8734bbfd4 100644
--- a/transport-&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;-epoll/src/main/java/io/netty/channel/epoll/EpollEventLoop.java
+++ b/transport-&lt;span class=&quot;code-keyword&quot;&gt;native&lt;/span&gt;-epoll/src/main/java/io/netty/channel/epoll/EpollEventLoop.java
@@ -208,10 +208,15 @@ &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;EpollEventLoop &lt;span class=&quot;code-keyword&quot;&gt;extends&lt;/span&gt; SingleThreadEventLoop {
         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; currentTimeNanos = &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.nanoTime();
         &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; selectDeadLineNanos = currentTimeNanos + delayNanos(currentTimeNanos);
         &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (;;) {
-            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timeoutMillis = (selectDeadLineNanos - currentTimeNanos + 500000L) / 1000000L;
+            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timeoutNanos = selectDeadLineNanos - currentTimeNanos + 500000L;
+            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; timeoutMillis =  timeoutNanos / 1000000L;
+            &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.printf(&lt;span class=&quot;code-quote&quot;&gt;&quot;timeoutNanos: %d, timeoutMillis: %d | deadline: %d - now: %d | hastask: %d\n&quot;&lt;/span&gt;,
+                    timeoutNanos, timeoutMillis,
+                    selectDeadLineNanos, currentTimeNanos, hasTasks() ? 1 : 0);
             &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (timeoutMillis &amp;lt;= 0) {
                 &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (selectCnt == 0) {
                     &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; ready = Native.epollWait(epollFd.intValue(), events, 0);
+                    &lt;span class=&quot;code-object&quot;&gt;System&lt;/span&gt;.out.printf(&lt;span class=&quot;code-quote&quot;&gt;&quot;ready: %d\n&quot;&lt;/span&gt;, ready);
                     &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (ready &amp;gt; 0) {
                         &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ready;
                     }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And this gives :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;timeoutNanos: 1000500000, timeoutMillis: 1000 | deadline: 2001782341816510 - now: 2001781341816510 | hastask: 0
timeoutNanos: 1000500000, timeoutMillis: 1000 | deadline: 2001782342087239 - now: 2001781342087239 | hastask: 0
timeoutNanos: 1000500000, timeoutMillis: 1000 | deadline: 2001782342166947 - now: 2001781342166947 | hastask: 0
timeoutNanos: 508459, timeoutMillis: 0 | deadline: 2001781342297987 - now: 2001781342289528 | hastask: 0
ready: 0
timeoutNanos: 508475, timeoutMillis: 0 | deadline: 2001781342357719 - now: 2001781342349244 | hastask: 0
ready: 0
timeoutNanos: 509327, timeoutMillis: 0 | deadline: 2001781342394822 - now: 2001781342385495 | hastask: 0
ready: 0
timeoutNanos: 509339, timeoutMillis: 0 | deadline: 2001781342430192 - now: 2001781342420853 | hastask: 0
ready: 0
timeoutNanos: 509510, timeoutMillis: 0 | deadline: 2001781342461588 - now: 2001781342452078 | hastask: 0
ready: 0
timeoutNanos: 509493, timeoutMillis: 0 | deadline: 2001781342495044 - now: 2001781342485551 | hastask: 0
ready: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The nanosecond timeout all come from &lt;tt&gt;eventLoop.schedule(this, 10000, TimeUnit.NANOSECONDS);&lt;/tt&gt; in &lt;tt&gt;Message::Flusher&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Knowing that, I&apos;m not sure what would be best to do, and I have a hard time understanding Message::Flusher, but to me it looks like trying to schedule less tasks would probably help and I didn&apos;t think anything obvious that could be done with netty.&lt;/p&gt;

&lt;p&gt;Changing &lt;tt&gt;if (++runsWithNoWork &amp;gt; 5)&lt;/tt&gt; to 2 seems to help a little bit, but that isn&apos;t really significant.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13083792">CASSANDRA-13651</key>
            <summary>Large amount of CPU used by epoll_wait(.., .., .., 0)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="burmanm">Michael Burman</assignee>
                                    <reporter username="iksaif">Corentin Chary</reporter>
                        <labels>
                            <label>pull-request-available</label>
                    </labels>
                <created>Fri, 30 Jun 2017 14:03:00 +0000</created>
                <updated>Fri, 15 May 2020 08:06:21 +0000</updated>
                            <resolved>Fri, 24 Aug 2018 15:12:24 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>12</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="600">10m</timespent>
                                <comments>
                            <comment id="16070535" author="iksaif" created="Fri, 30 Jun 2017 18:33:23 +0000"  >&lt;p&gt;Things to check or try (for me):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;io.netty.eventLoopThreads&lt;/li&gt;
	&lt;li&gt;Check if we could use the same eventloop instead of starting two&lt;/li&gt;
	&lt;li&gt;Create a custom SelectStrategy that skips looking at fds if there is a scheduled task happening in a few microseconds&lt;/li&gt;
	&lt;li&gt;Try to understand why Message::Flusher currently works this way&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16070634" author="jasobrown" created="Fri, 30 Jun 2017 20:00:49 +0000"  >&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=norman&quot; class=&quot;user-hover&quot; rel=&quot;norman&quot;&gt;norman&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16070997" author="iksaif" created="Sat, 1 Jul 2017 04:54:16 +0000"  >&lt;p&gt;Also check:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/netty/netty/issues/1759&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/issues/1759&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://gist.github.com/jadbaz/47d98da0ead2e71659f343b14ef05de6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://gist.github.com/jadbaz/47d98da0ead2e71659f343b14ef05de6&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;Benchmark batching vs. stupid writeAndFlush()&lt;/li&gt;
	&lt;li&gt;It&apos;s unclear why sending the response is done in the flusher right now&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/spotify/netty-batch-flusher&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/spotify/netty-batch-flusher&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16072162" author="iksaif" created="Mon, 3 Jul 2017 09:20:38 +0000"  >&lt;p&gt;I cooked a patch to use spotify&apos;s netty-batch-flusher instead of the current flusher. Here are some results:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;normal:

Results:
Op rate                   :    4,220 op/s  [insert: 4,220 op/s]
Partition rate            :    4,220 pk/s  [insert: 4,220 pk/s]
Row rate                  :   41,851 row/s [insert: 41,851 row/s]
Latency mean              :    0.2 ms [insert: 0.2 ms]
Latency median            :    0.2 ms [insert: 0.2 ms]
Latency 95th percentile   :    0.2 ms [insert: 0.2 ms]
Latency 99th percentile   :    0.3 ms [insert: 0.3 ms]
Latency 99.9th percentile :    0.4 ms [insert: 0.4 ms]
Latency max               :   65.5 ms [insert: 65.5 ms]
Total partitions          :    100,000 [insert: 100,000]
Total errors              :          0 [insert: 0]
Total GC count            : 6
Total GC memory           : 3.473 GiB
Total GC time             :    0.4 seconds
Avg GC time               :   60.0 ms
StdDev GC time            :    5.1 ms
Total operation time      : 00:00:23
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;batched:

Results:
Op rate                   :    4,344 op/s  [insert: 4,344 op/s]
Partition rate            :    4,344 pk/s  [insert: 4,344 pk/s]
Row rate                  :   43,121 row/s [insert: 43,121 row/s]
Latency mean              :    0.2 ms [insert: 0.2 ms]
Latency median            :    0.2 ms [insert: 0.2 ms]
Latency 95th percentile   :    0.2 ms [insert: 0.2 ms]
Latency 99th percentile   :    0.3 ms [insert: 0.3 ms]
Latency 99.9th percentile :    0.4 ms [insert: 0.4 ms]
Latency max               :   63.4 ms [insert: 63.4 ms]
Total partitions          :    100,000 [insert: 100,000]
Total errors              :          0 [insert: 0]
Total GC count            : 6
Total GC memory           : 3.467 GiB
Total GC time             :    0.4 seconds
Avg GC time               :   60.0 ms
StdDev GC time            :    3.3 ms
Total operation time      : 00:00:23
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So slightly more QPS, but more interestingly, the epoll thread now uses ~4 times less CPU. I&apos;ll try to do a full scale benchmark on a bigger workload with 3 nodes tomorrow.&lt;/p&gt;

&lt;p&gt;Patch at &lt;a href=&quot;https://github.com/iksaif/cassandra/tree/cassandra-13651-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iksaif/cassandra/tree/cassandra-13651-trunk&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16073502" author="iksaif" created="Tue, 4 Jul 2017 11:28:20 +0000"  >&lt;p&gt;I ran tests on a 3 node cluster, I can confirm that not using scheduled tasks and using a simpler batcher removes all the &lt;tt&gt;epoll_wait(..., 0)&lt;/tt&gt; calls. This reduces the CPU used by epoll threads.&lt;br/&gt;
I need to take more time do check how efficient the batching still is, and compare the context switchs with and without it.&lt;/p&gt;</comment>
                            <comment id="16099971" author="iksaif" created="Tue, 25 Jul 2017 12:35:15 +0000"  >&lt;p&gt;Latest patch (&lt;a href=&quot;https://github.com/iksaif/cassandra/tree/cassandra-13651-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iksaif/cassandra/tree/cassandra-13651-trunk&lt;/a&gt;)  tested with an actual workload, I attached the screenshot.&lt;br/&gt;
Looks like we can get ~2% of CPU back with -Dcassandra.netty_flush_delay_nanoseconds=0 and some more with -Dio.netty.eventLoopThreads=6. This doesn&apos;t not seem to affect latency&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://issues.apache.org/jira/images/icons/attach/noimage.png&quot; imagetext=&quot;Screenshot (5).png|thumbnail&quot; align=&quot;absmiddle&quot; border=&quot;0&quot; /&gt;&lt;/p&gt;</comment>
                            <comment id="16109278" author="iksaif" created="Tue, 1 Aug 2017 16:52:21 +0000"  >&lt;p&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/12879868/12879868_cpu-usage.png&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Almost ~8% of CPU saving after updating all three nodes.&lt;/p&gt;</comment>
                            <comment id="16110320" author="jjirsa" created="Wed, 2 Aug 2017 05:18:47 +0000"  >&lt;p&gt;That&apos;s really interesting. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=norman&quot; class=&quot;user-hover&quot; rel=&quot;norman&quot;&gt;norman&lt;/a&gt; - if you get a few minutes to glance, always appreciate your thoughts here. &lt;/p&gt;

&lt;p&gt;Also, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iksaif&quot; class=&quot;user-hover&quot; rel=&quot;iksaif&quot;&gt;iksaif&lt;/a&gt; - can you share a bit more detail on your test? Is it just stress? Have you tested with many connected clients? Any immediate reason you suspect that CPU went down (significantly?), but throughput remains unchanged (do you see the next bottleneck, the op rate on that stress run looks pretty low, even for a single machine cluster?)&lt;/p&gt;</comment>
                            <comment id="16110335" author="norman" created="Wed, 2 Aug 2017 05:32:39 +0000"  >&lt;p&gt;Sorry for the late response.. didn&apos;t see the mention &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;So yes netty uses `epoll_wait` which only supports milli-seconds resulution so everything smaller then this will just cause `epoll_wait(...)` be called with a `0` and so a non-blocking check of ready fds. What we could do in our native transport implementation is that we make use of `timerfd` &lt;span class=&quot;error&quot;&gt;&amp;#91;1&amp;#93;&lt;/span&gt; to schedule timeouts but again this would only work for the case of using the native epoll transport and not when you use the nio transport (which works on all OS). So I think what you really want to do is have timeouts of &amp;gt;= 1ms. &lt;/p&gt;

&lt;p&gt;Comments and ideas welcome &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16110416" author="iksaif" created="Wed, 2 Aug 2017 06:50:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt;: The cassandra-stress report is for &lt;a href=&quot;https://github.com/criteo/biggraphite/blob/master/tools/stress/biggraphite.yaml&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/criteo/biggraphite/blob/master/tools/stress/biggraphite.yaml&lt;/a&gt;. The bottleneck here was the lack of parallelization on the client I guess.&lt;br/&gt;
The screenshot is the actual workload of BigGraphite: 3 nodes, 100 connected clients.&lt;/p&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=norman&quot; class=&quot;user-hover&quot; rel=&quot;norman&quot;&gt;norman&lt;/a&gt;: Both timeouts of 1ms or no timeouts would achieve the same thing I guess. I tested with no timeout as it implied less changes to the actual logic (see &lt;a href=&quot;https://github.com/iksaif/cassandra/tree/cassandra-13651-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iksaif/cassandra/tree/cassandra-13651-trunk&lt;/a&gt;). Currently (I believe that) the message itself it written after the delay, increasing the timeout will increase the latency of every operations. In my test I simply disable the timeout and schedule the flush task as soon as I can, this doesn&apos;t reduce the opportunities for batching that much if you keep the number of epoll threads low.&lt;/p&gt;</comment>
                            <comment id="16110935" author="jjirsa" created="Wed, 2 Aug 2017 13:47:39 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iksaif&quot; class=&quot;user-hover&quot; rel=&quot;iksaif&quot;&gt;iksaif&lt;/a&gt; - this is not a review (and I think there are better people around to review this than myself, like either Norman, Jason, Jake or Ariel), but I&apos;m unable to get a clean test run with your patch on trunk with either netty 4.0.44 or 4.1.13. You mention in the first post that you added some traces to 4.1 - can you confirm which version of netty you tested with? Can you also confirm whether or not &lt;tt&gt;ant test -Dtest.name=NativeTransportServiceTest&lt;/tt&gt; passes cleanly for you?&lt;/p&gt;</comment>
                            <comment id="16111027" author="norman" created="Wed, 2 Aug 2017 14:39:52 +0000"  >&lt;p&gt;Also for the record Scott Mitchell (another core netty dev) just created a PR in netty to support micro seconds timeouts when using the native epoll transport:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/netty/netty/pull/7042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/pull/7042&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;That said I still need to review it in detail and its not merged yet.&lt;/p&gt;</comment>
                            <comment id="16111060" author="iksaif" created="Wed, 2 Aug 2017 14:52:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/iksaif/cassandra/commit/c05f2eef6abc8066b69e50dc5025f17e17871f0c&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iksaif/cassandra/commit/c05f2eef6abc8066b69e50dc5025f17e17871f0c&lt;/a&gt; should fix the test.&lt;/p&gt;

&lt;p&gt;I&apos;m running with 4.0.44. The production test is using 3.11 as a base but I&apos;m able to start trunk on my dev machine.&lt;/p&gt;</comment>
                            <comment id="16112292" author="iksaif" created="Thu, 3 Aug 2017 06:57:56 +0000"  >&lt;p&gt;Using timerfd is something that I looked at, but I though that it would be easier to just change the code in Cassandra for now. I&apos;ll be out in the next three weeks but I&apos;ll definitivement try a patched version of netty when I&apos;m back.&lt;/p&gt;</comment>
                            <comment id="16133438" author="norman" created="Fri, 18 Aug 2017 18:39:35 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iksaif&quot; class=&quot;user-hover&quot; rel=&quot;iksaif&quot;&gt;iksaif&lt;/a&gt; FYI we will merge the change to use timerfd today and so it will be part of the next Netty release. That said I think what you suggested (changing the Cassandra code) may make more sense in general.&lt;/p&gt;</comment>
                            <comment id="16143466" author="iksaif" created="Mon, 28 Aug 2017 07:16:45 +0000"  >&lt;p&gt;Great ! I&apos;m good with either bumping netty to this version or merging my patch, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt; what do you think ?&lt;/p&gt;</comment>
                            <comment id="16166200" author="iksaif" created="Thu, 14 Sep 2017 12:52:56 +0000"  >&lt;p&gt;Ping, anything against &lt;a href=&quot;https://github.com/iksaif/cassandra/commits/cassandra-13651-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iksaif/cassandra/commits/cassandra-13651-trunk&lt;/a&gt; ? If not I&apos;ll send a proper pull request.&lt;/p&gt;</comment>
                            <comment id="16167083" author="jasobrown" created="Thu, 14 Sep 2017 22:50:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iksaif&quot; class=&quot;user-hover&quot; rel=&quot;iksaif&quot;&gt;iksaif&lt;/a&gt; I just took a read through your patch.  Here&apos;s my thoughts:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The refactoring of &lt;tt&gt;Dispatcher#FlushItem&lt;/tt&gt; to &lt;tt&gt;DelayedFlusher&lt;/tt&gt; is unnecessary. There&apos;s nothing functionally incorrect with the existing implementation. (I&apos;ll posit that the nested class within a nested class is ... non-standard.)&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;NativeTransportService#defaultWorkerGroup&lt;/tt&gt; is confusing. Why not just use the existing &lt;tt&gt;NativeTransportService#workerGroup&lt;/tt&gt;?&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;NativeTransportService#getDefaultWorkerGroup&lt;/tt&gt; isn&apos;t thread safe, and so you could end up with mutiple {{EventLoopGroup}}s group created - although this maybe not a problem in practice.&lt;/li&gt;
	&lt;li&gt;Scott&apos;s netty patch landed in 4.1.15. Let&apos;s update trunk for that.&lt;/li&gt;
	&lt;li&gt;Minor nit: I&apos;d prefer to rename &lt;tt&gt;netty_flush_delay_nanoseconds&lt;/tt&gt; to something like &lt;tt&gt;native_transport_flush_delay_nanoseconds&lt;/tt&gt; to make it explicit that this property will only affect the netty use in the native transport and not the internode messaging or streaming.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Honestly, I think the patch can be reduced to simply adding the &lt;tt&gt;FLUSH_DELAY&lt;/tt&gt; logic to &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/transport/Message.java#L488&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;Message.Dispatcher.Flusher#run&lt;/tt&gt;&lt;/a&gt;, and updating netty. Or possibly just update netty and call it a day. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iksaif&quot; class=&quot;user-hover&quot; rel=&quot;iksaif&quot;&gt;iksaif&lt;/a&gt; let me know if you can run a test with just the updated netty library.&lt;/p&gt;</comment>
                            <comment id="16167399" author="iksaif" created="Fri, 15 Sep 2017 06:25:48 +0000"  >&lt;p&gt;Ok, here is the plan (for myself):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Separate the &quot;use only one worker group&quot; patch. It&apos;s useful because it creates less threads, but isn&apos;t really directly related to this.&lt;/li&gt;
	&lt;li&gt;Update netty to 4.1.15 on our setup (without -Dnetty_flush_delay_nanoseconds) and see the effects&lt;/li&gt;
	&lt;li&gt;Set -Dnetty_flush_delay_nanoseconds and see the effects. Depending on the results, propose a simpler version of the patch.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16168280" author="jasobrown" created="Fri, 15 Sep 2017 18:06:42 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iksaif&quot; class=&quot;user-hover&quot; rel=&quot;iksaif&quot;&gt;iksaif&lt;/a&gt; This all sounds great! A quick note: if you are testing on something lower than trunk, I think you can use netty 4.0.51 as that will also have Scott&apos;s patch (and will be generally more compatible with everything pre-&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8457&quot; title=&quot;nio MessagingService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8457&quot;&gt;&lt;del&gt;CASSANDRA-8457&lt;/del&gt;&lt;/a&gt;)&lt;/p&gt;</comment>
                            <comment id="16169984" author="githubbot" created="Mon, 18 Sep 2017 13:09:26 +0000"  >&lt;p&gt;GitHub user iksaif opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/151&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/151&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13651&quot; title=&quot;Large amount of CPU used by epoll_wait(.., .., .., 0)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13651&quot;&gt;&lt;del&gt;CASSANDRA-13651&lt;/del&gt;&lt;/a&gt;: Reduce epoll/timerfd CPU usage&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Bump Netty to 4.1.15&lt;/li&gt;
	&lt;li&gt;Add a setting to schedule flushes immediatly&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/iksaif/cassandra&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iksaif/cassandra&lt;/a&gt; cassandra-13651-trunk&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/151.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/151.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #151&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit 969dcee971242ff08a2ba1baf9e3139935e85ee8&lt;br/&gt;
Author: Corentin Chary &amp;lt;c.chary@criteo.com&amp;gt;&lt;br/&gt;
Date:   2017-09-18T12:12:46Z&lt;/p&gt;

&lt;p&gt;    Bump netty to 4.1.15&lt;/p&gt;

&lt;p&gt;    This is to take advantages of the improvements from &lt;a href=&quot;https://github.com/netty/netty/pull/7042&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/pull/7042&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;commit 594ef9eee5ad853eaec4234f9a11bc12e030ae6c&lt;br/&gt;
Author: Corentin Chary &amp;lt;c.chary@criteo.com&amp;gt;&lt;br/&gt;
Date:   2017-09-18T12:26:35Z&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13651&quot; title=&quot;Large amount of CPU used by epoll_wait(.., .., .., 0)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13651&quot;&gt;&lt;del&gt;CASSANDRA-13651&lt;/del&gt;&lt;/a&gt;: Reduce CPU used by epoll_wait() / timerfd_create()&lt;/p&gt;

&lt;p&gt;    By setting -Dcassandra.native_transport_flush_delay_nanoseconds=0 one can&lt;br/&gt;
    schedule the flush() immediatly which will be more efficient when&lt;br/&gt;
    using epoll() on Linux by reducing the number of calls to epoll_wait().&lt;/p&gt;

&lt;p&gt;    This is simmilarly more efficient on version of netty that use timerfd&lt;br/&gt;
    to get timeouts with microsecond resolution when calling epoll().&lt;/p&gt;

&lt;p&gt;    On those platforms this can save up to 10% of CPU.&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16169988" author="iksaif" created="Mon, 18 Sep 2017 13:11:21 +0000"  >&lt;p&gt;Results: the calls to timerfd end up costing almost as much as what epoll_wait() before. It is still more efficient to execute instead of schedule.&lt;/p&gt;

&lt;p&gt;I added a patch to bump netty to 4.1.15, and a way simpler version of my previous patch that allows one to configure the task delay.&lt;/p&gt;</comment>
                            <comment id="16170780" author="jasobrown" created="Mon, 18 Sep 2017 21:45:11 +0000"  >&lt;p&gt;Cool. Thanks for the patch. The code itself is trivial (adding a configuration property), however I liked what you had before: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (FLUSH_DELAY &amp;gt; 0)
    eventLoop.schedule(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, FLUSH_DELAY, TimeUnit.NANOSECONDS);
&lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
    eventLoop.execute(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That way if the &lt;tt&gt;FLUSH_DELAY&lt;/tt&gt; is 0, skip creating a scheduled task in netty and just submit it for execution. wdyt?&lt;/p&gt;

&lt;p&gt;I&apos;d like to run this in my test environment to verify if there&apos;s any change on my side. It may take a few days due to other on-going work.&lt;/p&gt;</comment>
                            <comment id="16171291" author="iksaif" created="Tue, 19 Sep 2017 08:18:55 +0000"  >&lt;p&gt;Thanks for double-checking that, I pushed the wrong version. This should now be fixed.&lt;/p&gt;</comment>
                            <comment id="16263992" author="iksaif" created="Thu, 23 Nov 2017 08:47:09 +0000"  >&lt;p&gt;ping ?&lt;/p&gt;</comment>
                            <comment id="16468728" author="burmanm" created="Wed, 9 May 2018 11:37:01 +0000"  >&lt;p&gt;I&apos;ve done a follow up patch to this also, available here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/burmanm/cassandra/commit/eb8af9a47b00a836fbb4e155aa64024250470ba7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/burmanm/cassandra/commit/eb8af9a47b00a836fbb4e155aa64024250470ba7&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I could not find a use-case where (at least using epoll) the timer would be beneficial. It&apos;s going to eat CPU all the time in any case, and I verified this by creating a small looping C program that did the same thing using epoll &amp;amp; timerfd directly (around ~4% CPU usage from the C program and ~6% from the Netty version when both are only rescheduling the job). So, I did the following to Flusher:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Removed automatic rescheduling by the Flusher&lt;/li&gt;
	&lt;li&gt;Instead, after every write we schedule the flush during the next eventloop invocation. If multiple writes are successful before that, they&apos;re flushed together&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In my tests, this both improves the&#160;throughput slightly, but more importantly, it also decreases latency. On Azure D8s_V3 instances, the latency is decreased by 0.3ms with mediocre and more punishing loads. Obviously, the profiler shows that we spent more time in the writevAddresses(), but then EpollWait0 is reduced to next to nothing during stress run.&lt;/p&gt;

&lt;p&gt;At this point I would suggest removing the batching completely and then return to this issue&#160;once we can sanely batch the work of encode also (and make that pipeline then flush at the end). &lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16587624" author="benedict" created="Tue, 21 Aug 2018 15:51:11 +0000"  >&lt;p&gt;So, I assume we&apos;re now defaulting to epoll in most cases, and this behaviour comes from a period where this wasn&apos;t the default (and was probably poorly justified at the time - AFAICR we used to benchmark with only a single connection, where this behaviour would be more beneficial).&lt;/p&gt;

&lt;p&gt;It&apos;s a shame we no longer have any standard benchmarking tools for the project, but it seems we have multiple data points demonstrating a win (or no loss), and the code is simpler after the patch.&lt;/p&gt;

&lt;p&gt;So, I&apos;m +1 on the patch.  I will get a circleci run going shortly.&lt;/p&gt;</comment>
                            <comment id="16587629" author="norman" created="Tue, 21 Aug 2018 15:54:08 +0000"  >&lt;p&gt;I am no committer but the netty project lead so from the point of view of netty usage I am also +1 on this.&lt;/p&gt;</comment>
                            <comment id="16587633" author="jjirsa" created="Tue, 21 Aug 2018 15:58:06 +0000"  >&lt;p&gt;There are two patches here, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iksaif&quot; class=&quot;user-hover&quot; rel=&quot;iksaif&quot;&gt;iksaif&lt;/a&gt;&apos;s patch and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=burmanm&quot; class=&quot;user-hover&quot; rel=&quot;burmanm&quot;&gt;burmanm&lt;/a&gt;&apos;s follow-patch, which did you each +1?&lt;/p&gt;</comment>
                            <comment id="16587656" author="benedict" created="Tue, 21 Aug 2018 16:06:13 +0000"  >&lt;p&gt;The latest, i.e. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=burmanm&quot; class=&quot;user-hover&quot; rel=&quot;burmanm&quot;&gt;burmanm&lt;/a&gt;&apos;s.&lt;/p&gt;

&lt;p&gt;It simplifies the code, and as I say, I&apos;m not sure the original patch was as well justified as we thought - our benchmarking methodology was flawed at the time (using a single connection).&lt;/p&gt;

&lt;p&gt;I suppose arguably there&apos;s value in maintaining the current behaviour for those users with a single connection and without epoll, but since epoll is now the default it&apos;s probably better to improve code clarity.&lt;/p&gt;

&lt;p&gt;I&apos;m open to dispute, of course, in which case we can revisit Corentin&apos;s patch (or try to reproduce the old benchmarks and see what we might be losing in modern C* in the worst case).  In this case, I would probably prefer to have a LegacyFlusher and a Flusher - the latter the cleaned code contributed by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=burmanm&quot; class=&quot;user-hover&quot; rel=&quot;burmanm&quot;&gt;burmanm&lt;/a&gt;, the former the old unadulterated code, and to select between them based on the config property (with a default being determined by epoll usage status)&lt;/p&gt;</comment>
                            <comment id="16591334" author="burmanm" created="Fri, 24 Aug 2018 08:39:22 +0000"  >&lt;p&gt;I added a commit &lt;a href=&quot;https://github.com/burmanm/cassandra/commit/681ab256e0af50827169d88931fadf89b3cd3770&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/burmanm/cassandra/commit/681ab256e0af50827169d88931fadf89b3cd3770&lt;/a&gt; to tree &lt;a href=&quot;https://github.com/burmanm/cassandra/tree/netty_flusher&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/burmanm/cassandra/tree/netty_flusher&lt;/a&gt; which allows selecting either the new behavior (default) or the old one. I&apos;m open to better naming and description &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; I&apos;ve made the new behavior enabled for default now, or do you still wish to have the old behavior as default for non-epoll cases?&lt;/p&gt;</comment>
                            <comment id="16591345" author="benedict" created="Fri, 24 Aug 2018 08:50:25 +0000"  >&lt;p&gt;Looks good.  The user-visible property should probably be adjacent to the native_transport settings, though, and prefixed by the same name; perhaps be named something like &lt;tt&gt;native_transport_flush_in_batches_legacy&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16591443" author="burmanm" created="Fri, 24 Aug 2018 10:21:53 +0000"  >&lt;p&gt;Sounds a lot better name. Changed to that, rebased to current trunk: &lt;a href=&quot;https://github.com/burmanm/cassandra/commit/30e4dda2d3c3e6124fe118d61da798d216ad20b9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/burmanm/cassandra/commit/30e4dda2d3c3e6124fe118d61da798d216ad20b9&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16591782" author="benedict" created="Fri, 24 Aug 2018 15:12:24 +0000"  >&lt;p&gt;Committed to &lt;a href=&quot;https://github.com/apache/cassandra/commit/96ef514917e5a4829dbe864104dbc08a7d0e0cec&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt; with some small edits.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12879868" name="cpu-usage.png" size="76174" author="iksaif" created="Tue, 1 Aug 2017 16:52:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[burmanm]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3gy9r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>