<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:17:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-1736] ConcurrentModificationException when updating column family metadata</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-1736</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;From cli&lt;br/&gt;
&amp;gt; update column family Tweet with column_metadata=[&lt;/p&gt;
{column_name:state, validation_class:UTF8Type}
&lt;p&gt;]&lt;br/&gt;
&amp;gt; set Tweet &lt;span class=&quot;error&quot;&gt;&amp;#91;x&amp;#93;&lt;/span&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;state&amp;#93;&lt;/span&gt; = TX&lt;br/&gt;
&amp;gt; get Tweet where state = TX&lt;br/&gt;
No index columns present&lt;br/&gt;
&amp;gt; update column family Tweet with column_metadata=[&lt;/p&gt;
{column_name:state, index_type:0, validation_class:UTF8Type}
&lt;p&gt;]&lt;br/&gt;
null&lt;br/&gt;
&amp;gt; list Tweet&lt;br/&gt;
java.net.SocketException: Broken pipe&lt;/p&gt;


&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;MigrationStage:1&amp;#93;&lt;/span&gt; 2010-11-12 09:12:28,618 AbstractCassandraDaemon.java (line 90) Fatal exception in thread Thread[Migra$&lt;br/&gt;
java.util.ConcurrentModificationException&lt;br/&gt;
        at java.util.HashMap$HashIterator.nextEntry(HashMap.java:793)&lt;br/&gt;
        at java.util.HashMap$KeyIterator.next(HashMap.java:828)&lt;br/&gt;
        at org.apache.cassandra.db.ColumnFamilyStore.snapshot(ColumnFamilyStore.java:1495)&lt;br/&gt;
        at org.apache.cassandra.db.migration.UpdateColumnFamily.beforeApplyModels(UpdateColumnFamily.java:76)&lt;br/&gt;
        at org.apache.cassandra.db.migration.Migration.apply(Migration.java:109)&lt;br/&gt;
        at org.apache.cassandra.thrift.CassandraServer$2.call(CassandraServer.java:672)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619)&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;pool-1-thread-5&amp;#93;&lt;/span&gt; 2010-11-12 09:12:28,636 CustomTThreadPoolServer.java (line 175) Thrift error occurred during processin$&lt;br/&gt;
org.apache.thrift.protocol.TProtocolException: Required field &apos;why&apos; was not present! Struct: InvalidRequestException(why:null)&lt;br/&gt;
        at org.apache.cassandra.thrift.InvalidRequestException.validate(InvalidRequestException.java:340)&lt;br/&gt;
        at org.apache.cassandra.thrift.InvalidRequestException.write(InvalidRequestException.java:309)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$system_update_column_family_result.write(Cassandra.java:26764)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor$system_update_column_family.process(Cassandra.java:3605)&lt;br/&gt;
        at org.apache.cassandra.thrift.Cassandra$Processor.process(Cassandra.java:2555)&lt;br/&gt;
        at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:167)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:619)&lt;/p&gt;</description>
                <environment></environment>
        <key id="12479813">CASSANDRA-1736</key>
            <summary>ConcurrentModificationException when updating column family metadata</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="bterm">JCF</reporter>
                        <labels>
                    </labels>
                <created>Fri, 12 Nov 2010 17:31:41 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:13 +0000</updated>
                            <resolved>Tue, 23 Nov 2010 15:26:17 +0000</resolved>
                                        <fixVersion>0.7.0 rc 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12931614" author="jbellis" created="Sat, 13 Nov 2010 03:06:27 +0000"  >&lt;p&gt;This is a regression caused by treating the compaction marker as a component (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1471&quot; title=&quot;Improve SSTable discovery and allow for more components&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1471&quot;&gt;&lt;del&gt;CASSANDRA-1471&lt;/del&gt;&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1544&quot; title=&quot;Compacted SSTables not properly removed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1544&quot;&gt;&lt;del&gt;CASSANDRA-1544&lt;/del&gt;&lt;/a&gt;).  The CME comes when compaction modifies the components set while snapshot is iterating over them; since snapshot begins by flushing, this is actually fairly likely to happen (especially with non-JNA snapshots, i.e., slow ones).&lt;/p&gt;

&lt;p&gt;IMO the best fix to this would be to stop treating the compaction marker as a component and make the components set Unmodifiable to close off that avenue of bugs in the future.&lt;/p&gt;</comment>
                            <comment id="12931616" author="jbellis" created="Sat, 13 Nov 2010 03:15:27 +0000"  >&lt;p&gt;One reason I don&apos;t think compaction marker belongs in components is that as this bug highlights, we could end up with the marker as part of a snapshot.  Which would cause a more subtle bug.  Here is the order of events:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;My CFS has sstables A B C.
Flush introduces sstable D.
We begin compacting A B C D.
We begin iterating A B C D &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; snapshot.
During the iteration, compaction finishes producing sstable E.  A B C D are marked compacted.
snapshot finishes, with (say) C D marked compacted.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now, the sstable tracker guarantees that we see a consistent view of the sstables &amp;#8211; we will either exactly one of  &lt;/p&gt;
{A B C D}
&lt;p&gt; or &lt;/p&gt;
{E}
&lt;p&gt;.  But by mixing the compaction marker in as a component we now have a snapshot that implies that A and B were live but C and D were compacted, and if we take that snapshot as-is and promote it to live data, when we restart Cassandra will purge C and D since they were marked compacted.&lt;/p&gt;

&lt;p&gt;We could band-aid this in a number of ways but I think the less fragile approach is to treat the compaction marker as something separate from components.&lt;/p&gt;</comment>
                            <comment id="12931871" author="jbellis" created="Sun, 14 Nov 2010 19:33:34 +0000"  >&lt;p&gt;patch along the above lines&lt;/p&gt;</comment>
                            <comment id="12932140" author="stuhood" created="Mon, 15 Nov 2010 18:39:46 +0000"  >&lt;p&gt;This patch adds the isCompacted method, but it isn&apos;t called anywhere, which raises the question: who might call that method in the future, or care that an SSTable is compacted?&lt;/p&gt;

&lt;p&gt;Also, SSTable.delete() will fail if the SSTable is not marked compacted, for instance if the second branch of the &apos;if&apos; in CFStore is triggered.&lt;/p&gt;</comment>
                            <comment id="12932167" author="jbellis" created="Mon, 15 Nov 2010 19:49:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;This patch adds the isCompacted method, but it isn&apos;t called anywhere&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I will remove it.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;SSTable.delete() will fail if the SSTable is not marked compacted&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;If you&apos;re referring to &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            FileUtils.delete(desc.filenameFor(Component.COMPACTED_MARKER));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I changed that to not use deleteWithConfirm for exactly that reason.&lt;/p&gt;</comment>
                            <comment id="12933297" author="jbellis" created="Thu, 18 Nov 2010 02:37:08 +0000"  >&lt;p&gt;v2 removes boolean and replaces with assert that we&apos;re not instantiating a compacted SSTableReader&lt;/p&gt;</comment>
                            <comment id="12933873" author="gdusbabek" created="Fri, 19 Nov 2010 17:19:28 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12933947" author="hudson" created="Fri, 19 Nov 2010 20:05:42 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #19 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/19/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/19/&lt;/a&gt;)&lt;br/&gt;
    fix race between snapshot andcompaction&lt;br/&gt;
patch by jbellis; reviewed by gdusbabek for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1736&quot; title=&quot;ConcurrentModificationException when updating column family metadata&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1736&quot;&gt;&lt;del&gt;CASSANDRA-1736&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="12934090" author="hudson" created="Sat, 20 Nov 2010 03:12:00 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #22 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/22/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/22/&lt;/a&gt;)&lt;br/&gt;
    avoid attempting to delete compacted sstables twice on restart&lt;br/&gt;
patch by jbellis to fix regression introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-1736&quot; title=&quot;ConcurrentModificationException when updating column family metadata&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-1736&quot;&gt;&lt;del&gt;CASSANDRA-1736&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12459872" name="1736-v2.txt" size="8186" author="jbellis" created="Thu, 18 Nov 2010 02:41:43 +0000"/>
                            <attachment id="12459568" name="1736.txt" size="8906" author="jbellis" created="Sun, 14 Nov 2010 19:33:33 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20282</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 1 week, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g72n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>92576</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>gdusbabek</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[gdusbabek]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>