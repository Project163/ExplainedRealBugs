<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:12:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-778] Gossiper thread deadlock</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-778</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Found this while attempting to bootstrap a node with more than a trivial amount of data:&lt;/p&gt;

&lt;p&gt;Found one Java-level deadlock:&lt;br/&gt;
=============================&lt;br/&gt;
&quot;GMFD:1&quot;:&lt;br/&gt;
  waiting to lock monitor 0x0000000100861d60 (object 0x00000001066a7ed8, a org.apache.cassandra.service.StorageService),&lt;br/&gt;
  which is held by &quot;main&quot;&lt;br/&gt;
&quot;main&quot;:&lt;br/&gt;
  waiting to lock monitor 0x0000000100860710 (object 0x0000000106c7c968, a org.apache.cassandra.gms.Gossiper),&lt;br/&gt;
  which is held by &quot;GMFD:1&quot;&lt;/p&gt;

&lt;p&gt;Java stack information for the threads listed above:&lt;br/&gt;
===================================================&lt;br/&gt;
&quot;GMFD:1&quot;:&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.getReplicationStrategy(StorageService.java:226)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x00000001066a7ed8&amp;gt; (a org.apache.cassandra.service.StorageService)&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.calculatePendingRanges(StorageService.java:634)&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.handleStateNormal(StorageService.java:502)&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.onChange(StorageService.java:445)&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.onJoin(StorageService.java:812)&lt;br/&gt;
	at org.apache.cassandra.gms.Gossiper.handleMajorStateChange(Gossiper.java:607)&lt;br/&gt;
	at org.apache.cassandra.gms.Gossiper.handleNewJoin(Gossiper.java:582)&lt;br/&gt;
	at org.apache.cassandra.gms.Gossiper.applyStateLocally(Gossiper.java:649)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x0000000106c7c968&amp;gt; (a org.apache.cassandra.gms.Gossiper)&lt;br/&gt;
	at org.apache.cassandra.gms.Gossiper$GossipDigestAck2VerbHandler.doVerb(Gossiper.java:1061)&lt;br/&gt;
	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:40)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
	at java.lang.Thread.run(Thread.java:637)&lt;br/&gt;
&quot;main&quot;:&lt;br/&gt;
	at org.apache.cassandra.gms.Gossiper.addLocalApplicationState(Gossiper.java:861)&lt;/li&gt;
	&lt;li&gt;waiting to lock &amp;lt;0x0000000106c7c968&amp;gt; (a org.apache.cassandra.gms.Gossiper)&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.startBootstrap(StorageService.java:347)&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:318)&lt;/li&gt;
	&lt;li&gt;locked &amp;lt;0x00000001066a7ed8&amp;gt; (a org.apache.cassandra.service.StorageService)&lt;br/&gt;
	at org.apache.cassandra.thrift.CassandraDaemon.setup(CassandraDaemon.java:99)&lt;br/&gt;
	at org.apache.cassandra.thrift.CassandraDaemon.main(CassandraDaemon.java:174)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Found 1 deadlock.&lt;/p&gt;

&lt;p&gt;main acquires SS lock and doesn&apos;t release it before attempting to acquire the Gossiper lock.  Meanwhile, the gossip stage acquires the Gossiper lock and then attempts to acquire the SS lock.&lt;/p&gt;

&lt;p&gt;Solution is to have finer-grained locking on the resource in SS (map of replication strategies), or to move the collection to a different class (DD maybe?).  This was introduced in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-620&quot; title=&quot;Add per-keyspace replication factor (possibly even replication strategy)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-620&quot;&gt;&lt;del&gt;CASSANDRA-620&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12455667">CASSANDRA-778</key>
            <summary>Gossiper thread deadlock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gdusbabek">Gary Dusbabek</assignee>
                                    <reporter username="gdusbabek">Gary Dusbabek</reporter>
                        <labels>
                    </labels>
                <created>Mon, 8 Feb 2010 18:49:05 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:28 +0000</updated>
                            <resolved>Mon, 8 Feb 2010 19:39:22 +0000</resolved>
                                        <fixVersion>0.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12831038" author="gdusbabek" created="Mon, 8 Feb 2010 18:50:10 +0000"  >&lt;p&gt;introduce a fine-grained lock around SS.replicationStrategies.&lt;/p&gt;</comment>
                            <comment id="12831041" author="jbellis" created="Mon, 8 Feb 2010 18:56:20 +0000"  >&lt;p&gt;Can we get rid of the manual locking entirely instead?  ISTM that either (a) instantiating all RS in the SS constructor or (b) using NBHM and the ConcurrentMap apis (putIfAbsent etc) would fix this.&lt;/p&gt;</comment>
                            <comment id="12831059" author="gdusbabek" created="Mon, 8 Feb 2010 19:18:44 +0000"  >&lt;p&gt;does away with manual locking.&lt;/p&gt;</comment>
                            <comment id="12831065" author="jbellis" created="Mon, 8 Feb 2010 19:23:54 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="12831077" author="gdusbabek" created="Mon, 8 Feb 2010 19:39:22 +0000"  >&lt;p&gt;r907771. &lt;/p&gt;

&lt;p&gt;Modified slightly so that it throws a RTE if a bogus table is given (to comply with unit tests).&lt;/p&gt;</comment>
                            <comment id="12834869" author="hudson" created="Wed, 17 Feb 2010 17:54:43 +0000"  >&lt;p&gt;Integrated in Cassandra #357 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/357/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/357/&lt;/a&gt;)&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12435196" name="0001-fix-deadlock.patch" size="3048" author="gdusbabek" created="Mon, 8 Feb 2010 19:18:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[gdusbabek]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19859</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            15 years, 40 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0g10n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91595</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>