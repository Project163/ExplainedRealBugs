<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:28:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3335] ThreadPoolExecutor creates threads as non-daemon and will block on shutdown by default</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3335</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This is most obviously visible in OptionalTasks which should not block shutdown, but often does.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12526280">CASSANDRA-3335</key>
            <summary>ThreadPoolExecutor creates threads as non-daemon and will block on shutdown by default</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="brandon.williams">Brandon Williams</reporter>
                        <labels>
                    </labels>
                <created>Fri, 7 Oct 2011 21:40:31 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:48 +0000</updated>
                            <resolved>Tue, 20 Dec 2011 20:41:22 +0000</resolved>
                                        <fixVersion>1.0.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13123248" author="jbellis" created="Fri, 7 Oct 2011 22:00:09 +0000"  >&lt;p&gt;Patch that switches DTPE to daemon threads, and Memtable&apos;s jamm TPE to DTPE. The only other direct use of TPE is the thrift handler for sync mode in ACD, which doesn&apos;t seem to have a problem killing things off when we ask it to so I left it alone.&lt;/p&gt;</comment>
                            <comment id="13124374" author="brandon.williams" created="Mon, 10 Oct 2011 18:33:16 +0000"  >&lt;p&gt;+1 on this patch for being technically correct, but it actually does not help.  What I see is OptionalTasks jump to 100% on control-c, and then eventually it spins down and a few minutes later java finally exits.  During the last bit, I can see jamm still working.  I&apos;m not sure why java is taking so long to exit, but it is responsive to nodetool the entire time, though tpstats shows nothing active.&lt;/p&gt;</comment>
                            <comment id="13127924" author="jbellis" created="Fri, 14 Oct 2011 22:31:58 +0000"  >&lt;p&gt;v2 adds a log line before running any scheduled task. Maybe that will help pinpoint the culprit.&lt;/p&gt;</comment>
                            <comment id="13127926" author="jbellis" created="Fri, 14 Oct 2011 22:32:27 +0000"  >&lt;p&gt;(all the task logging is done w/ the StorageService logger so it can be enabled separately from the reset of the package involved)&lt;/p&gt;</comment>
                            <comment id="13161235" author="brandon.williams" created="Thu, 1 Dec 2011 22:07:19 +0000"  >&lt;p&gt;Tracked down to the shutdown hook:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;   java.lang.Thread.State: TIMED_WAITING (sleeping)
    at java.lang.Thread.sleep(Native Method)
    at org.apache.cassandra.utils.ExpiringMap.shutdown(ExpiringMap.java:103)
    at org.apache.cassandra.net.MessagingService.shutdown(MessagingService.java:495)
    at org.apache.cassandra.service.StorageService$2.runMayThrow(StorageService.java:426)
    at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)
    at java.lang.Thread.run(Thread.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Appears to be the ExpiringMap added in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2034&quot; title=&quot;Make Read Repair unnecessary when Hinted Handoff is enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2034&quot;&gt;&lt;del&gt;CASSANDRA-2034&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13166954" author="jbellis" created="Sat, 10 Dec 2011 19:28:23 +0000"  >&lt;p&gt;Patch to stop adding new messages to the callback map when MessagingService is shutdown.&lt;/p&gt;</comment>
                            <comment id="13167707" author="brandon.williams" created="Mon, 12 Dec 2011 19:41:13 +0000"  >&lt;p&gt;Doesn&apos;t seem to help.  Thread dump attached.&lt;/p&gt;</comment>
                            <comment id="13170769" author="jbellis" created="Fri, 16 Dec 2011 04:47:59 +0000"  >&lt;p&gt;Okay, take four here.  The problem with v3 is that we were only blocking sendOneWay during shutdown, not addCallback, which is the source of the ExpiringMap entries we were waiting for.&lt;/p&gt;

&lt;p&gt;As I commented,&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    /**
     * There isn&apos;t a good way to shut down the MessagingService. One problem (but not the only one)
     * is that StorageProxy has no way to communicate back to clients, &quot;I&apos;m nominally alive, but I can&apos;t
     * send that request to the nodes with your data.&quot;  Neither TimedOut nor Unavailable is appropriate
     * to return in that situation.
     *
     * So instead of shutting down MS and letting StorageProxy/clients cope somehow, we shut down
     * the Thrift service and then wait for all the outstanding requests to finish or timeout.
     */
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That part was straightforward.  I also had to make the Thrift shutdown actually work &amp;#8211; we were calling setSoTimeout to attempt to make accept() nonblocking, but &quot;0&quot; means &quot;wait indefinitely&quot; not &quot;don&apos;t wait at all&quot;.  Then we needed to handle the timeout in the accept loop.&lt;/p&gt;

&lt;p&gt;Finally, I did a bunch of cleanup to ExpiringMap and added trace-level logging in case we need to go at this &lt;b&gt;again&lt;/b&gt;.&lt;/p&gt;

</comment>
                            <comment id="13173417" author="brandon.williams" created="Tue, 20 Dec 2011 18:56:45 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13173491" author="jbellis" created="Tue, 20 Dec 2011 20:41:22 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12499105" name="3335-v2.txt" size="15216" author="jbellis" created="Fri, 14 Oct 2011 22:31:58 +0000"/>
                            <attachment id="12506864" name="3335-v3.txt" size="1331" author="jbellis" created="Sat, 10 Dec 2011 19:29:21 +0000"/>
                            <attachment id="12507648" name="3335-v4.txt" size="13499" author="jbellis" created="Fri, 16 Dec 2011 04:47:59 +0000"/>
                            <attachment id="12498247" name="3335.txt" size="2721" author="jbellis" created="Fri, 7 Oct 2011 22:00:09 +0000"/>
                            <attachment id="12507042" name="3335v3_jstack.txt" size="270238" author="brandon.williams" created="Mon, 12 Dec 2011 19:41:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>50529</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 49 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ginb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94451</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>