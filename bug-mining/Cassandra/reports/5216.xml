<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:13:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15172] LegacyLayout RangeTombstoneList throws IndexOutOfBoundsException</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15172</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Hi All,&lt;/p&gt;

&lt;p&gt;This is the first time I open an issue, so apologies if I&apos;m not following the rules properly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;After upgrading a node from version 2.1.21 to 3.11.4, we&apos;ve started seeing a lot of AbstractLocalAwareExecutorService exceptions. This happened right after the node successfully started up with the new 3.11.4 binaries. &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO&#160; [main] 2019-06-05 04:41:37,730 Gossiper.java:1715 - No gossip backlog; proceeding
INFO&#160; [main] 2019-06-05 04:41:38,036 NativeTransportService.java:70 - Netty using native Epoll event loop
INFO&#160; [main] 2019-06-05 04:41:38,117 Server.java:155 - Using Netty Version: [netty-buffer=netty-buffer-4.0.44.Final.452812a, netty-codec=netty-codec-4.0.44.Final.452812a, netty-codec-haproxy=netty-codec-haproxy-4.0.44.Final.452812a, netty-codec-http=netty-codec-http-4.0.44.Final.452812a, netty-codec-socks=netty-codec-socks-4.0.44.Final.452812a, netty-common=netty-common-4.0.44.Final.452812a, netty-handler=netty-handler-4.0.44.Final.452812a, netty-tcnative=netty-tcnative-1.1.33.Fork26.142ecbb, netty-transport=netty-transport-4.0.44.Final.452812a, netty-transport-native-epoll=netty-transport-native-epoll-4.0.44.Final.452812a, netty-transport-rxtx=netty-transport-rxtx-4.0.44.Final.452812a, netty-transport-sctp=netty-transport-sctp-4.0.44.Final.452812a, netty-transport-udt=netty-transport-udt-4.0.44.Final.452812a]
INFO&#160; [main] 2019-06-05 04:41:38,118 Server.java:156 - Starting listening for CQL clients on /0.0.0.0:9042 (unencrypted)...
INFO&#160; [main] 2019-06-05 04:41:38,179 CassandraDaemon.java:556 - Not starting RPC server as requested. Use JMX (StorageService-&amp;gt;startRPCServer()) or nodetool (enablethrift) to start it
INFO&#160; [Native-Transport-Requests-21] 2019-06-05 04:41:39,145 AuthCache.java:161 - (Re)initializing PermissionsCache (validity period/update interval/max entries) (2000/2000/1000)
INFO&#160; [OptionalTasks:1] 2019-06-05 04:41:39,729 CassandraAuthorizer.java:409 - Converting legacy permissions data
INFO&#160; [HANDSHAKE-/10.10.10.8] 2019-06-05 04:41:39,808 OutboundTcpConnection.java:561 - Handshaking version with /10.10.10.8
INFO&#160; [HANDSHAKE-/10.10.10.9] 2019-06-05 04:41:39,808 OutboundTcpConnection.java:561 - Handshaking version with /10.10.10.9
INFO&#160; [HANDSHAKE-dc1_02/10.10.10.6] 2019-06-05 04:41:39,809 OutboundTcpConnection.java:561 - Handshaking version with dc1_02/10.10.10.6

WARN&#160; [ReadStage-2] 2019-06-05 04:41:39,857 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread[ReadStage-2,5,main]: {}
java.lang.ArrayIndexOutOfBoundsException: 1
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.db.AbstractBufferClusteringPrefix.get(AbstractBufferClusteringPrefix.java:55)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.db.LegacyLayout$LegacyRangeTombstoneList.serializedSizeCompound(LegacyLayout.java:2545)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.db.LegacyLayout$LegacyRangeTombstoneList.serializedSize(LegacyLayout.java:2522)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.db.LegacyLayout.serializedSizeAsLegacyPartition(LegacyLayout.java:565)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.db.ReadResponse$Serializer.serializedSize(ReadResponse.java:446)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.db.ReadResponse$Serializer.serializedSize(ReadResponse.java:352)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.net.MessageOut.payloadSize(MessageOut.java:171)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.net.OutboundTcpConnectionPool.getConnection(OutboundTcpConnectionPool.java:77)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.net.MessagingService.getConnection(MessagingService.java:802)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.net.MessagingService.sendOneWay(MessagingService.java:953)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.net.MessagingService.sendReply(MessagingService.java:929)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.db.ReadCommandVerbHandler.doVerb(ReadCommandVerbHandler.java:62)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:66)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:162)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:134)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:114)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.lang.Thread.run(Thread.java:745)
&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;After several of the above warnings, the following warning appeared as well:&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN&#160; [ReadStage-9] 2019-06-05 04:42:04,369 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread[ReadStage-9,5,main]: {}
java.lang.ArrayIndexOutOfBoundsException: null
WARN&#160; [ReadStage-11] 2019-06-05 04:42:04,381 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread[ReadStage-11,5,main]: {}
java.lang.ArrayIndexOutOfBoundsException: null
WARN&#160; [ReadStage-10] 2019-06-05 04:42:04,396 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread[ReadStage-10,5,main]: {}
java.lang.ArrayIndexOutOfBoundsException: null
WARN&#160; [ReadStage-2] 2019-06-05 04:42:04,443 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread[ReadStage-2,5,main]: {}
java.lang.ArrayIndexOutOfBoundsException: null

&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Then suddenly, Validation errors appeared although &lt;b&gt;no repair was running on any of the nodes&lt;/b&gt;! Checked with &lt;tt&gt;ps -ef&lt;/tt&gt; command and &lt;tt&gt;nodetool compactionstats&lt;/tt&gt; on the entire cluster.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [ValidationExecutor:2] 2019-06-05 04:42:47,979 Validator.java:268 - Failed creating a merkle tree for [repair #e54b4090-876d-11e9-a3f4-c33d22c45471 on ks1/table1, []], /
10.10.10.6 (see log for details)
ERROR [ValidationExecutor:2] 2019-06-05 04:42:47,979 CassandraDaemon.java:228 - Exception in thread Thread[ValidationExecutor:2,1,main]
java.lang.NullPointerException: null
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.db.compaction.CompactionManager.doValidationCompaction(CompactionManager.java:1363)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.db.compaction.CompactionManager.access$600(CompactionManager.java:83)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.db.compaction.CompactionManager$13.call(CompactionManager.java:977)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.util.concurrent.FutureTask.run(FutureTask.java:266)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:81)
&#160;&#160;&#160;&#160;&#160;&#160;&#160; at java.lang.Thread.run(Thread.java:745)
&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Following those, client requests started to fail and NTR tasks started to pile up and get blocked and GC was impacted.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO&#160; [ScheduledTasks:1] 2019-06-05 04:43:11,660 StatusLogger.java:51 - Native-Transport-Requests&#160;&#160;&#160;&#160;&#160;&#160; 128&#160;&#160;&#160;&#160;&#160;&#160; 197&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 594810&#160;&#160;&#160;&#160;&#160;&#160;&#160; 65&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 2725
&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;FWIW, these are the warnings I found during startup: &lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;-WARN in net.logstash.logback.encoder.LogstashEncoder@140e5a13 - Logback version is prior to 1.2.0.&#160; Enabling backwards compatible encoding.&#160; Logback 1.2.1 or greater is recommended.
&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN&#160; [main] 2019-06-05 08:44:18,568 NativeLibrary.java:187 - Unable to lock JVM memory (ENOMEM). This can result in part of the JVM being swapped out, especially with mmapped I/O enabled. Increase RLIMIT_MEMLOCK or run Cassandra as root.
WARN&#160; [main] 2019-06-05 08:44:18,569 StartupChecks.java:136 - jemalloc shared library could not be preloaded to speed up memory allocations

&#160;

WARN&#160; [main] 2019-06-05 08:44:20,225 Optional.java:159 - Legacy auth tables credentials, users, permissions in keyspace system_auth still exist and have not been properly migrated.

WARN&#160; [MessagingService-Outgoing-dc1_03/10.10.10.4-Gossip] 2019-06-05 08:44:49,582 OutboundTcpConnection.java:486 - Seed gossip version is 8; will not connect with that version
WARN&#160; [MessagingService-Outgoing-dc2_02/10.20.20.4-Gossip] 2019-06-05 08:44:49,620 OutboundTcpConnection.java:486 - Seed gossip version is 8; will not connect with that version
WARN&#160; [MessagingService-Outgoing-dc2_01/10.20.20.1-Gossip] 2019-06-05 08:44:49,621 OutboundTcpConnection.java:486 - Seed gossip version is 8; will not connect with that version
WARN&#160; [MessagingService-Outgoing-dc2_03/10.20.20.5-Gossip] 2019-06-05 08:44:49,621 OutboundTcpConnection.java:486 - Seed gossip version is 8; will not connect with that version
WARN&#160; [GossipTasks:1] 2019-06-05 08:44:51,631 FailureDetector.java:278 - Not marking nodes down due to local pause of 30943606906 &amp;gt; 5000000000
&#160;&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;We&apos;ve naturally stopped the upgrade but we still wish to upgrade from 2.1.21 and hopefully find the root cause of this matter. &lt;br/&gt;
I&apos;ll be happy to provide additional details if needs be.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13240381">CASSANDRA-15172</key>
            <summary>LegacyLayout RangeTombstoneList throws IndexOutOfBoundsException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="Sagges">Shalom</reporter>
                        <labels>
                    </labels>
                <created>Wed, 19 Jun 2019 09:32:37 +0000</created>
                <updated>Fri, 4 Oct 2019 16:20:07 +0000</updated>
                            <resolved>Thu, 22 Aug 2019 11:50:27 +0000</resolved>
                                        <fixVersion>3.0.19</fixVersion>
                    <fixVersion>3.11.5</fixVersion>
                                    <component>Local/Other</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16888040" author="sagges" created="Thu, 18 Jul 2019 14:46:36 +0000"  >&lt;p&gt;Trying to push this up a bit because I still want to upgrade to 3.11.4 but I fear that this issue may recur.&lt;/p&gt;

&lt;p&gt;If someone has any idea on what happened here or how to mitigate it, that&apos;d be awesome!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16900581" author="ferozshaik552@gmail.com" created="Tue, 6 Aug 2019 03:35:37 +0000"  >&lt;p&gt;We have also hit this problem today while upgrading from 2.1.16 to 3.11.4/&#160;&lt;/p&gt;

&lt;p&gt;we encountered this as soon as node started up with 3.11.4&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-4&amp;#93;&lt;/span&gt; 2019-08-06 02:57:57,408 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-4,5,main&amp;#93;&lt;/span&gt;: {}&lt;br/&gt;
java.lang.NullPointerException: null&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-32&amp;#93;&lt;/span&gt; 2019-08-06 02:14:20,353 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;/p&gt;

&lt;p&gt;and the below errors continued in the logfile as long as the process was up.&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-12&amp;#93;&lt;/span&gt; 2019-08-06 03:00:47,135 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-8&amp;#93;&lt;/span&gt; 2019-08-06 03:00:48,778 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-13&amp;#93;&lt;/span&gt; 2019-08-06 03:00:57,454 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-11&amp;#93;&lt;/span&gt; 2019-08-06 03:00:57,482 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-2&amp;#93;&lt;/span&gt; 2019-08-06 03:00:58,543 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-8&amp;#93;&lt;/span&gt; 2019-08-06 03:00:58,899 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-17&amp;#93;&lt;/span&gt; 2019-08-06 03:00:59,074 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-12&amp;#93;&lt;/span&gt; 2019-08-06 03:01:08,123 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-17&amp;#93;&lt;/span&gt; 2019-08-06 03:01:19,055 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-4&amp;#93;&lt;/span&gt; 2019-08-06 03:01:20,880 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-13&amp;#93;&lt;/span&gt; 2019-08-06 03:01:29,983 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-13,5,main&amp;#93;&lt;/span&gt;: {}&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-2&amp;#93;&lt;/span&gt; 2019-08-06 03:01:31,119 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-6&amp;#93;&lt;/span&gt; 2019-08-06 03:01:46,262 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-15&amp;#93;&lt;/span&gt; 2019-08-06 03:01:46,520 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-2&amp;#93;&lt;/span&gt; 2019-08-06 03:01:48,842 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-2,5,main&amp;#93;&lt;/span&gt;: {}&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-1&amp;#93;&lt;/span&gt; 2019-08-06 03:01:50,351 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-5&amp;#93;&lt;/span&gt; 2019-08-06 03:02:06,061 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-8&amp;#93;&lt;/span&gt; 2019-08-06 03:02:07,616 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-8,5,main&amp;#93;&lt;/span&gt;: {}&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-17&amp;#93;&lt;/span&gt; 2019-08-06 03:02:08,384 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;br/&gt;
 ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;Native-Transport-Requests-5&amp;#93;&lt;/span&gt; 2019-08-06 03:02:10,244 ErrorMessage.java:384 - Unexpected exception during request&lt;br/&gt;
 java.lang.NullPointerException: null&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;The nodetool version says 3.11.4 and the no of connections on 9042 was similar to other nodes. The exceptions were scary that we had to call off the change. Any help and insights to this problem from the community is appreciated.&lt;/p&gt;</comment>
                            <comment id="16900876" author="ferozshaik552@gmail.com" created="Tue, 6 Aug 2019 10:41:02 +0000"  >&lt;p&gt;Full stack trace is as below:&lt;/p&gt;

&lt;p&gt;WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-4&amp;#93;&lt;/span&gt; 2019-08-06 02:57:57,408 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-4,5,main&amp;#93;&lt;/span&gt;: {}&lt;br/&gt;
java.lang.NullPointerException: null&lt;br/&gt;
 at org.apache.cassandra.db.LegacyLayout$LegacyRangeTombstoneList.updateDigest(LegacyLayout.java:2433) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.4.jar:3.11.4&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cassandra.db.LegacyLayout$LegacyUnfilteredPartition.digest(LegacyLayout.java:1479) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.4.jar:3.11.4&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cassandra.db.rows.UnfilteredRowIterators.digest(UnfilteredRowIterators.java:182) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.4.jar:3.11.4&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators.digest(UnfilteredPartitionIterators.java:263) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.4.jar:3.11.4&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cassandra.db.ReadResponse.makeDigest(ReadResponse.java:140) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.4.jar:3.11.4&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cassandra.db.ReadResponse.createDigestResponse(ReadResponse.java:87) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.4.jar:3.11.4&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:352) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.4.jar:3.11.4&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cassandra.db.ReadCommandVerbHandler.doVerb(ReadCommandVerbHandler.java:50) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.4.jar:3.11.4&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:66) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.4.jar:3.11.4&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_131&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:162) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.4.jar:3.11.4&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:134) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.4.jar:3.11.4&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:114) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-3.11.4.jar:3.11.4&amp;#93;&lt;/span&gt;&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:748) &lt;span class=&quot;error&quot;&gt;&amp;#91;na:1.8.0_131&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16900879" author="ferozshaik552@gmail.com" created="Tue, 6 Aug 2019 10:42:57 +0000"  >&lt;p&gt;What we also know is that the nodes suffered some heavy tombstones recently.. could it be under specific condition like &quot;tombstones&quot; plus reading legacy version files is hitting this problem. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Sagges&quot; class=&quot;user-hover&quot; rel=&quot;Sagges&quot;&gt;Sagges&lt;/a&gt; did you cluster have any tombstone references at all?&lt;/p&gt;</comment>
                            <comment id="16900882" author="ferozshaik552@gmail.com" created="Tue, 6 Aug 2019 10:45:24 +0000"  >&lt;p&gt;We have currently isolated this node (cut off thrift , native protocols) and trying to run upgradesstables to see if it can re-write all the files and stop logging the below message.&lt;/p&gt;

&lt;p&gt;&quot;WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-6&amp;#93;&lt;/span&gt; 2019-08-06 10:44:09,773 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-6,5,main&amp;#93;&lt;/span&gt;: {}&lt;br/&gt;
java.lang.NullPointerException: null&quot;&lt;/p&gt;

&lt;p&gt;I will keep the thread posted about its outcome,&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16901010" author="benedict" created="Tue, 6 Aug 2019 12:58:00 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Sagges&quot; class=&quot;user-hover&quot; rel=&quot;Sagges&quot;&gt;Sagges&lt;/a&gt;, sorry for the slow response - I missed the original filing of this ticket.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ferozshaik552%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;ferozshaik552@gmail.com&quot;&gt;ferozshaik552@gmail.com&lt;/a&gt; it looks like your bug, while very similar, presents differently.  It would be great if you could file a separate ticket.&lt;/p&gt;

&lt;p&gt;Both of these look to be among the category of 2.1-&amp;gt;3.0 upgrade bugs involving range deletions.  To best investigate and diagnose, it would be great to start with information about the affected schema, the kinds of range tombstone deletes you perform, and preferably if you could pin down sstables that are affected and upload them somewhere private for us to access.  This would help us investigate much more readily.&lt;/p&gt;

&lt;p&gt;Could you also confirm if you utilise thrift, or CQL schema?  It&apos;s possible this is a compatibility issue specific to thrift.&lt;/p&gt;</comment>
                            <comment id="16901049" author="ferozshaik552@gmail.com" created="Tue, 6 Aug 2019 13:25:26 +0000"  >&lt;p&gt;Sure, I shall raise a separate request.&lt;/p&gt;</comment>
                            <comment id="16905215" author="benedict" created="Mon, 12 Aug 2019 13:50:06 +0000"  >&lt;p&gt;This bug appears to be similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15263&quot; title=&quot;LegacyLayout RangeTombstoneList throws java.lang.NullPointerException: null&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15263&quot;&gt;CASSANDRA-15263&lt;/a&gt;, in that a reverse query with the RTBoundCloser is the likely source of asymmetric range tombstone bounds.  However in this case the problem is much easier to solve; we simply have to not assume the bounds have the same length.&lt;/p&gt;

&lt;p&gt;I have pushed a patch &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/15172-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16912357" author="michaelsembwever" created="Wed, 21 Aug 2019 14:45:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;, we&apos;ve seen this in the wild as well, with an upgrade from 2.2.14 to 3.11.4.&lt;br/&gt;
 I am jumping in to test and review it.&lt;/p&gt;</comment>
                            <comment id="16912704" author="michaelsembwever" created="Wed, 21 Aug 2019 21:44:11 +0000"  >
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;circleci&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;asf jenkins testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;asf jenkins dtests&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...belliottsmith:15172-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;15172-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/belliottsmith/workflows/cassandra/tree/15172-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circleci&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-testall/44/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-testall/44//badge/icon&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/679&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/679//badge/icon&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;

</comment>
                            <comment id="16913254" author="michaelsembwever" created="Thu, 22 Aug 2019 11:50:27 +0000"  >&lt;p&gt;Committed as 2b10a5f2b5e62f2900119a37e91637916e8b23df&lt;/p&gt;</comment>
                            <comment id="16915197" author="sagges" created="Sun, 25 Aug 2019 09:02:22 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Sorry for the late reply...&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Could you also confirm if you utilise thrift, or CQL schema? It&apos;s possible this is a compatibility issue specific to thrift.&lt;/p&gt;

&lt;p&gt;I do see there are a few thrift counter tables that were created with the WITH COMPACT STORAGE attribute.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I also see that &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ferozshaik552%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;ferozshaik552@gmail.com&quot;&gt;ferozshaik552@gmail.com&lt;/a&gt; had seen WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-4&amp;#93;&lt;/span&gt; 2019-08-06 02:57:57,408 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-4,5,main&amp;#93;&lt;/span&gt;: {}&lt;br/&gt;
 java.lang.NullPointerException: null&lt;/p&gt;



&lt;p&gt;What I mainly saw was AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-9,5,main&amp;#93;&lt;/span&gt;: {}&lt;br/&gt;
java.lang.ArrayIndexOutOfBoundsException: null&lt;/p&gt;

&lt;p&gt;Does the fix fit the same scenario as Feroz&apos;s? Could my issue be thrift related?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Sorry again for the late reply.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16916910" author="sagges" created="Tue, 27 Aug 2019 17:40:05 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; ,&lt;/p&gt;

&lt;p&gt;I&apos;m not sure if my comments/tickets are somehow not getting filed, but I hope not &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Is the above error (previous comment) related to this bug or is it a different one?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;</comment>
                            <comment id="16916921" author="michaelsembwever" created="Tue, 27 Aug 2019 17:50:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Sagges&quot; class=&quot;user-hover&quot; rel=&quot;Sagges&quot;&gt;Sagges&lt;/a&gt;,&lt;/p&gt;

&lt;p&gt; this bug comes from existing thrift (legacy) tables, where range tombstones were used. &lt;/p&gt;

&lt;p&gt;The NPE &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ferozshaik552%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;ferozshaik552@gmail.com&quot;&gt;ferozshaik552@gmail.com&lt;/a&gt; reported is a separate bug, despite it also being coming from legacy thrift tables with range tombstones. Unfortunately though, the fix for this ticket will not solve the NPE bug. &lt;/p&gt;</comment>
                            <comment id="16916953" author="sagges" created="Tue, 27 Aug 2019 17:56:09 +0000"  >&lt;p&gt;Thanks for clarifying &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mck&quot; class=&quot;user-hover&quot; rel=&quot;mck&quot;&gt;mck&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="16916995" author="benedict" created="Tue, 27 Aug 2019 18:47:37 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Sagges&quot; class=&quot;user-hover&quot; rel=&quot;Sagges&quot;&gt;Sagges&lt;/a&gt;, I&apos;m afraid I was on holiday so was unable to respond, and am now otherwise engaged for the next few weeks, but &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mck&quot; class=&quot;user-hover&quot; rel=&quot;mck&quot;&gt;mck&lt;/a&gt; is mostly correct.  However, to clarify, the likely cause of this bug that I have established is not related to thrift or legacy tables (though atypical range tombstone use with thrift could cause it), but to communication from a 3.0 node to a 2.2 or 2.1 node, in the face of range tombstones that cover a primary key prefix.&lt;/p&gt;

&lt;p&gt;That is to say, a schema of the form (pk, c1, c2, v), with a deletion on (pk, c1)&lt;/p&gt;</comment>
                            <comment id="16918545" author="sagges" created="Thu, 29 Aug 2019 12:04:08 +0000"  >&lt;p&gt;Thanks a lot for further clarifying &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;. (I hope you enjoyed your vacation &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; )&lt;/p&gt;

&lt;p&gt;Just to set my mind straight, the issue is when there are mixed versions in the cluster, so if I upgraded all binaries to 3.11, it won&apos;t recur even if I haven&apos;t upgraded the SSTables yet. Is my assumption correct?&lt;/p&gt;</comment>
                            <comment id="16936164" author="sagges" created="Mon, 23 Sep 2019 20:23:35 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I tried the patch. It didn&apos;t do the trick, however, I was able to fully reproduce the bug.&lt;/p&gt;

&lt;p&gt;tl;dr&lt;/p&gt;

&lt;p&gt;The bug does occur when running queries on range tombstones, but on top of that, those queries have to specifically be range queries.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;*+Steps to Reproduce:&lt;br/&gt;
+* &lt;/p&gt;

&lt;p&gt;CREATE KEYSPACE ks1 WITH replication = {&apos;class&apos;: &apos;NetworkTopologyStrategy&apos;, &apos;DC1&apos;: &apos;3&apos;} AND durable_writes = true;&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;&lt;b&gt;TABLE:&lt;/b&gt;&lt;/ins&gt; &lt;br/&gt;
CREATE TABLE ks1.table1 (&lt;br/&gt;
 col1 text,&lt;br/&gt;
 col2 text,&lt;br/&gt;
 col3 text,&lt;br/&gt;
 col4 text,&lt;br/&gt;
 col5 text,&lt;br/&gt;
 col6 timestamp,&lt;br/&gt;
 data text,&lt;br/&gt;
 PRIMARY KEY ((col1, col2, col3), col4, col5, col6)&lt;br/&gt;
);&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Inserted ~4 million rows and created range tombstones by deleting ~1 million rows.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;&lt;b&gt;Create Data&lt;/b&gt;&lt;/ins&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;insert into ks1.table1 (col1, col2 , col3 , col4 , col5 , col6 , data ) VALUES ( &apos;1&apos;, &apos;11&apos;, &apos;21&apos;, &apos;1&apos;, &apos;a&apos;, 12312312300000, &apos;data&apos;);&lt;/em&gt;&lt;br/&gt;
&lt;em&gt;insert into ks1.table1 (col1, col2 , col3 , col4 , col5 , col6 , data ) VALUES ( &apos;1&apos;, &apos;11&apos;, &apos;21&apos;, &apos;2&apos;, &apos;a&apos;, 12312312300000, &apos;data&apos;);&lt;/em&gt;&lt;br/&gt;
&lt;em&gt;insert into ks1.table1 (col1, col2 , col3 , col4 , col5 , col6 , data ) VALUES ( &apos;1&apos;, &apos;11&apos;, &apos;21&apos;, &apos;3&apos;, &apos;a&apos;, 12312312300000, &apos;data&apos;);&lt;/em&gt;&lt;br/&gt;
&lt;em&gt;insert into ks1.table1 (col1, col2 , col3 , col4 , col5 , col6 , data ) VALUES ( &apos;1&apos;, &apos;11&apos;, &apos;21&apos;, &apos;4&apos;, &apos;a&apos;, 12312312300000, &apos;data&apos;);&lt;/em&gt;&lt;br/&gt;
&lt;em&gt;insert into ks1.table1 (col1, col2 , col3 , col4 , col5 , col6 , data ) VALUES ( &apos;1&apos;, &apos;11&apos;, &apos;21&apos;, &apos;5&apos;, &apos;a&apos;, 12312312300000, &apos;data&apos;);&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;&lt;b&gt;Create Range Tombstones&lt;/b&gt;&lt;/ins&gt;&lt;/p&gt;

&lt;p&gt;delete from ks1.table1 where col1=&apos;1&apos; and col2=&apos;11&apos; and col3=&apos;21&apos; and col4=&apos;1&apos;;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;&lt;b&gt;Query Live Rows (no tombstones)&lt;/b&gt;&lt;/ins&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;select * from ks1.table1 where col1=&apos;1&apos; and col2=&apos;201&apos; and col3=&apos;21&apos; and col4=&apos;1&apos; and col5=&apos;a&apos; and &lt;b&gt;col6&amp;gt;12312312300000&lt;/b&gt;;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;No issues found, everything is running properly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;&lt;b&gt;Query Range Tombstones&lt;/b&gt;&lt;/ins&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;select * from ks1.table1 where col1=&apos;1&apos; and col2=&apos;11&apos; and col3=&apos;21&apos; and col4=&apos;1&apos; and col5=&apos;a&apos; and &lt;b&gt;col6=12312312300000&lt;/b&gt;;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;No issues found, everything is running properly.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;ins&gt;BUT when running range queries:&lt;/ins&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;select * from ks1.table1 where col1=&apos;1&apos; and col2=&apos;11&apos; and col3=&apos;21&apos; and col4=&apos;1&apos; and col5=&apos;a&apos; and &lt;b&gt;col6&amp;gt;12312312200000;&lt;/b&gt;&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;WARN &lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-1&amp;#93;&lt;/span&gt; 2019-09-23 14:17:10,281 AbstractLocalAwareExecutorService.java:167 - Uncaught exception on thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;ReadStage-1,5,main&amp;#93;&lt;/span&gt;: {}&lt;br/&gt;
java.lang.ArrayIndexOutOfBoundsException: 2&lt;br/&gt;
 at org.apache.cassandra.db.AbstractBufferClusteringPrefix.get(AbstractBufferClusteringPrefix.java:55)&lt;br/&gt;
 at org.apache.cassandra.db.LegacyLayout$LegacyRangeTombstoneList.serializedSizeCompound(LegacyLayout.java:2545)&lt;br/&gt;
 at org.apache.cassandra.db.LegacyLayout$LegacyRangeTombstoneList.serializedSize(LegacyLayout.java:2522)&lt;br/&gt;
 at org.apache.cassandra.db.LegacyLayout.serializedSizeAsLegacyPartition(LegacyLayout.java:565)&lt;br/&gt;
 at org.apache.cassandra.db.ReadResponse$Serializer.serializedSize(ReadResponse.java:446)&lt;br/&gt;
 at org.apache.cassandra.db.ReadResponse$Serializer.serializedSize(ReadResponse.java:352)&lt;br/&gt;
 at org.apache.cassandra.net.MessageOut.payloadSize(MessageOut.java:171)&lt;br/&gt;
 at org.apache.cassandra.net.OutboundTcpConnectionPool.getConnection(OutboundTcpConnectionPool.java:77)&lt;br/&gt;
 at org.apache.cassandra.net.MessagingService.getConnection(MessagingService.java:802)&lt;br/&gt;
 at org.apache.cassandra.net.MessagingService.sendOneWay(MessagingService.java:953)&lt;br/&gt;
 at org.apache.cassandra.net.MessagingService.sendReply(MessagingService.java:929)&lt;br/&gt;
 at org.apache.cassandra.db.ReadCommandVerbHandler.doVerb(ReadCommandVerbHandler.java:62)&lt;br/&gt;
 at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:66)&lt;br/&gt;
 at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)&lt;br/&gt;
 at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$FutureTask.run(AbstractLocalAwareExecutorService.java:162)&lt;br/&gt;
 at org.apache.cassandra.concurrent.AbstractLocalAwareExecutorService$LocalSessionFutureTask.run(AbstractLocalAwareExecutorService.java:134)&lt;br/&gt;
 at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:114)&lt;br/&gt;
 at java.lang.Thread.run(Thread.java:745)&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;This WARN is constantly generated until I stop the range queries script.&lt;/p&gt;

&lt;p&gt;Hope this helps..&lt;/p&gt;

&lt;p&gt;Thanks!&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16937526" author="sagges" created="Wed, 25 Sep 2019 08:41:07 +0000"  >&lt;p&gt;For users that happen to stumble upon this use case too, I&apos;d like to emphasize that the bug occurs only during mixed versions.&lt;/p&gt;

&lt;p&gt;Once the cluster got fully upgraded (binaries only), the issue was gone.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="16937547" author="benedict" created="Wed, 25 Sep 2019 09:19:36 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Sagges&quot; class=&quot;user-hover&quot; rel=&quot;Sagges&quot;&gt;Sagges&lt;/a&gt;, I&apos;m on holiday (again!) but please file a new bug report for this and assign it to me so that I remember when I return, as it is presumably a different (but very similar) bug.&lt;/p&gt;</comment>
                            <comment id="16937903" author="sagges" created="Wed, 25 Sep 2019 16:39:47 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Done and assigned to you! &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15336&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-15336&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Enjoy your holiday. (the more the merrier) &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13249253">CASSANDRA-15263</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12991" cascade-level="1"><![CDATA[Response Crash]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 7 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z03w80:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mck]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332361">3.0 alpha 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/2b10a5f2b5e62f2900119a37e91637916e8b23df&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/2b10a5f2b5e62f2900119a37e91637916e8b23df&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;unit test included&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>