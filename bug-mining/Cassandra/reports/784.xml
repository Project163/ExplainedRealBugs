<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:20:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2349] Expring columns can expire between the two phase of LazilyCompactedRow.</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2349</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;LazilyCompactedRow reads the columns to compact twice. First to create the index, bloom filter and calculate the data size, and then another phase to actually write the columns. But a column can expire between those two phase, which will result in a bad data size in the sstable (and a possibly corrupted row index).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12501688">CASSANDRA-2349</key>
            <summary>Expring columns can expire between the two phase of LazilyCompactedRow.</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Thu, 17 Mar 2011 14:37:23 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:03 +0000</updated>
                            <resolved>Fri, 18 Mar 2011 04:31:51 +0000</resolved>
                                        <fixVersion>0.7.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="7200">2h</timeoriginalestimate>
                            <timeestimate seconds="7200">2h</timeestimate>
                                        <comments>
                            <comment id="13007932" author="slebresne" created="Thu, 17 Mar 2011 14:40:55 +0000"  >&lt;p&gt;This could be fixed by making LazilyCompactedRow do only one phase. We could write a place holder header, write the column, and seek back at the end to write the header. The tricky part is that this won&apos;t fit well with AbstractCompactedRow, since it is assume that the column count is known before write is called.&lt;/p&gt;</comment>
                            <comment id="13007945" author="slebresne" created="Thu, 17 Mar 2011 15:07:14 +0000"  >&lt;p&gt;Actually, this won&apos;t work because we cannot anticipate the index size.&lt;/p&gt;</comment>
                            <comment id="13007962" author="slebresne" created="Thu, 17 Mar 2011 15:56:25 +0000"  >&lt;p&gt;Attaching simpler solution consisting in not transforming expired columns into tombstones, so that the second phase of LazilyCompactedRow sees the same columns than the first phase.&lt;/p&gt;

&lt;p&gt;I would be happy to come up with a unit test for this, but this is a subtle race condition and I&apos;m really not sure how to write a test that capture it.&lt;/p&gt;</comment>
                            <comment id="13007971" author="jbellis" created="Thu, 17 Mar 2011 16:11:23 +0000"  >&lt;p&gt;don&apos;t we need forceKeepExpired for both passes or we have the opposite problem?  If so, would prefer fKE a constructor arg for the iterator instead of setter.&lt;/p&gt;</comment>
                            <comment id="13007972" author="jbellis" created="Thu, 17 Mar 2011 16:14:07 +0000"  >&lt;p&gt;Or: should we have an expireBefore parameter like gcBefore so it can stay constant during the compaction?&lt;/p&gt;</comment>
                            <comment id="13007982" author="slebresne" created="Thu, 17 Mar 2011 16:27:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;don&apos;t we need forceKeepExpired for both passes or we have the opposite problem? If so, would prefer fKE a constructor arg for the iterator instead of setter.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;There is no opposite problem, since you can&apos;t have a column expired for the first phase but not for the second one.&lt;/p&gt;

&lt;p&gt;Note that the point of transforming expired columns to tombstone is to re-gain quickly the disk space used by the column value (without having to wait for gcGrace). So using fKE in phase 1 would prevent that for LazilyCompactedRow, which would be a pity.&lt;/p&gt;</comment>
                            <comment id="13007992" author="jbellis" created="Thu, 17 Mar 2011 16:47:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;There is no opposite problem, since you can&apos;t have a column expired for the first phase but not for the second one.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But you can have an expired column counted as a tombstone for the first but not in the second since you have enabled forceKE.  No?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;the point of transforming expired columns to tombstone is to re-gain quickly the disk space used by the column value&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, which is why using a constant expireBefore value that we pass to the serializer instead of computing it locally each time seems like a better solution. &lt;/p&gt;</comment>
                            <comment id="13007999" author="slebresne" created="Thu, 17 Mar 2011 16:58:46 +0000"  >&lt;blockquote&gt;&lt;p&gt;But you can have an expired column counted as a tombstone for the first but not in the second since you have enabled forceKE. No?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You are right. Oups.&lt;/p&gt;

&lt;p&gt;You are right, having an expireBefore is a better solution. I&apos;ll work out the patch.&lt;/p&gt;</comment>
                            <comment id="13008019" author="slebresne" created="Thu, 17 Mar 2011 17:25:19 +0000"  >&lt;p&gt;Attached patch using the expireBefore idea.&lt;/p&gt;</comment>
                            <comment id="13008325" author="jbellis" created="Fri, 18 Mar 2011 04:31:51 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13009442" author="hudson" created="Mon, 21 Mar 2011 22:15:38 +0000"  >&lt;p&gt;Integrated in Cassandra-0.7 #397 (See &lt;a href=&quot;https://hudson.apache.org/hudson/job/Cassandra-0.7/397/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://hudson.apache.org/hudson/job/Cassandra-0.7/397/&lt;/a&gt;)&lt;/p&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12473924" name="0001-Introduce-expireBefore-and-keep-it-constant-all-thro.patch" size="13426" author="slebresne" created="Thu, 17 Mar 2011 17:25:19 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20572</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 36 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gav3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93190</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>