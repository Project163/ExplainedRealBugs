<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:27:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3520] Unit test are hanging on 0.8 branch</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3520</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;As the summary says, the unit test on current 0.8 are just hanging after CliTest (it&apos;s apparently not the case on windows, but it is on Linux and MacOSX).&lt;br/&gt;
Not sure what&apos;s going on, but what I can tell is that it&apos;s enough to run CliTest to have it hang after the test successfully pass (i.e, JUnit just wait indefinitely for the VM to exit). Even weirder, it seems that it is the counter increment in the CliTest that make it hang, if you comment those statement, it stop hanging. However, nothing seems to go wrong with the increment itself (the test passes) and it doesn&apos;t even trigger anything (typically sendToHintedEndpoint is not called because there is only one node).&lt;br/&gt;
Looking at the stack when the VM is hanging (attached), there is nothing specific to counters in there, and nothing that struck me at odd (but I could miss something). There do is a few thrift thread running (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3335&quot; title=&quot;ThreadPoolExecutor creates threads as non-daemon and will block on shutdown by default&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3335&quot;&gt;&lt;del&gt;CASSANDRA-3335&lt;/del&gt;&lt;/a&gt;), but why would that only be a problem for the tests in that situation is a mystery to me.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux&lt;/p&gt;</environment>
        <key id="12532289">CASSANDRA-3520</key>
            <summary>Unit test are hanging on 0.8 branch</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Nov 2011 08:42:24 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:45 +0000</updated>
                            <resolved>Mon, 28 Nov 2011 16:39:05 +0000</resolved>
                                        <fixVersion>0.8.8</fixVersion>
                                    <component>Legacy/Testing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13155148" author="jbellis" created="Tue, 22 Nov 2011 14:04:21 +0000"  >&lt;p&gt;Does it hang if you just run CliTest, or only for the whole suite?&lt;/p&gt;</comment>
                            <comment id="13155153" author="slebresne" created="Tue, 22 Nov 2011 14:08:44 +0000"  >&lt;p&gt;Only CliTest. I honestly didn&apos;t really try to run other tests (and CliTest is like the 3rd test), so possibly there is other tests failing.&lt;/p&gt;</comment>
                            <comment id="13155205" author="jbellis" created="Tue, 22 Nov 2011 15:34:17 +0000"  >&lt;p&gt;On Windows CliTest on 0.8 times out, after all the tests pass, but it does not hang.&lt;/p&gt;</comment>
                            <comment id="13155206" author="jbellis" created="Tue, 22 Nov 2011 15:34:59 +0000"  >&lt;p&gt;(My 0.8 checkout was on the 0.8.6 tag when I reported that CliTest worked completely.)&lt;/p&gt;</comment>
                            <comment id="13157190" author="slebresne" created="Fri, 25 Nov 2011 15:22:47 +0000"  >&lt;p&gt;So, some form of progress here. The hanging can be bisected to r1185961 (svn). And it is actually due to the switch to non-durable writes for the system keyspace. But I don&apos;t know why yet. In particular 1.0 and trunk also use non-durable writes and have no such problem.&lt;/p&gt;

&lt;p&gt;I&apos;m attaching a small patch to re-enable durable writes. I think we should figure out what is going on, but if we want to go ahead with the release of 0.8.8 in the meantime, we could apply that.&lt;/p&gt;

&lt;p&gt;Last info, CliTest is not the only one to hang, CleanupTest and AntiEntropyServiceCounterTest.java are also hanging.&lt;/p&gt;</comment>
                            <comment id="13157211" author="slebresne" created="Fri, 25 Nov 2011 15:56:15 +0000"  >&lt;p&gt;btw, how sure are we that using non-durable writes for the system keyspace is a good idea? It doesn&apos;t seem great for hints at least. Moreover on 1.0, when will the CF be flushed if durable_writes is false unless we do a manual flush?&lt;/p&gt;</comment>
                            <comment id="13157235" author="jbellis" created="Fri, 25 Nov 2011 16:54:11 +0000"  >&lt;p&gt;Setting durable_writes back to true does not fix CliTest timing out on windows.  However, I can&apos;t think a good reason to have it off for the system KS so I committed 0001.&lt;/p&gt;</comment>
                            <comment id="13157248" author="hudson" created="Fri, 25 Nov 2011 17:13:42 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #406 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/406/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/406/&lt;/a&gt;)&lt;br/&gt;
    set system keyspace back to durable_writes&lt;br/&gt;
patch by slebresne; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3520&quot; title=&quot;Unit test are hanging on 0.8 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3520&quot;&gt;&lt;del&gt;CASSANDRA-3520&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1206257&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1206257&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/config/KSMetaData.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13157263" author="jbellis" created="Fri, 25 Nov 2011 17:42:35 +0000"  >&lt;p&gt;I can confirm that r1185960 is the last revision that doesn&apos;t timeout CliTest.  (r1185961 doesn&apos;t compile, and r1185963 times out.)&lt;/p&gt;</comment>
                            <comment id="13158324" author="slebresne" created="Mon, 28 Nov 2011 09:50:45 +0000"  >&lt;p&gt;I was a bit fast at calling it victory. I was testing with CleanupTest that was hanging as well, and starting from the same revision, so I assumed that the problem was the exact same as for CliTest. Turns out setting durable writes does fix both CleanupTest and AntiEntropyServiceCounterTest, but CliTest is still hanging (it&apos;s now the only one to do so however).&lt;/p&gt;</comment>
                            <comment id="13158345" author="slebresne" created="Mon, 28 Nov 2011 11:13:39 +0000"  >&lt;p&gt;So, the whole problem is due to our handling of non durable writes in the shutdown hook. For those, we flush the CFS as part of shutdown. However, flush tries to grab a commitlog context, which blocks because the commit log has been shutdown &lt;b&gt;before&lt;/b&gt; all this (and for some reason, executor.submit() don&apos;t throw any exception if the executor is shutdown).&lt;/p&gt;

&lt;p&gt;The reason why r1185960 was triggering this is that it actually fixed a bug by which previously to this commit, adding a new column family to a keyspace would reset the durableWrites option to true, hence hiding the bug as far as CliTest is concerned.&lt;/p&gt;

&lt;p&gt;One simple solution is to move the commit log shutdown after the flushes of the non-durable CFs (which 1.0 does, and that&apos;s why it isn&apos;t affected). Truth is, it doesn&apos;t feel like the right fix in that non-durable CF shouldn&apos;t query the commit log at all, even during flushes. However, changing that introduces the possibility to have some CL segment retained forever when upgrading a keyspace from non-durable to durable if we&apos;re not careful. So overall just pushing the CL shutdown down in the shutdown hook to match 1.0 seems good enough, at least for 0.8. Attaching a patch to do just that. We can then look at making things cleaner with respect to flushing non-durable CFS in 1.0/trunk if we so wish.&lt;/p&gt;

&lt;p&gt;Note that while having a non-durable system keyspace was not directly the problem, I think it was a fairly bad idea, and we should leave it to durable for 0.8 and turn it back to durable for 1.0 and trunk.&lt;/p&gt;</comment>
                            <comment id="13158465" author="jbellis" created="Mon, 28 Nov 2011 14:28:07 +0000"  >&lt;p&gt;+1, but can we add a system test w/ a non-durable ks to help prevent regressions?&lt;/p&gt;

&lt;p&gt;Edit: never mind, that&apos;s what we&apos;re already doing in NoCommitlogSpace, hence the continuing clitest timeout&lt;/p&gt;</comment>
                            <comment id="13158506" author="hudson" created="Mon, 28 Nov 2011 15:21:06 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #407 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/407/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/407/&lt;/a&gt;)&lt;br/&gt;
    Shutdown CL after having flushed non-durable CF&lt;br/&gt;
patch by slebresne; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3520&quot; title=&quot;Unit test are hanging on 0.8 branch&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3520&quot;&gt;&lt;del&gt;CASSANDRA-3520&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;slebresne : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1207262&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1207262&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/service/StorageService.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13158545" author="slebresne" created="Mon, 28 Nov 2011 16:39:05 +0000"  >&lt;p&gt;Committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12505117" name="0001-Use-durable-writes-for-system-ks.patch" size="1252" author="slebresne" created="Fri, 25 Nov 2011 15:22:47 +0000"/>
                            <attachment id="12505320" name="3520.patch" size="1866" author="slebresne" created="Mon, 28 Nov 2011 11:13:39 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>218022</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gkx3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94819</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>