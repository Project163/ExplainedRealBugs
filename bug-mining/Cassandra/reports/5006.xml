<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:14 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14284] Chunk checksum test needs to occur before uncompress to avoid JVM crash</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14284</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;While checksums are (generally) performed on compressed data, the checksum test when reading is currently (in all variants of C* 2.x, 3.x I&apos;ve looked at) done &lt;span class=&quot;error&quot;&gt;&amp;#91;on the compressed data&amp;#93;&lt;/span&gt; only after the uncompress operation has completed.&#160;&lt;/p&gt;

&lt;p&gt;The issue here is that LZ4_decompress_fast (as documented in e.g.&#160;&lt;a href=&quot;https://github.com/lz4/lz4/blob/dev/lib/lz4.h#L214)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/lz4/lz4/blob/dev/lib/lz4.h#L214)&lt;/a&gt;&#160;can result in memory overruns when provided with malformed source data. This in turn can (and does, e.g. in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13757&quot; title=&quot;Cassandra 3.5.0 JVM Segfault Problem While Repair Job is Running&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13757&quot;&gt;&lt;del&gt;CASSANDRA-13757&lt;/del&gt;&lt;/a&gt;) lead to JVM crashes during the uncompress&#160;of corrupted chunks. The checksum operation would obviously detect the issue, but we&apos;d never get to it if the JVM crashes first.&lt;/p&gt;

&lt;p&gt;Moving the checksum test of the compressed data to before the uncompress operation (in cases where the checksum is done on compressed data) will resolve this issue.&lt;/p&gt;

&lt;p&gt;-----------------------------&lt;/p&gt;

&lt;p&gt;The check-only-after-doing-the-decompress logic appears to be in all current releases.&lt;/p&gt;

&lt;p&gt;Here are some samples at different evolution points :&lt;/p&gt;

&lt;p&gt;3.11.2:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11.2/src/java/org/apache/cassandra/io/util/CompressedChunkReader.java#L146&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.11.2/src/java/org/apache/cassandra/io/util/CompressedChunkReader.java#L146&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11.2/src/java/org/apache/cassandra/io/util/CompressedChunkReader.java#L207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.11.2/src/java/org/apache/cassandra/io/util/CompressedChunkReader.java#L207&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;3.5:&lt;/p&gt;

&lt;p&gt;&#160;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.5/src/java/org/apache/cassandra/io/compress/CompressedRandomAccessReader.java#L135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.5/src/java/org/apache/cassandra/io/compress/CompressedRandomAccessReader.java#L135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.5/src/java/org/apache/cassandra/io/compress/CompressedRandomAccessReader.java#L196&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.5/src/java/org/apache/cassandra/io/compress/CompressedRandomAccessReader.java#L196&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2.1.17:&lt;/p&gt;

&lt;p&gt;&#160;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.1.17/src/java/org/apache/cassandra/io/compress/CompressedRandomAccessReader.java#L122&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-2.1.17/src/java/org/apache/cassandra/io/compress/CompressedRandomAccessReader.java#L122&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;The check-only-after-doing-the-decompress logic appears to be in all current releases.&lt;/p&gt;

&lt;p&gt;Here are some samples at different evolution points :&lt;/p&gt;

&lt;p&gt;3.11.2:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11.2/src/java/org/apache/cassandra/io/util/CompressedChunkReader.java#L146&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.11.2/src/java/org/apache/cassandra/io/util/CompressedChunkReader.java#L146&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11.2/src/java/org/apache/cassandra/io/util/CompressedChunkReader.java#L207&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.11.2/src/java/org/apache/cassandra/io/util/CompressedChunkReader.java#L207&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;3.5:&lt;/p&gt;

&lt;p&gt;&#160;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.5/src/java/org/apache/cassandra/io/compress/CompressedRandomAccessReader.java#L135&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.5/src/java/org/apache/cassandra/io/compress/CompressedRandomAccessReader.java#L135&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.5/src/java/org/apache/cassandra/io/compress/CompressedRandomAccessReader.java#L196&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.5/src/java/org/apache/cassandra/io/compress/CompressedRandomAccessReader.java#L196&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;2.1.17:&lt;/p&gt;

&lt;p&gt;&#160;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.1.17/src/java/org/apache/cassandra/io/compress/CompressedRandomAccessReader.java#L122&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-2.1.17/src/java/org/apache/cassandra/io/compress/CompressedRandomAccessReader.java#L122&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</environment>
        <key id="13141910">CASSANDRA-14284</key>
            <summary>Chunk checksum test needs to occur before uncompress to avoid JVM crash</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="giltene">Gil Tene</reporter>
                        <labels>
                    </labels>
                <created>Thu, 1 Mar 2018 21:12:47 +0000</created>
                <updated>Fri, 15 May 2020 08:05:08 +0000</updated>
                            <resolved>Tue, 10 Apr 2018 12:15:56 +0000</resolved>
                                        <fixVersion>2.1.21</fixVersion>
                    <fixVersion>2.2.13</fixVersion>
                    <fixVersion>3.0.17</fixVersion>
                    <fixVersion>3.11.3</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16417289" author="blerer" created="Wed, 28 Mar 2018 12:50:25 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branches&lt;/th&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...blerer:14284-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...blerer:14284-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.2&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...blerer:14284-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...blerer:14284-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:14284-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;I ran the unit tests and the dtests on our internal CI and the failing tests seems unrelated.&lt;/p&gt;</comment>
                            <comment id="16417327" author="blambov" created="Wed, 28 Mar 2018 13:29:56 +0000"  >&lt;p&gt;The patches before 3.11 look good, but I&apos;m not very happy with the separate buffer for the checksum in 3.11+. In fact, since we are doing the checksum immediately after the read now, why not include the checksum read with the compressed content? I.e.&#160;reserve four extra bytes at the end of the buffer, choose if checksum will be done before the read and adjust&#160;its length if so, then proceed&#160;like in the memmapped case.&lt;/p&gt;

&lt;p&gt;Alternatively, you could use the first bytes of the uncompressed buffer.&lt;/p&gt;

&lt;p&gt;The trunk patch seems to contain at least one odd character&#160;and the diff isn&apos;t displayed properly. Could you fix the line endings and upload it again?&lt;/p&gt;</comment>
                            <comment id="16417573" author="giltene" created="Wed, 28 Mar 2018 15:40:23 +0000"  >&lt;p&gt;The patch for 2.1 has an issue, I think: 2.1 (unlike the later versions) seems to support checksumming o&#160;either the compressed or uncompressed data (depending on what metadata.hasPostCompressionAdlerChecksums indicates). Only the checksum test of the compressed data can be moved to before the uncompress. The checksum in the uncompressed case has to remain after the uncompress.&lt;/p&gt;</comment>
                            <comment id="16418943" author="blerer" created="Thu, 29 Mar 2018 12:55:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=giltene&quot; class=&quot;user-hover&quot; rel=&quot;giltene&quot;&gt;giltene&lt;/a&gt; Thanks for the reviews. I completely missed the pre-compression checksum logic in 2.1.&lt;/p&gt;

&lt;p&gt;I force pushed some new patches for &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...blerer:14284-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1&lt;/a&gt; , &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...blerer:14284-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.1&lt;/a&gt;, and &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:14284-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; that address the different problems.&lt;/p&gt;</comment>
                            <comment id="16418973" author="blambov" created="Thu, 29 Mar 2018 13:13:18 +0000"  >&lt;p&gt;Shouldn&apos;t&#160;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...blerer:14284-2.1#diff-67366d25fce65930f46564d6ea8e0f40R139&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt;&#160;be using &lt;tt&gt;bytes&lt;/tt&gt; instead of &lt;tt&gt;compressed.array()&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="16419094" author="blambov" created="Thu, 29 Mar 2018 14:34:19 +0000"  >&lt;p&gt;The rest looks fine with one nit, which you can feel free to ignore:&#160;you could now extract the crc checking logic to a common method&#160;for the normal and memmapped case (in trunk, the normal+uncompressed case has to remain separate, though).&lt;/p&gt;</comment>
                            <comment id="16432172" author="blerer" created="Tue, 10 Apr 2018 12:15:56 +0000"  >&lt;p&gt;Committed into 2.1 at 34a1d5da58fb8edcad39633084541bb4162f5ede and merged into 2.2, 3.0, 3.11 and trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                            <outwardlinks description="duplicates">
                                        <issuelink>
            <issuekey id="13094089">CASSANDRA-13757</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13141689">CASSANDRA-14283</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13094089">CASSANDRA-13757</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 32 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3qrhr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blambov</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blambov]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>