<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:24:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-17424] Performance and Semantic Concerns w/ Metrics for Local vs. Remote Requests in StorageProxy</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-17424</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10023&quot; title=&quot;Emit a metric for number of local read and write calls&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10023&quot;&gt;&lt;del&gt;CASSANDRA-10023&lt;/del&gt;&lt;/a&gt;, we added two new metrics to both &lt;tt&gt;ClientRequestMetrics&lt;/tt&gt; and &lt;tt&gt;ClientWriteRequestMetrics&lt;/tt&gt; to represent requests where the driver either does or does not make a correct token-aware choice of coordinator. (Auditing driver behavior is listed as the primary goal of that Jira.)&lt;/p&gt;

&lt;p&gt;There are, however, a few concerns we should address before this releases in 4.1:&lt;/p&gt;

&lt;p&gt;1.) With paging enabled and a LIMIT &amp;lt; fetch size, &lt;tt&gt;IN&lt;/tt&gt; queries can hit &lt;tt&gt;fetchRows()&lt;/tt&gt; multiple times, so the number of local + remote requests isn&#8217;t the same as the number of queries marked in &lt;tt&gt;ClientRequestMetrics&lt;/tt&gt; in &lt;tt&gt;readRegular()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;2.) &lt;tt&gt;IN&lt;/tt&gt; queries will potentially mark a bunch of &#8220;remote&#8221; requests even if one key in the &lt;tt&gt;IN&lt;/tt&gt; set is &#8220;local&#8221;.&lt;/p&gt;

&lt;p&gt;3.) Something similar happens with mutations. If &lt;tt&gt;StorageProxy#mutate()&lt;/tt&gt; receives multiple mutations, we&#8217;ll mark against one of these new metrics in &lt;tt&gt;ClientWriteRequestMetrics&lt;/tt&gt; for each mutation, while &lt;tt&gt;ClientWriteRequestMetrics&lt;/tt&gt; will only register the actual client request once.&lt;/p&gt;

&lt;p&gt;For cases 2 and 3, we may mark both local and remote requests for the same overall client request, which introduces ambiguity if these are intended to help audit driver coordinator selection behavior. There are a few options:&lt;/p&gt;

&lt;p&gt;a.) We can accept the ambiguity, but then we haven&#8217;t really accomplished the goal of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10023&quot; title=&quot;Emit a metric for number of local read and write calls&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10023&quot;&gt;&lt;del&gt;CASSANDRA-10023&lt;/del&gt;&lt;/a&gt; for some request types.&lt;/p&gt;

&lt;p&gt;b.) We can simply not record any of these metrics for requests where multiple partitions/tokens are involved.&lt;/p&gt;

&lt;p&gt;c.) We can be lenient, marking requests as &#8220;local&#8221; if any of the partitions/tokens involved in the client request are, in fact, local.&lt;/p&gt;

&lt;p&gt;&#8220;c&#8221; feels like the option that preserves as much functionality as possible without being ambiguous, but problem #2 above is still tricky, given the way IN and GROUP BY queries behave w/ paging. (Perhaps ambiguity in that case is acceptable?)&lt;/p&gt;

&lt;p&gt;In addition to the general ambiguity around the above&#8230;&lt;/p&gt;

&lt;p&gt;4.) There is excessive object creation involved (on a hot path) in our determination of whether a request is local or remote. We should be able to mitigate this by getting rid of &lt;tt&gt;AbstractReadExecutor#getContactedReplicas()&lt;/tt&gt; and relying on &lt;tt&gt;ReplicaPlan#lookup()&lt;/tt&gt; rather than creating strings. (Even for writes, we should be able to push down marking into performWrite(), where the write ReplicaPlan is already available.)&lt;/p&gt;</description>
                <environment></environment>
        <key id="13432709">CASSANDRA-17424</key>
            <summary>Performance and Semantic Concerns w/ Metrics for Local vs. Remote Requests in StorageProxy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maedhroz">Caleb Rackliffe</assignee>
                                    <reporter username="maedhroz">Caleb Rackliffe</reporter>
                        <labels>
                    </labels>
                <created>Tue, 8 Mar 2022 22:49:29 +0000</created>
                <updated>Fri, 27 May 2022 19:24:53 +0000</updated>
                            <resolved>Tue, 29 Mar 2022 16:59:02 +0000</resolved>
                                        <fixVersion>4.1-alpha1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                                    <component>Observability/Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="4800">1h 20m</timespent>
                                <comments>
                            <comment id="17506587" author="maedhroz" created="Mon, 14 Mar 2022 22:28:06 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/1501&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra?branch=CASSANDRA-17424&amp;amp;filter=all&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CircleCI&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I pushed up a first attempt at this. I&apos;ve left the ambiguity around IN/GROUP BY alone for now, although I&apos;m more than willing to revisit that if there&apos;s enough feedback. (See the PR for some inline notes...)&lt;/p&gt;

&lt;p&gt;CC &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17510051" author="jonmeredith" created="Mon, 21 Mar 2022 17:50:51 +0000"  >&lt;p&gt;Patch looks good to me in current form, I added a couple of very minor comments to the PR.&lt;/p&gt;

&lt;p&gt;I&apos;d suggest we resolve any ambiguity in a follow up JIRA, and limit this to reducing the object creation/string search.&lt;/p&gt;</comment>
                            <comment id="17513821" author="krummas" created="Tue, 29 Mar 2022 05:55:05 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17514195" author="maedhroz" created="Tue, 29 Mar 2022 16:59:02 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/57ab3afcf16970047d3df4656241cf0705e94bee&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/57ab3afcf16970047d3df4656241cf0705e94bee&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="12853127">CASSANDRA-10023</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12988" cascade-level="1"><![CDATA[API / Semantic Implementation]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12975"><![CDATA[Code Inspection]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 33 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10aqg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jmeredithco]]></customfieldvalue>
        <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12350145">4.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/57ab3afcf16970047d3df4656241cf0705e94bee&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/57ab3afcf16970047d3df4656241cf0705e94bee&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;n/a&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>