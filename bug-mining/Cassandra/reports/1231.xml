<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:24:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3370] Deflate Compression corrupts SSTables</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3370</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;it seems that the Deflate Compressor corrupts the SSTables. 3 out of 3 Installations were corrupt. Snappy works fine.&lt;/p&gt;

&lt;p&gt;Here is what I did:&lt;/p&gt;

&lt;p&gt;1. Start a single cassandra node (I was using ByteOrderedPartitioner)&lt;br/&gt;
2. Write data into cf that uses deflate compression - I think it has to be enough data so that the data folder contains some files.&lt;br/&gt;
3. When I now try to read (I did a range scan) from my application, it fails and the logs show corruptions:&lt;/p&gt;

&lt;p&gt;Caused by: org.apache.cassandra.io.compress.CorruptedBlockException: (/home/cspriegel/Development/cassandra1/data/Test/Response-h-2-Data.db): corruption detected, chunk at 0 of length 65536.&lt;/p&gt;

&lt;p&gt;regards,&lt;br/&gt;
Christian&lt;/p&gt;</description>
                <environment>&lt;p&gt;Ubuntu Linux, amd64, Cassandra 1.0.0-rc2&lt;/p&gt;</environment>
        <key id="12527375">CASSANDRA-3370</key>
            <summary>Deflate Compression corrupts SSTables</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="christianmovi">Christian Spriegel</reporter>
                        <labels>
                            <label>compression</label>
                    </labels>
                <created>Sun, 16 Oct 2011 23:04:01 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:48 +0000</updated>
                            <resolved>Thu, 20 Oct 2011 13:35:22 +0000</resolved>
                                        <fixVersion>1.0.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13128539" author="christianmovi" created="Sun, 16 Oct 2011 23:06:05 +0000"  >&lt;p&gt;Attached system.log of broken installation&lt;/p&gt;</comment>
                            <comment id="13129788" author="slebresne" created="Tue, 18 Oct 2011 15:15:00 +0000"  >&lt;p&gt;The exception is raised because there is a digest mismatch for the initial block of one of the sstable.&lt;/p&gt;

&lt;p&gt;Haven&apos;t been able to reproduce so far using stress with deflate with the default 1M keys (which create a bunch of sstables, at least on my machine) using row slices and range scans (using both Random and ByteOrdered partitioners).&lt;/p&gt;

&lt;p&gt;Would you be able to 1) try with 1.0.0 and 2) try with the stress tool that comes with Cassandra (it&apos;s in tools/stress of the source distribution, and you&apos;ll want to insert values with &apos;stress -I DeflateCompressor&apos; and read with &apos;stress -I DeflateCompressor -o RANGE_SLICE&apos; ) and see if you can reproduce? Another question is, did you used openJDK or Sun JDK?&lt;/p&gt;</comment>
                            <comment id="13129794" author="christianmovi" created="Tue, 18 Oct 2011 15:21:56 +0000"  >&lt;p&gt;My Java version is: &lt;br/&gt;
java version &quot;1.6.0_26&quot;&lt;br/&gt;
Java(TM) SE Runtime Environment (build 1.6.0_26-b03)&lt;br/&gt;
Java HotSpot(TM) 64-Bit Server VM (build 20.1-b02, mixed mode)&lt;/p&gt;

&lt;p&gt;Cassandra report during startup:&lt;br/&gt;
INFO 17:20:39,113 JVM vendor/version: Java HotSpot(TM) 64-Bit Server VM/1.6.0_26&lt;/p&gt;

&lt;p&gt;I will test tonight ...&lt;/p&gt;</comment>
                            <comment id="13130001" author="christianmovi" created="Tue, 18 Oct 2011 20:33:43 +0000"  >&lt;p&gt;I tested again with 1.0.0. Unfortunetaly the problem still exists.&lt;/p&gt;

&lt;p&gt;But I think I was able to narrow it down: It seems that the problem only occurs when I insert large byte-arrays.&lt;/p&gt;

&lt;p&gt;It seems to work fine with 10kb arrays, no problem there. I was able to repeatedly insert and read.&lt;/p&gt;

&lt;p&gt;With 100kb or 200kb arrays it crashes after about 1000-2000 insertions. (Insertions work, but range scan afterwards crashes)&lt;/p&gt;



</comment>
                            <comment id="13130007" author="christianmovi" created="Tue, 18 Oct 2011 20:42:46 +0000"  >&lt;p&gt;btw: I just tested the DeflaterOutputStream/DeflaterInputStream classes in a small testcase and there it works fine. I thought maybe Deflate in my jvm is broken.&lt;/p&gt;</comment>
                            <comment id="13130553" author="slebresne" created="Wed, 19 Oct 2011 12:48:14 +0000"  >&lt;p&gt;Still cannot reproduce. I&apos;ve tried multiple times inserting 5000 keys using the stress tool using values of 10KB, 20KB, 100KB and 200KB (using &apos;stress -I DeflateCompressor -S 200000 -n 5000&apos;). I then try to reading both with &apos;stress -o RANGE_SLICE -n 5000&apos; and by simply fetching the 100 first keys using the CLI (with a simple &apos;list Standard1;&apos;) and got no exceptions (the actual listing in the CLI took a while to be printed on screen because the columns are big but outside of that, no errors).&lt;/p&gt;

&lt;p&gt;Would you mind trying the same experiment (with the same tools) or providing the test script you&apos;re using so we can check if it has to do with the specific insertions or with something in your environment.&lt;/p&gt;</comment>
                            <comment id="13130685" author="christianmovi" created="Wed, 19 Oct 2011 15:18:17 +0000"  >&lt;p&gt;Ok, I will try the stress tool.&lt;/p&gt;

&lt;p&gt;Just to be sure: You are talking about stress.py and not the java-based stress? Because I was trying the java stress and it did not accept the -I parameter.&lt;/p&gt;</comment>
                            <comment id="13130691" author="slebresne" created="Wed, 19 Oct 2011 15:23:21 +0000"  >&lt;p&gt;No, I&apos;m talking of the java one. The python one is old and won&apos;t support compression for instance. The java one in the 1.0.0 source does support compression through the -I parameter. Are you sure you&apos;re looking at the right version ? &lt;/p&gt;</comment>
                            <comment id="13130695" author="christianmovi" created="Wed, 19 Oct 2011 15:33:55 +0000"  >&lt;p&gt;I see! I got the wrong version. Sorry, I did not know that it was included in the cassandra source. I thought I had to download it some place else.&lt;/p&gt;

&lt;p&gt;I will try with that and let you know about the results...&lt;/p&gt;</comment>
                            <comment id="13130962" author="christianmovi" created="Wed, 19 Oct 2011 20:27:12 +0000"  >&lt;p&gt;I tried using stress from 1.0.0 and I got the same results as you. Stress for some reason works fine. &lt;/p&gt;

&lt;p&gt;One thing is strange about stress:&lt;br/&gt;
I let stress run for quite some time, but there is only 12 MB in the datafolder.&lt;br/&gt;
I let my tool run for 10 seconds, but there are 97MB in the data folder.&lt;/p&gt;

&lt;p&gt;Is stress maybe not generating random data, so that it compresses really well? Might that be the difference?&lt;/p&gt;

&lt;p&gt;Can I maybe share my application with you? Its a single source file with a pom.xml. &lt;/p&gt;

&lt;p&gt;If you have any idea what I can do, please let me know.&lt;/p&gt;
</comment>
                            <comment id="13131022" author="christianmovi" created="Wed, 19 Oct 2011 21:33:45 +0000"  >&lt;p&gt;Attached my client that causes the crash.&lt;/p&gt;</comment>
                            <comment id="13131517" author="slebresne" created="Thu, 20 Oct 2011 10:57:48 +0000"  >&lt;p&gt;You test did help. Turns out that&apos;s because you&apos;re inserting random and thus basically uncompressible data, and the compressed data was bigger than the uncompressed one. The code is supposed to handle that but there is a bug in that part.&lt;/p&gt;

&lt;p&gt;Patch attached to fix.&lt;/p&gt;</comment>
                            <comment id="13131519" author="christianmovi" created="Thu, 20 Oct 2011 11:02:31 +0000"  >&lt;p&gt;Great! This would also apply if some app would insert already compressed data.&lt;/p&gt;</comment>
                            <comment id="13131603" author="xedin" created="Thu, 20 Oct 2011 13:20:44 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13131626" author="slebresne" created="Thu, 20 Oct 2011 13:35:22 +0000"  >&lt;p&gt;Committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12499845" name="3370.patch" size="957" author="slebresne" created="Thu, 20 Oct 2011 10:57:48 +0000"/>
                            <attachment id="12499765" name="Test.zip" size="3342" author="christianmovi" created="Wed, 19 Oct 2011 21:33:45 +0000"/>
                            <attachment id="12499227" name="system.log" size="24021" author="christianmovi" created="Sun, 16 Oct 2011 23:06:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>87538</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 5 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gj27:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94518</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>xedin</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[xedin]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>