<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:22:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2494] Quorum reads are not monotonically consistent</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2494</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;As discussed in this thread,&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://www.mail-archive.com/user@cassandra.apache.org/msg12421.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.mail-archive.com/user@cassandra.apache.org/msg12421.html&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Quorum reads should be consistent.  Assume we have a cluster of 3 nodes (X,Y,Z) and a replication factor of 3. If a write of N is committed to X, but not Y and Z, then a read from X should not return N unless the read is committed to at  least two nodes.  To ensure this, a read from X should wait for an ack of the read repair write from either Y or Z before returning.&lt;/p&gt;

&lt;p&gt;Are there system tests for cassandra?  If so, there should be a test similar to the original post in the email thread.  One thread should write 1,2,3... at consistency level ONE.  Another thread should read at consistency level QUORUM from a random host, and verify that each read is &amp;gt;= the last read.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12504486">CASSANDRA-2494</key>
            <summary>Quorum reads are not monotonically consistent</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="sbridges">Sean Bridges</reporter>
                        <labels>
                    </labels>
                <created>Sun, 17 Apr 2011 14:29:37 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:54 +0000</updated>
                            <resolved>Thu, 11 Aug 2011 19:29:40 +0000</resolved>
                                        <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="13020867" author="scode" created="Sun, 17 Apr 2011 21:01:09 +0000"  >&lt;p&gt;As far as I can tell the consistency being asked for was never promised by Cassandra is in fact not expected.&lt;/p&gt;

&lt;p&gt;The expected behavior of writes is that they propagate; the difference between ONE and QUORUM is just how many are required to receive a write prior to a return to the client with a successful error code. For reads, that means you may get lucky at ONE or you may get lucky at QUORUM; the positive guarantee is in the case of a &lt;b&gt;completing&lt;/b&gt; QUORUM write followed by a QUORUM read.&lt;/p&gt;

&lt;p&gt;So just to be clear, although I don&apos;t think this is what is being asked for: As far as I know, it has never been the case, nor the intent to promise, that a write which fails is guaranteed not to eventually complete. Simply &quot;fixing&quot; reads is not enough; by design the data will be replicated during read-repair and AES - this is how consistency is achieved in Cassandra.&lt;/p&gt;

&lt;p&gt;However, it sounds like what is being asked for is not that they don&apos;t propagate in the event of a write &quot;failure&quot;, but just that reads don&apos;t see the writes until they are sufficiently propagated to guarantee that any future QUORUM read will also see the data. I can understand that is desirable, in the sense of achieving monotonically forward-moving data as the benchmark/test from the e-mail thread does. Another way to look at is that maybe you never want to read data successfully prior to achieving a certain level of replication, in order to avoid a client ever seeing data that may suddenly go away due to e.g. a node failure in spite of said failure not exceeding the number of failures the cluster was designed to survive.&lt;/p&gt;

&lt;p&gt;So the key point would be the bit about guaranteeing that any &quot;future QUORUM read will see the data or data subsequently overwritten&quot;, and actively read-repairing and waiting for it to happen would take care of that. It would be important to ensure that the act of ensuring a quorum of nodes have seen the data is the important part; one should not await for a quorum to agree on the &lt;b&gt;current&lt;/b&gt; version of the data as that would create potentially unbounded round-trips on hotly contended data.&lt;/p&gt;

&lt;p&gt;Thing to consider: One might think about cases where read-repair is currently not done, like range slices, and how an implementation that requires read repair for consistency affects that.&lt;/p&gt;
</comment>
                            <comment id="13020898" author="sbridges" created="Mon, 18 Apr 2011 04:20:10 +0000"  >&lt;p&gt;Peter Shuller wrote,&lt;/p&gt;

&lt;p&gt;&quot;However, it sounds like what is being asked for is not that they don&apos;t propagate in the event of a write &quot;failure&quot;, but just that reads don&apos;t see the writes until they are sufficiently propagated to guarantee that any future QUORUM read will also see the data.&quot;&lt;/p&gt;

&lt;p&gt;Yes, that is the issue.  The comment in the bug about writing at ONE and reading at QUORUM is just a way of testing this new guarantee in a distributed test, if Cassandra has those.&lt;/p&gt;</comment>
                            <comment id="13021242" author="JIRAUSER308715" created="Mon, 18 Apr 2011 20:41:27 +0000"  >&lt;p&gt;I would think that reads at QUORUM should never go backwards.  Even if the Write was at ZERO.  If there were writes to the cluster of a=1 time=5, a=2 time=10, a=3 time=15, and I do a read at QUORUM which tells me a=3 time=15, I should not be able to do another read at QUORUM and get a=2 time=10.&lt;/p&gt;</comment>
                            <comment id="13023116" author="stuhood" created="Fri, 22 Apr 2011 05:17:00 +0000"  >&lt;p&gt;W plus R must be &lt;em&gt;greater than&lt;/em&gt; N for consistency.&lt;/p&gt;

&lt;p&gt;EDIT: And adding a blocking implicit write step to QUORUM reads by waiting for read repair is not reasonable.&lt;/p&gt;</comment>
                            <comment id="13023151" author="scode" created="Fri, 22 Apr 2011 08:26:09 +0000"  >&lt;p&gt;I don&apos;t think anyone is claiming otherwise, unless I&apos;m misunderstanding. The problem is that while the &quot;if sucessfully written to quorum, subsequent quorum reads will see it&quot; guarantee is indeed maintained, it is possible for quorum reads to see data go backwards (on a timeline) in the event of a &lt;b&gt;failed&lt;/b&gt; attempted quorum write. This includes the possibility of reads seeing data that then permanently vanishes, even though you only lost say 1 node that you designed your cluster for surviving (RF &amp;gt;= 3, QUORUM). (&quot;lost 1 node&quot; can be substituted with &quot;killed 1 node in periodic commit mode&quot;)&lt;/p&gt;

&lt;p&gt;I still don&apos;t think this is a violation of what was promised, but I can see how making the further guarantee would make for more useful consistency semantics in some cases.&lt;/p&gt;

&lt;p&gt;With respect to implicit write: An alternative is to adjust reconciliation logic when applied as part of reads (as opposed to AES,  hinted hand-off, writes) to take consistency level into account and only consider columns whose timestamp is &amp;gt;= the greatest timestamp that has quorum (off the top of my head I think that should be correct in call cases, but I didn&apos;t think this through terribly).&lt;/p&gt;</comment>
                            <comment id="13023154" author="scode" created="Fri, 22 Apr 2011 08:34:42 +0000"  >&lt;p&gt;Ok, so my last suggestion is in fact broken. A counter example is:&lt;/p&gt;

&lt;p&gt; A: column @ t1&lt;br/&gt;
 B: column @ t2&lt;br/&gt;
 C: column @ t3&lt;/p&gt;

&lt;p&gt;If A + B is participating, A&apos;s column @ t1 has timestamp quorum and would be selected. If B + C is participating, B&apos;s column is picked. Thus, a read where B + C participates will see data that will be reverted once A + B happens to be picked.&lt;/p&gt;

&lt;p&gt;Note to self: Think before posting.&lt;/p&gt;</comment>
                            <comment id="13023233" author="sbridges" created="Fri, 22 Apr 2011 14:45:41 +0000"  >&lt;p&gt;I think the guarantee of quorum reads not seeing old writes once a quorum read sees a new write is  very useful.  I suspect most people already think that this guarantee occurs, including, it seems, Jonathan Ellis whose quote can be found in the email thread linked to in the bug,&lt;/p&gt;

&lt;p&gt;&quot;The important guarantee this gives you is that once one quorum read sees the new value, all others will too.   You can&apos;t see the newest version, then see an older version on a subsequent write [sic, I&lt;br/&gt;
assume he meant read], which is the characteristic of non-strong consistency&quot;&lt;/p&gt;


</comment>
                            <comment id="13023237" author="slebresne" created="Fri, 22 Apr 2011 15:01:25 +0000"  >&lt;p&gt;The problem is you are considering the consistency of reads but not write. The guarantee is: &quot;quorum reads will not see old quorum write once a quorum read sees a new quorum&quot;. Period. I you don&apos;t consider the consistency of a write, consider the case of a CL.ANY write. In this case, the update may not be at all on any replica. How can we ensure the quorum read property that you want ? We query all nodes for quorum reads in case there is an hint somewhere ?&lt;/p&gt;

&lt;p&gt;If you look at the Consistency part of &lt;a href=&quot;http://wiki.apache.org/cassandra/ArchitectureOverview&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://wiki.apache.org/cassandra/ArchitectureOverview&lt;/a&gt;, it seems to me that it is pretty clear that the consistency of reads &lt;b&gt;and&lt;/b&gt; writes is involved to achieve strong consistency. So I would hope &apos;most people&apos; are aware of that.&lt;/p&gt;</comment>
                            <comment id="13023239" author="scode" created="Fri, 22 Apr 2011 15:11:55 +0000"  >&lt;p&gt;The issue is that of &lt;b&gt;failed&lt;/b&gt; QUORUM writes. I.e., you design your system to use QUORUM writes and QUORUM reads, and expect that once a QUORUM read sees a given piece of data a subsequent QUORUM read will also see it (or a later data). A &lt;b&gt;failed&lt;/b&gt; QUORUM write that was replicated to less than a QUORUM would be visible as part of QUORUM reads that happen to touch one of those replicas, but there is no guarantee that subsequent reads see it.&lt;/p&gt;

&lt;p&gt;I was under the impression this was never an intended guarantee. Apparently I may be wrong about that given the jbellis quote above. In either case, it is certainly not an &lt;b&gt;actual&lt;/b&gt; guarantee given by the current implementation.&lt;/p&gt;

&lt;p&gt;The guarantee that a &lt;b&gt;successful&lt;/b&gt; QUORUM write is seen by a subsequent QUORUM read is, as far as I can tell, not in question here.&lt;/p&gt;
</comment>
                            <comment id="13023242" author="sbridges" created="Fri, 22 Apr 2011 15:22:29 +0000"  >&lt;p&gt;To be clear, this is a new guarantee.  The current guarantee is R+W&amp;gt;N gives you consistency.  This bug is asking that a successful quorum read of A means that A has been committed to a quorum of nodes.&lt;/p&gt;

&lt;p&gt;&quot;How can we ensure the quorum read property that you want ?&quot;&lt;/p&gt;

&lt;p&gt;If when reading at quorum, and no quorum can be found which agrees on a particular value, then the coordinator ( ? ) will wait for acks of read repair writes (or perhaps just do normal writes) to be returned from a sufficient number of nodes to ensure that the value has been committed to a quorum of nodes.&lt;/p&gt;

&lt;p&gt;Without this new guarantee it is hard for readers to function correctly.  The reader does not know that the quorum write failed, or is still in progress, so without reading at ALL, the R+W&amp;gt;N guarantee does not help the reader.&lt;/p&gt;


</comment>
                            <comment id="13071478" author="jbellis" created="Wed, 27 Jul 2011 01:46:55 +0000"  >&lt;p&gt;I don&apos;t see any reason not to guarantee that the replicas we read from provide monotonic read consistency.&lt;/p&gt;

&lt;p&gt;Patch attached to do this.&lt;/p&gt;</comment>
                            <comment id="13071654" author="slebresne" created="Wed, 27 Jul 2011 11:08:35 +0000"  >&lt;p&gt;Ok, I now see what you mean &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;br/&gt;
Makes perfect sense.&lt;/p&gt;

&lt;p&gt;Comments on the patch:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;There is a number of case where scheduleRepairs may not have been called (if the read for repair timeout and/or we had no or only 1 response or we have the situation were removeDeleted removes everything), so repairResults will be null in those cases. In SP, we should check for it.&lt;/li&gt;
	&lt;li&gt;That new wait can extend the rpc timeout to almost twice what it should be. I agree that it is not a huge deal, but by exposing the &apos;startTime&apos; stored in RepairCallback we can make it so we don&apos;t extend it that way.&lt;/li&gt;
	&lt;li&gt;Shouldn&apos;t we give the same love to range requests, now that we do repairs there too ?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13078829" author="jbellis" created="Wed, 3 Aug 2011 16:34:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;There is a number of case where scheduleRepairs may not have been called&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;defaulted repairResults to emptyList.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;That new wait can extend the rpc timeout to almost twice what it should be&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, sort of &amp;#8211; rpctimeout is working exactly as intended, i.e., to prevent waiting indefinitely for a node that died after we sent it a request.  Treating it as &quot;max time to respond to client&quot; has never really been correct.  (E.g., in the CL &amp;gt; ONE case we can already wait up to rpctimeout twice, one for the original digest read set, and again for the data read after mismatch.)  So I don&apos;t think we should try to be clever with that here.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Shouldn&apos;t we give the same love to range requests, now that we do repairs there too&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;done.&lt;/p&gt;</comment>
                            <comment id="13083168" author="slebresne" created="Thu, 11 Aug 2011 15:34:34 +0000"  >&lt;blockquote&gt;&lt;p&gt;Well, sort of &#8211; rpctimeout is working exactly as intended, i.e., to prevent waiting indefinitely for a node that died after we sent it a request. Treating it as &quot;max time to respond to client&quot; has never really been correct. (E.g., in the CL &amp;gt; ONE case we can already wait up to rpctimeout twice, one for the original digest read set, and again for the data read after mismatch.) So I don&apos;t think we should try to be clever with that here.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Fair enough. It would probably be useful to make rpctimeout meaning closer to &quot;max time to respond to client&quot;. Created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3018&quot; title=&quot;Make RPCTimeout be as close to &amp;quot;max time to respond to client&amp;quot; as possible&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3018&quot;&gt;CASSANDRA-3018&lt;/a&gt; for that though.&lt;/p&gt;

&lt;p&gt;+1 on v2.&lt;/p&gt;</comment>
                            <comment id="13083421" author="jbellis" created="Thu, 11 Aug 2011 19:29:40 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13083465" author="hudson" created="Thu, 11 Aug 2011 20:14:24 +0000"  >&lt;p&gt;Integrated in Cassandra #1017 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra/1017/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra/1017/&lt;/a&gt;)&lt;br/&gt;
    provide monotonic read consistency&lt;br/&gt;
patch by jbellis; reviewed by slebresne for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2494&quot; title=&quot;Quorum reads are not monotonically consistent&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2494&quot;&gt;&lt;del&gt;CASSANDRA-2494&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1156758&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1156758&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/service/StorageProxy.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/service/RepairCallback.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/service/RowRepairResolver.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/utils/FBUtilities.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/service/RangeSliceResponseResolver.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14906978" author="aaaron" created="Thu, 24 Sep 2015 20:45:58 +0000"  >&lt;p&gt;The relevant code in the patch has changed significantly. Is the monotonic read consistency guarantee still provided?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13272022">CASSANDRA-15442</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12489205" name="2494-v2.txt" size="22757" author="jbellis" created="Wed, 3 Aug 2011 16:34:56 +0000"/>
                            <attachment id="12487930" name="2494.txt" size="6642" author="jbellis" created="Wed, 27 Jul 2011 01:46:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20654</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 8 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gbp3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93325</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>