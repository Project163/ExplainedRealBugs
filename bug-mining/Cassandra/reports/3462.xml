<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:51:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9077] Deleting an element from a List which is null throws a NPE</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9077</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I am seeing an NPE on the latest 2.1 branch with this sequence of deletes from a list - first delete the entire list, then attempt to delete one element.&lt;/p&gt;

&lt;p&gt;I expected to see &lt;tt&gt;List index 0 out of bound, list has size 0&lt;/tt&gt; but instead got an NPE.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;./bin/cqlsh
Connected to Test Cluster at 127.0.0.1:9042.
[cqlsh 5.0.1 | Cassandra 2.1.3-SNAPSHOT | CQL spec 3.2.0 | Native protocol v3]
Use HELP for help.
cqlsh&amp;gt; use frozen_collections ;
cqlsh:frozen_collections&amp;gt; DROP TABLE IF EXISTS t;
cqlsh:frozen_collections&amp;gt; CREATE TABLE t (id text PRIMARY KEY, l list&amp;lt;text&amp;gt;, s set&amp;lt;text&amp;gt;);
cqlsh:frozen_collections&amp;gt; INSERT INTO t (id, l, s) VALUES (&apos;user&apos;, [&apos;1&apos;], {&apos;1&apos;});
cqlsh:frozen_collections&amp;gt;
cqlsh:frozen_collections&amp;gt; DELETE l FROM t WHERE id =&apos;user&apos;;
cqlsh:frozen_collections&amp;gt; //INSERT INTO t (id, l) VALUES (&apos;user&apos;, [&apos;1&apos;]);
cqlsh:frozen_collections&amp;gt; DELETE l[0] FROM t WHERE id = &apos;user&apos;;
ServerError: &amp;lt;ErrorMessage code=0000 [Server error] message=&quot;java.lang.NullPointerException&quot;&amp;gt;
cqlsh:frozen_collections&amp;gt;
cqlsh:frozen_collections&amp;gt; DELETE s FROM t WHERE id =&apos;user&apos;;
cqlsh:frozen_collections&amp;gt; DELETE s[&apos;1&apos;] FROM t WHERE id = &apos;user&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It appears the &lt;tt&gt;DELETE emails...&lt;/tt&gt; directly followed by &lt;tt&gt;DELETE emails&lt;span class=&quot;error&quot;&gt;&amp;#91;0&amp;#93;&lt;/span&gt;...&lt;/tt&gt; is the offending sequence. Either one alone works fine, as does adding an intervening insert/update.&lt;/p&gt;

&lt;p&gt;The same sequence performed on a Set rather than List works (as shown above).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12786924">CASSANDRA-9077</key>
            <summary>Deleting an element from a List which is null throws a NPE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jjirsa">Jeff Jirsa</assignee>
                                    <reporter username="djatnieks">dan jatnieks</reporter>
                        <labels>
                    </labels>
                <created>Tue, 31 Mar 2015 04:48:38 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:16 +0000</updated>
                            <resolved>Wed, 1 Apr 2015 17:15:13 +0000</resolved>
                                        <fixVersion>2.1.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14387986" author="djatnieks" created="Tue, 31 Mar 2015 04:49:57 +0000"  >&lt;p&gt;Attaching stacktrace from system.log.&lt;/p&gt;</comment>
                            <comment id="14388054" author="jjirsa" created="Tue, 31 Mar 2015 05:46:44 +0000"  >&lt;p&gt;The underlying problem is that o.a.c.db.composites.AbstractCellNameType.CQL3RowOfSparse getMultiCellColumn() can return null (if collection==null), which happens if/when you delete the list. &lt;/p&gt;

&lt;p&gt;A very similar NPE would be thrown if you tried to update to set a list element by index once the list was deleted:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:test2&amp;gt; update t set l[0] = &apos;1&apos; where id=&apos;user&apos;;
ServerError: &amp;lt;ErrorMessage code=0000 [Server error] message=&quot;java.lang.NullPointerException&quot;&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [SharedPool-Worker-1] 2015-03-30 22:22:32,682 QueryMessage.java:132 - Unexpected error during query
java.lang.NullPointerException: null
	at org.apache.cassandra.cql3.Lists$SetterByIndex.execute(Lists.java:345) ~[main/:na]
	at org.apache.cassandra.cql3.statements.UpdateStatement.addUpdateForKey(UpdateStatement.java:111) ~[main/:na]
	at org.apache.cassandra.cql3.statements.UpdateStatement.addUpdateForKey(UpdateStatement.java:58) ~[main/:na]
	at org.apache.cassandra.cql3.statements.ModificationStatement.getMutations(ModificationStatement.java:643) ~[main/:na]
	at org.apache.cassandra.cql3.statements.ModificationStatement.executeWithoutCondition(ModificationStatement.java:475) ~[main/:na]
	at org.apache.cassandra.cql3.statements.ModificationStatement.execute(ModificationStatement.java:461) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:234) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:261) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:246) ~[main/:na]
	at org.apache.cassandra.transport.messages.QueryMessage.execute(QueryMessage.java:119) ~[main/:na]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:475) ~[main/:na]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:371) ~[main/:na]
	at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) ~[netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:333) ~[netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.access$700(AbstractChannelHandlerContext.java:32) ~[netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext$8.run(AbstractChannelHandlerContext.java:324) ~[netty-all-4.0.23.Final.jar:4.0.23.Final]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_25]
	at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) ~[main/:na]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) ~[main/:na]
	at java.lang.Thread.run(Thread.java:724) ~[na:1.7.0_25]
ERROR [SharedPool-Worker-1] 2015-03-30 22:22:32,683 ErrorMessage.java:329 - Unexpected exception during request
java.lang.NullPointerException: null
	at org.apache.cassandra.cql3.Lists$SetterByIndex.execute(Lists.java:345) ~[main/:na]
	at org.apache.cassandra.cql3.statements.UpdateStatement.addUpdateForKey(UpdateStatement.java:111) ~[main/:na]
	at org.apache.cassandra.cql3.statements.UpdateStatement.addUpdateForKey(UpdateStatement.java:58) ~[main/:na]
	at org.apache.cassandra.cql3.statements.ModificationStatement.getMutations(ModificationStatement.java:643) ~[main/:na]
	at org.apache.cassandra.cql3.statements.ModificationStatement.executeWithoutCondition(ModificationStatement.java:475) ~[main/:na]
	at org.apache.cassandra.cql3.statements.ModificationStatement.execute(ModificationStatement.java:461) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:234) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:261) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:246) ~[main/:na]
	at org.apache.cassandra.transport.messages.QueryMessage.execute(QueryMessage.java:119) ~[main/:na]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:475) ~[main/:na]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:371) ~[main/:na]
	at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) ~[netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:333) ~[netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.access$700(AbstractChannelHandlerContext.java:32) ~[netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext$8.run(AbstractChannelHandlerContext.java:324) ~[netty-all-4.0.23.Final.jar:4.0.23.Final]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_25]
	at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) ~[main/:na]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) ~[main/:na]
	at java.lang.Thread.run(Thread.java:724) ~[na:1.7.0_25]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are two ways to fix this - could either &lt;/p&gt;

&lt;p&gt;1) Check for null in Lists.java, and throw a new error trying to delete an element from an empty list (or similarly, try to add an element at an index of an empty list), &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:test2&amp;gt; INSERT INTO t (id, l, s) VALUES (&apos;user&apos;, [&apos;1&apos;], {&apos;1&apos;}); DELETE l FROM t WHERE id =&apos;user&apos;; DELETE l[0] FROM t WHERE id = &apos;user&apos;;
InvalidRequest: code=2200 [Invalid query] message=&quot;Attempt to delete from an empty list&quot;
cqlsh:test2&amp;gt; update t set l[0] = &apos;1&apos; where id=&apos;user&apos;;                                                                                                                                                                                                  
InvalidRequest: code=2200 [Invalid query] message=&quot;Attempt to set an element on a null list&quot;
cqlsh:test2&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2) Make it return an actual empty list instead of null, in which case the existing bounds checking works as intended: &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:test2&amp;gt; INSERT INTO t (id, l, s) VALUES (&apos;user&apos;, [&apos;1&apos;], {&apos;1&apos;}); DELETE l FROM t WHERE id =&apos;user&apos;; DELETE l[0] FROM t WHERE id = &apos;user&apos;;                                                                                                           
InvalidRequest: code=2200 [Invalid query] message=&quot;List index 0 out of bound, list has size 0&quot;
cqlsh:test2&amp;gt; update t set l[0] = &apos;1&apos; where id=&apos;user&apos;;                                                                                                                                                                                                  
InvalidRequest: code=2200 [Invalid query] message=&quot;List index 0 out of bound, list has size 0&quot;
cqlsh:test2&amp;gt; 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Both patches attached. Leaving it to a reviewer to decide which is the right approach (perhaps both?)&lt;/p&gt;</comment>
                            <comment id="14388346" author="blerer" created="Tue, 31 Mar 2015 10:18:59 +0000"  >&lt;p&gt;I think we should provide as clear information as possible. By consequence, I am more in favor of the approach of the first patch.&lt;br/&gt;
Regarding the first patch I have the following comments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I think the messages should be &lt;tt&gt;&quot;Attempted to set an element on a list which is null&quot;&lt;/tt&gt; and &lt;tt&gt;&quot;Attempted to delete an element from a list which is null&quot;&lt;/tt&gt;. If we sometime talk about &lt;tt&gt;empty&lt;/tt&gt; and other time about &lt;tt&gt;null&lt;/tt&gt; it might confuse the user.&lt;/li&gt;
	&lt;li&gt;It seems that operation like: &lt;tt&gt;UPDATE %s SET l = l - [&apos;2&apos;] WHERE id = &apos;user&apos;&lt;/tt&gt; suffer from a similar problem&lt;/li&gt;
	&lt;li&gt;Could you add some unit tests in &lt;tt&gt;CollectionsTest&lt;/tt&gt; to verify the correct behavior for all those use cases?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14389255" author="jjirsa" created="Tue, 31 Mar 2015 19:35:30 +0000"  >&lt;p&gt;option1-v2 addresses all 3 requests:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Changed wording to be consistent&lt;/li&gt;
	&lt;li&gt;Handles NPE in Discarder (removing element from null list)&lt;/li&gt;
	&lt;li&gt;Adds unit tests for all 3 cases (Discarder, DiscarderByIndex, SetterByIndex)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Diff was based on trunk, applies cleanly to 2.1 as well. &lt;/p&gt;</comment>
                            <comment id="14390866" author="blerer" created="Wed, 1 Apr 2015 15:58:11 +0000"  >&lt;p&gt;This patch simplify the unit test added in the previous patch by using &lt;tt&gt;assertInvalidMessage&lt;/tt&gt; instead of &lt;tt&gt;try/catch&lt;/tt&gt; blocks.&lt;/p&gt;</comment>
                            <comment id="14390867" author="blerer" created="Wed, 1 Apr 2015 15:59:04 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14391002" author="jjirsa" created="Wed, 1 Apr 2015 17:11:53 +0000"  >&lt;p&gt;Much better.&lt;/p&gt;</comment>
                            <comment id="14391007" author="thobbs" created="Wed, 1 Apr 2015 17:15:13 +0000"  >&lt;p&gt;Committed as cc672f3.  Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12708325" name="9077-stacktrace.log" size="4274" author="djatnieks" created="Tue, 31 Mar 2015 04:49:57 +0000"/>
                            <attachment id="12708723" name="CASSANDRA-9077-v3.txt" size="5384" author="blerer" created="Wed, 1 Apr 2015 15:58:11 +0000"/>
                            <attachment id="12708503" name="cassandra-9077-option1-v2.txt" size="4445" author="jjirsa" created="Tue, 31 Mar 2015 19:35:30 +0000"/>
                            <attachment id="12708338" name="cassandra-9077-option1.txt" size="1528" author="jjirsa" created="Tue, 31 Mar 2015 05:47:54 +0000"/>
                            <attachment id="12708346" name="cassandra-9077-option2.txt" size="825" author="jjirsa" created="Tue, 31 Mar 2015 06:05:31 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jjirsa]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 33 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i27kp3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328951">2.1.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>