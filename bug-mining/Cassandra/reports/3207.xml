<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8176] Intermittent NPE from RecoveryManagerTest RecoverPIT unit test</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8176</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    [junit] Testsuite: org.apache.cassandra.db.RecoveryManagerTest
    [junit] Tests run: 5, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 7.654 sec
    [junit] 
    [junit] ------------- Standard Output ---------------
    [junit] WARN  16:40:38 No host ID found, created 2cbd54a8-79a5-40e0-a8e6-c8bf2c575877 (Note: This should happen exactly once per node).
    [junit] WARN  16:40:38 No host ID found, created 2cbd54a8-79a5-40e0-a8e6-c8bf2c575877 (Note: This should happen exactly once per node).
    [junit] WARN  16:40:38 Encountered bad header at position 16 of commit log /home/mshuler/git/cassandra/build/test/cassandra/commitlog:0/CommitLog-4-1414082433807.log, with invalid CRC. The end of segment marker should be zero.
    [junit] WARN  16:40:38 Encountered bad header at position 16 of commit log /home/mshuler/git/cassandra/build/test/cassandra/commitlog:0/CommitLog-4-1414082433807.log, with invalid CRC. The end of segment marker should be zero.
    [junit] ------------- ---------------- ---------------
    [junit] Testcase: testRecoverPIT(org.apache.cassandra.db.RecoveryManagerTest):      Caused an ERROR
    [junit] null
    [junit] java.lang.NullPointerException
    [junit]     at org.apache.cassandra.db.RecoveryManagerTest.testRecoverPIT(RecoveryManagerTest.java:129)
    [junit] 
    [junit] 
    [junit] Test org.apache.cassandra.db.RecoveryManagerTest FAILED
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Test fails roughly 20-25% of CI runs. Several 10x and 25x bisections for 2.1 &lt;tt&gt;git bisect start cassandra-2.1 f03e505&lt;/tt&gt; resulted in &lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;first bad commit: [1394b128c65ef1ad59f765e9c9c5058cac04ca69]&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; which is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6904&quot; title=&quot;commitlog segments may not be archived after restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6904&quot;&gt;&lt;del&gt;CASSANDRA-6904&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;That patch went to 2.0 and I still need to dig there to see if we&apos;re getting the same error, but I&apos;ve attached the unit test failure system.log from 2.1.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12750116">CASSANDRA-8176</key>
            <summary>Intermittent NPE from RecoveryManagerTest RecoverPIT unit test</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="mshuler">Michael Shuler</reporter>
                        <labels>
                            <label>qa-resolved</label>
                    </labels>
                <created>Thu, 23 Oct 2014 16:59:10 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:30 +0000</updated>
                            <resolved>Wed, 29 Oct 2014 15:24:02 +0000</resolved>
                                        <fixVersion>2.1.2</fixVersion>
                                    <component>Legacy/Testing</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14181575" author="mshuler" created="Thu, 23 Oct 2014 17:07:43 +0000"  >&lt;p&gt;I don&apos;t see this test failing in CI on the 2.0 branch, and I&apos;ve looped over this test on 2.0 HEAD ~30 times with no failure.&lt;/p&gt;</comment>
                            <comment id="14188237" author="beobal" created="Wed, 29 Oct 2014 10:59:00 +0000"  >&lt;p&gt;I believe this is a problem which at the moment can only affect the tests. There&apos;s a pre-existing race which the changes introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6904&quot; title=&quot;commitlog segments may not be archived after restart&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6904&quot;&gt;&lt;del&gt;CASSANDRA-6904&lt;/del&gt;&lt;/a&gt; make more obvious. &lt;/p&gt;

&lt;p&gt;The race is in each of the RecoveryManagerTest tests:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;1 - [main] calls CommitLog.instance.resetUnsafe() -- clears CL active/avail segments
2 - [main] calls CommitLog.instance.recover() -- attempts to replay all unmanaged files in the CL dir, then recycle them.
3 - [COMMIT-LOG-ALLOCATOR] detects that there are no available segments, so it:
    3a - creates a new segment
    3b - adds it to the list of available segments
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The issue is when steps 2 and 3a/3b are interspersed. In that scenario, the new segment created in 3a is replayed by the &lt;tt&gt;[main]&lt;/tt&gt; thread and subsequently recycled whereby its file is renamed. However, as well as being recycled it is added to the list of available segments (3b). So when the next test in the suite runs, this segment is used when performing the initial writes. The recycling has renamed the file but the segment id has not changed, so the checksums written are calculated using the id. Now when this second test resets then tries to recover, it discards the segment due to the checksum mismatches. Ultimately, that&apos;s what leads to the NPE &amp;amp; the test failure as the mutations from that dropped segment are not replayed. This race is highlighted by the changes in the commit &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mshuler&quot; class=&quot;user-hover&quot; rel=&quot;mshuler&quot;&gt;mshuler&lt;/a&gt; mentioned because now &lt;tt&gt;CL.recover()&lt;/tt&gt; scans the commit log dir twice and even though in this test the archive/restore calls are no-ops, this widens the window for the race to occur.&lt;/p&gt;

&lt;p&gt;So it&apos;s only the (ab)use of &lt;tt&gt;resetUnsafe()&lt;/tt&gt; coupled with the way that &lt;tt&gt;recover()&lt;/tt&gt; expects the segments it replays to be unmanaged that causes this problem. The simplest fix right now is to add another &lt;tt&gt;resetUnsafe()&lt;/tt&gt; to the tests so that each starts with a clean CL, avoiding the possibility of reusing a segment that has already been recycled.&lt;/p&gt;

&lt;p&gt;This is something to keep in mind with regard to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7232&quot; title=&quot;Enable live replay of commit logs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7232&quot;&gt;CASSANDRA-7232&lt;/a&gt; if we start replaying commit logs outside of a restart.&lt;/p&gt;</comment>
                            <comment id="14188244" author="beobal" created="Wed, 29 Oct 2014 11:11:54 +0000"  >&lt;p&gt;With the attached patch I haven&apos;t seen a failure in 100+ loops over the tests, whereas I was getting a failure every 20-40 runs without&lt;/p&gt;</comment>
                            <comment id="14188446" author="jbellis" created="Wed, 29 Oct 2014 15:24:02 +0000"  >&lt;p&gt;LGTM, committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12677870" name="8176.txt" size="2127" author="samt" created="Wed, 29 Oct 2014 11:11:54 +0000"/>
                            <attachment id="12676619" name="RecoveryManagerTest_failure_system.log.gz" size="12871" author="mshuler" created="Thu, 23 Oct 2014 16:59:10 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 3 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i21i73:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327256">2.1.0</customfieldvalue>
    <customfieldvalue id="12326774">2.1.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>