<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:47:49 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7744] Dropping the last collection column turns CompoundSparseCellNameType$WithCollection into CompoundDenseCellNameType</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7744</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Dropping the last collection column turns CompoundSparseCellNameType$WithCollection into CompoundDenseCellNameType&lt;/p&gt;

&lt;p&gt;To reproduce&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh:test&amp;gt; create table test (id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; primary key, col map&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;);
cqlsh:test&amp;gt; alter table test drop col;
cqlsh:test&amp;gt; alter table test add col list&amp;lt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;&amp;gt;;
code=2200 [Invalid query] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;Cannot add &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; column to a COMPACT STORAGE table&quot;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12733277">CASSANDRA-7744</key>
            <summary>Dropping the last collection column turns CompoundSparseCellNameType$WithCollection into CompoundDenseCellNameType</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                    </labels>
                <created>Mon, 11 Aug 2014 16:39:33 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:37 +0000</updated>
                            <resolved>Mon, 18 Aug 2014 12:40:39 +0000</resolved>
                                        <fixVersion>2.0.10</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14094007" author="slebresne" created="Tue, 12 Aug 2014 12:12:41 +0000"  >&lt;p&gt;This has to do with the detection of whether a table is dense or not. In this particular instance, the problem is that for a table with no regular column (like is the case after the drop), we base that &quot;is dense&quot; detection on the comparator: it&apos;s considered dense unless the comparator is &lt;tt&gt;CompositeType(UTF8Type)&lt;/tt&gt; because that is the comparator we except if you create a CQL table with only a partition key. Except that, due to reasons explained in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6276&quot; title=&quot;CQL: Map can not be created with the same name as a previously dropped list&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6276&quot;&gt;&lt;del&gt;CASSANDRA-6276&lt;/del&gt;&lt;/a&gt;, the comparator after the drop is &lt;tt&gt;CompositeType(UTF8Type, ColumnToCollectionType(...))&lt;/tt&gt; and hence the &quot;detection&quot; fails and the table is reported &quot;dense&quot;, which is wrong.&lt;/p&gt;

&lt;p&gt;But the more general problem is that this detection business is overly fragile for no reason. At least for table created from CQL, we know at creation if the table should be dense or not, and this should not change, so we should simply save that information (we should have done that a long time ago tbh). So anyway, attaching a patch that does that and fix this particular issue.&lt;/p&gt;</comment>
                            <comment id="14094576" author="iamaleksey" created="Tue, 12 Aug 2014 19:47:32 +0000"  >&lt;p&gt;Haven&apos;t dug into it, but the patch breaks CliTest, in a legit way:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; [junit] Caused by: java.lang.IndexOutOfBoundsException: Index: 0, Size: 0
 [junit] 	at java.util.ArrayList.rangeCheck(ArrayList.java:635)
 [junit] 	at java.util.ArrayList.set(ArrayList.java:426)
 [junit] 	at org.apache.cassandra.config.CFMetaData.rebuildCQL3Metadata(CFMetaData.java:1981)
 [junit] 	at org.apache.cassandra.config.CFMetaData.rebuild(CFMetaData.java:1947)
 [junit] 	at org.apache.cassandra.config.CFMetaData.apply(CFMetaData.java:1117)
 [junit] 	at org.apache.cassandra.config.CFMetaData.reload(CFMetaData.java:1046)
 [junit] 	at org.apache.cassandra.db.DefsTables.updateColumnFamily(DefsTables.java:377)
 [junit] 	at org.apache.cassandra.db.DefsTables.mergeColumnFamilies(DefsTables.java:318)
 [junit] 	at org.apache.cassandra.db.DefsTables.mergeSchema(DefsTables.java:183)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14094623" author="snazy" created="Tue, 12 Aug 2014 20:36:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; not sure if it&apos;s correct:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;comment out CFMetaData:1961: &lt;tt&gt;//if (isDense == null)&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;change L1981 to 
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;                    int ckIdx = def.componentIndex == null ? 0 : def.componentIndex;
                    if (ckIdx &amp;lt; ckCols.size())
                        ckCols.set(ckIdx, def);
                    else
                        ckCols.add(def);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;CliTest test runs through all tests afterwards.&lt;/p&gt;</comment>
                            <comment id="14094687" author="iamaleksey" created="Tue, 12 Aug 2014 21:12:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt; the goal isn&apos;t to make the test pass - it&apos;s to fix the underlying problem.&lt;/p&gt;</comment>
                            <comment id="14094714" author="snazy" created="Tue, 12 Aug 2014 21:33:29 +0000"  >&lt;p&gt;Yes - the patch introduced the &quot;isDense&quot; field caching. It&apos;s set directly by CreateTableStatement. And it&apos;s set implicitly in rebuildCQL3Metadata - but only once - a second call to rebuildCQL3Metadata (or the first after CreateTableStatement) would not change the dense-setting and cause the failure.&lt;/p&gt;</comment>
                            <comment id="14094948" author="iamaleksey" created="Wed, 13 Aug 2014 00:31:29 +0000"  >&lt;p&gt;Well, no, it has nothing to do with CreateTableStatement, being CliTest, and everything to do with Thrift.&lt;/p&gt;

&lt;p&gt;The following sequence is enough to reproduce:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;create column family test with comparator=UTF8Type and column_metadata=[{ column_name:test, validation_class:BytesType}];
update column family test with comparator=UTF8Type and column_metadata=[];
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The CF remains sparse after the update, but the automatically added clustering column is now OOB because of&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; nbCkCols = isDense
                     ? comparator.componentsCount()
                     : comparator.componentsCount() - (hasCollection() ? 2 : 1);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Problem is of course that CFMetaData#fromThriftForUpdate() called CFMetaData#rebuild() which didn&apos;t know yet at that stage about the old CF being sparse, so it auto-created a clustering column thinking it was dense.&lt;/p&gt;

&lt;p&gt;So it&apos;s the inverse, really - the bug caused by the value not persisting. The table turns from sparse to dense in the end.&lt;/p&gt;

&lt;p&gt;Several ways to deal with this - from rejecting updates like this (we don&apos;t allow removing columns from COMPACT STORAGE via CQL3, this would be consistent), to making sure that sparseness/denseness always persists through updates via Thrift.&lt;/p&gt;</comment>
                            <comment id="14095242" author="snazy" created="Wed, 13 Aug 2014 07:30:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; thanks for the explanation. IMO since it seems that it never worked before, I&apos;d prefer the first option (reject such updates).&lt;/p&gt;</comment>
                            <comment id="14095436" author="slebresne" created="Wed, 13 Aug 2014 12:55:02 +0000"  >&lt;p&gt;Yes, we need to preserver denseness through thrift update too. Updated the patch to does that (it just adds one line in &lt;tt&gt;CFMetadata.fromThriftForUpdate&lt;/tt&gt;).&lt;/p&gt;</comment>
                            <comment id="14095472" author="slebresne" created="Wed, 13 Aug 2014 13:43:12 +0000"  >&lt;p&gt;Actually, scratch that. I don&apos;t think preserving denseness for thrift is the safest choice. All we want to ensure here is that for CQL tables (which can&apos;t be updated from thrift) we can&apos;t change our mind on denseness. So let&apos;s leave thrift table from now and have thrift update recompute denseness for each update. This is what the inital patch was doing but the bug of that initial version was just that isDense was not properly set in &lt;tt&gt;CFMetadata.apply&lt;/tt&gt;. I&apos;ve updated the patch to fix that.&lt;/p&gt;</comment>
                            <comment id="14097696" author="iamaleksey" created="Thu, 14 Aug 2014 21:28:12 +0000"  >&lt;p&gt;Oh well. I guess we still have an issue with Thrift, but it&apos;s older than 7744, so should be handled separately.&lt;/p&gt;

&lt;p&gt;The patch LGTM, with tiny nits:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;should probably add isDense to CFM#equals() and CFM#toString()&lt;/li&gt;
	&lt;li&gt;&quot;method does it&apos;s best&quot; should read &quot;method does its best&quot;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14100590" author="slebresne" created="Mon, 18 Aug 2014 12:40:39 +0000"  >&lt;p&gt;Committed with nits fixed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12661449" name="7744.txt" size="10307" author="slebresne" created="Wed, 13 Aug 2014 13:43:12 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411305</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1yrfr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>411297</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326830">2.0.9</customfieldvalue>
    <customfieldvalue id="12327541">2.1 rc5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>