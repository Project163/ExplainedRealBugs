<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:33:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3882] avoid distributed deadlock in migration stage</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3882</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This is follow-up work for the remainders of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3832&quot; title=&quot;gossip stage backed up due to migration manager future de-ref&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3832&quot;&gt;&lt;del&gt;CASSANDRA-3832&lt;/del&gt;&lt;/a&gt; which was only a partial fix. The deadlock in the migration stage needs to be fixed, as it can cause bootstrap (at least) to take potentially a very very long time to complete, and might also cause a lack of schema propagation until otherwise &quot;poked&quot;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12541956">CASSANDRA-3882</key>
            <summary>avoid distributed deadlock in migration stage</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="richardlow">Richard Low</assignee>
                                    <reporter username="scode">Peter Schuller</reporter>
                        <labels>
                    </labels>
                <created>Thu, 9 Feb 2012 10:36:39 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:40 +0000</updated>
                            <resolved>Fri, 1 Jun 2012 10:56:42 +0000</resolved>
                                        <fixVersion>1.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13272058" author="scode" created="Thu, 10 May 2012 03:33:01 +0000"  >&lt;p&gt;Attaching a pure hack that works around this on large clusters (schema migrations are essentially impossible/useless on large clusters without it).&lt;/p&gt;

&lt;p&gt;It is not a clean solution, but it was very fast to hack together, should be very safe, and solves our burning problem. It simply spreads out migration tasks slowly over time so that the probability of triggering deadlocks becomes vastly smaller. (We&apos;re also running with a hack to make the timeout on migration messages be 500 ms.)&lt;/p&gt;

&lt;p&gt;You&apos;ll tend to see schema converging very quickly, and then see a flurry of secondly memtable flushes as it processes rectification in the background, even though they don&apos;t actually &quot;do&quot; anything to the schema.&lt;/p&gt;</comment>
                            <comment id="13272059" author="scode" created="Thu, 10 May 2012 03:36:29 +0000"  >&lt;p&gt;Let me clarify: I&apos;m not suggesting this be committed. I am merely posting it so that others in this position may be helped. Unfortunately I do not have the time to work on a clean solution, but I wanted to at least share the hack instead of sitting on it.&lt;/p&gt;</comment>
                            <comment id="13272077" author="jbellis" created="Thu, 10 May 2012 04:31:03 +0000"  >&lt;p&gt;Remind me what problem we&apos;re solving post-3832?&lt;/p&gt;</comment>
                            <comment id="13272098" author="scode" created="Thu, 10 May 2012 05:33:24 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3832&quot; title=&quot;gossip stage backed up due to migration manager future de-ref&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3832&quot;&gt;&lt;del&gt;CASSANDRA-3832&lt;/del&gt;&lt;/a&gt; avoided the &lt;b&gt;gossip&lt;/b&gt; stage being backed up as a result of distributed migration manager deadlock, by having the schema rectification be executed asynchronously with respect to the gossip stage. This allowed bootstrap to complete, among other things (&quot;other things&quot; being anything blocking on gossip stage getting to execute incoming tasks).&lt;/p&gt;

&lt;p&gt;As indicated in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3832&quot; title=&quot;gossip stage backed up due to migration manager future de-ref&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3832&quot;&gt;&lt;del&gt;CASSANDRA-3832&lt;/del&gt;&lt;/a&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3832?focusedCommentId=13201012&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13201012&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-3832?focusedCommentId=13201012&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13201012&lt;/a&gt;) there was still the underlying distributed deadlock (or almost deadlock, since timeouts allow it to eventually complete) in the migration stage itself.&lt;/p&gt;

&lt;p&gt;The posted hack is band-aid for that problem. We&apos;re still doing useless work performing migration:s beyond what is required, and it doesn&apos;t &lt;b&gt;eliminate&lt;/b&gt; the problem - just makes it vastly less likely.&lt;/p&gt;</comment>
                            <comment id="13272367" author="jbellis" created="Thu, 10 May 2012 14:17:43 +0000"  >&lt;p&gt;Quoting from 3832: &quot;&lt;span class=&quot;error&quot;&gt;&amp;#91;the deadlock&amp;#93;&lt;/span&gt; is because all nodes, when a node is marked alive, just know that it has a different schema - not who has the &quot;newer&quot; schema. So when a node joins it gets migration messages from others while it also tries to send migration messages to others and waiting on the response. Whenever it sends a migration message to someone whose migration stage is busy waiting on a response from the node in question - deadlock (until timeout).&quot;&lt;/p&gt;</comment>
                            <comment id="13272435" author="scode" created="Thu, 10 May 2012 15:55:33 +0000"  >&lt;p&gt;I&apos;m not sure what your intention is with the quote. If you mean that it implies it&apos;s only during bootstrap, it&apos;s because I was only considering bootstrap at the time and didn&apos;t think far enough to realize this would be a problem in general for schema changes.&lt;/p&gt;

&lt;p&gt;The empirical observation is that all nodes are stuck with lots of migrationstage pending, schema requests time out, schema updates at CLI sit there forever, and it very very very slowly recovers since each guy is waiting on RPC timeout (depending on said timeout).&lt;/p&gt;

&lt;p&gt;jstacking shows waiting in the migration stage on that future, for a response.&lt;/p&gt;</comment>
                            <comment id="13272454" author="jbellis" created="Thu, 10 May 2012 16:17:47 +0000"  >&lt;p&gt;My intention was only to clarify what problem we&apos;re trying to solve here, so everyone doesn&apos;t have to xref w/ 3832.&lt;/p&gt;</comment>
                            <comment id="13273685" author="jbellis" created="Fri, 11 May 2012 22:36:29 +0000"  >&lt;p&gt;Why do we have block-for-response at all?  Would anything break if we just made the response processing asynchronous?&lt;/p&gt;</comment>
                            <comment id="13280105" author="richardlow" created="Mon, 21 May 2012 11:59:22 +0000"  >&lt;p&gt;I have observed this problem too, and have implemented and tested Jonathan&apos;s suggestion of processing the response asynchronously.  I have a simple reproduction that works about 50% of the time:&lt;/p&gt;

&lt;p&gt;1. Create a two node cluster (nodes A and B)&lt;br/&gt;
2. Create a keyspace&lt;br/&gt;
3. Take down A and wipe its data and commit log directories&lt;br/&gt;
4. Bring up A&lt;br/&gt;
5. A never learns about the keyspace&lt;/p&gt;

&lt;p&gt;The issue is that when A restarts, it sends a MIGRATION_REQUEST message to B.  But B also sends the message to A at about the same time.  Since the processing of this is done synchronously in MigrationTask, the single thread on the MigrationStage is blocked on both A and B.  The messages timeout and retry, and after 30 seconds it gives up.&lt;/p&gt;

&lt;p&gt;The simple solution is to process the response asynchronously - the patch &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3882&quot; title=&quot;avoid distributed deadlock in migration stage&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3882&quot;&gt;&lt;del&gt;CASSANDRA-3882&lt;/del&gt;&lt;/a&gt;-async.patch makes this change.  With this, node A always learns about the new keyspace very quickly after restarting.&lt;/p&gt;

&lt;p&gt;As a general rule, only async processing should be done on stages, otherwise distributed deadlocks are very likely.&lt;/p&gt;

&lt;p&gt;Peter, is this the same issue you were seeing?&lt;/p&gt;

&lt;p&gt;I can&apos;t think of anything that should break doing this asynchronously - DefsTable.mergeSchema is static synchronized so it looks safe.&lt;/p&gt;</comment>
                            <comment id="13281373" author="scode" created="Wed, 23 May 2012 02:48:49 +0000"  >&lt;p&gt;Yes, that is the issue I&apos;m seeing. And I completely agree about synchronous (with respect to other nodes) operations on stages.&lt;/p&gt;

&lt;p&gt;I also agree that I can&apos;t think of why specifically this would be unsafe to do asynchronously; I was just taking the ultra-conservative approach.&lt;/p&gt;

&lt;p&gt;Looked through the patch very briefly and it seems reasonable, but I haven&apos;t looked at it carefully or tested it. One thing I&apos;m concerned with for large clusters is the total number of messages back and fourth, since I believe it ends up being quadratic in cluster size. That said, maybe that&apos;s okay up to at least several hundred nodes.&lt;/p&gt;</comment>
                            <comment id="13281374" author="scode" created="Wed, 23 May 2012 02:49:38 +0000"  >&lt;p&gt;I will try to look at it more closely/test it, but if I can&apos;t make it by thursday or so it&apos;s likely to not happen until a week or two later.&lt;/p&gt;</comment>
                            <comment id="13287322" author="slebresne" created="Fri, 1 Jun 2012 10:56:42 +0000"  >&lt;p&gt;Looks good to me, +1. Committed, thanks.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;One thing I&apos;m concerned with for large clusters is the total number of messages back and fourth&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s a separate problem so let&apos;s leave that for some other ticket.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12540842">CASSANDRA-3832</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12528412" name="CASSANDRA-3882-async.patch" size="3403" author="richardlow" created="Mon, 21 May 2012 12:00:02 +0000"/>
                            <attachment id="12526291" name="CASSANDRA-3882-hack.txt" size="3453" author="scode" created="Thu, 10 May 2012 03:33:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[richardlow]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>227243</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 25 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gpdr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95542</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>