<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6447] SELECT someColumns FROM table results in AssertionError in AbstractQueryPager.discardFirst</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6447</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I have a query which must read all the rows from the table:&lt;br/&gt;
Query: &quot;SELECT key, col1, col2, col3 FROM mytable&quot;&lt;/p&gt;

&lt;p&gt;Here is the corresponding code (this is using datastax driver):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ResultSet result = session.execute(&lt;span class=&quot;code-quote&quot;&gt;&quot;SELECT key, col1, col2, col3 FROM mytable&quot;&lt;/span&gt;);
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (Row row : result) {
     &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; some work with row
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Messages sent from the client to Cassandra:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;1st: &lt;tt&gt;QUERY SELECT key, col1, col2, col3 FROM mytable([cl=ONE, vals=[], skip=false, psize=5000, state=null, serialCl=ONE])&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;2nd: &lt;tt&gt;QUERY SELECT key, col1, col2, col3 FROM mytable([cl=ONE, vals=[], skip=false, psize=5000, state=java.nio.HeapByteBuffer&lt;span class=&quot;error&quot;&gt;&amp;#91;pos=24 lim=80 cap=410474&amp;#93;&lt;/span&gt;, serialCl=ONE])&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;On the first message, everything is fine, and the server returns 5000 rows.&lt;br/&gt;
On the second message, paging is in progress, and the server fails in AbstractQueryPager.discardFirst: AssertionError (stack trace attached).&lt;/p&gt;

&lt;p&gt;Here is some more info (step by step debugging on reception of 2nd message):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;AbstractQueryPager.fetchPage(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;):
* pageSize=5000, currentPageSize=5001, rows size=5002, liveCount=5001
* containsPreviousLast(rows.get(0)) returns &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;

-&amp;gt; AbstractQueryPager.discardFirst(List&amp;lt;Row&amp;gt;):
* rows size=5002
* first=TreeMapBackedSortedColumns[with TreeMap size=1]

-&amp;gt; AbstractQueryPager.discardHead(ColumnFamily, ...):
* counter = ColumnCounter$GroupByPrefix
* iter.hasNext() returns &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt; (TreeMap$ValueIterator with TreeMap size=1)
* Column c = DeletedColumn
* counter.count() -&amp;gt; c.isLive returns &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt; (c is DeletedColumn)
* counter.live() = 0
* iter.hasNext() returns &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;
* &lt;span class=&quot;code-object&quot;&gt;Math&lt;/span&gt;.min(0, toDiscard==1) returns 0

&amp;lt;- AbstractQueryPager.discardFirst(List&amp;lt;Row&amp;gt;):
* discarded = 0;
* count = newCf.getColumnCount() = 0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;-&amp;gt;  assert discarded == 1 &lt;b&gt;throws AssertionError&lt;/b&gt;&lt;/p&gt;
</description>
                <environment>&lt;p&gt;Cluster: single node server (ubuntu)&lt;br/&gt;
Cassandra version: 2.0.3 (server/client)&lt;br/&gt;
Client: Datastax cassandra-driver-core 2.0.0-rc1&lt;/p&gt;</environment>
        <key id="12682664">CASSANDRA-6447</key>
            <summary>SELECT someColumns FROM table results in AssertionError in AbstractQueryPager.discardFirst</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="julien.ayme@gmail.com">Julien Aym&#233;</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Dec 2013 11:50:59 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:58 +0000</updated>
                            <resolved>Fri, 20 Dec 2013 07:50:27 +0000</resolved>
                                        <fixVersion>2.0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13838837" author="julien.ayme@gmail.com" created="Wed, 4 Dec 2013 11:56:30 +0000"  >&lt;p&gt;the stacktrace&lt;/p&gt;</comment>
                            <comment id="13838838" author="julien.ayme@gmail.com" created="Wed, 4 Dec 2013 11:59:16 +0000"  >&lt;p&gt;I think this issue occurs because the row to discard has only one column, and this column is not live, but I may be wrong here.&lt;/p&gt;</comment>
                            <comment id="13838841" author="julien.ayme@gmail.com" created="Wed, 4 Dec 2013 12:06:44 +0000"  >&lt;p&gt;Also, since newCf.getColumnCount() == 0, the rest of the code is still valid (the row will not be included in the returned Rows).&lt;br/&gt;
Therefore, I think that the assert statement should be transformed to:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; discarded == 1 || discarded == 0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Or that the assert statement should be dropped, since it was introduced in the last commit on AbstractQueryPager: &lt;/p&gt;

&lt;p&gt;See: &lt;a href=&quot;https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commit;h=3c9760bdb986f6c2430adfc13c86ecb75c3246ac&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://git-wip-us.apache.org/repos/asf?p=cassandra.git;a=commit;h=3c9760bdb986f6c2430adfc13c86ecb75c3246ac&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13845283" author="julien.ayme@gmail.com" created="Wed, 11 Dec 2013 10:50:45 +0000"  >&lt;p&gt;Proposed (trivial) patch&lt;/p&gt;</comment>
                            <comment id="13845284" author="julien.ayme@gmail.com" created="Wed, 11 Dec 2013 10:51:41 +0000"  >&lt;p&gt;Updated fix version, since fix should be trivial&lt;/p&gt;</comment>
                            <comment id="13846482" author="slebresne" created="Thu, 12 Dec 2013 17:36:12 +0000"  >&lt;p&gt;I believe the fix is a tiny bit less trivial than that. If the first row in discardFirst has no live data, we need to check the following rows until we find one to discard, otherwise paging would end up return twice the same result. Not sure why discardFirst is not handling that correctly since discardLast is, but anyway, attaching patch to fix (the patch also slightly modify discardLast because it was actually not handling the case where there was less live rows than we want to discard).&lt;/p&gt;</comment>
                            <comment id="13847200" author="julien.ayme@gmail.com" created="Fri, 13 Dec 2013 06:14:57 +0000"  >&lt;p&gt;Thanks for looking into this issue, and sorry for the assumption that this was trivial (I am still not completely familiar with the architecture of Cassandra, but I am trying to dig into it as best as I can).&lt;/p&gt;</comment>
                            <comment id="13853036" author="iamaleksey" created="Thu, 19 Dec 2013 17:06:42 +0000"  >&lt;p&gt;I think we are good this time. +1&lt;/p&gt;</comment>
                            <comment id="13853762" author="slebresne" created="Fri, 20 Dec 2013 07:50:27 +0000"  >&lt;p&gt;Committed thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12618443" name="6447.txt" size="3733" author="slebresne" created="Thu, 12 Dec 2013 17:36:12 +0000"/>
                            <attachment id="12618218" name="cassandra-2.0-6447.patch" size="781" author="julien.ayme@gmail.com" created="Wed, 11 Dec 2013 10:50:45 +0000"/>
                            <attachment id="12616973" name="stacktrace.txt" size="1499" author="julien.ayme@gmail.com" created="Wed, 4 Dec 2013 11:56:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>361921</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 48 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qdxr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362216</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325322">2.0.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>