<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:52:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9136] Improve error handling when table is queried before the schema has fully propagated</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9136</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This error occurs during a rolling upgrade between 2.0.14 and 2.1.4.&lt;/p&gt;

&lt;h3&gt;&lt;a name=&quot;Repo&quot;&gt;&lt;/a&gt;Repo&lt;/h3&gt;
&lt;p&gt;With all the nodes on 2.0.14 make the following tables&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE KEYSPACE test WITH replication = {
  &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;,
  &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;2&apos;&lt;/span&gt;
};

USE test;

CREATE TABLE compact (
  k &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  d &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  PRIMARY KEY ((k), c)
) WITH COMPACT STORAGE;

CREATE TABLE norm (
  k &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  c &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  d &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
  PRIMARY KEY ((k), c)
) ;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then load some data into these tables. I used the python driver&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;from cassandra.cluster &lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; Cluster
s = Cluster().connect()
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; x in range (1000):
    &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; y in range (1000):
       s.execute_async(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO test.compact (k,c,d) VALUES (%d,%d,%d)&quot;&lt;/span&gt;%(x,y,y))
       s.execute_async(&lt;span class=&quot;code-quote&quot;&gt;&quot;INSERT INTO test.norm (k,c,d) VALUES (%d,%d,%d)&quot;&lt;/span&gt;%(x,y,y))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Upgrade one node from 2.0.14 -&amp;gt; 2.1.4&lt;/p&gt;

&lt;p&gt;From the 2.1.4 node, create a new table.&lt;/p&gt;

&lt;p&gt;Query that table&lt;/p&gt;

&lt;p&gt;On the 2.0.14 nodes you get these exceptions because the schema didn&apos;t propagate there.  This exception kills the TCP connection between the nodes.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-19] 2015-04-08 18:48:45,337 CassandraDaemon.java (line 258) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-19,5,main]
java.lang.NullPointerException
	at org.apache.cassandra.db.RangeSliceCommandSerializer.deserialize(RangeSliceCommand.java:247)
	at org.apache.cassandra.db.RangeSliceCommandSerializer.deserialize(RangeSliceCommand.java:156)
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:99)
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:149)
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:131)
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:74)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Run cqlsh on the upgraded node and queries will fail until the TCP connection is established again, easiest to repo with CL = ALL&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh&amp;gt; SELECT count(*) FROM test.norm where k = 22 ;
ReadTimeout: code=1200 [Coordinator node timed out waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; replica nodes&lt;span class=&quot;code-quote&quot;&gt;&apos; responses] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;Operation timed out - received only 1 responses.&quot;&lt;/span&gt; info={&apos;&lt;/span&gt;received_responses&lt;span class=&quot;code-quote&quot;&gt;&apos;: 1, &apos;&lt;/span&gt;required_responses&lt;span class=&quot;code-quote&quot;&gt;&apos;: 2, &apos;&lt;/span&gt;consistency&lt;span class=&quot;code-quote&quot;&gt;&apos;: &apos;&lt;/span&gt;ALL&apos;}
cqlsh&amp;gt; SELECT count(*) FROM test.norm where k = 21 ;
ReadTimeout: code=1200 [Coordinator node timed out waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; replica nodes&lt;span class=&quot;code-quote&quot;&gt;&apos; responses] message=&lt;span class=&quot;code-quote&quot;&gt;&quot;Operation timed out - received only 1 responses.&quot;&lt;/span&gt; info={&apos;&lt;/span&gt;received_responses&lt;span class=&quot;code-quote&quot;&gt;&apos;: 1, &apos;&lt;/span&gt;required_responses&lt;span class=&quot;code-quote&quot;&gt;&apos;: 2, &apos;&lt;/span&gt;consistency&lt;span class=&quot;code-quote&quot;&gt;&apos;: &apos;&lt;/span&gt;ALL&apos;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So connection made:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DEBUG [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-227] 2015-04-09 05:09:02,718 IncomingTcpConnection.java (line 107) Set version &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /10.240.14.115 to 8 (will use 7)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Connection broken by query of table before schema propagated:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-227] 2015-04-09 05:10:24,015 CassandraDaemon.java (line 258) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-227,5,main]
java.lang.NullPointerException
	at org.apache.cassandra.db.RangeSliceCommandSerializer.deserialize(RangeSliceCommand.java:247)
	at org.apache.cassandra.db.RangeSliceCommandSerializer.deserialize(RangeSliceCommand.java:156)
	at org.apache.cassandra.net.MessageIn.read(MessageIn.java:99)
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessage(IncomingTcpConnection.java:149)
	at org.apache.cassandra.net.IncomingTcpConnection.receiveMessages(IncomingTcpConnection.java:131)
	at org.apache.cassandra.net.IncomingTcpConnection.run(IncomingTcpConnection.java:74)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;All query to that node will fail with timeouts now until...&lt;br/&gt;
Connection re-established&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DEBUG [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-228] 2015-04-09 05:11:00,323 IncomingTcpConnection.java (line 107) Set version &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /10.240.14.115 to 8 (will use 7)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now queries work again.&lt;/p&gt;</description>
                <environment>&lt;p&gt;3 Nodes GCE, N1-Standard-2, Ubuntu 12, 1 Node on 2.1.4, 2 on 2.0.14&lt;/p&gt;</environment>
        <key id="12819454">CASSANDRA-9136</key>
            <summary>Improve error handling when table is queried before the schema has fully propagated</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="rspitzer">Russell Spitzer</reporter>
                        <labels>
                    </labels>
                <created>Wed, 8 Apr 2015 20:59:36 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:58 +0000</updated>
                            <resolved>Thu, 7 May 2015 15:33:54 +0000</resolved>
                                        <fixVersion>2.0.15</fixVersion>
                    <fixVersion>2.1.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="14486725" author="JIRAUSER308715" created="Thu, 9 Apr 2015 05:21:32 +0000"  >&lt;p&gt;Updated the description.  The issue here is that queries to a table before schema has propagated break the tcp/ip connection between the nodes with the NPE in o.a.c.db.RangeSliceCommandSerializer.deserialize(RangeSliceCommand.java:247).  Until that connection gets re-established all queries will timeout.&lt;/p&gt;</comment>
                            <comment id="14487720" author="thobbs" created="Thu, 9 Apr 2015 17:36:50 +0000"  >&lt;p&gt;According to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5275&quot; title=&quot;Error validating row DecoratedKey(..., ...)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5275&quot;&gt;&lt;del&gt;CASSANDRA-5275&lt;/del&gt;&lt;/a&gt;, it&apos;s expected behavior to close the connection when a request is made for an unrecognized table.  At the least, we should be checking for the existence of the table when deserializing and throwing an &lt;tt&gt;UnknownColumnFamilyException&lt;/tt&gt; if it&apos;s not found.&lt;/p&gt;

&lt;p&gt;However, this particular error is pretty straightforward to recover from, so I&apos;m not sure why we simply close the connection.  In 2.0 and 2.1, we could read the remainder of the message, log at WARN, and drop the message.  In 3.0, we could use the new Read/WriteFailureException hooks to signal a failure.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; is that unreasonable for some reason that I&apos;m missing?&lt;/p&gt;</comment>
                            <comment id="14488057" author="slebresne" created="Thu, 9 Apr 2015 19:22:30 +0000"  >&lt;p&gt;Am I missing something or this is not at all related to mixed cluster/upgrade? It&apos;s just a case of querying a table before schema agreement has been reached, which well, you shouldn&apos;t do (and we explicitly let that be the client job).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;According to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5275&quot; title=&quot;Error validating row DecoratedKey(..., ...)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5275&quot;&gt;&lt;del&gt;CASSANDRA-5275&lt;/del&gt;&lt;/a&gt;, it&apos;s expected behavior to close the connection when a request is made for an unrecognized table.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Are you sure that was the ticket you meant to link to? That doesn&apos;t seem related to closing connections or not from what I can tell.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In 2.0 and 2.1, we could read the remainder of the message, log at WARN, and drop the message.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;At least for 2.1, I don&apos;t think that&apos;s trivial because we depend on the CFMetaData to deserialize the remainder of the message. In theory, that dependence is not terribly strong and it might be possible to write methods to skip the remainder even if we don&apos;t know the table, but it&apos;s not &lt;em&gt;that&lt;/em&gt; straightforward. I would suspect that&apos;s also not the only message that can have that problem so I would have a preference for a slightly more general solution.&lt;/p&gt;

&lt;p&gt;In practice, we do ship the payload size with messages, so in theory it shouldn&apos;t be too hard to generally skip to the end of the message on error (at least on that kind of error where there is no reason to suspect the connection is screwed), which could be an option. That said, I don&apos;t really mind if you prefer the previous option.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;In 3.0, we could use the new Read/WriteFailureException hooks to signal a failure.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, though we still have to make sure we deserialize the remainder of the message (or skip it somehow).&lt;/p&gt;
</comment>
                            <comment id="14488195" author="thobbs" created="Thu, 9 Apr 2015 20:19:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;Am I missing something or this is not at all related to mixed cluster/upgrade? It&apos;s just a case of querying a table before schema agreement has been reached, which well, you shouldn&apos;t do (and we explicitly let that be the client job).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Well, it&apos;s only related because a table was created on a 2.1 node in a mixed cluster (and a background process started querying it).  I agree that clients shouldn&apos;t query the table until schema agreement is reached, but it would be good to make the consequences for bad behavior a little less drastic.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Are you sure that was the ticket you meant to link to? That doesn&apos;t seem related to closing connections or not from what I can tell.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Bah, I meant &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5725&quot; title=&quot;Silently failing messages in case of schema not fully propagated&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5725&quot;&gt;&lt;del&gt;CASSANDRA-5725&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;At least for 2.1, I don&apos;t think that&apos;s trivial because we depend on the CFMetaData to deserialize the remainder of the message. [...] In practice, we do ship the payload size with messages, so in theory it shouldn&apos;t be too hard to generally skip to the end of the message on error&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yeah, I think taking advantage of the payload size is the simplest option (with a little refactoring).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Yes, though we still have to make sure we deserialize the remainder of the message (or skip it somehow).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right.&lt;/p&gt;
</comment>
                            <comment id="14488232" author="JIRAUSER308715" created="Thu, 9 Apr 2015 20:41:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;Am I missing something or this is not at all related to mixed cluster/upgrade? It&apos;s just a case of querying a table before schema agreement has been reached, which well, you shouldn&apos;t do (and we explicitly let that be the client job).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, I fully admit the code was in the wrong.  The upgrade just makes the disagreement easier to force, as it will never resolve &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;.  But I think an NPE is the wrong thing to happen in any case.  At the least I think we should throw an UnknownColumnFamilyException (with the name in it, would have made this a lot easier to track down).  At best if we can just throw away the query and log a WARN that would be great.&lt;/p&gt;</comment>
                            <comment id="14488730" author="kohlisankalp" created="Fri, 10 Apr 2015 01:39:28 +0000"  >&lt;p&gt;I think title of this JIRA needs to be updated. It will scare people who are about to upgrade to 2.1 &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14489133" author="slebresne" created="Fri, 10 Apr 2015 08:04:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;But I think an NPE is the wrong thing to happen in any case. At the least I think we should throw an UnknownColumnFamilyException (with the name in it, would have made this a lot easier to track down).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Totally agreed.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;it would be good to make the consequences for bad behavior a little less drastic.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t disagree that it would be good. Just remarking that it&apos;s not something client should do, and that I&apos;m not sure I&apos;d qualify the existing behavior as &quot;drastic&quot;. We do kill the connection on that case, but we&apos;ll reconnect right away and queries shouldn&apos;t timeout unless that reconnection takes more than the timeout. Which can happen and is probably what has happened here, but in general reconnecting shouldn&apos;t take forever either, and so that behavior doesn&apos;t seem so horrible to me (I agree 100% with Jeremiah argument above that a better error should be logged however).  Not saying we can&apos;t improve and happy to try it, but I&apos;ll also wait to see how hairy the patch is before giving my opinion on whether I think it&apos;s worth the trouble or not &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="14497030" author="thobbs" created="Wed, 15 Apr 2015 21:19:11 +0000"  >&lt;p&gt;Linking to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8996&quot; title=&quot;dtests should pass on trunk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8996&quot;&gt;&lt;del&gt;CASSANDRA-8996&lt;/del&gt;&lt;/a&gt; because this occasionally causes dtest failures when the default role setup triggers the NPE.&lt;/p&gt;</comment>
                            <comment id="14497108" author="thobbs" created="Wed, 15 Apr 2015 22:07:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; I&apos;ve pushed a couple of commits to a &lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-9136&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; as a basic example of what I would do (not complete or tested).  The first just throws &lt;tt&gt;UnknownColumnFamilyException&lt;/tt&gt;, the second recovers from that error during deserialization.  Does that seem reasonable?&lt;/p&gt;</comment>
                            <comment id="14502902" author="slebresne" created="Mon, 20 Apr 2015 14:19:02 +0000"  >&lt;p&gt;It&apos;s not unreasonable per-se, but the fact that you have to manually pass how much bytes you&apos;ve deserialized when throwing the exception makes this a bit error prone in general imo, even though it&apos;s arguably easy enough to proof check in this particular case (it would also make it slightly more annoying to add support for &lt;tt&gt;EncodedDataInputStream&lt;/tt&gt; if we wanted too for instance, though that&apos;s a minor point).&lt;/p&gt;

&lt;p&gt;The intial idea I had was to use something like &lt;tt&gt;BytesReadTracker&lt;/tt&gt; to make the counting automatic, but I&apos;m married to that idea either though since it adds a small overhead in general which I don&apos;t like.&lt;/p&gt;

&lt;p&gt;Overall, I respect wanting to improve this but I think I&apos;m of the opinion that simply making the error message a lot more clear should be good enough and that it&apos;s not worth trying to be too smart in recovering. Not a strong opinion though, just a data point.&lt;/p&gt;</comment>
                            <comment id="14521761" author="JIRAUSER308715" created="Thu, 30 Apr 2015 16:26:04 +0000"  >&lt;p&gt;I think it would be good to be able to recover.  That would be my preference.  Yes you shouldn&apos;t query before schema has settled, but if you do, I don&apos;t think it shouldn&apos;t break all your other queries.  But a better error message would at least give people a clue to what broke them.&lt;/p&gt;</comment>
                            <comment id="14524258" author="thobbs" created="Fri, 1 May 2015 23:14:48 +0000"  >&lt;p&gt;Since we haven&apos;t decided what the best solution for recovery is and we all agree on the error message part, I&apos;ve opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9289&quot; title=&quot;Recover from unknown table when deserializing internode messages&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9289&quot;&gt;&lt;del&gt;CASSANDRA-9289&lt;/del&gt;&lt;/a&gt; to deal with recovery separately.  I&apos;ll have a patch and test for the error message shortly.&lt;/p&gt;</comment>
                            <comment id="14529442" author="thobbs" created="Tue, 5 May 2015 22:42:05 +0000"  >&lt;p&gt;The attached patches fix the error messages for 2.0 and 2.1.  I&apos;ve also created a &lt;a href=&quot;https://github.com/thobbs/cassandra-dtest/tree/upgrade-schema-change-test&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; to exercise this.&lt;/p&gt;</comment>
                            <comment id="14530074" author="slebresne" created="Wed, 6 May 2015 07:19:51 +0000"  >&lt;p&gt;Patches looks good, though I would make the error messages more clear as to what is likely the issue, adding something along the lines of &quot;If the table was just created, this is likely due to its schema not having fully propagated yet, please wait for schema agreement on table creation&quot;.&lt;/p&gt;</comment>
                            <comment id="14531573" author="thobbs" created="Wed, 6 May 2015 22:29:31 +0000"  >&lt;p&gt;The v2 patches have an updated error message along the lines of what you suggested.&lt;/p&gt;

&lt;p&gt;I also have cassci test runs on the branches (the failures are not regressions):&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-9136-2.0-dtest/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.0 tests&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-9136-2.1-dtest/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;2.1 tests&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14532183" author="slebresne" created="Thu, 7 May 2015 07:41:17 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14532865" author="thobbs" created="Thu, 7 May 2015 15:33:54 +0000"  >&lt;p&gt;Thanks, committed as &lt;tt&gt;58de86bff5&lt;/tt&gt; and merged to 2.1 and trunk.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12783375">CASSANDRA-8996</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12826670">CASSANDRA-9289</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12730986" name="9136-2.0-v2.txt" size="5291" author="thobbs" created="Wed, 6 May 2015 22:29:31 +0000"/>
                            <attachment id="12730635" name="9136-2.0.txt" size="3755" author="thobbs" created="Tue, 5 May 2015 22:40:11 +0000"/>
                            <attachment id="12730987" name="9136-2.1-v2.txt" size="4704" author="thobbs" created="Wed, 6 May 2015 22:29:31 +0000"/>
                            <attachment id="12730636" name="9136-2.1.txt" size="3829" author="thobbs" created="Tue, 5 May 2015 22:40:11 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 28 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2czuv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>