<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:26 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11551] Incorrect counting of pending messages in OutboundTcpConnection</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11551</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Somehow &lt;tt&gt;OutboundTcpConnection.getPendingMessages()&lt;/tt&gt; seems to return a wrong number.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;nodetool netstats
Mode: NORMAL
Not sending any streams.
Read Repair Statistics:
Attempted: 1655
Mismatch (Blocking): 0
Mismatch (Background): 2
Pool Name                    Active   Pending      Completed
Large messages                  n/a         5              0
Small messages                  n/a         0       31534100
Gossip messages                 n/a         0         520393
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Inspection of the heap dump of that node unveiled that all instances of &lt;tt&gt;OutboundTcpConnection.backlog&lt;/tt&gt; are empty but &lt;tt&gt;currentMsgBufferCount&lt;/tt&gt; is &lt;tt&gt;1&lt;/tt&gt; for 5 instances of &lt;tt&gt;OutboundTcpConnection&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Maybe the cause is in &lt;tt&gt;OutboundTcpConnection.run()&lt;/tt&gt; where &lt;tt&gt;drainedMessages.size()&lt;/tt&gt; is called twice but assumed that these are equal.&lt;/p&gt;

&lt;p&gt;/cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="12958045">CASSANDRA-11551</key>
            <summary>Incorrect counting of pending messages in OutboundTcpConnection</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="chovatia.jaydeep@gmail.com">Jaydeepkumar Chovatia</assignee>
                                    <reporter username="snazy">Robert Stupp</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Apr 2016 09:10:04 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:36 +0000</updated>
                            <resolved>Wed, 16 May 2018 21:40:44 +0000</resolved>
                                        <fixVersion>2.2.13</fixVersion>
                    <fixVersion>3.0.17</fixVersion>
                    <fixVersion>3.11.3</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16013903" author="hryhoriev.nick" created="Wed, 17 May 2017 12:09:27 +0000"  >&lt;p&gt;Just want mention that in 3.9 it&apos;s still exist.&lt;/p&gt;</comment>
                            <comment id="16450341" author="chovatia.jaydeep@gmail.com" created="Tue, 24 Apr 2018 18:18:32 +0000"  >&lt;p&gt;I think I&apos;ve found the root cause for this issue,&#160;one possible reason is once we break at &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.11/src/java/org/apache/cassandra/net/OutboundTcpConnection.java#L270&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this point&lt;/a&gt; then &lt;tt&gt;currentMsgBufferCount&lt;/tt&gt; doesn&apos;t get reset and at that time &lt;tt&gt;backlog.size()&lt;/tt&gt; is 0 but &lt;tt&gt;currentMsgBufferCount&lt;/tt&gt; could be &amp;gt; 0 and call to &lt;tt&gt;getPendingMessages&lt;/tt&gt; at this time will give &amp;gt; 0 pending message even though in reality it is none.&lt;/p&gt;

&lt;p&gt;This problem will not happen most likely on &lt;tt&gt;trunk&lt;/tt&gt; because it doesn&apos;t use &lt;tt&gt;currentMsgBufferCount&lt;/tt&gt; instead it directly deals with &lt;tt&gt;backlog.size()&lt;/tt&gt; in &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/net/async/OutboundMessagingConnection.java#L659&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;getPendingMessages&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve fixed this for older branches, please find fix here:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.11&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...jaydeepkumar1984:11551-3.11?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;diff &lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...jaydeepkumar1984:11551-3.0?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;diff &lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...jaydeepkumar1984:11551-2.2?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;diff&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jaydeepkumar1984/cassandra/63&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://circleci.com/gh/jaydeepkumar1984/cassandra/tree/11551-3.11.svg?style=svg&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jaydeepkumar1984/cassandra/65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://circleci.com/gh/jaydeepkumar1984/cassandra/tree/11551-3.0.svg?style=svg&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jaydeepkumar1984/cassandra/69&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://circleci.com/gh/jaydeepkumar1984/cassandra/tree/11551-2.2.svg?style=svg&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &#160;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Jaydeep&lt;/p&gt;</comment>
                            <comment id="16454640" author="chovatia.jaydeep@gmail.com" created="Thu, 26 Apr 2018 18:06:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=hryhoriev.nick&quot; class=&quot;user-hover&quot; rel=&quot;hryhoriev.nick&quot;&gt;hryhoriev.nick&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt; Can you see if my analysis above makes sense?&lt;/p&gt;

&lt;p&gt;Jaydeep&lt;/p&gt;</comment>
                            <comment id="16457081" author="aweisberg" created="Fri, 27 Apr 2018 21:16:38 +0000"  >&lt;p&gt;+1 Your assessment looks correct.&lt;/p&gt;</comment>
                            <comment id="16478151" author="chovatia.jaydeep@gmail.com" created="Wed, 16 May 2018 21:37:51 +0000"  >&lt;p&gt;A gentle ping&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; Is it possible for you to commit this?&lt;/p&gt;

&lt;p&gt;Jaydeep&lt;/p&gt;</comment>
                            <comment id="16478154" author="aweisberg" created="Wed, 16 May 2018 21:40:44 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/81b6c9e994d16e114457dafb85886e03e5d6d2a7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;81b6c9e994d16e114457dafb85886e03e5d6d2a7&lt;/a&gt;. Thanks!&lt;/p&gt;</comment>
                            <comment id="16478199" author="chovatia.jaydeep@gmail.com" created="Wed, 16 May 2018 22:22:20 +0000"  >&lt;p&gt;Thank You! &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[chovatia.jaydeep@gmail.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2vzin:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335694">3.0.7</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aweisberg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>