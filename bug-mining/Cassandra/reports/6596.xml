<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:31:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-20135] Assertion errors on CheckForAbort / QueryCancellationChecker on multiple calls of applyToPartition</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-20135</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We see there are assertion errors thrown in 4.1 at least in StoppingTransformation like these:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
java.lang.RuntimeException: java.lang.AssertionError
        at org.apache.cassandra.net.InboundSink.accept(InboundSink.java:108)
        at org.apache.cassandra.net.InboundSink.accept(InboundSink.java:45)
        at org.apache.cassandra.net.InboundMessageHandler$ProcessMessage.run(InboundMessageHandler.java:430)
        at org.apache.cassandra.concurrent.ExecutionFailure$1.run(ExecutionFailure.java:133)
        at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:142)
        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
        at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
Caused by: java.lang.AssertionError: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at org.apache.cassandra.db.transform.StoppingTransformation.attachTo(StoppingTransformation.java:72)
        at org.apache.cassandra.db.transform.BaseRows.add(BaseRows.java:104)
        at org.apache.cassandra.db.transform.UnfilteredRows.add(UnfilteredRows.java:49)
        at org.apache.cassandra.db.transform.Transformation.add(Transformation.java:198)
        at org.apache.cassandra.db.transform.Transformation.apply(Transformation.java:140)
        at org.apache.cassandra.db.ReadCommand$CheckForAbort.applyToPartition(ReadCommand.java:616)
        at org.apache.cassandra.db.ReadCommand$CheckForAbort.applyToPartition(ReadCommand.java:604)
        at org.apache.cassandra.db.transform.BasePartitions.hasNext(BasePartitions.java:97)
        at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:303)
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.build(ReadResponse.java:201)
        at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:186)
        at org.apache.cassandra.db.ReadResponse.createDataResponse(ReadResponse.java:48)
        at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:337)
        at org.apache.cassandra.db.ReadCommandVerbHandler.doVerb(ReadCommandVerbHandler.java:63)
        at org.apache.cassandra.net.InboundSink.lambda$&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt;$0(InboundSink.java:78)
        at org.apache.cassandra.net.InboundSink.accept(InboundSink.java:97)
        ... 6 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This does not make sense at first sight and it is quite a rabbit hole to go through. If you follow the stacktrace, you see that &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Caused by: java.lang.AssertionError: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at org.apache.cassandra.db.transform.StoppingTransformation.attachTo(StoppingTransformation.java:72)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but ... why? It means that this (1) was called twice because that is the only place where &quot;this.rows&quot; are ever updated in that class (and this.rows is private) which means that &lt;em&gt;something&lt;/em&gt; has to call this twice in a row. Once it sets it just fine and another time it goes to set it again but it fails as it is not null anymore. Hence, the question is why is that set twice?&lt;/p&gt;

&lt;p&gt;The reason is quite elaborative. &quot;attachTo&quot; which throws is ever called in BaseRows#add(Transformation) (2) and just on the next line it calls &quot;super.add(transformation);&quot; which adds that transformation at the end of a stack in Stack class which BaseRows extends.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    void add(Transformation add)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (length == stack.length)
            stack = resize(stack);
        stack[length++] = add;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Next thing we see from the stacktrace is that CheckForAbort.applyToPartition is calling Transformation.apply (3) and what that ultimately does is that it will add itself, again, at the end of the stack (4).&lt;/p&gt;

&lt;p&gt;When we look at that stacktrace as a whole, what it does is that it is iterating over Unfiliteredpartition while building a local data response on a read and as it does so, it calls &quot;BasePartitions.hasNext&quot;. Now we are getting to that ... (5). What &quot;hasNext&quot; is doing is that while this.next is null, it will take the stack and it loops in while by taking &quot;next&quot; from &quot;input&quot; and it applies all the transformations by calling &quot;fs&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.applyToParition(next)&quot;.&lt;/p&gt;

&lt;p&gt;So, there is a stack of transformations and they are called just one after another until some result of &quot;applyToPartition&quot; returns null or we iterated over all transformations. The chain of transformations also include &quot;CheckForAbort&quot; transformation which we added here (6) so what happens is that when we call &quot;applyToPartitions&quot; for the first time on CheckForAbort, it will run just fine, but when that while loop / for loop in BasePartitions is called &lt;em&gt;again&lt;/em&gt; (e.g. we are calling &quot;hasNext&quot; upon iterating in UnfilteredPartitionIterators), then &quot;applyToPartition&quot; for &quot;CheckForAbort&quot; will be called again as well. But CheckForAbort is doing this (7).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; UnfilteredRowIterator applyToPartition(UnfilteredRowIterator partition)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (maybeAbort())
            {
                partition.close();
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            }

            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; Transformation.apply(partition, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Check the last line where it applies itself when it is not aborted:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Transformation.apply(partition, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The application of this stopping transformation to given partition means that it will add that transformation at the end of the stack as we already showed. Then, we will iterate over that stack again upon iterating in BasePartitions, which eventually calls &quot;attachTo&quot; for the second time, hence the assertion error.&lt;/p&gt;

&lt;p&gt;The stack might look like&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
stack[0] = transformation1
stack[1] = transformation2
stack[2] = CheckForAbort
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;then we call &quot;fs&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;.applyToParition(next)&quot; which will modify the stack like this:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
stack[0] = transformation1
stack[1] = transformation2
stack[2] = CheckForAbort
stack[3] = CheckForAbort 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Then we will loop over that again and if I am not mistaken, when we hit stack&lt;span class=&quot;error&quot;&gt;&amp;#91;2&amp;#93;&lt;/span&gt;, it will call applyToPartition on that and it will do &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
stack[0] = transformation1
stack[1] = transformation2
stack[2] = CheckForAbort &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; basically adds itself at the end again
&lt;/span&gt;stack[3] = CheckForAbort 
stack[4] = CheckForAbort 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but we actually never get this far because on adding itself to the stack, we will hit that assertion error. &lt;/p&gt;

&lt;p&gt;I also see that CheckForAbort was replaced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17810&quot; title=&quot;Revise timeout handling on queries triggering timeout introduced by CASSANDRA-7392&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17810&quot;&gt;&lt;del&gt;CASSANDRA-17810&lt;/del&gt;&lt;/a&gt; (8) by QueryCancellationChecker but except some &quot;cosmetic&quot; changes, the logic remains the same. That stopping transformation is applying itself in applyToPartition so I think that this problem is present in 5.0+ too. No transformation is applying itself like that but this one. &lt;/p&gt;

&lt;p&gt;I am not completely sure what we should do about this but two ideas are obvious (with non-zero probability that both of them are wrong)&lt;/p&gt;

&lt;p&gt;1) We apply &lt;em&gt;new instance&lt;/em&gt; of QueryCancellationChecker / CheckForAbort so we will never call attachTo on the &lt;em&gt;same&lt;/em&gt; instance (but then we would end up with a bunch of QueryCancellationChecker / CheckForAbort instances in the stack, brrr)&lt;br/&gt;
2) We will remove &quot;assert&quot; in attachTo in StoppingTransformation so we will enable this to be called twice so we will not throw at least ... &lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/transform/StoppingTransformation.java#L72&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/transform/StoppingTransformation.java#L72&lt;/a&gt;&lt;br/&gt;
(2) &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/transform/BaseRows.java#L104&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/transform/BaseRows.java#L104&lt;/a&gt;&lt;br/&gt;
(3) &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/ReadCommand.java#L627&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/ReadCommand.java#L627&lt;/a&gt;&lt;br/&gt;
(4) &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/transform/Transformation.java#L198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/transform/Transformation.java#L198&lt;/a&gt;&lt;br/&gt;
(5) &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/transform/BasePartitions.java#L87-L109&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/transform/BasePartitions.java#L87-L109&lt;/a&gt;&lt;br/&gt;
(6) &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/ReadCommand.java#L436&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/ReadCommand.java#L436&lt;/a&gt;&lt;br/&gt;
(7) &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/ReadCommand.java#L619-L628&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/ReadCommand.java#L619-L628&lt;/a&gt;&lt;br/&gt;
(8) &lt;a href=&quot;https://github.com/apache/cassandra/commit/f4b69ba0e82bb051e56a92d792142034d9f617f0#diff-554e7dff38b500f5eaed0b9b651c7098c3f8a1bd4f6aca12063eab352e685b9fR690&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/f4b69ba0e82bb051e56a92d792142034d9f617f0#diff-554e7dff38b500f5eaed0b9b651c7098c3f8a1bd4f6aca12063eab352e685b9fR690&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmckenzie&quot; class=&quot;user-hover&quot; rel=&quot;jmckenzie&quot;&gt;jmckenzie&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13601346">CASSANDRA-20135</key>
            <summary>Assertion errors on CheckForAbort / QueryCancellationChecker on multiple calls of applyToPartition</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="smiklosovic">Stefan Miklosovic</assignee>
                                    <reporter username="smiklosovic">Stefan Miklosovic</reporter>
                        <labels>
                    </labels>
                <created>Mon, 9 Dec 2024 09:29:16 +0000</created>
                <updated>Sat, 18 Jan 2025 11:07:24 +0000</updated>
                            <resolved>Sat, 18 Jan 2025 11:07:24 +0000</resolved>
                                        <fixVersion>4.0.16</fixVersion>
                    <fixVersion>4.1.8</fixVersion>
                    <fixVersion>5.0.3</fixVersion>
                    <fixVersion>5.1</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17904100" author="smiklosovic" created="Mon, 9 Dec 2024 10:44:29 +0000"  >&lt;p&gt;By the way ... for exactly what reason are we attaching that stopping transformation to the stack again here? (1). Why don&apos;t we just do (same logic is done in applyToRow already).&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        @Override
        &lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; UnfilteredRowIterator applyToPartition(UnfilteredRowIterator partition)
        {
            maybeCancel();
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; partition;
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I just don&apos;t see the reason why we are trying to attach that all over again. We should just check if we should cancel.&lt;/p&gt;

&lt;p&gt;Also, currently, applyToPartition will never return null because we are returning iterator again by applying that stopping transformation to that iterator, so the logic here (2) will see next as non-null too and it will continue that loop till the end with a side effect of adding that transformation at the end of the stack (which actually fails, because re-attaching is not possible).&lt;/p&gt;

&lt;p&gt;(1) &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/ReadCommand.java#L758&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/ReadCommand.java#L758&lt;/a&gt;&lt;br/&gt;
(2) &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/transform/BasePartitions.java#L97&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/db/transform/BasePartitions.java#L97&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17904159" author="smiklosovic" created="Mon, 9 Dec 2024 13:43:29 +0000"  >&lt;p&gt;I&apos;ve attached PR for trunk but I would like to see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17810&quot; title=&quot;Revise timeout handling on queries triggering timeout introduced by CASSANDRA-7392&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17810&quot;&gt;&lt;del&gt;CASSANDRA-17810&lt;/del&gt;&lt;/a&gt; to be backported to 4.0.x and 4.1.x as well. &lt;/p&gt;</comment>
                            <comment id="17904189" author="jmckenzie" created="Mon, 9 Dec 2024 15:27:05 +0000"  >&lt;p&gt;I&apos;ve worked quite a bit recently with the &lt;tt&gt;StoppingTransformation&lt;/tt&gt; in the paging across tombstones code, but haven&apos;t really delved into &lt;tt&gt;QueryCancellationChecker&lt;/tt&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17810&quot; title=&quot;Revise timeout handling on queries triggering timeout introduced by CASSANDRA-7392&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17810&quot;&gt;&lt;del&gt;CASSANDRA-17810&lt;/del&gt;&lt;/a&gt; was an upstreaming of another author&apos;s work and it&apos;s been 2 years so... brain cache purged =/).&lt;/p&gt;

&lt;p&gt;If neither &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=marcuse&quot; class=&quot;user-hover&quot; rel=&quot;marcuse&quot;&gt;marcuse&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt; have immediate context on that to determine whether removal of that transformation application on the tail end is correct, I can take a look at this maybe next week before I step away for holiday.&lt;/p&gt;

&lt;p&gt;Edit: I&apos;m getting more and more irritated w/JIRA comment formatting. /grumble&lt;/p&gt;</comment>
                            <comment id="17904211" author="smiklosovic" created="Mon, 9 Dec 2024 16:19:51 +0000"  >&lt;p&gt;I think that adding the transformation back as it is done now is OK. When I removed it, cql_test.py::TestCQLSlowQuery::test_local_query started to fail. &lt;/p&gt;

&lt;p&gt;It is enough if we just check if rows / partitions are null if we go to attach in QueryCancellationChecker&lt;/p&gt;

&lt;p&gt;I am running Circle for that as I write this.&lt;/p&gt;</comment>
                            <comment id="17904265" author="smiklosovic" created="Mon, 9 Dec 2024 19:48:23 +0000"  >&lt;p&gt;sneak peek from trunk, not bad ... errors are flakes&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-20135-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-20135-trunk&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java17_pre-commit_tests                         
  &#10003; j17_build                                        4m 32s
  &#10003; j17_cqlsh_dtests_py311                           7m 19s
  &#10003; j17_cqlsh_dtests_py38                             7m 2s
  &#10003; j17_cqlshlib_cython_tests                       10m 16s
  &#10003; j17_cqlshlib_tests                               9m 18s
  &#10003; j17_dtests                                      34m 16s
  &#10003; j17_dtests_vnode                                35m 54s
  &#10003; j17_jvm_dtests                                  26m 21s
  &#10003; j17_unit_tests                                  17m 42s
  &#10003; j17_utests_oa                                   16m 36s
  &#10005; j17_cqlsh_dtests_py311_vnode                     8m 50s
      cqlsh_tests.test_cqlsh_copy.TestCqlshCopy test_bulk_round_trip_with_timeouts
  &#10005; j17_cqlsh_dtests_py38_vnode                      8m 47s
      cqlsh_tests.test_cqlsh_copy.TestCqlshCopy test_bulk_round_trip_with_timeouts
  &#10005; j17_dtests_latest                               35m 32s
      configuration_test.TestConfiguration test_change_durable_writes
  &#10005; j17_jvm_dtests_latest_vnode                      26m 8s
      org.apache.cassandra.distributed.test.tcm.CMSPlacementAfterMoveTest testMoveToCMS
  &#10005; j17_utests_latest                               16m 21s
      org.apache.cassandra.cql3.RandomSchemaTest test                            
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/5092/workflows/4488bd7f-42ed-4946-aaac-b334030017a3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_pre-commit_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17911996" author="smiklosovic" created="Fri, 10 Jan 2025 14:17:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmckenzie&quot; class=&quot;user-hover&quot; rel=&quot;jmckenzie&quot;&gt;jmckenzie&lt;/a&gt; kindly pinging again, would be great if you took a look at this. &lt;/p&gt;</comment>
                            <comment id="17914092" author="smiklosovic" created="Fri, 17 Jan 2025 13:10:53 +0000"  >&lt;p&gt;These are builds after Josh&apos;s suggestions. &lt;/p&gt;

&lt;p&gt;Errors are nothing out of &quot;ordinary&quot;. I am building the rest.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-20135-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-20135-trunk&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java17_pre-commit_tests                         
  &#10003; j17_build                                        4m 55s
  &#10003; j17_cqlsh_dtests_py311                           7m 15s
  &#10003; j17_cqlsh_dtests_py311_vnode                     7m 12s
  &#10003; j17_cqlsh_dtests_py38                            6m 58s
  &#10003; j17_cqlsh_dtests_py38_vnode                       7m 5s
  &#10003; j17_cqlshlib_cython_tests                        8m 39s
  &#10003; j17_cqlshlib_tests                              10m 16s
  &#10003; j17_jvm_dtests_latest_vnode                     19m 39s
  &#10003; j17_unit_tests                                   15m 5s
  &#10003; j17_utests_latest                               14m 36s
  &#10003; j17_utests_oa                                   16m 21s
  &#10005; j17_dtests                                      43m 26s
      compaction_test.TestCompaction test_compaction_throughput
      refresh_test.TestRefresh test_refresh_deadlock_startup
  &#10005; j17_dtests_latest                               39m 19s
      read_repair_test.TestSpeculativeReadRepair test_normal_read_repair
      read_repair_test.TestSpeculativeReadRepair test_quorum_requirement_on_speculated_read
      read_repair_test.TestSpeculativeReadRepair test_speculative_data_request
  &#10005; j17_dtests_vnode                                41m 48s
      compaction_test.TestCompaction test_compaction_throughput
      counter_test.TestCounters test_counter_node_down
  &#10005; j17_jvm_dtests                                  17m 46s
      org.apache.cassandra.fuzz.ring.ConsistentBootstrapTest coordinatorIsBehindTest                            
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/5212/workflows/be9b26ce-5339-4c95-9b2a-0e71c241a9d6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_pre-commit_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17914125" author="jmckenzie" created="Fri, 17 Jan 2025 14:18:16 +0000"  >&lt;p&gt;To anyone that didn&apos;t dig into the PR, I suggested we make calls to attach &lt;tt&gt;BasePartitions&lt;/tt&gt; or &lt;tt&gt;BaseRows&lt;/tt&gt; idempotent if called w/the same object twice and instead throw if someone attempts to attach 2 differing objects to a single &lt;tt&gt;StoppingTransformation&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/transform/StoppingTransformation.java#L62-L74&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. That should give us some flexibility when working around Transformation stacks without violating correctness or giving nasty surprises.&lt;/p&gt;</comment>
                            <comment id="17914167" author="jmckenzie" created="Fri, 17 Jan 2025 16:21:09 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17914317" author="smiklosovic" created="Sat, 18 Jan 2025 10:24:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-20135-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-20135-4.0&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; 
java8_pre-commit_tests                          
  &#10003; j8_build                                         6m 11s
  &#10003; j8_cqlsh-dtests-py2-no-vnodes                    5m 41s
  &#10003; j8_cqlsh-dtests-py2-with-vnodes                  7m 53s
  &#10003; j8_cqlsh_dtests_py3                              5m 49s
  &#10003; j8_cqlsh_dtests_py311                            8m 39s
  &#10003; j8_cqlsh_dtests_py311_vnode                      7m 50s
  &#10003; j8_cqlsh_dtests_py38_vnode                       5m 55s
  &#10003; j8_cqlsh_dtests_py3_vnode                        7m 50s
  &#10003; j8_cqlshlib_tests                                8m 33s
  &#10003; j8_dtests_vnode                                 41m 35s
  &#10003; j8_jvm_dtests                                   14m 55s
  &#10003; j8_unit_tests                                    8m 23s
  &#10003; j8_utests_system_keyspace_directory               8m 7s
  &#10003; j11_unit_tests                                   8m 11s
  &#10003; j11_dtests_vnode                                41m 41s
  &#10003; j11_cqlsh_dtests_py3_vnode                       5m 26s
  &#10003; j11_cqlsh_dtests_py38_vnode                      5m 28s
  &#10003; j11_cqlsh_dtests_py38                            5m 31s
  &#10003; j11_cqlsh_dtests_py311_vnode                     5m 43s
  &#10003; j11_cqlsh_dtests_py311                           5m 29s
  &#10003; j11_cqlsh_dtests_py3                             5m 15s
  &#10003; j11_cqlsh-dtests-py2-with-vnodes                  7m 8s
  &#10003; j11_cqlsh-dtests-py2-no-vnodes                    5m 5s
  &#10005; j8_cqlsh_dtests_py38                             7m 13s
      cqlsh_tests.test_cqlsh_copy.TestCqlshCopy test_bulk_round_trip_with_timeouts
  &#10005; j8_dtests                                        53m 1s
      refresh_test.TestRefresh test_refresh_deadlock_startup
  &#10005; j11_dtests                                      49m 59s
      refresh_test.TestRefresh test_refresh_deadlock_startup
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/5217/workflows/57557da3-1c28-4f1e-848c-2567c9a0649e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java8_pre-commit_tests&lt;/a&gt;&lt;/p&gt;
</comment>
                            <comment id="17914319" author="smiklosovic" created="Sat, 18 Jan 2025 10:26:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-20135-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-20135-4.1&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java8_pre-commit_tests                          
  &#10003; j8_build                                         6m 58s
  &#10003; j8_cqlsh_dtests_py3                              7m 20s
  &#10003; j8_cqlsh_dtests_py311                            7m 10s
  &#10003; j8_cqlsh_dtests_py311_vnode                      7m 36s
  &#10003; j8_cqlsh_dtests_py38                             5m 35s
  &#10003; j8_cqlsh_dtests_py38_vnode                       6m 21s
  &#10003; j8_cqlsh_dtests_py3_vnode                        5m 49s
  &#10003; j8_cqlshlib_cython_tests                         10m 3s
  &#10003; j8_cqlshlib_tests                                8m 19s
  &#10003; j8_dtests_vnode                                 40m 20s
  &#10003; j8_jvm_dtests                                   16m 20s
  &#10003; j8_jvm_dtests_vnode                             13m 20s
  &#10003; j8_simulator_dtests                              1m 46s
  &#10003; j8_unit_tests                                   11m 12s
  &#10003; j8_utests_system_keyspace_directory              9m 59s
  &#10003; j11_unit_tests                                   9m 39s
  &#10003; j11_jvm_dtests_vnode                            13m 30s
  &#10003; j11_jvm_dtests                                  14m 58s
  &#10003; j11_dtests_vnode                                40m 36s
  &#10003; j11_cqlshlib_tests                               6m 19s
  &#10003; j11_cqlshlib_cython_tests                        7m 24s
  &#10003; j11_cqlsh_dtests_py3_vnode                       6m 12s
  &#10003; j11_cqlsh_dtests_py38_vnode                      5m 51s
  &#10003; j11_cqlsh_dtests_py311_vnode                     5m 59s
  &#10003; j11_cqlsh_dtests_py311                           5m 48s
  &#10003; j11_cqlsh_dtests_py3                             5m 43s
  &#10005; j8_dtests                                       50m 51s
      refresh_test.TestRefresh test_refresh_deadlock_startup
  &#10005; j11_dtests                                      52m 47s
      refresh_test.TestRefresh test_refresh_deadlock_startup
  &#10005; j11_cqlsh_dtests_py38                            7m 21s
      cqlsh_tests.test_cqlsh_copy.TestCqlshCopy test_bulk_round_trip_with_timeouts
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/5215/workflows/8926b669-3719-4217-9736-1d711892b996&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java8_pre-commit_tests&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17914321" author="smiklosovic" created="Sat, 18 Jan 2025 10:30:48 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/instaclustr/cassandra/tree/CASSANDRA-20135-5.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-20135-5.0&lt;/a&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java17_pre-commit_tests                         
  &#10003; j17_build                                        4m 17s
  &#10003; j17_cqlsh_dtests_py311_vnode                     6m 33s
  &#10003; j17_cqlsh_dtests_py38                             6m 4s
  &#10003; j17_cqlsh_dtests_py38_vnode                      6m 10s
  &#10003; j17_cqlshlib_cython_tests                        8m 21s
  &#10003; j17_cqlshlib_tests                               6m 53s
  &#10003; j17_dtests_latest                               40m 38s
  &#10003; j17_jvm_dtests                                  22m 56s
  &#10003; j17_jvm_dtests_latest_vnode                      17m 9s
  &#10003; j17_utests_latest                               17m 14s
  &#10003; j17_utests_oa                                   19m 43s
  &#10005; j17_cqlsh_dtests_py311                            8m 2s
      cqlsh_tests.test_cqlsh_copy.TestCqlshCopy test_bulk_round_trip_with_timeouts
  &#10005; j17_dtests                                       33m 5s
      refresh_test.TestRefresh test_refresh_deadlock_startup
  &#10005; j17_dtests_vnode                                44m 35s
  &#10005; j17_unit_tests                                  18m 28s
      org.apache.cassandra.db.commitlog.CommitLogSegmentManagerCDCTest testCompletedFlag
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/5213/workflows/7b5f2142-cd0c-4b52-b276-34f15cf8702b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;java17_pre-commit_tests&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;j17_dtests_vnode passes, there is just one problematic worker who did not finish on time / was stuck but from the results I see it all passed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            42 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1szr4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jmckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348835">NA</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/4bc61e5209d474c50639a4858e273653fbb4e399&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/4bc61e5209d474c50639a4858e273653fbb4e399&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;CI&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>