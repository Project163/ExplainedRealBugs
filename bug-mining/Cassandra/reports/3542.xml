<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:53:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9321] Aggregate UDFs allow SFUNC return type to differ from STYPE if FFUNC specified</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9321</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When a final function is specified in an aggregate C* allows the return type of the state function to not match the state type.  &lt;/p&gt;

&lt;p&gt;Allowing the mismatch if a final function is specified seems to be intentional as if you don&apos;t provide a final function and you provide a state function with a return type that doesn&apos;t match the state type, then C* gives you an error that states that they must match &quot;unless a final function is specified&quot;.  &lt;/p&gt;

&lt;p&gt;It seems incorrect regardless of whether or not a final function is present to allow the state functions return type to vary from state type.  And indeed if you do so it produces an error when you try to use the aggregate.&lt;/p&gt;

&lt;p&gt;Here is a simple example that shows the problem:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE OR REPLACE FUNCTION state_func(state &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, p2 &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
RETURNS &lt;span class=&quot;code-object&quot;&gt;double&lt;/span&gt; LANGUAGE java AS &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Double&lt;/span&gt;.valueOf(1.0);&apos;&lt;/span&gt;;

CREATE OR REPLACE FUNCTION final_func(state &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;)
RETURNS &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
LANGUAGE java
AS &lt;span class=&quot;code-quote&quot;&gt;&apos;&lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.valueOf(1);&apos;&lt;/span&gt;;

CREATE OR REPLACE AGGREGATE my_aggregate( &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; )
SFUNC state_func
STYPE &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
FINALFUNC final_func
INITCOND 1;

SELECT my_aggregate(column) FROM table;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The select produces the error:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Aggregate &apos;ks.my_aggregate : (int) -&amp;gt; int&apos; exists but hasn&apos;t been loaded successfully for the following reason: Referenced state function &apos;ks.state_func [double, int]&apos; for aggregate &apos;ks.my_aggregate&apos; does not exist.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I was reproducing this with 3.0 trunk, though now I just grabbed the latest and there is an NPE instead of the error above:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException: at index 1
	at com.google.common.collect.ObjectArrays.checkElementNotNull(ObjectArrays.java:240) ~[guava-16.0.jar:na]
	at com.google.common.collect.ImmutableSet.construct(ImmutableSet.java:195) ~[guava-16.0.jar:na]
	at com.google.common.collect.ImmutableSet.of(ImmutableSet.java:116) ~[guava-16.0.jar:na]
	at org.apache.cassandra.cql3.functions.UDAggregate.getFunctions(UDAggregate.java:110) ~[main/:na]
	at org.apache.cassandra.cql3.selection.AbstractFunctionSelector$1.getFunctions(AbstractFunctionSelector.java:78) ~[main/:na]
	at org.apache.cassandra.cql3.selection.SelectorFactories.getFunctions(SelectorFactories.java:105) ~[main/:na]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12827878">CASSANDRA-9321</key>
            <summary>Aggregate UDFs allow SFUNC return type to differ from STYPE if FFUNC specified</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="snazy">Robert Stupp</assignee>
                                    <reporter username="zackurey">Zachary Kurey</reporter>
                        <labels>
                    </labels>
                <created>Thu, 7 May 2015 00:10:26 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:12 +0000</updated>
                            <resolved>Fri, 8 May 2015 20:43:48 +0000</resolved>
                                        <fixVersion>2.2.0 beta 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14532325" author="snazy" created="Thu, 7 May 2015 09:31:05 +0000"  >&lt;p&gt;The attached patch tackles both issues:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;now always checks &lt;tt&gt;STYPE&lt;/tt&gt; against &lt;tt&gt;SFUNC&lt;/tt&gt; return type (argument type is implicitly checked using &lt;tt&gt;Functions.find()&lt;/tt&gt;)&lt;/li&gt;
	&lt;li&gt;the &quot;new NPE&quot;, which is caused by the broken aggregate (&lt;tt&gt;UDAggregate&lt;/tt&gt; could not be initialized - so &lt;tt&gt;stateFunction&lt;/tt&gt; was &lt;tt&gt;null&lt;/tt&gt;)&lt;/li&gt;
	&lt;li&gt;added new utest against the original issue (SFUNC return type and arg type differs)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14532330" author="snazy" created="Thu, 7 May 2015 09:32:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt; can you review?&lt;/p&gt;</comment>
                            <comment id="14533040" author="thobbs" created="Thu, 7 May 2015 17:22:39 +0000"  >&lt;p&gt;Pending test runs:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-9321-merge-dtest/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-9321-merge-testall/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test-all&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14535297" author="thobbs" created="Fri, 8 May 2015 19:11:32 +0000"  >&lt;p&gt;Tests look good (no regressions), +1.&lt;/p&gt;</comment>
                            <comment id="14535475" author="snazy" created="Fri, 8 May 2015 20:43:48 +0000"  >&lt;p&gt;Committed as 40a7e8606eed7664de07653eb962cee3fa77d72b&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12731130" name="9321.txt" size="6018" author="snazy" created="Thu, 7 May 2015 09:31:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 28 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2eedb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324945">2.2.0 beta 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>