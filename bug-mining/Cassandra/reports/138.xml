<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:11:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-392] Deadlock with SelectorManager.doProcess and TcpConnection.write</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-392</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We ran into a deadlock last night:&lt;br/&gt;
Name: MESSAGE-SERIALIZER-POOL:2&lt;br/&gt;
State: BLOCKED on sun.nio.ch.SelectionKeyImpl@2e257f1b owned by: TCP Selector Manager&lt;br/&gt;
Total blocked: 1  Total waited: 1&lt;/p&gt;

&lt;p&gt;Stack trace: &lt;br/&gt;
org.apache.cassandra.net.SelectionKeyHandler.turnOnInterestOps(SelectionKeyHandler.java:73)&lt;br/&gt;
org.apache.cassandra.net.TcpConnection.write(TcpConnection.java:186)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked org.apache.cassandra.net.TcpConnection@5ab9f791&lt;br/&gt;
org.apache.cassandra.net.MessageSerializationTask.run(MessageSerializationTask.java:67)&lt;br/&gt;
java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
java.lang.Thread.run(Thread.java:619)&lt;/li&gt;
&lt;/ul&gt;




&lt;p&gt;Name: TCP Selector Manager&lt;br/&gt;
State: BLOCKED on org.apache.cassandra.net.TcpConnection@5ab9f791 owned by: MESSAGE-SERIALIZER-POOL:2&lt;br/&gt;
Total blocked: 2  Total waited: 0&lt;/p&gt;

&lt;p&gt;Stack trace: &lt;br/&gt;
org.apache.cassandra.net.TcpConnection.connect(TcpConnection.java:360)&lt;br/&gt;
org.apache.cassandra.net.SelectorManager.doProcess(SelectorManager.java:131)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;locked sun.nio.ch.SelectionKeyImpl@2e257f1b&lt;br/&gt;
org.apache.cassandra.net.SelectorManager.run(SelectorManager.java:98)&lt;/li&gt;
&lt;/ul&gt;



&lt;p&gt;The SelectionManager.doProcess acquires a monitor on the SelectionKey and then calls methods such as TcpConnection.connect(SelectionKey key) which obtains a monitor for the TcpConnection object itself.  Another task eg: MessageSerializationTask can come along and call write(Message message) which obtains a monitor for the TCPConnection first and then on calls to turnOnInterestOps tries to obtain the monitor for the SelectionKey which causes the deadlock.&lt;/p&gt;

</description>
                <environment></environment>
        <key id="12434078">CASSANDRA-392</key>
            <summary>Deadlock with SelectorManager.doProcess and TcpConnection.write</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="junrao">Jun Rao</assignee>
                                    <reporter username="sammy.yu">Sammy Yu</reporter>
                        <labels>
                    </labels>
                <created>Wed, 26 Aug 2009 18:35:15 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:34 +0000</updated>
                            <resolved>Mon, 31 Aug 2009 15:49:20 +0000</resolved>
                                        <fixVersion>0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12748085" author="sammy.yu" created="Wed, 26 Aug 2009 18:57:30 +0000"  >&lt;p&gt;For TcpConnection.write(Message) moved turnOnInterestOps outside of synchronized block so that call only depends on having the SelectionKey monitor.&lt;/p&gt;
</comment>
                            <comment id="12748181" author="junrao" created="Wed, 26 Aug 2009 22:05:17 +0000"  >&lt;p&gt;In SelectorManager.doProcess(), I don&apos;t see why we need to synchronize on each selection key any more. Within each of the process such as connect, read and write, we already synchronize on the selection key through turnOnInterestOps/turnOffInterestOps (which only holds a short lock on a selection key).&lt;/p&gt;

&lt;p&gt;Attached is a patch that removes the selection key synchronization in SelectorManager(). Sammy, could you give it a try and see it works?&lt;/p&gt;</comment>
                            <comment id="12749194" author="lenn0x" created="Sat, 29 Aug 2009 22:21:16 +0000"  >&lt;p&gt;+1.&lt;/p&gt;

&lt;p&gt;We tested this in production and its working good!. Let&apos;s ship it.&lt;/p&gt;</comment>
                            <comment id="12749529" author="junrao" created="Mon, 31 Aug 2009 15:49:20 +0000"  >&lt;p&gt;commited.&lt;/p&gt;</comment>
                            <comment id="12749886" author="hudson" created="Tue, 1 Sep 2009 12:35:59 +0000"  >&lt;p&gt;Integrated in Cassandra #184 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/184/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/184/&lt;/a&gt;)&lt;br/&gt;
    Deadlock with SelectorManager.doProcess and TcpConnection.write; patch by Sammy Yu and junrao; reviewed by Chris Goffinet for &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12417771" name="0001-CASSANDRA-392-Moved-turnOnInterestOps-outside-of-syn.patch" size="1589" author="sammy.yu" created="Wed, 26 Aug 2009 18:57:30 +0000"/>
                            <attachment id="12417819" name="issue392.patchv2" size="2029" author="junrao" created="Wed, 26 Aug 2009 22:05:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[junrao]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19667</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 13 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fynj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91212</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>