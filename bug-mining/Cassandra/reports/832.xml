<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:20:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2406] Secondary index and index expression problems</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2406</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When I iteratively get data with secondary index and index clause, result of data acquired by consistency level &quot;one&quot; is different from the one by consistency level &quot;quorum&quot;.  The one by consistecy level &quot;one&quot; is correct result.  But the one by consistecy level &quot;quorum&quot; is incorrect and is dropped by Cassandra.  &lt;/p&gt;

&lt;p&gt;You can reproduce the bug by executing attached programs.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;1. Start Cassandra cluster.  It consists of 3 cassandra nodes and distributes data by ByteOrderedPartitioner.  Initial tokens of those nodes are &lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;31&amp;quot;, &amp;quot;32&amp;quot;, &amp;quot;33&amp;quot;&amp;#93;&lt;/span&gt;.&lt;/li&gt;
	&lt;li&gt;2. Create keyspace and column family, according to &quot;create_table.cli&quot;,&lt;/li&gt;
	&lt;li&gt;3. Execute &quot;secondary_index_insertv2.py&quot;, inserting a few hundred columns to cluster&lt;/li&gt;
	&lt;li&gt;4. Execute &quot;secondary_index_checkv2.py&quot; and get data with secondary index and index clause iteratively.  &quot;secondary_index_insertv2.py&quot; and &quot;secondary_index_checkv2.py&quot; require pycassa.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;You will be able to execute  4th &quot;secondary_index_checkv2.py&quot; script with following option so that &lt;br/&gt;
you get data with consistency level &quot;one&quot;.  &lt;/p&gt;

&lt;p&gt;% python &quot;secondary_index_checkv2.py&quot; -one&lt;/p&gt;

&lt;p&gt;On the other hand, to acquire data with consistency level &quot;quorum&quot;, you will need to use following option.  &lt;/p&gt;

&lt;p&gt;% python &quot;secondary_index_checkv2.py&quot; -quorum&lt;/p&gt;

&lt;p&gt;You can check that result of data acquired by consistency level &quot;one&quot; is different from one by consistency level &quot;quorum&quot;.  &lt;/p&gt;</description>
                <environment>&lt;p&gt;CentOS 5.5 (64bit), JDK 1.6.0_23&lt;/p&gt;</environment>
        <key id="12502972">CASSANDRA-2406</key>
            <summary>Secondary index and index expression problems</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xedin">Pavel Yaskevich</assignee>
                                    <reporter username="muga_nishizawa">Muga Nishizawa</reporter>
                        <labels>
                    </labels>
                <created>Thu, 31 Mar 2011 03:18:46 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:03 +0000</updated>
                            <resolved>Mon, 18 Apr 2011 13:28:47 +0000</resolved>
                                        <fixVersion>0.7.5</fixVersion>
                                    <component>Feature/2i Index</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13016847" author="skamio" created="Thu, 7 Apr 2011 13:20:07 +0000"  >&lt;p&gt;an experimental patch&lt;/p&gt;</comment>
                            <comment id="13016849" author="skamio" created="Thu, 7 Apr 2011 13:32:54 +0000"  >&lt;p&gt;I&apos;ve attached an experimental patch. The problem is gone with this patch. But it&apos;s inefficient when a large number of rows are requested.&lt;/p&gt;

&lt;p&gt;The main problem was that the rows collected in ColumnFamilyStore.scan() can have duplicates. So, it returns less unique rows than requested. Then, StorageProxy.scan() asks more results from next range. That means the last returned row gets wrong.&lt;/p&gt;

&lt;p&gt;As for inefficiency of the patch, if the rows are added in order, the uniqueness check should be done only for the last row. But I don&apos;t known if I can assume the order or not. So, please improve the patch if so.&lt;/p&gt;</comment>
                            <comment id="13016878" author="jbellis" created="Thu, 7 Apr 2011 15:34:11 +0000"  >&lt;p&gt;Hmm. There are two ways we could get duplicate rows:&lt;/p&gt;

&lt;p&gt;1. the ranges we iterate through overlap.  but if that were the bug, we would see it on ONE as well as QUORUM&lt;br/&gt;
2. the ReadCallback/RangeSliceResponseResolver object (probably the resolver) returns duplicates from incorrect merging of the quorum replies&lt;/p&gt;

&lt;p&gt;If 2. is the problem we should fix it in callback/resolver instead of in StorageProxy.&lt;/p&gt;

&lt;p&gt;Even with it narrowed down there the problem is not obvious to me &amp;#8211; each response should come back in sorted (token) order, and RSRR uses a collating + reducing iterator to merge duplicates, in theory.&lt;/p&gt;</comment>
                            <comment id="13017244" author="skamio" created="Fri, 8 Apr 2011 02:49:26 +0000"  >&lt;p&gt;I forgot to say, but 1. is right. The duplicate problem is visible on CL.ONE as well.&lt;br/&gt;
The above test script returns rows of &quot;173&quot;, &quot;174&quot;, &quot;174&quot; (duplicate), &quot;175&quot;, &quot;176&quot; in the first iteration. It has duplicate.&lt;br/&gt;
And if you see my debug log attached, ColumnFamilyStore collects the row &quot;174&quot; twice in CL.ONE.&lt;/p&gt;

&lt;p&gt;The only case it works correcly is when I specify start_key. In the above script, set start_key = &quot;173&quot;. The result is &quot;173&quot;, &quot;174&quot;, &quot;175&quot;, &quot;176&quot;, &quot;177&quot; in the first iteration. It is correct, no duplicate.&lt;/p&gt;</comment>
                            <comment id="13017245" author="skamio" created="Fri, 8 Apr 2011 02:52:43 +0000"  >&lt;p&gt;I&apos;ve attached debug log (node-1.system.log) with various debug prints. This is debug log in running the first iteration of test script with CL.ONE. The result has duplicate.&lt;/p&gt;</comment>
                            <comment id="13018868" author="jbellis" created="Tue, 12 Apr 2011 15:24:05 +0000"  >&lt;p&gt;Pavel, can you take a stab at figuring out why the ranges overlap?  They are not supposed to.&lt;/p&gt;

&lt;p&gt;(I am using &lt;a href=&quot;https://github.com/pcmanus/ccm&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pcmanus/ccm&lt;/a&gt; for testing, it saves a lot of time.)&lt;/p&gt;</comment>
                            <comment id="13020310" author="jbellis" created="Fri, 15 Apr 2011 14:33:47 +0000"  >&lt;p&gt;Pavel&apos;s patch fixes a 3rd kind of bug: CFS.scan itself can return duplicate rows, even for a single node and range.  Added a unit test and committed.&lt;/p&gt;

&lt;p&gt;Shotaro, does this fix what you are seeing?&lt;/p&gt;</comment>
                            <comment id="13020902" author="skamio" created="Mon, 18 Apr 2011 04:51:21 +0000"  >&lt;p&gt;Yes, it fixes our problem. Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12475709" name="CASSANDRA-2406-debug.patch" size="1443" author="skamio" created="Thu, 7 Apr 2011 13:20:07 +0000"/>
                            <attachment id="12476234" name="CASSANDRA-2406.patch" size="2057" author="xedin" created="Wed, 13 Apr 2011 13:20:51 +0000"/>
                            <attachment id="12475053" name="create_table.cli" size="250" author="muga_nishizawa" created="Thu, 31 Mar 2011 03:19:38 +0000"/>
                            <attachment id="12475775" name="node-1.system.log" size="37507" author="skamio" created="Fri, 8 Apr 2011 02:52:43 +0000"/>
                            <attachment id="12475055" name="secondary_index_checkv2.py" size="3342" author="muga_nishizawa" created="Thu, 31 Mar 2011 03:20:39 +0000"/>
                            <attachment id="12475054" name="secondary_index_insertv2.py" size="2334" author="muga_nishizawa" created="Thu, 31 Mar 2011 03:20:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[xedin]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20604</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 32 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gb6n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93242</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>