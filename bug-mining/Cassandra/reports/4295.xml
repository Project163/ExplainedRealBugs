<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:03:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11905] Index building fails to start CFS.readOrdering when reading</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11905</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This code for indexing partition when building index in 3.0 is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SinglePartitionReadCommand cmd = SinglePartitionReadCommand.fullPartitionRead(cfs.metadata, FBUtilities.nowInSeconds(), key);

try (OpOrder.Group opGroup = cfs.keyspace.writeOrder.start();
      UnfilteredRowIterator partition = cmd.queryMemtableAndDisk(cfs, opGroup))
{
    cfs.indexManager.indexPartition(partition, opGroup, indexes, cmd.nowInSec());
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;which is clearly incorrect as the &lt;tt&gt;OpOrder&lt;/tt&gt; that &lt;tt&gt;queryMemtableAndDisk&lt;/tt&gt; expects is the one from &lt;tt&gt;cfs.readOrdering&lt;/tt&gt;, not the one for writes on the keyspace.&lt;br/&gt;
This wasn&apos;t a problem prior to 3.0 as the similar code was using the pager, which ended up properly taking the read &lt;tt&gt;OpOrder&lt;/tt&gt; internally but I messed this up in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8099&quot; title=&quot;Refactor and modernize the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8099&quot;&gt;&lt;del&gt;CASSANDRA-8099&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Thanks to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; for pointing that out.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12973341">CASSANDRA-11905</key>
            <summary>Index building fails to start CFS.readOrdering when reading</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Fri, 27 May 2016 08:31:26 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:31 +0000</updated>
                            <resolved>Mon, 30 May 2016 14:18:58 +0000</resolved>
                                        <fixVersion>3.0.7</fixVersion>
                    <fixVersion>3.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15303838" author="slebresne" created="Fri, 27 May 2016 09:45:46 +0000"  >&lt;p&gt;The fix is pretty simple, we just have to grab the read order and pass it to &lt;tt&gt;queryMemtableAndDisk&lt;/tt&gt;, and that&apos;s exactly what I did for 3.0 to optimize for minimum amount of change. On 3.7 however, I took a slightly more aggressive approach that should hopefully protect against that kind of mistake: I removed the &lt;tt&gt;queryMemtableAndDisk&lt;/tt&gt; method that was taking an &lt;tt&gt;OpOrder.Group&lt;/tt&gt;, leaving only the one taking a &lt;tt&gt;ReadExecutionController&lt;/tt&gt;, which should in itself prevent mistakenly passing a write order. But I also make a few (minor overall) additions to &lt;tt&gt;ReadExecutionController&lt;/tt&gt; so we even validate that the controller we use has been properly taken on the right table (to typically prevent misusing a base table &lt;tt&gt;OpOrder.Group&lt;/tt&gt; to read on an index table).&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; 3.0  &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; 3.7 &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11905-3.0-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11905-3.7-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11905-3.0-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-11905-3.7-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Note that tests haven&apos;t yet run as of this writing, and I didn&apos;t started trunk cause it&apos;s basically the same as 3.7 right now.&lt;/p&gt;

&lt;p&gt;I&apos;ll note that since that&apos;s a fairly serious bug (probably don&apos;t reproduce often, but could make us remove a sstable that is still being read, potentially hard-crashing a node if things are mmapped) and since 3.6 hasn&apos;t been voted on yet, we might want to consider including that fix.&lt;/p&gt;</comment>
                            <comment id="15303901" author="stefania" created="Fri, 27 May 2016 10:31:11 +0000"  >&lt;p&gt;+1 on the &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/11905-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0 patch&lt;/a&gt;; the &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/11905-3.7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.7 patch&lt;/a&gt; also looks OK from a quick look, but I will take another look first thing on Monday, as well as checking any CI failures. I agree on pushing it to 3.6 if we can, thank you for producing a patch so quickly!&lt;/p&gt;</comment>
                            <comment id="15306252" author="stefania" created="Mon, 30 May 2016 05:37:04 +0000"  >&lt;p&gt;There is a typo at line 122 of &lt;tt&gt;SinglePartitionSliceCommandTest&lt;/tt&gt;, it should be &lt;tt&gt;pIter.next()&lt;/tt&gt; rather than &lt;tt&gt;partitionIterator.next()&lt;/tt&gt;. This is causing 2 CI failures, the remaining failing tests are all unrelated known failures.&lt;/p&gt;

&lt;p&gt;+1 once the typo in the test is fixed.&lt;/p&gt;</comment>
                            <comment id="15306701" author="slebresne" created="Mon, 30 May 2016 14:18:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;There is a typo at line 122 of &lt;tt&gt;SinglePartitionSliceCommandTest&lt;/tt&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Thanks, and sorry about that. There was a few failures initially due to some test using an empty controller (which, while probably inconsequential in those short tests, was wrong, and so it validates the changes are catching misusages) and I fixed that one too quickly.&lt;/p&gt;

&lt;p&gt;So I committed this and included 3.6 as discussed above. I did only merged the 3.0 patch for 3.6 and 3.7 and left the refactor to trunk: no point in taking risks and arguably such small refactor belongs to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 25 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2yl5z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stefania</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>