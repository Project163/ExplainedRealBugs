<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:09:21 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13603] Change repair midpoint logging from  CASSANDRA-13052</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13603</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13052&quot; title=&quot;Repair process is violating the start/end token limits for small ranges&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13052&quot;&gt;&lt;del&gt;CASSANDRA-13052&lt;/del&gt;&lt;/a&gt; , we changed the way we handle repairs on small ranges to make them more sane in general, but &lt;tt&gt;MerkleTree.differenceHelper&lt;/tt&gt; now erroneously logs at error.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13079879">CASSANDRA-13603</key>
            <summary>Change repair midpoint logging from  CASSANDRA-13052</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jjirsa">Jeff Jirsa</assignee>
                                    <reporter username="jjirsa">Jeff Jirsa</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Jun 2017 20:59:44 +0000</created>
                <updated>Fri, 15 May 2020 08:06:47 +0000</updated>
                            <resolved>Tue, 5 Sep 2017 19:02:14 +0000</resolved>
                                        <fixVersion>3.0.15</fixVersion>
                    <fixVersion>3.11.1</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16049666" author="jjirsa" created="Wed, 14 Jun 2017 21:15:08 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Branch &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Testall &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; Dtest &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/tree/cassandra-3.0-13603&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/jeffjirsa/cassandra/tree/cassandra-3.0-13603&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/88/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;asf dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/tree/cassandra-3.11-13603&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/jeffjirsa/cassandra/tree/cassandra-3.11-13603&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/89/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;asf dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/tree/cassandra-13603&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/jeffjirsa/cassandra/tree/cassandra-13603&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/90/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;asf dtest&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;



&lt;p&gt;For the reviewer: I really have mixed feelings about &lt;tt&gt;MerkleTree.differenceHelper&lt;/tt&gt; in general. In particular, it presumes that there are differences in the trees, which is always true in the existing codepath, but may not be true later if someone misuses it in the future. It seems &lt;a href=&quot;https://github.com/jeffjirsa/cassandra/commit/cee5a2d75e8e867dc20f3d94f0fe5df360210d46&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fairly straightforward&lt;/a&gt; to make it properly handle the case where the trees are consistent for a given range, though I&apos;m not sure it&apos;s necessary.&lt;/p&gt;

&lt;p&gt;Thoughts &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=spodxx%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;spodxx@gmail.com&quot;&gt;spodxx@gmail.com&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; ? &lt;/p&gt;</comment>
                            <comment id="16053833" author="spodxx@gmail.com" created="Mon, 19 Jun 2017 11:37:48 +0000"  >&lt;p&gt;I agree that it&apos;s easy to misuse MerkleTree.differenceHelper(). It should only really be called from MerkleTree.difference() and should have a  &lt;tt&gt;@VisibleForTesting&lt;/tt&gt; annotation to indicate that it&apos;s internal use only. As for the suggested changes around midpoint result handling, I&apos;m not really convinced that we should use this value to check if we should stop tree traversal. Although we should be at a leaf nodes already when getting an invalid midpoint value, we wouldn&apos;t be able to tell otherwise without any kind of error message, blindly following this assumption. This may cover other potential errors.&lt;/p&gt;

&lt;p&gt;We already check &lt;tt&gt;node instanceof Leaf&lt;/tt&gt; before recursively calling differenceHelper() with a sub-range. I&apos;d suggest to do the same in difference(). It just doesn&apos;t make sense to call differenceHelper() with two leaf nodes, doesn&apos;t it?&lt;/p&gt;</comment>
                            <comment id="16056539" author="jjirsa" created="Tue, 20 Jun 2017 21:56:10 +0000"  >&lt;blockquote&gt;
&lt;p&gt;We already check node instanceof Leaf before recursively calling differenceHelper() with a sub-range. I&apos;d suggest to do the same in difference(). It just doesn&apos;t make sense to call differenceHelper() with two leaf nodes, doesn&apos;t it?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think you&apos;re right - pushed a new commit to each branch that checks to see if either node is &lt;tt&gt;instanceof Leaf&lt;/tt&gt; and avoids that tree traversal. Also marked &lt;tt&gt;MerkleTree.differenceHelper&lt;/tt&gt; as &lt;tt&gt;@VisibleForTesting&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;I think this makes the midpoint check below irrelevant, but may protect us from another bug later? Considering switching it to an assert rather than the block that exists now?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (midpoint.equals(active.left) || midpoint.equals(active.right))
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 


</comment>
                            <comment id="16057292" author="spodxx@gmail.com" created="Wed, 21 Jun 2017 10:12:29 +0000"  >&lt;p&gt;We should continue to check the midpoint return value. Even if it&apos;s just for troubleshooting similar problems in the future. &lt;/p&gt;

&lt;p&gt;Throwing an AssertionError instead of just logging an error message is probably not a good idea in 2.2. See my comment from before the patch:&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Unfortunately we can&apos;t throw here to abort the validation process, as the code is executed in it&apos;s own thread with the caller waiting for a condition to be signaled after completion and without an option to indicate an error (2.x only).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;But 3.0+ should be able to deal with failed SyncTasks, as those are now handled as futures. SyncTask.run is currently missing any exception handling, but that could be changed.&lt;/p&gt;</comment>
                            <comment id="16146346" author="jjirsa" created="Tue, 29 Aug 2017 23:39:08 +0000"  >&lt;p&gt;Would love to revisit this.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=spodxx%40gmail.com&quot; class=&quot;user-hover&quot; rel=&quot;spodxx@gmail.com&quot;&gt;spodxx@gmail.com&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt; , pushed rebased versions, and here&apos;s shortcut links to combined diffs for the three branches: &lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...jeffjirsa:cassandra-3.0-13603?ws=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/cassandra-3.0...jeffjirsa:cassandra-3.0-13603?ws=1&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...jeffjirsa:cassandra-3.11-13603?ws=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/cassandra-3.11...jeffjirsa:cassandra-3.11-13603?ws=1&lt;/a&gt; &lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...jeffjirsa:cassandra-13603?ws=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...jeffjirsa:cassandra-13603?ws=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Either of you see anything else you&apos;d like to change that I didn&apos;t catch already? Either of you up to mark yourselves as formal reviewer? &lt;/p&gt;</comment>
                            <comment id="16147802" author="bdeggleston" created="Wed, 30 Aug 2017 18:43:41 +0000"  >&lt;p&gt;I think the current state of &lt;tt&gt;MerkleTree.differenceHelper&lt;/tt&gt; is sort of the wrong approach for what it&apos;s trying to do in general. The current implementation has weird edge cases like this, and is too complex and difficult to follow. Also, it shares some of it&apos;s responsibilities with &lt;tt&gt;difference&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;Really, we&apos;re just trying to recursively compare these trees and record the largest contiguous out of sync ranges. The only complication here is that a given invocation of the method doesn&apos;t know if it&apos;s adjacent range is also out of sync, so it has to defer to the caller to do something if it&apos;s range is &lt;tt&gt;FULLY_INCONSISTENT&lt;/tt&gt;. I put together an alternate implementation &lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/differencer-cleanup&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Having said all that, those changes are out of scope for this ticket and 3.0, so I&apos;m +1 on the changes as proposed, and will open another ticket to refactor differece/differenceHelper.&lt;/p&gt;</comment>
                            <comment id="16147829" author="bdeggleston" created="Wed, 30 Aug 2017 18:51:37 +0000"  >&lt;p&gt;opened &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13830&quot; title=&quot;Simplify MerkleTree.difference/differenceHelper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13830&quot;&gt;CASSANDRA-13830&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16154141" author="jjirsa" created="Tue, 5 Sep 2017 19:02:14 +0000"  >&lt;p&gt;Thanks. Committed as &lt;tt&gt;bc5c2316c5acfc1ee0ef101a3ebf00d03c89e283&lt;/tt&gt; to 3.0 and merged 3.11 and trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jjirsa]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 11 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3ga6f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>bdeggleston</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>