<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:26:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16418] Unsafe to run nodetool cleanup during bootstrap or decommission</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16418</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;What we expected: Running a cleanup is a safe operation; the result of running a query after a cleanup should be the same as the result of running a query before a cleanup.&lt;/p&gt;

&lt;p&gt;What actually happened: We ran a cleanup during a decommission. All the streamed data was silently deleted, the bootstrap did not fail, the cluster&apos;s data after the decommission was very different to the state before.&lt;/p&gt;

&lt;p&gt;Why: Cleanups do not take into account pending ranges and so the cleanup thought that all the data that had just been streamed was redundant and so deleted it. We think that this is symmetric with bootstraps, though have not verified.&lt;/p&gt;

&lt;p&gt;Not sure if this is technically a bug but it was very surprising (and seemingly undocumented) behaviour.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13356435">CASSANDRA-16418</key>
            <summary>Unsafe to run nodetool cleanup during bootstrap or decommission</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="linzuro">Lindsey Zurovchak</assignee>
                                    <reporter username="jebaker">James Baker</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Feb 2021 09:15:44 +0000</created>
                <updated>Wed, 6 Dec 2023 15:37:05 +0000</updated>
                            <resolved>Mon, 23 Jan 2023 22:45:42 +0000</resolved>
                                        <fixVersion>4.0.8</fixVersion>
                    <fixVersion>4.1.1</fixVersion>
                    <fixVersion>5.0-alpha1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                    <component>Consistency/Bootstrap and Decommission</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="12000">3h 20m</timespent>
                                <comments>
                            <comment id="17651377" author="JIRAUSER298539" created="Thu, 22 Dec 2022 18:42:27 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://github.com/apache/cassandra/pull/2061&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;PR&lt;/a&gt; for this and made the following changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Added check during cleanup to ensure the node has no pending ranges before proceeding&lt;/li&gt;
	&lt;li&gt;Bug did not exist for bootstrap due to existing safety check but the check was one level below other safeguard checks so moved it to same location&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17652521" author="paulo" created="Wed, 28 Dec 2022 15:21:56 +0000"  >&lt;p&gt;Nice work &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linzuro&quot; class=&quot;user-hover&quot; rel=&quot;linzuro&quot;&gt;linzuro&lt;/a&gt;! The approach and test looks mostly good to me, added a few comments to the PR.&lt;/p&gt;

&lt;p&gt;Can you add a similar regression test for bootstrap so we can detect if this is ever broken in the future? The test should fail when the bootstrap safeguard is removed. I think you can find some bootstrap dtest examples on &lt;tt&gt;org.apache.cassandra.distributed.test.ring.BootstrapTest&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I have submitted a preliminary CI run for your branch on:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2151/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2151/&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17675737" author="paulo" created="Wed, 11 Jan 2023 22:38:18 +0000"  >&lt;p&gt;In order to check the tests were reliably reproducing the issue on Lindsey&apos;s &lt;a href=&quot;https://github.com/apache/cassandra/pull/2061&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; I commented out the following excerpt:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;        InetAddressAndPort localAddress = FBUtilities.getBroadcastAddressAndPort();
        Integer pendingRangesCount = tokenMetadata.getPendingRanges(keyspaceName, localAddress).size();

        if (pendingRangesCount &amp;gt; 0)
        {
            throw new RuntimeException(&quot;Node is involved in cluster membership changes. Not safe to run cleanup.&quot;);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;And expected both &lt;a href=&quot;https://github.com/apache/cassandra/pull/2061/files#diff-68d2cd75caa0e4091c7206717116594bdcb0aab38f72f6d6afa44eac60466e13R41&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testCleanupFailsDuringOngoingDecommission&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/pull/2061/files#diff-68d2cd75caa0e4091c7206717116594bdcb0aab38f72f6d6afa44eac60466e13R85&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testCleanupFailsDuringOngoingBootstrap&lt;/a&gt; to fail.&lt;/p&gt;

&lt;p&gt;Even though the tests failed most of the time, sometimes the tests passed so data was not being wrongly cleaned up as expected.&lt;/p&gt;

&lt;p&gt;The reason for this is that these tests require that the cleanup is executed between the sstables are transferred by streaming and the ring membership operation is finished. There is a small chance cleanup is not executed within this window so the issue will not reproduce, especially if we run this test on faster hardware.&lt;/p&gt;

&lt;p&gt;I took a slightly different testing approach on &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/blob/702f77d247893a51461823268ad6a20cd6c1a021/test/distributed/org/apache/cassandra/distributed/test/ring/CleanupFailureTest.java#L40&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this commit&lt;/a&gt; that inserts data while a node is bootstrapping or decommissioning and checks the data is present after a cleanup is run. This was able to reliably reproduce the issue when the excerpt above is commented out.&lt;/p&gt;

&lt;p&gt;The updated test is more deterministic because we don&apos;t depend on streaming nor timing. Furthermore this makes the test faster since we don&apos;t need so many rows to reproduce the issue, which is needed with the streaming approach.&lt;/p&gt;

&lt;p&gt;A nice benefit of this approach is that since we only run cleanup a single time while the node is bootstrapping/decommissioning, we&apos;re able to &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/blob/702f77d247893a51461823268ad6a20cd6c1a021/test/distributed/org/apache/cassandra/distributed/test/ring/CleanupFailureTest.java#L105&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;verify that the cleanup fails with the expected error message&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17675740" author="paulo" created="Wed, 11 Jan 2023 22:41:35 +0000"  >&lt;p&gt;I rebased and squashed Lindsey&apos;s commit &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/tree/CASSANDRA-16418&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;on this branch&lt;/a&gt; + updated tests &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/702f77d247893a51461823268ad6a20cd6c1a021&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;from this commit&lt;/a&gt; and submitted CI on &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/tree/CASSANDRA-16418&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/pauloricardomg/cassandra/tree/CASSANDRA-16418&lt;/a&gt; (still queued).&lt;/p&gt;

&lt;p&gt;I think this is ready for a second round of review. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=JoshuaMcKenzie&quot; class=&quot;user-hover&quot; rel=&quot;JoshuaMcKenzie&quot;&gt;JoshuaMcKenzie&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt; would you have cycles to take a look?&lt;/p&gt;</comment>
                            <comment id="17675941" author="smiklosovic" created="Thu, 12 Jan 2023 10:56:03 +0000"  >&lt;p&gt;could you please create a PR from your branch so we may potentially comment on it? &lt;/p&gt;</comment>
                            <comment id="17676706" author="smiklosovic" created="Fri, 13 Jan 2023 17:22:53 +0000"  >&lt;p&gt;I ve commented on this &lt;a href=&quot;https://github.com/apache/cassandra/pull/2061/files&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2061/files&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I am +1 on successful build.&lt;/p&gt;

&lt;p&gt;Comments in the PR are just nits, I leave this to the author&apos;s discretion.&lt;/p&gt;</comment>
                            <comment id="17677879" author="smiklosovic" created="Tue, 17 Jan 2023 18:16:22 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linzuro&quot; class=&quot;user-hover&quot; rel=&quot;linzuro&quot;&gt;linzuro&lt;/a&gt; for taking care of that. There is one unused import which fails the build. I am overall +1 when we build this successfully.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulo&quot; class=&quot;user-hover&quot; rel=&quot;paulo&quot;&gt;paulo&lt;/a&gt; would you mind to take the lead here and eventually merge it, please?&lt;/p&gt;</comment>
                            <comment id="17677987" author="paulo" created="Tue, 17 Jan 2023 21:25:28 +0000"  >&lt;p&gt;Prepared &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=linzuro&quot; class=&quot;user-hover&quot; rel=&quot;linzuro&quot;&gt;linzuro&lt;/a&gt;&apos;s patch for commit on 4.0/4.1/trunk and submitted CI:&lt;/p&gt;


&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;branch&lt;/td&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/tree/CASSANDRA-16418-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-16418-4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2202/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#2202&lt;/a&gt; (finished)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/tree/CASSANDRA-16418-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-16418-4.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2203/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#2203&lt;/a&gt; (finished)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/tree/CASSANDRA-16418-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-16418-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2204/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#2204&lt;/a&gt; (finished)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17678335" author="paulo" created="Wed, 18 Jan 2023 17:08:23 +0000"  >&lt;p&gt;There seems to be a legit failure on &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2202/testReport/org.apache.cassandra.db/CleanupTest/testCleanup/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CleanupTest&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17678437" author="paulo" created="Thu, 19 Jan 2023 00:26:30 +0000"  >&lt;p&gt;Resubmitted CI after &lt;a href=&quot;https://github.com/linzuro/cassandra/commit/8de9c73d28291d2df67727ffcb7292f8c21b3442&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test fix&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;branch&lt;/td&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/tree/CASSANDRA-16418-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-16418-4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2205/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#2205&lt;/a&gt; (finished)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/tree/CASSANDRA-16418-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-16418-4.1&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2206/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#2206&lt;/a&gt; (finished)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra/tree/CASSANDRA-16418-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-16418-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2207/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#2207&lt;/a&gt; (finished)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17679268" author="paulo" created="Fri, 20 Jan 2023 18:45:22 +0000"  >&lt;p&gt;Test failures look unrelated - for instance &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2205/testReport/junit/dtest.topology_test/TestTopology/test_decommissioned_node_cant_rejoin/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test_decommissioned_node_cant_rejoin&lt;/a&gt; failed on 4.0 and &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/2207/testReport/junit/dtest-novnode.bootstrap_test/TestBootstrap/test_simultaneous_bootstrap/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;test_simultaneous_bootstrap&lt;/a&gt; on trunk, but they don&apos;t seem to be at all related to this ticket. I ran these tests locally on the respective branches and they&apos;re passing.&lt;/p&gt;

&lt;p&gt;ok to merge &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="17680021" author="smiklosovic" created="Mon, 23 Jan 2023 20:45:44 +0000"  >&lt;p&gt;+1. thanks!&lt;/p&gt;</comment>
                            <comment id="17762436" author="JIRAUSER302037" created="Wed, 6 Sep 2023 15:47:49 +0000"  >&lt;p&gt;Given it appears to be a genuine problem on 3.11, is there any reason why it hasn&apos;t been merge/ported to that version?&lt;/p&gt;</comment>
                            <comment id="17762438" author="smiklosovic" created="Wed, 6 Sep 2023 15:57:30 +0000"  >&lt;p&gt;hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=szymon.miezal&quot; class=&quot;user-hover&quot; rel=&quot;szymon.miezal&quot;&gt;szymon.miezal&lt;/a&gt; , if you prepare a patch for that (while you are on it, why not for 3.0 too if that problem is there as well?) then I can commit that for you.&#160;&lt;/p&gt;

&lt;p&gt;We probably just thought that branches lower from 4.0 are not worth the effort. I do not think there is any special reason behind that.&lt;/p&gt;</comment>
                            <comment id="17762441" author="JIRAUSER302037" created="Wed, 6 Sep 2023 16:07:01 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=smiklosovic&quot; class=&quot;user-hover&quot; rel=&quot;smiklosovic&quot;&gt;smiklosovic&lt;/a&gt;, now knowing that decision wasn&apos;t deliberate I think it make sense to prepare those patches. Shall it be a separate ticket for the sake of doing the backporting work or should we still use this one?&lt;/p&gt;</comment>
                            <comment id="17762442" author="brandon.williams" created="Wed, 6 Sep 2023 16:09:22 +0000"  >&lt;p&gt;Let&apos;s use a new ticket so the lineage can be tracked more clearly.&lt;/p&gt;</comment>
                            <comment id="17762444" author="JIRAUSER302037" created="Wed, 6 Sep 2023 16:15:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; that&apos;s reasonable, thank you for confirmation.&lt;/p&gt;</comment>
                            <comment id="17792799" author="jlewandowski" created="Mon, 4 Dec 2023 12:15:44 +0000"  >&lt;p&gt;Why that check in &lt;tt&gt;CompactionManager&lt;/tt&gt; was removed? Was it needed for tests to make them run? I&apos;m afraid that the check could have been legit for production use.&lt;/p&gt;

&lt;p&gt;cc &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=szymon.miezal&quot; class=&quot;user-hover&quot; rel=&quot;szymon.miezal&quot;&gt;szymon.miezal&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17792847" author="paulo" created="Mon, 4 Dec 2023 13:22:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;Why that check in CompactionManager was removed? Was it needed for tests to make them run? I&apos;m afraid that the check could have been legit for production use.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I think that check was deemed unnecessary after a new check was added to &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/service/StorageService.java#L3907&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;StorageService.forceKeyspaceCleanup&lt;/a&gt; to prevent starting cleanup when there are pending ranges (ie. when a node is joining).&lt;/p&gt;

&lt;p&gt;It&apos;s not clear to me why this latter check is not present in &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/service/StorageService.java#L2524&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt; (while it&apos;s present in 4.0/4.1).&lt;/p&gt;</comment>
                            <comment id="17792862" author="brandon.williams" created="Mon, 4 Dec 2023 14:02:45 +0000"  >&lt;p&gt;Trunk does have &lt;a href=&quot;https://github.com/apache/cassandra/blame/trunk/src/java/org/apache/cassandra/db/compaction/CompactionManager.java#L624-L628&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; check though, which was added by TCM.  It&apos;s not clear to me either why this disparity exists.&lt;/p&gt;</comment>
                            <comment id="17792966" author="beobal" created="Mon, 4 Dec 2023 17:10:44 +0000"  >&lt;p&gt;The TCM patch removed this check from &lt;tt&gt;forceKeyspaceCleanup&lt;/tt&gt; and replaced it with more granular and consistent checks as cleanup is run for each CFS.  &lt;/p&gt;

&lt;p&gt;With TCM there isn&apos;t the same concept of pending ranges. Instead, replica sets for reads and writes are independent and modified separately during range movements. If a node will acquire a range as part of a range movement, it is added as a write replica at the start of the operation, before any streaming takes place. There&apos;s a &lt;a href=&quot;https://cwiki.apache.org/confluence/display/CASSANDRA/CEP-21%3A+Transactional+Cluster+Metadata#CEP21:TransactionalClusterMetadata-MappingClusterOperationstoMetadataTransitions(Events)&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;walkthrough of this&lt;/a&gt; in the CEP doc. &lt;/p&gt;

&lt;p&gt;Owned ranges for cleanup of a CFS are computed when the cleanup task is submitted, so if any range movement has started by that point the ranges involved would already be known to cleanup. What we don&apos;t have, and which the original check in &lt;tt&gt;forceKeyspaceCleanup&lt;/tt&gt; also did not guard against, is a range movement which starts in the window between grabbing the owned ranges &lt;a href=&quot;https://github.com/apache/cassandra/blob/ae0842372ff6dd1437d026f82968a3749f555ff4/src/java/org/apache/cassandra/db/compaction/CompactionManager.java#L634-L642&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and selecting the sstables for the cleanup task &lt;a href=&quot;https://github.com/apache/cassandra/blob/ae0842372ff6dd1437d026f82968a3749f555ff4/src/java/org/apache/cassandra/db/compaction/CompactionManager.java#L656&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. The safest way to protect against this is probably to simply cancel any running cleanup tasks when the set of local ranges is modified, in &lt;tt&gt;CFS::invalidateLocalRanges&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17792967" author="jlewandowski" created="Mon, 4 Dec 2023 17:12:54 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17793600" author="jlewandowski" created="Wed, 6 Dec 2023 09:51:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;I think that check was deemed unnecessary after a new check was added to StorageService.forceKeyspaceCleanup to prevent starting cleanup when there are pending ranges (ie. when a node is joining).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulo&quot; class=&quot;user-hover&quot; rel=&quot;paulo&quot;&gt;paulo&lt;/a&gt; - it looks ok from the user point of view. However, from the API pov &lt;tt&gt;CompactionManager.performCleanup&lt;/tt&gt; can be now called anytime - I think it was important precondition for that method - wouldn&apos;t be good to keep it there, just changing the condition to check pending ranges rather than joining status?&lt;/p&gt;</comment>
                            <comment id="17793739" author="paulo" created="Wed, 6 Dec 2023 14:10:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;However, from the API pov CompactionManager.performCleanup can be now called anytime - I think it was important precondition for that method - wouldn&apos;t be good to keep it there, just changing the condition to check pending ranges rather than joining status?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good point, this was overlooked during review - I suggested removing that just to cleanup but looking back I think there is value in keeping it for safety if this API is used elsewhere. Feel free to create a new ticket to add it back or piggyback in some other ticket, I&apos;d be glad to review.&lt;/p&gt;

&lt;p&gt;To me it&apos;d be nice that CompactionManager API is a dumb local API unaware of token ranges/membership status since it&apos;s just a local operation, but practically these concerns are mixed across the codebase so developers expect that any local API is safe from a distributed standpoint.&lt;/p&gt;</comment>
                            <comment id="17793789" author="brandon.williams" created="Wed, 6 Dec 2023 15:37:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;Feel free to create a new ticket to add it back or piggyback in some other ticket, I&apos;d be glad to review.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That would be &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-18824&quot; title=&quot;Backport CASSANDRA-16418: Cleanup behaviour during node decommission caused missing replica&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-18824&quot;&gt;&lt;del&gt;CASSANDRA-18824&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310361">
                    <name>Blocked</name>
                                            <outwardlinks description="Blocked">
                                        <issuelink>
            <issuekey id="13549757">CASSANDRA-18824</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[linzuro]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12314420" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Mentor</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>paulo</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0nax4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[paulo]]></customfieldvalue>
        <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/8bb9c72f582de6bcc39522ba9ade91fd5bc22f67&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/8bb9c72f582de6bcc39522ba9ade91fd5bc22f67&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;dtest,&#160;CHANGES.txt&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>