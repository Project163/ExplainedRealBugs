<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:29:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-19219] CMS: restarting a CMS node with different ip address</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-19219</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I am simulating running a cluster in Kubernetes and testing what happens when a pod goes down and is re created with a new ip address, the data is all stored on a detached volume so when the new pod is created all the old data for the node is reattached. In 4.0 this is handled correctly the node will come back up with the same hostid, tokens etc, just a new ip address and the cluster is healthy throughout.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;To simulate this I create a 3 node cluster on a local machine using 3 loopback addresses&lt;/p&gt;

&lt;p&gt;127.0.0.1&lt;br/&gt;
127.0.0.2&lt;br/&gt;
127.0.0.3&lt;/p&gt;

&lt;p&gt;I then run nodetool -p 7199 reconfigurecms datacenter1:3 --sync to create 3 CMS nodes&lt;/p&gt;


&lt;p&gt;I then bring down 127.0.0.1 and replace the rpc_address and listen_address with 127.0.0.4 and re start the node. The node then hangs with this as the last error message:&lt;/p&gt;

&lt;p&gt;(8821185654333640868,9200867415893016118]=ForRange{lastModified=Epoch&lt;/p&gt;
{epoch=12}
&lt;p&gt;, endpointsForRange=&lt;span class=&quot;error&quot;&gt;&amp;#91;Full(/127.0.0.1:7000,(8821185654333640868,9200867415893016118&amp;#93;&lt;/span&gt;), Full(/127.0.0.2:7000,(8821185654333640868,9200867415893016118]), Full(/127.0.0.3:7000,(8821185654333640868,9200867415893016118])]},&lt;br/&gt;
}}}, lockedRanges=LockedRanges{lastModified=Epoch&lt;/p&gt;
{epoch=14}
&lt;p&gt;, locked={}}}. This can mean that this node is configured differently from CMS.&lt;br/&gt;
java.lang.AssertionError: not aware of any cluster members&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.locator.NetworkTopologyStrategy.calculateNaturalReplicas(NetworkTopologyStrategy.java:233)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.locator.CMSPlacementStrategy$DatacenterAware.reconfigure(CMSPlacementStrategy.java:119)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.tcm.transformations.cms.PrepareCMSReconfiguration$Complex.execute(PrepareCMSReconfiguration.java:164)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.tcm.log.LocalLog.processPendingInternal(LocalLog.java:429)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.tcm.log.LocalLog$Async$AsyncRunnable.run(LocalLog.java:682)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.concurrent.InfiniteLoopExecutor.loop(InfiniteLoopExecutor.java:121)&lt;br/&gt;
&#160; &#160; &#160; &#160; at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)&lt;br/&gt;
&#160; &#160; &#160; &#160; at java.base/java.lang.Thread.run(Thread.java:829)&lt;br/&gt;
WARN &#160;&lt;span class=&quot;error&quot;&gt;&amp;#91;GlobalLogFollower&amp;#93;&lt;/span&gt; 2023-12-21 11:11:34,408 LocalLog.java:693 - Stopping log processing on the node... All subsequent epochs will be ignored.&lt;br/&gt;
org.apache.cassandra.tcm.log.LocalLog$StopProcessingException: java.lang.AssertionError: not aware of any cluster members&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.tcm.log.LocalLog.processPendingInternal(LocalLog.java:434)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.tcm.log.LocalLog$Async$AsyncRunnable.run(LocalLog.java:682)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.concurrent.InfiniteLoopExecutor.loop(InfiniteLoopExecutor.java:121)&lt;br/&gt;
&#160; &#160; &#160; &#160; at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)&lt;br/&gt;
&#160; &#160; &#160; &#160; at java.base/java.lang.Thread.run(Thread.java:829)&lt;br/&gt;
Caused by: java.lang.AssertionError: not aware of any cluster members&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.locator.NetworkTopologyStrategy.calculateNaturalReplicas(NetworkTopologyStrategy.java:233)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.locator.CMSPlacementStrategy$DatacenterAware.reconfigure(CMSPlacementStrategy.java:119)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.tcm.transformations.cms.PrepareCMSReconfiguration$Complex.execute(PrepareCMSReconfiguration.java:164)&lt;br/&gt;
&#160; &#160; &#160; &#160; at org.apache.cassandra.tcm.log.LocalLog.processPendingInternal(LocalLog.java:429)&lt;br/&gt;
&#160; &#160; &#160; &#160; ... 4 common frames omitted&lt;/p&gt;</description>
                <environment></environment>
        <key id="13562594">CASSANDRA-19219</key>
            <summary>CMS: restarting a CMS node with different ip address</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="ifesdjeen">Alex Petrov</assignee>
                                    <reporter username="paulchandler">Paul Chandler</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Dec 2023 11:24:18 +0000</created>
                <updated>Mon, 22 Jan 2024 14:14:52 +0000</updated>
                            <resolved>Mon, 22 Jan 2024 14:14:52 +0000</resolved>
                                        <fixVersion>5.1-alpha1</fixVersion>
                                    <component>Transactional Cluster Metadata</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="17799381" author="beobal" created="Thu, 21 Dec 2023 11:33:32 +0000"  >&lt;p&gt;Sorry &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulchandler&quot; class=&quot;user-hover&quot; rel=&quot;paulchandler&quot;&gt;paulchandler&lt;/a&gt; this is a known issue, we just hadn&apos;t filed a JIRA for it yet. We should have done that already, but the good news is that the fix is implemented and should be available very soon.  &lt;/p&gt;</comment>
                            <comment id="17799387" author="paulchandler" created="Thu, 21 Dec 2023 11:41:33 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=samt&quot; class=&quot;user-hover&quot; rel=&quot;samt&quot;&gt;samt&lt;/a&gt; The 3rd issue I have is that now allows non CMS nodes to swap IP addresses and startup, this was blocked in 4.0 with an error on startup. This then causes data loss on the cluster. Is this a known issue as well, so shall I submit a ticket for that one ?&#160;&lt;/p&gt;</comment>
                            <comment id="17799411" author="beobal" created="Thu, 21 Dec 2023 12:29:13 +0000"  >&lt;p&gt;This isn&apos;t a dataloss-causing event with TCM, as all participants (coordinator and replicas) in a read or write must agree on the ownership of the token or range involved. As these changes are linearised by the CMS, it&apos;s not possible for nodes to see them occur out of sequence or for one node to take over the address of another. That is, node A must have given up its address by switching to another before node B can take over that address. If you are seeing these happen concurrently (i.e. both nodes go down, then come back up with the other&apos;s address), we should investigate.&lt;/p&gt;

&lt;p&gt;In earlier versions, this scenario was dangerous because Coordinator C may not be aware that addresses have changed and route reads/writes to the wrong node, based on the previous binding. On top of that, nodes would blindly accept reads/writes regardless of whether or not they actually owned the relevant ranges, leading to potential consistency violations and data loss.&lt;/p&gt;

&lt;p&gt;Now a node will reject a read or write if it is not a valid replica of the relevant ranges. This is actively checked at read/write time to ensure that their view of the ring/data placements has not diverged from that of their peers. So if a node on either side of read/write has missed a change, it must become aware of it by virtue of participating.&lt;/p&gt;

&lt;p&gt;Of course, this could still present a problem if reading or writing at weaker consistency levels (e.g. CL.ONE). As an isolated node may beleive itself to still be the owner of some data, when the rest of the cluster has agreed that it no longer is.&lt;/p&gt;</comment>
                            <comment id="17799417" author="paulchandler" created="Thu, 21 Dec 2023 12:54:46 +0000"  >&lt;p&gt;&quot;If you are seeing these happen concurrently (i.e. both nodes go down, then come back up with the other&apos;s address), we should investigate.&quot;&lt;/p&gt;

&lt;p&gt;This is what I am seeing at the moment. I will raise a separate Jira for it. I have seen the code that I thought would trap it, but it does not seem to be catching this example.&#160;&#160;&lt;/p&gt;</comment>
                            <comment id="17799439" author="beobal" created="Thu, 21 Dec 2023 14:09:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;This is what I am seeing at the moment. I will raise a separate Jira for it&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;thanks!&lt;/p&gt;</comment>
                            <comment id="17799450" author="paulchandler" created="Thu, 21 Dec 2023 15:30:43 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-19221&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-19221&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17801869" author="paulchandler" created="Tue, 2 Jan 2024 17:23:40 +0000"  >&lt;p&gt;I have tested the patch, and this fixes the problem I was having, the node will now restart after a ip address change.&#160;&lt;/p&gt;</comment>
                            <comment id="17806779" author="beobal" created="Mon, 15 Jan 2024 12:15:45 +0000"  >&lt;p&gt;+1 I couldn&apos;t repro the handful of test failures/errors in the attached CI run &amp;amp; these are all unrelated to the patch anyway.&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13065536" name="ci_summary.html" size="6909" author="ifesdjeen" created="Thu, 21 Dec 2023 15:54:25 +0000"/>
                            <attachment id="13065537" name="result_details.tar.gz" size="41160730" author="ifesdjeen" created="Thu, 21 Dec 2023 15:54:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12994" cascade-level="1"><![CDATA[Unavailable]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311120" key="com.pyxis.greenhopper.jira:gh-epic-link">
                        <customfieldname>Epic Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>CASSANDRA-19055</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            1 year, 43 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1me3c:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
        <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12353509">5.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/46b90364daecf1880db5eda9899d7353ad81f445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/46b90364daecf1880db5eda9899d7353ad81f445&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Test included&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>