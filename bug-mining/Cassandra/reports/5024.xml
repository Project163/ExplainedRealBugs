<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-12743] Assertion error while running compaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-12743</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;While running compaction I run into an error sometimes :&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;nodetool compact
error: null
-- StackTrace --
java.lang.AssertionError
        at org.apache.cassandra.io.compress.CompressionMetadata$Chunk.&amp;lt;init&amp;gt;(CompressionMetadata.java:463)
        at org.apache.cassandra.io.compress.CompressionMetadata.chunkFor(CompressionMetadata.java:228)
        at org.apache.cassandra.io.util.CompressedSegmentedFile.createMappedSegments(CompressedSegmentedFile.java:80)
        at org.apache.cassandra.io.util.CompressedPoolingSegmentedFile.&amp;lt;init&amp;gt;(CompressedPoolingSegmentedFile.java:38)
        at org.apache.cassandra.io.util.CompressedPoolingSegmentedFile$Builder.complete(CompressedPoolingSegmentedFile.java:101)
        at org.apache.cassandra.io.util.SegmentedFile$Builder.complete(SegmentedFile.java:198)
        at org.apache.cassandra.io.sstable.format.big.BigTableWriter.openEarly(BigTableWriter.java:315)
        at org.apache.cassandra.io.sstable.SSTableRewriter.maybeReopenEarly(SSTableRewriter.java:171)
        at org.apache.cassandra.io.sstable.SSTableRewriter.append(SSTableRewriter.java:116)
        at org.apache.cassandra.db.compaction.writers.DefaultCompactionWriter.append(DefaultCompactionWriter.java:64)
        at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:184)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:74)
        at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59)
        at org.apache.cassandra.db.compaction.CompactionManager$8.runMayThrow(CompactionManager.java:599)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)
        at java.util.concurrent.FutureTask.run(FutureTask.java:266)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
        at java.lang.Thread.run(Thread.java:745)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Why is that happening?&lt;br/&gt;
Is there anyway to provide more details (e.g. which SSTable cannot be compacted)?&lt;/p&gt;

&lt;p&gt;We are using Cassandra 2.2.7&lt;/p&gt;</description>
                <environment>&lt;p&gt;unix&lt;/p&gt;</environment>
        <key id="13009228">CASSANDRA-12743</key>
            <summary>Assertion error while running compaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jay.zhuang">Jay Zhuang</assignee>
                                    <reporter username="jbleduigou">Jean-Baptiste Le Duigou</reporter>
                        <labels>
                    </labels>
                <created>Mon, 3 Oct 2016 12:57:39 +0000</created>
                <updated>Fri, 15 May 2020 08:00:08 +0000</updated>
                            <resolved>Tue, 1 May 2018 22:32:50 +0000</resolved>
                                        <fixVersion>2.2.13</fixVersion>
                    <fixVersion>3.0.17</fixVersion>
                    <fixVersion>3.11.3</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="16155043" author="krummas" created="Wed, 6 Sep 2017 09:10:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbleduigou&quot; class=&quot;user-hover&quot; rel=&quot;jbleduigou&quot;&gt;jbleduigou&lt;/a&gt; Is this still happening for you?&lt;/p&gt;</comment>
                            <comment id="16155060" author="jhb" created="Wed, 6 Sep 2017 09:20:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; I&apos;m on the same team as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbleduigou&quot; class=&quot;user-hover&quot; rel=&quot;jbleduigou&quot;&gt;jbleduigou&lt;/a&gt;, we just had a 60h perf testing run without such issue, so it looks like it&apos;s not happening anymore.&lt;/p&gt;</comment>
                            <comment id="16155069" author="krummas" created="Wed, 6 Sep 2017 09:26:14 +0000"  >&lt;p&gt;Ok, thanks, closing as cannot reproduce, please reopen if you see it again&lt;/p&gt;</comment>
                            <comment id="16347943" author="jay.zhuang" created="Thu, 1 Feb 2018 03:06:25 +0000"  >&lt;p&gt;We&apos;re seeing the same issue in 3.0.14, here is the log:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [CompactionExecutor:73398] 2018-01-30 02:23:32,177 CassandraDaemon.java:207 - Exception in thread Thread[CompactionExecutor:73398,1,main]
java.lang.AssertionError: null
    at org.apache.cassandra.io.compress.CompressionMetadata$Chunk.&amp;lt;init&amp;gt;(CompressionMetadata.java:475) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.compress.CompressionMetadata.chunkFor(CompressionMetadata.java:240) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.MmappedRegions.updateState(MmappedRegions.java:155) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.MmappedRegions.&amp;lt;init&amp;gt;(MmappedRegions.java:70) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.MmappedRegions.&amp;lt;init&amp;gt;(MmappedRegions.java:58) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.MmappedRegions.map(MmappedRegions.java:96) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.CompressedSegmentedFile.&amp;lt;init&amp;gt;(CompressedSegmentedFile.java:47) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.CompressedSegmentedFile$Builder.complete(CompressedSegmentedFile.java:132) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.SegmentedFile$Builder.complete(SegmentedFile.java:177) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.SegmentedFile$Builder.buildData(SegmentedFile.java:188) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.sstable.format.big.BigTableWriter.openEarly(BigTableWriter.java:245) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.sstable.SSTableRewriter.maybeReopenEarly(SSTableRewriter.java:172) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.sstable.SSTableRewriter.append(SSTableRewriter.java:124) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.db.compaction.writers.DefaultCompactionWriter.realAppend(DefaultCompactionWriter.java:57) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.db.compaction.writers.CompactionAwareWriter.append(CompactionAwareWriter.java:109) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:195) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:89) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:61) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionCandidate.run(CompactionManager.java:264) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_121]
    at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_121]
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_121]
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_121]
    at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:79) [apache-cassandra-3.0.14.jar:3.0.14]
    at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_121]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Sometimes the error is&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [CompactionExecutor:1324] 2018-01-31 17:00:21,922 CassandraDaemon.java:207 - Exception in thread Thread[CompactionExecutor:1324,1,main]
java.lang.AssertionError: Illegal bounds [12800..12808); size: 12800
    at org.apache.cassandra.io.util.Memory.checkBounds(Memory.java:339) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.SafeMemory.checkBounds(SafeMemory.java:104) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.Memory.getLong(Memory.java:260) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.compress.CompressionMetadata.chunkFor(CompressionMetadata.java:238) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.MmappedRegions.updateState(MmappedRegions.java:155) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.MmappedRegions.&amp;lt;init&amp;gt;(MmappedRegions.java:70) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.MmappedRegions.&amp;lt;init&amp;gt;(MmappedRegions.java:58) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.MmappedRegions.map(MmappedRegions.java:96) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.CompressedSegmentedFile.&amp;lt;init&amp;gt;(CompressedSegmentedFile.java:47) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.CompressedSegmentedFile$Builder.complete(CompressedSegmentedFile.java:132) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.SegmentedFile$Builder.complete(SegmentedFile.java:177) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.util.SegmentedFile$Builder.buildData(SegmentedFile.java:188) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.sstable.format.big.BigTableWriter.openEarly(BigTableWriter.java:245) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.sstable.SSTableRewriter.maybeReopenEarly(SSTableRewriter.java:172) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.io.sstable.SSTableRewriter.append(SSTableRewriter.java:124) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.db.compaction.writers.MaxSSTableSizeWriter.realAppend(MaxSSTableSizeWriter.java:88) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.db.compaction.writers.CompactionAwareWriter.append(CompactionAwareWriter.java:109) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:195) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:89) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:61) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionCandidate.run(CompactionManager.java:264) ~[apache-cassandra-3.0.14.jar:3.0.14]
    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_121]
    at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_121]
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_121]
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_121]
    at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:79) [apache-cassandra-3.0.14.jar:3.0.14]
    at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_121]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;sstable_preemptive_open_interval_in_mb&lt;/tt&gt; is set to 50 by default. Maybe we could try to disable it.&lt;/p&gt;

&lt;p&gt;It happens for both LCS and STCS.&lt;/p&gt;</comment>
                            <comment id="16355297" author="tvdw" created="Wed, 7 Feb 2018 10:42:03 +0000"  >&lt;p&gt;Found one on 3.11.1 as well:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [CompactionExecutor:1696] 2018-02-07 09:58:10,510 CassandraDaemon.java:228 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:1696,1,main]
java.lang.AssertionError: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
        at org.apache.cassandra.io.compress.CompressionMetadata$Chunk.&amp;lt;init&amp;gt;(CompressionMetadata.java:474) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.io.compress.CompressionMetadata.chunkFor(CompressionMetadata.java:239) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.io.util.MmappedRegions.updateState(MmappedRegions.java:163) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.io.util.MmappedRegions.&amp;lt;init&amp;gt;(MmappedRegions.java:73) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.io.util.MmappedRegions.&amp;lt;init&amp;gt;(MmappedRegions.java:61) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.io.util.MmappedRegions.map(MmappedRegions.java:104) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.io.util.FileHandle$Builder.complete(FileHandle.java:362) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.io.sstable.format.big.BigTableWriter.openEarly(BigTableWriter.java:290) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.io.sstable.SSTableRewriter.maybeReopenEarly(SSTableRewriter.java:179) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.io.sstable.SSTableRewriter.append(SSTableRewriter.java:134) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.db.compaction.writers.MaxSSTableSizeWriter.realAppend(MaxSSTableSizeWriter.java:98) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.db.compaction.writers.CompactionAwareWriter.append(CompactionAwareWriter.java:141) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:201) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:85) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:61) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionCandidate.run(CompactionManager.java:268) ~[apache-cassandra-3.11.1.jar:3.11.1]
        at java.util.concurrent.Executors$RunnableAdapter.call(Unknown Source) ~[na:1.8.0_152]
        at java.util.concurrent.FutureTask.run(Unknown Source) ~[na:1.8.0_152]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source) [na:1.8.0_152]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source) [na:1.8.0_152]
        at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:81) [apache-cassandra-3.11.1.jar:3.11.1]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(Unknown Source) ~[na:1.8.0_152]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16451469" author="jay.zhuang" created="Wed, 25 Apr 2018 00:59:04 +0000"  >&lt;p&gt;The problem is because &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/io/sstable/IndexSummaryBuilder.java#L64&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;dataSyncPosition&lt;/tt&gt;&lt;/a&gt; is the compressed file size (set here: &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/io/sstable/format/big/BigTableWriter.java#L445&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;BigTableWriter.java:445&lt;/tt&gt;&lt;/a&gt;), VS. &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/io/sstable/IndexSummaryBuilder.java#L58&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;lastReadableByData&lt;/tt&gt;&lt;/a&gt; is having &lt;a href=&quot;https://github.com/apache/cassandra/blob/5dc55e715eba6667c388da9f8f1eb7a46489b35c/src/java/org/apache/cassandra/io/sstable/format/big/BigTableWriter.java#L185&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;uncompressed data size&lt;/a&gt;: &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/io/sstable/IndexSummaryBuilder.java#L222&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;IndexSummaryBuilder.java:222&lt;/tt&gt;&lt;/a&gt;.&lt;br/&gt;
So if the compression ratio is bigger or around &lt;tt&gt;1.0&lt;/tt&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/blob/5dc55e715eba6667c388da9f8f1eb7a46489b35c/src/java/org/apache/cassandra/io/sstable/IndexSummaryBuilder.java#L174&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the index file is synced faster than the data file&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/io/sstable/format/big/BigTableWriter.java#L287&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;openEarly()&lt;/tt&gt;&lt;/a&gt; may open data that haven&apos;t been synced.&lt;/p&gt;

&lt;p&gt;Here is the patch, please review:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; Branch &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; uTest &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; dTest &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/12743-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12743-2.2&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/12743-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/12743-2.2.svg?style=svg&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/526&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#526&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/12743-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12743-3.0&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/12743-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/12743-3.0.svg?style=svg&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/527&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#527&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/12743-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12743-3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/12743-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/12743-3.11.svg?style=svg&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/528&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#528&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/cooldoger/cassandra/tree/12743-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;12743-trunk&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/12743-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://circleci.com/gh/cooldoger/cassandra/tree/12743-trunk.svg?style=svg&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/529&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;#529&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16452169" author="krummas" created="Wed, 25 Apr 2018 12:31:06 +0000"  >&lt;p&gt;nice catch &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jay.zhuang&quot; class=&quot;user-hover&quot; rel=&quot;jay.zhuang&quot;&gt;jay.zhuang&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;Do you think it would it be possible to create a regression test? Ie, to create an sstable where this reproduces?&lt;/p&gt;

&lt;p&gt;I think we need the truncate(...) fix in 2.2 and 3.0 as well (including the fix in SequentialWriter which only seems to be in 3.11+ (see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11579?focusedCommentId=15241980&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-15241980&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;this&lt;/a&gt; comment))?&lt;/p&gt;</comment>
                            <comment id="16453166" author="jay.zhuang" created="Wed, 25 Apr 2018 22:02:33 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; for the review. It makes sense to backport the &lt;tt&gt;truncate()&lt;/tt&gt; part to &lt;tt&gt;2.2&lt;/tt&gt; and &lt;tt&gt;3.0&lt;/tt&gt;. The branch is updated, please review.&lt;/p&gt;

&lt;p&gt;It&apos;s really hard to reproduce it locally, as the most of time the index file is synced slower than the data file, so it uses index file synced position (even the data synced position is wrong, it won&apos;t cause the problem): &lt;a href=&quot;https://github.com/apache/cassandra/blob/5dc55e715eba6667c388da9f8f1eb7a46489b35c/src/java/org/apache/cassandra/io/sstable/IndexSummaryBuilder.java#L174&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;IndexSummaryBuilder.java:174&lt;/tt&gt;&lt;/a&gt;.&lt;br/&gt;
But in one of our cluster, it happens every dozens hours per node. I patched the fix and no longer see the issue.&lt;/p&gt;</comment>
                            <comment id="16453595" author="krummas" created="Thu, 26 Apr 2018 07:05:56 +0000"  >&lt;p&gt;pushed a repro here: &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/repro_12743&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/repro_12743&lt;/a&gt; - it runs a major compaction with a compressor that doubles the data size&lt;/p&gt;</comment>
                            <comment id="16454920" author="jay.zhuang" created="Thu, 26 Apr 2018 21:43:20 +0000"  >&lt;p&gt;Cool, thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt;. Updated each branch with the unittest.&lt;/p&gt;</comment>
                            <comment id="16456116" author="krummas" created="Fri, 27 Apr 2018 08:48:09 +0000"  >&lt;p&gt;restarted the trunk dtests - +1 if they look ok&lt;/p&gt;</comment>
                            <comment id="16458854" author="jay.zhuang" created="Mon, 30 Apr 2018 18:37:09 +0000"  >&lt;p&gt;There&apos;re a few dTest failures for each branch. Trying to confirm they&apos;re not introduced by this patch.&lt;/p&gt;</comment>
                            <comment id="16460237" author="jay.zhuang" created="Tue, 1 May 2018 22:32:17 +0000"  >&lt;p&gt;Thank you Marcus again for the review. Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/3a713827f48399f389ea851a19b8ec8cd2cc5773&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3a71382&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13073913">CASSANDRA-13545</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jay.zhuang]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 29 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i34d1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335581">2.2.7</customfieldvalue>
    <customfieldvalue id="12340362">3.0.14</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335581">2.2.7</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>