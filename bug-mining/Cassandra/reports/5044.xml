<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14513] Reverse order queries in presence of range tombstones may cause permanent data loss</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14513</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Slice queries in descending sort order can create oversized artificial range tombstones. At CL &amp;gt; ONE, read repair can propagate these tombstones to all replicas, wiping out vast data ranges that they mistakenly cover.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13165591">CASSANDRA-14513</key>
            <summary>Reverse order queries in presence of range tombstones may cause permanent data loss</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="samt">Sam Tunnicliffe</reporter>
                        <labels>
                    </labels>
                <created>Tue, 12 Jun 2018 15:01:45 +0000</created>
                <updated>Fri, 15 May 2020 08:02:07 +0000</updated>
                            <resolved>Thu, 14 Jun 2018 17:23:32 +0000</resolved>
                                        <fixVersion>3.0.17</fixVersion>
                    <fixVersion>3.11.3</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Core</component>
                    <component>Legacy/CQL</component>
                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>19</watches>
                                                                                                                <comments>
                            <comment id="16509790" author="beobal" created="Tue, 12 Jun 2018 15:56:10 +0000"  >&lt;p&gt;The problem manifests when executing a slice query with reverse ordering against an indexed partition if the upper bound of the query precedes the first clustering in the partition for a given SSTable.&lt;/p&gt;

&lt;p&gt;The initial search of the index correctly identifies that the slice bounds are not contained within the partition and &lt;tt&gt;ReverseIndexedReader::setForSlice&lt;/tt&gt; returns an empty iterator. However, it doesn&#8217;t update the pointer to the current index block in &lt;tt&gt;IndexState&lt;/tt&gt;. The pointer remains set to the size of the column index, so that when the initial empty iterator is exhausted &lt;tt&gt;ReversedIndexReader::hasNextInternal&lt;/tt&gt; incorrectly assumes that there is more to do, bumps the pointer back one to the last index block and starts reading.&lt;/p&gt;

&lt;p&gt;If a range tombstone spans the boundary between the penultimate and final index blocks, the iterator will emit the end marker after first altering the bounds to match those of the query. The assumption made is that only data that falls within the bounds of the query slice will be read from disk and so adjusting the tombstone bounds in this way is simply a narrowing of the range tombstone. The index block pointer bug invalidates this assumption and so a wholly new and invalid marker is generated.&lt;/p&gt;

&lt;p&gt;On a single node this new marker alone can shadow live data in other sstables, but the effect is transient. A tombstone never gets written to disk and when the SSTable is compacted, the layout of the partition on disk will &lt;em&gt;likely&lt;/em&gt; no longer trigger the bug (though is no guarantee of this).&lt;/p&gt;

&lt;p&gt;In a multi-node scenario read repair can cause the erroneous marker to be matched to an (unrelated) marker from another replica, creating a new tombstone, potentially with a very wide range. This is then propagated to all replicas, causing data loss from the partition.&lt;/p&gt;</comment>
                            <comment id="16509800" author="iamaleksey" created="Tue, 12 Jun 2018 16:01:47 +0000"  >&lt;p&gt;A dtest representing both scenarios can be found &lt;a href=&quot;https://github.com/iamaleksey/cassandra-dtest/commits/14513&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;test_14513_transient&lt;/tt&gt; shows that the issue can be reproduced with just one node - although there is no permanent data loss here, just queries not returning all the results they are supposed to. Which is bad in itself, but not as bad as the other scenario.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;test_14513_permanent&lt;/tt&gt; illustrates how that oversized tombstone can be propagated by read repair to every replica and wipe out the partition.&lt;/p&gt;

&lt;p&gt;Both tests are a bit longer than they need be - minimal reproduction can be achieved in half as much code, but I opted for showing the full impact in an intentionally more verbose manner.&lt;/p&gt;</comment>
                            <comment id="16509847" author="beobal" created="Tue, 12 Jun 2018 16:41:41 +0000"  >&lt;p&gt;Trivial fix is to correctly adjust the current index pointer in IndexState when the slice bounds are found to be wholly before the start of the partition. It might make sense to open a follow up JIRA to investigate whether the modification of the tombstone bounds (in &lt;tt&gt;RangeTombstoneList::reverseIterator&lt;/tt&gt;, and maybe &lt;tt&gt;forwardIterator&lt;/tt&gt; if necessary) can be tightened up by asserting that any newly generated bounds are not disjoint from the query slice.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CircleCI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/14513-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/16abca6e-d7e8-4671-aaeb-4f9de32b8190&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/14513-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/7c79b1d7-26db-436f-b156-cdf05284b85a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/14513-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/workflow-run/076bf598-8a40-4637-9de2-f936c62f8863&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&#160;CI runs are using &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt;&apos;s dtest branch mentioned in the previous comment.&lt;/p&gt;</comment>
                            <comment id="16512325" author="iamaleksey" created="Thu, 14 Jun 2018 11:16:16 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16512781" author="beobal" created="Thu, 14 Jun 2018 17:23:32 +0000"  >&lt;p&gt;Thanks. Committed to 3.0 as &lt;tt&gt;eb91942f64972bef04c4e965dcdf788ae1f21a60&lt;/tt&gt; and merged to 3.11 &amp;amp; trunk.&lt;/p&gt;</comment>
                            <comment id="16512878" author="iamaleksey" created="Thu, 14 Jun 2018 18:52:21 +0000"  >&lt;p&gt;Committed the dtests as &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/51c8352020b8df3fe04344ae88c29d2a73a228bd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;51c8352020b8df3fe04344ae88c29d2a73a228bd&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="13161" cascade-level="1"><![CDATA[Unrecoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 22 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3urvz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>