<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:08:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13480] nodetool repair can hang forever if we lose the notification for the repair completing/failing</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13480</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When a Jmx lost notification occurs, sometimes the lost notification in question is the notification which let&apos;s RepairRunner know that the repair is finished (ProgressEventType.COMPLETE or even ERROR for that matter).&lt;br/&gt;
This results in nodetool process running the repair hanging forever. &lt;/p&gt;

&lt;p&gt;I have a test which reproduces the issue here:&lt;br/&gt;
&lt;a href=&quot;https://github.com/Jollyplum/cassandra-dtest/tree/repair_hang_test&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Jollyplum/cassandra-dtest/tree/repair_hang_test&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To fix this, If on receiving a notification that notifications have been lost (JMXConnectionNotification.NOTIFS_LOST), we instead query a new endpoint via Jmx to receive all the relevant notifications we&apos;re interested in, we can replay those we missed and avoid this scenario.&lt;/p&gt;

&lt;p&gt;It&apos;s possible also that the JMXConnectionNotification.NOTIFS_LOST itself might be lost and so for good measure I have made RepairRunner poll periodically to see if there were any notifications that had been sent but we didn&apos;t receive (scoped just to the particular tag for the given repair).&lt;/p&gt;

&lt;p&gt;Users who don&apos;t use nodetool but go via jmx directly, can still use this new endpoint and implement similar behaviour in their clients as desired.&lt;br/&gt;
I&apos;m also expiring the notifications which have been kept on the server side.&lt;br/&gt;
Please let me know if you&apos;ve any questions or can think of a different approach, I also tried setting:&lt;br/&gt;
 JVM_OPTS=&quot;$JVM_OPTS -Djmx.remote.x.notification.buffer.size=5000&quot;&lt;br/&gt;
but this didn&apos;t fix the test. I suppose it might help under certain scenarios but in this test we don&apos;t even send that many notifications so I&apos;m not surprised it doesn&apos;t fix it.&lt;br/&gt;
It seems like getting lost notifications is always a potential problem with jmx as far as I can tell.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13067566">CASSANDRA-13480</key>
            <summary>nodetool repair can hang forever if we lose the notification for the repair completing/failing</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mbyrd">Matt Byrd</assignee>
                                    <reporter username="mbyrd">Matt Byrd</reporter>
                        <labels>
                            <label>repair</label>
                    </labels>
                <created>Fri, 28 Apr 2017 01:19:49 +0000</created>
                <updated>Tue, 7 Mar 2023 11:52:24 +0000</updated>
                            <resolved>Thu, 29 Jun 2017 19:17:14 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Tool/nodetool</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="15988094" author="cnlwsu" created="Fri, 28 Apr 2017 02:49:42 +0000"  >&lt;p&gt;how many notifications you see doesnt impact the notification buffer. JMX will create a buffer of notifications and cycle through them indexing new events as they are created. The JMX client will request events with the last index it has seen. Since the server does not store the state of the clients or know what they are listening for, ALL events regardless of listening state are appended into buffer. Even if nothing is listening to them all the storage notifications, the streaming notifications, the jvm hotspot notifications are being pushed onto that buffer. If your client takes too long between polling it will get lost notifications (and it will tell you how many it lost). 5000 still may not be nearly enough, but its gonna cost the heap dearly to make that value too large.&lt;/p&gt;

&lt;p&gt;Nodetool actually used to just shut down on lost notifications, but in some clusters/workloads its almost impossible for a client to keep up. In &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7909&quot; title=&quot;Do not exit nodetool repair when receiving JMX NOTIF_LOST&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7909&quot;&gt;&lt;del&gt;CASSANDRA-7909&lt;/del&gt;&lt;/a&gt; it was just starting to be logged. Querying a different endpoint wouldnt really help, only the repair coordinator has the events and it doesnt keep it around (and its cycled outta buffer). We could in theory pull expose a JMX operation that checks the repair_history table or current repair states to determine if the repair has been completed or errored out, and on lost notifications call it to make sure we did not miss a complete event.&lt;/p&gt;</comment>
                            <comment id="15989556" author="mbyrd" created="Fri, 28 Apr 2017 23:01:05 +0000"  >&lt;p&gt;So the patch I have currently also caches the notifications for repairs for a limited time on the co-ordinator, it was initially targeting a release where we didn&apos;t yet have the repair history tables.&lt;br/&gt;
I suppose there is a concern that caching these notifications could under some circumstances cause unwanted extra heap usage. &lt;br/&gt;
(Similarly to the notifications buffer, although at least here we&apos;re only caching a subset that we care more about)&lt;br/&gt;
So using the repair history tables instead and exposing this information by imx seems like a reasonable alternative.&lt;br/&gt;
There are perhaps a couple of kinks to work out, but I&apos;ll have a go at adapting the patch that I have to work in this way.&lt;br/&gt;
For one we only have the cmd id int sent back to the nodetool process (rather than the parent session id which the internal table is partition keyed off)&lt;br/&gt;
We could either keep track of the cmd id int -&amp;gt; parent session uuid in the co-ordinator, either in memory cached to expire or in another internal table,&lt;br/&gt;
or we could parse the uuid out of the notification sent for the start of the parent repair.&lt;br/&gt;
Parsing the message is a bit brittle though and not full proof in theory (we could miss that notification also).&lt;br/&gt;
Ideally I suppose running a repair could return and communicate on the basis of the parent session uuid rather than the int cmd id, but this is a pretty major overhaul and has all sorts of compatibility questions.&lt;/p&gt;</comment>
                            <comment id="16054909" author="mbyrd" created="Mon, 19 Jun 2017 23:01:48 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/Jollyplum/cassandra/tree/13480&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/98/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/Jollyplum/cassandra/14&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16054911" author="githubbot" created="Mon, 19 Jun 2017 23:03:43 +0000"  >&lt;p&gt;GitHub user Jollyplum opened a pull request:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/122&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/122&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;    When lost notifications occur and periodically, check for the parent &#8230;&lt;/p&gt;

&lt;p&gt;    &#8230;repair status and exit if we&apos;ve completed/failed&lt;/p&gt;

&lt;p&gt;    patch by Matt Byrd, reviewed by Chris Lohfink for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13480&quot; title=&quot;nodetool repair can hang forever if we lose the notification for the repair completing/failing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13480&quot;&gt;&lt;del&gt;CASSANDRA-13480&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;You can merge this pull request into a Git repository by running:&lt;/p&gt;

&lt;p&gt;    $ git pull &lt;a href=&quot;https://github.com/Jollyplum/cassandra&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Jollyplum/cassandra&lt;/a&gt; 13480&lt;/p&gt;

&lt;p&gt;Alternatively you can review and apply these changes as the patch at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/122.patch&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/122.patch&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;To close this pull request, make a commit to your master/trunk branch&lt;br/&gt;
with (at least) the following in the commit message:&lt;/p&gt;

&lt;p&gt;    This closes #122&lt;/p&gt;

&lt;hr /&gt;
&lt;p&gt;commit b4c0a5a65ef94b1013793adb088ca11f563ff14b&lt;br/&gt;
Author: Matt Byrd &amp;lt;matthew.l.byrd@gmail.com&amp;gt;&lt;br/&gt;
Date:   2017-05-27T00:03:17Z&lt;/p&gt;

&lt;p&gt;    When lost notifications occur and periodically, check for the parent repair status and exit if we&apos;ve completed/failed&lt;br/&gt;
    patch by Matt Byrd, reviewed by Chris Lohfink for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13480&quot; title=&quot;nodetool repair can hang forever if we lose the notification for the repair completing/failing&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13480&quot;&gt;&lt;del&gt;CASSANDRA-13480&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;hr /&gt;</comment>
                            <comment id="16068439" author="cnlwsu" created="Thu, 29 Jun 2017 14:56:33 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16068809" author="jjirsa" created="Thu, 29 Jun 2017 19:17:14 +0000"  >&lt;p&gt;Thanks all, committed into 4.0 as &lt;tt&gt;20d5ce8b9b587be2f0b7bc5765254e8dc6e0bd3b&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="16202716" author="githubbot" created="Thu, 12 Oct 2017 22:16:58 +0000"  >&lt;p&gt;Github user Jollyplum closed the pull request at:&lt;/p&gt;

&lt;p&gt;    &lt;a href=&quot;https://github.com/apache/cassandra/pull/122&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/122&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16378919" author="tania.engel@quest.com" created="Tue, 27 Feb 2018 16:48:59 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=mbyrd&quot; class=&quot;user-hover&quot; rel=&quot;mbyrd&quot;&gt;mbyrd&lt;/a&gt; : I have reason to believe I just hit this in 3.11.1, I at the very least ran into a repair which has never completed on an 11 node cluster. Is there a way to get this fix in 3.11?&lt;/p&gt;</comment>
                            <comment id="16479873" author="michaelsembwever" created="Thu, 17 May 2018 23:26:23 +0000"  >&lt;p&gt;I can see immediate benefit to users of Reaper with this, so would like to see it back ported to 3.11.x&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jjirsa&quot; class=&quot;user-hover&quot; rel=&quot;jjirsa&quot;&gt;jjirsa&lt;/a&gt;, what are your thoughts?&lt;/p&gt;

&lt;p&gt;Regarding the patch:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;the only public signature added are:
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;the method &lt;tt&gt;List&amp;lt;String&amp;gt; StorageServiceMBean.getParentRepairStatus(int cmd)&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;the enum &lt;tt&gt;ActiveRepairService.ParentRepairStatus&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;the method &lt;tt&gt;ActiveRepairService.recordRepairStatus(&#8230;)&lt;/tt&gt;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;the addition of the 100k entry cache for ParentRepairStatus events&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;While it seems to be reasonably safe, if it is back ported I wonder if the &lt;tt&gt;getParentRepairStatus(..)&lt;/tt&gt; method should be marked as &lt;tt&gt;@Beta&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="16481212" author="rustyrazorblade" created="Fri, 18 May 2018 21:23:11 +0000"  >&lt;p&gt;Assuming it back ports cleanly I&apos;m +1 on bringing it to 3.11.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13160063">CASSANDRA-14453</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12746488">CASSANDRA-8076</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                            <outwardlinks description="supercedes">
                                        <issuelink>
            <issuekey id="12746488">CASSANDRA-8076</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mbyrd]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 26 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3e7w7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12337740">2.1.16</customfieldvalue>
    <customfieldvalue id="12339942">3.0.13</customfieldvalue>
    <customfieldvalue id="12351720">5.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>cnlwsu</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[cnlwsu]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>