<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:13:23 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14647] Reading cardinality from Statistics.db failed</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14647</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;There is some issue&#160;with sstable metadata which is visible in system.log, the messages says:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;WARN&#160; [Thread-6] 2018-07-25 07:12:47,928 SSTableReader.java:249 - Reading cardinality from Statistics.db failed for /opt/data/disk5/data/keyspace/table/mc-big-Data.db.&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Although there is no such file. &lt;/p&gt;

&lt;p&gt;The message has appeared after i&apos;ve changed the compaction strategy from SizeTiered to Leveled. Compaction strategy has been changed region by region (total 3 regions) and it has coincided with the double client write traffic increase.&lt;br/&gt;
 I have tried to run nodetool scrub to rebuilt the sstable, but that does not fix the issue.&lt;/p&gt;

&lt;p&gt;So very hard to define the steps to reproduce, probably it will be:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;run stress tool with write traffic&lt;/li&gt;
	&lt;li&gt;under load change compaction strategy from SireTiered to Leveled for the bunch of hosts&lt;/li&gt;
	&lt;li&gt;add more write traffic&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;Reading the code it is said that if this metadata is broken, then &quot;estimating the keys will be done using index summary&quot;.&#160;&lt;br/&gt;
 &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0.17/src/java/org/apache/cassandra/io/sstable/format/SSTableReader.java#L247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.0.17/src/java/org/apache/cassandra/io/sstable/format/SSTableReader.java#L247&lt;/a&gt;&lt;br/&gt;
 &#160;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Clients are doing only writes with Local One, cluster consist of 3 regions with RF3.&lt;br/&gt;
Storage is configured wth jbod/XFS on 10 x 1Tb disks&lt;br/&gt;
IOPS limit for each disk 500 (total 5000 iops)&lt;br/&gt;
Bandwith for each disk 60mb/s (600 total)&lt;br/&gt;
OS is Debian linux.&lt;/p&gt;</environment>
        <key id="13179321">CASSANDRA-14647</key>
            <summary>Reading cardinality from Statistics.db failed</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="n.v.harikrishna">n.v.harikrishna</assignee>
                                    <reporter username="nezdali">Vitali Djatsuk</reporter>
                        <labels>
                    </labels>
                <created>Thu, 16 Aug 2018 10:26:32 +0000</created>
                <updated>Fri, 15 May 2020 08:02:54 +0000</updated>
                            <resolved>Thu, 9 May 2019 12:37:08 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Observability/Metrics</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="16583121" author="djoshi3" created="Thu, 16 Aug 2018 22:17:38 +0000"  >&lt;p&gt;Hey Vitali, thanks for the report. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; any idea what is going on here? Would changing compaction strategies cause this issue?&lt;/p&gt;</comment>
                            <comment id="16583361" author="krummas" created="Fri, 17 Aug 2018 05:17:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nezdali&quot; class=&quot;user-hover&quot; rel=&quot;nezdali&quot;&gt;nezdali&lt;/a&gt; could you post logs?&lt;/p&gt;</comment>
                            <comment id="16583927" author="rha" created="Fri, 17 Aug 2018 13:15:19 +0000"  >&lt;p&gt;This is not due to STCS -&amp;gt; LCS. I have the same behavior on one cluster with LCS and heavy writes.&#160;STCS has never been configured on it.&lt;/p&gt;</comment>
                            <comment id="16596400" author="krummas" created="Wed, 29 Aug 2018 14:26:08 +0000"  >&lt;p&gt;Looks like this can happen when the table metric `EstimatedPartitionCount` is &lt;a href=&quot;https://github.com/apache/cassandra/blob/d049c6b9b4af4f663aac2bf90d860c3b0c20684a/src/java/org/apache/cassandra/metrics/TableMetrics.java#L307&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;queried &lt;/a&gt; - it grabs the CANONICAL sstables without referencing them, so if there are very many sstables some might get compacted away while calculating the partition count and we get this warning&lt;/p&gt;

&lt;p&gt;If this is the case it is not really a problem (other than the annoying warn message in the log files)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rha&quot; class=&quot;user-hover&quot; rel=&quot;rha&quot;&gt;rha&lt;/a&gt; could you verify that you are querying this metric?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rha&quot; class=&quot;user-hover&quot; rel=&quot;rha&quot;&gt;rha&lt;/a&gt; / &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nezdali&quot; class=&quot;user-hover&quot; rel=&quot;nezdali&quot;&gt;nezdali&lt;/a&gt; could you pause querying this metric and check if the error stops appearing?&lt;/p&gt;

&lt;p&gt;Thanks for providing the logs over email btw &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nezdali&quot; class=&quot;user-hover&quot; rel=&quot;nezdali&quot;&gt;nezdali&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16596418" author="nezdali" created="Wed, 29 Aug 2018 14:37:50 +0000"  >&lt;p&gt;Thanks Marcus. Stopped quering&#160;EstimatedPartitionCount metric from on 1 node.&lt;/p&gt;</comment>
                            <comment id="16597469" author="nezdali" created="Thu, 30 Aug 2018 13:45:17 +0000"  >&lt;p&gt;Unfortunately this did no help, the failed cardinality message is still in the log.&lt;/p&gt;</comment>
                            <comment id="16598934" author="rha" created="Fri, 31 Aug 2018 15:54:21 +0000"  >&lt;p&gt;I do query partition count through Datadog JMX agent, so it happens all the time.&#160;I&apos;ll try to disabled it - although it didn&apos;t work for &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nezdali&quot; class=&quot;user-hover&quot; rel=&quot;nezdali&quot;&gt;nezdali&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16603303" author="rha" created="Tue, 4 Sep 2018 16:44:11 +0000"  >&lt;p&gt;After removing &lt;tt&gt;EstimatedPartitionCount&lt;/tt&gt; from Datadog&apos;s cassandra.yaml on one node, I don&apos;t see any warning for 4 days.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nezdali&quot; class=&quot;user-hover&quot; rel=&quot;nezdali&quot;&gt;nezdali&lt;/a&gt; can you double check that your change was effective (e.g. monitoring service restarted, etc.)?&#160;&lt;/p&gt;</comment>
                            <comment id="16603402" author="krummas" created="Tue, 4 Sep 2018 18:03:08 +0000"  >&lt;p&gt;there is an alias for the metric called &lt;tt&gt;EstimatedRowCount&lt;/tt&gt; which should also be disabled&lt;/p&gt;

&lt;p&gt;I&apos;ll work on a fix&lt;/p&gt;</comment>
                            <comment id="16604491" author="nezdali" created="Wed, 5 Sep 2018 14:44:45 +0000"  >&lt;p&gt;Tested again, and there are no more warning in the log for the whole day. Turned out that monitoring system is querying all keys via jmx and then filters them based on the configuration file.&lt;/p&gt;</comment>
                            <comment id="16758140" author="n.v.harikrishna" created="Fri, 1 Feb 2019 09:34:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; I have created a patch for this and uploaded to this ticket&#160; &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12957234/12957234_14647-trunk-1.patch&quot; title=&quot;14647-trunk-1.patch attached to CASSANDRA-14647&quot;&gt;14647-trunk-1.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16776660" author="krummas" created="Mon, 25 Feb 2019 09:07:18 +0000"  >&lt;p&gt;The &lt;tt&gt;TableMetrics&lt;/tt&gt; change looks good to me (grabbing refs to the sstables before checking key count), but I don&apos;t think we need the &lt;tt&gt;SSTableReader.refAndGetApproximateKeyCount&lt;/tt&gt; part - in the cases this is called we always already have a ref to the sstable.&lt;/p&gt;</comment>
                            <comment id="16781765" author="n.v.harikrishna" created="Fri, 1 Mar 2019 15:14:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=krummas&quot; class=&quot;user-hover&quot; rel=&quot;krummas&quot;&gt;krummas&lt;/a&gt; Updated the patch.&#160;&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;CircleCI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...nvharikrishna:14647-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;14647-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/nvharikrishna/cassandra/3#tests/containers/2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;link&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16836338" author="krummas" created="Thu, 9 May 2019 12:34:38 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;re-ran the tests and failures look unrelated;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://circleci.com/workflow-run/264bb5cb-fd18-4ea2-8b1d-768d9ab96d94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/workflow-run/264bb5cb-fd18-4ea2-8b1d-768d9ab96d94&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="16836343" author="krummas" created="Thu, 9 May 2019 12:37:08 +0000"  >&lt;p&gt;sorry for the delay on this - committed as &lt;tt&gt;ded62076e7fdfd1cfdcf96447489ea607ca796a0&lt;/tt&gt; to trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12957234" name="14647-trunk-1.patch" size="11517" author="n.v.harikrishna" created="Fri, 1 Feb 2019 09:33:41 +0000"/>
                            <attachment id="12935840" name="cassandra_compaction_pending_tasks_7days.png" size="1026637" author="nezdali" created="Thu, 16 Aug 2018 08:31:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[n.v.harikrishna]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            6 years, 27 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3x3zr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12341001">3.0.15</customfieldvalue>
    <customfieldvalue id="12342778">3.0.17</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>marcuse</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326275">2.1 beta1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;adds test case&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>