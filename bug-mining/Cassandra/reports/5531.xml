<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:17:30 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15789] Rows can get duplicated in mixed major-version clusters and after full upgrade</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15789</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;In a mixed 2.X/3.X major version cluster a sequence of row deletes, collection overwrites, paging, and read repair can cause 3.X nodes to split individual rows into several rows with identical clustering. This happens due to 2.X paging and RT semantics, and a 3.X &lt;tt&gt;LegacyLayout&lt;/tt&gt; deficiency.&lt;/p&gt;

&lt;p&gt;To reproduce, set up a 2-node mixed major version cluster with the following table:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
CREATE TABLE distributed_test_keyspace.tlb (
    pk &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
    ck &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;,
    v map&amp;lt;text, text&amp;gt;,
    PRIMARY KEY (pk, ck)
);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;1. Using either node as the coordinator, delete the row with ck=2 using timestamp 1&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
DELETE FROM tbl USING TIMESTAMP 1 WHERE pk = 1 AND ck = 2;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;2. Using either node as the coordinator, insert the following 3 rows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INSERT INTO tbl (pk, ck, v) VALUES (1, 1, {&lt;span class=&quot;code-quote&quot;&gt;&apos;e&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;f&apos;&lt;/span&gt;}) USING TIMESTAMP 3;
INSERT INTO tbl (pk, ck, v) VALUES (1, 2, {&lt;span class=&quot;code-quote&quot;&gt;&apos;g&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;h&apos;&lt;/span&gt;}) USING TIMESTAMP 3;
INSERT INTO tbl (pk, ck, v) VALUES (1, 3, {&lt;span class=&quot;code-quote&quot;&gt;&apos;i&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;j&apos;&lt;/span&gt;}) USING TIMESTAMP 3;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3. Flush the table on both nodes&lt;/p&gt;

&lt;p&gt;4. Using the 2.2 node as the coordinator, force read repar by querying the table with page size = 2:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
SELECT * FROM tbl;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;5. Overwrite the row with ck=2 using timestamp 5:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
INSERT INTO tbl (pk, ck, v) VALUES (1, 2, {&lt;span class=&quot;code-quote&quot;&gt;&apos;g&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;h&apos;&lt;/span&gt;}) USING TIMESTAMP 5;}}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;6. Query the 3.0 node and observe the split row:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
cqlsh&amp;gt; select * from distributed_test_keyspace.tlb ;

 pk | ck | v
----+----+------------
  1 |  1 | {&lt;span class=&quot;code-quote&quot;&gt;&apos;e&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;f&apos;&lt;/span&gt;}
  1 |  2 | {&lt;span class=&quot;code-quote&quot;&gt;&apos;g&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;h&apos;&lt;/span&gt;}
  1 |  2 | {&lt;span class=&quot;code-quote&quot;&gt;&apos;k&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;l&apos;&lt;/span&gt;}
  1 |  3 | {&lt;span class=&quot;code-quote&quot;&gt;&apos;i&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;j&apos;&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This happens because the read to query the second page ends up generating the following mutation for the 3.0 node:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ColumnFamily(tbl -{deletedAt=-9223372036854775808, localDeletion=2147483647,
             ranges=[2:v:_-2:v:!, deletedAt=2, localDeletion=1588588821]
                    [2:v:!-2:!,   deletedAt=1, localDeletion=1588588821]
                    [3:v:_-3:v:!, deletedAt=2, localDeletion=1588588821]}-
             [2:v:63:&lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;:1@3,])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Which on 3.0 side gets incorrectly deserialized as&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Mutation(keyspace=&lt;span class=&quot;code-quote&quot;&gt;&apos;distributed_test_keyspace&apos;&lt;/span&gt;, key=&lt;span class=&quot;code-quote&quot;&gt;&apos;00000001&apos;&lt;/span&gt;, modifications=[
  [distributed_test_keyspace.tbl] key=1 partition_deletion=deletedAt=-9223372036854775808, localDeletion=2147483647 columns=[[] | [v]]
    Row[info=[ts=-9223372036854775808] ]: ck=2 | del(v)=deletedAt=2, localDeletion=1588588821, [v[c]=d ts=3]
    Row[info=[ts=-9223372036854775808] del=deletedAt=1, localDeletion=1588588821 ]: ck=2 |
    Row[info=[ts=-9223372036854775808] ]: ck=3 | del(v)=deletedAt=2, localDeletion=1588588821
])
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;LegacyLayout&lt;/tt&gt; correctly interprets a range tombstone whose start and finish &lt;tt&gt;collectionName&lt;/tt&gt; values don&apos;t match as a wrapping fragment of a legacy row deletion that&apos;s being interrupted by a collection deletion (correctly) - see &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/LegacyLayout.java#L1874-L1889&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt;. Quoting the comment inline:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// Because of the way RangeTombstoneList work, we can have a tombstone where only one of
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// the bound has a collectionName. That happens &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we have a big tombstone A (spanning one
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// or multiple rows) and a collection tombstone B. In that &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt;, RangeTombstoneList will
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// split &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; into 3 RTs: the first one from the beginning of A to the beginning of B,
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;// then B, then a third one from the end of B to the end of A. To make &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; simpler, &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt;
&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;// we detect that &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; we transform the 1st and 3rd tombstone so they don&apos;t end in the middle
&lt;/span&gt; &lt;span class=&quot;code-comment&quot;&gt;// of a row (which is still correct).&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;&lt;tt&gt;LegacyLayout#addRowTombstone()&lt;/tt&gt; method then chokes when it encounters such a tombstone in the middle of an existing row - having seen &lt;tt&gt;v&lt;span class=&quot;error&quot;&gt;&amp;#91;c&amp;#93;&lt;/span&gt;=d&lt;/tt&gt; first, and mistakenly starts a new row, while in the middle of an existing one: (see &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/LegacyLayout.java#L1500-L1501&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;code&lt;/a&gt;).&lt;/p&gt;</description>
                <environment></environment>
        <key id="13302894">CASSANDRA-15789</key>
            <summary>Rows can get duplicated in mixed major-version clusters and after full upgrade</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                    </labels>
                <created>Tue, 5 May 2020 15:01:22 +0000</created>
                <updated>Thu, 5 Nov 2020 07:32:11 +0000</updated>
                            <resolved>Wed, 20 May 2020 07:09:42 +0000</resolved>
                                        <fixVersion>3.0.21</fixVersion>
                    <fixVersion>3.11.7</fixVersion>
                    <fixVersion>4.0-beta1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Coordination</component>
                    <component>Local/Memtable</component>
                    <component>Local/SSTable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17100070" author="iamaleksey" created="Tue, 5 May 2020 16:52:18 +0000"  >&lt;p&gt;&lt;tt&gt;nodetool scrub&lt;/tt&gt;&#160;can fix thee sstables by collapsing rows with the same clustering into one, via the logic added in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12144&quot; title=&quot;Undeletable / duplicate rows after upgrading from 2.2.4 to 3.0.7&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12144&quot;&gt;&lt;del&gt;CASSANDRA-12144&lt;/del&gt;&lt;/a&gt; to address a similar corruption.&lt;/p&gt;</comment>
                            <comment id="17100653" author="krummas" created="Wed, 6 May 2020 10:18:30 +0000"  >&lt;p&gt;Attaching branches which contain commits to;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Add a in-jvm dtest to reproduce.&lt;/li&gt;
	&lt;li&gt;Add a new &lt;tt&gt;PartitionUpdate&lt;/tt&gt; method &lt;tt&gt;fromPre30Iterator&lt;/tt&gt; which merges any subsequent duplicate rows.&lt;/li&gt;
	&lt;li&gt;Make sure we don&apos;t create a new row in legacy layout when encountering a row tombstone after seeing actual data.&lt;/li&gt;
	&lt;li&gt;Add read and compaction time detection for the duplication, with the ability to automatically snapshot the involved replicas to be able to investigate the sstables.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;The 3.0 and 3.11 branches contain the fixes while trunk only has the duplication detection&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; branch &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; unit tests &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; dtests &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; jvm dtests &lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt; jvm upgrade dtests &lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;   &lt;a href=&quot;https://github.com/krummas/cassandra/commits/15789-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;  &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3262&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;vnodes&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3265&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;novnodes&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3263&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jvm dtests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3267&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;upgrade dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;  &lt;a href=&quot;https://github.com/krummas/cassandra/commits/15789-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3236&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3245&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;vnodes&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3244&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;novnodes&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3235&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jvm dtests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3249&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;upgrade dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://github.com/krummas/cassandra/commits/15789-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3238&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3247&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;vnodes&lt;/a&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3248&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;novnodes&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3237&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jvm dtests&lt;/a&gt; &lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt; &lt;a href=&quot;https://circleci.com/gh/krummas/cassandra/3252&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;upgrade dtests&lt;/a&gt; &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The 3.11 upgrade dtest failure is expected since it uses the current 3.0 dtest jar&lt;/p&gt;</comment>
                            <comment id="17102676" author="slebresne" created="Fri, 8 May 2020 15:33:18 +0000"  >&lt;p&gt;I had a quick look at those commits, and agrees about the fix in `LegacyLayout`.&lt;/p&gt;

&lt;p&gt;And I have no strong objections on the 2 other parts, but wanted to remark 2 points:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;regarding the elimination of duplicates on iterator coming from `LegacyLayout`: the patch currently merge the duplicates rather silently.  What if we have another bug in `LegacyLayout` for which row duplication is only one sign, but that also lose data? Are we sure we won&apos;t regret not failing on what would be an unknown bug?&lt;/li&gt;
	&lt;li&gt;Regarding the duplicate check on all reads, I &quot;think&quot; this could have a measurable impact on performance for some workloads. Which isn&apos;t a reason not to add it, but as this impact all reads and will go in &quot;stable&quot; versions, do we want to run a few benchmarks to quantify this? Or have a way to disable the check?&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17104630" author="ifesdjeen" created="Mon, 11 May 2020 16:06:46 +0000"  >&lt;p&gt;+1 with some minor comments:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;nowInSeconds&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/cassandra/commit/966ae03e778742a94fbbecffe07d977c3a39f70b#diff-984dca80cb7e39e7a99f4928ae4b3ec8R55&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; seems to be unused&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...krummas:15789-3.0#diff-984dca80cb7e39e7a99f4928ae4b3ec8R52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this&lt;/a&gt; can be just &lt;tt&gt;flush()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...krummas:15789-3.0#diff-32fe9b86f85fea958f137ab7862ec522R98&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, we will be logging unconditionally, even if we have sent snapshot messages. On a somewhat related note, we can also use &lt;tt&gt;CompactionIteratorTest#duplicateRowsTest&lt;/tt&gt; to verify that throttling works by just clearing &lt;tt&gt;sentMessages&lt;/tt&gt; and making sure we don&apos;t issue it again if there&apos;s one more duplicate.&lt;/li&gt;
	&lt;li&gt;I&apos;m not 100% sure which level is the best for in-jvm dtests. Should we keep &lt;tt&gt;DEBUG&lt;/tt&gt; or should we switch to &lt;tt&gt;ERROR&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;should we add some information that shows &lt;tt&gt;Row/RT/Row&lt;/tt&gt; sandwich, like the one in description? It might make it easier for people to read it in future.&lt;/li&gt;
	&lt;li&gt;in &lt;tt&gt;PartitionUpdateTest&lt;/tt&gt;, &lt;tt&gt;testDuplicate&lt;/tt&gt; and &lt;tt&gt;testMerge&lt;/tt&gt; seem to be specific to this issue, but we don&apos;t have any ticket specific information there. Should we add some motivation/information? In fact, we may consider adding some fuzz tests to test even more scenarios in the future.&lt;/li&gt;
	&lt;li&gt;There are some (possibly intended) &lt;tt&gt;printlns&lt;/tt&gt; in &lt;tt&gt;assertCommandIssued&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Regarding duplicates elimination in &lt;tt&gt;PartitionUpdate&lt;/tt&gt;, since they&apos;ll still be detected and snapshotted, I think this is fine. However, I can imagine a scenario where an erroneous duplicate row can result into data resurrection. But given duplicate rows are by no means a right behaviour, and we already know at least three ways that could lead to such behaviour (12144, 14008, and this issue), merging them to one seems to be a reasonable thing to do, but doesn&apos;t always guarantee behaviour one would otherwise expect from the database. It might be good to make it configurable and/or disabled by default.&lt;/p&gt;</comment>
                            <comment id="17110126" author="krummas" created="Mon, 18 May 2020 10:36:48 +0000"  >&lt;p&gt;Pushed a few commits to the branches above addressing the comments;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Made &lt;tt&gt;PartitionUpdate.fromPre30Iterator&lt;/tt&gt; log whenever it &lt;a href=&quot;https://github.com/krummas/cassandra/commit/7f88a2d60e0fa8da1d328c84d07da3dee6b78b18&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;merges rows&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/commit/aedbfc761fa798c8118409cfc07ece47990578d8&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Revert&lt;/a&gt; to debug logging for in-jvm dtests&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/krummas/cassandra/commit/210da67d6cae3b8c01df315d28e89c455bac488e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Make&lt;/a&gt; it possible to disable read/compaction time duplicate detection&lt;/li&gt;
	&lt;li&gt;Various &lt;a href=&quot;https://github.com/krummas/cassandra/commit/7a18bbea6bb5c1203014396d85fc8a3822c7969a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;minor&lt;/a&gt; &lt;a href=&quot;https://github.com/krummas/cassandra/commit/c4373b3b75aa234b4ebd67ffa03ad5553d73e357&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fixes&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17110270" author="slebresne" created="Mon, 18 May 2020 13:17:02 +0000"  >&lt;p&gt;+1 from me.&lt;/p&gt;</comment>
                            <comment id="17111027" author="ifesdjeen" created="Tue, 19 May 2020 09:53:30 +0000"  >&lt;p&gt;+1 from me as well. &lt;/p&gt;

&lt;p&gt;Two tiny nits that can be fixed on commit: &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;two getters (&lt;tt&gt;getCheckForDuplicateRowsDuringReads&lt;/tt&gt; and &lt;tt&gt;getCheckForDuplicateRowsDuringCompaction&lt;/tt&gt;) return &lt;tt&gt;void&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...krummas:15789-3.11#diff-c43c377976893dc7ae62e89072946ecbR141&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;toIter&lt;/a&gt; can be replaced by &lt;tt&gt;Iterators#forArray()&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I have some questions / meta-discussions:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;In this patch, we&apos;re using an &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...krummas:15789-3.11#diff-32fe9b86f85fea958f137ab7862ec522R42&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;executor&lt;/a&gt; that doesn&apos;t get shut down. Should we use use non-periodic tasks for them?&lt;/li&gt;
	&lt;li&gt;we&apos;re setting &lt;tt&gt;snapshot_on_duplicate_row_detection&lt;/tt&gt; via config and &lt;tt&gt;diagnostic_snapshot_interval_nanos&lt;/tt&gt; via system property. I don&apos;t mind to have it as-is in current case, but we should generally try to consolidate the way we&apos;re managing configuration.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17111052" author="beobal" created="Tue, 19 May 2020 10:25:48 +0000"  >&lt;blockquote&gt;&lt;ul&gt;
	&lt;li&gt;In this patch, we&apos;re using an &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...krummas:15789-3.11#diff-32fe9b86f85fea958f137ab7862ec522R42&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;executor&lt;/a&gt; that doesn&apos;t get shut down. Should we use use non-periodic tasks for them?&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;This is to be explicit about making the snapshot task execution single threaded to ensure that only a single snapshot per-prefix can be triggered on a replica. Non-periodic tasks should be, and most likely always is, effectively singlethreaded but it doesn&apos;t explicitly guarantee that.&lt;/p&gt;

&lt;blockquote&gt;&lt;ul&gt;
	&lt;li&gt;we&apos;re setting snapshot_on_duplicate_row_detection via config and diagnostic_snapshot_interval_nanos via system property. I don&apos;t mind to have it as-is in current case, but we should generally try to consolidate the way we&apos;re managing configuration.&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;tt&gt;diagnostic_snapshot_interval_nanos&lt;/tt&gt; is purely for testing, so it didn&apos;t feel necessary to make that accessible to operators. We could subclass &lt;tt&gt;DiagnosticSnapshotService&lt;/tt&gt; for testing instead, but it didn&apos;t seem too hacky to use a system property here.&lt;/p&gt;</comment>
                            <comment id="17111844" author="krummas" created="Wed, 20 May 2020 07:09:42 +0000"  >&lt;p&gt;and committed, thanks!&lt;/p&gt;</comment>
                            <comment id="17226467" author="leonz" created="Thu, 5 Nov 2020 02:44:27 +0000"  >&lt;p&gt;Hey all - just wanted to call out that an errant import made it into the Cassandra 3.11 patch of this PR: &lt;a href=&quot;https://github.com/apache/cassandra/blob/4d42c189fa82b32fd93ae42a164b91e4db62992e/src/java/org/apache/cassandra/service/StorageProxyMBean.java#L24&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/4d42c189fa82b32fd93ae42a164b91e4db62992e/src/java/org/apache/cassandra/service/StorageProxyMBean.java#L24&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Not a big deal, but noticed this because we publish the MBeans/jmx api as their own custom-built package and hit a compilation error because the DatabaseDescriptor wasn&apos;t included.&lt;/p&gt;</comment>
                            <comment id="17226544" author="krummas" created="Thu, 5 Nov 2020 07:29:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=leonz&quot; class=&quot;user-hover&quot; rel=&quot;leonz&quot;&gt;leonz&lt;/a&gt; thanks for letting us know, fixed in &lt;a href=&quot;https://github.com/apache/cassandra/commit/fa9bbd431100ceac0af8ca3ea0a3dac407246446&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/fa9bbd431100ceac0af8ca3ea0a3dac407246446&lt;/a&gt; and merged up to 3.11 and trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
        <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
        <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12986" cascade-level="1"><![CDATA[Recoverable Corruption / Loss]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12972"><![CDATA[Fuzz Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 1 week, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0eeb4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[ifesdjeen]]></customfieldvalue>
        <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
        <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12332361">3.0 alpha 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/4d42c189fa82b32fd93ae42a164b91e4db62992e&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/4d42c189fa82b32fd93ae42a164b91e4db62992e&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;new tests and cci runs&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>