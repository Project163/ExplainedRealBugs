<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:21:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2818] 0.8.0 is unable to participate with nodes using a _newer_ protocol version</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2818</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When a 0.8.1 node tries to join a 0.8.0 ring, we see an endless supply of these in system.log:&lt;/p&gt;

&lt;p&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;Thread-4&amp;#93;&lt;/span&gt; 2011-06-23 21:14:04,149 IncomingTcpConnection.java (line 103) Received connection from newer protocol version. Ignorning message.&lt;/p&gt;

&lt;p&gt;and the node never joins the ring.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12511410">CASSANDRA-2818</key>
            <summary>0.8.0 is unable to participate with nodes using a _newer_ protocol version</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="mallen">Michael Allen</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Jun 2011 21:22:12 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:56 +0000</updated>
                            <resolved>Tue, 28 Jun 2011 17:50:55 +0000</resolved>
                                        <fixVersion>0.8.2</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13054454" author="jbellis" created="Fri, 24 Jun 2011 13:53:00 +0000"  >&lt;p&gt;Not sure what&apos;s going on. Here&apos;s what&apos;s supposed to happen:&lt;/p&gt;

&lt;p&gt;If new node N is contacted first by old node M, N records the version of M and generates messages at that version. M never knows that N is actually newer.&lt;/p&gt;

&lt;p&gt;If M is contacted first, we expect to see the above message a few times, but M adds N to its gossip list after the first time. Once N gets a gossip from M, it will know to use M&apos;s version when creating messages.&lt;/p&gt;

&lt;p&gt;I don&apos;t see anything obviously wrong with this code. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="13054532" author="jbellis" created="Fri, 24 Jun 2011 16:34:24 +0000"  >&lt;p&gt;It looks like this is a problem in 0.7 too, but you can avoid it if you happen to upgrade a seed node first.&lt;/p&gt;</comment>
                            <comment id="13054534" author="jbellis" created="Fri, 24 Jun 2011 16:42:40 +0000"  >&lt;p&gt;Patch for part one of the problem: actually disconnect when we can&apos;t handle a new version, so the other end will retry.&lt;/p&gt;</comment>
                            <comment id="13054538" author="jbellis" created="Fri, 24 Jun 2011 16:45:33 +0000"  >&lt;p&gt;The breakdown in how it&apos;s supposed to work is, Gossiper.setVersion does not actually add it to the set of nodes-to-contact (liveEndpoints and unreachableEndpoints).  We can&apos;t fix it directly by simply adding to liveEndpoints either, because Gossiper assumes that if we know about the node, we also know about its state (e.g. rack and DC information).&lt;/p&gt;</comment>
                            <comment id="13054638" author="brandon.williams" created="Fri, 24 Jun 2011 19:23:50 +0000"  >&lt;p&gt;In 0.7, we did actually add the node to the endpoint state map by calling addSavedEndpoint.  I removed this in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2092&quot; title=&quot;Refactor gossiper&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2092&quot;&gt;&lt;del&gt;CASSANDRA-2092&lt;/del&gt;&lt;/a&gt;, probably because it makes the log message somewhat incorrect (&quot;XXX has restarted, now UP again&quot;) but if it was good enough for 0.7, I think it&apos;s good enough for 0.8. Note that even without the disconnect 0.7-&amp;gt;0.8 works, but the disconnect is an optimization.  Protection from DC/RACK NPEs is guaranteed by addSavedEndpoint initially marking the node as down, so there&apos;s no reason to query the state information (other things that utilize getNaturalEndpoints may NPE like nodetool ring, but it&apos;s a short window to exploit and non-critical.)  Patch to restore the previous behavior to 0.8.&lt;/p&gt;</comment>
                            <comment id="13054656" author="jbellis" created="Fri, 24 Jun 2011 20:20:55 +0000"  >&lt;p&gt;v2 incorporates the disconnect patch for 0.8 and removes a redundant endpointstate lookup.&lt;/p&gt;</comment>
                            <comment id="13055739" author="brandon.williams" created="Mon, 27 Jun 2011 20:40:33 +0000"  >&lt;p&gt;v2 has two problems:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;It shuts the connection down slightly too aggressively, causing an exception on the remote side before setVersion gets called.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;It stores the remote&apos;s version even when it is greater, causing the lower version node to always report itself as the newer version to the newer node.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;v3 address the first problem by sleeping for a half second before closing, and addresses the second by only calling setVersion if the remote side is compatible, otherwise it calls addSavedEndpoint before disconnecting so that it will reconnect.&lt;/p&gt;</comment>
                            <comment id="13055775" author="jbellis" created="Mon, 27 Jun 2011 21:34:00 +0000"  >&lt;blockquote&gt;&lt;p&gt;It shuts the connection down slightly too aggressively, causing an exception on the remote side before setVersion gets called&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I can see that the initiating side could get pissed that the target closes the socket uncleanly &amp;#8211; what I don&apos;t get is how a sleep could make a difference.  Is it on the reconnect?  In which case the sleep is going to be fragile with a bigger cluster, since we depend on gossip to spread the version info.&lt;/p&gt;

&lt;p&gt;Do you have a sample stacktrace?&lt;/p&gt;</comment>
                            <comment id="13055796" author="brandon.williams" created="Mon, 27 Jun 2011 22:03:40 +0000"  >&lt;p&gt;This repeats infinitely:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;TRACE 22:02:38,187 cassandra-2/10.179.64.227 sending GOSSIP_DIGEST_SYN to 9@/10.179.65.102
DEBUG 22:02:38,188 error writing to /10.179.65.102
java.net.SocketException: Connection reset
        at java.net.SocketOutputStream.socketWrite(SocketOutputStream.java:96)
        at java.net.SocketOutputStream.write(SocketOutputStream.java:136)
        at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:65)
        at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:123)
        at java.io.DataOutputStream.flush(DataOutputStream.java:106)
        at org.apache.cassandra.net.OutboundTcpConnection.writeConnected(OutboundTcpConnection.java:114)
        at org.apache.cassandra.net.OutboundTcpConnection.run(OutboundTcpConnection.java:90)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13055884" author="jbellis" created="Mon, 27 Jun 2011 22:32:44 +0000"  >&lt;p&gt;That makes sense for v2, yeah.&lt;/p&gt;

&lt;p&gt;I realized that we don&apos;t actually need to reconnect to send old-version messages &amp;#8211; version is per-Message, the connection itself is basically just a queue around a socket.&lt;/p&gt;

&lt;p&gt;v4 attached that doesn&apos;t drop (non-streaming) connections at all.  (This is part of the &quot;how did it possibly work on 0.7?&quot; answer, I think.)&lt;/p&gt;</comment>
                            <comment id="13055885" author="jbellis" created="Mon, 27 Jun 2011 22:33:26 +0000"  >&lt;p&gt;v4 also changes the current-version to 3, so we don&apos;t create a version exhaustion problem for ourselves (see comment in MS).&lt;/p&gt;</comment>
                            <comment id="13056191" author="brandon.williams" created="Mon, 27 Jun 2011 23:19:54 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13056675" author="jbellis" created="Tue, 28 Jun 2011 17:50:55 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="13056797" author="hudson" created="Tue, 28 Jun 2011 21:27:07 +0000"  >&lt;p&gt;Integrated in Cassandra-0.8 #197 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra-0.8/197/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra-0.8/197/&lt;/a&gt;)&lt;br/&gt;
    fix Message version propagation fromold nodes to new ones&lt;br/&gt;
patch by brandonwilliams and jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2818&quot; title=&quot;0.8.0 is unable to participate with nodes using a _newer_ protocol version&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2818&quot;&gt;&lt;del&gt;CASSANDRA-2818&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;jbellis : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1140751&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1140751&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/interface/thrift/gen-java/org/apache/cassandra/thrift/Cassandra.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/gms/Gossiper.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/interface/thrift/gen-java/org/apache/cassandra/thrift/InvalidRequestException.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/contrib&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/src/java/org/apache/cassandra/net/IncomingTcpConnection.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/interface/thrift/gen-java/org/apache/cassandra/thrift/SuperColumn.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/interface/thrift/gen-java/org/apache/cassandra/thrift/NotFoundException.java&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8&lt;/li&gt;
	&lt;li&gt;/cassandra/branches/cassandra-0.8/interface/thrift/gen-java/org/apache/cassandra/thrift/Column.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12483733" name="2818-disconnect.txt" size="2777" author="jbellis" created="Fri, 24 Jun 2011 16:42:40 +0000"/>
                            <attachment id="12483764" name="2818-v2.txt" size="4480" author="jbellis" created="Fri, 24 Jun 2011 20:20:55 +0000"/>
                            <attachment id="12484006" name="2818-v3.txt" size="5401" author="brandon.williams" created="Mon, 27 Jun 2011 20:40:33 +0000"/>
                            <attachment id="12484061" name="2818-v4.txt" size="6039" author="jbellis" created="Mon, 27 Jun 2011 22:32:44 +0000"/>
                            <attachment id="12483759" name="2818.txt" size="592" author="brandon.williams" created="Fri, 24 Jun 2011 19:23:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20847</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 22 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gdnb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93641</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>