<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:39 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8619] using CQLSSTableWriter gives ConcurrentModificationException</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8619</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Using CQLSSTableWriter gives ConcurrentModificationException &lt;br/&gt;
I&apos;m trying to load many timeseries into cassandra 2.0.11-1&lt;br/&gt;
using  &apos;org.apache.cassandra:cassandra-all:2.0.11&apos;&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.util.ConcurrentModificationException
	at java.util.TreeMap$PrivateEntryIterator.nextEntry(TreeMap.java:1115)
	at java.util.TreeMap$ValueIterator.next(TreeMap.java:1160)
	at org.apache.cassandra.db.ColumnIndex$Builder.build(ColumnIndex.java:126)
	at org.apache.cassandra.io.sstable.SSTableWriter.rawAppend(SSTableWriter.java:202)
	at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:187)
	at org.apache.cassandra.io.sstable.SSTableSimpleUnsortedWriter$DiskWriter.run(SSTableSimpleUnsortedWriter.java:215)

schema
CREATE TABLE test.sample (ts_id bigint, yr int, t timestamp, v double, tgs set&amp;lt;varchar&amp;gt;, PRIMARY KEY((ts_id,yr), t)) WITH CLUSTERING ORDER BY (t DESC) AND COMPRESSION = {&apos;sstable_compression&apos;: &apos;LZ4Compressor&apos;};

statement:
INSERT INTO  test.sample(ts_id, yr, t, v) VALUES (?,?,?,?)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;with .withBufferSizeInMB(128); it happens more than with&lt;br/&gt;
.withBufferSizeInMB(256);&lt;/p&gt;




&lt;p&gt;code based on &lt;a href=&quot;http://planetcassandra.org/blog/using-the-cassandra-bulk-loader-updated/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://planetcassandra.org/blog/using-the-cassandra-bulk-loader-updated/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;writer.addRow(tsId, year, new Date(time), value);&lt;/p&gt;


&lt;p&gt;Any suggestions will be highly appreciated&lt;/p&gt;</description>
                <environment>&lt;p&gt;sun jdk 7&lt;br/&gt;
linux - ubuntu&lt;/p&gt;</environment>
        <key id="12767419">CASSANDRA-8619</key>
            <summary>using CQLSSTableWriter gives ConcurrentModificationException</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="igor.berman">Igor Berman</reporter>
                        <labels>
                    </labels>
                <created>Wed, 14 Jan 2015 12:46:46 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:23 +0000</updated>
                            <resolved>Wed, 28 Jan 2015 23:01:02 +0000</resolved>
                                        <fixVersion>2.0.13</fixVersion>
                    <fixVersion>2.1.3</fixVersion>
                                    <component>Legacy/Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14276907" author="igor.berman" created="Wed, 14 Jan 2015 13:37:05 +0000"  >&lt;p&gt;problem occurs after few minutes of running&lt;/p&gt;</comment>
                            <comment id="14282853" author="igor.berman" created="Mon, 19 Jan 2015 18:49:50 +0000"  >&lt;p&gt;I believe this is connected to concurrent access to TreeMapBackedSortedColumns both from preparing(main) thread and from DiskWriter thread. TreeMapBackedSortedColumns  is not threadsafe.&lt;/p&gt;</comment>
                            <comment id="14283761" author="igor.berman" created="Tue, 20 Jan 2015 12:14:46 +0000"  >&lt;p&gt;using &apos;org.apache.cassandra:cassandra-all:2.1.2&apos; doesn&apos;t reproduce the problem&lt;/p&gt;</comment>
                            <comment id="14285566" author="benedict" created="Wed, 21 Jan 2015 12:32:37 +0000"  >&lt;p&gt;It&apos;s a pretty simple problem, introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7360&quot; title=&quot;CQLSSTableWriter consumes all memory for table with compound primary key&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7360&quot;&gt;&lt;del&gt;CASSANDRA-7360&lt;/del&gt;&lt;/a&gt;. Since we now sync intra-partition, we need to refresh the buffered column family when we start a sync. &lt;/p&gt;

&lt;p&gt;Marking &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; reviewer, since he wrote the original patch, and I may have missed something. For instance, glancing at this code, it looks to me like we may also be counting additions twice in the BufferedWriter, causing flushes to occur twice as often as desired.&lt;/p&gt;</comment>
                            <comment id="14285745" author="igor.berman" created="Wed, 21 Jan 2015 15:13:12 +0000"  >&lt;p&gt;Benedict, the patch is good for my work! thanks a lot!&lt;/p&gt;</comment>
                            <comment id="14286295" author="slebresne" created="Wed, 21 Jan 2015 21:24:16 +0000"  >&lt;p&gt;patch lgtm, +1 (I&apos;m not sure we need the &lt;tt&gt;columnFamily = null&lt;/tt&gt; line but it doesn&apos;t hurt either).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;it looks to me like we may also be counting additions twice in the BufferedWriter&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t think that&apos;s the case but I would agree that it&apos;s hard to follow (though the comment on BufferedWriter tries to explain it). Basically, while BufferedWriter extends SSUW, it bypass some of its method and in particular the &lt;tt&gt;addColumn&lt;/tt&gt; which does the counting for SSUW. So counting is only done by the call in BufferedWriter. And further note that the &lt;tt&gt;addColumn&lt;/tt&gt; in BufferWriter doesn&apos;t override the one of SSUW. I can agree that all this is not the cleanest code ever, but it was a simple way to reuse the code of SSUW. I suspect that in the future we might just want to deprecate and finally remove SSUW (in favor of simply CQLSSTableWriter), at which point we can clean that up.&lt;/p&gt;</comment>
                            <comment id="14287332" author="benedict" created="Thu, 22 Jan 2015 12:14:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;(I&apos;m not sure we need the columnFamily = null line but it doesn&apos;t hurt either).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We don&apos;t, but it made me slightly more comfortable, for no great reason. If somebody is misusing the API and concurrently adding at the same time as sync, this may permit a NPE to be thrown and alert them to their misuse. Not a great reason, but I didn&apos;t like passing the buffer to another thread whilst its contents were still accessible. Not that they&apos;re at all guaranteed not accessible this way. I deleted/inserted that line a couple of times before leaving it, so also happy to remove it again.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;And further note that the addColumn in BufferWriter doesn&apos;t override the one of SSUW. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Perhaps it &lt;em&gt;should&lt;/em&gt; to throw UnsupportedOE and make it clearer?  Not that it matters tremendously, it&apos;s neither the cleanest nor the ugliest code in the tree.&lt;/p&gt;</comment>
                            <comment id="14288184" author="slebresne" created="Thu, 22 Jan 2015 20:46:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;We don&apos;t, but it made me slightly more comfortable&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s good enough for me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Perhaps it should to throw UnsupportedOE and make it clearer?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s a good idea. You have my blessing for ninja-including it in the commit.&lt;/p&gt;</comment>
                            <comment id="14296012" author="benedict" created="Wed, 28 Jan 2015 23:01:02 +0000"  >&lt;p&gt;Committed, with agreed UOE&lt;/p&gt;</comment>
                            <comment id="14296646" author="benedict" created="Thu, 29 Jan 2015 09:50:23 +0000"  >&lt;p&gt;This introduced a risk of failing with an assertion error due to writing an empty partition, since we could create a new CF on the boundary. Thankfully this was caught by the existing tests. This also caused an existing bug with racing to report the error condition to present, that I&apos;ve also ninja-fixed. I&apos;ve skipped writing the first partition of any flush if it&apos;s empty, and use timed BlockingQueue.offer() to recheck the exceptions periodically. This seems good enough, but will revisit if you take exception to either approach.&lt;/p&gt;</comment>
                            <comment id="14386726" author="ajitj" created="Mon, 30 Mar 2015 13:57:09 +0000"  >&lt;p&gt;I am using the latest snapshot built from 2.1 branch (2.1.3-SNAPSHOT) and I am always getting the following error:&lt;br/&gt;
Exception in thread &quot;main&quot; java.lang.AssertionError: Empty partition&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableSimpleUnsortedWriter$DiskWriter.run(SSTableSimpleUnsortedWriter.java:228)&lt;/p&gt;

&lt;p&gt;It happens at a certain point that seems to be repeatable. Only issue is I am converting 400 million records into multiple SSTables and creating small test is a challenge&lt;/p&gt;

&lt;p&gt;Is there a work around, quick fix that I can try out locally?&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
-Ajit&lt;/p&gt;</comment>
                            <comment id="14386753" author="ajitj" created="Mon, 30 Mar 2015 14:28:26 +0000"  >&lt;p&gt;Opened a new bug &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9071&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-9071&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12693573" name="8619" size="862" author="benedict" created="Wed, 21 Jan 2015 12:32:37 +0000"/>
                            <attachment id="12692219" name="TimeSeriesCassandraLoaderTest.java" size="4248" author="igor.berman" created="Wed, 14 Jan 2015 13:37:05 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 34 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i24cwf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>