<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:40:56 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5732] Can not query secondary index</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5732</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Noticed after taking a column family that already existed and assigning to an IntegerType index_type:KEYS and the caching was already set to &apos;ALL&apos; that the prepared statement do not return rows neither did it throw an exception. Here is the sequence.&lt;br/&gt;
1. Starting state query running with caching off for a Column Family with the query using the secondary index for te WHERE clause.&lt;br/&gt;
2, Set Column Family caching to ALL using Cassandra-CLI and update CQL. Cassandra-cli Describe shows column family caching set to ALL&lt;br/&gt;
3. Rerun query and it works.&lt;br/&gt;
4. Restart Cassandra and run query and no rows returned. Cassandra-cli Describe shows column family caching set to ALL&lt;br/&gt;
5. Set Column Family caching to NONE using Cassandra-cli and update CQL. Rerun query and no rows returned. Cassandra-cli Describe for column family shows caching set to NONE.&lt;br/&gt;
6. Restart Cassandra. Rerun query and it is working again. We are now back to the starting state.&lt;/p&gt;

&lt;p&gt;Best Regards,&lt;br/&gt;
-Tony&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows 8, Jre 1.6.0_45 32-bit&lt;/p&gt;</environment>
        <key id="12656702">CASSANDRA-5732</key>
            <summary>Can not query secondary index</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="adanecito">Tony Anecito</reporter>
                        <labels>
                    </labels>
                <created>Mon, 8 Jul 2013 21:35:28 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:10 +0000</updated>
                            <resolved>Sun, 13 Oct 2013 16:14:59 +0000</resolved>
                                        <fixVersion>1.2.11</fixVersion>
                    <fixVersion>2.0.2</fixVersion>
                                    <component>Feature/2i Index</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="13702913" author="adanecito" created="Tue, 9 Jul 2013 04:52:19 +0000"  >&lt;p&gt;Hi,&lt;/p&gt;

&lt;p&gt;I tried the same set of tables, data, java code in Windows 7 jre 1.7.0_05 64-bit and it seems to not have the issue so far. Will try other environment using 1.7.0_x 32 then 64-bit to see if that solves the issue.&lt;/p&gt;

&lt;p&gt;Regards,&lt;br/&gt;
-Tony&lt;/p&gt;</comment>
                            <comment id="13704207" author="adanecito" created="Wed, 10 Jul 2013 04:54:46 +0000"  >&lt;p&gt;Ok. I figured out it has to do with a config setting in cassandra.yaml file. If you set row_cache_size_in_mb to 200 instead of 0 and you are setting caching = &quot;ALL&quot; for a column family and using and secondary index for a query this issue occurs. If you set row_cache_size_in_mb this problem goes away.&lt;br/&gt;
Let me know why this is. It would be nice to use row caching and column family caching.&lt;/p&gt;</comment>
                            <comment id="13704633" author="jalkanen" created="Wed, 10 Jul 2013 15:04:40 +0000"  >&lt;p&gt;Is this the same as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4785&quot; title=&quot;Secondary Index Sporadically Doesn&amp;#39;t Return Rows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4785&quot;&gt;&lt;del&gt;CASSANDRA-4785&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4973&quot; title=&quot;Secondary Index stops returning rows when caching=ALL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4973&quot;&gt;&lt;del&gt;CASSANDRA-4973&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13704647" author="adanecito" created="Wed, 10 Jul 2013 15:19:47 +0000"  >&lt;p&gt;Hi Janne,&lt;br/&gt;
&#160;&lt;br/&gt;
There are simularities. Mine though is a solid failure and I narrowed it down to what I said so the Cassandra&#160;team should be able to solve the issue.&lt;br/&gt;
&#160;&lt;br/&gt;
Best Regards,&lt;br/&gt;
-Tony&lt;/p&gt;

&lt;p&gt;From: Janne Jalkanen (JIRA) &amp;lt;jira@apache.org&amp;gt;&lt;br/&gt;
To: adanecito@yahoo.com &lt;br/&gt;
Sent: Wednesday, July 10, 2013 9:05 AM&lt;br/&gt;
Subject: &lt;span class=&quot;error&quot;&gt;&amp;#91;jira&amp;#93;&lt;/span&gt; &lt;span class=&quot;error&quot;&gt;&amp;#91;Commented&amp;#93;&lt;/span&gt; (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5732&quot; title=&quot;Can not query secondary index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5732&quot;&gt;&lt;del&gt;CASSANDRA-5732&lt;/del&gt;&lt;/a&gt;) Can not query secondary index&lt;/p&gt;



&lt;p&gt;&#160; &#160; [ &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5732?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel&amp;amp;focusedCommentId=13704633#comment-13704633&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-5732?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel&amp;amp;focusedCommentId=13704633#comment-13704633&lt;/a&gt; ] &lt;/p&gt;

&lt;p&gt;Janne Jalkanen commented on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5732&quot; title=&quot;Can not query secondary index&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5732&quot;&gt;&lt;del&gt;CASSANDRA-5732&lt;/del&gt;&lt;/a&gt;:&lt;br/&gt;
-------------------------------------------&lt;/p&gt;

&lt;p&gt;Is this the same as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4785&quot; title=&quot;Secondary Index Sporadically Doesn&amp;#39;t Return Rows&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4785&quot;&gt;&lt;del&gt;CASSANDRA-4785&lt;/del&gt;&lt;/a&gt;?&lt;br/&gt;
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &lt;/p&gt;

&lt;p&gt;&amp;#8211;&lt;br/&gt;
This message is automatically generated by JIRA.&lt;br/&gt;
If you think it was sent incorrectly, please contact your JIRA administrators&lt;br/&gt;
For more information on JIRA, see: &lt;a href=&quot;http://www.atlassian.com/software/jira&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.atlassian.com/software/jira&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13772032" author="dmeyer" created="Thu, 19 Sep 2013 16:54:57 +0000"  >&lt;p&gt;This is definitly a bug in latest 1.2.  Just reproduced in 1.2.10&lt;/p&gt;

&lt;p&gt;Repro is easy.  Create single node cluster off of latest 1.2 branch and do the following:&lt;/p&gt;

&lt;p&gt;cqlsh:ks&amp;gt; CREATE TABLE test ( row text, name text, PRIMARY KEY (row) );&lt;br/&gt;
cqlsh:ks&amp;gt; ALTER TABLE test WITH caching=&apos;all&apos;;&lt;br/&gt;
cqlsh:ks&amp;gt; INSERT INTO test (row, name) VALUES ( &apos;row1&apos;, &apos;daniel&apos; );&lt;br/&gt;
cqlsh:ks&amp;gt; INSERT INTO test (row, name) VALUES ( &apos;row2&apos;, &apos;ryan&apos; );&lt;br/&gt;
cqlsh:ks&amp;gt; CREATE INDEX on test (name);&lt;br/&gt;
cqlsh:ks&amp;gt; select * from test where name=&apos;daniel&apos;;&lt;/p&gt;

&lt;p&gt; row  | name&lt;br/&gt;
-----&lt;del&gt;+&lt;/del&gt;-------&lt;br/&gt;
 row1 | daniel&lt;br/&gt;
#Notice how row is returned&lt;/p&gt;

&lt;p&gt;Stop node and set:&lt;br/&gt;
row_cache_size_in_mb: 200&lt;br/&gt;
Start node again and follow this procedure:&lt;/p&gt;

&lt;p&gt;cqlsh&amp;gt; use ks;&lt;br/&gt;
cqlsh:ks&amp;gt; select * from test where name=&apos;daniel&apos;;&lt;br/&gt;
#Nothing is returned from this query&lt;/p&gt;


&lt;p&gt;Now stop the node and set:&lt;br/&gt;
row_cache_size_in_mb: 0&lt;/p&gt;

&lt;p&gt;start the node and do the following:&lt;/p&gt;

&lt;p&gt;cqlsh&amp;gt; use ks;&lt;br/&gt;
cqlsh:ks&amp;gt; select * from test where name=&apos;daniel&apos;;&lt;/p&gt;

&lt;p&gt; row  | name&lt;br/&gt;
-----&lt;del&gt;+&lt;/del&gt;-------&lt;br/&gt;
 row1 | daniel&lt;/p&gt;

&lt;p&gt;#Notice how the row is returned.&lt;/p&gt;</comment>
                            <comment id="13772035" author="jbellis" created="Thu, 19 Sep 2013 16:57:54 +0000"  >&lt;p&gt;Suspect this might be up your alley, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13791509" author="beobal" created="Thu, 10 Oct 2013 14:02:11 +0000"  >&lt;p&gt;The reason for the missing results is that in CFS.getColumnFamily() we look up the cfs id from Schema to calculate the cache key. However, 2i CFSes are never loaded into the Schema, so Schema.instance.getId always returns null. Simply fixing this by calling Schema.instance.load() with the 2i CFMD when the index is initialized uncovers another issue. The cfid is now retrievable, but the deserialization of a cached 2i row fails as it depends on the 2i CFMD being present in the enclosing KSMD for the eventual call to Schema.getCFMD(). Once we start adding index CFs to Schema they then become involved in schema migrations which makes everything very messy. So rather than adding them directly to KSMD like regular CFs, I added a separate cfId-&amp;gt;CFMD map to Schema, so as far as most things are concerned nothing has changed, just we have one further place to look when retrieving CFMD for a given cfId.&lt;/p&gt;

&lt;p&gt;The attached patch is against the 1.2 branch, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4875&quot; title=&quot;Revert IAuthority2 interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4875&quot;&gt;&lt;del&gt;CASSANDRA-4875&lt;/del&gt;&lt;/a&gt; is a duplicate of this, but has a fixver of 1.1 &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt;, do you want me to submit a patch against 1.1 also?&lt;/p&gt;

&lt;p&gt;I wrote a dtest for this, pull request for that here: &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/22&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/riptano/cassandra-dtest/pull/22&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Looking at this, I also uncovered what I think is an issue with the setup of the 2i cache config. In AbstractSimplePerColumnSecondaryIndex (in 1.2, the same code is in KeysIndex in 1.1), the estimated key and mean column counts are used to gauge the index&apos;s cardinality then use that to decide whether or not to enable row caching. This calculation is first performed prior to the index actually being built, so there are no SSTables to provide the estimates, which results in row caching always being disabled until the next time the index is initialized when C* is restarted (this appears to be why the repro steps require a restart). If this is a genuine problem, I&apos;ll create a separate JIRA to address it. &lt;/p&gt;</comment>
                            <comment id="13791809" author="jbellis" created="Thu, 10 Oct 2013 18:24:18 +0000"  >&lt;p&gt;Hmm, it&apos;s not actually necessary to look up your id through the schema here.  v2 is a simpler solution if that&apos;s the only problem.&lt;/p&gt;</comment>
                            <comment id="13791840" author="beobal" created="Thu, 10 Oct 2013 18:50:09 +0000"  >&lt;p&gt;Yeah, unfortunately that failed lookup was only masking the other problem I mentioned. Even with the v2 fix, without the index cfm in Schema, you fall foul (silently, except for debug) of &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-1.2/src/java/org/apache/cassandra/db/ColumnFamilySerializer.java#L183&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-1.2/src/java/org/apache/cassandra/db/ColumnFamilySerializer.java#L183&lt;/a&gt; and so the row cache is effectively bypassed for 2i cfs.&lt;/p&gt;</comment>
                            <comment id="13791912" author="jbellis" created="Thu, 10 Oct 2013 19:49:26 +0000"  >&lt;p&gt;I see.&lt;/p&gt;

&lt;p&gt;I think your patch is probably fine, but I&apos;m super nervous about messing with Schema internals this late in 1.2.x (let alone 1.1).&lt;/p&gt;

&lt;p&gt;v3 just disables row cache entirely for 2i CFs.&lt;/p&gt;</comment>
                            <comment id="13791923" author="beobal" created="Thu, 10 Oct 2013 19:59:19 +0000"  >&lt;p&gt;Sure, that&apos;s reasonable and pretty much expected. I&apos;ll attach a patch for trunk/2.0&lt;/p&gt;</comment>
                            <comment id="13793693" author="jbellis" created="Sun, 13 Oct 2013 16:14:59 +0000"  >&lt;p&gt;Committed v3 then.&lt;/p&gt;

&lt;p&gt;I don&apos;t think it&apos;s worth doing extra work for 2.0 since we&apos;re removing row cache for 2.1.&lt;/p&gt;</comment>
                            <comment id="13896378" author="jeromatron" created="Mon, 10 Feb 2014 10:09:57 +0000"  >&lt;p&gt;FWIW, appears to also be a problem in Cassandra 1.1.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12611096">CASSANDRA-4785</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12607811" name="5732-1.2" size="3943" author="samt" created="Thu, 10 Oct 2013 14:02:31 +0000"/>
                            <attachment id="12607852" name="5732-v2.txt" size="1850" author="jbellis" created="Thu, 10 Oct 2013 18:24:18 +0000"/>
                            <attachment id="12607870" name="5732-v3.txt" size="2889" author="jbellis" created="Thu, 10 Oct 2013 19:49:26 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>336925</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 41 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1m46f:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>337248</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12323843">1.1.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>