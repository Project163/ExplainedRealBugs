<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:02:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11609] Nested UDTs cause error when migrating 2.x schema to trunk</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11609</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This was found in the upgrades user_types_test.&lt;/p&gt;

&lt;p&gt;Can also be repro&apos;d with ccm.&lt;/p&gt;

&lt;p&gt;To repro using ccm:&lt;/p&gt;

&lt;p&gt;Create a 1 node cluster on 2.2.x&lt;/p&gt;

&lt;p&gt;Create this schema:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;create keyspace test2 with replication = {&apos;class&apos;:&apos;SimpleStrategy&apos;, &apos;replication_factor&apos;:1};
use test2;
CREATE TYPE address (
         street text,
         city text,
         zip_code int,
         phones set&amp;lt;text&amp;gt;
         );
CREATE TYPE fullname (
         irstname text,
         astname text
         );
CREATE TABLE users (
         d uuid PRIMARY KEY,
         ame frozen&amp;lt;fullname&amp;gt;,
         ddresses map&amp;lt;text, frozen&amp;lt;address&amp;gt;&amp;gt;
         );
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Upgrade the single node to trunk, attempt to start the node up. Start will fail with this exception:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [main] 2016-04-19 11:33:19,218 CassandraDaemon.java:704 - Exception encountered during startup
org.apache.cassandra.exceptions.InvalidRequestException: Non-frozen UDTs are not allowed inside collections: map&amp;lt;text, address&amp;gt;
        at org.apache.cassandra.cql3.CQL3Type$Raw$RawCollection.throwNestedNonFrozenError(CQL3Type.java:686) ~[main/:na]
        at org.apache.cassandra.cql3.CQL3Type$Raw$RawCollection.prepare(CQL3Type.java:652) ~[main/:na]
        at org.apache.cassandra.cql3.CQL3Type$Raw$RawCollection.prepareInternal(CQL3Type.java:644) ~[main/:na]
        at org.apache.cassandra.schema.CQLTypeParser.parse(CQLTypeParser.java:53) ~[main/:na]
        at org.apache.cassandra.schema.SchemaKeyspace.createColumnFromRow(SchemaKeyspace.java:1022) ~[main/:na]
        at org.apache.cassandra.schema.SchemaKeyspace.lambda$fetchColumns$12(SchemaKeyspace.java:1006) ~[main/:na]
        at java.lang.Iterable.forEach(Iterable.java:75) ~[na:1.8.0_77]
        at org.apache.cassandra.schema.SchemaKeyspace.fetchColumns(SchemaKeyspace.java:1006) ~[main/:na]
        at org.apache.cassandra.schema.SchemaKeyspace.fetchTable(SchemaKeyspace.java:960) ~[main/:na]
        at org.apache.cassandra.schema.SchemaKeyspace.fetchTables(SchemaKeyspace.java:939) ~[main/:na]
        at org.apache.cassandra.schema.SchemaKeyspace.fetchKeyspace(SchemaKeyspace.java:902) ~[main/:na]
        at org.apache.cassandra.schema.SchemaKeyspace.fetchKeyspacesWithout(SchemaKeyspace.java:879) ~[main/:na]
        at org.apache.cassandra.schema.SchemaKeyspace.fetchNonSystemKeyspaces(SchemaKeyspace.java:867) ~[main/:na]
        at org.apache.cassandra.config.Schema.loadFromDisk(Schema.java:134) ~[main/:na]
        at org.apache.cassandra.config.Schema.loadFromDisk(Schema.java:124) ~[main/:na]
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:229) [main/:na]
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:558) [main/:na]
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:687) [main/:na]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12960068">CASSANDRA-11609</key>
            <summary>Nested UDTs cause error when migrating 2.x schema to trunk</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="rhatch">Russ Hatch</reporter>
                        <labels>
                    </labels>
                <created>Tue, 19 Apr 2016 17:42:27 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:35 +0000</updated>
                            <resolved>Fri, 29 Apr 2016 20:54:28 +0000</resolved>
                                        <fixVersion>3.6</fixVersion>
                                    <component>Legacy/Distributed Metadata</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="15250114" author="slebresne" created="Wed, 20 Apr 2016 15:45:03 +0000"  >&lt;p&gt;It would sound like we&apos;re losing the frozeness information during the upgrade of the schema somehow.&lt;br/&gt;
Slightly confused by the &quot;Can be repro&apos;d with ccm&quot; though: are you able to reproduce with the step you provide here or not?&lt;/p&gt;</comment>
                            <comment id="15250263" author="rhatch" created="Wed, 20 Apr 2016 16:59:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Yes, it should repro easily with the steps above.&lt;/p&gt;</comment>
                            <comment id="15250296" author="rhatch" created="Wed, 20 Apr 2016 17:17:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11613&quot; title=&quot;dtest failure in upgrade_tests.cql_tests.TestCQLNodes2RF1_2_2_HEAD_UpTo_Trunk.more_user_types_test&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11613&quot;&gt;&lt;del&gt;CASSANDRA-11613&lt;/del&gt;&lt;/a&gt; started happening recently as well (and involves upgrading UDT schema) so I wonder if they could have the same cause.&lt;/p&gt;</comment>
                            <comment id="15250492" author="thobbs" created="Wed, 20 Apr 2016 18:49:27 +0000"  >&lt;p&gt;This was probably triggered by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7423&quot; title=&quot;Allow updating individual subfields of UDT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7423&quot;&gt;&lt;del&gt;CASSANDRA-7423&lt;/del&gt;&lt;/a&gt;, I&apos;ll look into it.&lt;/p&gt;</comment>
                            <comment id="15250937" author="thobbs" created="Wed, 20 Apr 2016 23:28:52 +0000"  >&lt;p&gt;The root of the problem was that in the 2.x schema, implicitly frozen types (like nested UDTs) were not wrapped in &lt;tt&gt;FrozenType()&lt;/tt&gt;.  Before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7423&quot; title=&quot;Allow updating individual subfields of UDT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7423&quot;&gt;&lt;del&gt;CASSANDRA-7423&lt;/del&gt;&lt;/a&gt;, these were still implicitly frozen, so the 2.x -&amp;gt; 3.x migration correctly converted them.  After 7423 this no longer happens, so they need to be explicitly converted as part of the schema migration.&lt;/p&gt;

&lt;p&gt;Migrations from 2.x -&amp;gt; 3.0.x -&amp;gt; 3.x should be fine without this patch.&lt;/p&gt;

&lt;p&gt;I attempted to extend &lt;tt&gt;LegacySchemaMigratorTest&lt;/tt&gt; to cover this, but unfortunately it doesn&apos;t seem possible to create a table that uses a UDT within the test framework.  So, I think we&apos;ll need to continue to rely on the existing upgrade tests for coverage here.&lt;/p&gt;

&lt;p&gt;Patch and pending CI runs:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;testall&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-11609&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CASSANDRA-11609&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-11609-testall&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/thobbs/job/thobbs-CASSANDRA-11609-dtest&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; would you mind reviewing?&lt;/p&gt;</comment>
                            <comment id="15262553" author="thobbs" created="Thu, 28 Apr 2016 17:15:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; ping. Just want to make sure this gets in before 3.6 to avoid a regression.&lt;/p&gt;</comment>
                            <comment id="15264326" author="blerer" created="Fri, 29 Apr 2016 16:49:59 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="15264717" author="thobbs" created="Fri, 29 Apr 2016 20:54:28 +0000"  >&lt;p&gt;Thanks, committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/d62b2cf7c77b01723c4d312bcc249c91a73b4e45&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;d62b2cf7c77b01723c4d312bcc249c91a73b4e45&lt;/tt&gt;&lt;/a&gt; to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 29 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2wbzz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12335055">3.6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>blerer</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>