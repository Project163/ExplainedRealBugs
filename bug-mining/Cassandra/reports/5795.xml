<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:21:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16796] Clear pending ranges for a SHUTDOWN peer</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16796</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If a node involved in a MOVE operation should fail, peers can sometimes maintain pending ranges for it even when it has left&#160;the ring and/or been replaced (in practice until the peer is next bounced). This in turn can lead to bogus unavailable responses to clients if a replica for the any of the pending ranges should go down.&lt;/p&gt;

&lt;p&gt;If the moving node crashes hard, a subsequent replacement will correctly fail as long as cassandra.consistent.rangemovement is set to true because the new node will learn the MOVING status from the remaining peers. A graceful shutdown, however, causes that status to be replaced with SHUTDOWN, but doesn&apos;t update TokenMetadata, so pending ranges remain for the down node, even after it has been removed from the ring.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13389174">CASSANDRA-16796</key>
            <summary>Clear pending ranges for a SHUTDOWN peer</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="samt">Sam Tunnicliffe</reporter>
                        <labels>
                    </labels>
                <created>Mon, 12 Jul 2021 15:32:17 +0000</created>
                <updated>Tue, 20 Jul 2021 18:42:52 +0000</updated>
                            <resolved>Tue, 20 Jul 2021 18:42:52 +0000</resolved>
                                        <fixVersion>3.0.25</fixVersion>
                    <fixVersion>3.11.11</fixVersion>
                    <fixVersion>4.0.1</fixVersion>
                                    <component>Cluster/Membership</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17379301" author="beobal" created="Mon, 12 Jul 2021 17:38:27 +0000"  >&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/16796-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;16796-3.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/beobal/cassandra?branch=16796-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/16796-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;16796-3.11&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/beobal/cassandra?branch=16796-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/16796-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;16796-4.0&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/beobal/cassandra?branch=16796-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/beobal/cassandra/tree/16796-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;16796-trunk&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/beobal/cassandra?branch=16796-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;circle&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The 3.0/3.11 &amp;amp; 4.0/trunk patches are basically the same, so I&apos;ve only kicked off ci-c jobs for &lt;br/&gt;
&lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/936&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt; and &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/936&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17383658" author="maedhroz" created="Mon, 19 Jul 2021 23:31:16 +0000"  >&lt;p&gt;Two questions...&lt;/p&gt;

&lt;p&gt;1.) So just to make things explicit (for me, a non-gossip expert), notifying subscribers in &lt;tt&gt;onChange()&lt;/tt&gt; means we hit &lt;tt&gt;updateNormalTokens()&lt;/tt&gt;, which removes the endpoint from the &quot;moving endpoints&quot; set and eventually removes the pending ranges?&lt;/p&gt;

&lt;p&gt;2.) What guarantees that a &lt;tt&gt;PendingRangeTask&lt;/tt&gt; has run by the time &lt;tt&gt;gossipShutdownUpdatesTokenMetadata()&lt;/tt&gt; verifies there are no longer pending range for node 2? &lt;/p&gt;

&lt;p&gt;The 3.0 patch looks good, so moving on to 4.0...&lt;/p&gt;
</comment>
                            <comment id="17384092" author="beobal" created="Tue, 20 Jul 2021 11:26:57 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;So just to make things explicit (for me, a non-gossip expert), notifying subscribers in onChange() means we hit updateNormalTokens(), which removes the endpoint from the &quot;moving endpoints&quot; set and eventually removes the pending ranges?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, that&apos;s right. The shutting down node is essentially returning to a &lt;tt&gt;NORMAL&lt;/tt&gt; state, so we just make sure that all&lt;br/&gt;
relevant parties (i.e. &lt;tt&gt;TokenMetadata&lt;/tt&gt; ) are aware.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;What guarantees that a PendingRangeTask has run by the time gossipShutdownUpdatesTokenMetadata() verifies there are no longer pending range for node 2?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good catch, I haven&apos;t seen any failures yet, but this definitely has the potential for flakiness. I&apos;ve added a log&lt;br/&gt;
statement at &lt;tt&gt;DEBUG&lt;/tt&gt; at the end of &lt;tt&gt;Gossiper::markAsShutdown&lt;/tt&gt; to gate the test on, plus a blocking wait in the&lt;br/&gt;
assertion to ensure the PRT is complete before we check.&lt;/p&gt;

&lt;p&gt;Circle runs are in the same place as before, new ASF CI jobs here: &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/961&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/962&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;4.0&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17384363" author="maedhroz" created="Tue, 20 Jul 2021 16:09:33 +0000"  >&lt;p&gt;+1 on all patches&lt;/p&gt;

&lt;p&gt;Just watch out for the unused imports in &lt;tt&gt;GossipTest&lt;/tt&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17384434" author="beobal" created="Tue, 20 Jul 2021 18:42:52 +0000"  >&lt;p&gt;Thanks, cleaned up those unused imports and committed to 3.0 and merged to 3.11 -&amp;gt; 4.0 -&amp;gt; trunk.&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12994" cascade-level="1"><![CDATA[Unavailable]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 17 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0sv88:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333891">3.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/fbb20b9162b73c4de8a82cf4ffdde3304e904603&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/fbb20b9162b73c4de8a82cf4ffdde3304e904603&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;new dtest added&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>