<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:35 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5670] running compact on an index did not compact two index files into one</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5670</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;With a data directory containing secondary index files ending in -1 and -2, I expected that when I ran compact against the index that they would compact down to a set of -3 files.  This column family uses SizeTieredCompactionStrategy.&lt;/p&gt;

&lt;p&gt;Using our standard CQL example, the compact command used was: &lt;br/&gt;
$ ./nodetool compact test1 test1-playlists.playlists_artist_idx&lt;/p&gt;

&lt;p&gt;Please note: reproducing this test on 1.1.12 (using a single primary key), you will see that running compact on the keyspace also does not compact the index file.  There is no option to compact the index, so I could not compare that.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE KEYSPACE test1 WITH replication = {&apos;class&apos;:&apos;SimpleStrategy&apos;, &apos;replication_factor&apos;:1};

use test1;

CREATE TABLE playlists (
  id uuid,
  song_order int,
  song_id uuid,
  title text,
  album text,
  artist text,
  PRIMARY KEY  (id, song_order ) );

INSERT INTO playlists (id, song_order, song_id, title, artist, album)
  VALUES (62c36092-82a1-3a00-93d1-46196ee77204, 1,
  a3e64f8f-bd44-4f28-b8d9-6938726e34d4, &apos;La Grange&apos;, &apos;ZZ Top&apos;, &apos;Tres Hombres&apos;);

select * from playlists;

=====================================
./nodetool flush test1

$ ls /var/lib/cassandra/data/test1/playlists
test1-playlists-ic-1-CompressionInfo.db				
test1-playlists-ic-1-Data.db	
test1-playlists-ic-1-Filter.db					
test1-playlists-ic-1-Index.db					
test1-playlists-ic-1-Statistics.db				
test1-playlists-ic-1-Summary.db					
test1-playlists-ic-1-TOC.txt					

=====================================

CREATE INDEX ON playlists(artist );
select * from playlists;
select * from playlists where artist = &apos;ZZ Top&apos;;

=====================================
$ ./nodetool flush test1

$ ls /var/lib/cassandra/data/test1/playlists
test1-playlists-ic-1-CompressionInfo.db			
test1-playlists-ic-1-Data.db					
test1-playlists-ic-1-Filter.db					
test1-playlists-ic-1-Index.db					
test1-playlists-ic-1-Statistics.db				
test1-playlists-ic-1-Summary.db					
test1-playlists-ic-1-TOC.txt					
	
test1-playlists.playlists_artist_idx-ic-1-CompressionInfo.db
test1-playlists.playlists_artist_idx-ic-1-Data.db
test1-playlists.playlists_artist_idx-ic-1-Filter.db
test1-playlists.playlists_artist_idx-ic-1-Index.db
test1-playlists.playlists_artist_idx-ic-1-Statistics.db
test1-playlists.playlists_artist_idx-ic-1-Summary.db
test1-playlists.playlists_artist_idx-ic-1-TOC.txt

=====================================

delete artist from playlists where id = 62c36092-82a1-3a00-93d1-46196ee77204 and song_order = 1;
select * from playlists;
select * from playlists where artist = &apos;ZZ Top&apos;;

=====================================
$ ./nodetool flush test1

$ ls /var/lib/cassandra/data/test1/playlists
test1-playlists-ic-1-CompressionInfo.db	
test1-playlists-ic-1-Data.db					
test1-playlists-ic-1-Filter.db					
test1-playlists-ic-1-Index.db					
test1-playlists-ic-1-Statistics.db				
test1-playlists-ic-1-Summary.db					
test1-playlists-ic-1-TOC.txt					
test1-playlists-ic-2-CompressionInfo.db				
test1-playlists-ic-2-Data.db					
test1-playlists-ic-2-Filter.db					
test1-playlists-ic-2-Index.db					
test1-playlists-ic-2-Statistics.db				
test1-playlists-ic-2-Summary.db					
test1-playlists-ic-2-TOC.txt
			
test1-playlists.playlists_artist_idx-ic-1-CompressionInfo.db
test1-playlists.playlists_artist_idx-ic-1-Data.db
test1-playlists.playlists_artist_idx-ic-1-Filter.db
test1-playlists.playlists_artist_idx-ic-1-Index.db
test1-playlists.playlists_artist_idx-ic-1-Statistics.db
test1-playlists.playlists_artist_idx-ic-1-Summary.db
test1-playlists.playlists_artist_idx-ic-1-TOC.txt
test1-playlists.playlists_artist_idx-ic-2-CompressionInfo.db
test1-playlists.playlists_artist_idx-ic-2-Data.db
test1-playlists.playlists_artist_idx-ic-2-Filter.db
test1-playlists.playlists_artist_idx-ic-2-Index.db
test1-playlists.playlists_artist_idx-ic-2-Statistics.db
test1-playlists.playlists_artist_idx-ic-2-Summary.db
test1-playlists.playlists_artist_idx-ic-2-TOC.txt

=====================================

./nodetool compact test1

$ ls /var/lib/cassandra/data/test1/playlists
test1-playlists-ic-3-CompressionInfo.db
test1-playlists-ic-3-Data.db
test1-playlists-ic-3-Filter.db
test1-playlists-ic-3-Index.db
test1-playlists-ic-3-Statistics.db
test1-playlists-ic-3-Summary.db
test1-playlists-ic-3-TOC.txt
test1-playlists.playlists_artist_idx-ic-1-CompressionInfo.db
test1-playlists.playlists_artist_idx-ic-1-Data.db
test1-playlists.playlists_artist_idx-ic-1-Filter.db
test1-playlists.playlists_artist_idx-ic-1-Index.db
test1-playlists.playlists_artist_idx-ic-1-Statistics.db
test1-playlists.playlists_artist_idx-ic-1-Summary.db
test1-playlists.playlists_artist_idx-ic-1-TOC.txt
test1-playlists.playlists_artist_idx-ic-2-CompressionInfo.db
test1-playlists.playlists_artist_idx-ic-2-Data.db
test1-playlists.playlists_artist_idx-ic-2-Filter.db
test1-playlists.playlists_artist_idx-ic-2-Index.db
test1-playlists.playlists_artist_idx-ic-2-Statistics.db
test1-playlists.playlists_artist_idx-ic-2-Summary.db
test1-playlists.playlists_artist_idx-ic-2-TOC.txt

=====================================

$ ./nodetool compact test1 test1-playlists.playlists_artist_idx

$ ls /var/lib/cassandra/data/test1/playlists
test1-playlists-ic-3-CompressionInfo.db
test1-playlists-ic-3-Data.db
test1-playlists-ic-3-Filter.db
test1-playlists-ic-3-Index.db
test1-playlists-ic-3-Statistics.db
test1-playlists-ic-3-Summary.db
test1-playlists-ic-3-TOC.txt
test1-playlists.playlists_artist_idx-ic-1-CompressionInfo.db
test1-playlists.playlists_artist_idx-ic-1-Data.db
test1-playlists.playlists_artist_idx-ic-1-Filter.db
test1-playlists.playlists_artist_idx-ic-1-Index.db
test1-playlists.playlists_artist_idx-ic-1-Statistics.db
test1-playlists.playlists_artist_idx-ic-1-Summary.db
test1-playlists.playlists_artist_idx-ic-1-TOC.txt
test1-playlists.playlists_artist_idx-ic-2-CompressionInfo.db
test1-playlists.playlists_artist_idx-ic-2-Data.db
test1-playlists.playlists_artist_idx-ic-2-Filter.db
test1-playlists.playlists_artist_idx-ic-2-Index.db
test1-playlists.playlists_artist_idx-ic-2-Statistics.db
test1-playlists.playlists_artist_idx-ic-2-Summary.db
test1-playlists.playlists_artist_idx-ic-2-TOC.txt


=====================================
cqlsh:test1&amp;gt; describe keyspace test1;

CREATE KEYSPACE test1 WITH replication = {
  &apos;class&apos;: &apos;SimpleStrategy&apos;,
  &apos;replication_factor&apos;: &apos;1&apos;
};

USE test1;

CREATE TABLE playlists (
  id uuid,
  song_order int,
  album text,
  artist text,
  song_id uuid,
  title text,
  PRIMARY KEY (id, song_order)
) WITH
  bloom_filter_fp_chance=0.010000 AND
  caching=&apos;KEYS_ONLY&apos; AND
  comment=&apos;&apos; AND
  dclocal_read_repair_chance=0.000000 AND
  gc_grace_seconds=864000 AND
  read_repair_chance=0.100000 AND
  replicate_on_write=&apos;true&apos; AND
  populate_io_cache_on_flush=&apos;false&apos; AND
  compaction={&apos;class&apos;: &apos;SizeTieredCompactionStrategy&apos;} AND
  compression={&apos;sstable_compression&apos;: &apos;SnappyCompressor&apos;};

CREATE INDEX playlists_artist_idx ON playlists (artist);

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12653833">CASSANDRA-5670</key>
            <summary>running compact on an index did not compact two index files into one</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jasobrown">Jason Brown</assignee>
                                    <reporter username="cdaw">Cathy Daw</reporter>
                        <labels>
                            <label>nodetool</label>
                            <label>secondary_index</label>
                    </labels>
                <created>Thu, 20 Jun 2013 01:14:37 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:11 +0000</updated>
                            <resolved>Tue, 30 Jul 2013 20:54:24 +0000</resolved>
                                        <fixVersion>1.2.9</fixVersion>
                    <fixVersion>2.0 rc1</fixVersion>
                                    <component>Legacy/Tools</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13691065" author="michalm" created="Sat, 22 Jun 2013 06:25:35 +0000"  >&lt;p&gt;I think it&apos;s impossible to compact secondary index CF using nodetool - I remember that I tried it once with 1.2.1 when having a problem with indexes and as far as I remember I was getting an exception (or just notting happened, I&apos;m not sure now). I had to use JMX to compact it. Anyway, I&apos;ll check it.&lt;/p&gt;</comment>
                            <comment id="13691068" author="michalm" created="Sat, 22 Jun 2013 06:38:25 +0000"  >&lt;p&gt;Yes, as I supposed, found in log:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; WARN 08:09:53,952 Operation not allowed on secondary Index column family (test1-
playlists.playlists_artist_idx)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So &quot;it&apos;s not a bug, it&apos;s a feature&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;JMX&apos;s forceMajorCompaction call works fine.&lt;/p&gt;</comment>
                            <comment id="13691082" author="michalm" created="Sat, 22 Jun 2013 08:18:09 +0000"  >&lt;p&gt;BTW. method that decides what to compact accepts two boolean flags that tell (a) if index CFs should be allowed and (b) if index CFs should be automatically included in compaction, so adding a &quot;--with-indexes&quot; to &quot;nodetool compact&quot; command and/or adding a separate &quot;nodetool compactindex&quot; command will not be a problem.&lt;/p&gt;</comment>
                            <comment id="13691353" author="jbellis" created="Sun, 23 Jun 2013 05:59:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;it&apos;s not a bug, it&apos;s a feature&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I thought we are allowing it in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4464&quot; title=&quot;expose 2I CFs to the rest of nodetool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4464&quot;&gt;&lt;del&gt;CASSANDRA-4464&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;What is nodetool doing if not calling forceMajorCompaction?&lt;/p&gt;</comment>
                            <comment id="13691371" author="michalm" created="Sun, 23 Jun 2013 07:24:30 +0000"  >&lt;blockquote&gt;&lt;p&gt;I thought we are allowing it in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4464&quot; title=&quot;expose 2I CFs to the rest of nodetool&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4464&quot;&gt;&lt;del&gt;CASSANDRA-4464&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;My bad, didn&apos;t know about the task you mentioned. &lt;br/&gt;
I thought that it maybe was overwritten by other patch, but it wasn&apos;t - it seems it was intended (or it&apos;s just a mistake):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ git show cef8eb0
(...)
     public void forceTableCompaction(String tableName, String... columnFamilies) throws IOException, ExecutionException, InterruptedExcepti
     {
-        for (ColumnFamilyStore cfStore : getValidColumnFamilies(tableName, columnFamilies))
+        for (ColumnFamilyStore cfStore : getValidColumnFamilies(false, false, tableName, columnFamilies))
         {
             cfStore.forceMajorCompaction();
         }&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;BTW. I can see your comment in that task ( &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4464?focusedCommentId=13461974&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13461974&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-4464?focusedCommentId=13461974&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-13461974&lt;/a&gt; ) didn&apos;t mention &quot;compact&quot; in any of the categories, so I&apos;d guess it was just &quot;forgotten&quot;.&lt;/p&gt;

&lt;p&gt;Anyway, I can&apos;t see a good reason to disallow compacting indexes via nodetool.&lt;/p&gt;</comment>
                            <comment id="13724309" author="jasobrown" created="Tue, 30 Jul 2013 19:41:08 +0000"  >&lt;p&gt;(Getting back to this one now). I worked from the list of tasks that Jonathan provided in the comment linked to above - and, yeah, looks like compact was left out or forgotten. Will work on adding compacting 2is today.&lt;/p&gt;</comment>
                            <comment id="13724329" author="jasobrown" created="Tue, 30 Jul 2013 19:54:09 +0000"  >&lt;p&gt;v1 simply enables compaction on 2Is (changes a false argument to true)&lt;/p&gt;</comment>
                            <comment id="13724346" author="jbellis" created="Tue, 30 Jul 2013 20:14:57 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13724410" author="jasobrown" created="Tue, 30 Jul 2013 20:53:48 +0000"  >&lt;p&gt;commmitted to 1.2 and trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12595031" name="5670-v1.diff" size="1154" author="jasobrown" created="Tue, 30 Jul 2013 19:54:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334110</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 17 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1lmvj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>334436</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>