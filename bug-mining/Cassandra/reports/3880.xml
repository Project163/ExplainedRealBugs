<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:58:29 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10377] AssertionError: attempted to delete non-existing file CommitLog</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10377</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After several hours of script tests (create and drop users, keyspaces and tables) exception is thrown:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR 02:58:39 Failed managing commit log segments. Commit disk failure policy is stop; terminating thread
java.lang.AssertionError: attempted to delete non-existing file CommitLog-5-1442599226756.log
	at org.apache.cassandra.io.util.FileUtils.deleteWithConfirm(FileUtils.java:122) ~[main/:na]
	at org.apache.cassandra.io.util.FileUtils.deleteWithConfirm(FileUtils.java:149) ~[main/:na]
	at org.apache.cassandra.db.commitlog.CommitLogSegment.discard(CommitLogSegment.java:314) ~[main/:na]
	at org.apache.cassandra.db.commitlog.CommitLogSegmentManager$2.run(CommitLogSegmentManager.java:374) ~[main/:na]
	at org.apache.cassandra.db.commitlog.CommitLogSegmentManager$1.runMayThrow(CommitLogSegmentManager.java:155) ~[main/:na]
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) [main/:na]
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:745) [na:1.8.0_45]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I added some logs to &lt;b&gt;deleteWithConfirm&lt;/b&gt; and it showed that this file really was deleted by previous delete action, i.e. it was second attempt to delete the same log. Commit log with next number exists in the same time, so log was switched.&lt;/p&gt;

&lt;p&gt;I disabled assert and it seems to have no no bad effect.&lt;/p&gt;</description>
                <environment>&lt;p&gt;CentOS 7.1/x64&lt;/p&gt;</environment>
        <key id="12888771">CASSANDRA-10377</key>
            <summary>AssertionError: attempted to delete non-existing file CommitLog</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vovodroid">Vovodroid</assignee>
                                    <reporter username="vovodroid">Vovodroid</reporter>
                        <labels>
                    </labels>
                <created>Sat, 19 Sep 2015 14:17:15 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:55 +0000</updated>
                            <resolved>Sat, 17 Oct 2015 10:37:29 +0000</resolved>
                                        <fixVersion>2.1.12</fixVersion>
                    <fixVersion>2.2.4</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14900009" author="vovodroid" created="Sun, 20 Sep 2015 17:47:48 +0000"  >&lt;p&gt;I added more logs, here is whole picture:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Commit log segment CommitLogSegment(CommitLog-5-1442725099391.log) is unused, force recycleSegment, TID:86
Add task CommitLogSegmentManager$2@15a719ab
Commit log segment CommitLogSegment(CommitLog-5-1442725099391.log) is unused, recycleSegment, TID:18
Add task CommitLogSegmentManager$2@4a81b2cf
segmentManagementTasks.take and run CommitLogSegmentManager$2@15a719ab
deleteWithConfirm [CommitLog-5-1442725099391.log] 
segmentManagementTasks.poll and run CommitLogSegmentManager$2@4a81b2cf
deleteWithConfirm [CommitLog-5-1442725099391.log] 
not exists CommitLog-5-1442725099391.log
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So what happened?&lt;br/&gt;
1) Function &lt;b&gt;forceRecycleAll&lt;/b&gt; in thread 86 decided that segment is unused and forced enqueuing deletion task &lt;b&gt;15a719ab&lt;/b&gt;&lt;br/&gt;
2) Function &lt;b&gt;discardCompletedSegments&lt;/b&gt; in thread 18 decided that segment is unused and enqueued deletion task &lt;b&gt;4a81b2cf&lt;/b&gt;&lt;br/&gt;
3) Task &lt;b&gt;15a719ab&lt;/b&gt; was dequeued and file was deleted.&lt;br/&gt;
4) Task &lt;b&gt;4a81b2cf&lt;/b&gt; was dequeued and the same file was tried to be deleted.&lt;/p&gt;

&lt;p&gt;Any thoughts? If it&apos;s normal behavior probably allow segment deletion to not fail if file doesn&apos;t not exist ( call deleteWithConfirm(file, false, null) ?&lt;/p&gt;</comment>
                            <comment id="14940737" author="vovodroid" created="Fri, 2 Oct 2015 03:48:00 +0000"  >&lt;p&gt;It seems I found reason for issue. Function &lt;b&gt;recycleSegment&lt;/b&gt; is called from different threads, then it removes segment from activeSegments queue and then it queues segment deletion task, even if segment not found in activeSegments queue.&lt;/p&gt;

&lt;p&gt;Due to racing it possible that &lt;b&gt;recycleSegment&lt;/b&gt; will be called twice and thus two identical deletion task will be queued.&lt;/p&gt;

&lt;p&gt;Proposed patch check remove from activeSegments queue result and delete segment only if it found in queue.&lt;/p&gt;</comment>
                            <comment id="14950300" author="snazy" created="Fri, 9 Oct 2015 12:20:39 +0000"  >&lt;p&gt;Your analysis WRT race condition seems to be correct. EDIT: Appreciate your effort to analyze this!&lt;br/&gt;
I dug a bit deeper into the whole CL thing. Just an idea (not necessarily correct): Maybe it&apos;s worth to make &lt;tt&gt;CLS.discard()&lt;/tt&gt; synchronized and check inside CLS whether the file should be deleted. OTOH your approach should work - but I&apos;d like to have someone else&apos;s opinion. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt; ?&lt;br/&gt;
Beside that, the patch should also cover 2.1, as the race condition is also present there.&lt;/p&gt;</comment>
                            <comment id="14950302" author="vovodroid" created="Fri, 9 Oct 2015 12:25:16 +0000"  >&lt;p&gt;------your approach should work - but I&apos;d like to have someone else&apos;s opinion.&lt;/p&gt;

&lt;p&gt;Sure, it&apos;s better to prevent racing than test this in latest moment.&lt;/p&gt;</comment>
                            <comment id="14952859" author="blambov" created="Mon, 12 Oct 2015 09:37:18 +0000"  >&lt;p&gt;I think this is a good solution; any new code trying to delete an active segment will go through &lt;tt&gt;recycleSegment&lt;/tt&gt; and will also be protected by the atomicity of the &lt;tt&gt;activeSegments&lt;/tt&gt; queue.&lt;/p&gt;

&lt;p&gt;+1 to commit.&lt;/p&gt;</comment>
                            <comment id="14952915" author="snazy" created="Mon, 12 Oct 2015 10:48:12 +0000"  >&lt;p&gt;Alright - have setup branches for 2.1 + 2.2 (merges to 3.0, trunk), waiting for CI results.&lt;/p&gt;</comment>
                            <comment id="14957270" author="snazy" created="Wed, 14 Oct 2015 16:58:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vovodroid&quot; class=&quot;user-hover&quot; rel=&quot;vovodroid&quot;&gt;vovodroid&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt;, can you take a look at the 2.1 branch? It uses the same approach, but is a bit different as this piece of code changed between 2.1 and 2.2.&lt;/p&gt;</comment>
                            <comment id="14957386" author="vovodroid" created="Wed, 14 Oct 2015 17:56:16 +0000"  >&lt;p&gt;Yes, in 2.1 function looks as&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    void recycleSegment(&lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; CommitLogSegment segment)
    {
        &lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; archiveSuccess = CommitLog.instance.archiver.maybeWaitForArchiving(segment.getName());
        activeSegments.remove(segment);
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!archiveSuccess)
        {
            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; archiving (command) was not successful then leave the file alone. don&apos;t delete or recycle.
&lt;/span&gt;            discardSegment(segment, &lt;span class=&quot;code-keyword&quot;&gt;false&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isCapExceeded() || !DatabaseDescriptor.getCommitLogSegmentRecyclingEnabled())
        {
            discardSegment(segment, &lt;span class=&quot;code-keyword&quot;&gt;true&lt;/span&gt;);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
        }

        logger.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Recycling {}&quot;&lt;/span&gt;, segment);
        segmentManagementTasks.add(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Callable&amp;lt;CommitLogSegment&amp;gt;()
        {
            &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; CommitLogSegment call()
            {
                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; segment.recycle();
            }
        });
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;So fix can be &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (!activeSegments.remove(segment))
{
    logger.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;segment {} not found in activeSegments queue&quot;&lt;/span&gt;, segment);
    &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="14957595" author="snazy" created="Wed, 14 Oct 2015 19:40:04 +0000"  >&lt;p&gt;Yea - that looks cleaner. Updated and pushed that change it.&lt;/p&gt;</comment>
                            <comment id="14961843" author="snazy" created="Sat, 17 Oct 2015 10:37:29 +0000"  >&lt;p&gt;Thanks!&lt;br/&gt;
Committed as 27c80117d2ff62acbecc0887ca851bb541b2d830 to 2.1..trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12764731" name="10377.patch" size="1083" author="vovodroid" created="Fri, 2 Oct 2015 03:48:00 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[vovodroid]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 5 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2l5kv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12333059">2.2.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>snazy</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>