<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:59:07 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-10652] Tracing prevents startup after upgrading</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-10652</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After upgrading from 2.1 to 3.0, the &lt;tt&gt;system_traces.sessions&lt;/tt&gt; table is not properly upgraded to include the &lt;tt&gt;client&lt;/tt&gt; column added in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8162&quot; title=&quot;Log client address in query trace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8162&quot;&gt;&lt;del&gt;CASSANDRA-8162&lt;/del&gt;&lt;/a&gt;. Just upgrading from a clean 2.2 install to 3.0 won&apos;t show this error because the column was included in 2.2, it just doesn&apos;t break the queries in that release.&lt;/p&gt;

&lt;p&gt;The errors I get when querying &lt;tt&gt;system_traces.sessions&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.RuntimeException: java.lang.IllegalStateException: [ColumnDefinition{name=client, type=org.apache.cassandra.db.marshal.InetAddressType, kind=REGULAR, position=-1}, ColumnDefinition{name=command, type=org.apache.cassandra.db.marshal.UTF8Type, kind=REGULAR, position=-1}, ColumnDefinition{name=coordinator, type=org.apache.cassandra.db.marshal.InetAddressType, kind=REGULAR, position=-1}, ColumnDefinition{name=duration, type=org.apache.cassandra.db.marshal.Int32Type, kind=REGULAR, position=-1}, ColumnDefinition{name=request, type=org.apache.cassandra.db.marshal.UTF8Type, kind=REGULAR, position=-1}, ColumnDefinition{name=started_at, type=org.apache.cassandra.db.marshal.TimestampType, kind=REGULAR, position=-1}, ColumnDefinition{name=parameters, type=org.apache.cassandra.db.marshal.MapType(org.apache.cassandra.db.marshal.UTF8Type,org.apache.cassandra.db.marshal.UTF8Type), kind=REGULAR, position=-1}] is not a subset of [coordinator duration request started_at parameters]
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2350) ~[main/:na]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_45]
	at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) ~[main/:na]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [main/:na]
	at java.lang.Thread.run(Thread.java:745) [na:1.8.0_45]
Caused by: java.lang.IllegalStateException: [ColumnDefinition{name=client, type=org.apache.cassandra.db.marshal.InetAddressType, kind=REGULAR, position=-1}, ColumnDefinition{name=command, type=org.apache.cassandra.db.marshal.UTF8Type, kind=REGULAR, position=-1}, ColumnDefinition{name=coordinator, type=org.apache.cassandra.db.marshal.InetAddressType, kind=REGULAR, position=-1}, ColumnDefinition{name=duration, type=org.apache.cassandra.db.marshal.Int32Type, kind=REGULAR, position=-1}, ColumnDefinition{name=request, type=org.apache.cassandra.db.marshal.UTF8Type, kind=REGULAR, position=-1}, ColumnDefinition{name=started_at, type=org.apache.cassandra.db.marshal.TimestampType, kind=REGULAR, position=-1}, ColumnDefinition{name=parameters, type=org.apache.cassandra.db.marshal.MapType(org.apache.cassandra.db.marshal.UTF8Type,org.apache.cassandra.db.marshal.UTF8Type), kind=REGULAR, position=-1}] is not a subset of [coordinator duration request started_at parameters]
	at org.apache.cassandra.db.Columns$Serializer.encodeBitmap(Columns.java:531) ~[main/:na]
	at org.apache.cassandra.db.Columns$Serializer.serializeSubset(Columns.java:465) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:178) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:108) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredSerializer.serialize(UnfilteredSerializer.java:96) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:132) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:87) ~[main/:na]
	at org.apache.cassandra.db.rows.UnfilteredRowIteratorSerializer.serialize(UnfilteredRowIteratorSerializer.java:77) ~[main/:na]
	at org.apache.cassandra.db.partitions.UnfilteredPartitionIterators$Serializer.serialize(UnfilteredPartitionIterators.java:298) ~[main/:na]
	at org.apache.cassandra.db.ReadResponse$LocalDataResponse.build(ReadResponse.java:136) ~[main/:na]
	at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:128) ~[main/:na]
	at org.apache.cassandra.db.ReadResponse$LocalDataResponse.&amp;lt;init&amp;gt;(ReadResponse.java:123) ~[main/:na]
	at org.apache.cassandra.db.ReadResponse.createDataResponse(ReadResponse.java:65) ~[main/:na]
	at org.apache.cassandra.db.ReadCommand.createResponse(ReadCommand.java:288) ~[main/:na]
	at org.apache.cassandra.service.StorageProxy$LocalReadRunnable.runMayThrow(StorageProxy.java:1692) ~[main/:na]
	at org.apache.cassandra.service.StorageProxy$DroppableRunnable.run(StorageProxy.java:2346) ~[main/:na]
	... 4 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This means that we cannot read the sessions once a trace has occurred on 3.0. Much worse is when a trace gets into a commit log, Cassandra will stop startup because of replaying that file:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;org.apache.cassandra.db.commitlog.CommitLogReplayer$CommitLogReplayException: Unexpected error deserializing mutation; saved to /var/folders/j4/f48yz8cx0c302b21nf3fd1vh0000gn/T/mutation5130350977980177204dat.  This may be caused by replaying a mutation against a table with the same name but incompatible schema.  Exception follows: java.lang.RuntimeException: Unknown column client during deserialization
	at org.apache.cassandra.db.commitlog.CommitLogReplayer.handleReplayError(CommitLogReplayer.java:633) [main/:na]
	at org.apache.cassandra.db.commitlog.CommitLogReplayer.replayMutation(CommitLogReplayer.java:556) [main/:na]
	at org.apache.cassandra.db.commitlog.CommitLogReplayer.replaySyncSection(CommitLogReplayer.java:509) [main/:na]
	at org.apache.cassandra.db.commitlog.CommitLogReplayer.recover(CommitLogReplayer.java:404) [main/:na]
	at org.apache.cassandra.db.commitlog.CommitLogReplayer.recover(CommitLogReplayer.java:151) [main/:na]
	at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:189) [main/:na]
	at org.apache.cassandra.db.commitlog.CommitLog.recover(CommitLog.java:169) [main/:na]
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:295) [main/:na]
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:561) [main/:na]
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:689) [main/:na]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12910452">CASSANDRA-10652</key>
            <summary>Tracing prevents startup after upgrading</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="carlyeks">Carl Yeksigian</reporter>
                        <labels>
                    </labels>
                <created>Wed, 4 Nov 2015 19:32:14 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:51 +0000</updated>
                            <resolved>Fri, 6 Nov 2015 13:54:37 +0000</resolved>
                                        <fixVersion>2.2.4</fixVersion>
                    <fixVersion>3.0.0</fixVersion>
                                    <component>Legacy/Observability</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="14990503" author="mambocab" created="Wed, 4 Nov 2015 21:44:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhatch&quot; class=&quot;user-hover&quot; rel=&quot;rhatch&quot;&gt;rhatch&lt;/a&gt; Can you keep an eye out for this error as you dig through the upgrade tests? I&apos;d be surprised if there isn&apos;t an existing CassCI job that covers this.&lt;/p&gt;</comment>
                            <comment id="14991649" author="slebresne" created="Thu, 5 Nov 2015 13:22:45 +0000"  >&lt;p&gt;There seems to be a hole in how we deal with upgrade of that trace keyspace. Basically, on upgrades, even if the schema of a trace table changed in &lt;tt&gt;TraceKeyspace&lt;/tt&gt;, this won&apos;t be used because the table was pre-existing and the old schema is used. That&apos;s not a 3.0 bug per-se btw, I&apos;ve manually checked that if you create a trace in 2.1 and upgrade to 2.2, then you won&apos;t get the &lt;tt&gt;client&lt;/tt&gt; column (added by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8162&quot; title=&quot;Log client address in query trace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8162&quot;&gt;&lt;del&gt;CASSANDRA-8162&lt;/del&gt;&lt;/a&gt;) back. In practice, this means &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8162&quot; title=&quot;Log client address in query trace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8162&quot;&gt;&lt;del&gt;CASSANDRA-8162&lt;/del&gt;&lt;/a&gt; is only visible on new 2.2 clusters, but useless otherwise, which is kind of a problem.&lt;/p&gt;

&lt;p&gt;Now, it doesn&apos;t have much more consequence in 2.1 -&amp;gt; 2.2 upgrade than making that new client column inaccessible, but 3.0 is more picky: while the node will use the old metadata, the rest of the tracing code &lt;b&gt;assumes&lt;/b&gt; the client column exists and will write it, and 3.0 don&apos;t like writes to columns that don&apos;t exist.&lt;/p&gt;

&lt;p&gt;Not sure what is the best fix yet. I&apos;m not sure why we don&apos;t force the schema of those tracing tables to the most recent version. Probably going to try and see if something breaks if we do that, but if someone more familiar with the dealing of this keyspace wants to chime in with some other idea, feel free to.&lt;/p&gt;</comment>
                            <comment id="14991744" author="slebresne" created="Thu, 5 Nov 2015 14:41:35 +0000"  >&lt;p&gt;Pushed commit &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/10652&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; to always use the most up-to-date version of the table schema for our pseudo-system keyspaces (traces, auth and distributedKeys). I&apos;ve pushed a test to reproduce this (&lt;a href=&quot;https://github.com/riptano/cassandra-dtest/commit/0adc92ad93bba17defdefd1c93d632a2e6a015ee&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;directly to the dtests&lt;/a&gt; since that&apos;s a blocker for 3.0 anyway) and this does fix it.&lt;/p&gt;

&lt;p&gt;I&apos;ve start CI for the unit tests &lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/pcmanus/job/pcmanus-10652-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.  Haven&apos;t yet started dtests since it&apos;s not too informative until they have been fully updated for the new python driver. I&apos;ll start them when that&apos;s done, but this can be reviewed in the meantime.&lt;/p&gt;

&lt;p&gt;I&apos;ll note that the patch is against 3.0, but as said in my previous comment, I do think we should fix that in 2.2 (it&apos;s less of a blocker there, but still a bug). If we agree on that latter part and we&apos;re good with the patch, I&apos;ll backport it to 2.2 (should be trivial).&lt;/p&gt;</comment>
                            <comment id="14992433" author="carlyeks" created="Thu, 5 Nov 2015 20:41:18 +0000"  >&lt;p&gt;+1 &amp;#8211; the approach looks reasonable and fixes the issue. I think we should also fix 2.2, since it is broken there too, and will also cleanup the Auth keyspace initialization.&lt;/p&gt;</comment>
                            <comment id="14993694" author="slebresne" created="Fri, 6 Nov 2015 13:54:37 +0000"  >&lt;p&gt;Alright, backported to 2.2 &lt;a href=&quot;https://github.com/pcmanus/cassandra/commits/10652-2.2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and both &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-10652-2.2-testall/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utest&lt;/a&gt; and &lt;a href=&quot;http://cassci.datastax.com/job/pcmanus-10652-2.2-dtest/1/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt; looked on par with the 2.2 branch so committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 2 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2nyhj:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>carlyeks</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>