<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:49:54 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8458] Don&apos;t give out positions in an sstable beyond its first/last tokens</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8458</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Looks like we include tmplink sstables in streams in 2.1+, and when we do, sometimes we get this error message on the receiving side: &lt;tt&gt;java.io.IOException: Corrupt input data, block did not start with 2 byte signature (&apos;ZV&apos;) followed by type byte, 2-byte length)&lt;/tt&gt;. I&apos;ve only seen this happen when a tmplink sstable is included in the stream.&lt;/p&gt;

&lt;p&gt;We can not just exclude the tmplink files when starting the stream - we need to include the original file, which we might miss since we check if the requested stream range intersects the sstable range.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12761050">CASSANDRA-8458</key>
            <summary>Don&apos;t give out positions in an sstable beyond its first/last tokens</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="marcuse">Marcus Eriksson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 11 Dec 2014 12:25:35 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:26 +0000</updated>
                            <resolved>Wed, 17 Dec 2014 11:26:43 +0000</resolved>
                                        <fixVersion>2.1.3</fixVersion>
                                    <component>Legacy/Local Write-Read Paths</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14242832" author="benedict" created="Thu, 11 Dec 2014 17:41:23 +0000"  >&lt;p&gt;We could also try and figure out how/why this happens, as it should be able to stream safely.&lt;/p&gt;

&lt;p&gt;Does it only happen if streaming a range that wraps zero (i.e. from +X, to -Y)? &lt;/p&gt;

&lt;p&gt;edit: To elaborate, I suspect the broken bit is that our dfile/ifile objects don&apos;t actually truncate the readable range - only our indexed decoratedkey range is truncated. In sstable.getPositionsForRanges we just return the end of the file if the range goes past the range of the file; in this case we could stream partially written data. If so, we could fix by simply making sstable.getPositionsForRanges() lookup the start position of the last key in the file, and always ensure we leave a key&apos;s overlap between the dropped sstables and the replacement.&lt;/p&gt;</comment>
                            <comment id="14244219" author="krummas" created="Fri, 12 Dec 2014 14:53:45 +0000"  >&lt;p&gt;attached patch checks first/last keys in an sstable to make sure we don&apos;t give out positions beyond them&lt;/p&gt;</comment>
                            <comment id="14246786" author="benedict" created="Mon, 15 Dec 2014 16:14:37 +0000"  >&lt;p&gt;I&apos;m pretty sure this should throw an AssertionError given our new checks on first/last, instead of simply continuing, and it simplifies the code a little. Also, technically not related to this ticket, but doesn&apos;t it strike you as a bug to use Operation.GT, instead of Operation.GE? If so, I&apos;m not sure how we don&apos;t have tests to catch it.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            RowIndexEntry idxLeft = getPosition(leftBound, Operator.GT);
            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; left = idxLeft == &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt; ? -1 : idxLeft.position;
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (left == -1)
                &lt;span class=&quot;code-comment&quot;&gt;// left is past the end of the file
&lt;/span&gt;                &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Couldn&apos;t we also simplify correcting &quot;right&quot; to a similar approach as you&apos;ve taken for left, and use the fact that we know the positions we&apos;re looking for exist in both cases? I think the following snippet for the guts of the method should work but is (perhaps?) a little clearer:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;            &lt;span class=&quot;code-comment&quot;&gt;// range is never wrap around, unless right is the minimum token
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; !range.isWrapAround() || range.right.isMinimum();

            &lt;span class=&quot;code-comment&quot;&gt;// truncate the range so it at most covers the sstable
&lt;/span&gt;            AbstractBounds&amp;lt;RowPosition&amp;gt; bounds = range.toRowBounds();
            RowPosition leftBound = bounds.left.compareTo(first) &amp;gt; 0 ? bounds.left : first.getToken().minKeyBound();
            RowPosition rightBound = bounds.right.isMinimum() ? last.getToken().maxKeyBound() : bounds.right;

            &lt;span class=&quot;code-comment&quot;&gt;// skip non-overlapping ranges
&lt;/span&gt;            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (leftBound.compareTo(last) &amp;gt; 0 || rightBound.compareTo(first) &amp;lt; 0)
                &lt;span class=&quot;code-keyword&quot;&gt;continue&lt;/span&gt;;

            &lt;span class=&quot;code-comment&quot;&gt;// transform into positions known to exist in the file
&lt;/span&gt;            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; left = getPosition(leftBound, Operator.GE).position;
            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; right = (rightBound.compareTo(last) &amp;gt;= 0)
                         ? (openReason == OpenReason.EARLY
                            &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; opened early, we overlap with the old sstables by one key, so we know that the last
&lt;/span&gt;                            &lt;span class=&quot;code-comment&quot;&gt;// (and further) key(s) will be streamed from these &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; necessary
&lt;/span&gt;                            ? getPosition(last.getToken().maxKeyBound(), Operator.GE).position
                            : uncompressedLength())
                         : getPosition(rightBound, Operator.GT).position;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14248232" author="krummas" created="Tue, 16 Dec 2014 13:32:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;Doesn&apos;t it strike you as a bug to use Operation.GT, instead of Operation.GE?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;hmm, we use range.toRowBounds which creates a maxKeyBound for both the left and the right in the range, meaning it can never be equal. Say we have an sstable with tokens 1, 2, 3, 4, 5, and we request positions for range (2,4], here we should not include the 2, we want the position for the key after. Also, for the right bound, we want the start-position for the key that is GT than 4, so that we include the 4. Using GE will also work since we use the max key bound, but since we actually want GT, I think we should keep it that way?&lt;/p&gt;

&lt;p&gt;Your refactoring looks good, but we still need to check if left == right (if there are no keys in the requested range, we should not include the positions). Pushed here (with GT instead of GE): &lt;a href=&quot;https://github.com/krummas/cassandra/commits/marcuse/8458-2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/krummas/cassandra/commits/marcuse/8458-2&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14248491" author="benedict" created="Tue, 16 Dec 2014 17:04:04 +0000"  >&lt;p&gt;Good point! (and the left==right bit was just a cut/paste boundary)&lt;/p&gt;

&lt;p&gt;Given that, though, we should just perform getPosition(last, Operator.EQ).position, since it&apos;s known to occur in both files - and it leaves me feeling more comfortable for some reason. It should be completely fine as is, though, so +1 either way. &lt;/p&gt;</comment>
                            <comment id="14249596" author="krummas" created="Wed, 17 Dec 2014 07:52:23 +0000"  >&lt;p&gt;Committed, but, I kept getPosition(last, Operator.GT).position since I kind of liked having a one-key overlap between the early opened file and the original files&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12686854" name="0001-Make-sure-we-don-t-give-out-positions-from-an-sstabl.patch" size="6996" author="marcuse" created="Fri, 12 Dec 2014 14:53:45 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 48 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i23b8n:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>benedict</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>