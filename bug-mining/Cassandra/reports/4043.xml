<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:00:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8072] Exception during startup: Unable to gossip with any seeds</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8072</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When Opscenter 4.1.4 or 5.0.1 tries to provision a 2-node DSC 2.0.10 cluster in either ec2 or locally, an error occurs sometimes with one of the nodes refusing to start C*.  The error in the /var/log/cassandra/system.log is:&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; 2014-10-06 15:54:52,292 CassandraDaemon.java (line 513) Exception encountered during startup&lt;br/&gt;
java.lang.RuntimeException: Unable to gossip with any seeds&lt;br/&gt;
        at org.apache.cassandra.gms.Gossiper.doShadowRound(Gossiper.java:1200)&lt;br/&gt;
        at org.apache.cassandra.service.StorageService.checkForEndpointCollision(StorageService.java:444)&lt;br/&gt;
        at org.apache.cassandra.service.StorageService.prepareToJoin(StorageService.java:655)&lt;br/&gt;
        at org.apache.cassandra.service.StorageService.initServer(StorageService.java:609)&lt;br/&gt;
        at org.apache.cassandra.service.StorageService.initServer(StorageService.java:502)&lt;br/&gt;
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:378)&lt;br/&gt;
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:496)&lt;br/&gt;
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:585)&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StorageServiceShutdownHook&amp;#93;&lt;/span&gt; 2014-10-06 15:54:52,326 Gossiper.java (line 1279) Announcing shutdown&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;StorageServiceShutdownHook&amp;#93;&lt;/span&gt; 2014-10-06 15:54:54,326 MessagingService.java (line 701) Waiting for messaging service to quiesce&lt;br/&gt;
 INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;ACCEPT-localhost/127.0.0.1&amp;#93;&lt;/span&gt; 2014-10-06 15:54:54,327 MessagingService.java (line 941) MessagingService has terminated the accept() thread&lt;/p&gt;

&lt;p&gt;This errors does not always occur when provisioning a 2-node cluster, but probably around half of the time on only one of the nodes.  I haven&apos;t been able to reproduce this error with DSC 2.0.9, and there have been no code or definition file changes in Opscenter.&lt;/p&gt;

&lt;p&gt;I can reproduce locally with the above steps.&#8194; I&apos;m happy to test any proposed fixes since I&apos;m the only person able to reproduce reliably so far.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12746431">CASSANDRA-8072</key>
            <summary>Exception during startup: Unable to gossip with any seeds</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="stefania">Stefania Alborghetti</assignee>
                                    <reporter username="respringer">Ryan Springer</reporter>
                        <labels>
                    </labels>
                <created>Tue, 7 Oct 2014 16:05:58 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:32 +0000</updated>
                            <resolved>Fri, 8 Jan 2016 16:13:28 +0000</resolved>
                                        <fixVersion>2.1.13</fixVersion>
                    <fixVersion>2.2.5</fixVersion>
                    <fixVersion>3.0.3</fixVersion>
                    <fixVersion>3.3</fixVersion>
                                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>3</votes>
                                    <watches>18</watches>
                                                                                                                <comments>
                            <comment id="14162044" author="brandon.williams" created="Tue, 7 Oct 2014 16:14:09 +0000"  >&lt;p&gt;FWIW, I know this is some kind of issue because I&apos;ve both seen it in the wild and experienced it myself, but it only repros very rarely for me, so it&apos;s hard to troubleshoot.  AFAICT, everything in the code is fine so we need to get lower level on it to see what&apos;s going on.&lt;/p&gt;</comment>
                            <comment id="14176830" author="saket" created="Mon, 20 Oct 2014 11:40:31 +0000"  >&lt;p&gt;We encountered the same issue on a single node DSE Cassandra instance. This is a single node fresh install and we getting this error while starting up the service.&lt;/p&gt;</comment>
                            <comment id="14201236" author="jw.clark" created="Thu, 6 Nov 2014 23:52:20 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8274&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-8274&lt;/a&gt; appears to me to be the root cause, in my situation at least, to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7292&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;CASSANDRA-7292&lt;/a&gt;. I&apos;m still not convinced that 7292 and 8072 are duplicate issues.&lt;/p&gt;</comment>
                            <comment id="14210049" author="respringer" created="Thu, 13 Nov 2014 17:25:10 +0000"  >&lt;p&gt;This is a copy of a /var/log/cassandra/system.log file from a node that failed to provision from opscenter with a &quot;Thrift timeout error&quot;.  DSC 2.0.10 was chosen for provisioning, using a version with an assert patch from Brandon Williams.&lt;/p&gt;</comment>
                            <comment id="14211231" author="brandon.williams" created="Thu, 13 Nov 2014 20:10:46 +0000"  >&lt;p&gt;I don&apos;t know what that FNFE is about, but it&apos;s not related to this ticket.&lt;/p&gt;</comment>
                            <comment id="14284049" author="rhatch" created="Tue, 20 Jan 2015 17:14:41 +0000"  >&lt;p&gt;So far in testing I&apos;m unable to get much traction reproducing locally (using 2 containers on the same host machine). I can get the exception if I start one node about 10 seconds before the other, but I assume it&apos;s probably a normal exception in that case. Seems like perhaps this is ec2 specific or relates to some other connectivity flakiness that could be occurring between nodes on startup.&lt;/p&gt;</comment>
                            <comment id="14284056" author="brandon.williams" created="Tue, 20 Jan 2015 17:20:32 +0000"  >&lt;blockquote&gt;&lt;p&gt;probably a normal exception in that case&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Depends on which one is the seed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;It&apos;s not ec-2 specific since I know Ryan Springer was using local VMs, and I&apos;ve encountered it on rax.&lt;/p&gt;</comment>
                            <comment id="14292325" author="rhatch" created="Mon, 26 Jan 2015 20:03:51 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=respringer&quot; class=&quot;user-hover&quot; rel=&quot;respringer&quot;&gt;respringer&lt;/a&gt; Can you help me better understand what&apos;s happening with the nodes (via opscenter) when this occurs? From what we talked about before it sounds like the nodes are started with little/no configuration and then are stopped, configured, and started up again with seeds configured.&lt;/p&gt;

&lt;p&gt;First startup:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;are any changes made to cassandra.yaml before this start?&lt;/li&gt;
	&lt;li&gt;are nodes aware of each other as seeds?&lt;/li&gt;
	&lt;li&gt;does the start happen serially or in parallel?&lt;/li&gt;
	&lt;li&gt;is it possible to get sample config yaml for 2 nodes at this phase?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Stopping:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;are the nodes stopped serially or in parallel?&lt;/li&gt;
	&lt;li&gt;are the nodes able to complete startup before being stopped, or could they be getting interrupted during initial start?&lt;/li&gt;
	&lt;li&gt;are the nodes stopped forcefully (like kill -9) or something nicer?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Starting again with configurations completed:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;are nodes started serially or in parallel? (from what I know this would be parallel but just want to be sure)&lt;/li&gt;
	&lt;li&gt;will this startup step wait for all nodes to be ready before launching in parallel? (or could one node get a significant head start if it completes the earlier steps first?)&lt;/li&gt;
	&lt;li&gt;is it possible to get sample config yaml for 2 nodes at this point? (I grabbed yaml from a failed repro attempt but want to be sure I didn&apos;t get something wrong in that attempt)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Finally, when provisioning in this way how do the (ec2) nodes refer to one another: public ip, private ip, or private dns?&lt;/p&gt;

&lt;p&gt;Thanks! And sorry for all the questions. I&apos;m trying to close in on the issue and still having difficulty reproducing in a local container environment, so I&apos;m trying to figure out what could be unique about the provisioning of these nodes that may account for triggering this issue.&lt;/p&gt;</comment>
                            <comment id="14294364" author="rhatch" created="Tue, 27 Jan 2015 22:59:46 +0000"  >&lt;p&gt;I have been able to reproduce this issue using the steps provided in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8422&quot; title=&quot;cassandra won&amp;#39;t start up due to &amp;quot;Unable to gossip with any seeds&amp;quot; on the decommissioned node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8422&quot;&gt;&lt;del&gt;CASSANDRA-8422&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;During one repro attempt I tried to run &apos;nodetool gossipinfo&apos; in a loop on the non-seed node (just before the reported exception was expected to occur), and was surprised to see it complain about attempting to use a closed connection.&lt;/p&gt;

&lt;p&gt;Using netstat I had a look at the seed and the non-seed node, and can see a lingering CLOSE_WAIT connection on the seed node &amp;#8211; I&apos;m wondering if cassandra could somehow be trying to reuse this stale connection, making the seed unable to connect back to the non-seed (and making it think the seed is unavailable).&lt;/p&gt;

&lt;p&gt;It may also be relevant that the non-seed node has a connection in state FIN_WAIT2 for approx. 10-15 seconds after stopping the cassandra process.&lt;/p&gt;</comment>
                            <comment id="14295134" author="respringer" created="Wed, 28 Jan 2015 13:32:53 +0000"  >&lt;p&gt;No problem with all the questions.  The more information we have on this issue, the better.&lt;/p&gt;

&lt;p&gt;First Startup:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The DSC deb/rpm packages are installed by the agent.  Part of the scripts in the deb/rpm automatically starts DSC when the package is installed.&lt;/li&gt;
	&lt;li&gt;No changes are made to cassandra.yaml before this initial start from the packaged scripts.&lt;/li&gt;
	&lt;li&gt;Initially the nodes are not aware of each other as seeds, because the cassandra.yaml being used is the one from the package.&lt;/li&gt;
	&lt;li&gt;The initial install is made in parallel in batches of 20 nodes at a time ( configurable with the Opscenter install_throttle parameter.  )  However, I am seeing the problem with just 2 nodes in the cluster, so I don&apos;t think the throttle is involved.&lt;/li&gt;
	&lt;li&gt;I will do a run of 2 nodes and post the cassandra.yaml files.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Stopping:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The nodes are stopped in parallel&lt;/li&gt;
	&lt;li&gt;It looks as though Opscenter waits for the &quot;apt-get install&quot; or equivalent rpm command to return from the DSC package installation and then Opscenter considers the node to be initially started.  Once the package install commands have finished for all nodes, then Opscenter begins to stop all of the DSC instances.  If the package install command returns before DSC is completely initialized, that could be related to this issue.&lt;/li&gt;
	&lt;li&gt;The nodes are stopped with: pkill -f CassandraDaemon&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Starting again&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The DSC nodes are restarted serially, with the seed nodes being started before non-seed nodes.  The seeds are first sorted by string comparison and then started one at a time in that order.&lt;/li&gt;
	&lt;li&gt;Opscenter will wait for all DSC instances to have been started, then it will restart the agents, wait for them to reconnect to Opscenter, and then Opscenter considers the provisioning to be finished.&lt;/li&gt;
	&lt;li&gt;I will grab 2 cassandra.yaml configs for this stage as well.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;From my reading of the code, I believe the ec2 nodes will refer to each other using public IPs, but I will verify from a real run.&lt;/p&gt;</comment>
                            <comment id="14295364" author="rhatch" created="Wed, 28 Jan 2015 16:36:10 +0000"  >&lt;p&gt;Thanks very much.&lt;/p&gt;</comment>
                            <comment id="14295419" author="brandon.williams" created="Wed, 28 Jan 2015 17:22:36 +0000"  >&lt;p&gt;My suspicion is that we&apos;re not closing an incoming TCP connection cleanly, and thus the OS has to handle that for us.  In the time it takes for that to happen, the seed thinks it still has a connection when it doesn&apos;t, and is using that to attempt gossip, which of course fails.  I&apos;m not entirely sure where this is occurring yet, however.&lt;/p&gt;</comment>
                            <comment id="14295525" author="respringer" created="Wed, 28 Jan 2015 18:08:46 +0000"  >&lt;p&gt;Actually, I was wrong about Opscenter waiting until all of the nodes had installed the DSC package before stopping the nodes.  As soon as the package install has finished for a node, Opscenter will proceed and stop the running DSC instance for that node without waiting for other nodes to finish their installs.  Opscenter will also reconfigure nodes without waiting for all nodes to be stopped.&lt;/p&gt;

&lt;p&gt;It looks like the node install -&amp;gt; stop -&amp;gt; configure process runs independently for each node.  So we could theoretically have one node in a reconfigured but stopped state while another node is still installing the packages.  Opscenter will, however, wait until all nodes have been reconfigured before beginning to restarting DSC on the nodes.&lt;/p&gt;</comment>
                            <comment id="14295618" author="respringer" created="Wed, 28 Jan 2015 18:56:56 +0000"  >&lt;p&gt;Also, Opscenter is using the ec2 private IPs, not the public ones.&lt;/p&gt;</comment>
                            <comment id="14296070" author="rhatch" created="Wed, 28 Jan 2015 23:44:33 +0000"  >&lt;p&gt;A few more notes here. I noticed testing today that running decommission on the non-seed node actually seems to properly close one connection (it waits for a few seconds after decommission is complete and disappears from the netstat output on the seed), but that another connection springs up in it&apos;s place. It&apos;s this connection established &lt;b&gt;after&lt;/b&gt; decommission which seems to be lingering when the peer disappers, going into CLOSE_WAIT when the process is stopped. I did some testing with tcpkill to forcefully close this connection (which is a little tricky because it needs traffic flowing to work), and was able to confirm that when this connection is no longer open, a node can start without triggering the &apos;unable to gossip&apos; exception.&lt;/p&gt;
</comment>
                            <comment id="14296075" author="rhatch" created="Wed, 28 Jan 2015 23:47:51 +0000"  >&lt;p&gt;One correction here, the FIN_WAIT2 seems like it&apos;s actually lasting about one minute, so I think it&apos;s being removed when tcp_fin_timeout expires.&lt;/p&gt;</comment>
                            <comment id="14490383" author="albertsj1" created="Fri, 10 Apr 2015 21:19:29 +0000"  >&lt;p&gt;Logs from cassandra cluster with logging set to TRACE.  This is from a new node launched and cassandra failed to start.&lt;br/&gt;
This is for a cluster running on EC2 using the ec2multiregion snitch.&lt;br/&gt;
I was able to reproduce this issue on a new cluster, decommissioned a node, shut it down, brought up a new node with the same EIP and this failed.&lt;/p&gt;</comment>
                            <comment id="14490401" author="brandon.williams" created="Fri, 10 Apr 2015 21:32:21 +0000"  >&lt;p&gt;Thanks for the logs! So, the relevant portion of these logs is here:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG 20:53:50,981 Starting shadow gossip round to check for endpoint collision
 INFO 20:53:51,304 Starting Encrypted Messaging Service on SSL port 7001
 INFO 20:53:51,312 Starting Messaging Service on port 7000
 INFO 20:53:51,315 Loading settings from file:/etc/cassandra/conf/cassandra.yaml
TRACE 20:53:51,336 /54.219.189.161 sending GOSSIP_DIGEST_SYN to 1@/54.219.189.162
TRACE 20:53:51,353 /54.219.189.161 sending GOSSIP_DIGEST_SYN to 2@/54.219.189.163
DEBUG 20:53:51,354 attempting to connect to /54.219.189.162
TRACE 20:53:51,354 Assuming current protocol version for /54.219.189.162
TRACE 20:53:51,355 Filtering org.apache.cassandra.db.ColumnFamilyStore$9@496cc7de for rows matching org.apache.cassandra.db.filter.ExtendedFilter$EmptyClauseFilter@4b5e57b
DEBUG 20:53:51,359 attempting to connect to /54.219.189.163
TRACE 20:53:51,360 Assuming current protocol version for /54.219.189.163
 INFO 20:53:51,543 Handshaking version with cas-dev-dt-01-uw1-cassandra-seed02.localdomain-ext/54.219.189.163
 INFO 20:53:51,544 Handshaking version with cas-dev-dt-01-uw1-cassandra-seed01.localdomain-ext/54.219.189.162
DEBUG 20:53:51,583 Setting version 7 for cas-dev-dt-01-uw1-cassandra-seed02.localdomain-ext/54.219.189.163
DEBUG 20:53:51,586 Setting version 7 for cas-dev-dt-01-uw1-cassandra-seed01.localdomain-ext/54.219.189.162
TRACE 20:53:51,586 Upgrading OutputStream to be compressed
TRACE 20:53:51,588 Upgrading OutputStream to be compressed
TRACE 20:53:55,247 Expired 0 entries
DEBUG 20:53:55,598 GC for ConcurrentMarkSweep: 71 ms for 1 collections, 240266176 used; max is 7935623168
TRACE 20:54:00,248 Expired 0 entries
TRACE 20:54:05,248 Expired 0 entries
TRACE 20:54:10,249 Expired 0 entries
TRACE 20:54:15,249 Expired 0 entries
TRACE 20:54:20,250 Expired 0 entries
ERROR 20:54:22,360 Exception encountered during startup
java.lang.RuntimeException: Unable to gossip with any seeds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can see that this node sent the SYN, which caused MS to connect to those nodes, and it successfully negotiated the version, so we know that everything worked as expected until this point.  What we don&apos;t know is why neither seed replied to the SYN, or if they even attempted to, or just never received the SYN for some reason.  Without TRACE from one of the seeds, we won&apos;t be able to tell.&lt;/p&gt;</comment>
                            <comment id="14490462" author="albertsj1" created="Fri, 10 Apr 2015 22:20:41 +0000"  >&lt;p&gt;Wow, that was a quick response. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;  Thanks for looking into this.&lt;br/&gt;
I cleaned out the log files, enabled trace on both seed nodes and the new node that is failing and started cassandra on the failing node.  Trace logs from each node are attached.&lt;/p&gt;</comment>
                            <comment id="14490551" author="brandon.williams" created="Fri, 10 Apr 2015 23:40:27 +0000"  >&lt;p&gt;Now we&apos;re getting somewhere.  It starts here, after the seed receives the dead state for the decommissioned node:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [GossipStage:1] 2015-04-10 22:05:10,147 ReconnectableSnitchHelper.java (line 70) Intiated reconnect to an Internal IP /10.2.1.139 for the /54.219.189.161
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Later, the seed receives the SYN and tries to send the ACK, but it tries to send over the previous internal IP:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [ACCEPT-/10.2.0.71] 2015-04-10 22:06:45,576 MessagingService.java (line 917) Connection version 7 from /54.219.189.161
DEBUG [Thread-11] 2015-04-10 22:06:45,621 MessagingService.java (line 780) Setting version 7 for /54.219.189.161
DEBUG [Thread-11] 2015-04-10 22:06:45,621 IncomingTcpConnection.java (line 107) Set version for /54.219.189.161 to 7 (will use 7)
TRACE [GossipStage:1] 2015-04-10 22:06:45,658 GossipDigestSynVerbHandler.java (line 40) Received a GossipDigestSynMessage from /54.219.189.161
TRACE [GossipStage:1] 2015-04-10 22:06:45,660 Gossiper.java (line 768) local heartbeat version 179776 greater than 0 for /54.219.189.161
TRACE [GossipStage:1] 2015-04-10 22:06:45,666 GossipDigestSynVerbHandler.java (line 84) Sending a GossipDigestAckMessage to /54.219.189.161
TRACE [GossipStage:1] 2015-04-10 22:06:45,666 MessagingService.java (line 660) /54.219.189.162 sending GOSSIP_DIGEST_ACK to 399@/54.219.189.161
DEBUG [WRITE-/54.219.189.161] 2015-04-10 22:06:45,666 OutboundTcpConnection.java (line 290) attempting to connect to /10.2.1.139
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It seems like the &apos;new&apos; 161 isn&apos;t binding this IP, which is fine depending on your circumstance, but at least one problem we have is we shouldn&apos;t be sending the onJoin event for a dead state which triggers the initial reconnect.  I can&apos;t think of any reason we&apos;d want to send that event upon discovery of any dead state, so patch to only send it for live states.&lt;/p&gt;

&lt;p&gt;That said, I don&apos;t think this is the original cause, because when I&apos;ve seen it I wasn&apos;t using INTERNAL_IP nor a reconnecting snitch.&lt;/p&gt;</comment>
                            <comment id="14490559" author="brandon.williams" created="Fri, 10 Apr 2015 23:50:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;I can&apos;t think of any reason we&apos;d want to send that event upon discovery of any dead state, so patch to only send it for live states.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Actually, I can.  In the case of a removal/decom during a partition, this is the only way the other side will remove it when the partition heals.  Patch to instead filter dead states in ReconnectableSnitchHelper.&lt;/p&gt;</comment>
                            <comment id="14491140" author="jw.clark" created="Sat, 11 Apr 2015 18:12:33 +0000"  >&lt;p&gt;I agree. John Albert&apos;s logs seem more consistent with bug 7292(which I still maintain should not be marked as a duplicate) - &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7292&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-7292&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Glad to see progress on this issue though. Thanks all.&lt;/p&gt;</comment>
                            <comment id="14497063" author="brandon.williams" created="Wed, 15 Apr 2015 21:42:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=albertsj1&quot; class=&quot;user-hover&quot; rel=&quot;albertsj1&quot;&gt;albertsj1&lt;/a&gt; can you see if that patch fixes your scenario?&lt;/p&gt;</comment>
                            <comment id="14497070" author="albertsj1" created="Wed, 15 Apr 2015 21:49:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; Absolutely.  I probably won&apos;t get a chance to test this until tomorrow.&lt;br/&gt;
Thanks for the patch.&lt;/p&gt;</comment>
                            <comment id="14497140" author="jsvede" created="Wed, 15 Apr 2015 22:26:57 +0000"  >&lt;p&gt;FWIW, I am on OS X, v10.9.5 and was using JDK 8 and got a similar error though with subtly different stacktrace:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.RuntimeException: Unable to gossip with any seeds
	at org.apache.cassandra.gms.Gossiper.doShadowRound(Gossiper.java:1222) ~[apache-cassandra-2.1.2.jar:2.1.2]
	at org.apache.cassandra.service.StorageService.checkForEndpointCollision(StorageService.java:463) ~[apache-cassandra-2.1.2.jar:2.1.2]
	at org.apache.cassandra.service.StorageService.prepareToJoin(StorageService.java:706) ~[apache-cassandra-2.1.2.jar:2.1.2]
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:643) ~[apache-cassandra-2.1.2.jar:2.1.2]
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:535) ~[apache-cassandra-2.1.2.jar:2.1.2]
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:324) [apache-cassandra-2.1.2.jar:2.1.2]
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:448) [apache-cassandra-2.1.2.jar:2.1.2]
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:537) [apache-cassandra-2.1.2.jar:2.1.2]
java.lang.RuntimeException: Unable to gossip with any seeds
	at org.apache.cassandra.gms.Gossiper.doShadowRound(Gossiper.java:1222)
	at org.apache.cassandra.service.StorageService.checkForEndpointCollision(StorageService.java:463)
	at org.apache.cassandra.service.StorageService.prepareToJoin(StorageService.java:706)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:643)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:535)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:324)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:448)
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:537)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This was cassandra 2.1.2 installed via brew. I uninstalled it, installed from the CLI using this:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://exponential.io/blog/2015/01/28/install-cassandra-2_1-on-mac-os-x/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://exponential.io/blog/2015/01/28/install-cassandra-2_1-on-mac-os-x/&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;And still had the issue. Then I changed my JAVA_HOME to point back to Java7:&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.7.0_51.jdk/Contents/Home&lt;/tt&gt;&lt;/p&gt;

&lt;p&gt;And now it starts fine.&lt;/p&gt;

&lt;p&gt;HTH.&lt;/p&gt;</comment>
                            <comment id="14497151" author="brandon.williams" created="Wed, 15 Apr 2015 22:33:44 +0000"  >&lt;p&gt;I&apos;m going to guess that was just random luck since I highly doubt this is JVM-specific.&lt;/p&gt;</comment>
                            <comment id="14499850" author="brandon.williams" created="Fri, 17 Apr 2015 13:48:22 +0000"  >&lt;p&gt;Moving the patch for ec2/reconnectable snitches to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7292&quot; title=&quot;Can&amp;#39;t seed new node into ring with (public) ip of an old node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7292&quot;&gt;&lt;del&gt;CASSANDRA-7292&lt;/del&gt;&lt;/a&gt; since it fits better there.&lt;/p&gt;</comment>
                            <comment id="14500545" author="brandon.williams" created="Fri, 17 Apr 2015 19:49:07 +0000"  >&lt;p&gt;After deep packet inspection, I believe I&apos;ve found the root non-reconnectable snitch part of this issue.  When you decom a node, it never correctly tears down its ITC pools, which leaves the other side with a dead OTC pool:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;tcp        1      0 10.208.8.123:33441      10.208.8.63:7000        CLOSE_WAIT  18401/java      
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Now when you try to bootstrap with the same IP, the shadow syn is correctly sent and the ack reply is built and queued, but MS tries to use the now defunct OTC pool and the message never makes it back to the node, since it just sends TCP RSTs which finally kills the connection.  But since the gossip syn is only sent once, the seed has nothing else to send the node and never reestablishes the connection, leaving the bootstrapping node thinking it never talked to a seed and throwing this error.&lt;/p&gt;</comment>
                            <comment id="14500554" author="brandon.williams" created="Fri, 17 Apr 2015 19:55:26 +0000"  >&lt;p&gt;The reason this only manifests with shadow gossip is because shadow is the only time we send precisely one round, under normal gossip conditions we fire once per second, but probably lose the first message as well.&lt;/p&gt;</comment>
                            <comment id="14580341" author="andie78" created="Wed, 10 Jun 2015 10:09:48 +0000"  >&lt;p&gt;Hello, I made following steps: I decom a 2.0.15 node with 128 vnodes and tried to bootstrap 2.1.6-R on the same node w/ 256 vnodes in write survey mode to test. 2.1.6 doesn&apos;t bootstrap because of the unable gossib exception but the old 2.0.15 does it w/o problems. Even if i use cassandra.yaml from 2.0.15 (deleted properties invalid for 2.1.6) it doesn&apos;t start. I have 14 nodes 2.0.15 running on Windows 7.&lt;/p&gt;
&lt;div class=&quot;panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;system.log&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;panelContent&quot;&gt;
&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;main&amp;#93;&lt;/span&gt; 2015-06-10 12:03:22,200 CassandraDaemon.java:553 - Exception encountered during startup&lt;br/&gt;
java.lang.RuntimeException: Unable to gossip with any seeds&lt;br/&gt;
	at org.apache.cassandra.gms.Gossiper.doShadowRound(Gossiper.java:1307) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.6.jar:2.1.6&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.checkForEndpointCollision(StorageService.java:530) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.6.jar:2.1.6&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.prepareToJoin(StorageService.java:774) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.6.jar:2.1.6&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:711) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.6.jar:2.1.6&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:602) ~&lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.6.jar:2.1.6&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:394) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.6.jar:2.1.6&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:536) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.6.jar:2.1.6&amp;#93;&lt;/span&gt;&lt;br/&gt;
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:625) &lt;span class=&quot;error&quot;&gt;&amp;#91;apache-cassandra-2.1.6.jar:2.1.6&amp;#93;&lt;/span&gt;&lt;br/&gt;
WARN  &lt;span class=&quot;error&quot;&gt;&amp;#91;StorageServiceShutdownHook&amp;#93;&lt;/span&gt; 2015-06-10 12:03:22,200 Gossiper.java:1418 - No local state or state is in silent shutdown, not announcing shutdown&lt;br/&gt;
INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;StorageServiceShutdownHook&amp;#93;&lt;/span&gt; 2015-06-10 12:03:22,200 MessagingService.java:708 - Waiting for messaging service to quiesce&lt;br/&gt;
INFO  &lt;span class=&quot;error&quot;&gt;&amp;#91;ACCEPT-PC5771/10.2.0.61&amp;#93;&lt;/span&gt; 2015-06-10 12:03:22,200 MessagingService.java:958 - MessagingService has terminated the accept() thread&lt;/p&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14580409" author="andie78" created="Wed, 10 Jun 2015 11:14:49 +0000"  >&lt;p&gt;I tried severel times to switch between 2.0.15 and 2.1.6 (start bootstr at 2.0.15, stop, copy data to 2.1.6) but 2.1.6 doesn&apos;t start probably. One time, 2.1.6 had seen only other nodes, not himself. Now I deleted all data again on that node, removed the node with nodetool and now the bootstrap w/ 2.0.15 works well in write survey mode. I&apos;ll wait until bootstrap finished and then I try to upgrade the same node to 2.1.6 w/ write survey as well. Seems like 2.1.6 is not backward compatible bootstrapping to a 2.0.x cluster. Can u confirm that behavior?&lt;/p&gt;</comment>
                            <comment id="14742914" author="slowenthal" created="Mon, 14 Sep 2015 04:47:06 +0000"  >&lt;p&gt;I can easily reproduce this with my automated launcher  I even tried to better randomize when non-seed nodes come in to join.   I recently noticed that the seed node has a socket stuck in CLOSE_WAIT for the nodes that report can&apos;t gossip with any seeds.  Perhaps the solution lies in ensuring that both ends of the connection properly close the connection.  It&apos;s likely the client (the node asking to join) exceptions out and dies without elegantly closing the connection.   See Screenshot.  Also well-known port afs3-fileserver is 7000.&lt;/p&gt;</comment>
                            <comment id="14744717" author="stefania" created="Tue, 15 Sep 2015 02:36:28 +0000"  >&lt;p&gt;Without having looked in much detail at this yet, it seems very similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10205&quot; title=&quot;decommissioned_wiped_node_can_join_test fails on Jenkins&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10205&quot;&gt;&lt;del&gt;CASSANDRA-10205&lt;/del&gt;&lt;/a&gt;. It&apos;s worth trying out that patch to see if it solves this as well.&lt;/p&gt;

&lt;p&gt;Summary of 10205: after a node is decommissioned, its data wiped, and the node restarted, it never receives GOSSIP replies from seeds during the shadow round and fails to start. This is because the node is not marked as dead and the socket is not closed properly. Marking the node as dead even when the status is LEFT, closes the socket and the test of 10205 passes. The patch is for 3.0 but the same problem occurs on 2.0+.&lt;/p&gt;</comment>
                            <comment id="14982857" author="iamaleksey" created="Fri, 30 Oct 2015 16:50:14 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slowery23&quot; class=&quot;user-hover&quot; rel=&quot;slowery23&quot;&gt;slowery23&lt;/a&gt; Can you reproduce it in 2.1.latest?&lt;/p&gt;</comment>
                            <comment id="14985302" author="kenfailbus" created="Mon, 2 Nov 2015 14:41:53 +0000"  >&lt;p&gt;I am seeing this issue in 2.0.14. And it&apos;s reproducible. We are adding a node in a large vnode based cluster. All the other time we have successfully added the node in the past and this time around we are seeing this issue.&lt;/p&gt;

&lt;p&gt;Is there a work around for this situation? Any ideas?&lt;/p&gt;
</comment>
                            <comment id="14985589" author="kenfailbus" created="Mon, 2 Nov 2015 17:38:02 +0000"  >&lt;p&gt;Upon enabling trace on the one seed node and re-bootstrapping the new node, I got the following exception on the node that was bootstrapping.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2015-11-02 17:34:52,150 [ACCEPT-/10.22.168.53] DEBUG MessagingService Error reading the socket Socket[addr=/10.xx.xx.xx,port=46678,localport=10xxx]
java.net.SocketTimeoutException
        at sun.nio.ch.SocketAdaptor$SocketInputStream.read(SocketAdaptor.java:229)
        at sun.nio.ch.ChannelInputStream.read(ChannelInputStream.java:103)
        at java.io.InputStream.read(InputStream.java:101)
        at sun.nio.ch.ChannelInputStream.read(ChannelInputStream.java:81)
        at java.io.DataInputStream.readInt(DataInputStream.java:387)
        at org.apache.cassandra.net.MessagingService$SocketThread.run(MessagingService.java:916)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And then usual exception that this ticket is mentioning about&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;2015-11-02 17:34:55,526 [EXPIRING-MAP-REAPER:1] TRACE ExpiringMap Expired 0 entries
2015-11-02 17:35:00,526 [EXPIRING-MAP-REAPER:1] TRACE ExpiringMap Expired 0 entries
2015-11-02 17:35:05,527 [EXPIRING-MAP-REAPER:1] TRACE ExpiringMap Expired 0 entries
2015-11-02 17:35:10,527 [EXPIRING-MAP-REAPER:1] TRACE ExpiringMap Expired 0 entries
2015-11-02 17:35:11,982 [main] ERROR CassandraDaemon Exception encountered during startup
java.lang.RuntimeException: Unable to gossip with any seeds
        at org.apache.cassandra.gms.Gossiper.doShadowRound(Gossiper.java:1296)
        at org.apache.cassandra.service.StorageService.checkForEndpointCollision(StorageService.java:457)
        at org.apache.cassandra.service.StorageService.prepareToJoin(StorageService.java:671)
        at org.apache.cassandra.service.StorageService.initServer(StorageService.java:623)
        at org.apache.cassandra.service.StorageService.initServer(StorageService.java:515)
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:437)
        at com.datastax.bdp.server.DseDaemon.setup(DseDaemon.java:423)
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:567)
        at com.datastax.bdp.server.DseDaemon.main(DseDaemon.java:641)
2015-11-02 17:35:11,986 [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-7] INFO DseDaemon DSE shutting down...
2015-11-02 17:35:11,987 [StorageServiceShutdownHook] WARN Gossiper No local state or state is in silent shutdown, not announcing shutdown
2015-11-02 17:35:11,987 [StorageServiceShutdownHook] INFO MessagingService Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; messaging service to quiesce
2015-11-02 17:35:11,987 [StorageServiceShutdownHook] DEBUG MessagingService Closing accept() thread
2015-11-02 17:35:11,988 [ACCEPT-/10.22.168.53] DEBUG MessagingService Asynchronous close seen by server thread
2015-11-02 17:35:11,988 [ACCEPT-/10.22.168.53] INFO MessagingService MessagingService has terminated the accept() thread
2015-11-02 17:35:12,068 [&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-7] ERROR CassandraDaemon Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-7,5,main]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15064093" author="stefania" created="Fri, 18 Dec 2015 15:32:16 +0000"  >&lt;p&gt;I&apos;ve reproduced it on 2.1 HEAD with this dtest, which follows the steps of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8422&quot; title=&quot;cassandra won&amp;#39;t start up due to &amp;quot;Unable to gossip with any seeds&amp;quot; on the decommissioned node&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8422&quot;&gt;&lt;del&gt;CASSANDRA-8422&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;def decommissioned_wiped_node_can_gossip_to_single_seed_test(self):
        &quot;&quot;&quot;
        @jira_ticket CASSANDRA-8072
        @jira_ticket CASSANDRA-8422
        Test that &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; we decommission a node, kill it and wipe its data, it can join a cluster with a single
        seed node.
        &quot;&quot;&quot;
        cluster = self.cluster
        cluster.populate(1)
        cluster.start(wait_for_binary_proto=True)

        # Add a &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; node, bootstrap=True ensures that it is not a seed
        node2 = new_node(cluster, bootstrap=True)
        node2.start(wait_for_binary_proto=True, wait_other_notice=True)

        # Decommision the &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; node and kill it
        node2.decommission()
        node2.stop(gently=False)

        # Wipe its data
        data_dir = os.path.join(node2.get_path(), &lt;span class=&quot;code-quote&quot;&gt;&apos;data&apos;&lt;/span&gt;)
        commitlog_dir = os.path.join(node2.get_path(), &lt;span class=&quot;code-quote&quot;&gt;&apos;commitlogs&apos;&lt;/span&gt;)
        debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Deleting {}&quot;&lt;/span&gt;.format(data_dir))
        shutil.rmtree(data_dir)
        shutil.rmtree(commitlog_dir)

        # Now start it, it should be allowed to join
        mark = node2.mark_log()
        node2.start(wait_other_notice=False)
        node2.watch_log_for(&lt;span class=&quot;code-quote&quot;&gt;&quot;JOINING:&quot;&lt;/span&gt;, from_mark=mark)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;This results in the following exception in node2:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [main] 2015-12-18 16:21:07,357 CassandraDaemon.java:581 - Exception encountered during startup
java.lang.RuntimeException: Unable to gossip with any seeds
        at org.apache.cassandra.gms.Gossiper.doShadowRound(Gossiper.java:1337) ~[main/:na]
        at org.apache.cassandra.service.StorageService.checkForEndpointCollision(StorageService.java:541) ~[main/:na]
        at org.apache.cassandra.service.StorageService.prepareToJoin(StorageService.java:789) ~[main/:na]
        at org.apache.cassandra.service.StorageService.initServer(StorageService.java:721) ~[main/:na]
        at org.apache.cassandra.service.StorageService.initServer(StorageService.java:612) ~[main/:na]
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:389) [main/:na]
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:564) [main/:na]
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:653) [main/:na]
WARN  [StorageServiceShutdownHook] 2015-12-18 16:21:07,360 Gossiper.java:1454 - No local state or state is in silent shutdown, not announcing shutdown
INFO  [StorageServiceShutdownHook] 2015-12-18 16:21:07,361 MessagingService.java:734 - Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; messaging service to quiesce
INFO  [ACCEPT-/127.0.0.2] 2015-12-18 16:21:07,361 MessagingService.java:1018 - MessagingService has terminated the accept() thread
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15066524" author="stefania" created="Mon, 21 Dec 2015 15:02:33 +0000"  >&lt;p&gt;Building on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; previous analysis but taking into account more recent changes where we do close sockets, the problem is still that the seed node is sending the ACK to the old socket, even after it has been closed by the decommissioned node. This is because we only send on these sockets, so we cannot know when they are closed until the send buffers are exceeded or unless we try to read from them as well. However, the problem should now only be true until the node is convicted, approx 10 seconds with a &lt;tt&gt;phi_convict_threshold&lt;/tt&gt; of 8. I verified this by adding a sleep of 15 seconds in my test before restarting the node, and it restarted without problems. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slowenthal&quot; class=&quot;user-hover&quot; rel=&quot;slowenthal&quot;&gt;slowenthal&lt;/a&gt; or &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhatch&quot; class=&quot;user-hover&quot; rel=&quot;rhatch&quot;&gt;rhatch&lt;/a&gt; would you be able to confirm this with your tests?&lt;/p&gt;

&lt;p&gt;If we cannot detect when an outgoing socket is closed by its peer, then we need an out-of-bound notification. This could come from the departing node announcing its shutdown at the end of its decommission but the existing logic in &lt;tt&gt;Gossiper.stop()&lt;/tt&gt; prevents this for the dead states (&lt;b&gt;removing, removed, left and hibernate&lt;/b&gt;) or for &lt;b&gt;bootstrapping&lt;/b&gt;. This was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8336&quot; title=&quot;Add shutdown gossip state to prevent timeouts during rolling restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8336&quot;&gt;&lt;del&gt;CASSANDRA-8336&lt;/del&gt;&lt;/a&gt; and the same problem has already been raised in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9630&quot; title=&quot;Killing cassandra process results in unclosed connections&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9630&quot;&gt;&lt;del&gt;CASSANDRA-9630&lt;/del&gt;&lt;/a&gt;. Even if we undo &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8336&quot; title=&quot;Add shutdown gossip state to prevent timeouts during rolling restarts&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8336&quot;&gt;&lt;del&gt;CASSANDRA-8336&lt;/del&gt;&lt;/a&gt; there is then another issue: since &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9765&quot; title=&quot;checkForEndpointCollision fails for legitimate collisions&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9765&quot;&gt;&lt;del&gt;CASSANDRA-9765&lt;/del&gt;&lt;/a&gt; we can no longer join a cluster in status SHUTDOWN and I believe this is correct. So the answer cannot be to announce a shutdown after decommission, not without significant changes to the Gossip protocol. Closing the socket earlier, say when we get the status LEFT notification, is not sufficient because during the RING_DELAY sleep period we may re-establish the connection to the node before it dies, typically for a Gossip update. &lt;/p&gt;

&lt;p&gt;So I think we only have two options:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;read from outgoing sockets purely to detect when they are closed&lt;/li&gt;
	&lt;li&gt;send a new GOSSIP flag indicating it is time to close the sockets to a node&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="15066554" author="stefania" created="Mon, 21 Dec 2015 15:17:48 +0000"  >&lt;p&gt;Forgot to mention also another obvious way to go around this, that is to extend the shadow round and to retry multiple times.&lt;/p&gt;</comment>
                            <comment id="15066601" author="stefania" created="Mon, 21 Dec 2015 15:52:33 +0000"  >&lt;p&gt;In fact we don&apos;t need to extend the shadow round since RING_DELAY is already a pretty long time (30 seconds by default), we just need to retry perhaps every 5 seconds?&lt;/p&gt;

&lt;p&gt;Here is a patch that does that and that fixes my test:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/stef1927/cassandra/commits/8072-2.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-8072-2.1-testall/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/stef1927/job/stef1927-8072-2.1-dtest/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15085168" author="stefania" created="Wed, 6 Jan 2016 07:55:51 +0000"  >&lt;p&gt;Ping:  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slowenthal&quot; class=&quot;user-hover&quot; rel=&quot;slowenthal&quot;&gt;slowenthal&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhatch&quot; class=&quot;user-hover&quot; rel=&quot;rhatch&quot;&gt;rhatch&lt;/a&gt; - I cannot reproduce this if I wait for the restarting node to be convicted, typically a sleep of around 15 seconds. Are you able to reproduce this in any way beyond this period?&lt;/p&gt;</comment>
                            <comment id="15087755" author="rhatch" created="Thu, 7 Jan 2016 17:49:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; It&apos;s been a long while since I tested, but I vaguely remember that a long enough sleep would prevent the issue from happening when I was working to repro it consistently.&lt;/p&gt;</comment>
                            <comment id="15089429" author="beobal" created="Fri, 8 Jan 2016 16:13:28 +0000"  >&lt;p&gt;Patch lgtm, thanks. I&apos;ve committed to 2.1 in &lt;tt&gt;0f27d68fc23a942c0fa27ba4662621891939eaed&lt;/tt&gt; and merged forwards. I didn&apos;t go as far as creating CI branches for all the targets, but I did verify that the new dtest passes on them all. That dtest needed a slight tweak following &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6696&quot; title=&quot;Partition sstables by token range&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6696&quot;&gt;&lt;del&gt;CASSANDRA-6696&lt;/del&gt;&lt;/a&gt; and I&apos;ve opened a PR for it &lt;a href=&quot;https://github.com/riptano/cassandra-dtest/pull/737&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="15091593" author="stefania" created="Mon, 11 Jan 2016 08:20:39 +0000"  >&lt;p&gt;Thank you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=beobal&quot; class=&quot;user-hover&quot; rel=&quot;beobal&quot;&gt;beobal&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=rhatch&quot; class=&quot;user-hover&quot; rel=&quot;rhatch&quot;&gt;rhatch&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12716282">CASSANDRA-7292</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12848517">CASSANDRA-9878</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12759397">CASSANDRA-8422</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                            <issuelinktype id="10001">
                    <name>dependent</name>
                                                                <inwardlinks description="is depended upon by">
                                        <issuelink>
            <issuekey id="12750105">CASSANDRA-8175</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12724684" name="cas-dev-dt-01-uw1-cassandra-seed01_logs.tar.bz2" size="493034" author="albertsj1" created="Fri, 10 Apr 2015 22:20:40 +0000"/>
                            <attachment id="12724685" name="cas-dev-dt-01-uw1-cassandra-seed02_logs.tar.bz2" size="520280" author="albertsj1" created="Fri, 10 Apr 2015 22:20:40 +0000"/>
                            <attachment id="12724686" name="cas-dev-dt-01-uw1-cassandra02_logs.tar.bz2" size="96083" author="albertsj1" created="Fri, 10 Apr 2015 22:20:41 +0000"/>
                            <attachment id="12681366" name="casandra-system-log-with-assert-patch.log" size="11767" author="respringer" created="Thu, 13 Nov 2014 17:25:10 +0000"/>
                            <attachment id="12755657" name="screenshot-1.png" size="221668" author="slowenthal" created="Mon, 14 Sep 2015 04:48:42 +0000"/>
                            <attachment id="12724666" name="trace_logs.tar.bz2" size="78020" author="albertsj1" created="Fri, 10 Apr 2015 21:19:29 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>6.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 45 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i20vyn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327164">2.0.10</customfieldvalue>
    <customfieldvalue id="12327942">2.0.11</customfieldvalue>
    <customfieldvalue id="12328951">2.1.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>samt</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>rhatch</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>