<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:27:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3510] Incorrect query results due to invalid SSTable.maxTimestamp</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3510</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3446&quot; title=&quot;Problem SliceByNamesReadCommand on super column family after flush operation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3446&quot;&gt;&lt;del&gt;CASSANDRA-3446&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;(sorry this is so long, took me a bit to work through it all and there is a lot of new code &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt; )&lt;/p&gt;

&lt;h1&gt;&lt;a name=&quot;Summary&quot;&gt;&lt;/a&gt;Summary&lt;/h1&gt;

&lt;p&gt;SSTable.maxTimestamp for files created before 1.0 defaults to Long.MIN_VALUE, and this means the wrong data is returned from queries. &lt;/p&gt;

&lt;h2&gt;&lt;a name=&quot;Details&quot;&gt;&lt;/a&gt;Details &lt;/h2&gt;

&lt;p&gt;Noticed on a cluster that was upgraded from 0.8.X to 1.X, it then had trouble similar to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3446&quot; title=&quot;Problem SliceByNamesReadCommand on super column family after flush operation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3446&quot;&gt;&lt;del&gt;CASSANDRA-3446&lt;/del&gt;&lt;/a&gt;. It was rolled back to 0.8 and the migrated to 1.0.3. &lt;/p&gt;

&lt;p&gt;4 Node cluster, all files upgraded to &quot;hb&quot; format. &lt;/p&gt;

&lt;p&gt;In a super CF there are situations where a get for a sub columns returns a different value than a get for the column. .e.g. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[default@XXX] get Users[ascii(&apos;username&apos;)][&apos;meta&apos;][&apos;password&apos;];
=&amp;gt; (column=password, value=3130323130343130, timestamp=1307352647576000)

[default@XX] get Users[ascii(&apos;username&apos;)][&apos;meta&apos;];     
(snip)       
=&amp;gt; (column=password, value=3034323131303034, timestamp=1319563673493000)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The correct value is the second one. &lt;/p&gt;

&lt;p&gt;I added logging after line 109 in o.a.c.db.CollectionController.collectTimeOrderedData() to log the sstable name and the file max timestamp, this is what I got:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (SSTableReader sstable : view.sstables)
{
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; currentMaxTs = sstable.getMaxTimestamp();
    logger.debug(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Got sstable %s and max TS %d&quot;&lt;/span&gt;, sstable, currentMaxTs));
    reduceNameFilter(reducedFilter, container, currentMaxTs);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG 14:08:46,012 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12348-Data.db&apos;) and max TS 1321824847534000
DEBUG 14:08:47,231 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12346-Data.db&apos;) and max TS 1321813380793000
DEBUG 14:08:49,879 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12330-Data.db&apos;) and max TS -9223372036854775808
DEBUG 14:08:49,880 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12325-Data.db&apos;) and max TS -9223372036854775808
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The key I was reading is present in files 12330 and 12325, the first contains the &lt;b&gt;old / wrong&lt;/b&gt; value with timestamp 1307352647576000 above. The second contains the &lt;b&gt;new / correct&lt;/b&gt; value with timestamp 1319563673493000.&lt;/p&gt;

&lt;p&gt;*&lt;b&gt;Updated:&lt;/b&gt;* Incorrect, it was a later file that had the correct value, see the first comment. &lt;/p&gt;

&lt;p&gt;When CollectionController.collectTimeOrderedData() processes the 12325 file (after processing the 12330 file) while looping over the sstables the call to reduceNameFilter() removes the column  from the filter because the column read from the 12330 file has a time stamp of 1307352647576000 and the 12325 file incorrectly has a max time stamp of -9223372036854775808 .&lt;/p&gt;

&lt;p&gt;SSTableMetadata is reading the max time stamp from the stats file, but it is Long.MIN_VALUE. I think this happens because scrub creates the SSTableWriter using cfs.createCompactionWriter() which sets the maxTimestamp in the meta data collector according to the maxTimestamp in the meta data for the file(s) that will be scrubbed / compacted. But for pre 1.0 format files the default in SSTableMetadata is Long.MIN_VALUE, (see SSTableMetaData.deserialize() and the ctor). So scrubbing a pre 1.0 file will write stats files that have maxTimestamp as Long.MIN_VALUE.&lt;/p&gt;

&lt;p&gt;During scrubbing the SSTableWriter does not update the maxTimestamp because append(AbstractCompactedRow) is called which expects the that cfs.createCompactionWriter() was able to set the correct maxTimestamp on the meta data. Compaction also uses append(AbstractCompactedRow) so may create an SSTable with an incorrect maxTimestamp if one of the input files started life as a pre 1.0 file and has a bad maxTimestamp. &lt;/p&gt;

&lt;p&gt;It looks like the only time the maxTimestamp is calculated is when the SSTable is originally written. So the error from the old files will be carried along. &lt;/p&gt;

&lt;p&gt;e.g. If the files a,b and c have the maxTimestamps 10, 100 and Long.MIN_VALUE compaction will write a SSTable with maxTimestamp 100. However file c may actually contain columns with a timestamp &amp;gt; 100 which will be in the compacted file.&lt;/p&gt;

&lt;h1&gt;&lt;a name=&quot;Reproduce&quot;&gt;&lt;/a&gt;Reproduce&lt;/h1&gt;

&lt;p&gt;1. Start a clean 0.8.7&lt;/p&gt;

&lt;p&gt;2. Add a schema (details of the schema do not matter):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[default@unknown] create keyspace dev;   
5f834620-140b-11e1-0000-242d50cf1fdf
Waiting for schema agreement...
... schemas agree across the cluster
[default@unknown] 
[default@unknown] use dev;
Authenticated to keyspace: dev
[default@dev] 
[default@dev] create column family super_dev with column_type = &apos;Super&apos; 
...	and key_validation_class = &apos;AsciiType&apos; and comparator = &apos;AsciiType&apos; and 
...	subcomparator = &apos;AsciiType&apos; and default_validation_class = &apos;AsciiType&apos;;
60490720-140b-11e1-0000-242d50cf1fdf
Waiting for schema agreement...
... schemas agree across the cluster
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;3. Shutdown 0.8.7&lt;/p&gt;

&lt;p&gt;4. Start 1.0.3 using the same data. Check the schema version loaded, example below shows the wrong schema is loaded. I stepped the code and the wrong value was read from Migration.getLastMigrationId() due to this bug. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; INFO [main] 2011-11-21 19:39:08,546 DatabaseDescriptor.java (line 501) Loading schema version 5f834620-140b-11e1-0000-242d50cf1fdf
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;5. Check the schema using the 1.0.3 CLI &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[default@unknown] use dev;
Authenticated to keyspace: dev
[default@dev] describe;
Keyspace: dev:
  Replication Strategy: org.apache.cassandra.locator.NetworkTopologyStrategy
  Durable Writes: true
    Options: [datacenter1:1]
  Column Families:
[default@dev] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;6. I then did a 1.0.3 scrub and re-started. The correct schema version was read, but stepping the code both Schema SSTables had Long.MIN_VALUE as the maxTimestamp so I think it was only the random order of the files that made it work. &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG 19:52:30,744 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/system/Schema-hb-4-Data.db&apos;) and max TS -9223372036854775808
DEBUG 19:52:30,744 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/system/Schema-hb-3-Data.db&apos;) and max TS -9223372036854775808
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h1&gt;&lt;a name=&quot;Fixes&quot;&gt;&lt;/a&gt;Fixes&lt;/h1&gt;

&lt;p&gt;Not sure, (wanted to get the ticket opened and find out if I was imagining things), guessing...&lt;/p&gt;

&lt;p&gt;Use Long.MIN_VALUE as a magic maxTimestamp that means the value is not know. This would not fix issues where the incorrect maxTimestamp been included in compaction. &lt;/p&gt;

&lt;p&gt;Looking at making scrub re-calculate the maxTimestamp.&lt;/p&gt;

&lt;p&gt;Also wondering if the maxTimestamp should default to Long.MAX_VALUE if read from a file format that does not support maxTimestamp ?&lt;/p&gt;</description>
                <environment></environment>
        <key id="12532118">CASSANDRA-3510</key>
            <summary>Incorrect query results due to invalid SSTable.maxTimestamp</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="amorton">Aaron Morton</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Nov 2011 07:15:46 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:46 +0000</updated>
                            <resolved>Tue, 22 Nov 2011 09:40:36 +0000</resolved>
                                        <fixVersion>1.0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13154085" author="amorton" created="Mon, 21 Nov 2011 09:16:42 +0000"  >&lt;p&gt;To be clear, I do not think this is an issue with super CF&apos;s. The Schema CF is a standard, it was noticed on a super CF. &lt;/p&gt;

&lt;p&gt;I added some more logging and removed the call to cut the query short by checking maxTimestamp in CollationController.collectTimeOrderedData(). The query returned the result value (password col with timestamp 1319563673493000) and this was the output &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (SSTableReader sstable : view.sstables)
{
    &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; currentMaxTs = sstable.getMaxTimestamp();
    logger.debug(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Got sstable %s and max TS %d&quot;&lt;/span&gt;, sstable, currentMaxTs));
&lt;span class=&quot;code-comment&quot;&gt;//                reduceNameFilter(reducedFilter, container, currentMaxTs);
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (((NamesQueryFilter) reducedFilter.filter).columns.isEmpty())
&lt;/span&gt;&lt;span class=&quot;code-comment&quot;&gt;//                    &lt;span class=&quot;code-keyword&quot;&gt;break&lt;/span&gt;;
&lt;/span&gt;
    IColumnIterator iter = reducedFilter.getSSTableColumnIterator(sstable);
    iterators.add(iter);
    &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (iter.getColumnFamily() != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;)
    {
        container.delete(iter.getColumnFamily());
        sstablesIterated++;
        &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; (iter.hasNext())
        {
            IColumn col = iter.next();
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (col &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; SuperColumn)
            {
              &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (IColumn subcol : ((SuperColumn)col).columns)
              {
                &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (subcol.name().equals(ByteBufferUtil.bytes(&lt;span class=&quot;code-quote&quot;&gt;&quot;password&quot;&lt;/span&gt;)))
                  logger.debug(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Add Sub Column %s&quot;&lt;/span&gt;, subcol.getString(cfs.metadata.subcolumnComparator)));
              }
            }
            &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
            {
              logger.debug(&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Add Column %s&quot;&lt;/span&gt;, col.getString(cfs.metadata.comparator)));
            }
            container.addColumn(col);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG 22:05:20,748 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12348-Data.db&apos;) and max TS 1321824847534000
DEBUG 22:05:20,749 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12346-Data.db&apos;) and max TS 1321813380793000
DEBUG 22:05:20,753 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12330-Data.db&apos;) and max TS -9223372036854775808
DEBUG 22:05:20,754 Add Sub Column password:false:8@1307352647576000
DEBUG 22:05:20,755 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12325-Data.db&apos;) and max TS -9223372036854775808
DEBUG 22:05:20,757 Add Sub Column password:false:8@1307352647576000
DEBUG 22:05:20,758 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12327-Data.db&apos;) and max TS -9223372036854775808
DEBUG 22:05:20,760 Add Sub Column password:false:8@1307352647576000
DEBUG 22:05:20,761 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12328-Data.db&apos;) and max TS -9223372036854775808
DEBUG 22:05:20,762 Add Sub Column password:false:8@1319563673493000
DEBUG 22:05:20,763 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12326-Data.db&apos;) and max TS -9223372036854775808
DEBUG 22:05:20,765 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12331-Data.db&apos;) and max TS -9223372036854775808
DEBUG 22:05:20,767 Add Sub Column password:false:8@1307352647576000
DEBUG 22:05:20,768 Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/X/Users-hb-12332-Data.db&apos;) and max TS -9223372036854775808
DEBUG 22:05:20,774 Read: 27 ms.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</comment>
                            <comment id="13154111" author="amorton" created="Mon, 21 Nov 2011 10:44:11 +0000"  >&lt;p&gt;patch 0001 is a proof of concept hack based on my first comment, it generated this output when using the extra logging &lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [ReadStage:1] 2011-11-21 23:12:28,578 CollationController.java (line 77) collectTimeOrderedData
DEBUG [ReadStage:1] 2011-11-21 23:12:28,578 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/fmm/Users-hb-12348-Data.db&apos;) and max TS 1321824847534000
DEBUG [ReadStage:1] 2011-11-21 23:12:28,578 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/fmm/Users-hb-12346-Data.db&apos;) and max TS 1321813380793000
DEBUG [ReadStage:1] 2011-11-21 23:12:28,583 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/fmm/Users-hb-12330-Data.db&apos;) and max TS -9223372036854775808
DEBUG [ReadStage:1] 2011-11-21 23:12:28,584 CollationController.java (line 130) Add Sub Column password:false:8@1307352647576000
DEBUG [ReadStage:1] 2011-11-21 23:12:28,585 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/fmm/Users-hb-12325-Data.db&apos;) and max TS -9223372036854775808
DEBUG [ReadStage:1] 2011-11-21 23:12:28,587 CollationController.java (line 130) Add Sub Column password:false:8@1307352647576000
DEBUG [ReadStage:1] 2011-11-21 23:12:28,588 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/fmm/Users-hb-12327-Data.db&apos;) and max TS -9223372036854775808
DEBUG [ReadStage:1] 2011-11-21 23:12:28,590 CollationController.java (line 130) Add Sub Column password:false:8@1307352647576000
DEBUG [ReadStage:1] 2011-11-21 23:12:28,591 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/fmm/Users-hb-12328-Data.db&apos;) and max TS -9223372036854775808
DEBUG [ReadStage:1] 2011-11-21 23:12:28,592 CollationController.java (line 130) Add Sub Column password:false:8@1319563673493000
DEBUG [ReadStage:1] 2011-11-21 23:12:28,593 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/fmm/Users-hb-12326-Data.db&apos;) and max TS -9223372036854775808
DEBUG [ReadStage:1] 2011-11-21 23:12:28,595 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/fmm/Users-hb-12331-Data.db&apos;) and max TS -9223372036854775808
DEBUG [ReadStage:1] 2011-11-21 23:12:28,596 CollationController.java (line 130) Add Sub Column password:false:8@1307352647576000
DEBUG [ReadStage:1] 2011-11-21 23:12:28,597 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/fmm/Users-hb-12332-Data.db&apos;) and max TS -9223372036854775808
DEBUG [pool-2-thread-1] 2011-11-21 23:12:28,604 StorageProxy.java (line 694) Read: 26 ms.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;patch 0002 makes scrub update the maxTimestamp and when I ran my test afterwards it created this output:&lt;/p&gt;

&lt;p&gt;*&lt;b&gt;NOTE&lt;/b&gt;* patch 0002 has incorrect file name, it modifies scrub.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;
DEBUG [ReadStage:33] 2011-11-21 23:20:32,032 CollationController.java (line 77) collectTimeOrderedData
DEBUG [ReadStage:33] 2011-11-21 23:20:32,033 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/private/var/lib/cassandra/data/fmm/Users-hc-12357-Data.db&apos;) and max TS 1321824847534000
DEBUG [ReadStage:33] 2011-11-21 23:20:32,033 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/fmm/Users-hc-12352-Data.db&apos;) and max TS 1321813380793000
DEBUG [ReadStage:33] 2011-11-21 23:20:32,063 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/private/var/lib/cassandra/data/fmm/Users-hc-12356-Data.db&apos;) and max TS 1321560509938000
DEBUG [ReadStage:33] 2011-11-21 23:20:32,064 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/fmm/Users-hc-12349-Data.db&apos;) and max TS 1319813295567000
DEBUG [ReadStage:33] 2011-11-21 23:20:32,105 CollationController.java (line 130) Add Sub Column password:false:8@1319563673493000
DEBUG [ReadStage:33] 2011-11-21 23:20:32,105 CollationController.java (line 111) Got sstable SSTableReader(path=&apos;/var/lib/cassandra/data/fmm/Users-hc-12350-Data.db&apos;) and max TS 1318523190222000
DEBUG [pool-2-thread-2] 2011-11-21 23:20:32,106 StorageProxy.java (line 694) Read: 74 ms.
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13154125" author="slebresne" created="Mon, 21 Nov 2011 11:43:44 +0000"  >&lt;p&gt;The fix of the first patch looks. For the second patch, even though this is an option, I think I&apos;d rather make this parts of compaction, because I don&apos;t like too much having potential subtle bug that needs scrub to be run (without really anything telling you that you potentially have a problem btw).&lt;/p&gt;

&lt;p&gt;Attaching a patch that does this (make it work for compaction in general as long as we&apos;re not using an EchoedRow (which makes it work for scrub in particular)). The patch also adds a few comments and a unit test. It includes the fix of the first patch. &lt;/p&gt;</comment>
                            <comment id="13154228" author="jbellis" created="Mon, 21 Nov 2011 15:08:26 +0000"  >&lt;blockquote&gt;&lt;p&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;+         * However, for old sstables without timestamp, we still want to update the timestamp (and we know
+         * that in this case we will not use EchoedRow).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Where is the &quot;don&apos;t use echoedrow for old sstables&quot; logic?&lt;/p&gt;</comment>
                            <comment id="13154246" author="slebresne" created="Mon, 21 Nov 2011 15:30:11 +0000"  >&lt;blockquote&gt;&lt;p&gt;Where is the &quot;don&apos;t use echoedrow for old sstables&quot; logic?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;In CompactionController.needDeserialize(), but I agree that the comment could be improved to recall it.&lt;/p&gt;</comment>
                            <comment id="13154252" author="jbellis" created="Mon, 21 Nov 2011 15:41:16 +0000"  >&lt;p&gt;Referring to the isLatestVersion check?&lt;/p&gt;</comment>
                            <comment id="13154294" author="slebresne" created="Mon, 21 Nov 2011 16:57:07 +0000"  >&lt;blockquote&gt;&lt;p&gt;Referring to the isLatestVersion check?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes.&lt;/p&gt;</comment>
                            <comment id="13154378" author="amorton" created="Mon, 21 Nov 2011 19:14:53 +0000"  >&lt;p&gt;Thanks, will test shortly. &lt;/p&gt;</comment>
                            <comment id="13154425" author="amorton" created="Mon, 21 Nov 2011 19:57:12 +0000"  >&lt;p&gt;Tested against the current 1.0 head, with the test case I had and the query works as expected. &lt;/p&gt;

&lt;p&gt;I agree doing it in compaction is safer, putting it in repair just got me there faster last night. &lt;/p&gt;

&lt;p&gt;Thanks for cleaning up the patch. &lt;br/&gt;
+1&lt;/p&gt;</comment>
                            <comment id="13154433" author="jbellis" created="Mon, 21 Nov 2011 20:05:52 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13154977" author="slebresne" created="Tue, 22 Nov 2011 09:40:36 +0000"  >&lt;p&gt;Committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12504489" name="0001-3510-ignore-maxTimestamp-if-Long.MIN_VALUE.patch" size="1124" author="amorton" created="Mon, 21 Nov 2011 10:44:11 +0000"/>
                            <attachment id="12504490" name="0002-3510-update-maxTimestamp-during-repair.patch" size="3144" author="amorton" created="Mon, 21 Nov 2011 10:44:11 +0000"/>
                            <attachment id="12504493" name="3510.patch" size="6838" author="slebresne" created="Mon, 21 Nov 2011 11:43:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>217854</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gksn:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94799</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>amorton</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[amorton]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>