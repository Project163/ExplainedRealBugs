<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:47:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7810] tombstones gc&apos;d before being locally applied</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7810</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;ol&gt;
	&lt;li&gt;single node environment&lt;br/&gt;
CREATE KEYSPACE test WITH replication = 
{&apos;class&apos;: &apos;SimpleStrategy&apos;, &apos;replication_factor&apos;: 1 }
&lt;p&gt;;&lt;br/&gt;
use test;&lt;br/&gt;
create table foo (a int, b int, primary key(a,b));&lt;br/&gt;
alter table foo with gc_grace_seconds = 0;&lt;br/&gt;
insert into foo (a,b) values (1,2);&lt;br/&gt;
select * from foo;&lt;/p&gt;
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;one row returned. so far, so good.&lt;br/&gt;
delete from foo where a=1 and b=2;&lt;br/&gt;
select * from foo;&lt;/li&gt;
		&lt;li&gt;0 rows. still rainbows and kittens.&lt;br/&gt;
bin/nodetool flush;&lt;br/&gt;
bin/nodetool compact;&lt;br/&gt;
select * from foo;&lt;br/&gt;
 a | b&lt;br/&gt;
--&lt;del&gt;+&lt;/del&gt;--&lt;br/&gt;
 1 | 2&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;(1 rows)&lt;/p&gt;

&lt;p&gt;gahhh.&lt;/p&gt;

&lt;p&gt;looks like the tombstones were considered obsolete and thrown away before being applied to the compaction?  gc_grace just means the interval after which they won&apos;t be available to remote nodes repair - they should still apply locally regardless (and do correctly in 2.0.9)&lt;/p&gt;</description>
                <environment>&lt;p&gt;2.1.0.rc6&lt;/p&gt;</environment>
        <key id="12735788">CASSANDRA-7810</key>
            <summary>tombstones gc&apos;d before being locally applied</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="jhalliday">Jonathan Halliday</reporter>
                        <labels>
                    </labels>
                <created>Thu, 21 Aug 2014 14:16:36 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:36 +0000</updated>
                            <resolved>Wed, 27 Aug 2014 11:13:42 +0000</resolved>
                                        <fixVersion>1.2.19</fixVersion>
                    <fixVersion>2.0.11</fixVersion>
                    <fixVersion>2.1.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14105457" author="yukim" created="Thu, 21 Aug 2014 15:18:20 +0000"  >&lt;p&gt;I cannot reproduce this on either 2.1.0-rc6 or 2.1.0-HEAD.&lt;br/&gt;
I comfirmed that after &lt;tt&gt;nodetool compact&lt;/tt&gt;, generated SSTable through &lt;tt&gt;nodetool flush&lt;/tt&gt; is gone.&lt;br/&gt;
And following &lt;tt&gt;SELECT&lt;/tt&gt; does not return row as expected.&lt;/p&gt;</comment>
                            <comment id="14105496" author="krummas" created="Thu, 21 Aug 2014 16:01:12 +0000"  >&lt;p&gt;does not repro for me either, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jhalliday&quot; class=&quot;user-hover&quot; rel=&quot;jhalliday&quot;&gt;jhalliday&lt;/a&gt; does the attached dtest fail for you?&lt;/p&gt;</comment>
                            <comment id="14106645" author="jhalliday" created="Fri, 22 Aug 2014 08:59:12 +0000"  >&lt;p&gt;hmm, looks like something fishy in my environment - it works fine when I spin up a new vm instance for the test.  Guess I&apos;m going to be rebuilding my dev environment this morning then...   Thanks guys.&lt;/p&gt;</comment>
                            <comment id="14106873" author="jhalliday" created="Fri, 22 Aug 2014 14:11:16 +0000"  >&lt;p&gt;sorry guys, still seeing this intermittently even after an env cleanup. I suspect it&apos;s linked to the merging of sstables. If I flush the data and tombstones together to a single sstable and compact then it&apos;s fine. If I flush the data and the tombstones separately such that I have two sstables, then compact them, it goes wrong. Any chance someone could try that modified process and see if it&apos;s reproducible? thx.&lt;/p&gt;</comment>
                            <comment id="14107264" author="yukim" created="Fri, 22 Aug 2014 18:36:50 +0000"  >&lt;p&gt;Confirmed.&lt;br/&gt;
When merging two SSTable, one with composite cell and the other with RangeTombstone, only RangeTombstone is removed from merged SSTable (with gc_grace=0).&lt;br/&gt;
I think there is something going on when comparing those two cell name when reducing.&lt;/p&gt;</comment>
                            <comment id="14107538" author="yukim" created="Fri, 22 Aug 2014 21:34:21 +0000"  >&lt;p&gt;So this is broken since we removed PreCompactedRow(&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6142&quot; title=&quot;Remove multithreaded compaction (and precompactedrow)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6142&quot;&gt;&lt;del&gt;CASSANDRA-6142&lt;/del&gt;&lt;/a&gt;).&lt;br/&gt;
In LazilyCompactedRow, gcable RangeTombstone is just thrown away without removing cells it covers.&lt;/p&gt;</comment>
                            <comment id="14108707" author="jbellis" created="Mon, 25 Aug 2014 03:57:47 +0000"  >&lt;p&gt;Is this the same as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7808&quot; title=&quot;LazilyCompactedRow incorrectly handles row tombstones&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7808&quot;&gt;&lt;del&gt;CASSANDRA-7808&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="14109048" author="krummas" created="Mon, 25 Aug 2014 12:18:18 +0000"  >&lt;p&gt;attaching patch to track tombstones we are about to gc&lt;/p&gt;

&lt;p&gt;also makes sure we can safely drop the tombstone by checking maxPurgeableTimestamp&lt;/p&gt;</comment>
                            <comment id="14109077" author="krummas" created="Mon, 25 Aug 2014 12:52:45 +0000"  >&lt;p&gt;or not.. guess this could break columnIndex building since we track tombstones that are not stored&lt;/p&gt;</comment>
                            <comment id="14109080" author="krummas" created="Mon, 25 Aug 2014 13:01:16 +0000"  >&lt;p&gt;introduces a local rt tracker instead&lt;/p&gt;</comment>
                            <comment id="14109130" author="slebresne" created="Mon, 25 Aug 2014 14:12:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;So this is broken since we removed PreCompactedRow&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Doesn&apos;t that mean that 2.0 is affected too, albeit only large rows that are compacted by LazilyCompactedRow are?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;introduces a local rt tracker instead&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Can you elaborate why? Felt to me that using the one of the ColumnIndexer was the right thing to do (and cleaner), but I might be missing something.&lt;/p&gt;

&lt;p&gt;Small nit on the patch while at it: there&apos;s an &lt;tt&gt;assertEmpty&lt;/tt&gt; in &lt;tt&gt;CQLTester&lt;/tt&gt; (slightly less verbose than doing it manually).&lt;/p&gt;</comment>
                            <comment id="14109132" author="slebresne" created="Mon, 25 Aug 2014 14:17:57 +0000"  >&lt;blockquote&gt;&lt;p&gt;Can you elaborate why?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I had missed your &quot; this could break columnIndex building since we track tombstones that are not stored&quot;. Still kind of feel that fixing the tombstone tracker to not write on disk expired tombstones would be cleaner.&lt;/p&gt;</comment>
                            <comment id="14109144" author="yukim" created="Mon, 25 Aug 2014 14:29:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;Doesn&apos;t that mean that 2.0 is affected too&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This can be. I will check 2.0 as well.&lt;/p&gt;</comment>
                            <comment id="14109152" author="krummas" created="Mon, 25 Aug 2014 14:38:27 +0000"  >&lt;blockquote&gt;&lt;p&gt;Doesn&apos;t that mean that 2.0 is affected too&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yeah, I was going to dig in to that when looking at &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7808&quot; title=&quot;LazilyCompactedRow incorrectly handles row tombstones&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7808&quot;&gt;&lt;del&gt;CASSANDRA-7808&lt;/del&gt;&lt;/a&gt; - as &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; mentioned above, it looks related&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Still kind of feel that fixing the tombstone tracker to not write on disk expired tombstones would be cleaner.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Agreed, I&apos;ll see what I can do&lt;/p&gt;</comment>
                            <comment id="14109185" author="yukim" created="Mon, 25 Aug 2014 15:10:31 +0000"  >&lt;p&gt;Tested with 2.0 and it looks like 2.0 also has the same problem.&lt;/p&gt;</comment>
                            <comment id="14109276" author="yukim" created="Mon, 25 Aug 2014 16:33:03 +0000"  >&lt;p&gt;Attaching 2.0 version of Mercus&apos; patch.&lt;/p&gt;</comment>
                            <comment id="14110441" author="krummas" created="Tue, 26 Aug 2014 07:35:47 +0000"  >&lt;p&gt;updated patch that uses the tombstone tracker in index builder to track expired tombstones&lt;/p&gt;

&lt;p&gt;for 2.1 as well, will do the same for the 2.0-patch once this is reviewed&lt;/p&gt;</comment>
                            <comment id="14110636" author="krummas" created="Tue, 26 Aug 2014 12:09:16 +0000"  >&lt;p&gt;this goes back to 1.2 and it is not related to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7808&quot; title=&quot;LazilyCompactedRow incorrectly handles row tombstones&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7808&quot;&gt;&lt;del&gt;CASSANDRA-7808&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14110905" author="slebresne" created="Tue, 26 Aug 2014 16:30:13 +0000"  >&lt;p&gt;We don&apos;t really need the &lt;tt&gt;if (!(expired.contains(tombstone) &amp;amp;&amp;amp; !isExpired))&lt;/tt&gt; check in &lt;tt&gt;RangeTombstone.tracker&lt;/tt&gt;: if the new tombstone and the existing one have the same &quot;data&quot; they are obligatory either both expired or none are (since the RT data is its deletion times info). Other than that, we could avoid the isExpired set by passing maxPurgeableTimestamp and gcBefore to the tombstone tacker and simply having it skipping expired tombstone when writting the &quot;markers&quot;, but I don&apos;t mind too much so if you like it the way it is, lgtm.&lt;/p&gt;</comment>
                            <comment id="14112136" author="krummas" created="Wed, 27 Aug 2014 11:13:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;We don&apos;t really need the ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;ah of course, nice, removed&lt;/p&gt;

&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="14127644" author="peter-librato" created="Tue, 9 Sep 2014 22:09:54 +0000"  >&lt;p&gt;This is listed in the 2.0 CHANGES.txt as present in 2.0.10 but &quot;Fix Versions&quot; shows 2.0.11.&lt;/p&gt;</comment>
                            <comment id="14128639" author="krummas" created="Wed, 10 Sep 2014 16:00:22 +0000"  >&lt;p&gt;should be 2.0.11 in CHANGES - probably merge issue&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12832837">CASSANDRA-9486</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12664166" name="0001-7810-test-for-2.0.x.patch" size="4216" author="yukim" created="Mon, 25 Aug 2014 16:33:03 +0000"/>
                            <attachment id="12664342" name="0001-track-gcable-tombstones-v2.patch" size="7071" author="marcuse" created="Tue, 26 Aug 2014 07:35:47 +0000"/>
                            <attachment id="12664142" name="0001-track-gcable-tombstones.patch" size="5253" author="marcuse" created="Mon, 25 Aug 2014 13:01:16 +0000"/>
                            <attachment id="12664167" name="0002-track-gcable-tombstones-for-2.0.patch" size="2408" author="yukim" created="Mon, 25 Aug 2014 16:33:03 +0000"/>
                            <attachment id="12663422" name="range_tombstone_test.py" size="848" author="marcuse" created="Thu, 21 Aug 2014 16:27:48 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 10 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1z6nz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12327158">1.2.18</customfieldvalue>
    <customfieldvalue id="12327164">2.0.10</customfieldvalue>
    <customfieldvalue id="12327576">2.1 rc6</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>