<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:15:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14781] Log message when mutation passed to CommitLog#add(Mutation) is too large is not descriptive enough</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14781</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When hitting &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/commitlog/CommitLog.java#L256-L257&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/commitlog/CommitLog.java#L256-L257&lt;/a&gt;, the log message produced does not help the operator track down what data is being written. At a minimum the keyspace and cfIds involved would be useful (and are available) &#8211; more detail might not be reasonable to include.&#160;&lt;/p&gt;</description>
                <environment></environment>
        <key id="13186708">CASSANDRA-14781</key>
            <summary>Log message when mutation passed to CommitLog#add(Mutation) is too large is not descriptive enough</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="n.v.harikrishna">n.v.harikrishna</assignee>
                                    <reporter username="jwest">Jordan West</reporter>
                        <labels>
                            <label>protocolv5</label>
                    </labels>
                <created>Fri, 21 Sep 2018 19:29:34 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:38 +0000</updated>
                            <resolved>Mon, 4 May 2020 18:33:40 +0000</resolved>
                                        <fixVersion>4.0-beta1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Hints</component>
                    <component>Local/Commit Log</component>
                    <component>Messaging/Client</component>
                        <due></due>
                            <votes>1</votes>
                                    <watches>16</watches>
                                                                                                                <comments>
                            <comment id="16626105" author="tpetracca" created="Mon, 24 Sep 2018 16:46:59 +0000"  >&lt;p&gt;Related: &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12231&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-12231&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12941074/12941074_CASSANDRA-14781.patch&quot; title=&quot;CASSANDRA-14781.patch attached to CASSANDRA-14781&quot;&gt;CASSANDRA-14781.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;&lt;sup&gt;The attached&#160;trivial patch (built off of 2.2.X)&#160;is an easy way to get more info&lt;/sup&gt;&lt;/p&gt;</comment>
                            <comment id="16626665" author="jrwest" created="Tue, 25 Sep 2018 01:49:05 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tpetracca&quot; class=&quot;user-hover&quot; rel=&quot;tpetracca&quot;&gt;tpetracca&lt;/a&gt; thanks for the patch! &lt;tt&gt;Mutation::getColumnFamilies&lt;/tt&gt; was removed in Cassandra 3.0. Would you be interested in updating your patch for 3.0+ and I can review?&lt;/p&gt;</comment>
                            <comment id="16626684" author="tpetracca" created="Tue, 25 Sep 2018 02:37:23 +0000"  >&lt;p&gt;I&apos;m significantly less familiar with the 3.0+ code but at a quick glance it looks like every partition update should actually contain all this information at this point.&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12941143/12941143_CASSANDRA-14781_3.0.patch&quot; title=&quot;CASSANDRA-14781_3.0.patch attached to CASSANDRA-14781&quot;&gt;CASSANDRA-14781_3.0.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="16655317" author="cnlwsu" created="Thu, 18 Oct 2018 14:31:31 +0000"  >&lt;p&gt;To cover extreme cases, can you add a limit of like 10 tables then add a &quot; ... and X more&quot; or something? Also can you include the partition keys with a similar cap to prevent the string from getting too large. For the common case where theres only 1 large mutation or a bunch to a single partition that would be monumentally helpful.&lt;/p&gt;</comment>
                            <comment id="16944747" author="leonz" created="Fri, 4 Oct 2019 18:35:30 +0000"  >&lt;p&gt;&lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12982249/12982249_CASSANDRA-14781_3.11.patch&quot; title=&quot;CASSANDRA-14781_3.11.patch attached to CASSANDRA-14781&quot;&gt;CASSANDRA-14781_3.11.patch&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;Hey &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=cnlwsu&quot; class=&quot;user-hover&quot; rel=&quot;cnlwsu&quot;&gt;cnlwsu&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt;, I&apos;ve attached a patch for 3.11 (should be the same for 3.0) that prints (cf, key) pairs with a limit of 10.&lt;/p&gt;</comment>
                            <comment id="16947104" author="cnlwsu" created="Tue, 8 Oct 2019 18:20:29 +0000"  >&lt;p&gt;Thanks for the update! A few more things things:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Lets make this work for 4.0 first, I am not sure about backporting it to 3.11 or 3.0 at this point&lt;/li&gt;
	&lt;li&gt;Can you move the &lt;tt&gt;limit&lt;/tt&gt; up to a constant? Be great if that was something we can override too in yaml/jmx override incase need to to see more than 10 and accept risk but that can come later if dont want to include it in this patch.&lt;/li&gt;
	&lt;li&gt;If limited, can you make sure to show largest keys first instead of just taking first off the updates.&lt;/li&gt;
	&lt;li&gt;If we have metadata and the key, instead of doing a toString on the decorated key which gives a large hex dump, you can use &lt;tt&gt;partitionKeyType.getString(keybytes)&lt;/tt&gt; to get the human readable version.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;something like (this is untested, just example):&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
                 mutation.getPartitionUpdates().stream()
                         .sorted(Comparator.comparingInt(PartitionUpdate::dataSize).reversed())
                         .limit(LIMIT)
                         .map(upd -&amp;gt; &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;%s[%s]&quot;&lt;/span&gt;,
                             upd.metadata().name,
                             upd.metadata().partitionKeyType.getString(upd.partitionKey().getKey())))
                         .collect(Collectors.joining(&lt;span class=&quot;code-quote&quot;&gt;&quot;, &quot;&lt;/span&gt;));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="16972590" author="iamaleksey" created="Tue, 12 Nov 2019 16:30:48 +0000"  >&lt;p&gt;I&apos;d say this is a little insufficient. You have the exact same situation with writing hints in &lt;tt&gt;HintsBuffer.allocate()&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;What you want is to add an extra validation downstream all the way to &lt;tt&gt;ModificationStatement&lt;/tt&gt;, so that you can return a meaningful exception to the client immediately - rather than ending up timing out the response.&lt;/p&gt;</comment>
                            <comment id="16972601" author="iamaleksey" created="Tue, 12 Nov 2019 16:34:36 +0000"  >&lt;p&gt;I would also not bother with listing individual tables; keyspace and partition key should hopefully be sufficient enough, and memoise calculated &lt;tt&gt;Mutation&lt;/tt&gt; size in the &lt;tt&gt;Mutation&lt;/tt&gt; object (see &lt;tt&gt;serializedSize*&lt;/tt&gt; fields in &lt;tt&gt;Message&lt;/tt&gt; in 4.0) to prevent redundant calculations by subsequent stages.&lt;/p&gt;</comment>
                            <comment id="17007005" author="n.v.harikrishna" created="Thu, 2 Jan 2020 18:50:47 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tpetracca&quot; class=&quot;user-hover&quot; rel=&quot;tpetracca&quot;&gt;tpetracca&lt;/a&gt;&#160;Would you mind if I submit a patch for this? I ran into this requirement and made some progress on the patch.&lt;/p&gt;</comment>
                            <comment id="17008622" author="n.v.harikrishna" created="Mon, 6 Jan 2020 08:25:57 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt;&#160;Made a patch with the changes. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tpetracca&quot; class=&quot;user-hover&quot; rel=&quot;tpetracca&quot;&gt;tpetracca&lt;/a&gt;&#160;apologies if I am overtaking you.&lt;/p&gt;

&lt;p&gt;Here is the &lt;a href=&quot;https://github.com/nvharikrishna/cassandra/commit/5b3af390ce64860505dfeb3a3549cc9897987771&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt; and &lt;a href=&quot;https://app.circleci.com/jobs/github/nvharikrishna/cassandra/95&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I have a small question though. In &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/commitlog/CommitLog.java#L274&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CommitLog.java&lt;/a&gt;, it considers commit log entry overhead with mutation size to compare with max mutation size. Shouldn&apos;t it consider only the mutation size? I made changes to be compatible with overhead (I can change based on your comments).&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;SizeHolder&lt;/tt&gt; introduced in this patch can be used in &lt;tt&gt;Message&lt;/tt&gt; as well. I can make this change too if it is okay to mixup.&lt;/p&gt;</comment>
                            <comment id="17009182" author="jrwest" created="Mon, 6 Jan 2020 21:28:57 +0000"  >&lt;p&gt;Thanks for picking this up&#160;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=n.v.harikrishna&quot; class=&quot;user-hover&quot; rel=&quot;n.v.harikrishna&quot;&gt;n.v.harikrishna&lt;/a&gt;. Comments below.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;General:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Since this change logs keys which in some use cases may contain PII that users may not want logged, should we add a flag to gate this feature?&#160;&lt;/li&gt;
	&lt;li&gt;I don&#8217;t believe this address &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt;&apos;s concern that the exception be propagated to the client vs. timing out. At a minimum, we should add an in-jvm dtest to show it does (I&#8217;m happy to help contribute this unless you&#8217;d like to). Its possible to split the patch into two parts (one that changes the logging and one that propagates the exception), however, in prod I&#8217;ve seen the lack of this logging and the timeouts be an issue so they are definitely both worth addressing.&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;CommitLog:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;With your change to validate the size using serializedSize, it looks like its no longer be necessary to use the scratch buffer (which seems to be used primarily to get the length w/o calculating serialized size). However, I wonder if the original approach is better performance wise since we are already serializing the mutation. It would be good to benchmark workloads with all mutations exceeding max size, no mutations exceeding max size, and mixed to check because I can imagine how what I said is wrong as well. We should check if there is any difference or if its negligible.&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;SizeHolder:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Since the only call to &lt;tt&gt;#getSize()&lt;/tt&gt; currently is &lt;tt&gt;IMutation#validateSize&lt;/tt&gt; which is only called once from CommitLog.java. Consider removing the memoization.&#160;&lt;/li&gt;
	&lt;li&gt;If the memoization is still desired, I don&#8217;t think its necessary to have fields for each version since a mutation is executed within a single version of Cassandra (it may cross network boundaries and thus versions but at this point we have a new SizeHolder). Using a single variable would cleanup &lt;tt&gt;#getSize&lt;/tt&gt; considerably. Further, it would be cleaner/less error prone to memoize the size in the mutation since nothing maps the object passed to &lt;tt&gt;#getSize&lt;/tt&gt; to the stored value.&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;MutationExceededMaxSizeException:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;tt&gt;prepareMessage&lt;/tt&gt; recalculates the mutation size. While this is an exceptional case it is still common. Perhaps a place where the memoization could be helpful?&#160;&lt;/li&gt;
	&lt;li&gt;Spelling error: maxMutaionSize&lt;/li&gt;
	&lt;li&gt;I almost always prefer a configurable limit to something hardcoded and requiring recompilation to change&#160;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Other:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I don&#8217;t think &lt;tt&gt;IMutation.getMaxMutationSize()&lt;/tt&gt; is necessary. Use &lt;tt&gt;DatabaseDescriptor&lt;/tt&gt; instead. This is more typical of Cassandra config code. Further, the original code only called &lt;tt&gt;DatabaseDescriptor.getMaxMutationSize()&lt;/tt&gt; once instead of for every write. Unless we are going to make it a hot-prop its worth putting back to how it was.&#160;&lt;/li&gt;
	&lt;li&gt;We have a few &lt;tt&gt;Serializer&lt;/tt&gt; interfaces in C* already, consider renaming &lt;tt&gt;SizeHolder.Serializer&lt;/tt&gt; if its kept&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17009694" author="iamaleksey" created="Tue, 7 Jan 2020 12:51:48 +0000"  >&lt;p&gt;For what it&apos;s worth, I would strongly prefer the memoised fields to be inlined into &lt;tt&gt;Mutation&lt;/tt&gt;, same way they are in &lt;tt&gt;Message&lt;/tt&gt;. It&apos;s a very common object, and the bloat of the overhead of&#160;an extra&#160;&lt;tt&gt;SizeHolder&lt;/tt&gt; object vs. just the 3 inlined fields matters.&lt;/p&gt;

&lt;p&gt;We do want the memoisation itself, as otherwise we would be performing this calculation at least twice - once when validation, once when calculating message size for internode.&lt;/p&gt;</comment>
                            <comment id="17009986" author="n.v.harikrishna" created="Tue, 7 Jan 2020 18:53:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;Since the only call to #getSize() currently is IMutation#validateSize which is only called once from CommitLog.java. Consider removing the memoization.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Size is validated at org.apache.cassandra.service.reads.repair.BlockingReadRepairs#createRepairMutation method too. It may use different version for serialization based on destination. I feel memoization is required. Somehow I missed to include changes for this method in the patch. Including this change while addressing other review comments. Will update the patch asap.&lt;/p&gt;</comment>
                            <comment id="17010015" author="jrwest" created="Tue, 7 Jan 2020 19:26:23 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=n.v.harikrishna&quot; class=&quot;user-hover&quot; rel=&quot;n.v.harikrishna&quot;&gt;n.v.harikrishna&lt;/a&gt; . My comment re: memoization was more to give an option if we didn&apos;t need it. Since we do (based on my later comments, your comments, and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt; comments), I agree w/ &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt; suggestion re: removing &lt;tt&gt;SizeHolder&lt;/tt&gt;.&#160;&lt;/p&gt;</comment>
                            <comment id="17010954" author="n.v.harikrishna" created="Wed, 8 Jan 2020 19:18:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt;&#160;Made the changes.&#160;&lt;/p&gt;

&lt;p&gt;Here is the &lt;a href=&quot;https://github.com/nvharikrishna/cassandra/commit/1eb9a9846187f669516c88c85fa3550e4efb08f7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;updated patch&lt;/a&gt; and &lt;a href=&quot;https://app.circleci.com/jobs/github/nvharikrishna/cassandra/120&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;CI&lt;/a&gt;.&#160;&lt;/p&gt;

&lt;p&gt;Summary of changes:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Removed SizeHolder&lt;/li&gt;
	&lt;li&gt;MutationExceededMaxSizeException
	&lt;ul&gt;
		&lt;li&gt;Avoided calculating size again.&lt;/li&gt;
		&lt;li&gt;Changed constant for limiting no.of keys to size of the message. We are mostly concerned about dumping huge message to log. No.of keys to log has to vary based on its size and there won&apos;t be an ideal config by no.of keys. So changed it to message size (1kb for now, we can increase it further).&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;IMutation
	&lt;ul&gt;
		&lt;li&gt;removed getMaxMutationSize and replaced it with constant from CommitLog.&#160;&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
	&lt;li&gt;Replaced Mutation.serializer.serializedSize with mutation.serializedSize.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17012915" author="iamaleksey" created="Fri, 10 Jan 2020 14:24:08 +0000"  >&lt;p&gt;Could you flip the size fields to &lt;tt&gt;int&lt;/tt&gt; from &lt;tt&gt;long&lt;/tt&gt;? (not a full review, just a super quick skim related to my only previous point)&lt;/p&gt;</comment>
                            <comment id="17012980" author="jrwest" created="Fri, 10 Jan 2020 15:46:00 +0000"  >&lt;p&gt;A few code review comments below. I did want to discuss if we are going to address the user facing concerns Aleksey brought up in this ticket? The patch addresses the operators lack of visibility into keyspace/table/partitions but still results in timeouts for the user. Are we going to address those in a separate ticket? My thought is that something for the operators is better than no patch (having been blind in this situation before besides custom tools) but if the user facing changes require protocol changes we should probably fix it pre-4.0 like we have or plan to w/ other similar tickets &#8211; but that could still be in a separate ticket.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Code Comments:&#160;&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;del&gt;&lt;tt&gt;Mutation#serializedSize&lt;/tt&gt;: you should only need one field to memoize the size and can you pass version directly to &lt;tt&gt;Serializer#serializedSize&lt;/tt&gt;&#160;instead of the switch afterwards?&lt;/del&gt; never mind &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=n.v.harikrishna&quot; class=&quot;user-hover&quot; rel=&quot;n.v.harikrishna&quot;&gt;n.v.harikrishna&lt;/a&gt; pointed out code in &lt;tt&gt;BlockingReadRepairs&lt;/tt&gt; that makes this statement false.&lt;/li&gt;
	&lt;li&gt;We also shouldn&#8217;t duplicate the implementations between counter and regular mutations&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;validateSize&lt;/tt&gt;: since the two implementations are identical you could move them to a &lt;tt&gt;default&lt;/tt&gt; implementation in &lt;tt&gt;IMutation&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;MaxMutationExceededException&lt;/tt&gt;: the sort in &lt;tt&gt;#prepareMessage&lt;/tt&gt;&#160;could get pretty expensive, is it necessary? It also looks like there is an edge case where &#8220;and more&#8221; will be added even when there aren&#8217;t more. Using &lt;tt&gt;listIterator.hasNext()&lt;/tt&gt;&#160;instead of &lt;tt&gt;topPartitions.size() &amp;gt; 0&lt;/tt&gt;&#160;should fix that&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17015369" author="n.v.harikrishna" created="Tue, 14 Jan 2020 20:19:04 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;A few code review comments below. I did want to discuss if we are going to address the user facing concerns Aleksey brought up in this ticket? The patch addresses the operators lack of visibility into keyspace/table/partitions but still results in timeouts for the user. Are we going to address those in a separate ticket? My thought is that something for the operators is better than no patch (having been blind in this situation before besides custom tools) but if the user facing changes require protocol changes we should probably fix it pre-4.0 like we have or plan to w/ other similar tickets &#8211; but that could still be in a separate ticket.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I would prefer to have a separate ticket. +1 on having something better than no patch.&lt;/p&gt;
&lt;blockquote&gt;
&lt;ul&gt;
	&lt;li&gt;We also shouldn&#8217;t duplicate the implementations between counter and regular mutations&lt;/li&gt;
	&lt;li&gt;validateSize: since the two implementations are identical you could move them to a default implementation in IMutation&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;validateSize methods implementation looks similar, but they use different serialisers (Mutation uses MutationSerializer and CounterMutation uses CounterMutationSerializer) which are not visible in IMutation interface. serializedSize() methods needs memoization (needs serializedSize* fields) be cause of which we cannot move to interface as fields will be final. We had ruled out option having a separate class (i.e. SizeHolder). Now it makes me think about 2 options.&lt;/p&gt;

&lt;p&gt;1. I could not find any validation of size for &lt;tt&gt;CounterMutation&lt;/tt&gt;. If it is expected or not required, then can remove &lt;tt&gt;CounterMutaiton&lt;/tt&gt; changes and use{{ Mutation.validateSize}} directly (instead of defining it in &lt;tt&gt;IMutation&lt;/tt&gt;). The disadvantage I see with this approach is caller has to be aware of implementation and it makes things hard to abstract (code has to be aware of implementation instead of &lt;tt&gt;IMutation&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;2. Expect &lt;tt&gt;VirtualMutaiton&lt;/tt&gt;, I see mutations are expected to be serialized and/or deserialized. Provide serialize, serialziedSize and deserialize methods as part of &lt;tt&gt;IMutaiton&lt;/tt&gt; (so that we can abstract out direct usages of &lt;tt&gt;Mutation.serializer&lt;/tt&gt; and &lt;tt&gt;CounterMutation.serializer&lt;/tt&gt;) with an abstract class in between having common functionality.&lt;/p&gt;

&lt;p&gt;Or else pay the price of duplicate code. What do you think?&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;MaxMutationExceededException: the sort in #prepareMessage could get pretty expensive, is it necessary?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In Mutation, I see that there is only one PartitionUpdate per Table, and according to Mutation.merge() logic, a mutation can have changes related to only one keyspace and one key. Even if there are multiple updates for different rows of same partition, they are merged into single PartitionUpdate.&lt;/p&gt;

&lt;p&gt;When I ran a small test for sorting list of Longs (laptop having i7, 6 core and 16gb ram) it took approximately 33ms, 6ms and 1ms for 100K, 10k and 1k respectively.&lt;/p&gt;

&lt;p&gt;According to merge logic and test numbers, unless there are thousands of tables in a key space and trying to update all of them at once, I dont see a scenario where sorting can hurt (time taken for sort &amp;gt; 1 or 2ms).&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;It also looks like there is an edge case where &#8220;and more&#8221; will be added even when there aren&#8217;t more. Using listIterator.hasNext() instead of topPartitions.size() &amp;gt; 0 should fix that&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;I had moved the code into separte funtion and added unit test cases. It is working as expected. Using listIterator.hasNext() caused few tests to fail. Did I miss any scenario to test?&lt;/p&gt;

&lt;p&gt;Converted serializedSize* long fields to int as suggested by Aleksey. Changes are here:&#160;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...nvharikrishna:14781-trunk?expand=1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...nvharikrishna:14781-trunk?expand=1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17018144" author="jrwest" created="Fri, 17 Jan 2020 15:52:23 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=n.v.harikrishna&quot; class=&quot;user-hover&quot; rel=&quot;n.v.harikrishna&quot;&gt;n.v.harikrishna&lt;/a&gt;. I think the duplicate code is probably simpler than making things more nuanced and thanks for testing the sorting performance. The code looks ok me and I am ok w/ the separate ticket approach so that there is some improvements for operators at a minimum but I would like to get &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt;&apos;s input as well.&#160;&lt;/p&gt;</comment>
                            <comment id="17021091" author="iamaleksey" created="Wed, 22 Jan 2020 14:04:15 +0000"  >&lt;p&gt;I&apos;m perfectly fine with this level of duplication. Don&apos;t mind a separate ticket, either. Although FWIW that other ticket is the important one - we should never ever get to the point when an oversized mutation makes it to the commitlog at all, outside of potentially boundary mixed mode conditions - when a mutation validates for the current messaging version but ends up being slightly over the size for legacy.&lt;/p&gt;</comment>
                            <comment id="17065110" author="edimitrova" created="Mon, 23 Mar 2020 21:22:49 +0000"  >&lt;p&gt;Was additional ticket opened?&lt;br/&gt;
What shall we do with this one?&lt;/p&gt;</comment>
                            <comment id="17078740" author="jrwest" created="Wed, 8 Apr 2020 21:35:01 +0000"  >&lt;p&gt;I believe this patch is ready (and has one +1) but needs a committer to review. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=n.v.harikrishna&quot; class=&quot;user-hover&quot; rel=&quot;n.v.harikrishna&quot;&gt;n.v.harikrishna&lt;/a&gt; was another ticket opened? &lt;/p&gt;</comment>
                            <comment id="17087386" author="n.v.harikrishna" created="Mon, 20 Apr 2020 05:51:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jrwest&quot; class=&quot;user-hover&quot; rel=&quot;jrwest&quot;&gt;jrwest&lt;/a&gt;&#160;raised&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15741&quot; title=&quot;Mutation size exceeds max limit - clients get timeout?&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15741&quot;&gt;CASSANDRA-15741&lt;/a&gt; for validation and/or fixing client timeout when mutation exceeds max size.&lt;/p&gt;</comment>
                            <comment id="17096595" author="jrwest" created="Thu, 30 Apr 2020 14:39:41 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=n.v.harikrishna&quot; class=&quot;user-hover&quot; rel=&quot;n.v.harikrishna&quot;&gt;n.v.harikrishna&lt;/a&gt;. I&apos;ve picked this back up and am getting it ready to commit. Thanks for your patience.&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve squashed your branch here: &lt;a href=&quot;https://github.com/jrwest/cassandra/commits/14781-trunk.&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/jrwest/cassandra/commits/14781-trunk.&lt;/a&gt;&#160;I made a few minor changes along the way (I also re-reviewed since it had been a little bit since I had read the patch):&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;Modified &lt;tt&gt;CHANGES.txt&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;Modified &lt;tt&gt;IMutation#validateSize&lt;/tt&gt; javadoc&lt;/li&gt;
	&lt;li&gt;Moved call to &lt;tt&gt;Keyspace.open&lt;/tt&gt; into the catch block of &lt;tt&gt;BlockingReadRepairs#createRepairMutation&lt;/tt&gt;. It was only used if we reached that block anyways.&lt;/li&gt;
	&lt;li&gt;Fixed whitespace formatting in &lt;tt&gt;MutationExceededMaxSizeException#prepareMessage&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I ran a build prior to these changes. The build looked good (better than trunk actually) and any failures do not seem related:&#160;&lt;a href=&quot;https://app.circleci.com/pipelines/github/jrwest/cassandra/4/workflows/e43918eb-40d2-45ad-80c3-dbeaa5ee186b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jrwest/cassandra/4/workflows/e43918eb-40d2-45ad-80c3-dbeaa5ee186b&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve kicked off a new build with the changes above and with the squash performed: &lt;a href=&quot;https://app.circleci.com/pipelines/github/jrwest/cassandra/6/workflows/3c3f674e-db89-488a-bbd5-98f04de4fd0d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/jrwest/cassandra/6/workflows/3c3f674e-db89-488a-bbd5-98f04de4fd0d&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;EDIT:&lt;/p&gt;

&lt;p&gt;I was slightly concerned about the failure in &lt;tt&gt;read_repair_test.py&lt;/tt&gt;&apos;s &lt;tt&gt;test_speculative_data_request&lt;/tt&gt;. Looking closer at the test runs, its flaky and doesn&apos;t look like that flakiness could be related to the changes here (since the mutation sizes are static).&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;I&apos;ve also kicked off a Jenkins build for good measure: &lt;a href=&quot;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/107/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/view/patches/job/Cassandra-devbranch/107/&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17099222" author="jrwest" created="Mon, 4 May 2020 18:20:02 +0000"  >&lt;p&gt;Tests looked good. Any failures are suspected flaky tests and are unrelated. Committed as&#160;d3dadcd6f3bbde471e972f8332eb62de0f2d4aae.&#160;&lt;/p&gt;</comment>
                            <comment id="17100077" author="n.v.harikrishna" created="Tue, 5 May 2020 16:57:53 +0000"  >&lt;p&gt;Thanks a lot &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jwest&quot; class=&quot;user-hover&quot; rel=&quot;jwest&quot;&gt;jwest&lt;/a&gt;&#160;for taking it forward!!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13299576">CASSANDRA-15741</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13186716">CASSANDRA-14782</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12990632">CASSANDRA-12231</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12941074" name="CASSANDRA-14781.patch" size="1213" author="tpetracca" created="Mon, 24 Sep 2018 16:46:46 +0000"/>
                            <attachment id="12941143" name="CASSANDRA-14781_3.0.patch" size="1763" author="tpetracca" created="Tue, 25 Sep 2018 02:36:53 +0000"/>
                            <attachment id="12982249" name="CASSANDRA-14781_3.11.patch" size="3384" author="leonz" created="Fri, 4 Oct 2019 18:34:23 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[n.v.harikrishna]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 28 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3yd7j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>cnlwsu</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[cnlwsu]]></customfieldvalue>
        <customfieldvalue><![CDATA[jwest]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348285">4.0-beta1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/d3dadcd6f3bbde471e972f8332eb62de0f2d4aae&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/d3dadcd6f3bbde471e972f8332eb62de0f2d4aae&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>