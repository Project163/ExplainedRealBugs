<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:23:18 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-17116] When streaming sees a ClosedChannelException this triggers the disk failure policy</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-17116</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Found in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17085&quot; title=&quot;commit log was switched from non-daemon to daemon threads, which causes the JVM to exit in some case as no non-daemon threads are active&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17085&quot;&gt;&lt;del&gt;CASSANDRA-17085&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1069/workflows/26b7b83a-686f-4516-a56a-0709d428d4f2/jobs/7264&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1069/workflows/26b7b83a-686f-4516-a56a-0709d428d4f2/jobs/7264&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1069/workflows/26b7b83a-686f-4516-a56a-0709d428d4f2/jobs/7256&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1069/workflows/26b7b83a-686f-4516-a56a-0709d428d4f2/jobs/7256&lt;/a&gt;&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [Stream-Deserializer-/127.0.0.1:7000-f2eb1a15] 2021-11-02 21:35:40,983 DefaultFSErrorHandler.java:104 - Exiting forcefully due to file system exception on startup, disk failure policy &lt;span class=&quot;code-quote&quot;&gt;&quot;stop&quot;&lt;/span&gt;
org.apache.cassandra.io.FSWriteError: java.nio.channels.ClosedChannelException
	at org.apache.cassandra.io.sstable.format.big.BigTableZeroCopyWriter.write(BigTableZeroCopyWriter.java:227)
	at org.apache.cassandra.io.sstable.format.big.BigTableZeroCopyWriter.writeComponent(BigTableZeroCopyWriter.java:206)
	at org.apache.cassandra.db.streaming.CassandraEntireSSTableStreamReader.read(CassandraEntireSSTableStreamReader.java:125)
	at org.apache.cassandra.db.streaming.CassandraIncomingFile.read(CassandraIncomingFile.java:84)
	at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:51)
	at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:37)
	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:50)
	at org.apache.cassandra.streaming.StreamDeserializingTask.run(StreamDeserializingTask.java:62)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
Caused by: java.nio.channels.ClosedChannelException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.net.AsyncStreamingInputPlus.reBuffer(AsyncStreamingInputPlus.java:136)
	at org.apache.cassandra.net.AsyncStreamingInputPlus.consume(AsyncStreamingInputPlus.java:155)
	at org.apache.cassandra.io.sstable.format.big.BigTableZeroCopyWriter.write(BigTableZeroCopyWriter.java:217)
	... 9 common frames omitted
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;When bootstrap fails and streaming is closed, this triggers the disk failure policy which causes the JVM to halt by default (if this happens outside of bootstrap, then we stop transports and keep the JVM up).&lt;/p&gt;

&lt;p&gt;org.apache.cassandra.streaming.StreamDeserializingTask attempts to handle this by ignoring this exception, but the call to org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize&lt;br/&gt;
 Does try/catch and inspects exception; triggering this condition.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13409763">CASSANDRA-17116</key>
            <summary>When streaming sees a ClosedChannelException this triggers the disk failure policy</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="dcapwell">David Capwell</assignee>
                                    <reporter username="dcapwell">David Capwell</reporter>
                        <labels>
                    </labels>
                <created>Tue, 2 Nov 2021 23:38:24 +0000</created>
                <updated>Tue, 14 Oct 2025 12:14:00 +0000</updated>
                            <resolved>Fri, 4 Feb 2022 19:53:37 +0000</resolved>
                                        <fixVersion>4.1-alpha1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                                    <component>Consistency/Streaming</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17437668" author="dcapwell" created="Tue, 2 Nov 2021 23:40:59 +0000"  >&lt;p&gt;if this is impacting 4.0 as well we should add 4.0.x to fix version; not confirmed though&lt;/p&gt;</comment>
                            <comment id="17438213" author="dcapwell" created="Wed, 3 Nov 2021 17:28:29 +0000"  >&lt;p&gt;have a patch which replicates the problem and found several other issues as well.  This issue only triggers disk policy for zero-copy-streaming but the error handling in streaming also was causing issues as it wouldn&apos;t properly close the session; leaving it hanging...&lt;/p&gt;</comment>
                            <comment id="17438345" author="dcapwell" created="Wed, 3 Nov 2021 23:48:38 +0000"  >&lt;p&gt;To show that the test actually detects the issue, remove the core of the patch which fixes the issue&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
git checkout trunk src/java/org/apache/cassandra/db/streaming test/unit/org/apache/cassandra/io/sstable/format/big/BigTableZeroCopyWriterTest.java src/java/org/apache/cassandra/io/sstable/format/big/BigTableZeroCopyWriter.java
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17438467" author="dcapwell" created="Thu, 4 Nov 2021 03:27:06 +0000"  >&lt;p&gt;patch breaks streaming in python dtest; nice!&lt;/p&gt;</comment>
                            <comment id="17441346" author="dcapwell" created="Tue, 9 Nov 2021 20:02:16 +0000"  >&lt;p&gt;trying to debug why org.apache.cassandra.distributed.test.ring.BootstrapTest is flaky.  It seems that it times out on Cluster.close, and only happens for a single test sometimes... trying to look to see if I can get more insights into why this happens.&lt;/p&gt;</comment>
                            <comment id="17441435" author="dcapwell" created="Wed, 10 Nov 2021 00:07:59 +0000"  >&lt;p&gt;now that I don&apos;t try to hide channel close, it seems that python dtest is failing as the logs show the exception.  What is weird to me is that this happens in the happy path as well, so not sure how things were &quot;success&quot; if the session fails due to channel close... &lt;/p&gt;</comment>
                            <comment id="17444786" author="dcapwell" created="Tue, 16 Nov 2021 20:12:42 +0000"  >&lt;p&gt;I am trying to look closer at the streaming code, and I think there is a race condition&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-comment&quot;&gt;// only part of the code which sends COMPLETE
&lt;/span&gt;channel.sendControlMessage(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompleteMessage());
closeSession(State.COMPLETE);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There is a concept of a control message, which is its own channel.  This means we have 2 channels: control, data (don&apos;t know better name); we close data after sending COMPLETE on control, but there is nothing in place to make sure the followers don&apos;t see the channel closed BEFORE seeing COMPLETE...&lt;/p&gt;</comment>
                            <comment id="17444879" author="dcapwell" created="Tue, 16 Nov 2021 23:58:26 +0000"  >&lt;p&gt;cool, by trying to write CompleteMessage on the outbound channel (to avoid the race condition issue) LegacySSTableTest starts to fail with &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR [Reference-Reaper] 2021-11-16 15:55:07,656 LEAK DETECTED: a reference (org.apache.cassandra.utils.concurrent.Ref$State@637953b7) to &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;org.apache.cassandra.io.sstable.format.SSTableReader$InstanceTidier@1459220591:/Users/davidcapwell/src/github/apache/cassandra/trunk/test/data/legacy-sstables/nb/legacy_tables/legacy_nb_simple/nb-1-big was not released b
efore the reference was garbage collected
ERROR [Reference-Reaper] 2021-11-16 15:55:07,657 Allocate trace org.apache.cassandra.utils.concurrent.Ref$State@637953b7:
&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[main,5,main]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.getStackTrace(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:1559)
        at org.apache.cassandra.utils.concurrent.Ref$Debug.&amp;lt;init&amp;gt;(Ref.java:248)
        at org.apache.cassandra.utils.concurrent.Ref$State.&amp;lt;init&amp;gt;(Ref.java:178)
        at org.apache.cassandra.utils.concurrent.Ref.&amp;lt;init&amp;gt;(Ref.java:100)
        at org.apache.cassandra.io.sstable.format.SSTableReader.&amp;lt;init&amp;gt;(SSTableReader.java:679)
        at org.apache.cassandra.io.sstable.format.SSTableReader.&amp;lt;init&amp;gt;(SSTableReader.java:643)
        at org.apache.cassandra.io.sstable.format.big.BigTableReader.&amp;lt;init&amp;gt;(BigTableReader.java:57)
        at org.apache.cassandra.io.sstable.format.big.BigFormat$ReaderFactory.open(BigFormat.java:103)
        at org.apache.cassandra.io.sstable.format.SSTableReaderBuilder$ForRead.build(SSTableReaderBuilder.java:370)
        at org.apache.cassandra.io.sstable.format.SSTableReader.open(SSTableReader.java:510)
        at org.apache.cassandra.io.sstable.format.SSTableReader.open(SSTableReader.java:381)
        at org.apache.cassandra.io.sstable.format.SSTableReader.open(SSTableReader.java:376)
        at org.apache.cassandra.io.sstable.format.SSTableReader.open(SSTableReader.java:371)
        at org.apache.cassandra.io.sstable.LegacySSTableTest.streamLegacyTable(LegacySSTableTest.java:425)
        at org.apache.cassandra.io.sstable.LegacySSTableTest.streamLegacyTables(LegacySSTableTest.java:416)
        at org.apache.cassandra.io.sstable.LegacySSTableTest.testStreamLegacyCqlTables(LegacySSTableTest.java:301)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;and&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
DEBUG [main] 2021-11-16 15:55:14,453 Got exception trying to acquire sstables
org.apache.cassandra.db.repair.PendingAntiCompaction$SSTableAcquisitionException: Prepare phase failed because it encountered legacy sstables that don&apos;t support pending repair, run upgradesstables before starting incremental repairs, repair session (a4751540-4738-11ec-8f0a-09f160ae1e48)
        at org.apache.cassandra.db.repair.PendingAntiCompaction$AntiCompactionPredicate.apply(PendingAntiCompaction.java:132)
        at org.apache.cassandra.db.repair.PendingAntiCompaction$AntiCompactionPredicate.apply(PendingAntiCompaction.java:104)
        at com.google.common.base.Predicate.test(Predicate.java:79)
        at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:174)
        at java.util.Iterator.forEachRemaining(Iterator.java:116)
        at java.util.Spliterators$IteratorSpliterator.forEachRemaining(Spliterators.java:1801)
        at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:482)
        at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:472)
        at java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:708)
        at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)
        at java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:566)
        at org.apache.cassandra.db.repair.PendingAntiCompaction$AcquisitionCallable.acquireTuple(PendingAntiCompaction.java:198)
        at org.apache.cassandra.db.ColumnFamilyStore.runWithCompactionsDisabled(ColumnFamilyStore.java:2447)
        at org.apache.cassandra.db.repair.PendingAntiCompaction$AcquisitionCallable.call(PendingAntiCompaction.java:234)
        at org.apache.cassandra.io.sstable.LegacySSTableTest.testPendingAntiCompactionOldSSTables(LegacySSTableTest.java:373)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I don&apos;t grasp how this patch breaks it o_O&lt;/p&gt;</comment>
                            <comment id="17445506" author="dcapwell" created="Wed, 17 Nov 2021 22:11:33 +0000"  >&lt;p&gt;In talking with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi&quot; class=&quot;user-hover&quot; rel=&quot;djoshi&quot;&gt;djoshi&lt;/a&gt; this is the following feedback&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;from an API point of view we do not know if the FileChannel or the SocketChannel is closed; FileChannel implies race condition bug where as socket channel may be just &quot;network hates us&quot;.  Based off stack trace we know this case is network close.&lt;/li&gt;
	&lt;li&gt;when we send COMPLETE we also shutdown the channels, this doesn&apos;t give the followers enough time to consistently handle this; the feedback was to extend the state machine to have a COMPLETE_ACK (to attempt backwards compatibility, if we timeout and the channel is closed, assume the closed channel is an ACK (current behavior))&lt;/li&gt;
	&lt;li&gt;&quot;streaming doesn&apos;t support backwards compatibility&quot; - me: &quot;I have been called into prod to support repair in mixed mode... so lets try &lt;sup&gt;_&lt;/sup&gt;&quot;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17445541" author="djoshi3" created="Wed, 17 Nov 2021 23:06:51 +0000"  >&lt;p&gt;I think with the introduction of &lt;tt&gt;COMPLETE_ACK&lt;/tt&gt;, we would need to also introduce a timeout after the &lt;tt&gt;COMPLETE&lt;/tt&gt; message is transmitted but before the sender closes the Channel. This would give the receiving peer time to consume all the data and the &lt;tt&gt;COMPLETE&lt;/tt&gt; message. This would not only solve the issue but also be backward compatible as we could send &lt;tt&gt;COMPLETE_ACK&lt;/tt&gt; to peers that support the message and not to other peers.&lt;/p&gt;</comment>
                            <comment id="17445582" author="dcapwell" created="Thu, 18 Nov 2021 02:10:54 +0000"  >&lt;p&gt;Also didn&apos;t bother debugging but feel the bootstrap timeout tests (see &lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1129/workflows/43d3d109-58a5-42ac-846a-1eca0e9233ed/jobs/8175&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1129/workflows/43d3d109-58a5-42ac-846a-1eca0e9233ed/jobs/8175&lt;/a&gt;) are caused by this bug.  when the streams are in limbo jvm-dtest waits for them&lt;/p&gt;</comment>
                            <comment id="17446047" author="dcapwell" created="Thu, 18 Nov 2021 17:06:05 +0000"  >&lt;p&gt;did the POC, possible I messed everything up, but it doesn&apos;t solve anything; fails the same way...  going to do something simpler and see about just delaying close and see what happens.&lt;/p&gt;</comment>
                            <comment id="17446150" author="dcapwell" created="Thu, 18 Nov 2021 21:22:29 +0000"  >&lt;p&gt;delaying the close base off stream timeout seems to be more stable...&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=sbtourist&quot; class=&quot;user-hover&quot; rel=&quot;sbtourist&quot;&gt;sbtourist&lt;/a&gt; would love your feedback on how to deal with this.  Started down this rabbit hole trying to fix a flaky test, but do not know streaming well enough.&lt;/p&gt;</comment>
                            <comment id="17446498" author="JIRAUSER308715" created="Fri, 19 Nov 2021 13:52:23 +0000"  >&lt;p&gt;I wonder if the answer here is to instead set some state such that the ZCS code can catch the exception and check &quot;was this streaming op canceled?&quot; and if so not trigger the disk failure?&lt;/p&gt;</comment>
                            <comment id="17446587" author="dcapwell" created="Fri, 19 Nov 2021 17:12:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;ZCS code can catch the exception and check &quot;was this streaming op canceled?&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;We do this right now in the patch.   I moved the closed exception to no longer be re-thrown as a FSWriteError, this bubbles up to the top which notifies the session.onError method; I updated this method to special case this the same way EOF was special cased.  This works fine if we do not hit the COMPLETE/close race condition, if we see COMPLETE first we log a debug message, if we see close first we fail the stream.&lt;/p&gt;</comment>
                            <comment id="17454294" author="frankgh" created="Mon, 6 Dec 2021 23:53:03 +0000"  >&lt;p&gt;I took a look at this as well, and it seems that the follower keeps track of the number of &lt;tt&gt;RECEIVED&lt;/tt&gt; messages it expects and the number of received messages it has seen. Only when the follower has seen all the &lt;tt&gt;RECEIVED&lt;/tt&gt; messages it expects to see, will the follower initiate the &lt;tt&gt;COMPLETE&lt;/tt&gt; message, and close the connections.&lt;/p&gt;

&lt;p&gt;It looks like the initiator is sending back the received message before actually receiving the stream. The code sits in &lt;tt&gt;org.apache.cassandra.streaming.StreamSesssion.receive(IncomingStreamMessage)&lt;/tt&gt;. We can see that the control message is being sent and then the receiver receives the stream.&lt;/p&gt;

&lt;p&gt;A potential solution to the race is delaying the sending of the &lt;tt&gt;RECEIVED&lt;/tt&gt; message right after the stream has been consumed (maybe in the finally block of the &lt;tt&gt;receive&lt;/tt&gt; method).&lt;/p&gt;

&lt;p&gt;Unfortunately, I have not found a good way to reproduce the issue, so I don&apos;t know if that will be sufficient to resolve the race issue. Maybe if &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt; can try it, or give me some guidance on how to repro the issue, I can take a look into it further. &lt;/p&gt;</comment>
                            <comment id="17464183" author="frankgh" created="Thu, 23 Dec 2021 00:05:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi&quot; class=&quot;user-hover&quot; rel=&quot;djoshi&quot;&gt;djoshi&lt;/a&gt; and I took another look at this, it seems that the race is happening in &lt;tt&gt;org.apache.cassandra.streaming.StreamSession#maybeCompleted()&lt;/tt&gt;. &lt;/p&gt;

&lt;p&gt;The race is most likely happening in the code block below.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    channel.sendControlMessage(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompleteMessage());
    closeSession(State.COMPLETE);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The &lt;tt&gt;channel.sendControlMessage&lt;/tt&gt; call returns a future and we immediately close the session without waiting for the future to execute. In the majority of cases, the message will be delivered on time,&lt;br/&gt;
Network delays/system load/thread scheduling can cause the &lt;tt&gt;CompleteMessage&lt;/tt&gt; to be sent/received after the session has been closed triggering the &lt;tt&gt;java.nio.channels.ClosedChannelException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;A potential solution is to add a listener for the future, and only then close the session.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    Future&amp;lt;?&amp;gt; messageFuture = channel.sendControlMessage(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompleteMessage());
    messageFuture.addListener(f -&amp;gt; closeSession(State.COMPLETE));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17469511" author="dcapwell" created="Wed, 5 Jan 2022 19:36:53 +0000"  >&lt;p&gt;I like the listener way... seems clean if it works&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Future&amp;lt;?&amp;gt; messageFuture = channel.sendControlMessage(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; CompleteMessage());
messageFuture.addListener(f -&amp;gt; closeSession(State.COMPLETE));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17469513" author="dcapwell" created="Wed, 5 Jan 2022 19:40:14 +0000"  >&lt;p&gt;I can try adding the listener to my patch and run through CI to see if anything keeps failing... can keep triggering python dtests&lt;/p&gt;</comment>
                            <comment id="17469514" author="frankgh" created="Wed, 5 Jan 2022 19:42:01 +0000"  >&lt;p&gt;Great, let me know when you trigger CI. I can take a look and hopefully it solves the race condition.&lt;/p&gt;</comment>
                            <comment id="17469585" author="dcapwell" created="Wed, 5 Jan 2022 23:06:52 +0000"  >&lt;p&gt;rebased and push the change to my branch&lt;/p&gt;</comment>
                            <comment id="17469639" author="dcapwell" created="Thu, 6 Jan 2022 02:52:42 +0000"  >&lt;p&gt;heh. &lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1150/workflows/e1f0b429-c024-4b3e-8e97-07669f60996a/jobs/8438&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1150/workflows/e1f0b429-c024-4b3e-8e97-07669f60996a/jobs/8438&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;test_preview - repair_tests.preview_repair_test.TestPreviewRepair&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
test teardown failure
Unexpected error found in node logs (see stdout &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; full details). Errors: [ERROR [Stream-Deserializer-/127.0.0.1:7000-e3a2ecc2] 2022-01-06 02:26:28,485 StreamSession.java:650 - [Stream #0d9ed480-6e98-11ec-91be-5f7fa67bb742] Socket closed before session completion, peer 127.0.0.1:7000 is probably down.
java.nio.channels.ClosedChannelException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.net.AsyncStreamingInputPlus.reBuffer(AsyncStreamingInputPlus.java:136)
	at org.apache.cassandra.io.util.RebufferingInputStream.readByte(RebufferingInputStream.java:178)
	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:49)
	at org.apache.cassandra.streaming.StreamDeserializingTask.run(StreamDeserializingTask.java:59)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834), ERROR [Stream-Deserializer-/127.0.0.1:7000-e3a2ecc2] 2022-01-06 02:26:28,485 StreamSession.java:650 - [Stream #0d9ed480-6e98-11ec-91be-5f7fa67bb742] Socket closed before session completion, peer 127.0.0.1:7000 is probably down.
java.nio.channels.ClosedChannelException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
	at org.apache.cassandra.net.AsyncStreamingInputPlus.reBuffer(AsyncStreamingInputPlus.java:136)
	at org.apache.cassandra.io.util.RebufferingInputStream.readByte(RebufferingInputStream.java:178)
	at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:49)
	at org.apache.cassandra.streaming.StreamDeserializingTask.run(StreamDeserializingTask.java:59)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:834)]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;boolean&lt;/span&gt; isEofException = e &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; EOFException || e &lt;span class=&quot;code-keyword&quot;&gt;instanceof&lt;/span&gt; ClosedChannelException;
        &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (isEofException)
        {
            &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (state.finalState)
            {
                logger.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;[Stream #{}] Socket closed after session completed with state {}&quot;&lt;/span&gt;, planId(), state);

                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
            }
            &lt;span class=&quot;code-keyword&quot;&gt;else&lt;/span&gt;
            {
                logger.error(&lt;span class=&quot;code-quote&quot;&gt;&quot;[Stream #{}] Socket closed before session completion, peer {} is probably down.&quot;&lt;/span&gt;,
                             planId(),
                             peer.getHostAddressAndPort(),
                             e);

                &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; closeSession(State.FAILED);
            }
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;so closing after the write future notifies, we still see the issue.  &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi&quot; class=&quot;user-hover&quot; rel=&quot;djoshi&quot;&gt;djoshi&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankgh&quot; class=&quot;user-hover&quot; rel=&quot;frankgh&quot;&gt;frankgh&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17473141" author="dcapwell" created="Tue, 11 Jan 2022 20:07:27 +0000"  >&lt;p&gt;after looking closer with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=frankgh&quot; class=&quot;user-hover&quot; rel=&quot;frankgh&quot;&gt;frankgh&lt;/a&gt; it looks like this is a race condition issue in how we close connections, trying to figure out where.&lt;/p&gt;

&lt;p&gt;I see that adding a 10s sleep causes us to give enough time for the follower to send COMPLETE and close, and without that it some times works and some times doesn&apos;t; the fun behavior is we see COMPLETE isn&apos;t sent from the follower, yet the initiator closes the session as complete!&lt;/p&gt;</comment>
                            <comment id="17473170" author="dcapwell" created="Tue, 11 Jan 2022 20:56:57 +0000"  >&lt;p&gt;I think we finally found the issue!  When the follower sends the last msg, there is a race condition as we do the following&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
send(lastMessage);
&lt;span class=&quot;code-comment&quot;&gt;// with bad OS scheduling issues, &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; may happen AFTER the initiator closes the socket
&lt;/span&gt;closeSession(COMPLETE);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;if the OS scheduler runs the closeSession(COMPLETE) logic AFTER getting the socket close msg from initiator, then the socket will be closed and cause the ClosedChannelException, and since the state isn&apos;t final we fail the session...&lt;/p&gt;

&lt;p&gt;To fix this, moved end messages to the following pattern&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
setState(WAIT_COMPLETE);
setState(COMPLETE);
send(lastMessage);
closeSession(COMPLETE);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17475663" author="dcapwell" created="Thu, 13 Jan 2022 19:12:25 +0000"  >&lt;p&gt;Relative to trunk, it looks like CI is finally green!  &lt;/p&gt;

&lt;p&gt;Trunk: &lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1163/workflows/17e71cd2-1e9c-48db-bde4-63a290a90499&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1163/workflows/17e71cd2-1e9c-48db-bde4-63a290a90499&lt;/a&gt;&lt;br/&gt;
Patch: &lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1162/workflows/c22e4720-bbd0-4a0a-bc9b-2e99d7b0c5b6&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/1162/workflows/c22e4720-bbd0-4a0a-bc9b-2e99d7b0c5b6&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Going to do one more round of cleanup, but think ready for review&lt;/p&gt;</comment>
                            <comment id="17475722" author="frankgh" created="Thu, 13 Jan 2022 20:32:06 +0000"  >&lt;p&gt;I have a small commit for &lt;tt&gt;cassandra-dtest&lt;/tt&gt; for new expected output in the logs of one of the tests:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra-dtest/pull/172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/pull/172&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17485044" author="maedhroz" created="Tue, 1 Feb 2022 05:21:36 +0000"  >&lt;p&gt;Made a first pass at the &lt;a href=&quot;https://github.com/apache/cassandra/pull/1301&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk PR&lt;/a&gt; and left some minor comments. I still want to look at the new &lt;tt&gt;StreamCloseInMiddleTest&lt;/tt&gt; one more time though...&lt;/p&gt;</comment>
                            <comment id="17485531" author="maedhroz" created="Wed, 2 Feb 2022 00:06:17 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17486682" author="dcapwell" created="Thu, 3 Feb 2022 19:54:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi&quot; class=&quot;user-hover&quot; rel=&quot;djoshi&quot;&gt;djoshi&lt;/a&gt; approved in GH, so 2 +1s&lt;/p&gt;</comment>
                            <comment id="17486707" author="dcapwell" created="Thu, 3 Feb 2022 21:13:23 +0000"  >&lt;p&gt;Starting commit&lt;/p&gt;

&lt;p&gt;CI Results (pending):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-17116-trunk-9F17D44F-1990-4FA1-B04B-B908D0533DF7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-17116-trunk-9F17D44F-1990-4FA1-B04B-B908D0533DF7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/1398/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17486781" author="dcapwell" created="Fri, 4 Feb 2022 01:52:19 +0000"  >&lt;p&gt;Aborted commit due to change in AbstractCluster breaking a few upgrade tests.  Also found out that some upgrade tests don&apos;t actually test against trunk... so fixing...&lt;/p&gt;</comment>
                            <comment id="17486783" author="dcapwell" created="Fri, 4 Feb 2022 02:01:34 +0000"  >&lt;p&gt;pushed changes to fix the upgrade test issues&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
commit 1a43be88a433307c47521e3d890687bf784f4e1f (HEAD -&amp;gt; CASSANDRA-17116, origin/CASSANDRA-17116)
Author: David Capwell &amp;lt;dcapwell@apache.org&amp;gt;
Date:   Thu Feb 3 17:58:08 2022 -0800

    fixed it so singleUpgrade no longer takes to, as that allows us to not test against CURRENT

test/distributed/org/apache/cassandra/distributed/upgrade/MixedModeGossipTest.java
test/distributed/org/apache/cassandra/distributed/upgrade/MixedModeMessageForwardTest.java
test/distributed/org/apache/cassandra/distributed/upgrade/MixedModeReadTest.java
test/distributed/org/apache/cassandra/distributed/upgrade/MixedModeRepairTest.java
test/distributed/org/apache/cassandra/distributed/upgrade/Pre40MessageFilterTest.java
test/distributed/org/apache/cassandra/distributed/upgrade/UpgradeTestBase.java

commit 9dcdb1448284f4bd259b144a49e4b9e37408bda3
Author: David Capwell &amp;lt;dcapwell@apache.org&amp;gt;
Date:   Thu Feb 3 17:51:04 2022 -0800

    only clear delegate &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; it shutdown or &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; address changed, no other reason

test/distributed/org/apache/cassandra/distributed/impl/AbstractCluster.java
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17487191" author="dcapwell" created="Fri, 4 Feb 2022 17:25:47 +0000"  >&lt;p&gt;Starting commit&lt;/p&gt;

&lt;p&gt;CI Results (pending):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-17116-trunk-04BC233C-9090-4A35-8909-4BC19A3667EF&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-17116-trunk-04BC233C-9090-4A35-8909-4BC19A3667EF&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/1404/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="17487216" author="dcapwell" created="Fri, 4 Feb 2022 18:19:23 +0000"  >&lt;p&gt;Starting commit&lt;/p&gt;

&lt;p&gt;CI Results (pending):&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Branch&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Source&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Circle CI&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;Jenkins&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;trunk&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dcapwell/cassandra/tree/commit_remote_branch/CASSANDRA-17116-trunk-D65E87A1-597B-4BC8-A340-DA5754F5625C&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra?branch=commit_remote_branch%2FCASSANDRA-17116-trunk-D65E87A1-597B-4BC8-A340-DA5754F5625C&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-devbranch/1405/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;build&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13408953">CASSANDRA-17076</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13408974">CASSANDRA-17081</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13409179">CASSANDRA-17085</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13546417">CASSANDRA-18733</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[dcapwell]]></customfieldvalue>
        <customfieldvalue><![CDATA[frankgh]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12992" cascade-level="1"><![CDATA[Process Crash]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 40 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0we74:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
        <customfieldvalue><![CDATA[djoshi]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/0859b3c4cfa690dd270030c4bc7ff93eadf6a732&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/0859b3c4cfa690dd270030c4bc7ff93eadf6a732&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;tests added&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>