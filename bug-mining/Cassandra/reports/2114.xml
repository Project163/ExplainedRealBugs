<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:37:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5397] Updates to PerRowSecondaryIndex don&apos;t use most current values</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5397</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The way that updates to secondary indexes are performed using  SecondaryIndexManager.Updater is flawed for PerRowSecondaryIndexes.  Unlike PerColumnSecondaryIndexes, which only require the old &amp;amp; new values for a single column,  the expectation is that a PerRow indexer can be given just a key which it will use to retrieve the entire row (or as many columns as it requires) and perform its indexing on those columns.  As the indexes are updated before the memtable atomic swap occurs, a per-row indexer may only read the previous values for the row, not the new ones that are being written. In the case of an insert, there is no previous value and so nothing is added to the index.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12639634">CASSANDRA-5397</key>
            <summary>Updates to PerRowSecondaryIndex don&apos;t use most current values</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="samt">Sam Tunnicliffe</assignee>
                                    <reporter username="samt">Sam Tunnicliffe</reporter>
                        <labels>
                    </labels>
                <created>Thu, 28 Mar 2013 17:28:35 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:58 +0000</updated>
                            <resolved>Thu, 4 Apr 2013 18:24:53 +0000</resolved>
                                        <fixVersion>1.2.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13616453" author="beobal" created="Thu, 28 Mar 2013 17:30:04 +0000"  >&lt;p&gt;Patch extends the SecondaryIndexManager.Updater interface to add a commit() method.  Behaviour for PerColumn indexes remains unchanged, with updates applied to the index immediately and so the commit is a no-op. For PerRow indexes, the updates are deferred until after the memtable update occurs, then actioned via the call to commit.  I missed this in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2897&quot; title=&quot;Secondary indexes without read-before-write&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2897&quot;&gt;&lt;del&gt;CASSANDRA-2897&lt;/del&gt;&lt;/a&gt; partially because there are no implementations of PerRowSecondaryIndex in the codebase, so I&apos;ve also added a unit test with a dummy implementation.&lt;/p&gt;</comment>
                            <comment id="13618937" author="jbellis" created="Mon, 1 Apr 2013 17:15:50 +0000"  >&lt;p&gt;TBH my preferred fix here would be to make PerRowSI also do &quot;lazy updates&quot; a la &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2897&quot; title=&quot;Secondary indexes without read-before-write&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2897&quot;&gt;&lt;del&gt;CASSANDRA-2897&lt;/del&gt;&lt;/a&gt;.  Is that possible?&lt;/p&gt;</comment>
                            <comment id="13619808" author="beobal" created="Tue, 2 Apr 2013 13:56:57 +0000"  >&lt;p&gt;I don&apos;t really see how we can do that, especially as PRSI is typically implemented outside of C* and the contract we give it is expressed in the method signature &lt;tt&gt;public abstract void index(ByteBuffer rowKey);&lt;/tt&gt; So the assumption is that an update to a PRSI will be able to access the entire row at index time. &lt;/p&gt;

&lt;p&gt;Changes to AtomicSortedColumns are applied a column at a time so MixedIndexUpdater has a guard to ensure that even when a mutation changes multiple columns in the row,  the index is only updated once. Obviously though, until the last of these column updates occurs, the row is not fully updated. So I see 2 options, defer the per-row indexing until we&apos;ve finished updating the row (as in my first patch), or remove the guard and apply the per-row update as each column is updated. The second option has the benefit of not changing the SIM.Updater api, but is potentially very inefficient.&lt;/p&gt;</comment>
                            <comment id="13621283" author="jbellis" created="Wed, 3 Apr 2013 20:14:01 +0000"  >&lt;p&gt;Is this intended for 1.2 or 2.0?  I&apos;m getting lots of conflicts on both.&lt;/p&gt;</comment>
                            <comment id="13621969" author="beobal" created="Thu, 4 Apr 2013 09:34:42 +0000"  >&lt;p&gt;The patch was originally against 1.2, but it needed rebasing after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5395&quot; title=&quot;Compaction doesn&amp;#39;t remove index entries as designed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5395&quot;&gt;&lt;del&gt;CASSANDRA-5395&lt;/del&gt;&lt;/a&gt; was committed. I&apos;m attaching 2 new versions, one each for 1.2 and trunk.&lt;/p&gt;</comment>
                            <comment id="13622443" author="jbellis" created="Thu, 4 Apr 2013 15:56:54 +0000"  >&lt;p&gt;v3 against 1.2 fixes some formatting and removes the &lt;tt&gt;if (column.isMarkedForDelete()) return&lt;/tt&gt; from MIU.update, since it would re-introduce one of the problems fixed in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5395&quot; title=&quot;Compaction doesn&amp;#39;t remove index entries as designed&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5395&quot;&gt;&lt;del&gt;CASSANDRA-5395&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Not sure if it should actually be moved to the &quot;not instanceof PCSI&quot; block &amp;#8211; if so, how does PRSI remove stale entries?&lt;/p&gt;</comment>
                            <comment id="13622447" author="jbellis" created="Thu, 4 Apr 2013 15:59:13 +0000"  >&lt;p&gt;Also, remove is only called by compaction, so there will be no commit (so adding to deferred is a bad idea).&lt;/p&gt;

&lt;p&gt;If we&apos;re assuming that PRSI always keeps the index exactly up to date, remove can be a no-op.&lt;/p&gt;</comment>
                            <comment id="13622523" author="beobal" created="Thu, 4 Apr 2013 17:03:36 +0000"  >&lt;p&gt;Yes, you&apos;re right about the &lt;tt&gt;if( column.isMarkedForDelete()) return&lt;/tt&gt; being a regression.&lt;/p&gt;

&lt;p&gt;Its down to the PRSI implementation to figure out whether an update is actually an update or whether it actually calls for a delete. As the PRSI only has the key to work with &amp;amp; is going to be inspecting the whole row anyway this shouldn&apos;t be difficult, but it does make the whole SI/PCSI/PRCI hierarchy a bit ugly. &lt;/p&gt;

&lt;p&gt;Also, we do/should assume that PRSI always keeps the index exactly up to date, so I&apos;m +1 with making remove a no-op there.  &lt;/p&gt;

&lt;p&gt;attached v4 for 1.2 (v3 + the no-op remove for PRSI)&lt;/p&gt;</comment>
                            <comment id="13622618" author="jbellis" created="Thu, 4 Apr 2013 18:24:38 +0000"  >&lt;p&gt;Odd, I&apos;m seeing the following with v4:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;formite:git johnathanellis$ patch -p1 &amp;lt; ~/.JIRAClient/download/5397-1.2-v4.txt 
patching file src/java/org/apache/cassandra/db/AtomicSortedColumns.java
patching file src/java/org/apache/cassandra/db/index/SecondaryIndexManager.java
patch: **** malformed patch at line 159: diff --git a/test/unit/org/apache/cassandra/SchemaLoader.java b/test/unit/org/apache/cassandra/SchemaLoader.java
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I committed what I think is the same code based on v3, please doublecheck it.&lt;/p&gt;</comment>
                            <comment id="13622709" author="beobal" created="Thu, 4 Apr 2013 19:44:36 +0000"  >&lt;p&gt;lgtm, thanks.&lt;/p&gt;</comment>
                            <comment id="13622737" author="JIRAUSER308715" created="Thu, 4 Apr 2013 20:24:19 +0000"  >&lt;p&gt;Does this effect 1.1?  Or is it a problem with the new faster 1.2 indexes?&lt;/p&gt;</comment>
                            <comment id="13623467" author="krummas" created="Fri, 5 Apr 2013 08:57:28 +0000"  >&lt;p&gt;pushed a build fix to trunk (basically only fixed the test case): 6afbed371c0d12a15a969e4f52ba670998bab282 RowMutations do not take QueryPath in trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12576992" name="5397-1.2-v3.txt" size="13272" author="jbellis" created="Thu, 4 Apr 2013 15:56:54 +0000"/>
                            <attachment id="12577011" name="5397-1.2-v4.txt" size="14003" author="samt" created="Thu, 4 Apr 2013 17:03:54 +0000"/>
                            <attachment id="12575897" name="5397.txt" size="14090" author="samt" created="Thu, 28 Mar 2013 17:30:21 +0000"/>
                            <attachment id="12576954" name="5397_12.txt" size="13844" author="samt" created="Thu, 4 Apr 2013 09:35:06 +0000"/>
                            <attachment id="12576955" name="5397_trunk.txt" size="13781" author="samt" created="Thu, 4 Apr 2013 09:35:06 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320103</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 33 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1j8c7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>320444</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>