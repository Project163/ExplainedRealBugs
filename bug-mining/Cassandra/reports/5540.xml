<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:17:38 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-16241] ArrayClustering does not properly handle null clustering key elements left over from tables created WITH COMPACT STORAGE</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-16241</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;The only way we can produce null clustering key elements is leaving them empty on insert while a table is still compact. If we subsequently DROP COMPACT STORAGE, those null elements linger, and &lt;tt&gt;ArrayClustering&lt;/tt&gt; does not handle them appropriately on compaction. &lt;/p&gt;

&lt;p&gt;If you run the test &lt;a href=&quot;https://github.com/maedhroz/cassandra/commit/e247b7868cae383168153bbe8bbbaa47a660f76b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;, you should be able to observe an exception that looks roughly like this:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;java.lang.NullPointerException
	at java.base/java.nio.ByteBuffer.wrap(ByteBuffer.java:422)
	at org.apache.cassandra.db.AbstractArrayClusteringPrefix.getBufferArray(AbstractArrayClusteringPrefix.java:45)
	at org.apache.cassandra.io.sstable.metadata.MetadataCollector.finalizeMetadata(MetadataCollector.java:246)
	at org.apache.cassandra.io.sstable.format.SSTableWriter.finalizeMetadata(SSTableWriter.java:315)
	at org.apache.cassandra.io.sstable.format.big.BigTableWriter.access$200(BigTableWriter.java:52)
	at org.apache.cassandra.io.sstable.format.big.BigTableWriter$TransactionalProxy.doPrepare(BigTableWriter.java:415)
	at org.apache.cassandra.utils.concurrent.Transactional$AbstractTransactional.prepareToCommit(Transactional.java:168)
	at org.apache.cassandra.io.sstable.format.SSTableWriter.prepareToCommit(SSTableWriter.java:283)
	at org.apache.cassandra.io.sstable.SSTableRewriter.doPrepare(SSTableRewriter.java:380)
	at org.apache.cassandra.utils.concurrent.Transactional$AbstractTransactional.prepareToCommit(Transactional.java:168)
	at org.apache.cassandra.db.compaction.writers.CompactionAwareWriter.doPrepare(CompactionAwareWriter.java:118)
	at org.apache.cassandra.utils.concurrent.Transactional$AbstractTransactional.prepareToCommit(Transactional.java:168)
	at org.apache.cassandra.utils.concurrent.Transactional$AbstractTransactional.finish(Transactional.java:179)
	at org.apache.cassandra.db.compaction.writers.CompactionAwareWriter.finish(CompactionAwareWriter.java:128)
	at org.apache.cassandra.db.compaction.CompactionTask.runMayThrow(CompactionTask.java:225)
	at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are already numerous places where we respect the fact that clustering elements may be null, so this should be pretty straightforward to fix, and the tests that accompany it will probably be more complex than the fix itself.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13338456">CASSANDRA-16241</key>
            <summary>ArrayClustering does not properly handle null clustering key elements left over from tables created WITH COMPACT STORAGE</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maedhroz">Caleb Rackliffe</assignee>
                                    <reporter username="maedhroz">Caleb Rackliffe</reporter>
                        <labels>
                            <label>compaction</label>
                    </labels>
                <created>Mon, 2 Nov 2020 16:12:31 +0000</created>
                <updated>Mon, 21 Dec 2020 09:04:04 +0000</updated>
                            <resolved>Tue, 10 Nov 2020 20:46:14 +0000</resolved>
                                        <fixVersion>4.0-beta4</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1200">20m</timespent>
                                <comments>
                            <comment id="17224780" author="maedhroz" created="Mon, 2 Nov 2020 16:15:24 +0000"  >&lt;p&gt;I&apos;ve marked this as a &quot;degradation&quot; affecting &quot;resource management&quot; since it essentially blocks compactions, but you could consider it a &quot;correctness&quot; issue as well.&lt;/p&gt;</comment>
                            <comment id="17224836" author="maedhroz" created="Mon, 2 Nov 2020 17:50:36 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/802&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/141/workflows/07d9b042-a59c-4585-ae3e-2c48f58d8214&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Circle8&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/141/workflows/da29c5a9-4f5b-440c-b49f-bce780466862&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Circle11&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The tests look clean, except for one Java 8-only failure in &lt;tt&gt;TestMaterializedViews&lt;/tt&gt;., but that doesn&apos;t look related at all.&lt;/p&gt;</comment>
                            <comment id="17227035" author="jrwest" created="Thu, 5 Nov 2020 22:31:43 +0000"  >&lt;p&gt;+1 LGTM. Ran the test locally as well and verified it failed without the fix. Also looked at the call-sites of &lt;tt&gt;getBufferArrray&lt;/tt&gt;.&#160;&lt;/p&gt;</comment>
                            <comment id="17228377" author="yifanc" created="Mon, 9 Nov 2020 07:10:55 +0000"  >&lt;p&gt;The newly added upgrade test runs locally. It throws NPE with same trace when running w/o your patch. And the test passes with the patch. &lt;br/&gt;
However, I have to comment out setting &lt;tt&gt;cdc_raw_directory&lt;/tt&gt; and &lt;tt&gt;diagnostic_events_enabled&lt;/tt&gt; in &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/test/distributed/org/apache/cassandra/distributed/impl/InstanceConfig.java#L95-L113&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;InstanceConfig.java&lt;/a&gt; in order to start the test. &lt;br/&gt;
Please rebase and rerun the upgrade test in CI, there might be a recent change that breaks it.&lt;/p&gt;</comment>
                            <comment id="17228678" author="maedhroz" created="Mon, 9 Nov 2020 15:51:55 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yifanc&quot; class=&quot;user-hover&quot; rel=&quot;yifanc&quot;&gt;yifanc&lt;/a&gt; I&apos;ve rebased and started the JVM upgrade tests again here: &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/142/workflows/e657431c-1e91-45e8-b8f4-321f89408b5f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/maedhroz/cassandra/142/workflows/e657431c-1e91-45e8-b8f4-321f89408b5f&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17228891" author="yifanc" created="Tue, 10 Nov 2020 01:08:09 +0000"  >&lt;p&gt;Beside leaving clustering key empty on insertion, there is one other case that generates null values in clustering key. &lt;br/&gt;
When dropping the &lt;tt&gt;COMPACT STORAGE&lt;/tt&gt; from a table that has no clustering columns, a new clustering column is added to the table, and its value could be null. I modified your test to simulate that scenario, but compaction does not have a problem with it (using trunk code base). &lt;/p&gt;

&lt;p&gt;The patch makes sense to me. +1 and thanks.&lt;/p&gt;</comment>
                            <comment id="17228900" author="maedhroz" created="Tue, 10 Nov 2020 01:31:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jwest&quot; class=&quot;user-hover&quot; rel=&quot;jwest&quot;&gt;jwest&lt;/a&gt; Would you be able to commit this? (It&apos;s just trunk...)&lt;/p&gt;</comment>
                            <comment id="17229414" author="jrwest" created="Tue, 10 Nov 2020 18:12:37 +0000"  >&lt;p&gt;Spoke with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt;&#160;and we&apos;re going to wait until &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16256&quot; title=&quot;jvm dtest is strict on properties which causes upgrade tests to fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-16256&quot;&gt;&lt;del&gt;CASSANDRA-16256&lt;/del&gt;&lt;/a&gt; merges so we can get a cleaner upgrade test build.&lt;/p&gt;</comment>
                            <comment id="17229417" author="dcapwell" created="Tue, 10 Nov 2020 18:17:13 +0000"  >&lt;p&gt;pre-commit results &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-16256?focusedCommentId=17229412&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17229412&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-16256?focusedCommentId=17229412&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-17229412&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17229473" author="maedhroz" created="Tue, 10 Nov 2020 19:45:29 +0000"  >&lt;p&gt;If &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/143/workflows/ebc21a43-f3eb-4de4-aada-e7295cc27a71&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/maedhroz/cassandra/143/workflows/ebc21a43-f3eb-4de4-aada-e7295cc27a71&lt;/a&gt;&#160;looks good, we should be okay to merge...&lt;/p&gt;</comment>
                            <comment id="17229514" author="jrwest" created="Tue, 10 Nov 2020 20:46:14 +0000"  >&lt;p&gt;Committed as&#160;&lt;a href=&quot;https://github.com/apache/cassandra/commit/beee6b441c71895ca7b2833631933a6a55b516c2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/beee6b441c71895ca7b2833631933a6a55b516c2&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12995" cascade-level="1"><![CDATA[Resource Management]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0k7w8:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jwest]]></customfieldvalue>
        <customfieldvalue><![CDATA[yifanc]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348745">4.0-beta3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/beee6b441c71895ca7b2833631933a6a55b516c2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/beee6b441c71895ca7b2833631933a6a55b516c2&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;There is a new test here that reproduces the problem in a way that&apos;s basically identical to the way it occurred on an actual cluster.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>