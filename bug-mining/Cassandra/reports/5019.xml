<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:11:22 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-14389] Resolve local address binding in 4.0</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-14389</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8457&quot; title=&quot;nio MessagingService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8457&quot;&gt;&lt;del&gt;CASSANDRA-8457&lt;/del&gt;&lt;/a&gt;/&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12229&quot; title=&quot;Move streaming to non-blocking IO and netty (streaming 2.1)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12229&quot;&gt;&lt;del&gt;CASSANDRA-12229&lt;/del&gt;&lt;/a&gt; introduced a regression against &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12673&quot; title=&quot;Nodes cannot see each other in multi-DC, non-EC2 environment with two-interface nodes due to outbound node-to-node connection binding to private interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12673&quot;&gt;&lt;del&gt;CASSANDRA-12673&lt;/del&gt;&lt;/a&gt;. This was discovered with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14362&quot; title=&quot;Bind to correct local address in 4.0 streaming&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14362&quot;&gt;&lt;del&gt;CASSANDRA-14362&lt;/del&gt;&lt;/a&gt; and moved here for resolution independent of that ticket.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13152996">CASSANDRA-14389</key>
            <summary>Resolve local address binding in 4.0</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="djoshi">Dinesh Joshi</assignee>
                                    <reporter username="jasobrown">Jason Brown</reporter>
                        <labels>
                    </labels>
                <created>Tue, 17 Apr 2018 12:52:22 +0000</created>
                <updated>Fri, 15 May 2020 08:02:04 +0000</updated>
                            <resolved>Sun, 22 Apr 2018 23:38:38 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16444266" author="djoshi3" created="Thu, 19 Apr 2018 15:40:55 +0000"  >&lt;p&gt;I found the issue. When you leave the local side of the socket unbound, the kernel will prefer the IP address that matches the remote IP. Say node1 with IP &lt;tt&gt;127.0.0.1&lt;/tt&gt; wants to open a connection to node2 with IP &lt;tt&gt;127.0.0.2&lt;/tt&gt;, the socket would look like &lt;tt&gt;&amp;lt;127.0.0.2:61002, 127.0.0.2:7000&amp;gt;&lt;/tt&gt; on node1. This seems to confuse the streaming code. Here&apos;s how -&lt;/p&gt;

&lt;p&gt;Say we have three nodes node1, node2 &amp;amp; node3 with IPs &lt;tt&gt;127.0.0.1, 127.0.0.2, 127.0.0.3&lt;/tt&gt;. node1 has data and node3 is bootstrapping. It requests a stream from node1. So node3 is the `peer` in this case and node1&apos;s code execution is described below -&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;node1 receives the request (&lt;tt&gt;StreamingInboundHandler#deriveSession&lt;/tt&gt;) and &lt;tt&gt;StreamResultFuture#initReceivingSide&lt;/tt&gt; creates a new &lt;tt&gt;StreamResultFuture&lt;/tt&gt; and calls &lt;tt&gt;attachConnection()&lt;/tt&gt;. At this point it has two sets of IP &amp;amp; Ports from the peer. They are identified by the variable `&lt;tt&gt;from&lt;/tt&gt;` &amp;amp; expression `&lt;tt&gt;channel.remoteAddress()&lt;/tt&gt;` a.k.a `&lt;tt&gt;connecting&lt;/tt&gt;` ).&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;StreamResultFuture#attachConnection calls StreamCoordinator#getOrCreateSessionById&lt;/tt&gt; passing the from IP &amp;amp; &lt;tt&gt;InetAddressAndPort.getByAddressOverrideDefaults(connecting, from.port)&lt;/tt&gt; (!!!)&lt;/li&gt;
	&lt;li&gt;The key observation here is `from` is the IP that the peer sent in the `&lt;tt&gt;StreamMessageHeader&lt;/tt&gt;` while `connecting` is the remote IP of the peer.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;StreamCoordinator#getOrCreateSessionById&lt;/tt&gt; subsequently calls &lt;tt&gt;StreamCoordinator#getOrCreateHostData(peer)&lt;/tt&gt;. So we&apos;re indexing the &lt;tt&gt;peerSessions&lt;/tt&gt; by the `&lt;tt&gt;peer&lt;/tt&gt;` IP address. We also end up creating a `&lt;tt&gt;StreamSession&lt;/tt&gt;` in the process.&lt;/li&gt;
	&lt;li&gt;During `&lt;tt&gt;StreamSession&lt;/tt&gt;` creation, we end up passing the `&lt;tt&gt;peer&lt;/tt&gt;` and `&lt;tt&gt;connecting&lt;/tt&gt;` IPs. We use the `connecting` IP to establish the outbound connection to the peer. (&lt;tt&gt;NettyStreamingMessageSender&lt;/tt&gt; is now connected to `&lt;tt&gt;connecting&lt;/tt&gt;` IP on port &lt;tt&gt;7000&lt;/tt&gt;).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;In our case, since we leave the local side of the socket unbound, although the `&lt;tt&gt;peer&lt;/tt&gt;` correctly sets its IP to &lt;tt&gt;127.0.0.3&lt;/tt&gt; in the &lt;tt&gt;StreamMessageHeader&lt;/tt&gt;, the &lt;tt&gt;localAddress&lt;/tt&gt; that the kernel chooses for it is &lt;tt&gt;127.0.0.1&lt;/tt&gt;. On the inbound node1 seems to think that the `peer` is &lt;tt&gt;127.0.0.3&lt;/tt&gt; however the connecting IP address should be &lt;tt&gt;127.0.0.1&lt;/tt&gt;. Therefore, it prefers that IP when trying to establish an outbound session. In fact it establishes a connection to itself leading to the `&lt;tt&gt;Unknown peer requested: 127.0.0.1:7000&lt;/tt&gt;` exception. Note that along the way it actually drops the ephemeral port and instead uses the port returned by &lt;tt&gt;MessagingService#portFor&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Streaming code seems to rely on the perceived remote IP address of the host rather than the one that is set in the message header. I am not sure if preferring the IP address set in the header is the correct approach.&lt;/p&gt;</comment>
                            <comment id="16445297" author="djoshi3" created="Fri, 20 Apr 2018 04:52:32 +0000"  >&lt;p&gt;Here&apos;s a fix along with restoring the behavior from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12673&quot; title=&quot;Nodes cannot see each other in multi-DC, non-EC2 environment with two-interface nodes due to outbound node-to-node connection binding to private interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12673&quot;&gt;&lt;del&gt;CASSANDRA-12673&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/dineshjoshi/cassandra/tree/CASSANDRA-14389-trunk-fix-streaming&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/dineshjoshi/workflows/cassandra/tree/CASSANDRA-14389-trunk-fix-streaming&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests &amp;amp; dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16446288" author="jasobrown" created="Fri, 20 Apr 2018 20:02:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi3&quot; class=&quot;user-hover&quot; rel=&quot;djoshi3&quot;&gt;djoshi3&lt;/a&gt;, This looks pretty good. However, I wonder if we can dump all the places where we naively plumb the &apos;connecting&apos; address though. I took a pass at it here:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;14389&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/14389&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jasobrown/workflows/cassandra/tree/14389&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests &amp;amp; dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;The only change of interest is in &lt;tt&gt;MessagingService#getPreferredRemoteAddr()&lt;/tt&gt;, I check into &lt;tt&gt;SystemKeyspace.getPreferredIP(to)&lt;/tt&gt; if there was no &lt;tt&gt;OutboundMessagingPool&lt;/tt&gt; set up in {[MessagingService#channelManagers}}. wdyt?&lt;/p&gt;</comment>
                            <comment id="16446396" author="djoshi3" created="Fri, 20 Apr 2018 21:43:05 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt;, thank you for reviewing. I have incorporated your changes. I also added a test for &lt;tt&gt;StreamSession&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16446553" author="djoshi3" created="Sat, 21 Apr 2018 00:55:06 +0000"  >&lt;p&gt;I have incorporated the changes from your commit as well as added tests for &lt;tt&gt;MessagingService#getPreferredRemoteAddr&lt;/tt&gt;. Also squashed all commit into one.&lt;/p&gt;</comment>
                            <comment id="16446874" author="jasobrown" created="Sat, 21 Apr 2018 16:13:10 +0000"  >&lt;p&gt;I didn&apos;t understand the &lt;tt&gt;NettyStreamingMessageSenderFactory&lt;/tt&gt; and subclassing of &lt;tt&gt;NettyStreamingMessageSender&lt;/tt&gt; in the &lt;tt&gt;StreamSessionTest&lt;/tt&gt;. You weren&apos;t really taking any advantage of the subclass as all &lt;tt&gt;NSMSStub&lt;/tt&gt; did was override the parent&apos;s constructor, only to call the parent&apos;s constructor. Thus I&apos;ve removed &lt;tt&gt;NettyStreamingMessageSenderFactory&lt;/tt&gt; (ignore the comment on the commit) and cleaned up the test. I&apos;ve pushed up a commit to my branch, on top of your squash, and ran the testa again. If you are good with that, I&apos;m +1 on the rest of the patch.&lt;/p&gt;</comment>
                            <comment id="16447020" author="djoshi3" created="Sat, 21 Apr 2018 21:56:48 +0000"  >&lt;p&gt;Yes that looks good. I was fiddling with different ways of writing the test and the constructor that I introduced in &lt;tt&gt;StreamSession&lt;/tt&gt; made the factory redundant. Thank you for taking care of it.&lt;/p&gt;</comment>
                            <comment id="16447414" author="jasobrown" created="Sun, 22 Apr 2018 23:38:38 +0000"  >&lt;p&gt;committed as sha &lt;tt&gt;63945228fc0fabea2cfcf1f1b4d0a29ed3964107&lt;/tt&gt;. Thanks!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[djoshi]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            7 years, 30 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3sn9j:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jasobrown</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>