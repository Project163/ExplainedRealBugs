<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:07:44 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13120] Trace and Histogram output misleading</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13120</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;If we look at the following output:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[centos@cassandra-c-3]$ nodetool getsstables -- keyspace table 60ea4399-6b9f-4419-9ccb-ff2e6742de10
/mnt/cassandra/data/data/keyspace/table-62f30431acf411e69a4ed7dd11246f8a/mc-647146-big-Data.db
/mnt/cassandra/data/data/keyspace/table-62f30431acf411e69a4ed7dd11246f8a/mc-647147-big-Data.db
/mnt/cassandra/data/data/keyspace/table-62f30431acf411e69a4ed7dd11246f8a/mc-647145-big-Data.db
/mnt/cassandra/data/data/keyspace/table-62f30431acf411e69a4ed7dd11246f8a/mc-647152-big-Data.db
/mnt/cassandra/data/data/keyspace/table-62f30431acf411e69a4ed7dd11246f8a/mc-647157-big-Data.db
/mnt/cassandra/data/data/keyspace/table-62f30431acf411e69a4ed7dd11246f8a/mc-648137-big-Data.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We can see that this key value appears in just 6 sstables.  However, when we run a select against the table and key we get:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Tracing session: a6c81330-d670-11e6-b00b-c1d403fd6e84

 activity                                                                                                          | timestamp                  | source         | source_elapsed
-------------------------------------------------------------------------------------------------------------------+----------------------------+----------------+----------------
                                                                                                Execute CQL3 query | 2017-01-09 13:36:40.419000 | 10.200.254.141 |              0
 Parsing SELECT * FROM keyspace.table WHERE id = 60ea4399-6b9f-4419-9ccb-ff2e6742de10; [SharedPool-Worker-2]       | 2017-01-09 13:36:40.419000 | 10.200.254.141 |            104
                                                                         Preparing statement [SharedPool-Worker-2] | 2017-01-09 13:36:40.419000 | 10.200.254.141 |            220
                                        Executing single-partition query on table [SharedPool-Worker-1]            | 2017-01-09 13:36:40.419000 | 10.200.254.141 |            450
                                                                Acquiring sstable references [SharedPool-Worker-1] | 2017-01-09 13:36:40.419000 | 10.200.254.141 |            477
                                                 Bloom filter allows skipping sstable 648146 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419000 | 10.200.254.141 |            496
                                                 Bloom filter allows skipping sstable 648145 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419001 | 10.200.254.141 |            503
                                                            Key cache hit for sstable 648140 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419001 | 10.200.254.141 |            513
                                                 Bloom filter allows skipping sstable 648135 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419001 | 10.200.254.141 |            520
                                                 Bloom filter allows skipping sstable 648130 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419001 | 10.200.254.141 |            526
                                                 Bloom filter allows skipping sstable 648048 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419001 | 10.200.254.141 |            530
                                                 Bloom filter allows skipping sstable 647749 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419001 | 10.200.254.141 |            535
                                                 Bloom filter allows skipping sstable 647404 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419001 | 10.200.254.141 |            540
                                                            Key cache hit for sstable 647145 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419001 | 10.200.254.141 |            548
                                                            Key cache hit for sstable 647146 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419001 | 10.200.254.141 |            556
                                                            Key cache hit for sstable 647147 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419002 | 10.200.254.141 |            564
                                                 Bloom filter allows skipping sstable 647148 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419002 | 10.200.254.141 |            570
                                                 Bloom filter allows skipping sstable 647149 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419002 | 10.200.254.141 |            575
                                                 Bloom filter allows skipping sstable 647150 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419002 | 10.200.254.141 |            580
                                                 Bloom filter allows skipping sstable 647151 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419002 | 10.200.254.141 |            585
                                                            Key cache hit for sstable 647152 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419002 | 10.200.254.141 |            591
                                                 Bloom filter allows skipping sstable 647153 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419002 | 10.200.254.141 |            597
                                                 Bloom filter allows skipping sstable 647154 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419002 | 10.200.254.141 |            601
                                                 Bloom filter allows skipping sstable 647155 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419002 | 10.200.254.141 |            606
                                                 Bloom filter allows skipping sstable 647156 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419002 | 10.200.254.141 |            611
                                                            Key cache hit for sstable 647157 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419002 | 10.200.254.141 |            617
                                                 Bloom filter allows skipping sstable 647158 [SharedPool-Worker-1] | 2017-01-09 13:36:40.419003 | 10.200.254.141 |            623
                  Skipped 0/22 non-slice-intersecting sstables, included 0 due to tombstones [SharedPool-Worker-1] | 2017-01-09 13:36:40.419003 | 10.200.254.141 |            644
                                                 Merging data from memtables and 22 sstables [SharedPool-Worker-1] | 2017-01-09 13:36:40.419003 | 10.200.254.141 |            654
                                                           Read 9 live and 0 tombstone cells [SharedPool-Worker-1] | 2017-01-09 13:36:40.419003 | 10.200.254.141 |            732
                                                                                                  Request complete | 2017-01-09 13:36:40.419808 | 10.200.254.141 |            808
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;You&apos;ll note we claim not to have skipped any files due to bloom filters - even though we know the data is only in 6 files.&lt;/p&gt;

&lt;p&gt;CFHistograms also report that we&apos;re hitting every sstables:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;Percentile SSTables Write Latency Read Latency Partition Size Cell Count 
(micros) (micros) (bytes) 
50% 24.00 14.24 182.79 103 1 
75% 24.00 17.08 315.85 149 2 
95% 24.00 20.50 7007.51 372 7 
98% 24.00 24.60 10090.81 642 12 
99% 24.00 29.52 12108.97 770 14 
Min 21.00 3.31 29.52 43 0 
Max 29.00 1358.10 62479.63 1597 35
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Code for the read is here:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/SinglePartitionReadCommand.java#L561&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-3.0/src/java/org/apache/cassandra/db/SinglePartitionReadCommand.java#L561&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;We seem to iterate over all the sstables and increment the metric as part of that iteration.&lt;/p&gt;

&lt;p&gt;Either the reporting is incorrect - or we should maybe check the bloom filters first and then iterate the tombstones after?  &lt;/p&gt;

&lt;p&gt;In this particular case we were using TWCS which makes the problem more apparent.  TWCS guarantees that we&apos;ll keep more sstables in an un-merged state.  With STCS we have to search them all, but most of them should be merged together if Compaction is keeping up.  LCS the read path is restricted which will disguise the impact.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13034648">CASSANDRA-13120</key>
            <summary>Trace and Histogram output misleading</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="ahattrell">Adam Hattrell</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Jan 2017 13:41:38 +0000</created>
                <updated>Fri, 15 May 2020 08:00:31 +0000</updated>
                            <resolved>Thu, 1 Jun 2017 08:26:09 +0000</resolved>
                                        <fixVersion>3.0.14</fixVersion>
                    <fixVersion>3.11.0</fixVersion>
                    <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Core</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>11</watches>
                                                                                                                <comments>
                            <comment id="15839613" author="nbozicns" created="Thu, 26 Jan 2017 11:58:03 +0000"  >&lt;p&gt;I wanted to share some more details from digging and testing. First thing that I tried is LCS on clean node, to rule out TWCS as a problem. After some data loaded via &lt;b&gt;cassandra-stress&lt;/b&gt; and some manually I managed to have same behavior.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;getsstables&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;vagrant@cassandra:/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/rts/lcs_test-2be45680e3b111e6b03e5fb4fc6cee63$ nodetool getsstables rts lcs_test 1eea2a12-e3ad-11e6-bf01-fe55135034f3;
/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/rts/lcs_test-2be45680e3b111e6b03e5fb4fc6cee63/mb-993-big-Data.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So UUID is in single SSTable. Than I went to &lt;b&gt;cqlsh&lt;/b&gt; and tried tracing and select and here is outcome:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;tracing&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;cqlsh&amp;gt; SELECT * FROM rts.lcs_test WHERE id = 1eea2a12-e3ad-11e6-bf01-fe55135034f3;

 id                                   | tp_id | ex_uuid
--------------------------------------+-------+----------
 1eea2a12-e3ad-11e6-bf01-fe55135034f3 |     3 | asddddad

(1 rows)

Tracing session: aad45de0-e3bc-11e6-8de0-89a4196d20ae

 activity                                                                                                  | timestamp                  | source        | source_elapsed
-----------------------------------------------------------------------------------------------------------+----------------------------+---------------+----------------
                                                                                        Execute CQL3 query | 2017-01-26 11:43:34.078000 | 192.168.34.20 |              0
 Parsing SELECT * FROM rts.lcs_test WHERE id = 1eea2a12-e3ad-11e6-bf01-fe55135034f3; [SharedPool-Worker-1] | 2017-01-26 11:43:34.078000 | 192.168.34.20 |            199
                                                                 Preparing statement [SharedPool-Worker-1] | 2017-01-26 11:43:34.079000 | 192.168.34.20 |            361
                                        Executing single-partition query on lcs_test [SharedPool-Worker-2] | 2017-01-26 11:43:34.079000 | 192.168.34.20 |            660
                                                        Acquiring sstable references [SharedPool-Worker-2] | 2017-01-26 11:43:34.079000 | 192.168.34.20 |            684
                                           Bloom filter allows skipping sstable 1406 [SharedPool-Worker-2] | 2017-01-26 11:43:34.079000 | 192.168.34.20 |            732
                                                       Key cache hit &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; sstable 993 [SharedPool-Worker-2] | 2017-01-26 11:43:34.079000 | 192.168.34.20 |            755
           Skipped 0/2 non-slice-intersecting sstables, included 0 due to tombstones [SharedPool-Worker-2] | 2017-01-26 11:43:34.079000 | 192.168.34.20 |            771
                                          Merging data from memtables and 2 sstables [SharedPool-Worker-2] | 2017-01-26 11:43:34.079001 | 192.168.34.20 |            785
                                                   Read 1 live and 0 tombstone cells [SharedPool-Worker-2] | 2017-01-26 11:43:34.079001 | 192.168.34.20 |            849
                                                                                          Request complete | 2017-01-26 11:43:34.082327 | 192.168.34.20 |           4327

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So again 2 sstables are merged while bloom filter says one can be skipped.&lt;/p&gt;

&lt;p&gt;Next think that I checked is access time of files in linux system with &lt;b&gt;ls -l --time=atime&lt;/b&gt; command:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-style: solid;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;border-bottom-style: solid;&quot;&gt;&lt;b&gt;accesstime&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;vagrant@cassandra:/&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/rts/lcs_test-2be45680e3b111e6b03e5fb4fc6cee63$ ls -l --time=atime mb-993-big-*
-rw-r--r-- 1 cassandra cassandra      76 Jan 26 11:42 mb-993-big-CRC.db
-rw-r--r-- 1 cassandra cassandra 1048687 Jan 26 11:42 mb-993-big-Data.db
-rw-r--r-- 1 cassandra cassandra       9 Jan 26 11:42 mb-993-big-Digest.crc32
-rw-r--r-- 1 cassandra cassandra    5744 Jan 26 11:42 mb-993-big-Filter.db
-rw-r--r-- 1 cassandra cassandra  100769 Jan 26 11:42 mb-993-big-Index.db
-rw-r--r-- 1 cassandra cassandra   17703 Jan 26 11:42 mb-993-big-Statistics.db
-rw-r--r-- 1 cassandra cassandra    1072 Jan 26 11:42 mb-993-big-Summary.db
-rw-r--r-- 1 cassandra cassandra      80 Jan 26 11:42 mb-993-big-TOC.txt
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This timestamp of 11:42 is not changing when I do select on CQLSH and it is timestamp when Cassandra probably read file first time and placed it in memory. This actually proves that Cassandra is not accessing SSTables each time query is done, it is using memory so probably logging is misleading in this case. I would expect if bloom filter allowed skipping of some sstable to log &quot;Merging data from memtables and 1 sstables&quot; instead of 2.&lt;/p&gt;

&lt;p&gt;Why &lt;a href=&quot;https://github.com/apache/cassandra/blob/554d6beb0920cba9bcc0124fa9f33c580012b761/src/java/org/apache/cassandra/db/SinglePartitionReadCommand.java#L509&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this line in SinglePartitionReadCommand&lt;/a&gt; returns 2 sstables when it applies PK filter instead of 1?&lt;/p&gt;</comment>
                            <comment id="15855711" author="blerer" created="Tue, 7 Feb 2017 10:35:13 +0000"  >&lt;p&gt;The trace and histogram output are effectively wrong. The problem is caused by the fact that the code within &lt;tt&gt;SinglePartitionReadCommand&lt;/tt&gt; is not aware of which SSTables are skipped due to the Bloom filters.&lt;br/&gt;
I will try to find a way to correct that problem.&lt;/p&gt;</comment>
                            <comment id="15855844" author="nbozicns" created="Tue, 7 Feb 2017 12:02:03 +0000"  >&lt;p&gt;Basically counter is incremented (&lt;em&gt;sstablesIterated&lt;/em&gt;) on each loop no matter if Bloom Filter says it should be skipped or not. I was waiting for someone to check if that is intended or not.&lt;/p&gt;

&lt;p&gt;I have suggestion how we can fix that (I can create a patch as well). Out of all sstables candidates for a file, only sstables which return non null from &lt;a href=&quot;https://github.com/apache/cassandra/blob/af3fe39dcabd9ef77a00309ce6741268423206df/src/java/org/apache/cassandra/io/sstable/format/big/BigTableReader.java&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;BigTableReader&lt;/a&gt; will add up to result. Read path and this code is executed from &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-3.0.10/src/java/org/apache/cassandra/db/SinglePartitionReadCommand.java#L584&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this line&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We can introduce counter &lt;em&gt;sstablesWithData&lt;/em&gt; if &lt;em&gt;sstablesIterated&lt;/em&gt; is used somewhere else, and increment &lt;em&gt;sstablesWithData&lt;/em&gt; only when &lt;em&gt;iter&lt;/em&gt; has non-null result returned from BigTableReader.&lt;/p&gt;

&lt;p&gt;What do you think? That would give correct number of sstables based on read path including Bloom Filter.&lt;/p&gt;


</comment>
                            <comment id="15855904" author="blerer" created="Tue, 7 Feb 2017 12:36:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;Out of all sstables candidates for a file, only sstables which return non null from BigTableReader will add up to result.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I would prefer to not use that approach as it could break quite easily without anybody noticing. If somebody was replacing the reader by an &lt;tt&gt;Optional&amp;lt;BigTableReader&amp;gt;&lt;/tt&gt; for example.&lt;br/&gt;
To be honest, I am not sure yet how to fix it in the best way which is why I want to think a bit about it.&lt;/p&gt;</comment>
                            <comment id="16002381" author="blerer" created="Tue, 9 May 2017 09:41:23 +0000"  >&lt;p&gt;I pushed a patch to solve the problem &lt;a href=&quot;https://github.com/blerer/cassandra/tree/13120-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. The problem does not affect the &lt;tt&gt;3.11&lt;/tt&gt; branch.&lt;/p&gt;

&lt;p&gt;The patch passed CI without problems.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=nbozicns&quot; class=&quot;user-hover&quot; rel=&quot;nbozicns&quot;&gt;nbozicns&lt;/a&gt; I ended up relying on checking the &lt;tt&gt;RowIndexEntry&lt;/tt&gt; value. I do not like this approach much but as it is properly fixed in &lt;tt&gt;3.11&lt;/tt&gt; I think it is acceptable.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; Could you review?&lt;/p&gt;</comment>
                            <comment id="16003863" author="stefania" created="Wed, 10 May 2017 01:06:41 +0000"  >&lt;p&gt;The 3.0 patch LGTM, as you said it&apos;s not the cleanest, but it is safe and a good choice for 3.0.&lt;/p&gt;

&lt;p&gt;I am not quite sure why you think this is &lt;em&gt;properly fixed in 3.11&lt;/em&gt;? &lt;tt&gt;UnfilteredRowIteratorWithLowerBound&lt;/tt&gt; relies on cached RIEs only when we cannot use the metadata bounds and by then the iterator is initialized, it could return a lower bound from metadata which is before the key and in this case the iterator would be initialized. Even when the lower bound is null, merge iterator will initialize the iterator by calling &lt;tt&gt;hasNext&lt;/tt&gt;. Iterator initialized means that sstables iterated is incremented (&lt;tt&gt;SPRC.withSSTablesIterated&lt;/tt&gt;). Besides, &lt;tt&gt;SPRC.queryMemtableAndSSTablesInTimestampOrder&lt;/tt&gt; doesn&apos;t use this iterator at all. I don&apos;t see any other check on the BF in 3.11 so is it just that it cannot be reproduced and or am I missing something?&lt;/p&gt;</comment>
                            <comment id="16004829" author="blerer" created="Wed, 10 May 2017 15:08:47 +0000"  >&lt;p&gt;Sorry, my mistake. I did not checked the code correctly. I will make a new patch for 3.11&lt;/p&gt;</comment>
                            <comment id="16017213" author="blerer" created="Fri, 19 May 2017 10:35:09 +0000"  >&lt;p&gt;Right now, what &lt;tt&gt;CFHistograms&lt;/tt&gt; expose is the number of SSTables on which we do a partition lookup.&lt;br/&gt;
The partition look up can lead to skipping the SSTable (BF, min max, partition index lookup or index entry not found) or not.&lt;br/&gt;
Nevertheless, partition lookups are not cheap. Especially when an index lookup has to be done. Due to that, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; suggested to me, in an offline discussion, to keep the metric as it is and to add a new one &lt;tt&gt;mergedSSTable&lt;/tt&gt; to track how many SSTables have been actually merged.&lt;/p&gt;

&lt;p&gt;The number of actually merged SSTables should also be the one used for the &lt;tt&gt;Trace&lt;/tt&gt; message and for determining if the &lt;tt&gt;SSTables&lt;/tt&gt; must be compacted.&lt;/p&gt;</comment>
                            <comment id="16019058" author="stefania" created="Mon, 22 May 2017 00:59:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;Right now, what CFHistograms expose is the number of SSTables on which we do a partition lookup.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Except it has never been documented, as far as I can see neither the &lt;a href=&quot;http://cassandra.apache.org/doc/latest/tools/nodetool/tablehistograms.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;ASF docs&lt;/a&gt; nor the &lt;a href=&quot;http://docs.datastax.com/en/cassandra/3.0/cassandra/tools/toolsTablehisto.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;DS docs&lt;/a&gt; say what the number of sstables actually is  and &lt;a href=&quot;https://www.smartcat.io/blog/2017/where-is-my-data-debugging-sstables-in-cassandra/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;people&lt;/a&gt; tend to think this is the number of sstables it touches on each read, so it is very misleading. Our own comment says &lt;tt&gt;/** Histogram of the number of sstable data files accessed per read */&lt;/tt&gt;, which to me would indicate that if the BF excludes a table then it should not be counted. We should at a minimum improve our own comments.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;keep the metric as it is and to add a new one mergedSSTable to track how many SSTables have been actually merged.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Are we thinking of a new metrics histogram? I&apos;m not opposed, as long as we document &lt;tt&gt;nodetool [cf|table]histograms&lt;/tt&gt; accordingly. My only concern is that adding a new histogram on each read may have a performance impact - but I do understand if we don&apos;t want to change the existing behavior, especially in 3.0.&lt;/p&gt;
</comment>
                            <comment id="16019177" author="stefania" created="Mon, 22 May 2017 06:09:05 +0000"  >&lt;p&gt;Just to clarify what the current metric excludes: sstables that are not live, not selected by the view interval tree (which relies on the first and last partition key in the sstable), not selected by the filters (which rely on the clustering min and max values) unless they may have tombstones, not selected because of a max timestamp older than the latest tombstone. Basically anything not selected by &lt;tt&gt;queryMemtableAndDisk&lt;/tt&gt;. Also, for 3.11+, sstables that were not accessed because the query was already satisfied (&lt;tt&gt;UnfilteredRowIteratorWithLowerBound&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;However, sstables that are discarded by &lt;tt&gt;SSTableReader.getPosition()&lt;/tt&gt;, so BF, min and max keys (again) and partition not found in the sstable (BF false positive) end up in the current metric. The partition lookup in the index is the only expensive part, the first two are not.&lt;/p&gt;

&lt;p&gt;IMO the current metric is not at all consistent, so OK for two metrics if we must, but let&apos;s clarify the boundaries in a way meaningful to the users, not dependent on how we organized the code.&lt;/p&gt;</comment>
                            <comment id="16019181" author="jjirsa" created="Mon, 22 May 2017 06:18:43 +0000"  >&lt;p&gt;What did the 2.x metric include/exclude? Did we diverge with 8099, or has it always been like this?&lt;/p&gt;</comment>
                            <comment id="16019189" author="stefania" created="Mon, 22 May 2017 06:32:12 +0000"  >&lt;blockquote&gt;&lt;p&gt;What did the 2.x metric include/exclude? Did we diverge with 8099, or has it always been like this?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;From a very quick look, the 2.x code looks similar to 3.x, so I think it has always been like this. The entry point is &lt;tt&gt;CFS.getTopLevelColumns()&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16019395" author="blerer" created="Mon, 22 May 2017 10:01:58 +0000"  >&lt;p&gt;We double checked the &lt;tt&gt;2.2&lt;/tt&gt; code with &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; and the behavior was actually changed by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8099&quot; title=&quot;Refactor and modernize the storage engine&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8099&quot;&gt;&lt;del&gt;CASSANDRA-8099&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;After some discussion, we agreed that it is probably best to fix the metric and leave the addition of a new metric to a followup ticket (if people feel the need for a new metric).&lt;/p&gt;

&lt;p&gt;Regarding, &lt;tt&gt;SSTableReader:readCount&lt;/tt&gt; as it is used by &lt;tt&gt;SizedTierd&lt;/tt&gt; compaction to determine the SSTable hotness, it makes sense to also take into account parition range queries.   &lt;/p&gt;</comment>
                            <comment id="16019402" author="stefania" created="Mon, 22 May 2017 10:09:23 +0000"  >&lt;p&gt;To clarify further, the code before 8099 did not increment the number of sstables iterated if the sstable iterator had a &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-2.2/src/java/org/apache/cassandra/db/CollationController.java#L131&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;null column family&lt;/a&gt;, which is the equivalent of &lt;tt&gt;SSTableReader.getPosition()&lt;/tt&gt; returning null. Therefore, sstables excluded by the BF or a failed partition lookup were not considered. This patch will restore this behavior.&lt;/p&gt;</comment>
                            <comment id="16022545" author="blerer" created="Wed, 24 May 2017 08:40:43 +0000"  >&lt;p&gt;I made an initial patch for 3.11 &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:13120-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.&lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; could you check the patch and tell me if you are fine with it before I rewrite it for &lt;tt&gt;3.0&lt;/tt&gt; and &lt;tt&gt;trunk&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="16025735" author="stefania" created="Fri, 26 May 2017 03:01:28 +0000"  >&lt;p&gt;The approach looks good. &lt;/p&gt;

&lt;p&gt;Some nits &lt;a href=&quot;https://github.com/stef1927/cassandra/commit/4ff0ccf5e290749b60204509b7d4b7d5d469de59&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. &lt;/p&gt;

&lt;p&gt;I have two suggestions:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;Pass a boolean or a new enum to the &lt;tt&gt;SSTableReadMetricsCollector&lt;/tt&gt; constructor that indicates the query type (single or range). This way we know for sure if we need to increment &lt;tt&gt;mergedSSTables&lt;/tt&gt;. At the moment we rely on knowing which methods get called where, which is a bit brittle.&lt;/li&gt;
&lt;/ul&gt;


&lt;ul&gt;
	&lt;li&gt;Make the listener symmetric w.r.t. sstables skipped and selected. At the moment we have &lt;tt&gt;skippingSSTable&lt;/tt&gt; with a reason to indicate that an sstable was skipped and different methods to indicate that an sstable was selected. I would personally prefer to only have two methods, something like &lt;tt&gt;onSSTableSkipped&lt;/tt&gt; and &lt;tt&gt;onSSTableSelected&lt;/tt&gt;, with two parameters: the sstable and the reason. The reason enums should probably be two distinct enums. We loose the RIE parameter but it is not really used at the moment. WDYT?&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Regarding the unit tests:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The javadoc of &lt;tt&gt;SSTablesIteratedTest&lt;/tt&gt; needs updating, since it is no longer only limited to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8180&quot; title=&quot;Optimize disk seek using min/max column name meta data when the LIMIT clause is used&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8180&quot;&gt;&lt;del&gt;CASSANDRA-8180&lt;/del&gt;&lt;/a&gt;.&lt;/li&gt;
	&lt;li&gt;I&apos;m not sure the new test covers &lt;tt&gt;queryMemtableAndSSTablesInTimestampOrder()&lt;/tt&gt;.&lt;/li&gt;
	&lt;li&gt;It may be useful to also have a range query with the test checking that the metric is not updated and with a comment explaining why that it the case.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16031404" author="blerer" created="Wed, 31 May 2017 15:54:17 +0000"  >&lt;p&gt;I took the feedbacks into account and made some new patches for &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...blerer:13120-3.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.0&lt;/a&gt;, &lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.11...blerer:13120-3.11&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;3.11&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...blerer:13120-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;trunk&lt;/a&gt;. I ran the patch on our internal CI. There are not failures for the unit tests and the failing dtests are not related to the change.   &lt;/p&gt;</comment>
                            <comment id="16032383" author="stefania" created="Thu, 1 Jun 2017 03:36:46 +0000"  >&lt;p&gt;+1, latest approach looks pretty good, great job!&lt;/p&gt;</comment>
                            <comment id="16032632" author="blerer" created="Thu, 1 Jun 2017 08:25:01 +0000"  >&lt;p&gt;Thanks for the review &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16032634" author="blerer" created="Thu, 1 Jun 2017 08:26:09 +0000"  >&lt;p&gt;Committed into 3.0 at e22cb278b63a6ee5f03c7213071d07fd3b198659 and merged into 3.11 and trunk&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 24 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i38ny7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12337349">3.0.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>stefania</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[stefania]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>