<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6465] DES scores fluctuate too much for cache pinning</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6465</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;To quote the conf:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;# if set greater than zero and read_repair_chance is &amp;lt; 1.0, this will allow
# &apos;pinning&apos; of replicas to hosts in order to increase cache capacity.
# The badness threshold will control how much worse the pinned host has to be
# before the dynamic snitch will prefer other replicas over it.  This is
# expressed as a double which represents a percentage.  Thus, a value of
# 0.2 means Cassandra would continue to prefer the static snitch values
# until the pinned host was 20% worse than the fastest.
dynamic_snitch_badness_threshold: 0.1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;An assumption of this feature is that scores will vary by less than dynamic_snitch_badness_threshold during normal operations.  Attached is the result of polling a node for the scores of 6 different endpoints at 1 Hz for 15 minutes.  The endpoints to sample were chosen with `nodetool getendpoints` for row that is known to get reads.  The node was acting as a coordinator for a few hundred req/second, so it should have sufficient data to work with.  Other traces on a second cluster have produced similar results.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The scores vary by far more than I would expect, as show by the difficulty of seeing anything useful in that graph.&lt;/li&gt;
	&lt;li&gt;The difference between the best and next-best score is usually &amp;gt; 10% (default dynamic_snitch_badness_threshold).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Neither ClientRequest nor ColumFamily metrics showed wild changes during the data gathering period.&lt;/p&gt;

&lt;p&gt;Attachments:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;jython script cobbled together to gather the data (based on work on the mailing list from Maki Watanabe a while back)&lt;/li&gt;
	&lt;li&gt;csv of DES scores for 6 endpoints, polled about once a second&lt;/li&gt;
	&lt;li&gt;Attempt at making a graph&lt;/li&gt;
&lt;/ul&gt;

</description>
                <environment>&lt;p&gt;1.2.11, 2 DC cluster&lt;/p&gt;</environment>
        <key id="12683652">CASSANDRA-6465</key>
            <summary>DES scores fluctuate too much for cache pinning</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="thobbs">Tom Hobbs</assignee>
                                    <reporter username="cburroughs">Chris Burroughs</reporter>
                        <labels>
                            <label>gossip</label>
                    </labels>
                <created>Mon, 9 Dec 2013 18:23:02 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:58 +0000</updated>
                            <resolved>Tue, 14 Jan 2014 21:18:45 +0000</resolved>
                                        <fixVersion>2.0.5</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="13849949" author="rcoli" created="Tue, 17 Dec 2013 00:51:52 +0000"  >&lt;p&gt;Are we sure that this mechanism of producing cache pinning is worth the complexity here, especially given speculative execution? &lt;/p&gt;</comment>
                            <comment id="13861012" author="thobbs" created="Fri, 3 Jan 2014 00:34:12 +0000"  >&lt;p&gt;I can reproduce Chris&apos;s results, and in my experimentation it looks like almost all of the variation is due to the &quot;timePenalty&quot;, which is basically how long it has been since the last entry from an endpoint.  I can see why something like the time penalty might be useful for the phi FD, which expects messages on a periodic basis, but it doesn&apos;t make sense to me to use it in a load balancing measure.  My suggestion would be to remove the time penalty.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Are we sure that this mechanism of producing cache pinning is worth the complexity here, especially given speculative execution?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Effective cache utilization is extremely important, so I would say it&apos;s well worth the additional complexity.  I don&apos;t think speculative execution should affect this greatly, but I might be missing something; care to expand on that?&lt;/p&gt;</comment>
                            <comment id="13861081" author="jbellis" created="Fri, 3 Jan 2014 01:34:58 +0000"  >&lt;p&gt;This was introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3722&quot; title=&quot;Send Hints to Dynamic Snitch when Compaction or repair is going on for a node.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3722&quot;&gt;&lt;del&gt;CASSANDRA-3722&lt;/del&gt;&lt;/a&gt;.  It&apos;s not clear to me what that code is trying to do.  Or maybe I&apos;m still grumpy about calling i/o activity &quot;severity.&quot;&lt;/p&gt;</comment>
                            <comment id="13863309" author="ianbarfield" created="Mon, 6 Jan 2014 19:36:15 +0000"  >&lt;p&gt;I believe the purpose of time penalty was to more quickly detect problematic nodes. If a node was suddenly suffering severe issues, that wouldn&apos;t be reflected in its latency metric until the current outstanding queries resolved. That might take until the maximum duration timeout which can be arbitrarily long, and in many cases is a lot longer than you&apos;d like. By using timeDelay, the snitch can somewhat immediately penalize problem nodes since the queries do not have to timeout first. That said, it has numerous flaws both conceptually and in its implementation.&lt;/p&gt;

&lt;p&gt;I was working on this problem a couple weeks ago, but have been distracted since, so I might not be able to give the best summary. Here&apos;s a couple issues off the top of my head though:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;if the time delay values are low, then high jitter throws the scores way off. It isn&apos;t unreasonable to expect situations where the time delay shifts semi-randomly between 0 and 1 ms. This means very little in terms of whether a node is a suitable target but can cause a drastic difference in scores if there is no slow node to anchor the scores.&lt;/li&gt;
	&lt;li&gt;if the node response periods aren&apos;t low; say they average around 50 ms. Then by definition they are highly random since the score could be calculated at any point along 0 to 50 ms.&lt;/li&gt;
	&lt;li&gt;it has a lot of complex interactions outside of its original scope of detecting bad nodes&lt;/li&gt;
	&lt;li&gt;when calculating scores, if there is no lastReceived value for a node (eg. the node has just been added to the cluster), then the logic defaults to using the current time (essentially 0 or maximum &apos;good&apos;). You might instead take the view that an unproven, cache-cold node would be a bad selection.&lt;/li&gt;
	&lt;li&gt;sensitive to local noise. Each time the score is calculated, the timePenalty is calculated fresh. Since there is no concept of persistance or scope, events that corrupt the scoring process are extra harmful. eg. GC, CPU load / thread scheduling, and concurrency shenanigans occuring between the lastReceived.get() and System.currentTimeMillis()&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Some of these issues are somewhat alleviated by the switch to using nanos, and I&apos;ve been tempted to back port that for this class at least for testing, but this logic fails in complex ways. I think at some point I was able to confirm some wildly fluctuating values of the subcomponents to the scores (specifically timePenalty) by checking the mbeans and working under the assumption that timePenalty was likely the only component to well rounded scores &amp;#8211; if you have at least one node with &amp;gt;&amp;gt; timePenalty then it gets cut off to UPDATE_INTERVAL_IN_MS which as a divisor makes for nicely formed floating point numbers.&lt;/p&gt;

&lt;p&gt;There are also a lot of issues with the other score components, and some of the overall logic, but... some other time. Apologies if i&apos;ve gotten something quite wrong; I&apos;ve never really used Cassandra.&lt;/p&gt;</comment>
                            <comment id="13868234" author="thobbs" created="Fri, 10 Jan 2014 20:08:40 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ianbarfield&quot; class=&quot;user-hover&quot; rel=&quot;ianbarfield&quot;&gt;ianbarfield&lt;/a&gt; thanks for the analysis, you make some excellent observations.&lt;/p&gt;

&lt;p&gt;From the discussion in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3722&quot; title=&quot;Send Hints to Dynamic Snitch when Compaction or repair is going on for a node.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3722&quot;&gt;&lt;del&gt;CASSANDRA-3722&lt;/del&gt;&lt;/a&gt;, it seems like the two motivations for the time penalty were these:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;When a node dies, the FD will not mark it down for a while; in the meantime, we&apos;d like to stop sending queries to it&lt;/li&gt;
	&lt;li&gt;In a multi-DC setup, we would like to penalize the remote DC, but not so much that we won&apos;t ever use it when local nodes become very slow&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I suspect that rapid read protection (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4705&quot; title=&quot;Speculative execution for reads / eager retries&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4705&quot;&gt;&lt;del&gt;CASSANDRA-4705&lt;/del&gt;&lt;/a&gt;) does a good job of mitigating the #1 case until the FD marks the node down.  I&apos;ll do some testing to confirm this.&lt;/p&gt;

&lt;p&gt;I don&apos;t feel like the #2 case needs special treatment from the dynamic snitch, especially with the badness_threshold in effect.  Latency to the remote DC should prevent it from being used under normal circumstances.  If users really want to guarantee that, the LOCAL consistency levels are always available.&lt;/p&gt;</comment>
                            <comment id="13868251" author="brandon.williams" created="Fri, 10 Jan 2014 20:22:04 +0000"  >&lt;p&gt;The best way to test #1 is to run in foreground mode and then suspend (^Z) the JVM.&lt;/p&gt;</comment>
                            <comment id="13870974" author="thobbs" created="Tue, 14 Jan 2014 17:59:59 +0000"  >&lt;p&gt;Attached are two graphs of throughput and 99th percentile latencies for four runs of stress.  Two runs kept the time penalty in DES, and two had it removed.  There was a normal stress read of 3 million rows with and without the time penalty, and a second run where one of the three nodes was suspended 30 seconds into the run and resumed 60 seconds into the run.&lt;/p&gt;

&lt;p&gt;In short, there&apos;s no difference in throughput or median/95th/99th latencies when a node goes down with the time penalty removed, so it looks like rapid read protection does indeed dominate there.&lt;/p&gt;</comment>
                            <comment id="13870983" author="thobbs" created="Tue, 14 Jan 2014 18:10:42 +0000"  >&lt;p&gt;6465-v1.patch (and &lt;a href=&quot;https://github.com/thobbs/cassandra/tree/CASSANDRA-6465&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;) removes the timePenalty component from the DES score.&lt;/p&gt;</comment>
                            <comment id="13871089" author="brandon.williams" created="Tue, 14 Jan 2014 20:09:14 +0000"  >&lt;p&gt;Can we get some numbers on score fluctuation with the time penalty removed to be certain this fixes it?&lt;/p&gt;</comment>
                            <comment id="13871175" author="thobbs" created="Tue, 14 Jan 2014 21:04:34 +0000"  >&lt;p&gt;Attached are the DES scores from a run with and without the time penalty.  This was done with a three node CCM cluster. node1 coordinated all reads, and node2 and node3 were the replicas for all reads.  In both runs, node2 served most of the reads (as reported by cfstats).&lt;/p&gt;</comment>
                            <comment id="13871195" author="brandon.williams" created="Tue, 14 Jan 2014 21:18:45 +0000"  >&lt;p&gt;Committed, with mentions of time penalty removed from comments.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12622904" name="6465-v1.patch" size="3239" author="thobbs" created="Tue, 14 Jan 2014 18:10:42 +0000"/>
                            <attachment id="12622899" name="99th_latency.png" size="76109" author="thobbs" created="Tue, 14 Jan 2014 17:59:59 +0000"/>
                            <attachment id="12617871" name="des-score-graph.png" size="24562" author="cburroughs" created="Mon, 9 Dec 2013 18:24:14 +0000"/>
                            <attachment id="12622977" name="des-scores-with-penalty.csv" size="1342" author="thobbs" created="Tue, 14 Jan 2014 21:04:34 +0000"/>
                            <attachment id="12622976" name="des-scores-without-penalty.csv" size="1657" author="thobbs" created="Tue, 14 Jan 2014 21:04:34 +0000"/>
                            <attachment id="12617870" name="des.sample.15min.csv" size="47603" author="cburroughs" created="Mon, 9 Dec 2013 18:24:14 +0000"/>
                            <attachment id="12617869" name="get-scores.py" size="2801" author="cburroughs" created="Mon, 9 Dec 2013 18:24:14 +0000"/>
                            <attachment id="12622900" name="throughput.png" size="75706" author="thobbs" created="Tue, 14 Jan 2014 17:59:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>362724</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 45 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qivr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>363018</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12323243">1.2.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>