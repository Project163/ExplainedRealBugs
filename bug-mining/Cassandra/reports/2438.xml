<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:41:11 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6181] Replaying a commit led to java.lang.StackOverflowError and node crash</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6181</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;2 of our nodes died after attempting to replay a commit.  I can attach the commit log file if that helps.&lt;br/&gt;
It was occurring on 1.2.8, after several failed attempts to start, we attempted startup with 1.2.10.  This also yielded the same issue (below).  The only resolution was to physically move the commit log file out of the way and then the nodes were able to start...  &lt;/p&gt;

&lt;p&gt;The replication factor was 3 so I&apos;m hoping there was no data loss...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; INFO [main] 2013-10-11 14:50:35,891 CommitLogReplayer.java (line 119) Replaying /ebs/cassandra/commitlog/CommitLog-2-1377542389560.log
ERROR [MutationStage:18] 2013-10-11 14:50:37,387 CassandraDaemon.java (line 191) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[MutationStage:18,5,main]
java.lang.StackOverflowError
        at org.apache.cassandra.db.marshal.TimeUUIDType.compareTimestampBytes(TimeUUIDType.java:68)
        at org.apache.cassandra.db.marshal.TimeUUIDType.compare(TimeUUIDType.java:57)
        at org.apache.cassandra.db.marshal.TimeUUIDType.compare(TimeUUIDType.java:29)
        at org.apache.cassandra.db.marshal.AbstractType.compareCollectionMembers(AbstractType.java:229)
        at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:81)
        at org.apache.cassandra.db.marshal.AbstractCompositeType.compare(AbstractCompositeType.java:31)
        at org.apache.cassandra.db.RangeTombstoneList.insertAfter(RangeTombstoneList.java:439)
        at org.apache.cassandra.db.RangeTombstoneList.insertFrom(RangeTombstoneList.java:405)
        at org.apache.cassandra.db.RangeTombstoneList.weakInsertFrom(RangeTombstoneList.java:472)
        at org.apache.cassandra.db.RangeTombstoneList.insertAfter(RangeTombstoneList.java:456)
        at org.apache.cassandra.db.RangeTombstoneList.insertFrom(RangeTombstoneList.java:405)
        at org.apache.cassandra.db.RangeTombstoneList.weakInsertFrom(RangeTombstoneList.java:472)
        at org.apache.cassandra.db.RangeTombstoneList.insertAfter(RangeTombstoneList.java:456)
        at org.apache.cassandra.db.RangeTombstoneList.insertFrom(RangeTombstoneList.java:405)
        at org.apache.cassandra.db.RangeTombstoneList.weakInsertFrom(RangeTombstoneList.java:472)

.... etc.... over and over until ....

        at org.apache.cassandra.db.RangeTombstoneList.weakInsertFrom(RangeTombstoneList.java:472)
        at org.apache.cassandra.db.RangeTombstoneList.insertAfter(RangeTombstoneList.java:456)
        at org.apache.cassandra.db.RangeTombstoneList.insertFrom(RangeTombstoneList.java:405)
        at org.apache.cassandra.db.RangeTombstoneList.add(RangeTombstoneList.java:144)
        at org.apache.cassandra.db.RangeTombstoneList.addAll(RangeTombstoneList.java:186)
        at org.apache.cassandra.db.DeletionInfo.add(DeletionInfo.java:180)
        at org.apache.cassandra.db.AtomicSortedColumns.addAllWithSizeDelta(AtomicSortedColumns.java:197)
        at org.apache.cassandra.db.AbstractColumnContainer.addAllWithSizeDelta(AbstractColumnContainer.java:99)
        at org.apache.cassandra.db.Memtable.resolve(Memtable.java:207)
        at org.apache.cassandra.db.Memtable.put(Memtable.java:170)
        at org.apache.cassandra.db.ColumnFamilyStore.apply(ColumnFamilyStore.java:745)
        at org.apache.cassandra.db.Table.apply(Table.java:388)
        at org.apache.cassandra.db.Table.apply(Table.java:353)
        at org.apache.cassandra.db.commitlog.CommitLogReplayer$1.runMayThrow(CommitLogReplayer.java:258)
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471)
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:334)
        at java.util.concurrent.FutureTask.run(FutureTask.java:166)
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:724)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
</description>
                <environment>&lt;p&gt;1.2.8 &amp;amp; 1.2.10 - ubuntu 12.04&lt;/p&gt;</environment>
        <key id="12673448">CASSANDRA-6181</key>
            <summary>Replaying a commit led to java.lang.StackOverflowError and node crash</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="jdamick">Jeffrey Damick</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Oct 2013 15:01:06 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:03 +0000</updated>
                            <resolved>Wed, 23 Oct 2013 14:18:11 +0000</resolved>
                                        <fixVersion>1.2.12</fixVersion>
                    <fixVersion>2.0.2</fixVersion>
                                        <due></due>
                            <votes>1</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13792733" author="jbellis" created="Fri, 11 Oct 2013 15:46:08 +0000"  >&lt;p&gt;Pattern matching &lt;tt&gt;RangeTombstoneList&lt;/tt&gt; to Sylvain.&lt;/p&gt;</comment>
                            <comment id="13792806" author="slebresne" created="Fri, 11 Oct 2013 17:03:16 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jdamick&quot; class=&quot;user-hover&quot; rel=&quot;jdamick&quot;&gt;jdamick&lt;/a&gt; Actually, the commit log would be useful if you have it, though ideally I&apos;d need the schema too. Feel free to send that to me in private if you prefer.&lt;/p&gt;</comment>
                            <comment id="13792916" author="jdamick" created="Fri, 11 Oct 2013 18:25:45 +0000"  >&lt;p&gt;i sent you a link in email @ datastax.&lt;/p&gt;</comment>
                            <comment id="13801653" author="slebresne" created="Tue, 22 Oct 2013 09:44:35 +0000"  >&lt;p&gt;I unfortunately haven&apos;t been to reproduce with the commit log from Jeffrey.&lt;/p&gt;

&lt;p&gt;That being said, looking at the stacktrace more closely, I don&apos;t think that this is an infinite loop. Rather, in some insertion cases, we have to iterate over all (or a large part) of the range tombstones and that is currently done recursively so this can blow up the stack. The blow-up does reproduce rather easily in a unit test (with 3K range tombstone, which is not small, but not all that much). I though we would be unlikely to run into that case with the way range tombstones are used in practice, but I suppose that&apos;s still possible if you have multiple clustering columns so maybe that&apos;s just that.&lt;/p&gt;

&lt;p&gt;Anyway, I don&apos;t really another fix than to rewrite the logic non-recursively.  Attaching a patch for this. This is probably a little bit more involved that what I&apos;d like to push in 1.2 at this point, but at same I don&apos;t think there is any simpler way to fix this. On the bright side, RangeTombstoneList is relatively well covered by unit tests.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=exabytes18&quot; class=&quot;user-hover&quot; rel=&quot;exabytes18&quot;&gt;exabytes18&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jdamick&quot; class=&quot;user-hover&quot; rel=&quot;jdamick&quot;&gt;jdamick&lt;/a&gt;: If you guys could check that the attached patch does fix this for you, that would be awesome.&lt;/p&gt;</comment>
                            <comment id="13801772" author="frousseau" created="Tue, 22 Oct 2013 12:41:44 +0000"  >&lt;p&gt;Don&apos;t know if this can help but, unit tests do not set &quot;-Xss&quot; parameter and uses the default value (1M in general, see &lt;a href=&quot;http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html&lt;/a&gt; ) while default Xss is 180k for  Cassandra1.2&lt;/p&gt;

&lt;p&gt;Here are some raw numbers using unit tests and setting Xss in the build.xml :&lt;br/&gt;
N = 193; // 180k&lt;br/&gt;
N = 313; // 228k&lt;br/&gt;
N = 394; // 256k&lt;br/&gt;
N = 1036; // 512k&lt;br/&gt;
N = 2321; // 1024k&lt;/p&gt;

&lt;p&gt;This number represents the number of inserted tombstones before the tests starts failing (ie : incrementing this number by one : tests fails with SOException)&lt;br/&gt;
This should probably explain why it was not reproducible.&lt;br/&gt;
By the way, maybe the unit tests should set the Xss parameter in order to be as close as possible of a running cassandra instance ?&lt;/p&gt;
</comment>
                            <comment id="13802704" author="slebresne" created="Wed, 23 Oct 2013 08:23:50 +0000"  >&lt;p&gt;Right, it&apos;s really not that hard to get into with the default stack trace, which probably explain why we already have 2 people reporting this.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;maybe the unit tests should set the Xss parameter in order to be as close as possible of a running cassandra instance ?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Not a bad idea. I&apos;ve ninja-committed that, though I fixed it to 256k because that&apos;s the default in 2.0 and for 1.2, 180k is known to cause problem on some platforms and didn&apos;t wanted with that.&lt;/p&gt;</comment>
                            <comment id="13802876" author="frousseau" created="Wed, 23 Oct 2013 13:51:06 +0000"  >&lt;p&gt;After reviewing patch, here are some changes in RangeTombstone.java:&lt;/p&gt;

&lt;p&gt;L143: &apos;(pos &amp;gt;= 0 ? pos : -pos-1)&apos; should probably be &apos;(pos &amp;gt;= 0 ? pos+1 : -pos-1)&apos;&lt;br/&gt;
if pos is positive, it means that start == ends&lt;span class=&quot;error&quot;&gt;&amp;#91;pos&amp;#93;&lt;/span&gt;, and the interval should be inserted at (pos+1)&lt;/p&gt;


&lt;p&gt;Below is a simple test to reproduce this behaviour:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;    @Test
    public void overlappingPreviousEndEqualsStartTest1()
    {
        RangeTombstoneList l = new RangeTombstoneList(cmp, 0);
        // add a RangeTombstone, so, last insert is not in insertion order
        l.add(rt(11, 12, 2));
        l.add(rt(1, 4, 2));
        l.add(rt(4, 10, 5));

        assertEquals(2, l.search(b(3)).markedForDeleteAt);
        assertEquals(5, l.search(b(4)).markedForDeleteAt);
        assertEquals(5, l.search(b(8)).markedForDeleteAt);
        assertEquals(3, l.size());
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Some very minor changes in comments:&lt;br/&gt;
L200: should replace &apos;insertFrom&apos; to &apos;addInternal&apos;&lt;br/&gt;
L394: should the commented line be : setInternal(i, start, ends&lt;span class=&quot;error&quot;&gt;&amp;#91;i&amp;#93;&lt;/span&gt;, markedAt, delTime) ? (it seems more in the spirit)&lt;br/&gt;
L422: TODO can be removed, because implemented a few lines above&lt;/p&gt;

&lt;p&gt;Otherwise, LGTM&lt;/p&gt;</comment>
                            <comment id="13802894" author="slebresne" created="Wed, 23 Oct 2013 14:17:58 +0000"  >&lt;p&gt;Correct about L143, thanks. Updated and committed, thanks.&lt;/p&gt;</comment>
                            <comment id="13824671" author="exabytes18" created="Sat, 16 Nov 2013 23:41:43 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; Can you give a concrete cql schema + access pattern which causes this to occur? What would the effective usage limits be before and after this patch (i.e. how much improvement does this patch provide)?&lt;/p&gt;

&lt;p&gt;Our application does a certain number of deletions which are unavoidable. It seems under our current design, cassandra cannot accommodate our workload and we&apos;re trying to understand what to do differently.&lt;/p&gt;</comment>
                            <comment id="13825319" author="slebresne" created="Mon, 18 Nov 2013 13:45:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;What would the effective usage limits be before and after this patch&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Before, it would crash with the exception in the description above, after it won&apos;t. This is really &quot;just&quot; a bug fix, if you don&apos;t run into it, there is nothing this patch will do for you. If you do, then it will fix the problem.&lt;/p&gt;</comment>
                            <comment id="13825908" author="exabytes18" created="Mon, 18 Nov 2013 23:00:02 +0000"  >&lt;p&gt;Sorry, I mean what sort of DELETE statements cause this to happen? From reading these comments, it seems that there&apos;s some threshold at which too many deletions cause this to occur? Does the patch raise or eliminate this limit?&lt;/p&gt;</comment>
                            <comment id="13826340" author="slebresne" created="Tue, 19 Nov 2013 09:32:38 +0000"  >&lt;p&gt;This is related to range tombstones. We mainly use range tombstone in two cases:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;you do a &apos;DELETE FROM X WHERE Y&apos; (so the whole CQL3 row) &lt;b&gt;and&lt;/b&gt; Y contains at least a clustering column (if it contains only the partition key for instance, we don&apos;t use a range tombstone).&lt;/li&gt;
	&lt;li&gt;you set a collection (but not when you append/add/remove to it).&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;And this may be triggered if you reach some amount of such range tombstones within one partition. But 1) this is not guaranteed at all, as this depends on the ranges covered by those tombstones and the insertion order of those tombstones (and the exact conditions can&apos;t be easily characterize, sorry) and 2) the exact number of tombstones after which this may be triggered depends on the stack size (see Fabien&apos;s comment above).&lt;/p&gt;

&lt;p&gt;In any case, the patch eliminate this entirely.&lt;/p&gt;</comment>
                            <comment id="13826406" author="exabytes18" created="Tue, 19 Nov 2013 11:31:55 +0000"  >&lt;p&gt;Fantastic. Thanks for the clarification!&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="12674775">CASSANDRA-6223</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12609619" name="6181.txt" size="14814" author="slebresne" created="Tue, 22 Oct 2013 09:44:35 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>353071</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 1 week ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ovev:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>353358</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>frousseau</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[frousseau]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324785">1.2.8</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>