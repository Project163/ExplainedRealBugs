<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:37:40 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5179] Hinted handoff sends over 1000 rows for one column change</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5179</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We have a small test environment with two datacenters (DC1 and DC2) running on Windows 7 laptops.&lt;br/&gt;
Both datacenters have one node. We use network topology strategy to replicate all data to both datacenters.&lt;/p&gt;

&lt;p&gt;We started with empty db. &lt;br/&gt;
1. Created a keyspace with strategy options &lt;span class=&quot;error&quot;&gt;&amp;#91;DC1:1, DC2:1&amp;#93;&lt;/span&gt;&lt;br/&gt;
2. Added one row to a column family with CLI to DC1. Change was replicated to DC2.&lt;br/&gt;
3. Disconnected network cable from DC2.&lt;br/&gt;
4. Gossiper noticed, that other DC is dead.&lt;br/&gt;
5. Added another row to DC1.&lt;br/&gt;
6. Reconnected cable on DC2.&lt;br/&gt;
7. DC1 started hinted handoff for DC2.&lt;br/&gt;
8. Hinted handoff is finished with message: &quot;Finished hinted handoff of 1969 rows to endpoint &amp;lt;DC2 ip&amp;gt;&quot;&lt;/p&gt;

&lt;p&gt;We repeated test with same results on Linux cluster with Cassandra 1.2.0. &lt;/p&gt;

&lt;p&gt;On Cassandra 1.1.5 Linux cluster, only one row was sent to endpoint. &quot;Finished hinted handoff of 1 rows to endpoint &amp;lt;DC2 ip&amp;gt;&quot;&lt;/p&gt;</description>
                <environment>&lt;p&gt;Windows 7&lt;br/&gt;
Java 1.6u38&lt;/p&gt;</environment>
        <key id="12628677">CASSANDRA-5179</key>
            <summary>Hinted handoff sends over 1000 rows for one column change</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="anttiko">Antti Koivisto</reporter>
                        <labels>
                    </labels>
                <created>Tue, 22 Jan 2013 08:15:55 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:19 +0000</updated>
                            <resolved>Wed, 20 Mar 2013 17:29:47 +0000</resolved>
                                        <fixVersion>1.2.4</fixVersion>
                                        <due></due>
                            <votes>2</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13560849" author="jbellis" created="Wed, 23 Jan 2013 17:29:20 +0000"  >&lt;p&gt;Can you give us a debug log?&lt;/p&gt;</comment>
                            <comment id="13570349" author="cscetbon" created="Mon, 4 Feb 2013 16:02:58 +0000"  >&lt;p&gt;It&apos;s written that it&apos;s fixed in 1.2.2&lt;br/&gt;
Do you know if a bugfix corrected it ? &lt;/p&gt;</comment>
                            <comment id="13570361" author="jbellis" created="Mon, 4 Feb 2013 16:23:50 +0000"  >&lt;p&gt;Fix-for is target fix version.  The issue is not fixed until resolved.&lt;/p&gt;</comment>
                            <comment id="13570364" author="cscetbon" created="Mon, 4 Feb 2013 16:25:47 +0000"  >&lt;p&gt;Ok thanks for this information &#8230;&lt;/p&gt;</comment>
                            <comment id="13599680" author="iamaleksey" created="Tue, 12 Mar 2013 04:14:39 +0000"  >&lt;p&gt;4881221363f984ab6610756cab38e1a016b79e15 (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4761&quot; title=&quot;Async hints delivery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4761&quot;&gt;&lt;del&gt;CASSANDRA-4761&lt;/del&gt;&lt;/a&gt;) broke it. Current pagination logic doesn&apos;t deal well with the fact that deleteHint is now being called from a response handler callback and can go through the same hint again and again and again until it&apos;s finally replaced with a tombstone. This becomes really visible in multi-dc setups, where it can take a while to complete the write, but I was able to trigger it with ccm as well (the same hint got sent up to 3 times).&lt;/p&gt;

&lt;p&gt;Should we reopen &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4761&quot; title=&quot;Async hints delivery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4761&quot;&gt;&lt;del&gt;CASSANDRA-4761&lt;/del&gt;&lt;/a&gt; or deal with it here?&lt;/p&gt;</comment>
                            <comment id="13599692" author="jbellis" created="Tue, 12 Mar 2013 04:33:17 +0000"  >&lt;p&gt;Let&apos;s fix it here.&lt;/p&gt;</comment>
                            <comment id="13599698" author="iamaleksey" created="Tue, 12 Mar 2013 04:40:15 +0000"  >&lt;p&gt;k. This is the problematic branch btw: &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-1.2/src/java/org/apache/cassandra/db/HintedHandOffManager.java#L336&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-1.2/src/java/org/apache/cassandra/db/HintedHandOffManager.java#L336&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13599728" author="iamaleksey" created="Tue, 12 Mar 2013 05:41:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/iamaleksey/cassandra/compare/5179&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iamaleksey/cassandra/compare/5179&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13605203" author="mkjellman" created="Mon, 18 Mar 2013 15:20:37 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jbellis&quot; class=&quot;user-hover&quot; rel=&quot;jbellis&quot;&gt;jbellis&lt;/a&gt; patch looks good to me&lt;/p&gt;</comment>
                            <comment id="13605227" author="jbellis" created="Mon, 18 Mar 2013 15:44:16 +0000"  >&lt;p&gt;If we time out we should probably cease further delivery attempts, to avoid hammering a node that is behind.&lt;/p&gt;</comment>
                            <comment id="13605394" author="iamaleksey" created="Mon, 18 Mar 2013 17:47:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;If we time out we should probably cease further delivery attempts, to avoid hammering a node that is behind.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Probably. But that&apos;s not what causing this particular issue - the patch only fixes that faulty pagination logic.&lt;/p&gt;

&lt;p&gt;I don&apos;t see an easy way to stop it on a timeout as we did in 1.1 now (yet), but that&apos;s a problem for another ticket anyway.&lt;/p&gt;</comment>
                            <comment id="13605430" author="jbellis" created="Mon, 18 Mar 2013 18:17:25 +0000"  >&lt;p&gt;We can&apos;t put that code in the empty catch block here?&lt;/p&gt;</comment>
                            <comment id="13605431" author="iamaleksey" created="Mon, 18 Mar 2013 18:20:07 +0000"  >&lt;p&gt;It&apos;ll be of no use - all the requests have been sent at that point. It&apos;s waiting for responses before forcing compaction.&lt;/p&gt;</comment>
                            <comment id="13605614" author="jbellis" created="Mon, 18 Mar 2013 20:50:11 +0000"  >&lt;p&gt;What if we made it wait per page, instead of all at once?&lt;/p&gt;

&lt;p&gt;Seems like that would be a good way to put a bound on how many callbacks we need to keep around too.&lt;/p&gt;</comment>
                            <comment id="13605808" author="iamaleksey" created="Mon, 18 Mar 2013 23:46:35 +0000"  >&lt;blockquote&gt;&lt;p&gt;What if we made it wait per page, instead of all at once?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This goes against &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4761&quot; title=&quot;Async hints delivery&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4761&quot;&gt;&lt;del&gt;CASSANDRA-4761&lt;/del&gt;&lt;/a&gt; somewhat, but I think it&apos;s a good compromise between sending hints one at a time and pouring everything out. Updated &lt;a href=&quot;https://github.com/iamaleksey/cassandra/compare/5179&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iamaleksey/cassandra/compare/5179&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13605895" author="jbellis" created="Tue, 19 Mar 2013 01:08:19 +0000"  >&lt;p&gt;You could use break-to-label instead of a bool in the get() loop, but shouldn&apos;t it just be a return instead of break?&lt;/p&gt;</comment>
                            <comment id="13605910" author="iamaleksey" created="Tue, 19 Mar 2013 01:20:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;You could use break-to-label instead of a bool in the get() loop, but shouldn&apos;t it just be a return instead of break?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes I could. But some requests after the timed-out one could actually have succeeded - with the ratelimiter delay and all, and since we sent them, we might as well wait for the replies before triggering compaction (hints are deleted in that callback). And with return instead of break 1) compaction wouldn&apos;t be triggered, event if it&apos;s the last page of many and 2) &quot;Finished hinted handoff ..&quot; message wouldn&apos;t be logged.&lt;/p&gt;</comment>
                            <comment id="13605913" author="jbellis" created="Tue, 19 Mar 2013 01:24:47 +0000"  >&lt;p&gt;I think the reasoning for return instead of break in the FD block was that, if we haven&apos;t finished sending hints then we probably don&apos;t want to force a major compaction that will rewrite a bunch of undelivered hints.&lt;/p&gt;</comment>
                            <comment id="13605916" author="iamaleksey" created="Tue, 19 Mar 2013 01:26:43 +0000"  >&lt;p&gt;Maybe. It was break in 1.1 though - &lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-1.1/src/java/org/apache/cassandra/db/HintedHandOffManager.java#L375&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-1.1/src/java/org/apache/cassandra/db/HintedHandOffManager.java#L375&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13605925" author="jbellis" created="Tue, 19 Mar 2013 01:33:10 +0000"  >&lt;p&gt;True...  and 1.0 had a &quot;if rowsReplayed &amp;gt; 0&quot; around it.  Not sure why we removed that, except maybe that it would almost always be true.&lt;/p&gt;

&lt;p&gt;How about we make the 1.0 check smarter and compact if we delivered over half the hints?&lt;/p&gt;</comment>
                            <comment id="13605927" author="iamaleksey" created="Tue, 19 Mar 2013 01:34:37 +0000"  >&lt;blockquote&gt;&lt;p&gt;How about we make the 1.0 check smarter and compact if we delivered over half the hints?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;wfm&lt;/p&gt;</comment>
                            <comment id="13606091" author="iamaleksey" created="Tue, 19 Mar 2013 05:43:22 +0000"  >&lt;p&gt;Actually, it doesn&apos;t wfm. HHM is already complicated enough. I think returning completely is just fine there - as long as the log message mentions how many hints have been delivered.&lt;/p&gt;

&lt;p&gt;There will be many more opportunities for compaction - when hints to another node are all sent, or after another attempt in &amp;lt;= 10 minutes.&lt;/p&gt;

&lt;p&gt;Updated the branch (also did some &lt;b&gt;very&lt;/b&gt; minor refactoring so that the paging logic would at least fit in a single screen, plus some even minorer changes that I just couldn&apos;t resist).&lt;/p&gt;</comment>
                            <comment id="13607745" author="jbellis" created="Wed, 20 Mar 2013 15:50:48 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13607892" author="iamaleksey" created="Wed, 20 Mar 2013 17:29:47 +0000"  >&lt;p&gt;Thanks, committed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12610233">CASSANDRA-4761</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12566481" name="cassandra_receiver.log" size="441738" author="anttiko" created="Fri, 25 Jan 2013 07:59:02 +0000"/>
                            <attachment id="12566480" name="cassandra_sender.log" size="419356" author="anttiko" created="Fri, 25 Jan 2013 07:59:02 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>307202</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 35 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ahvr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>269363</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>