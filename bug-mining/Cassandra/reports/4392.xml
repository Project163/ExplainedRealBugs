<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:04:01 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11345] Assertion Errors &quot;Memory was freed&quot; during streaming</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11345</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We encountered the following AssertionError (twice on the same node) during a repair :&lt;/p&gt;

&lt;p&gt;On node /172.16.63.41&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [STREAM-IN-/10.174.216.160] 2016-03-09 02:38:13,900 StreamResultFuture.java:180 - [Stream #f6980580-e55f-11e5-8f08-ef9e099ce99e] Session with /10.174.216.160 is complete                                                                                                        
WARN  [STREAM-IN-/10.174.216.160] 2016-03-09 02:38:13,900 StreamResultFuture.java:207 - [Stream #f6980580-e55f-11e5-8f08-ef9e099ce99e] Stream failed                           
ERROR [STREAM-OUT-/10.174.216.160] 2016-03-09 02:38:13,906 StreamSession.java:505 - [Stream #f6980580-e55f-11e5-8f08-ef9e099ce99e] Streaming error occurred                    
java.lang.AssertionError: Memory was freed                                                                                                                                     
        at org.apache.cassandra.io.util.SafeMemory.checkBounds(SafeMemory.java:97) ~[apache-cassandra-2.1.13.jar:2.1.13]                                                   
        at org.apache.cassandra.io.util.Memory.getLong(Memory.java:249) ~[apache-cassandra-2.1.13.jar:2.1.13]                                                              
        at org.apache.cassandra.io.compress.CompressionMetadata.getTotalSizeForSections(CompressionMetadata.java:247) ~[apache-cassandra-2.1.13.jar:2.1.13]                
        at org.apache.cassandra.streaming.messages.FileMessageHeader.size(FileMessageHeader.java:112) ~[apache-cassandra-2.1.13.jar:2.1.13]                                
        at org.apache.cassandra.streaming.StreamSession.fileSent(StreamSession.java:546) ~[apache-cassandra-2.1.13.jar:2.1.13]                                             
        at org.apache.cassandra.streaming.messages.OutgoingFileMessage$1.serialize(OutgoingFileMessage.java:50) ~[apache-cassandra-2.1.13.jar:2.1.13]                      
        at org.apache.cassandra.streaming.messages.OutgoingFileMessage$1.serialize(OutgoingFileMessage.java:41) ~[apache-cassandra-2.1.13.jar:2.1.13]                      
        at org.apache.cassandra.streaming.messages.StreamMessage.serialize(StreamMessage.java:45) ~[apache-cassandra-2.1.13.jar:2.1.13]                                    
        at org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.sendMessage(ConnectionHandler.java:351) ~[apache-cassandra-2.1.13.jar:2.1.13]           
        at org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.run(ConnectionHandler.java:331) ~[apache-cassandra-2.1.13.jar:2.1.13]                   
        at java.lang.Thread.run(Thread.java:745) [na:1.7.0_65]                                                                                                                 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;     

&lt;p&gt;On node /10.174.216.160&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;       
ERROR [STREAM-OUT-/172.16.63.41] 2016-03-09 02:38:14,140 StreamSession.java:505 - [Stream #f6980580-e55f-11e5-8f08-ef9e099ce99e] Streaming error occurred                          
java.io.IOException: Connection reset by peer                                                                                                                              
        at sun.nio.ch.FileDispatcherImpl.write0(Native Method) ~[na:1.7.0_65]                                                                                              
        at sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:47) ~[na:1.7.0_65]                                                                                      
        at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93) ~[na:1.7.0_65]                                                                                          
        at sun.nio.ch.IOUtil.write(IOUtil.java:65) ~[na:1.7.0_65]                                                                                                          
        at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:487) ~[na:1.7.0_65]                                                                                   
        at org.apache.cassandra.io.util.DataOutputStreamAndChannel.write(DataOutputStreamAndChannel.java:48) ~[apache-cassandra-2.1.13.jar:2.1.13]                     
        at org.apache.cassandra.streaming.messages.StreamMessage.serialize(StreamMessage.java:44) ~[apache-cassandra-2.1.13.jar:2.1.13]                                
        at org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.sendMessage(ConnectionHandler.java:351) [apache-cassandra-2.1.13.jar:2.1.13]        
        at org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.run(ConnectionHandler.java:323) [apache-cassandra-2.1.13.jar:2.1.13]                
        at java.lang.Thread.run(Thread.java:745) [na:1.7.0_65]                                                                                                             
INFO  [STREAM-IN-/172.16.63.41] 2016-03-09 02:38:14,142 StreamResultFuture.java:180 - [Stream #f6980580-e55f-11e5-8f08-ef9e099ce99e] Session with /172.16.63.41 is complete
WARN  [STREAM-IN-/172.16.63.41] 2016-03-09 02:38:14,142 StreamResultFuture.java:207 - [Stream #f6980580-e55f-11e5-8f08-ef9e099ce99e] Stream failed                         
ERROR [STREAM-OUT-/172.16.63.41] 2016-03-09 02:38:14,143 StreamSession.java:505 - [Stream #f6980580-e55f-11e5-8f08-ef9e099ce99e] Streaming error occurred                  
java.io.IOException: Broken pipe                                                                                                                                           
        at sun.nio.ch.FileDispatcherImpl.write0(Native Method) ~[na:1.7.0_65]                                                                                              
        at sun.nio.ch.SocketDispatcher.write(SocketDispatcher.java:47) ~[na:1.7.0_65]                                                                                      
        at sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93) ~[na:1.7.0_65]                                                                                          
        at sun.nio.ch.IOUtil.write(IOUtil.java:65) ~[na:1.7.0_65]                                                                                                          
        at sun.nio.ch.SocketChannelImpl.write(SocketChannelImpl.java:487) ~[na:1.7.0_65]                                                                                   
        at org.apache.cassandra.io.util.DataOutputStreamAndChannel.write(DataOutputStreamAndChannel.java:48) ~[apache-cassandra-2.1.13.jar:2.1.13]                     
        at org.apache.cassandra.streaming.messages.StreamMessage.serialize(StreamMessage.java:44) ~[apache-cassandra-2.1.13.jar:2.1.13]                                
        at org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.sendMessage(ConnectionHandler.java:351) [apache-cassandra-2.1.13.jar:2.1.13]        
        at org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.run(ConnectionHandler.java:331) [apache-cassandra-2.1.13.jar:2.1.13]                
        at java.lang.Thread.run(Thread.java:745) [na:1.7.0_65]     
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="12949310">CASSANDRA-11345</key>
            <summary>Assertion Errors &quot;Memory was freed&quot; during streaming</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="pauloricardomg">Paulo Motta</assignee>
                                    <reporter username="jfgosselin">Jean-Francois Gosselin</reporter>
                        <labels>
                    </labels>
                <created>Fri, 11 Mar 2016 21:16:45 +0000</created>
                <updated>Wed, 15 Oct 2025 09:48:59 +0000</updated>
                            <resolved>Mon, 15 Aug 2016 16:51:57 +0000</resolved>
                                        <fixVersion>2.2.8</fixVersion>
                    <fixVersion>3.0.9</fixVersion>
                    <fixVersion>3.8</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>2</votes>
                                    <watches>12</watches>
                                                                                                                <comments>
                            <comment id="15237224" author="pauloricardomg" created="Tue, 12 Apr 2016 14:12:34 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jfgosselin&quot; class=&quot;user-hover&quot; rel=&quot;jfgosselin&quot;&gt;jfgosselin&lt;/a&gt; do u remember if you were using sequential or parallel repairs when this issue showed up?&lt;/p&gt;</comment>
                            <comment id="15256291" author="jfgosselin" created="Mon, 25 Apr 2016 12:49:31 +0000"  >&lt;p&gt;During a sequential repair.&lt;/p&gt;</comment>
                            <comment id="15277794" author="vineus" created="Tue, 10 May 2016 08:28:35 +0000"  >&lt;p&gt;I get this error when trying to boostrap a node. I had a &lt;a href=&quot;http://stackoverflow.com/questions/36719592/cant-add-a-new-cassandra-datacenter-due-to-streaming-errors/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;stackoverflow question&lt;/a&gt; opened (thought it was a DSE issue) but didn&apos;t think about looking at the out node logs.&lt;/p&gt;

&lt;p&gt;I tried bootstraping and rebuilding the node. Neither ever finish successfully.&lt;/p&gt;</comment>
                            <comment id="15278146" author="vineus" created="Tue, 10 May 2016 14:12:19 +0000"  >&lt;p&gt;Also happening in 2.1.14&lt;/p&gt;</comment>
                            <comment id="15278995" author="pauloricardomg" created="Tue, 10 May 2016 21:34:28 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vineus&quot; class=&quot;user-hover&quot; rel=&quot;vineus&quot;&gt;vineus&lt;/a&gt; What compaction strategy are you using? what is the average sstable size in the sending node?&lt;/p&gt;

&lt;p&gt;I suspect the following race is happening:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Node A sends SSTable X to bootstrapping node B&lt;/li&gt;
	&lt;li&gt;SSTable X is obsoleted by compaction during streaming&lt;/li&gt;
	&lt;li&gt;Node A finishes sending SSTable X to B and starts &lt;a href=&quot;https://github.com/apache/cassandra/blob/21448c50891642f95097a9e5ed0a3802bd90a877/src/java/org/apache/cassandra/streaming/StreamSession.java#L563&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;calculating header size&lt;/a&gt; to update metrics (this became more expensive for compressed tables after &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10680&quot; title=&quot;Deal with small compression chunk size better during streaming plan setup&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10680&quot;&gt;&lt;del&gt;CASSANDRA-10680&lt;/del&gt;&lt;/a&gt;)&lt;/li&gt;
	&lt;li&gt;Meanwhile, node B finishes receiving SSTable X and sends &quot;received&quot; message to node A&lt;/li&gt;
	&lt;li&gt;Node A receives &quot;received&quot; message for SSTable X and &lt;a href=&quot;https://github.com/apache/cassandra/blob/21448c50891642f95097a9e5ed0a3802bd90a877/src/java/org/apache/cassandra/streaming/messages/OutgoingFileMessage.java#L99&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;releases its reference&lt;/a&gt;, causing it to be garbage collected since it was obsoleted&lt;/li&gt;
	&lt;li&gt;Since &lt;tt&gt;CompressionMetadata&lt;/tt&gt; was released, &lt;a href=&quot;https://github.com/apache/cassandra/blob/21448c50891642f95097a9e5ed0a3802bd90a877/src/java/org/apache/cassandra/streaming/messages/FileMessageHeader.java#L133&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;header size calculation&lt;/a&gt; fails with &lt;tt&gt;Memory was freed&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Do you think this is plausible &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; ? &lt;/p&gt;

&lt;p&gt;Simple solution would be to cache header size on first calculation, but we need to confirm first this is really what is happening because it could be hiding some other issue.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vineus&quot; class=&quot;user-hover&quot; rel=&quot;vineus&quot;&gt;vineus&lt;/a&gt; Can you &lt;a href=&quot;https://docs.datastax.com/en/cassandra/2.1/cassandra/tools/toolsSetLogLev.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;set log level&lt;/a&gt; of package &lt;tt&gt;org.apache.cassandra.streaming&lt;/tt&gt; on sending on receiving nodes and attach system logs after error happens again?&lt;/p&gt;</comment>
                            <comment id="15279096" author="yukim" created="Tue, 10 May 2016 22:13:24 +0000"  >&lt;p&gt;SSTable X in node B  is added (activated) when streaming all SSTables in the same table finishes.&lt;br/&gt;
So I guess compaction of SSTable X shouldn&apos;t be happening during streaming.&lt;/p&gt;</comment>
                            <comment id="15279100" author="pauloricardomg" created="Tue, 10 May 2016 22:16:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; the &quot;memory freed&quot; problem happens on Node A, so obsoleting compaction happens on node A while it&apos;s streaming. Is this possible?&lt;/p&gt;</comment>
                            <comment id="15279124" author="yukim" created="Tue, 10 May 2016 22:26:49 +0000"  >&lt;p&gt;My bad, and yes, it seems possible from the code.&lt;/p&gt;</comment>
                            <comment id="15279910" author="vineus" created="Wed, 11 May 2016 10:30:05 +0000"  >&lt;p&gt;We are using the default &lt;tt&gt;SizeTieredCompactionStrategy&lt;/tt&gt; for all tables&lt;br/&gt;
The average SSTable (&lt;tt&gt;-Data.db&lt;/tt&gt; files) size of the sending nodes varies between a few MB to 40GB&lt;/p&gt;

&lt;p&gt;After turning the DEBUG loglevel on for &lt;tt&gt;org.apache.cassandra.streaming&lt;/tt&gt; on a sending node, bootstrap a new node, and wait for the error, this is what I got next to the error:&lt;/p&gt;

&lt;p&gt;(I removed the file name from the log, said file still exist)&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [STREAM-OUT-/172.31.45.28] 2016-05-11 13:28:49,947  CompressedStreamWriter.java:90 - [Stream #ecfe0390-1763-11e6-b6c8-c1820b05e9ae] Finished streaming file /raid0/cassandra/data/SSTABLEFILE-Data.db to /172.31.45.28, bytesTransferred = 5854462750, totalSize = 5854462750
DEBUG [STREAM-IN-/172.31.45.28] 2016-05-11 13:28:49,947  ConnectionHandler.java:106 - [Stream #ecfe0390-1763-11e6-b6c8-c1820b05e9ae] Closing stream connection handler on /172.31.45.28
INFO  [STREAM-IN-/172.31.45.28] 2016-05-11 13:28:49,947  StreamResultFuture.java:180 - [Stream #ecfe0390-1763-11e6-b6c8-c1820b05e9ae] Session with /172.31.45.28 is complete
WARN  [STREAM-IN-/172.31.45.28] 2016-05-11 13:28:49,948  StreamResultFuture.java:207 - [Stream #ecfe0390-1763-11e6-b6c8-c1820b05e9ae] Stream failed
ERROR [STREAM-OUT-/172.31.45.28] 2016-05-11 13:28:49,949  StreamSession.java:505 - [Stream #ecfe0390-1763-11e6-b6c8-c1820b05e9ae] Streaming error occurred
java.lang.AssertionError: Memory was freed
        at org.apache.cassandra.io.util.SafeMemory.checkBounds(SafeMemory.java:97) ~[cassandra-all-2.1.14.1272.jar:2.1.14.1272]
        at org.apache.cassandra.io.util.Memory.getLong(Memory.java:249) ~[cassandra-all-2.1.14.1272.jar:2.1.14.1272]
        at org.apache.cassandra.io.compress.CompressionMetadata.getTotalSizeForSections(CompressionMetadata.java:247) ~[cassandra-all-2.1.14.1272.jar:2.1.14.1272]
        at org.apache.cassandra.streaming.messages.FileMessageHeader.size(FileMessageHeader.java:112) ~[cassandra-all-2.1.14.1272.jar:2.1.14.1272]
        at org.apache.cassandra.streaming.StreamSession.fileSent(StreamSession.java:546) ~[cassandra-all-2.1.14.1272.jar:2.1.14.1272]
        at org.apache.cassandra.streaming.messages.OutgoingFileMessage$1.serialize(OutgoingFileMessage.java:50) ~[cassandra-all-2.1.14.1272.jar:2.1.14.1272]
        at org.apache.cassandra.streaming.messages.OutgoingFileMessage$1.serialize(OutgoingFileMessage.java:41) ~[cassandra-all-2.1.14.1272.jar:2.1.14.1272]
        at org.apache.cassandra.streaming.messages.StreamMessage.serialize(StreamMessage.java:45) ~[cassandra-all-2.1.14.1272.jar:2.1.14.1272]
        at org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.sendMessage(ConnectionHandler.java:358) ~[cassandra-all-2.1.14.1272.jar:2.1.14.1272]
        at org.apache.cassandra.streaming.ConnectionHandler$OutgoingMessageHandler.run(ConnectionHandler.java:338) ~[cassandra-all-2.1.14.1272.jar:2.1.14.1272]
        at java.lang.Thread.run(Thread.java:745) [na:1.7.0_80]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="15280284" author="pauloricardomg" created="Wed, 11 May 2016 15:29:34 +0000"  >&lt;p&gt;Can you post the trace a few lines before that to see what were the last messages received/processed on &lt;span class=&quot;error&quot;&gt;&amp;#91;STREAM-IN-/172.31.45.28&amp;#93;&lt;/span&gt; ?&lt;br/&gt;
Also, can you check &lt;tt&gt;/raid0/cassandra/data/SSTABLEFILE-Data.db&lt;/tt&gt; was logged before as participating in any compaction or other operation? Also can you double check the file still exists?&lt;br/&gt;
Thanks&lt;/p&gt;</comment>
                            <comment id="15280328" author="vineus" created="Wed, 11 May 2016 16:00:27 +0000"  >&lt;p&gt;Ok, I&apos;m sorry, I completely missed this, there was a timeout error prior to the &quot;Memory was freed&quot; error for this particular stream session:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [STREAM-IN-/172.31.45.28] 2016-05-11 13:10:43,842  StreamSession.java:505 - [Stream #ecfe0390-1763-11e6-b6c8-c1820b05e9ae] Streaming error occurred
java.net.SocketTimeoutException: null
        at sun.nio.ch.SocketAdaptor$SocketInputStream.read(SocketAdaptor.java:229) ~[na:1.7.0_80]
        at sun.nio.ch.ChannelInputStream.read(ChannelInputStream.java:103) ~[na:1.7.0_80]
        at java.nio.channels.Channels$ReadableByteChannelImpl.read(Channels.java:385) ~[na:1.7.0_80]
        at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:51) ~[cassandra-all-2.1.14.1272.jar:2.1.14.1272]
        at org.apache.cassandra.streaming.ConnectionHandler$IncomingMessageHandler.run(ConnectionHandler.java:257) ~[cassandra-all-2.1.14.1272.jar:2.1.14.1272]
        at java.lang.Thread.run(Thread.java:745) [na:1.7.0_80]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This particular file is mentioned only once in the log prior to the &quot;Finished streaming&quot; message, when is started to be streamed (with apparently the same size):&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;DEBUG [STREAM-OUT-/172.31.45.28] 2016-05-11 12:10:23,960  CompressedStreamWriter.java:60 - [Stream #ecfe0390-1763-11e6-b6c8-c1820b05e9ae] Start streaming file /raid0/cassandra/data/SSTABLEFILE-Data.db to /172.31.45.28, repairedAt = 0, totalSize = 5854462750
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are compactions for sstables of the same keyspace/table but not for this particular file.&lt;/p&gt;

&lt;p&gt;It still exist, weighting 52595900317 bytes and was last modified on Apr 16&lt;/p&gt;</comment>
                            <comment id="15280544" author="pauloricardomg" created="Wed, 11 May 2016 18:15:38 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vineus&quot; class=&quot;user-hover&quot; rel=&quot;vineus&quot;&gt;vineus&lt;/a&gt; It seems you are seeing the effects &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8343&quot; title=&quot;Secondary index creation causes moves/bootstraps to fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8343&quot;&gt;&lt;del&gt;CASSANDRA-8343&lt;/del&gt;&lt;/a&gt;. The problem is that it takes more than &lt;tt&gt;streaming_socket_timeout_in_ms&lt;/tt&gt; (default=1h) to transfer this 50GB file, so the sending node does not receive any message from the receiving node in the incoming socket and times out the stream session. As a temporary workaround you should increase this property to a larger value (10h or 20h) in sending nodes.&lt;/p&gt;

&lt;p&gt;In any case we should probably keep this ticket open to prevent this memory was freed error from happening when the stream session fails for some other reason.&lt;/p&gt;</comment>
                            <comment id="15280672" author="jmckenzie" created="Wed, 11 May 2016 19:39:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;The problem is that it takes more than streaming_socket_timeout_in_ms (default=1h) to transfer this 50GB file, so the sending node does not receive any message from the receiving node in the incoming socket and times out the stream session.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Is there a reason we don&apos;t have a simple heartbeat mechanism on these streaming sessions to prevent things like this?&lt;/p&gt;</comment>
                            <comment id="15280896" author="pauloricardomg" created="Wed, 11 May 2016 21:59:05 +0000"  >&lt;p&gt;No reason not to, this is going to be provided by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8343&quot; title=&quot;Secondary index creation causes moves/bootstraps to fail&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8343&quot;&gt;&lt;del&gt;CASSANDRA-8343&lt;/del&gt;&lt;/a&gt;. We haven&apos;t noticed this much before due to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11286&quot; title=&quot;streaming socket never times out&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11286&quot;&gt;&lt;del&gt;CASSANDRA-11286&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="15281447" author="vineus" created="Thu, 12 May 2016 12:04:09 +0000"  >&lt;p&gt;Thank! you &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;. It was indeed the issue, setting &lt;/p&gt;
{streaming_socket_timeout_in_ms}
&lt;p&gt; to a high value (72000000ms or 20h in my case) solved the issue! Will answer my stackoverflow question in the hope it helps others.&lt;/p&gt;</comment>
                            <comment id="15315001" author="pauloricardomg" created="Fri, 3 Jun 2016 22:31:47 +0000"  >&lt;p&gt;While the root cause of the reported issue is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11840&quot; title=&quot;Set a more conservative default to streaming_socket_timeout_in_ms&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11840&quot;&gt;&lt;del&gt;CASSANDRA-11840&lt;/del&gt;&lt;/a&gt;, as a consequence of that the stream session failed while an sstable was being transferred, making its reference be released by &lt;tt&gt;StreamTransferTask.abort()&lt;/tt&gt; -&amp;gt; &lt;tt&gt;OutgoingFileMessage.complete()&lt;/tt&gt; before the transfer was complete, potentially causing the subsequent &lt;tt&gt;Memory was freed&lt;/tt&gt; error if the sstable is garbage collected.&lt;/p&gt;

&lt;p&gt;The ideal solution is &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11956&quot; title=&quot;Interrupt outgoing file transfer when stream session is aborted&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11956&quot;&gt;CASSANDRA-11956&lt;/a&gt; (to interrupt the stream transfer task right away), but while that is not in place we should release the sstable reference only after the ongoing transfer is finished (even if the session is aborted). So the idea of the patch is to set a &lt;tt&gt;transferring&lt;/tt&gt; flag on &lt;tt&gt;OutgoingFileMessage&lt;/tt&gt; while the file is being transferred, and if the session is failed before that the reference is not released, only after the &lt;tt&gt;transferring&lt;/tt&gt; flag is unset at the end of the file transfer. I added a unit test that verifies that an sstable is not unreferenced if it&apos;s being transferred and the stream session fails, only after the transfer is finished.&lt;/p&gt;

&lt;p&gt;I also added a ninja fix to cache the &lt;tt&gt;FileMessageHeader&lt;/tt&gt; size to avoid paying a high cost of recalculation of the size of large compressed files after the file is transferred on &lt;a href=&quot;https://github.com/apache/cassandra/blob/9c8ee4c73f4e4e8d5b7693d34a0d6d6397418e90/src/java/org/apache/cassandra/streaming/StreamSession.java#L574&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;StreamSession.fileSent(FileMessageHeader)&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Patch and tests available below:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.7&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.7...pauloricardomg:3.7-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.7-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.7-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Would you mind reviewing &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt;? Thanks in advance!&lt;/p&gt;

&lt;p&gt;commit info: minor conflicts all the way up to 3.7 that merges cleanly to trunk&lt;/p&gt;</comment>
                            <comment id="15318774" author="yukim" created="Tue, 7 Jun 2016 16:13:10 +0000"  >&lt;p&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-11345-testall/lastCompletedBuild/testReport/org.apache.cassandra.streaming/StreamTransferTaskTest/testScheduleTimeout/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;StreamTransferTaskTest is failing.&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I think this is due to &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/blob/d2784f0bab9b629aead1625d28955cc513be2e79/src/java/org/apache/cassandra/streaming/messages/OutgoingFileMessage.java#L124&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;opposite check here&lt;/a&gt;. Shouldn&apos;t it be &lt;tt&gt;if (transferring)&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="15342067" author="pauloricardomg" created="Tue, 21 Jun 2016 16:06:37 +0000"  >&lt;p&gt;It was just a test cleanup problem (since before there was only one test in the suite), so I added a tearDown step, rebased and resubmitted tests:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15366355" author="yukim" created="Thu, 7 Jul 2016 16:23:04 +0000"  >&lt;p&gt;Thanks for update. One more thing I want to discuss is that I think we can calculate &lt;tt&gt;size()&lt;/tt&gt; at constructor and cache it to &lt;tt&gt;final long size&lt;/tt&gt;. &lt;tt&gt;size()&lt;/tt&gt; can be called at anytime from several thread so it seems safer that way.&lt;/p&gt;</comment>
                            <comment id="15388870" author="pauloricardomg" created="Fri, 22 Jul 2016 04:12:37 +0000"  >&lt;p&gt;Thanks for the review. I updated the patch to cache the transfer size during &lt;tt&gt;FileMessageHeader&lt;/tt&gt; construction.&lt;/p&gt;

&lt;p&gt;Since this is mostly a consequence &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11839&quot; title=&quot;Active streams fail with SocketTimeoutException&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11839&quot;&gt;&lt;del&gt;CASSANDRA-11839&lt;/del&gt;&lt;/a&gt;, which was mitigated by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-11840&quot; title=&quot;Set a more conservative default to streaming_socket_timeout_in_ms&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-11840&quot;&gt;&lt;del&gt;CASSANDRA-11840&lt;/del&gt;&lt;/a&gt; on 2.1, I think we can commit this only to 2.2+. WDYT?&lt;/p&gt;

&lt;p&gt;New patch and CI result available below:&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.1&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;2.2&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.0&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;3.9&lt;/th&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.1...pauloricardomg:2.1-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-2.2...pauloricardomg:2.2-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.0...pauloricardomg:3.0-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/cassandra-3.9...pauloricardomg:3.9-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...pauloricardomg:trunk-11345&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.9-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-11345-testall/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testall&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.1-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-2.2-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.0-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-3.9-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;http://cassci.datastax.com/view/Dev/view/paulomotta/job/pauloricardomg-trunk-11345-dtest/lastCompletedBuild/testReport/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="15406966" author="yukim" created="Thu, 4 Aug 2016 01:41:16 +0000"  >&lt;p&gt;3.9/trunk branch do not compile newly added unit test. (see github comment.)&lt;br/&gt;
I wonder why tests were running on CI though.&lt;/p&gt;</comment>
                            <comment id="15407707" author="pauloricardomg" created="Thu, 4 Aug 2016 13:03:40 +0000"  >&lt;p&gt;Fixed nit, CI results look good now. I think tests were from the previous rebase or dtests do not compile unit tests (where the compilation error was).&lt;/p&gt;</comment>
                            <comment id="15407835" author="yukim" created="Thu, 4 Aug 2016 14:19:30 +0000"  >&lt;p&gt;Thanks, committed to 2.2+ as &lt;tt&gt;03985212644112d2751cdabc72bd954dda9ff3ba&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15420847" author="pauloricardomg" created="Mon, 15 Aug 2016 11:01:45 +0000"  >&lt;p&gt;if a file starts transferring right after a stream session is aborted, it may cause the sstable ref to be released twice (once when the session is aborted, another when the file finishes transfer), causing the following exception (reproduce in this &lt;a href=&quot;https://cassci.datastax.com/view/Parameterized/job/parameterized_dtest_multiplexer/244/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;multiplexer run&lt;/a&gt; for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10810&quot; title=&quot;Make rebuild operations resumable&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10810&quot;&gt;&lt;del&gt;CASSANDRA-10810&lt;/del&gt;&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR [STREAM-OUT-/127.0.0.3] 2016-08-12 05:36:20,278 Ref.java:196 - BAD RELEASE: attempted to release a reference (org.apache.cassandra.utils.concurrent.Ref$State@62ddd804) that has already been released
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Simple fix is to fail-fast if start transferring an already completed &lt;tt&gt;OutgoingFileMessage&lt;/tt&gt;. I submitted &lt;a href=&quot;https://cassci.datastax.com/view/Parameterized/job/parameterized_dtest_multiplexer/247/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;another multiplexer run&lt;/a&gt; with &lt;a href=&quot;https://github.com/pauloricardomg/cassandra/commit/a932d66cf68046c732103d88c5b5f150f8d58553&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this fix&lt;/a&gt; and it passed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=yukim&quot; class=&quot;user-hover&quot; rel=&quot;yukim&quot;&gt;yukim&lt;/a&gt; coul you have a quick look and if it looks good ninja this fix as a complement to the original commit? Thanks!&lt;/p&gt;</comment>
                            <comment id="15421253" author="yukim" created="Mon, 15 Aug 2016 16:51:57 +0000"  >&lt;p&gt;Thanks, committed follow up as &lt;tt&gt;88b3cfc3b6b4417a913a512b461897378b48c039&lt;/tt&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12985753">CASSANDRA-12113</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12756491">CASSANDRA-8343</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[pauloricardomg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 14 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2ujl3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334273">2.1.13</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>yukim</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>