<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:28:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3579] AssertionError in hintedhandoff - 1.0.5</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3579</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We are running a 8 node cassandra cluster running cassandra 1.0.5.&lt;br/&gt;
All our CF use leveled compaction.  We ran a test where we did a lot&lt;br/&gt;
of inserts for 3 days. After that we started to run tests where some&lt;br/&gt;
of the reads could ask for information that was inserted a while back.&lt;br/&gt;
In this scenario we are seeing this assertion error in HintedHandoff.&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:3&amp;#93;&lt;/span&gt; 2011-12-05 15:42:04,324&lt;br/&gt;
AbstractCassandraDaemon.java (line 133) Fatal exception in thread&lt;br/&gt;
Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:3,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: java.lang.RuntimeException:&lt;br/&gt;
java.util.concurrent.ExecutionException: java.lang.AssertionError:&lt;br/&gt;
originally calculated column size of 470937164 but now it is 470294247&lt;br/&gt;
       at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:34)&lt;br/&gt;
       at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
       at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
Caused by: java.lang.RuntimeException:&lt;br/&gt;
java.util.concurrent.ExecutionException: java.lang.AssertionError:&lt;br/&gt;
originally calculated column size of 470937164 but now it is 470294247&lt;br/&gt;
       at org.apache.cassandra.db.HintedHandOffManager.deliverHintsToEndpoint(HintedHandOffManager.java:330)&lt;br/&gt;
       at org.apache.cassandra.db.HintedHandOffManager.access$100(HintedHandOffManager.java:81)&lt;br/&gt;
       at org.apache.cassandra.db.HintedHandOffManager$2.runMayThrow(HintedHandOffManager.java:353)&lt;br/&gt;
       at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
       ... 3 more&lt;br/&gt;
Caused by: java.util.concurrent.ExecutionException:&lt;br/&gt;
java.lang.AssertionError: originally calculated column size of&lt;br/&gt;
470937164 but now it is 470294247&lt;br/&gt;
       at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)&lt;br/&gt;
       at java.util.concurrent.FutureTask.get(FutureTask.java:83)&lt;br/&gt;
       at org.apache.cassandra.db.HintedHandOffManager.deliverHintsToEndpoint(HintedHandOffManager.java:326)&lt;br/&gt;
       ... 6 more&lt;br/&gt;
Caused by: java.lang.AssertionError: originally calculated column size&lt;br/&gt;
of 470937164 but now it is 470294247&lt;br/&gt;
       at org.apache.cassandra.db.compaction.LazilyCompactedRow.write(LazilyCompactedRow.java:124)&lt;br/&gt;
       at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:160)&lt;br/&gt;
       at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:158)&lt;br/&gt;
       at org.apache.cassandra.db.compaction.CompactionManager$6.call(CompactionManager.java:275)&lt;br/&gt;
       at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
       at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
       ... 3 more&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:3&amp;#93;&lt;/span&gt; 2011-12-05 15:42:04,333&lt;br/&gt;
AbstractCassandraDaemon.java (line 133) Fatal exception in thread&lt;br/&gt;
Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:3,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: java.lang.RuntimeException:&lt;br/&gt;
java.util.concurrent.ExecutionException: java.lang.AssertionError:&lt;br/&gt;
originally calculated column size of 470937164 but now it is 470294247&lt;br/&gt;
       at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:34)&lt;br/&gt;
       at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
       at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
Caused by: java.lang.RuntimeException:&lt;br/&gt;
java.util.concurrent.ExecutionException: java.lang.AssertionError:&lt;br/&gt;
originally calculated column size of 470937164 but now it is 470294247&lt;br/&gt;
       at org.apache.cassandra.db.HintedHandOffManager.deliverHintsToEndpoint(HintedHandOffManager.java:330)&lt;br/&gt;
       at org.apache.cassandra.db.HintedHandOffManager.access$100(HintedHandOffManager.java:81)&lt;br/&gt;
       at org.apache.cassandra.db.HintedHandOffManager$2.runMayThrow(HintedHandOffManager.java:353)&lt;br/&gt;
       at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
       ... 3 more&lt;br/&gt;
Caused by: java.util.concurrent.ExecutionException:&lt;br/&gt;
java.lang.AssertionError: originally calculated column size of&lt;br/&gt;
470937164 but now it is 470294247&lt;br/&gt;
       at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)&lt;br/&gt;
       at java.util.concurrent.FutureTask.get(FutureTask.java:83)&lt;br/&gt;
       at org.apache.cassandra.db.HintedHandOffManager.deliverHintsToEndpoint(HintedHandOffManager.java:326)&lt;br/&gt;
       ... 6 more&lt;br/&gt;
Caused by: java.lang.AssertionError: originally calculated column size&lt;br/&gt;
of 470937164 but now it is 470294247&lt;br/&gt;
       at org.apache.cassandra.db.compaction.LazilyCompactedRow.write(LazilyCompactedRow.java:124)&lt;br/&gt;
       at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:160)&lt;br/&gt;
       at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:158)&lt;br/&gt;
       at org.apache.cassandra.db.compaction.CompactionManager$6.call(CompactionManager.java:275)&lt;br/&gt;
       at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
       at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
       ... 3 more&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:9931&amp;#93;&lt;/span&gt; 2011-12-05 15:42:04,333&lt;br/&gt;
AbstractCassandraDaemon.java (line 133) Fatal exception in thread&lt;br/&gt;
Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:9931,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError: originally calculated column size of&lt;br/&gt;
470937164 but now it is 470294247&lt;br/&gt;
       at org.apache.cassandra.db.compaction.LazilyCompactedRow.write(LazilyCompactedRow.java:124)&lt;br/&gt;
       at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:160)&lt;br/&gt;
       at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:158)&lt;br/&gt;
       at org.apache.cassandra.db.compaction.CompactionManager$6.call(CompactionManager.java:275)&lt;br/&gt;
       at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
       at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
       at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
       at java.lang.Thread.run(Thread.java:662)&lt;/p&gt;</description>
                <environment>&lt;p&gt;RHEL 6.1 64 bit, 32 GB RAM, 8 GB allocated to JVM, running XFS filesystem for commit/data directories&lt;/p&gt;</environment>
        <key id="12534022">CASSANDRA-3579</key>
            <summary>AssertionError in hintedhandoff - 1.0.5</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="ramesh25">Ramesh Natarajan</reporter>
                        <labels>
                    </labels>
                <created>Tue, 6 Dec 2011 13:11:23 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:45 +0000</updated>
                            <resolved>Wed, 11 Jan 2012 19:53:32 +0000</resolved>
                                        <fixVersion>1.0.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13164041" author="maedhroz" created="Wed, 7 Dec 2011 01:31:26 +0000"  >&lt;p&gt;FWIW, I&apos;ve seen the same error when bringing a node back up after a brief (5 minute) down-time.&lt;/p&gt;

&lt;p&gt;ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:3&amp;#93;&lt;/span&gt; 2011-12-06 16:42:58,822 AbstractCassandraDaemon.java (line 133) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:3,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError&lt;br/&gt;
        at org.apache.cassandra.db.HintedHandOffManager.deliverHintsToEndpoint(HintedHandOffManager.java:301)&lt;br/&gt;
        at org.apache.cassandra.db.HintedHandOffManager.access$100(HintedHandOffManager.java:81)&lt;br/&gt;
        at org.apache.cassandra.db.HintedHandOffManager$2.runMayThrow(HintedHandOffManager.java:353)&lt;br/&gt;
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:722)&lt;/p&gt;</comment>
                            <comment id="13164075" author="jbellis" created="Wed, 7 Dec 2011 02:31:02 +0000"  >&lt;p&gt;Caleb, your assertion means you had some hint corruption from 1.0.0 (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3466&quot; title=&quot;Hinted handoff not working after rolling upgrade from 0.8.7 to 1.0.2&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3466&quot;&gt;&lt;del&gt;CASSANDRA-3466&lt;/del&gt;&lt;/a&gt;).  You should remove your Hint column families from the system/ keyspace.&lt;/p&gt;</comment>
                            <comment id="13165318" author="jbellis" created="Thu, 8 Dec 2011 16:44:38 +0000"  >&lt;p&gt;Ramesh, are you using counters?  If so, this may be the same as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3481&quot; title=&quot;During repair, &amp;quot;incorrect data size&amp;quot; &amp;amp; &amp;quot;Connection reset&amp;quot; errors. Repair unable to complete.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3481&quot;&gt;&lt;del&gt;CASSANDRA-3481&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="13165536" author="ramesh25" created="Thu, 8 Dec 2011 20:37:00 +0000"  >&lt;p&gt;No we are not using counters.&lt;/p&gt;</comment>
                            <comment id="13173334" author="cumarana" created="Tue, 20 Dec 2011 17:30:23 +0000"  >&lt;p&gt;I ran into this problem as well. I don&apos;t know if it is related, but I started to see Gossip errors for the node being down and up constantly even when I&apos;m not writing to Cassandra. Restarting Cassandra fixed the problem.&lt;/p&gt;


&lt;p&gt;INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:648&amp;#93;&lt;/span&gt; 2011-12-19 20:41:17,399 CompactionController.java (line 133) Compacting large row system/HintsColumnFamily:&lt;br/&gt;
77777777777777777777777777777770 (73427721 bytes) incrementally  INFO &lt;span class=&quot;error&quot;&gt;&amp;#91;FlushWriter:99&amp;#93;&lt;/span&gt; 2011-12-19 20:41:17,410 Memtable.java (line 275) Completed flushing /data/data/system/HintsColumnFamily-hb-141-Data&lt;br/&gt;
.db (3022 bytes)&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;CompactionExecutor:648&amp;#93;&lt;/span&gt; 2011-12-19 20:41:19,445 AbstractCassandraDaemon.java (line 133) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;Compaction Executor:648,1,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.AssertionError: originally calculated column size of 66102951 but now it is 66009419&lt;br/&gt;
        at org.apache.cassandra.db.compaction.LazilyCompactedRow.write(LazilyCompactedRow.java:124)&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:160)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:158)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager$6.call(CompactionManager.java:275)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
ERROR &lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:1&amp;#93;&lt;/span&gt; 2011-12-19 20:41:19,445 AbstractCassandraDaemon.java (line 133) Fatal exception in thread Thread&lt;span class=&quot;error&quot;&gt;&amp;#91;HintedHandoff:1,1 ,main&amp;#93;&lt;/span&gt;&lt;br/&gt;
java.lang.RuntimeException: java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.AssertionError: originally calc ulated column size of 66102951 but now it is 66009419&lt;br/&gt;
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:34)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:662)&lt;br/&gt;
Caused by: java.lang.RuntimeException: java.util.concurrent.ExecutionException: java.lang.AssertionError: originally calculated column siz e of 66102951 but now it is 66009419&lt;br/&gt;
        at org.apache.cassandra.db.HintedHandOffManager.deliverHintsToEndpoint(HintedHandOffManager.java:330)&lt;br/&gt;
        at org.apache.cassandra.db.HintedHandOffManager.access$100(HintedHandOffManager.java:81)&lt;br/&gt;
    at org.apache.cassandra.db.HintedHandOffManager.access$100(HintedHandOffManager.java:81)&lt;br/&gt;
        at org.apache.cassandra.db.HintedHandOffManager$2.runMayThrow(HintedHandOffManager.java:353)&lt;br/&gt;
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:30)&lt;br/&gt;
        ... 3 more&lt;br/&gt;
Caused by: java.util.concurrent.ExecutionException: java.lang.AssertionError: originally calculated column size of 66102951 but now it is66009419&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:222)&lt;br/&gt;
        at java.util.concurrent.FutureTask.get(FutureTask.java:83)&lt;br/&gt;
        at org.apache.cassandra.db.HintedHandOffManager.deliverHintsToEndpoint(HintedHandOffManager.java:326)&lt;br/&gt;
        ... 6 more&lt;br/&gt;
Caused by: java.lang.AssertionError: originally calculated column size of 66102951 but now it is 66009419&lt;br/&gt;
        at org.apache.cassandra.db.compaction.LazilyCompactedRow.write(LazilyCompactedRow.java:124)&lt;br/&gt;
        at org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:160)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionTask.execute(CompactionTask.java:158)&lt;br/&gt;
        at org.apache.cassandra.db.compaction.CompactionManager$6.call(CompactionManager.java:275)&lt;br/&gt;
        at java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:303)&lt;br/&gt;
        at java.util.concurrent.FutureTask.run(FutureTask.java:138)&lt;br/&gt;
        ... 3 more&lt;/p&gt;
</comment>
                            <comment id="13176737" author="jbellis" created="Wed, 28 Dec 2011 18:16:31 +0000"  >&lt;p&gt;The fact that all these stack traces show that the row size got &lt;b&gt;smaller&lt;/b&gt;, and that HH sets a time to live on its hints starting with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2034&quot; title=&quot;Make Read Repair unnecessary when Hinted Handoff is enabled&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2034&quot;&gt;&lt;del&gt;CASSANDRA-2034&lt;/del&gt;&lt;/a&gt;, makes me suspect that somehow columns are expiring in between the first and second LCR passes.  But I don&apos;t see anything obviously wrong with how we are using controller.gcBefore to theoretically prevent that.&lt;/p&gt;</comment>
                            <comment id="13179412" author="slebresne" created="Wed, 4 Jan 2012 11:03:32 +0000"  >&lt;p&gt;I believe I know what is going on. This is bug with CF having gc_grace == 0 (which hints have). The problem lies in the following line of removeDeleted:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if ((c.isMarkedForDelete() &amp;amp;&amp;amp; c.getLocalDeletionTime() &amp;lt;= gcBefore)
    || c.timestamp() &amp;lt;= cf.getMarkedForDeleteAt())
{
    iter.remove();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and more precisely the first condition. When that is executed, we have gcbefore &amp;lt;= now but we &lt;b&gt;can&lt;/b&gt; have gcbefore == now if gc_grace == 0 (and since the resolution is the second, it&apos;s not even a very unlikely race).&lt;/p&gt;

&lt;p&gt;Now for expiring columns it is further possible that localExpirationTime == gcbefore == now. When that happens, c.isMarkedForDelete() will return false (thus the column will be kept) because this method is defined as:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;public boolean isMarkedForDelete()
{
    return (int) (System.currentTimeMillis() / 1000 ) &amp;gt; localExpirationTime;
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;However, during the second pass, now has changed and it is possible that we have now &amp;gt; gcbefore. But since gcbefore == localExpirationTime, this means that isMarkedForDelete() will be true &lt;b&gt;and&lt;/b&gt; getLocalDeletionTime() &amp;lt;= gcbefore, so the column will be considered tombstone and gcable.&lt;/p&gt;

&lt;p&gt;In other word, the current code does not respect the condition that at all time a column is considered gcable only if it is considered deleted.&lt;/p&gt;

&lt;p&gt;A rather simple fix consist in changing the condition in removeDeleted to be&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;if ((c.isMarkedForDelete() &amp;amp;&amp;amp; c.getLocalDeletionTime() &amp;lt; gcBefore)
    || c.timestamp() &amp;lt;= cf.getMarkedForDeleteAt())
{
    iter.remove();
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Note the strict lesser than operator for the first condition. It fixes it because since we know that we always have gcbefore &amp;lt;= now, localExpirationTime &amp;lt; gcBefore always imply that isMarkedForDelete() is true.&lt;/p&gt;

&lt;p&gt;Attached patch to make that fix (with hopefully useful comments).&lt;/p&gt;</comment>
                            <comment id="13180946" author="jbellis" created="Thu, 5 Jan 2012 23:30:30 +0000"  >&lt;p&gt;I think this change is an improvement, and I also think it&apos;s a good thing to make the semantics of gcBefore match what its name implies, i.e., we collect tombstones from &lt;b&gt;before&lt;/b&gt; that epoch and not before-or-equal-to, but:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;It&apos;s slightly more intuitive for 0 gcgs to mean &quot;this is always gc&apos;d immediately,&quot; not &quot;gc&apos;d after one second.&quot;  In practice, I can&apos;t see how this could matter, but it does bother my OCD. &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/li&gt;
	&lt;li&gt;A search for &amp;lt; gcBefore, &amp;lt;= gcBefore, &amp;gt; gcBefore, &amp;gt;= gcBefore shows some of each.  We&apos;re not consistent in whether we treat it as before or before-or-equal-to, and we need to be.&lt;/li&gt;
	&lt;li&gt;The isMarkedForDelete behavior you point out scares me, because that&apos;s going to change during the two LCR passes as well.  I suspect that&apos;s going to cause subtle bugs if we don&apos;t create a fixed point in time for which we treat a compaction as happening.  (Maybe just replace controller.gcBefore with controller.compactionTime and derive gcBefore from that as a method, instead of a field.)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13180950" author="jbellis" created="Thu, 5 Jan 2012 23:32:16 +0000"  >&lt;p&gt;We have the same problem in 0.7 and 0.8 for any CF with 0 gcgs.  For those versions IMO we should just say &quot;don&apos;t do that.&quot;&lt;/p&gt;</comment>
                            <comment id="13181206" author="slebresne" created="Fri, 6 Jan 2012 08:57:16 +0000"  >&lt;blockquote&gt;&lt;p&gt;It&apos;s slightly more intuitive for 0 gcgs to mean &quot;this is always gc&apos;d immediately,&quot;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;True, though gc is more a an internal detail in that it doesn&apos;t affect whether a column is returned by queries or not. It only affect whether it will be removed by a compaction, but that is already so dependent of other timings than it cannot matter. Or to put it otherwise, that one doesn&apos;t bother my own OCD. But it doesn&apos;t really bother me either if gcBefore means before-or-equal so ...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;A search for &amp;lt; gcBefore, &amp;lt;= gcBefore, &amp;gt; gcBefore, &amp;gt;= gcBefore shows some of each.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;One of the goal of this patch was to actually adds consistency and I though I had eliminated all &apos;&amp;lt;=&apos; but maybe I missed one. I forgot to search for &apos;&amp;gt;&apos; and &apos;&amp;gt;=&apos; however. I&apos;ll fix.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The isMarkedForDelete behavior you point out scares me, because that&apos;s going to change during the two LCR passes as well. I suspect that&apos;s going to cause subtle bugs if we don&apos;t create a fixed point in time for which we treat a compaction as happening. (Maybe just replace controller.gcBefore with controller.compactionTime and derive gcBefore from that as a method, instead of a field.)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s an option, and it was even my first idea. But it means that isMarkedForDelete will take a timestamp, and it&apos;s called a lot in the code base. That and the other related change, I&apos;d be tempted to commit the patch as is for 1.0 and maybe do the switch to &apos;compactionTime&apos; for 1.1 onward.&lt;/p&gt;</comment>
                            <comment id="13181653" author="jbellis" created="Fri, 6 Jan 2012 22:30:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;d be tempted to commit the patch as is for 1.0 and maybe do the switch to &apos;compactionTime&apos; for 1.1 onward&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;All right, for 1.0 let&apos;s just audit for &amp;gt; &amp;gt;= gcBefore correctness.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;isMarkedForDelete will take a timestamp, and it&apos;s called a lot in the code base&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The more I think about it the less I like &quot;boolean isMarkedForDelete()&quot;...  I like &quot;getExpirationTime()&quot; a lot better.  That allows combining iMFD and getLDT into a single method (that can return Integer.MAX_VALUE for Column) that doesn&apos;t need any parameters, but doesn&apos;t change value during compaction.&lt;/p&gt;</comment>
                            <comment id="13181658" author="jbellis" created="Fri, 6 Jan 2012 22:39:32 +0000"  >&lt;p&gt;v2 changes two &amp;gt;= instances to &amp;gt;.&lt;/p&gt;</comment>
                            <comment id="13182628" author="slebresne" created="Mon, 9 Jan 2012 16:58:12 +0000"  >&lt;p&gt;+1 on v2, committed on 1.0 branch. How do we merge --record-only with git again?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The more I think about it the less I like &quot;boolean isMarkedForDelete()&quot;... I like &quot;getExpirationTime()&quot; a lot better.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed, that&apos;s much cleaner. I&apos;ll do that for 1.1.&lt;/p&gt;</comment>
                            <comment id="13182638" author="jbellis" created="Mon, 9 Jan 2012 17:12:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;How do we merge --record-only with git again&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The closest I found is &lt;tt&gt;git merge X --strategy=ours&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="13183408" author="jbellis" created="Tue, 10 Jan 2012 17:37:17 +0000"  >&lt;p&gt;Created &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3716&quot; title=&quot;Clean up isMarkedForDelete / getLocalDeletionTime&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3716&quot;&gt;&lt;del&gt;CASSANDRA-3716&lt;/del&gt;&lt;/a&gt; for the 1.1 followup&lt;/p&gt;</comment>
                            <comment id="13184292" author="jbellis" created="Wed, 11 Jan 2012 19:09:28 +0000"  >&lt;p&gt;this is causing the SystemTableTest failure mentioned in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3727&quot; title=&quot;Fix unit tests failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3727&quot;&gt;&lt;del&gt;CASSANDRA-3727&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13184314" author="jbellis" created="Wed, 11 Jan 2012 19:41:32 +0000"  >&lt;p&gt;Switching from &amp;lt;= to &amp;lt; means that getColumnFamily will now include tombstones for just-deleted column with gcgs == 0.&lt;/p&gt;

&lt;p&gt;For clients this is harmless (since we drop tombstones in the coordinator after RR), but internal code needs to be more careful.  patch attached to have loadTokens expunge all tombstones.&lt;/p&gt;</comment>
                            <comment id="13184323" author="slebresne" created="Wed, 11 Jan 2012 19:48:49 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13184327" author="jbellis" created="Wed, 11 Jan 2012 19:53:32 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12510227" name="3579-fix-text.txt" size="849" author="jbellis" created="Wed, 11 Jan 2012 19:41:32 +0000"/>
                            <attachment id="12509729" name="3579-v2.txt" size="5509" author="jbellis" created="Fri, 6 Jan 2012 22:39:32 +0000"/>
                            <attachment id="12509396" name="3579.patch" size="4034" author="slebresne" created="Wed, 4 Jan 2012 11:03:32 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>219748</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 45 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0glnb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>94937</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>