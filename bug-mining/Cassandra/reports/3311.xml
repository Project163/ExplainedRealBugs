<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:09 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7016] Allow mixing token and partition key restrictions</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7016</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;select ... where token(k) &amp;lt; x and token(k) &amp;gt;= y and k in (a,b) allow filtering;&lt;/p&gt;

&lt;p&gt;This fails on 2.0.6: can&apos;t restrict k by more than one relation.&lt;/p&gt;

&lt;p&gt;In the context of map/reduce (hence the token range) I want to map over only a subset of the keys (hence the &apos;in&apos;).  Pushing the &apos;in&apos; filter down to cql is substantially cheaper than pulling all rows to the client and then discarding most of them.&lt;/p&gt;

&lt;p&gt;Currently this is possible only if the hadoop integration code is altered to apply the AND on the client side and use cql that contains only the resulting filtered &apos;in&apos; set.  The problem is not hadoop specific though, so IMO it should really be solved in cql not the hadoop integration code.&lt;/p&gt;

&lt;p&gt;Most restrictions on cql syntax seem to exist to prevent unduly expensive queries. This one seems to be doing the opposite.&lt;/p&gt;

&lt;p&gt;Edit: on further thought and with reference to the code in SelectStatement$RawStatement, it seems to me that  token(k) and k should be considered distinct entities for the purposes of processing restrictions. That is, no restriction on the token should conflict with a restriction on the raw key. That way any monolithic query in terms of k and be decomposed into parallel chunks over the token range for the purposes of map/reduce processing simply by appending a &apos;and where token(k)...&apos; clause to the exiting &apos;where k ...&apos;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12707429">CASSANDRA-7016</key>
            <summary>Allow mixing token and partition key restrictions</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="jhalliday">Jonathan Halliday</reporter>
                        <labels>
                            <label>cql</label>
                            <label>docs</label>
                    </labels>
                <created>Wed, 9 Apr 2014 12:43:16 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:49 +0000</updated>
                            <resolved>Wed, 7 Jan 2015 20:09:11 +0000</resolved>
                                        <fixVersion>2.2.0 beta 1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14103820" author="blerer" created="Wed, 20 Aug 2014 12:41:24 +0000"  >&lt;p&gt;I forgot to modify the SelectStatement execute method in the previous patch. &lt;/p&gt;</comment>
                            <comment id="14109112" author="slebresne" created="Mon, 25 Aug 2014 13:39:47 +0000"  >&lt;p&gt;A few remarks:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;We should move the job of &lt;tt&gt;mergeKeyRestrictions&lt;/tt&gt; to the beginning of the loop of &lt;tt&gt;processPartitionKeyRestrictions&lt;/tt&gt;. No reason to incur this on each execution (versus once a preparation time), and it&apos;ll avoid the multiple inlining of &lt;tt&gt;stmt.keyRestrictions[i]&lt;/tt&gt; inside the loop.&lt;/li&gt;
	&lt;li&gt;In TokenFilter, we shouldn&apos;t use &lt;tt&gt;ByteBuffer&lt;/tt&gt; comparison but &lt;tt&gt;Token&lt;/tt&gt; comparison (so we should have a RangeSet&amp;lt;Token&amp;gt;, etc...).&lt;/li&gt;
	&lt;li&gt;In the test, I&apos;d have a preference for reducing the number of test functions by merging those that apply to the same table (especially since we&apos;re only testing selects). Re-creating the table for every test adds up to the test running time which is pretty long already. Plus, I personally find that 5 lines of clutter for every one true line of test is a bit excessive, and reducing the number of test methods cuts that down. Note that I understand that having multiple test lines in the same test function mean that an early failure will &quot;hide&quot; following ones, but since the number of acceptable test failures is 0 anyway, I consider that readability and execution times is more important.&lt;/li&gt;
	&lt;li&gt;Regarding the test, you also don&apos;t need to have 2 tests like:
 &lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt; execute(&quot;SELECT * FROM %s WHERE token(a) &amp;gt; token(?)&quot;, 2)
 execute(&quot;SELECT * FROM %s WHERE token(a) &amp;gt; token(2)&quot;)
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt; The first form is enough, CQLTester is smart enough to generate the 2nd form automatically. This also mean that ideally all statements would have the first &quot;prepared&quot; form (so we get both prepared and non-prepared tests for free).&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14113615" author="blerer" created="Thu, 28 Aug 2014 09:43:46 +0000"  >&lt;p&gt;The patch fix the previously mentioned issues and fix also the fact that the previous solution was not working properly with partition key on multiple columns.&lt;/p&gt;</comment>
                            <comment id="14129188" author="blerer" created="Wed, 10 Sep 2014 21:50:53 +0000"  >&lt;p&gt;The patch is not working currently for cases like:&lt;br/&gt;
1) CREATE TABLE %s (a int, b int, c int, primary key (a, b)) with&lt;br/&gt;
CREATE INDEX test on %s (c)&lt;br/&gt;
and a query like SELECT * FROM %s WHERE a = 0 and c = 0; &lt;/p&gt;

&lt;p&gt;2) CREATE TABLE %s (a int, b int, c int, primary key((a,b)) with &lt;br/&gt;
CREATE INDEX test on %s (c)&lt;br/&gt;
and a query like SELECT * FROM %s WHERE b = 0 and c =0; &lt;/p&gt;
</comment>
                            <comment id="14250612" author="blerer" created="Wed, 17 Dec 2014 21:39:59 +0000"  >&lt;p&gt;The patch introduce a new &lt;tt&gt;PrimaryKeyRestrictions&lt;/tt&gt; called &lt;tt&gt;TokenFilter&lt;/tt&gt; that allow to merge token and non token restrictions for the partition key.&lt;br/&gt;
The patch has been made for trunk as &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7981&quot; title=&quot;Refactor SelectStatement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7981&quot;&gt;&lt;del&gt;CASSANDRA-7981&lt;/del&gt;&lt;/a&gt;was a prerequisite to make the patch work for all the possible queries.&lt;/p&gt;</comment>
                            <comment id="14263185" author="thobbs" created="Fri, 2 Jan 2015 19:54:05 +0000"  >&lt;p&gt;Overall the patch looks good.&lt;/p&gt;

&lt;p&gt;There&apos;s one bug, though: if the two ends of a token range are equal, you&apos;ll get an error like the following:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;SELECT * FROM system.schema_columns WHERE token(keyspace_name) &amp;gt; token(&apos;abc&apos;) AND token(keyspace_name) &amp;lt; token(&apos;abc&apos;) AND keyspace_name IN (&apos;system&apos;, &apos;system_traces&apos;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ERROR 18:59:53 Unexpected exception during request
java.lang.IllegalArgumentException: Invalid range: (-5434086359492102041&#8229;-5434086359492102041)
	at com.google.common.collect.Range.&amp;lt;init&amp;gt;(Range.java:363) ~[guava-16.0.jar:na]
	at com.google.common.collect.Range.create(Range.java:153) ~[guava-16.0.jar:na]
	at com.google.common.collect.Range.range(Range.java:226) ~[guava-16.0.jar:na]
	at org.apache.cassandra.cql3.restrictions.TokenFilter.toRangSet(TokenFilter.java:197) ~[main/:na]
	at org.apache.cassandra.cql3.restrictions.TokenFilter.filter(TokenFilter.java:133) ~[main/:na]
	at org.apache.cassandra.cql3.restrictions.TokenFilter.values(TokenFilter.java:82) ~[main/:na]
	at org.apache.cassandra.cql3.restrictions.StatementRestrictions.getPartitionKeys(StatementRestrictions.java:361) ~[main/:na]
	at org.apache.cassandra.cql3.statements.SelectStatement.getSliceCommands(SelectStatement.java:296) ~[main/:na]
	at org.apache.cassandra.cql3.statements.SelectStatement.getPageableCommand(SelectStatement.java:205) ~[main/:na]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:165) ~[main/:na]
	at org.apache.cassandra.cql3.statements.SelectStatement.execute(SelectStatement.java:72) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.processStatement(QueryProcessor.java:239) ~[main/:na]
	at org.apache.cassandra.cql3.QueryProcessor.process(QueryProcessor.java:261) ~[main/:na]
	at org.apache.cassandra.transport.messages.QueryMessage.execute(QueryMessage.java:118) ~[main/:na]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:439) [main/:na]
	at org.apache.cassandra.transport.Message$Dispatcher.channelRead0(Message.java:335) [main/:na]
	at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:333) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext.access$700(AbstractChannelHandlerContext.java:32) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at io.netty.channel.AbstractChannelHandlerContext$8.run(AbstractChannelHandlerContext.java:324) [netty-all-4.0.23.Final.jar:4.0.23.Final]
	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) [na:1.7.0_40]
	at org.apache.cassandra.concurrent.AbstractTracingAwareExecutorService$FutureTask.run(AbstractTracingAwareExecutorService.java:164) [main/:na]
	at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:105) [main/:na]
	at java.lang.Thread.run(Thread.java:724) [na:1.7.0_40]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Besides that, a few nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The params in the javadoc for &lt;tt&gt;TokenFilter.toRangeSet()&lt;/tt&gt; are incorrect&lt;/li&gt;
	&lt;li&gt;Whitespace is off in &lt;tt&gt;TokenFilter.filter()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;In &lt;tt&gt;TokenFilter.isOnToken()&lt;/tt&gt;, I think the comment and logic could be a little clearer.  It seems like the check could use &lt;tt&gt;&amp;lt;&lt;/tt&gt; instead of &lt;tt&gt;!=&lt;/tt&gt;, correct? Perhaps the comment should say something like &quot;if all partition key columns have non-token restrictions, we can simply use the token range to filter those restrictions and then ignore the token range&quot;.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="14264391" author="blerer" created="Mon, 5 Jan 2015 09:25:20 +0000"  >&lt;p&gt;This patch fixes the problems mentioned by Tyler&lt;/p&gt;</comment>
                            <comment id="14268138" author="thobbs" created="Wed, 7 Jan 2015 20:09:11 +0000"  >&lt;p&gt;+1, committed to trunk as 395ea63.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310040">
                    <name>Required</name>
                                            <outwardlinks description="requires">
                                        <issuelink>
            <issuekey id="12742677">CASSANDRA-7981</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12663121" name="CASSANDRA-7016-V2.txt" size="21886" author="blerer" created="Wed, 20 Aug 2014 12:41:24 +0000"/>
                            <attachment id="12664856" name="CASSANDRA-7016-V3.txt" size="27561" author="blerer" created="Thu, 28 Aug 2014 09:43:46 +0000"/>
                            <attachment id="12687831" name="CASSANDRA-7016-V4-trunk.txt" size="29868" author="blerer" created="Wed, 17 Dec 2014 21:39:59 +0000"/>
                            <attachment id="12690052" name="CASSANDRA-7016-V5-trunk.txt" size="31324" author="blerer" created="Mon, 5 Jan 2015 09:25:20 +0000"/>
                            <attachment id="12660668" name="CASSANDRA-7016.txt" size="21650" author="blerer" created="Fri, 8 Aug 2014 17:19:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>385752</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 45 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1ugcv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>386016</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>