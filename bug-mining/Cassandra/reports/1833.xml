<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:35:34 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4789] CassandraStorage.getNextWide produces corrupt data</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4789</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This took me a while to track down.  I&apos;m seeing the problem when the &quot;key changes&quot; case happens.  The intended behavior (as far as I can tell) when the key changes is the method returns the current tuple, and picks up where it left off on the next call to getNextWide().  The problem I&apos;m seeing is the sometimes the current key advances between method calls, sometimes not.  &quot;Not&quot; being the correct behavior, since the code is saving the value into an instance variable, but when the key advances there is a key/value mismatch (the result being the values for two different keys are being glued together).  I think the problem might be related to keys that only have a single column???  I&apos;m still trying to track that down to help assist in solving this case...&lt;/p&gt;

&lt;p&gt;Maybe this will be clearer from me pasting a bunch of logging I added to the class.  The log messages are fairly self documenting (I hope):  &lt;/p&gt;

&lt;p&gt;...lots of previous logging...&lt;br/&gt;
enter getNextWide&lt;br/&gt;
hasNext = true&lt;br/&gt;
set key = dVNhbXAxMzQ3ODM1OA%3D%3D&lt;br/&gt;
lastRow != null&lt;br/&gt;
added 1 items to bag from lastRow&lt;br/&gt;
added 1 items to bag from row&lt;br/&gt;
hasNext = true&lt;br/&gt;
added 1 items to bag from row&lt;br/&gt;
hasNext = true&lt;br/&gt;
added 1 items to bag from row&lt;br/&gt;
hasNext = true&lt;br/&gt;
added 1 items to bag from row&lt;br/&gt;
hasNext = true&lt;br/&gt;
added 1 items to bag from row&lt;br/&gt;
hasNext = true&lt;br/&gt;
added 1 items to bag from row&lt;br/&gt;
hasNext = true&lt;br/&gt;
added 1 items to bag from row&lt;br/&gt;
hasNext = true&lt;br/&gt;
added 1 items to bag from row&lt;br/&gt;
hasNext = true&lt;br/&gt;
key changed, new key = 669392df09572d0045b964bc65f86a2c&lt;br/&gt;
exit getNextWide&lt;br/&gt;
enter getNextWide&lt;br/&gt;
hasNext = true&lt;br/&gt;
//!!&lt;span class=&quot;error&quot;&gt;Unable to render embedded object: File (THIS IS THE PROBLEM HERE I THINK) not found.&lt;/span&gt;!!&lt;br/&gt;
//!!&lt;span class=&quot;error&quot;&gt;Unable to render embedded object: File (Usually the key here == key before &amp;quot;exit getNextWide&amp;quot;) not found.&lt;/span&gt;!!&lt;br/&gt;
set key = 5f900ee4bb1850f8cf387cc3d5fc23ca&lt;br/&gt;
//!!! lastRow is data for 669392df09572d0045b964bc65f86a2c !!! &lt;br/&gt;
//!!! but it&apos;s being added to key 5f900ee4bb1850f8cf387cc3d5fc23ca !!!&lt;br/&gt;
lastRow != null&lt;br/&gt;
added 1 items to bag from lastRow&lt;br/&gt;
//!!! Here are the real values for 5f900ee4bb1850f8cf387cc3d5fc23ca !!!&lt;br/&gt;
added 1 items to bag from row&lt;br/&gt;
hasNext = true&lt;br/&gt;
added 1 items to bag from row&lt;br/&gt;
hasNext = true&lt;br/&gt;
key changed, new key = 50438549-cdb6-8c44-f93a-d18d7daeffd8&lt;br/&gt;
exit getNextWide&lt;br/&gt;
enter getNextWide&lt;br/&gt;
hasNext = true&lt;br/&gt;
set key = 50438549-cdb6-8c44-f93a-d18d7daeffd8&lt;/p&gt;</description>
                <environment></environment>
        <key id="12611242">CASSANDRA-4789</key>
            <summary>CassandraStorage.getNextWide produces corrupt data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="oberman">Will Oberman</assignee>
                                    <reporter username="oberman">Will Oberman</reporter>
                        <labels>
                    </labels>
                <created>Wed, 10 Oct 2012 20:48:54 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:25 +0000</updated>
                            <resolved>Thu, 11 Oct 2012 19:01:22 +0000</resolved>
                                        <fixVersion>1.1.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13473550" author="oberman" created="Wed, 10 Oct 2012 20:50:12 +0000"  >&lt;p&gt;Apparently using !!! is some kind of special syntax, sorry.  I was just trying to distinguish my comments from my logging.&lt;/p&gt;</comment>
                            <comment id="13473559" author="oberman" created="Wed, 10 Oct 2012 21:05:22 +0000"  >&lt;p&gt;I&apos;m now 99% sure the problem is keys that map to a single column are being skipped over, and their values glued into the key after them.  But I&apos;m not sure the most elegant fix...&lt;/p&gt;</comment>
                            <comment id="13473582" author="jbellis" created="Wed, 10 Oct 2012 21:33:06 +0000"  >&lt;p&gt;Are you mutating the ByteBuffers returned by CFIF?  That could definitely produce this kind of problem.&lt;/p&gt;</comment>
                            <comment id="13474171" author="oberman" created="Thu, 11 Oct 2012 14:04:08 +0000"  >&lt;p&gt;It&apos;s definitely a problem using widerows=true and having keys that only map to one column.  Here is my patch on 1.1.5 (I also have a one line patch to fix the wide rows bug):&lt;/p&gt;

&lt;p&gt;112a113&lt;br/&gt;
&amp;gt;     private ByteBuffer lastKey;&lt;br/&gt;
116d116&lt;br/&gt;
&amp;lt; &lt;br/&gt;
153a154&lt;br/&gt;
&amp;gt; 			    //check key == lastKey?&lt;br/&gt;
159a161&lt;br/&gt;
&amp;gt; 			lastKey = null;&lt;br/&gt;
177a180&lt;br/&gt;
&amp;gt; 		    lastKey = (ByteBuffer)reader.getCurrentKey();&lt;br/&gt;
185a189,200&lt;br/&gt;
&amp;gt; 		    if(lastKey != null &amp;amp;&amp;amp; !(key.equals(lastKey))) // last key only had one value&lt;br/&gt;
&amp;gt; 		    {&lt;br/&gt;
&amp;gt; 			tuple.append(new DataByteArray(lastKey.array(), lastKey.position()+lastKey.arrayOffset(), lastKey.limit()+lastKey.arrayOffset()));&lt;br/&gt;
&amp;gt; 			for (Map.Entry&amp;lt;ByteBuffer, IColumn&amp;gt; entry : lastRow.entrySet())&lt;br/&gt;
&amp;gt; 			&lt;/p&gt;
{
&amp;gt; 			    bag.add(columnToTuple(entry.getValue(), cfDef, parseType(cfDef.getComparator_type())));
&amp;gt; 			}
&lt;p&gt;&amp;gt; 			tuple.append(bag);&lt;br/&gt;
&amp;gt; 			lastKey = key;&lt;br/&gt;
&amp;gt; 			lastRow = (SortedMap&amp;lt;ByteBuffer,IColumn&amp;gt;)reader.getCurrentValue();&lt;br/&gt;
&amp;gt; 			return tuple;&lt;br/&gt;
&amp;gt; 		    }&lt;br/&gt;
194a210&lt;br/&gt;
&amp;gt; 		    lastKey = null;&lt;br/&gt;
551c567&lt;br/&gt;
&amp;lt;             widerows = Boolean.valueOf(System.getProperty(PIG_WIDEROW_INPUT));&lt;br/&gt;
&amp;#8212;&lt;br/&gt;
&amp;gt;             widerows = Boolean.valueOf(System.getenv(PIG_WIDEROW_INPUT));&lt;/p&gt;</comment>
                            <comment id="13474205" author="brandon.williams" created="Thu, 11 Oct 2012 14:51:56 +0000"  >&lt;p&gt;Could you post your patches as attachments?&lt;/p&gt;</comment>
                            <comment id="13474207" author="oberman" created="Thu, 11 Oct 2012 14:55:09 +0000"  >&lt;p&gt;Sorry about that, new to this.&lt;/p&gt;</comment>
                            <comment id="13474212" author="brandon.williams" created="Thu, 11 Oct 2012 14:59:52 +0000"  >&lt;p&gt;Thanks, but this doesn&apos;t appear to be in patch format:&lt;/p&gt;

&lt;p&gt;patch: **** Only garbage was found in the patch input.&lt;/p&gt;</comment>
                            <comment id="13474217" author="oberman" created="Thu, 11 Oct 2012 15:02:29 +0000"  >&lt;p&gt;I don&apos;t really have a proper development environment for cassandra, so it&apos;s a diff of the file...  I&apos;ll see how to get something better going.&lt;/p&gt;</comment>
                            <comment id="13474232" author="oberman" created="Thu, 11 Oct 2012 15:22:05 +0000"  >&lt;p&gt;Does this work?&lt;/p&gt;</comment>
                            <comment id="13474233" author="brandon.williams" created="Thu, 11 Oct 2012 15:27:34 +0000"  >&lt;p&gt;It applies, thanks.&lt;/p&gt;</comment>
                            <comment id="13474236" author="oberman" created="Thu, 11 Oct 2012 15:30:42 +0000"  >&lt;p&gt;Good!  At some point I&apos;ll actually try to figure out how to setup a real development environment, as I feel really uncomfortable showing code without unit tests.&lt;/p&gt;</comment>
                            <comment id="13474436" author="brandon.williams" created="Thu, 11 Oct 2012 19:01:22 +0000"  >&lt;p&gt;Committed the relevant portion of this with formatting fixes.  I&apos;ll leave the PIG_WIDEROW_INPUT fix to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4749&quot; title=&quot;Possible problem with widerow in Pig URI&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4749&quot;&gt;&lt;del&gt;CASSANDRA-4749&lt;/del&gt;&lt;/a&gt;, though it&apos;s needed to test this patch.  Thanks, Will!  I know this function is especially tricky.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12548752" name="patch.txt" size="5651" author="oberman" created="Thu, 11 Oct 2012 15:22:05 +0000"/>
                            <attachment id="12548748" name="patch.txt" size="1168" author="oberman" created="Thu, 11 Oct 2012 14:55:09 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[oberman]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>247116</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i07z87:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>44474</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>brandon.williams</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>