<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:16:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15900] Close channel and reduce buffer allocation during entire sstable streaming with SSL</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15900</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15740&quot; title=&quot;Entire SSTable transfers don&amp;#39;t work over SSL&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15740&quot;&gt;&lt;del&gt;CASSANDRA-15740&lt;/del&gt;&lt;/a&gt; added the ability to stream entire sstable by loading on-disk file into user-space off-heap buffer when SSL is enabled, because netty doesn&apos;t support zero-copy with SSL.&lt;/p&gt;

&lt;p&gt;But there are two issues:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;file channel is not closed.&lt;/li&gt;
	&lt;li&gt;1mb batch size is used. 1mb exceeds buffer pool&apos;s max allocation size, thus it&apos;s all allocated outside the pool and will cause large amount of allocations.&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/651&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Patch&lt;/a&gt;:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;close file channel when the last batch is loaded into off-heap bytebuffer. I don&apos;t think we need to wait until buffer is flushed by netty.&lt;/li&gt;
	&lt;li&gt;reduce the batch to 64kb which is more buffer pool friendly when streaming entire sstable with SSL.&lt;/li&gt;
&lt;/ol&gt;
</description>
                <environment></environment>
        <key id="13313236">CASSANDRA-15900</key>
            <summary>Close channel and reduce buffer allocation during entire sstable streaming with SSL</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jasonstack">Zhao Yang</assignee>
                                    <reporter username="jasonstack">Zhao Yang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 24 Jun 2020 11:47:59 +0000</created>
                <updated>Mon, 21 Dec 2020 09:32:12 +0000</updated>
                            <resolved>Tue, 7 Jul 2020 00:21:01 +0000</resolved>
                                        <fixVersion>4.0-beta1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Legacy/Streaming and Messaging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="17143778" author="jasonstack" created="Wed, 24 Jun 2020 11:49:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi&quot; class=&quot;user-hover&quot; rel=&quot;djoshi&quot;&gt;djoshi&lt;/a&gt;&#160;do you mind reviewing and checking it on apache ci?&lt;/p&gt;</comment>
                            <comment id="17144156" author="maedhroz" created="Wed, 24 Jun 2020 18:16:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; I can take an initial look.&lt;/p&gt;</comment>
                            <comment id="17144408" author="maedhroz" created="Wed, 24 Jun 2020 21:17:41 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; Made a couple comments inline in the PR where I thought that would be easier. Then there are a few higher level things:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;It might be worthwhile to have a test in &lt;tt&gt;AsyncStreamingOutputPlusTest&lt;/tt&gt; that verifies &lt;tt&gt;AsyncStreamingOutputPlus#writeFileToChannel()&lt;/tt&gt; closes the provided channel.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;AsyncStreamingOutputPlus#writeFileToChannel(FileChannel, StreamRateLimiter, int)&lt;/tt&gt; and &lt;tt&gt;AsyncStreamingOutputPlus#writeFileToChannelZeroCopy()&lt;/tt&gt; may be better off at &lt;tt&gt;private&lt;/tt&gt; visibility, given we&apos;re treating them as transport-level implementation details. (Perhaps &lt;tt&gt;writeFileToChannel&lt;/tt&gt; would be easier to test at package-private though.)&lt;/li&gt;
	&lt;li&gt;The JavaDoc for &lt;tt&gt;writeFileToChannel(FileChannel, StreamRateLimiter)&lt;/tt&gt; is slightly out-of date now, given we&apos;ve lowered the batch size for the SSL case. (We should make sure to preserve the bit about the method taking ownership of the &lt;tt&gt;FileChannel&lt;/tt&gt;.)&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17145693" author="jasonstack" created="Thu, 25 Jun 2020 17:42:09 +0000"  >&lt;blockquote&gt;&lt;p&gt;It might be worthwhile to have a test in AsyncStreamingOutputPlusTest that verifies AsyncStreamingOutputPlus#writeFileToChannel() closes the provided channel.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;AsyncStreamingOutputPlus#writeFileToChannel(FileChannel, StreamRateLimiter, int) and AsyncStreamingOutputPlus#writeFileToChannelZeroCopy() may be better off at private visibility, given we&apos;re treating them as transport-level implementation details. (Perhaps writeFileToChannel would be easier to test at package-private though.)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I left them as public and marked &quot;@VisibleForTesting&quot;..&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;The JavaDoc for writeFileToChannel(FileChannel, StreamRateLimiter) is slightly out-of date now, given we&apos;ve lowered the batch size for the SSL case. (We should make sure to preserve the bit about the method taking ownership of the FileChannel.)&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17145740" author="maedhroz" created="Thu, 25 Jun 2020 18:46:08 +0000"  >&lt;p&gt;+1&lt;/p&gt;

&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi&quot; class=&quot;user-hover&quot; rel=&quot;djoshi&quot;&gt;djoshi&lt;/a&gt; might take a quick look as well.&lt;/p&gt;</comment>
                            <comment id="17148113" author="djoshi3" created="Mon, 29 Jun 2020 20:05:29 +0000"  >&lt;p&gt;The patch lgtm too. +1. I&apos;ve kicked off tests as a final check &lt;a href=&quot;https://circleci.com/workflow-run/35d72695-0461-4080-997f-20d54940ff98&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and &lt;a href=&quot;https://circleci.com/workflow-run/3487a3b3-401e-4b50-aea8-fc667b2e64cd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. I&apos;ll commit once I get a clean run.&lt;/p&gt;</comment>
                            <comment id="17148877" author="djoshi3" created="Tue, 30 Jun 2020 18:20:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; looks like there are a few failures. They&apos;re likely unrelated but it would be great to double check and make sure.&lt;/p&gt;</comment>
                            <comment id="17149066" author="maedhroz" created="Wed, 1 Jul 2020 03:13:22 +0000"  >&lt;p&gt;Let&apos;s see...&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;test_restart_node_localhost - pushed_notifications_test.TestPushedNotifications&lt;/tt&gt; should have been addressed by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15677&quot; title=&quot;Topology events are not sent to clients if the nodes use the same network interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15677&quot;&gt;&lt;del&gt;CASSANDRA-15677&lt;/del&gt;&lt;/a&gt; a few days ago.&lt;/p&gt;

&lt;p&gt;&lt;tt&gt;test_describe - cqlsh_tests.test_cqlsh.TestCqlsh&lt;/tt&gt; and its materialized view equivalent have a history of flakiness, and don&apos;t look directly related to this patch. (Is there an issue around &lt;tt&gt;read_repair&lt;/tt&gt; showing up in the table DDL where it isn&apos;t expected?)&lt;/p&gt;
</comment>
                            <comment id="17149071" author="jasonstack" created="Wed, 1 Jul 2020 03:23:20 +0000"  >&lt;p&gt;rebased and submit another round of ci: &lt;a href=&quot;https://circleci.com/workflow-run/cdf55335-c876-450b-8bf9-1d778a2df806&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt; and &lt;a href=&quot;https://circleci.com/workflow-run/2080f225-f689-4243-ad67-288bef608640&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;test_restart_node_localhost - pushed_notifications_test.TestPushedNotifications should have been addressed by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15677&quot; title=&quot;Topology events are not sent to clients if the nodes use the same network interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15677&quot;&gt;&lt;del&gt;CASSANDRA-15677&lt;/del&gt;&lt;/a&gt; a few days ago.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;it&apos;s failing after rebase...&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;J11 - readRepairTest - org.apache.cassandra.distributed.test.SimpleReadWriteTest&lt;/p&gt;&lt;/blockquote&gt;
&lt;blockquote&gt;&lt;p&gt;J11 - testImportCorrupt - org.apache.cassandra.db.ImportTest&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;doesn&apos;t seem to be related.&lt;/p&gt;</comment>
                            <comment id="17149586" author="maedhroz" created="Wed, 1 Jul 2020 17:32:56 +0000"  >&lt;p&gt;I pinged &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bryncooke&quot; class=&quot;user-hover&quot; rel=&quot;bryncooke&quot;&gt;bryncooke&lt;/a&gt; about &lt;tt&gt;pushed_notifications_test.TestPushedNotifications&lt;/tt&gt;. It&apos;s possible &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15886&quot; title=&quot;pushed_notifications_test.TestPushedNotifications.test_restart_node_localhost failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15886&quot;&gt;&lt;del&gt;CASSANDRA-15886&lt;/del&gt;&lt;/a&gt; actually wasn&apos;t a duplicate of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15677&quot; title=&quot;Topology events are not sent to clients if the nodes use the same network interface&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15677&quot;&gt;&lt;del&gt;CASSANDRA-15677&lt;/del&gt;&lt;/a&gt;?&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; Unless those last two fail locally or have errors relating to channel closure, I wouldn&apos;t guess they have anything to do with this patch. However, I&apos;m also not seeing any existing flaky test Jiras for them (closest are &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15543&quot; title=&quot;flaky test org.apache.cassandra.distributed.test.SimpleReadWriteTest.readWithSchemaDisagreement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15543&quot;&gt;&lt;del&gt;CASSANDRA-15543&lt;/del&gt;&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15517&quot; title=&quot;Fix potentially flaky ImportTest#testImportCorruptWithoutValidation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15517&quot;&gt;&lt;del&gt;CASSANDRA-15517&lt;/del&gt;&lt;/a&gt;), so we may need a couple new Jiras. &lt;tt&gt;SimpleReadWriteTest&lt;/tt&gt; looks like it got taken out by the forked VM existing abnormally though.&lt;/p&gt;</comment>
                            <comment id="17151008" author="jasonstack" created="Fri, 3 Jul 2020 14:10:14 +0000"  >&lt;p&gt;both&#160;SimpleReadWriteTest and&#160;ImportTest passed locally with JDK11, I don&apos;t think they use streaming.&lt;/p&gt;</comment>
                            <comment id="17152382" author="djoshi3" created="Tue, 7 Jul 2020 00:21:01 +0000"  >&lt;p&gt;Committed. Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt;!&lt;/p&gt;</comment>
                            <comment id="17152771" author="jasonstack" created="Tue, 7 Jul 2020 14:13:42 +0000"  >&lt;p&gt;thanks for the review&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasonstack]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12995" cascade-level="1"><![CDATA[Resource Management]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12975"><![CDATA[Code Inspection]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 19 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0g5ns:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
        <customfieldvalue><![CDATA[djoshi]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/73691944c0ff9b01679cf5a6fe5944ad4c416509&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/73691944c0ff9b01679cf5a6fe5944ad4c416509&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://circleci.com/workflow-run/ba9f4692-da21-44e9-ac31-fe8d2e6215cb&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/workflow-run/ba9f4692-da21-44e9-ac31-fe8d2e6215cb&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>