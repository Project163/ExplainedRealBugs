<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:15:04 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15543] flaky test org.apache.cassandra.distributed.test.SimpleReadWriteTest.readWithSchemaDisagreement</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15543</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;This fails infrequently, last seen failure was on java 8&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
junit.framework.AssertionFailedError
	at org.apache.cassandra.distributed.test.DistributedReadWritePathTest.readWithSchemaDisagreement(DistributedReadWritePathTest.java:276)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13283295">CASSANDRA-15543</key>
            <summary>flaky test org.apache.cassandra.distributed.test.SimpleReadWriteTest.readWithSchemaDisagreement</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="newkek">Kevin Gallardo</assignee>
                                    <reporter username="dcapwell">David Capwell</reporter>
                        <labels>
                    </labels>
                <created>Tue, 4 Feb 2020 17:37:08 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:54 +0000</updated>
                            <resolved>Thu, 26 Mar 2020 14:16:28 +0000</resolved>
                                        <fixVersion>4.0-alpha4</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Test/dtest/java</component>
                    <component>Test/dtest/python</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                                                                                <comments>
                            <comment id="17038574" author="cnlwsu" created="Mon, 17 Feb 2020 18:59:26 +0000"  >&lt;p&gt;renamed to SimpleReadWriteTest so :&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
junit.framework.AssertionFailedError
	at org.apache.cassandra.distributed.test.SimpleReadWriteTest.readWithSchemaDisagreement(SimpleReadWriteTest.java:274)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;as seen in &lt;a href=&quot;https://circleci.com/gh/clohfink/cassandra/674&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/clohfink/cassandra/674&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17038576" author="dcapwell" created="Mon, 17 Feb 2020 19:01:00 +0000"  >&lt;p&gt;This was renamed in 0f22dab1a015cb84d9857f940de5a256bfbee083&lt;/p&gt;</comment>
                            <comment id="17042208" author="brandon.williams" created="Fri, 21 Feb 2020 22:20:19 +0000"  >&lt;p&gt;This is relatively easy to reproduce. We can get three types of responses here.  The one the test wants:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.cassandra.exceptions.ReadFailureException: Operation failed - received 1 responses and 1 failures: INCOMPATIBLE_SCHEMA from 127.0.0.3:7012, INCOMPATIBLE_SCHEMA from 127.0.0.2:7012
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;but sometimes with two failures:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.cassandra.exceptions.ReadFailureException: Operation failed - received 1 responses and 2 failures: INCOMPATIBLE_SCHEMA from 127.0.0.3:7012, INCOMPATIBLE_SCHEMA from 127.0.0.2:7012
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And sometimes either one of the nodes by itself:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
org.apache.cassandra.exceptions.ReadFailureException: Operation failed - received 1 responses and 1 failures: INCOMPATIBLE_SCHEMA from 127.0.0.3:7012
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;At the least it seems we have a legit problem with terminology or counting here.&lt;/p&gt;</comment>
                            <comment id="17050411" author="edimitrova" created="Tue, 3 Mar 2020 17:31:37 +0000"  >&lt;p&gt;Anyone working on this one?&lt;/p&gt;</comment>
                            <comment id="17050426" author="dcapwell" created="Tue, 3 Mar 2020 17:43:20 +0000"  >&lt;p&gt;I don&apos;t know of anyone working on it.&lt;/p&gt;</comment>
                            <comment id="17050430" author="brandon.williams" created="Tue, 3 Mar 2020 17:46:22 +0000"  >&lt;p&gt;Any guidance or suggestions &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; since this is your test?&lt;/p&gt;</comment>
                            <comment id="17053578" author="newkek" created="Fri, 6 Mar 2020 16:32:30 +0000"  >&lt;p&gt;I have been looking into this&#160;issue and trying to reproduce it locally. Did not have much luck, re-executed the test about 2500 times (let it run overnight) and only managed to reproduce something ~inconsistent in one case.&lt;/p&gt;

&lt;p&gt;The test setup is: execute a schema alteration request on 1 node, don&apos;t let the node propagate the schema changes to other nodes, then execute a select at Consistency = ALL on that same node and expect a failure, because the 2 other nodes did not get the schema alteration request.&lt;/p&gt;

&lt;p&gt;So the message we expect from the Select request would be the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Operation failed - received 1 responses and 2 failures: INCOMPATIBLE_SCHEMA from 127.0.0.3:7012, INCOMPATIBLE_SCHEMA from 127.0.0.2:7012&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Node1&apos;s response is successful (because it has the schema changes), but all the others fail because they have a stale schema.&lt;/p&gt;

&lt;p&gt;The closest I got to reproducing something inconsistent to this was:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Operation failed - received 0 responses and 2 failures: INCOMPATIBLE_SCHEMA from 127.0.0.3:7012, INCOMPATIBLE_SCHEMA from 127.0.0.2:7012&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;But also let&apos;s consider the ones Brandon had observed.&lt;/p&gt;

&lt;p&gt;I have looked into some of the places where &lt;tt&gt;ReadFailureException&lt;/tt&gt; are generated, and landed in the &lt;a href=&quot;https://github.com/apache/cassandra/blob/aed15bfb01e753f9bac8b149b382c7a7c8d33183/src/java/org/apache/cassandra/service/reads/ReadCallback.java#L162&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;&lt;tt&gt;ReadCallback&lt;/tt&gt;&lt;/a&gt; class.&lt;/p&gt;

&lt;p&gt;The logic of the code is:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;call &lt;tt&gt;awaitResults()&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;in &lt;tt&gt;awaitResults()&lt;/tt&gt;:
	&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
		&lt;li&gt;block on &lt;tt&gt;await()&lt;/tt&gt;&lt;/li&gt;
		&lt;li&gt;when &lt;tt&gt;await()&lt;/tt&gt; exits, check what responses we got and whether errors came back&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Also looked into &lt;tt&gt;onFailure()&lt;/tt&gt; method, the logic is the following:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; n = waitingFor(from)
      ? failuresUpdater.incrementAndGet(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;)
      : failures;

failureReasonByEndpoint.put(from, failureReason);

&lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; (blockFor + n &amp;gt; replicaPlan().contacts().size()) {
    condition.signalAll(); &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt; signals as soon as 1 failure happens
&lt;/span&gt;}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;tt&gt;waitingFor(from)&lt;/tt&gt; is supposed to filter out errors coming from non local nodes it seems. In this test it always returns true, for simplicity we&apos;ll consider it is.&lt;br/&gt;
 Same for &lt;tt&gt;blockFor&lt;/tt&gt;, and &lt;tt&gt;replicaPlan().contacts().size()&lt;/tt&gt; these are both &lt;tt&gt;3&lt;/tt&gt; for the test, I supposed these may differ in some use case.&lt;/p&gt;

&lt;p&gt;As we can see above once 1 failure happens, the &lt;tt&gt;condition&lt;/tt&gt; will be signaled to unblock waiting callers. When &lt;tt&gt;awaitResults()&lt;/tt&gt; unblocks, it checks the value of &lt;tt&gt;failures&lt;/tt&gt; to see how many errors happened and report it as a &lt;tt&gt;ReadFailureException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;The code is designed so that the &lt;tt&gt;condition&lt;/tt&gt; is freed when either all responses are successful, or one failure happened.&lt;/p&gt;

&lt;p&gt;Now my understanding of this is that, on certain circumstances, we end up returning an error message as soon as 1 error happens, and not wait for all responses to come back, and the values of &lt;tt&gt;failures&lt;/tt&gt; and &lt;tt&gt;received&lt;/tt&gt; are not guaranteed to be at a certain value, except we know in case of a failure that &lt;tt&gt;failures&lt;/tt&gt; will be &amp;gt; 0.&lt;/p&gt;

&lt;p&gt;I am unclear on what the expected behavior should be here. &lt;br/&gt;
From my POV, I would think the most reasonable logic would be that &lt;tt&gt;await()&lt;/tt&gt; only exits once all responses have come back, failed or successful, or it times out. Therefore I would replace the &lt;tt&gt;&quot;SimpleCondition condition&quot;&lt;/tt&gt; with a &lt;tt&gt;CountDownLatch&lt;/tt&gt; initialized to the value of the number of expected responses, and &lt;tt&gt;countDown()&lt;/tt&gt; on &lt;tt&gt;onReceived()&lt;/tt&gt; and &lt;tt&gt;onFailure()&lt;/tt&gt; and have &lt;tt&gt;await()&lt;/tt&gt; use that countDownLatch.&lt;/p&gt;

&lt;p&gt;If the behavior of failing as soon as 1 failure happens is preferred, then the logic can stay that way, but the test needs to be modified to account for the possibility that only 1 error and No successful response may be returned in the &lt;tt&gt;ReadFailureException&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; got any insights?&lt;/p&gt;</comment>
                            <comment id="17053647" author="newkek" created="Fri, 6 Mar 2020 18:00:44 +0000"  >&lt;p&gt;Also, I suggested we wait for all responses because this is what the test expects, the test waits for the &lt;tt&gt;ReadFailureException&lt;/tt&gt; to contain &lt;b&gt;both&lt;/b&gt; failures without accounting for possible race conditions of the &lt;tt&gt;ReadCallback&lt;/tt&gt; returning before all responses have come back.&lt;/p&gt;

&lt;p&gt;EDIT: I confused the number of received and the number of failures, I think what is below is incorrect.&lt;/p&gt;

&lt;p&gt;&lt;del&gt;Also noticed that in the current context, the number of &lt;tt&gt;failure&lt;/tt&gt; and the list of failures can be inconsistent with each other, because we create the exception with&lt;/del&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ReadFailureException(replicaPlan().consistencyLevel(), received, blockFor, resolver.isDataPresent(), failureReasonByEndpoint)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;del&gt;Concurrently, &lt;tt&gt;received&lt;/tt&gt; can have been incremented but not the map of &lt;tt&gt;failureReasonByEndpoint&lt;/tt&gt; and we could end up with:&lt;/del&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Operation failed - received 1 responses and 2 failures: INCOMPATIBLE_SCHEMA from 127.0.0.3:7012&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;del&gt;&quot;2&quot; failures but only 1 error message. (number of &lt;tt&gt;received&lt;/tt&gt; is irrelevant)&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;Conversely, since the reference to the map is passed to &lt;tt&gt;ReadFailureException&lt;/tt&gt; but &lt;tt&gt;received&lt;/tt&gt; is passed by value, we can end up in the following scenario:&lt;/del&gt;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;del&gt;1 error triggers awaitResults() to unblock&lt;/del&gt;&lt;/li&gt;
	&lt;li&gt;&lt;del&gt;call to &lt;tt&gt;new ReadFailureException(received, failureReasonByEndpoint)&lt;/tt&gt;&lt;/del&gt;&lt;/li&gt;
	&lt;li&gt;&lt;del&gt;value of 1 for &lt;tt&gt;received&lt;/tt&gt; copied when calling &lt;tt&gt;ReadFailureException&lt;/tt&gt; constructor but only reference to &lt;tt&gt;failureReasonByEndpoint&lt;/tt&gt; given&lt;/del&gt;&lt;/li&gt;
	&lt;li&gt;&lt;del&gt;concurrently second failure calls to &lt;tt&gt;onFailure()&lt;/tt&gt; which updates &lt;tt&gt;failures&lt;/tt&gt; and the map&lt;/del&gt;&lt;/li&gt;
	&lt;li&gt;&lt;del&gt;&lt;tt&gt;ReadFailureException&lt;/tt&gt; has the &lt;tt&gt;1&lt;/tt&gt; value for &lt;tt&gt;failures&lt;/tt&gt; but the map has been updated to have 2 failures and constructs the error message&lt;/del&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;del&gt;We end up with the error message:&lt;/del&gt;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Operation failed - received 1 responses and 1 failures: INCOMPATIBLE_SCHEMA from 127.0.0.3:7012, INCOMPATIBLE_SCHEMA from 127.0.0.2:7012&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&lt;del&gt;&quot;1&quot; failure but 2 error messages. (number of &lt;tt&gt;received&lt;/tt&gt; is irrelevant)&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;One way to solve these issues would be to pass a copy of the &lt;tt&gt;failureReasonByEndpoint&lt;/tt&gt; to the constructor of &lt;tt&gt;ReadFailureException&lt;/tt&gt;.&lt;/del&gt;&lt;/p&gt;

&lt;p&gt;&lt;del&gt;If &lt;tt&gt;await()&lt;/tt&gt; waited until all messages came back or timeout the 2 issues wouldn&apos;t be problematic I think.&lt;/del&gt;&lt;/p&gt;</comment>
                            <comment id="17053724" author="newkek" created="Fri, 6 Mar 2020 19:42:05 +0000"  >&lt;p&gt;Actually I just realized that the value passed in the &lt;tt&gt;ReadFailureException&lt;/tt&gt; constructor is &lt;tt&gt;received&lt;/tt&gt;, I confused and thought it was the number of failures. Need to re-think about that comment above&lt;/p&gt;</comment>
                            <comment id="17053733" author="newkek" created="Fri, 6 Mar 2020 19:55:11 +0000"  >&lt;p&gt;&lt;tt&gt;RequestFailureException&lt;/tt&gt; uses the map&apos;s size to find out the number of entries in it:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;protected&lt;/span&gt; RequestFailureException(ExceptionCode code, ConsistencyLevel consistency, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; received, &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; blockFor, Map&amp;lt;InetAddressAndPort, RequestFailureReason&amp;gt; failureReasonByEndpoint)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;super&lt;/span&gt;(code, &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;.format(&lt;span class=&quot;code-quote&quot;&gt;&quot;Operation failed - received %d responses and %d failures: %s&quot;&lt;/span&gt;,
                                  received,
                                  failureReasonByEndpoint.size(),
                                  buildFailureString(failureReasonByEndpoint)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;It does a copy of the map later in the constructor but I suppose there is still a chance the content of the map may be different between the call to &lt;tt&gt;size()&lt;/tt&gt; and the entries when iterated in &lt;tt&gt;buildFailureString()&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17053831" author="edimitrova" created="Sat, 7 Mar 2020 00:49:55 +0000"  >&lt;p&gt;Hi Kevin,&lt;/p&gt;

&lt;p&gt;Thanks for the extensive explanation! I am gonna review everything on Monday.&#160;&lt;/p&gt;

&lt;p&gt;Have a nice weekend!&lt;/p&gt;</comment>
                            <comment id="17054990" author="newkek" created="Mon, 9 Mar 2020 14:04:23 +0000"  >&lt;p&gt;Sounds good, thanks, hope you had a good weekend &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;As a summary, &lt;/p&gt;

&lt;p&gt;In any case, I believe passing an immutable copy of the &lt;tt&gt;failureReasonByEndpoint&lt;/tt&gt; map to the constructor of Read/WriteFailureException would reduce the chances for the &lt;tt&gt;number of failures&lt;/tt&gt; and the failure messages to be inconsistent.&lt;/p&gt;

&lt;p&gt;In addition to that, there&apos;s the remaining question of the behavior of ReadCallback when failures happen (do we fail fast? or do we wait for all responses to come back/timeout?). Depending on the outcome of that, the test that is flaky at the moment would need to be adjusted to expect 1 &lt;b&gt;or&lt;/b&gt; 2 failures in the response.&lt;/p&gt;</comment>
                            <comment id="17056278" author="edimitrova" created="Tue, 10 Mar 2020 18:46:21 +0000"  >&lt;p&gt;Hi Kevin,&lt;/p&gt;

&lt;p&gt;&quot;In any case, I believe passing an immutable copy of the &lt;tt&gt;failureReasonByEndpoint&lt;/tt&gt; map to the constructor of Read/WriteFailureException would reduce the chances for the &lt;tt&gt;number of failures&lt;/tt&gt; and the failure messages to be inconsistent.&quot;&#160;&lt;/p&gt;

&lt;p&gt;Agree with you. I would personally expect 1 response from node1 where the schema was altered and two failures with the two messages.&#160;&lt;/p&gt;

&lt;p&gt;&quot;In addition to that, there&apos;s the remaining question of the behavior of ReadCallback when failures happen (do we fail fast? or do we wait for all responses to come back/timeout?). Depending on the outcome of that, the test that is flaky at the moment would need to be adjusted to expect 1 &lt;b&gt;or&lt;/b&gt; 2 failures in the response.&quot;&lt;/p&gt;

&lt;p&gt;Or we can say &quot;as soon as it fails more than 0 times&quot; and be safe?&lt;/p&gt;

&lt;p&gt;This is my personal interpretation.&lt;/p&gt;

&lt;p&gt;I believe&#160; &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt; would be the best person to confirm any details but for test fix this would be enough I think to make it deterministic. I don&apos;t see a bug but confusing responses to the user (same as you, as we discussed on Slack)&lt;/p&gt;</comment>
                            <comment id="17057091" author="newkek" created="Wed, 11 Mar 2020 15:06:15 +0000"  >&lt;p&gt;Thanks for the reply, Ekaterina, and for confirming the behavior described.&lt;/p&gt;

&lt;p&gt;Got some more time to think about this, and it seems the best way to approach it, since what I suggest would be a larger behavioral change, would be to create a separate ticket for it. &lt;/p&gt;

&lt;p&gt;I think in this ticket I would rather: Fix the discrepancies between the failures number and the failure messages with the immutable map copy + fix the test that expects 2 failures to only expect 1 to match current behavior. &lt;/p&gt;

&lt;p&gt;Then, in the other ticket we can properly advocate/discuss pros and cons of returning cohesive error messages VS fail-fast &amp;amp; incohesive error message.&lt;/p&gt;

&lt;p&gt;Does that make sense?&lt;/p&gt;</comment>
                            <comment id="17057125" author="edimitrova" created="Wed, 11 Mar 2020 15:36:26 +0000"  >&lt;p&gt;Yes, I would also separate them. This is test fix. The other one would be to improve the failure reporting for the end users and try to mitigate any potential confusion.&#160;&lt;/p&gt;</comment>
                            <comment id="17057127" author="edimitrova" created="Wed, 11 Mar 2020 15:37:45 +0000"  >&lt;p&gt;Also, RequestFailureException is not used only here in the codebase...&lt;/p&gt;</comment>
                            <comment id="17057135" author="newkek" created="Wed, 11 Mar 2020 15:50:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;Also, RequestFailureException is not used only here in the codebase...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Right, I was planning on making the immutable copy changes for calls to WriteFailureException too&lt;/p&gt;</comment>
                            <comment id="17058206" author="newkek" created="Thu, 12 Mar 2020 19:43:54 +0000"  >&lt;p&gt;Changes available at &lt;a href=&quot;https://github.com/newkek/cassandra/tree/15543-trunk/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/newkek/cassandra/tree/15543-trunk/&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17058756" author="newkek" created="Fri, 13 Mar 2020 14:10:56 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=ifesdjeen&quot; class=&quot;user-hover&quot; rel=&quot;ifesdjeen&quot;&gt;ifesdjeen&lt;/a&gt;&#160;since you were the author of the test originally, would you have some to review the fixes above? Thank you&lt;/p&gt;</comment>
                            <comment id="17061159" author="newkek" created="Tue, 17 Mar 2020 20:06:51 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;, I&apos;ve seen you have done quite a bit of work in &lt;tt&gt;ReadCallback&lt;/tt&gt;, I was wondering if you had some cycles to take a look at the patch above (and optionally the discussion going on in this ticket)? Thanks&lt;/p&gt;</comment>
                            <comment id="17061214" author="benedict" created="Tue, 17 Mar 2020 22:00:04 +0000"  >&lt;p&gt;Probably not anytime soon I&apos;m afraid, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=newkek&quot; class=&quot;user-hover&quot; rel=&quot;newkek&quot;&gt;newkek&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17061583" author="blerer" created="Wed, 18 Mar 2020 09:59:51 +0000"  >&lt;p&gt;I should be able to have the review done by tomorrow evening.&lt;/p&gt;</comment>
                            <comment id="17061740" author="newkek" created="Wed, 18 Mar 2020 13:46:52 +0000"  >&lt;p&gt;Great, thanks Benedict and Benjamin.&lt;/p&gt;</comment>
                            <comment id="17061801" author="newkek" created="Wed, 18 Mar 2020 15:12:06 +0000"  >&lt;p&gt;I have launched builds of this branch, you can see the results &lt;a href=&quot;https://app.circleci.com/pipelines/github/newkek/cassandra?branch=15543-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;on CircleCI&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17066073" author="newkek" created="Tue, 24 Mar 2020 18:11:33 +0000"  >&lt;p&gt;After review from &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; I have made some changes and the latest CI run is &lt;a href=&quot;https://app.circleci.com/pipelines/github/newkek/cassandra?branch=15543-trunk&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; as #11. All the unit and JVM dtests ran successfully.&lt;/p&gt;</comment>
                            <comment id="17066110" author="newkek" created="Tue, 24 Mar 2020 19:00:52 +0000"  >&lt;p&gt;Just pushed a small commit that removes some unused imports I forgot to clean up: &lt;a href=&quot;https://github.com/newkek/cassandra/commit/55e94d94168ec62b01bdb764e1ea74d3d217ec41&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/newkek/cassandra/commit/55e94d94168ec62b01bdb764e1ea74d3d217ec41&lt;/a&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Feel free to squash&lt;/p&gt;</comment>
                            <comment id="17067707" author="blerer" created="Thu, 26 Mar 2020 14:16:28 +0000"  >&lt;p&gt;Patch committed into trunk at b6176906e71620b37920eaf84fa51516b046bdce&lt;/p&gt;</comment>
                            <comment id="17067780" author="newkek" created="Thu, 26 Mar 2020 15:34:48 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt;!&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[newkek]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 33 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0b5h4:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12346093">4.0-alpha</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314136" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/b6176906e71620b37920eaf84fa51516b046bdce&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/b6176906e71620b37920eaf84fa51516b046bdce&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;No doc change needed&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>