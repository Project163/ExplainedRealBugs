<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:48:19 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6075] The token function should allow column identifiers in the correct order only</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6075</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Given the following table:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE TABLE t1 (a &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;, b text, PRIMARY KEY ((a, b)));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The following request returns an error in cqlsh as literal arguments order is incorrect:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM t1 WHERE token(a, b) &amp;gt; token(&lt;span class=&quot;code-quote&quot;&gt;&apos;s&apos;&lt;/span&gt;, 1);
Bad Request: Type error: &lt;span class=&quot;code-quote&quot;&gt;&apos;s&apos;&lt;/span&gt; cannot be passed as argument 0 of function token of type &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But surprisingly if we provide the column identifier arguments in the wrong order no error is returned:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;SELECT * FROM t1 WHERE token(a, b) &amp;gt; token(1, &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// correct order is valid
&lt;/span&gt;SELECT * FROM t1 WHERE token(b, a) &amp;gt; token(1, &lt;span class=&quot;code-quote&quot;&gt;&apos;a&apos;&lt;/span&gt;); &lt;span class=&quot;code-comment&quot;&gt;// incorrect order is valid as well&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;Cassandra 1.2.9&lt;/p&gt;</environment>
        <key id="12669792">CASSANDRA-6075</key>
            <summary>The token function should allow column identifiers in the correct order only</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="blerer">Benjamin Lerer</assignee>
                                    <reporter username="mfiguiere">Micha&#235;l Figui&#232;re</reporter>
                        <labels>
                            <label>cql</label>
                    </labels>
                <created>Sat, 21 Sep 2013 02:06:55 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:04 +0000</updated>
                            <resolved>Wed, 24 Sep 2014 02:10:05 +0000</resolved>
                                        <fixVersion>2.0.11</fixVersion>
                    <fixVersion>2.1.1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14119783" author="blerer" created="Wed, 3 Sep 2014 11:49:30 +0000"  >&lt;p&gt;The patch add a test at the end of SelectStatement.processPartitionKeyRestrictions (once we are sure that no argument is missing) to check that the token function arguments have been specify in the good order.&lt;/p&gt;</comment>
                            <comment id="14129208" author="thobbs" created="Wed, 10 Sep 2014 22:02:18 +0000"  >&lt;p&gt;I assume this is a problem for 2.1 as well.  Can you post a 2.1 patch as well?  The main thing that should change is the unit test (which can extend CQLTester in 2.1).&lt;/p&gt;</comment>
                            <comment id="14138746" author="blerer" created="Thu, 18 Sep 2014 10:08:45 +0000"  >&lt;p&gt;This is the patch for the 2.1 branch. It differs from the one of the 2.0 branch because the 2.1 branch is using CFMetaData instead of CFDefinition. The test has also been migrated to CQLTester&lt;/p&gt;</comment>
                            <comment id="14139340" author="thobbs" created="Thu, 18 Sep 2014 19:02:06 +0000"  >&lt;p&gt;If I specify the partition key items out of order, I get a somewhat confusing type error message:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:ks1&amp;gt; create table foo (a int, b text, c int, d int, PRIMARY KEY ((a, b, c)));
cqlsh:ks1&amp;gt; select * from foo WHERE token(a, c, b) &amp;gt; token(0, 0, &apos;a&apos;);
Bad Request: Type error: 0 cannot be passed as argument 1 of function token of type text
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We need to do the order check prior to the type check or find a way to do the type check properly.&lt;/p&gt;</comment>
                            <comment id="14139420" author="blerer" created="Thu, 18 Sep 2014 20:07:22 +0000"  >&lt;p&gt;I am impressed Tyler. I would have never thought about testing such a crappy case.&lt;/p&gt;</comment>
                            <comment id="14140210" author="blerer" created="Fri, 19 Sep 2014 09:07:43 +0000"  >&lt;p&gt;I had a look and it is not easy to solve that problem. &lt;br/&gt;
The problem come from the fact that we build the restrictions at the same time that we do part of our validation. We will try to compute the value of token(0, 0, &apos;a&apos;) before we even know if we have all the columns required within the token function or if their is a mix of restrictions using token function that we do not support. If we want to do those check earlier we will end up duplicating the test that we do on Restrictions on Relations.&lt;br/&gt;
This seems to indicate a problem in the code. I believe that the code should first perform the validation checks on Relations then build Restrictions.&lt;br/&gt;
I planning to refactor SelectStatement and I will be able to tackle that problem properly at that time but I want to do that refactoring in 3.0 as it is not a trivial stuff to do.&lt;br/&gt;
So my proposal is to deliver the current fix in 2.0 and 2.1 (knowing that it is not perfect) and properly fix it for 3.0.&lt;br/&gt;
I opened #&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7981&quot; title=&quot;Refactor SelectStatement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7981&quot;&gt;&lt;del&gt;CASSANDRA-7981&lt;/del&gt;&lt;/a&gt; for the SelectStatement refactoring were I keep track of this issue. &lt;br/&gt;
What do you think Tyler?&lt;/p&gt;</comment>
                            <comment id="14140824" author="thobbs" created="Fri, 19 Sep 2014 16:26:56 +0000"  >&lt;p&gt;Seems reasonable to me.&lt;/p&gt;

&lt;p&gt;+1, committed.&lt;/p&gt;</comment>
                            <comment id="14141279" author="iamaleksey" created="Fri, 19 Sep 2014 20:57:24 +0000"  >&lt;p&gt;This breaks pig tests on trunk, at least.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blerer&quot; class=&quot;user-hover&quot; rel=&quot;blerer&quot;&gt;blerer&lt;/a&gt; to run pig tests, do &apos;ant pig-test&apos;. Ignore most the warnings - there are a lot of them.&lt;/p&gt;</comment>
                            <comment id="14144565" author="blerer" created="Tue, 23 Sep 2014 08:53:01 +0000"  >&lt;p&gt;Completely forgot the case of the slice with start and end bound(e.g. token(key) &amp;gt;= token(1) and token(key) &amp;lt; token(2))&lt;br/&gt;
That is what broke the Pig-Tests. Sorry.&lt;br/&gt;
Here are the patchs to fix that problem on the 2.0 and 2.1+ branches.&lt;/p&gt;

&lt;p&gt;I also dicover while trying to add more tests than the current approach to handle token functions is broken. With the current approach we cannot reject queries like:&lt;br/&gt;
&lt;tt&gt;SELECT * FROM %s WHERE token(a, b) &amp;gt; token(?, ?) and token(b) &amp;lt; token(?, ?)&lt;/tt&gt; or &lt;tt&gt;SELECT * FROM %s WHERE token(a) &amp;gt; token(?, ?) and token(b) &amp;gt; token(?, ?)&lt;/tt&gt; &lt;br/&gt;
I will try to find another solution as part of #&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7981&quot; title=&quot;Refactor SelectStatement&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7981&quot;&gt;&lt;del&gt;CASSANDRA-7981&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14145777" author="iamaleksey" created="Wed, 24 Sep 2014 02:10:05 +0000"  >&lt;p&gt;Fixed in &lt;a href=&quot;https://github.com/apache/cassandra/commit/b1166c09983b1678cbc4b241f1da860930c571a5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/b1166c09983b1678cbc4b241f1da860930c571a5&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Used Guava&apos;s Iterators#cycle() instead of the null/hasnext check, and removed the (if cfDef.partitionKeyCount() &amp;gt; 0) condition, which is always true.&lt;/p&gt;

&lt;p&gt;Thanks.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12670873" name="6075-fix-v2.txt" size="4589" author="aleksey" created="Wed, 24 Sep 2014 01:51:29 +0000"/>
                            <attachment id="12670668" name="CASSANDRA-2.0-6075-PART2.txt" size="4743" author="blerer" created="Tue, 23 Sep 2014 08:53:01 +0000"/>
                            <attachment id="12670669" name="CASSANDRA-2.1-6075-PART2.txt" size="3668" author="blerer" created="Tue, 23 Sep 2014 08:53:01 +0000"/>
                            <attachment id="12669692" name="CASSANDRA-2.1-6075.txt" size="5321" author="blerer" created="Thu, 18 Sep 2014 10:08:45 +0000"/>
                            <attachment id="12666209" name="CASSANDRA-6075.txt" size="8547" author="blerer" created="Wed, 3 Sep 2014 11:49:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[blerer]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>349720</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 8 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1oauv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>350018</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>