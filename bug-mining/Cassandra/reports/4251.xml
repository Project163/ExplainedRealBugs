<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:02:45 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-11391] &quot;class declared as inner class&quot; error when using UDF</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-11391</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:music&amp;gt; CREATE FUNCTION testMapEntry(my_map map&amp;lt;text, text&amp;gt;)
         ... CALLED ON NULL INPUT
         ... RETURNS text
         ... LANGUAGE java
         ... AS $$
         ...     String buffer = &quot;&quot;;
         ...     for(java.util.Map.Entry&amp;lt;String, String&amp;gt; entry: my_map.entrySet()) {
         ...         buffer = buffer + entry.getKey() + &quot;: &quot; + entry.getValue() + &quot;, &quot;;
         ...     }
         ...     return buffer;
         ... $$;
InvalidRequest: code=2200 [Invalid query] 
message=&quot;Could not compile function &apos;music.testmapentry&apos; from Java source: 
org.apache.cassandra.exceptions.InvalidRequestException: 
Java UDF validation failed: [class declared as inner class]&quot;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;When I try to decompile the source code into byte code, below is the result:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;  public java.lang.String test(java.util.Map&amp;lt;java.lang.String, java.lang.String&amp;gt;);
    Code:
       0: ldc           #2                  // String
       2: astore_2
       3: aload_1
       4: invokeinterface #3,  1            // InterfaceMethod java/util/Map.entrySet:()Ljava/util/Set;
       9: astore_3
      10: aload_3
      11: invokeinterface #4,  1            // InterfaceMethod java/util/Set.iterator:()Ljava/util/Iterator;
      16: astore        4
      18: aload         4
      20: invokeinterface #5,  1            // InterfaceMethod java/util/Iterator.hasNext:()Z
      25: ifeq          94
      28: aload         4
      30: invokeinterface #6,  1            // InterfaceMethod java/util/Iterator.next:()Ljava/lang/Object;
      35: checkcast     #7                  // class java/util/Map$Entry
      38: astore        5
      40: new           #8                  // class java/lang/StringBuilder
      43: dup
      44: invokespecial #9                  // Method java/lang/StringBuilder.&quot;&amp;lt;init&amp;gt;&quot;:()V
      47: aload_2
      48: invokevirtual #10                 // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
      51: aload         5
      53: invokeinterface #11,  1           // InterfaceMethod java/util/Map$Entry.getKey:()Ljava/lang/Object;
      58: checkcast     #12                 // class java/lang/String
      61: invokevirtual #10                 // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
      64: ldc           #13                 // String :
      66: invokevirtual #10                 // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
      69: aload         5
      71: invokeinterface #14,  1           // InterfaceMethod java/util/Map$Entry.getValue:()Ljava/lang/Object;
      76: checkcast     #12                 // class java/lang/String
      79: invokevirtual #10                 // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
      82: ldc           #15                 // String ,
      84: invokevirtual #10                 // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
      87: invokevirtual #16                 // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
      90: astore_2
      91: goto          18
      94: aload_2
      95: areturn
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt; There is nothing that could trigger inner class creation ...&lt;/p&gt;</description>
                <environment>&lt;p&gt;C* 3.4&lt;/p&gt;</environment>
        <key id="12952059">CASSANDRA-11391</key>
            <summary>&quot;class declared as inner class&quot; error when using UDF</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="snazy">Robert Stupp</assignee>
                                    <reporter username="doanduyhai">DuyHai Doan</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Mar 2016 15:09:01 +0000</created>
                <updated>Tue, 16 Apr 2019 09:30:39 +0000</updated>
                            <resolved>Sat, 30 Apr 2016 16:31:37 +0000</resolved>
                                        <fixVersion>3.6</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="15205266" author="snazy" created="Mon, 21 Mar 2016 22:12:15 +0000"  >&lt;p&gt;-&lt;del&gt;It&apos;s caused by a superfluous sandbox check. asm reports uses of inner classes (like &lt;tt&gt;java.util.Map$Entry&lt;/tt&gt; - and the check triggers a byte-code validation error in that case. We don&apos;t need that check since we check for use and instantiation of &quot;malicious&quot; classes anyway.&lt;/del&gt;-&lt;/p&gt;

&lt;p&gt;-&lt;del&gt;The fix is quite simple: remove that superfluous check + add a regression utest.&lt;/del&gt;-&lt;/p&gt;

&lt;p&gt;-&lt;del&gt;Cassci&apos;s currently working on CI results.&lt;/del&gt;-&lt;/p&gt;

&lt;p&gt;&lt;b&gt;EDIT&lt;/b&gt; We still need the test against inner classes.&lt;br/&gt;
Extended the fix to explicitly test against inner classes as shown in the new test target classes used in &lt;tt&gt;UFVerifierTest&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="15262526" author="thobbs" created="Thu, 28 Apr 2016 17:01:17 +0000"  >&lt;p&gt;+1 on the code changes.  Can you rebase against the latest trunk and re-run CI?  There are a lot of dtest failures that are hopefully unrelated.&lt;/p&gt;</comment>
                            <comment id="15263824" author="snazy" created="Fri, 29 Apr 2016 09:43:00 +0000"  >&lt;p&gt;Hmm - rebased and re-ran CI. Still a lot of dtest failures. Will check today.&lt;/p&gt;</comment>
                            <comment id="15264188" author="snazy" created="Fri, 29 Apr 2016 15:24:17 +0000"  >&lt;p&gt;Oops. Some of the unit test classes did not compile anymore. Fixed that. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=thobbs&quot; class=&quot;user-hover&quot; rel=&quot;thobbs&quot;&gt;thobbs&lt;/a&gt;, want to take a look at the latest CI results?&lt;/p&gt;</comment>
                            <comment id="15264672" author="thobbs" created="Fri, 29 Apr 2016 20:19:49 +0000"  >&lt;p&gt;The new test results look much better, so +1 from me.&lt;/p&gt;</comment>
                            <comment id="15265359" author="snazy" created="Sat, 30 Apr 2016 16:31:37 +0000"  >&lt;p&gt;Thanks!&lt;br/&gt;
Committed as 93b64f7b355a64d752e7f73d8ad4127004616c70 to trunk.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            9 years, 29 weeks, 3 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2uylz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334622">3.4</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>thobbs</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[thobbs]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12334622">3.4</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>