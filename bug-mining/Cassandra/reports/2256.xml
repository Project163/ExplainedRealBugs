<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:39:24 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5762] Lost row marker after TTL expires</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5762</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I have the following table&lt;/p&gt;

&lt;p&gt;cqlsh:loginproject&amp;gt; DESCRIBE TABLE gameservers;&lt;/p&gt;

&lt;p&gt;CREATE TABLE gameservers (&lt;br/&gt;
  address inet PRIMARY KEY,&lt;br/&gt;
  last_update timestamp,&lt;br/&gt;
  regions blob,&lt;br/&gt;
  server_status boolean&lt;br/&gt;
) WITH&lt;br/&gt;
  bloom_filter_fp_chance=0.010000 AND&lt;br/&gt;
  caching=&apos;KEYS_ONLY&apos; AND&lt;br/&gt;
  comment=&apos;&apos; AND&lt;br/&gt;
  dclocal_read_repair_chance=0.000000 AND&lt;br/&gt;
  gc_grace_seconds=864000 AND&lt;br/&gt;
  read_repair_chance=0.100000 AND&lt;br/&gt;
  replicate_on_write=&apos;true&apos; AND&lt;br/&gt;
  populate_io_cache_on_flush=&apos;false&apos; AND&lt;br/&gt;
  compaction=&lt;/p&gt;
{&apos;class&apos;: &apos;SizeTieredCompactionStrategy&apos;}
&lt;p&gt; AND&lt;br/&gt;
  compression=&lt;/p&gt;
{&apos;sstable_compression&apos;: &apos;SnappyCompressor&apos;}
&lt;p&gt;;&lt;/p&gt;



&lt;p&gt;after inserting a row and executing the following command:&lt;br/&gt;
UPDATE gameservers USING TTL 10 SET server_status = true WHERE address = &apos;192.168.0.100&apos;&lt;/p&gt;

&lt;p&gt;after waiting for the ttl to expire, the row will lose its rowmarker making &quot;select address from gameservers&quot; returning 0 results although there are some.&lt;/p&gt;

&lt;p&gt;in cassandra-cli the table looks like this:&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;default@loginproject&amp;#93;&lt;/span&gt; list gameservers;&lt;br/&gt;
Using default limit of 100&lt;br/&gt;
Using default cell limit of 100&lt;br/&gt;
-------------------&lt;br/&gt;
RowKey: 192.168.0.100&lt;br/&gt;
=&amp;gt; (name=last_update, value=0000000000000017, timestamp=1373884433543000)&lt;br/&gt;
=&amp;gt; (name=regions, value=&amp;lt;truncated&amp;gt;, timestamp=1373883701652000)&lt;/p&gt;

&lt;p&gt;1 Row Returned.&lt;br/&gt;
Elapsed time: 345 msec(s).&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;default@loginproject&amp;#93;&lt;/span&gt;&lt;/p&gt;

</description>
                <environment>&lt;p&gt;Ubuntu 12.04&lt;/p&gt;</environment>
        <key id="12657720">CASSANDRA-5762</key>
            <summary>Lost row marker after TTL expires</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="tnr">Taner Catakli</reporter>
                        <labels>
                    </labels>
                <created>Mon, 15 Jul 2013 13:18:44 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:58 +0000</updated>
                            <resolved>Mon, 22 Jul 2013 12:19:17 +0000</resolved>
                                        <fixVersion>1.2.7</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                                                                                <comments>
                            <comment id="13708490" author="slebresne" created="Mon, 15 Jul 2013 14:16:48 +0000"  >&lt;p&gt;This is a rather annoying problem. To sum it up, if you TTL one column, the row marker is ttled too, because we have no way to know that this is not the last live column in that CQL3 row, but then if there was other non-ttled columns, they will survive the death of the row marker which breaks the invariant that a live row always has a row marker.&lt;/p&gt;

&lt;p&gt;Tbh, I have a hard time coming with a way to fix this. And so the only workaround that comes to mind would be disallow setting a TTL on an individual columns. That is, you&apos;d have to update all columns of the row to be able to use a TTL, which I hate because 1) it&apos;ll look random syntax wise and 2) I&apos;m convinced that being able to TTL individual columns in a row is useful.&lt;/p&gt;</comment>
                            <comment id="13709708" author="slebresne" created="Tue, 16 Jul 2013 12:24:49 +0000"  >&lt;p&gt;As much as this pains me, I don&apos;t see any easy way to make this work outside of doing a read-before-write (which is not acceptable).&lt;/p&gt;

&lt;p&gt;It &quot;might&quot; be possible to make it work (without read-before-write) by specializing the row marker in the storage so that it tracks TTL to provide the desired behavior but at best that wouldn&apos;t be trivial and would probably make the row marker prohibitive in term of storage (though something like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4175&quot; title=&quot;Reduce memory, disk space, and cpu usage with a column name/id map&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4175&quot;&gt;&lt;del&gt;CASSANDRA-4175&lt;/del&gt;&lt;/a&gt; might help make it more reasonable). In any case, it&apos;s &lt;em&gt;at best&lt;/em&gt; a solution for 2.1 but not before that, and that&apos;s leaving aside the debate of whether the feature is worth the complexity.&lt;/p&gt;

&lt;p&gt;In the meantime, the best workaround I can come with would be to force SELECT queries to slice the whole CQL3 row even when only some columns are selected.  That is, we would revert to what we did for selects before &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4361&quot; title=&quot;CQL3: allow definition with only a PK&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4361&quot;&gt;&lt;del&gt;CASSANDRA-4361&lt;/del&gt;&lt;/a&gt;. Tbh, this probably wouldn&apos;t have much impact on performance since 1) CQL3 rows are bound to be relatively small and 2) we now optimize slice queries relatively well for that kind of case (partly in 1.2 with promoted index and even more in 2.0 with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5514&quot; title=&quot;Track min/max clustered values per sstable to optimize reads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5514&quot;&gt;&lt;del&gt;CASSANDRA-5514&lt;/del&gt;&lt;/a&gt;) so that queries by names probably don&apos;t have that much benefits anymore.&lt;/p&gt;

&lt;p&gt;Doing that would fix the problem is most cases, including the one of the description since it&apos;ll basically relegate the row marker to only mark rows where only the PK is set. This does not fix it fully though, since if you do&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;CREATE TABLE test (k int PRIMARY KEY, a int, b int);
INSERT INTO test (k, a, b) VALUES (0, 1, 2);
UPDATE test USING TTL=1 SET b=3 WHERE k=0;
// wait 2 seconds
DELETE a FROM test WHERE k=0;
SELECT * FROM test WHERE k=0;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;then the last select will return no results, even though it kind of should return one result (with &lt;tt&gt;a == null&lt;/tt&gt; and &lt;tt&gt;b == null&lt;/tt&gt;) since we haven&apos;t done a full row deletion. But then we could accept that as a whacky known special situation (don&apos;t get me wrong, I don&apos;t like it, it&apos;s just that &quot;we have a problem and I don&apos;t have a better solution&quot;). And to be fair, you would really have to try fairly hard to get bitten by this.&lt;/p&gt;

&lt;p&gt;Attaching the patch that do what&apos;s above for info (IN queries on the last clustering column, which we support. make that slightly more annoying that one would hope, but it&apos;s not too much of a big deal either).&lt;/p&gt;

&lt;p&gt;As mentionned above, another workaround could be to not let user get into that state by forcing all the (CQL3) columns of the (CQL3) row to be set int the statement if a TTL is used.&lt;/p&gt;

&lt;p&gt;The (imho big) problem is that this is a breaking change. If someone is using different TTL in the same CQL3 row (and his application do depends on it), it basically cannot upgrade (short of migrating data that have differents TTL into their own separate table, which is extremely painful). Part of me is also pretty convinced that the convenience of being able to set TTL to individual columns outweight the &quot;not exactly right&quot; behavior of the special case above (especially since only people that &lt;b&gt;needs&lt;/b&gt; per-columns TTL will ever run into that special case).&lt;/p&gt;</comment>
                            <comment id="13712679" author="iamaleksey" created="Thu, 18 Jul 2013 19:17:07 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13715153" author="slebresne" created="Mon, 22 Jul 2013 12:19:17 +0000"  >&lt;p&gt;Alright, committed, thanks&lt;/p&gt;</comment>
                            <comment id="13868417" author="JIRAUSER308715" created="Fri, 10 Jan 2014 22:39:46 +0000"  >&lt;p&gt;Could we keep a &quot;something in here has a TTL&quot; flag and do the optimized way unless it is set?  I think we even already keep that kind of data to do the sstable tombstone compaction?  That way if you don&apos;t use TTL&apos;s, and you have big columns, you don&apos;t get the heap penalty (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6569&quot; title=&quot;Batchlog replays copy the entire batchlog table into the heap&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6569&quot;&gt;&lt;del&gt;CASSANDRA-6569&lt;/del&gt;&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="13868741" author="slebresne" created="Sat, 11 Jan 2014 11:18:17 +0000"  >&lt;blockquote&gt;&lt;p&gt;Could we keep a &quot;something in here has a TTL&quot; flag and do the optimized way unless it is set?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I don&apos;t see how we could maintain such flag. We&apos;d need to know no TTL is involved whatsoever at the coordinator level (so before we&apos;re reached the replicas), which I don&apos;t think is possible to do reliably. What we could probably do is add a per-table &quot;disable ttl&quot; option that would make inserts with TTL rejected. And we could optimize when this option is set. That being said, if you want to store both small and large values in the same row and strongly rely on only being able to query only the small ones often, you might be better off using 2 tables, one for the small values, one for the large ones.&lt;/p&gt;</comment>
                            <comment id="13871978" author="slebresne" created="Wed, 15 Jan 2014 12:11:16 +0000"  >&lt;p&gt;Actually, &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6588&quot; title=&quot;Add a &amp;#39;NO EMPTY RESULTS&amp;#39; filter to SELECT&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6588&quot;&gt;CASSANDRA-6588&lt;/a&gt; is probably a better idea than my &quot;disable ttl option&quot; above.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12592529" name="0001-Always-do-slice-queries-for-CQL3-tables.txt" size="10057" author="slebresne" created="Tue, 16 Jul 2013 12:24:49 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>337940</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 44 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1mafb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>338262</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>