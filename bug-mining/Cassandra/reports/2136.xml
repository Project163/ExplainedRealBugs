<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:38:08 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4860] Estimated Row Cache Entry size incorrect (always 24?)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4860</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;After running for several hours the RowCacheSize was suspicious low (ie 70 something MB)  I used  &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4859&quot; title=&quot;Include number of entries in CachedService&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4859&quot;&gt;&lt;del&gt;CASSANDRA-4859&lt;/del&gt;&lt;/a&gt; to measure the size and number of entries on a node:&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;: 1560504./65021&lt;br/&gt;
Out&lt;span class=&quot;error&quot;&gt;&amp;#91;3&amp;#93;&lt;/span&gt;: 24.0&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;: 2149464./89561&lt;br/&gt;
Out&lt;span class=&quot;error&quot;&gt;&amp;#91;4&amp;#93;&lt;/span&gt;: 24.0&lt;/p&gt;

&lt;p&gt;In &lt;span class=&quot;error&quot;&gt;&amp;#91;6&amp;#93;&lt;/span&gt;: 7216096./300785&lt;br/&gt;
Out&lt;span class=&quot;error&quot;&gt;&amp;#91;6&amp;#93;&lt;/span&gt;: 23.990877204647838&lt;/p&gt;


&lt;p&gt;That&apos;s RowCacheSize/RowCacheNumEntires  .  Just to prove I don&apos;t have crazy small rows the mean size of the row &lt;b&gt;keys&lt;/b&gt; in the saved cache is 67 and Compacted row mean size: 355.  No jamm errors in the log&lt;/p&gt;

&lt;p&gt;Config notes:&lt;br/&gt;
row_cache_provider: ConcurrentLinkedHashCacheProvider&lt;br/&gt;
row_cache_size_in_mb: 2048&lt;/p&gt;

&lt;p&gt;Version info:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;C*: 1.1.6&lt;/li&gt;
	&lt;li&gt;centos 2.6.32-220.13.1.el6.x86_64&lt;/li&gt;
	&lt;li&gt;java 6u31 Java HotSpot(TM) 64-Bit Server VM (build 20.6-b01, mixed mode)&lt;/li&gt;
&lt;/ul&gt;
</description>
                <environment></environment>
        <key id="12613379">CASSANDRA-4860</key>
            <summary>Estimated Row Cache Entry size incorrect (always 24?)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="vijay2win@yahoo.com">Vijay</assignee>
                                    <reporter username="cburroughs">Chris Burroughs</reporter>
                        <labels>
                            <label>qa-resolved</label>
                    </labels>
                <created>Wed, 24 Oct 2012 22:11:03 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:24 +0000</updated>
                            <resolved>Mon, 13 May 2013 20:04:48 +0000</resolved>
                                        <fixVersion>1.2.0 beta 3</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>10</watches>
                                                                                                                <comments>
                            <comment id="13495915" author="vijay2win@yahoo.com" created="Tue, 13 Nov 2012 04:00:31 +0000"  >&lt;p&gt;Simple patch to fix the issue....&lt;/p&gt;

&lt;p&gt;Looks like the issue is that we do Mesure (instead of MeasureDeep) which will not measure the byte[] attached to the RK.&lt;/p&gt;

&lt;p&gt;*-for-11.patch is for 1.1 and *.patch is for 1.2.&lt;/p&gt;</comment>
                            <comment id="13496214" author="jbellis" created="Tue, 13 Nov 2012 14:06:03 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13496411" author="vijay2win@yahoo.com" created="Tue, 13 Nov 2012 18:48:05 +0000"  >&lt;p&gt;Committed Thanks!&lt;/p&gt;</comment>
                            <comment id="13616052" author="enigmacurry" created="Thu, 28 Mar 2013 04:53:33 +0000"  >&lt;p&gt;I&apos;ve been working on a 2.0/1.2 read performance regression analysis (&lt;a href=&quot;http://goo.gl/KHZfL&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;report is here&lt;/a&gt;) and it brought me back to this ticket.&lt;/p&gt;

&lt;p&gt;The patch as it was applied in revision 94fa82558f198489e0eefb0c14392607d5d23224 introduces a read performance penalty of about ~20%.&lt;/p&gt;

&lt;p&gt;I&apos;ve tested reverting this patch and applying on top of the latest 2.0 branch and it greatly improves read performance. &lt;/p&gt;

&lt;p&gt;I don&apos;t claim to know what this patch really does, so not sure if that&apos;s an appropriate action to take or not, but I&apos;ve attached my patch here regardless (trunk-4860-revert.patch).&lt;/p&gt;</comment>
                            <comment id="13616082" author="vijay2win@yahoo.com" created="Thu, 28 Mar 2013 05:52:50 +0000"  >&lt;p&gt;Ryan, so the results has row caching enabled? (For the record this shows up only when caching is enabled and using InHeap RowCache).&lt;br/&gt;
20% over head is a lot more than i initially anticipated.&lt;/p&gt;

&lt;p&gt;I could think of one alternative: I have to dig my history, but i had a alternative to measureDeep() which was very similar to &lt;a href=&quot;http://goo.gl/oqD89&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://goo.gl/oqD89&lt;/a&gt;, but it doesn&apos;t cover all the platforms and was lot more complicated so it was never committed. Should we resurrect it?&lt;/p&gt;</comment>
                            <comment id="13616101" author="enigmacurry" created="Thu, 28 Mar 2013 06:31:20 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=vijay2win%40yahoo.com&quot; class=&quot;user-hover&quot; rel=&quot;vijay2win@yahoo.com&quot;&gt;vijay2win@yahoo.com&lt;/a&gt;, I have not tweaked any row cache settings from the default. This is in my cassandra.yaml:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;# Maximum size of the row cache in memory.
# NOTE: &lt;span class=&quot;code-keyword&quot;&gt;if&lt;/span&gt; you reduce the size, you may not get you hottest keys loaded on startup.
#
# Default value is 0, to disable row caching.
row_cache_size_in_mb: 0
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;From the description, it sounds like I should have row caching turned off, and yet this code is still being run as evidenced by the change in performance by reverting your patch. I don&apos;t yet have a deep understanding of the features involved here, so if you have any other suggestions for things to test here, please let me know. Thanks!&lt;/p&gt;</comment>
                            <comment id="13616410" author="vijay2win@yahoo.com" created="Thu, 28 Mar 2013 16:46:34 +0000"  >&lt;p&gt;Ahaa missed it, it is the key cache which is slowing down the performance.&lt;/p&gt;</comment>
                            <comment id="13616585" author="vijay2win@yahoo.com" created="Thu, 28 Mar 2013 19:51:10 +0000"  >&lt;p&gt;Hi Ryan, &lt;br/&gt;
Since you have the environment do you mind testing -v2?&lt;br/&gt;
It is not a final patch, I have to verify the accuracy of the estimate though.&lt;/p&gt;</comment>
                            <comment id="13616642" author="enigmacurry" created="Thu, 28 Mar 2013 20:59:38 +0000"  >&lt;p&gt;With your v2 patch applied I get an average read rate of 14276. That&apos;s much worse actually than the first patch. To make sure something is not amiss, I re-ran the 2.0 baseline and got comparable results as before (22524). The number we&apos;re hoping to back to is ~28000.&lt;/p&gt;</comment>
                            <comment id="13617978" author="vijay2win@yahoo.com" created="Sat, 30 Mar 2013 03:55:05 +0000"  >&lt;p&gt;Hi Ryan, can you try this one? &lt;/p&gt;

&lt;p&gt;I am really optimistic that this patch should improve the performance without sacrificing the accuracy of measurement of the memory footprint.&lt;br/&gt;
Attached patch doesn&apos;t use any reflection, Micro benchmark shows a better performance than any other approach.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Completed warmup!, &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; of Iteratoions: 1000000
Using reflection took: 8113
Using 4860-v3 took: 95
Using MemoryMeter meter.measure(key) took: 190
Using MemoryMeter meter.measureDeep(key) took: 982
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Note: We don&apos;t have this optimization when we have a range tombstone in KeyCache (coz the code becomes really complex), and while using RowCache.&lt;/p&gt;

&lt;p&gt;Let me know if you want me to publish the accuracy test and perf test code.&lt;/p&gt;</comment>
                            <comment id="13619936" author="enigmacurry" created="Tue, 2 Apr 2013 15:46:45 +0000"  >&lt;p&gt;This one (v3 patch) is much better. Average read op rate is 26484. That&apos;s the best run I&apos;ve seen on 1.2+ except for the run with the trunk-4860-revert.patch applied which has an average read op rate of 27809 (4.8% faster).&lt;/p&gt;</comment>
                            <comment id="13619988" author="vijay2win@yahoo.com" created="Tue, 2 Apr 2013 16:50:12 +0000"  >&lt;p&gt;Ryan, Micro benchmark shows v3 is better, is there any chance you are hitting the same key in the key cache often? The reason for asking is that you might have a smaller key cache since the calculation is more accurate. If yes then i would increase the keycache and try. &lt;/p&gt;

&lt;p&gt;To be clear the Meter.measure() is bug and cannot be used in production and can cause OOM.&lt;/p&gt;</comment>
                            <comment id="13629297" author="enigmacurry" created="Thu, 11 Apr 2013 20:14:04 +0000"  >&lt;p&gt;I&apos;m hitting the same key multiple times in the write, but not the read:&lt;/p&gt;

&lt;p&gt;stress -F 2000000 -n 20000000 -i 1&lt;br/&gt;
stress -n 2000000 -o read -i 1&lt;/p&gt;</comment>
                            <comment id="13629757" author="vijay2win@yahoo.com" created="Fri, 12 Apr 2013 04:00:10 +0000"  >&lt;p&gt;This is my theory:&lt;/p&gt;

&lt;p&gt;2M KV with Measure.measure() will take 96,000,000 or 96M (2 *24 * 2000000 bytes) will fit in key cache.&lt;br/&gt;
2M KV with measureDeep() will take 96M + 48M (48 * 2000000 + 24 * 2000000) where 48 is the index min size and 24 is the key size.&lt;/p&gt;

&lt;p&gt;Hence there is a eviction overhead on the keycache which you dont have in Measure.measure().&lt;br/&gt;
Give the above if you have the key cache of 300M and re test both v3 should show a better performance.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Completed warmup!, &lt;span class=&quot;code-object&quot;&gt;Number&lt;/span&gt; of Iteratoions: 1000000
Using reflection took: 8037
Using 4860-v3 took: 90
Using MemoryMeter meter.measure(key) took: 190
Using MemoryMeter meter.measureDeep(key) took: 1002
Using 4860-v3 RowIndexEntry took: 14
Using MemoryMeter meter.measure(RowIndexEntry(i)) took: 104
Using MemoryMeter meter.measureDeep(RowIndexEntry(i)) took: 459
Size of Meter.measure key: 24
Size of Meter.measure index: 24
Size of Meter.measureDeep key: 48
Size of Meter.measureDeep index: 24
Size of key: 48
Size of index: 24
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13629783" author="vijay2win@yahoo.com" created="Fri, 12 Apr 2013 04:39:27 +0000"  >&lt;p&gt;Added unit test and pushed to &lt;a href=&quot;https://github.com/Vijay2win/cassandra/commits/4860-v4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/Vijay2win/cassandra/commits/4860-v4&lt;/a&gt;, Thanks!&lt;/p&gt;</comment>
                            <comment id="13632970" author="enigmacurry" created="Tue, 16 Apr 2013 16:25:33 +0000"  >&lt;p&gt;I increased my key_cache_size_in_mb and did in fact get better results:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Averages from the middle 80% of values:
interval_op_rate          : 27848
interval_key_rate         : 27848
latency median            : 0.7
latency 95th percentile   : 1.4
latency 99.9th percentile : 22.4
Total operation time      : 00:01:20
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The old measure() way with 300M key cache:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Running stress : -n 2000000 -o read -i 1
output is hidden &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; collecting stats...
Averages from the middle 80% of values:
interval_op_rate          : 27877
interval_key_rate         : 27877
latency median            : 0.7
latency 95th percentile   : 1.5
latency 99.9th percentile : 23.4
Total operation time      : 00:01:20
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;This is roughly equal to the original messure() method in read performance, I&apos;m happy with it!&lt;/p&gt;</comment>
                            <comment id="13632991" author="jbellis" created="Tue, 16 Apr 2013 16:38:10 +0000"  >&lt;blockquote&gt;
&lt;p&gt;2M KV with Measure.measure() will take 96,000,000 or 96M (2 *24 * 2000000 bytes) will fit in key cache.&lt;br/&gt;
2M KV with measureDeep() will take 96M + 48M (48 * 2000000 + 24 * 2000000) where 48 is the index min size and 24 is the key size.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Clarifying for my own benefit: Vijay is saying that before the original fix, the key cache underestimated the real entry size by 1/3, so a configured size of 2M would actually allow caching 3M worth of entries.  So to compare performance apples-to-apples, we need to allow the fixed code to use an equivalent size.&lt;/p&gt;</comment>
                            <comment id="13632999" author="jbellis" created="Tue, 16 Apr 2013 16:44:47 +0000"  >&lt;p&gt;Suggest standardizing on &lt;tt&gt;memorySize&lt;/tt&gt; instead of &lt;tt&gt;size&lt;/tt&gt; in IMeasureableMemory, to avoid confusion with size = number of contained elements.  Otherwise +1.&lt;/p&gt;</comment>
                            <comment id="13633668" author="vijay2win@yahoo.com" created="Wed, 17 Apr 2013 01:44:34 +0000"  >&lt;p&gt;Wow that sounds lot better than my cryptic explanation &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Committed to 1.2 and trunk, Thanks Ryan and Jonathan!&lt;/p&gt;</comment>
                            <comment id="13650936" author="tjake" created="Tue, 7 May 2013 15:02:27 +0000"  >&lt;p&gt;I just rolled this patch and am hitting this exception:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;) liveRatio is 7.8818923401518655 (just-counted was 7.8818923401518655).  calculation took 825ms &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 78373 columns
ERROR [ReadStage:14] 2013-05-07 11:01:44,555 CassandraDaemon.java (line 175) Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[ReadStage:14,5,main]
java.lang.AssertionError: Serialized size cannot be more than 2GB/&lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE
	at org.apache.cassandra.cache.ConcurrentLinkedHashCache$1.weightOf(ConcurrentLinkedHashCache.java:58)
	at org.apache.cassandra.cache.ConcurrentLinkedHashCache$1.weightOf(ConcurrentLinkedHashCache.java:54)
	at com.googlecode.concurrentlinkedhashmap.ConcurrentLinkedHashMap$BoundedEntryWeigher.weightOf(ConcurrentLinkedHashMap.java:1447)
	at com.googlecode.concurrentlinkedhashmap.ConcurrentLinkedHashMap.put(ConcurrentLinkedHashMap.java:764)
	at com.googlecode.concurrentlinkedhashmap.ConcurrentLinkedHashMap.put(ConcurrentLinkedHashMap.java:743)
	at org.apache.cassandra.cache.ConcurrentLinkedHashCache.put(ConcurrentLinkedHashCache.java:101)
	at org.apache.cassandra.cache.ConcurrentLinkedHashCache.put(ConcurrentLinkedHashCache.java:27)
	at org.apache.cassandra.cache.InstrumentingCache.put(InstrumentingCache.java:44)
	at org.apache.cassandra.io.sstable.SSTableReader.cacheKey(SSTableReader.java:696)
	at org.apache.cassandra.io.sstable.SSTableReader.getPosition(SSTableReader.java:834)
	at org.apache.cassandra.io.sstable.SSTableReader.getPosition(SSTableReader.java:717)
	at org.apache.cassandra.db.columniterator.SSTableSliceIterator.&amp;lt;init&amp;gt;(SSTableSliceIterator.java:43)
	at org.apache.cassandra.db.filter.SliceQueryFilter.getSSTableColumnIterator(SliceQueryFilter.java:101)
	at org.apache.cassandra.db.filter.QueryFilter.getSSTableColumnIterator(QueryFilter.java:68)
	at org.apache.cassandra.db.CollationController.collectAllData(CollationController.java:274)
	at org.apache.cassandra.db.CollationController.getTopLevelColumns(CollationController.java:65)
	at org.apache.cassandra.db.ColumnFamilyStore.getTopLevelColumns(ColumnFamilyStore.java:1357)
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1214)
	at org.apache.cassandra.db.ColumnFamilyStore.getColumnFamily(ColumnFamilyStore.java:1126)
	at org.apache.cassandra.db.Table.getRow(Table.java:347)
	at org.apache.cassandra.db.SliceFromReadCommand.getRow(SliceFromReadCommand.java:70)
	at org.apache.cassandra.db.ReadVerbHandler.doVerb(ReadVerbHandler.java:44)
	at org.apache.cassandra.net.MessageDeliveryTask.run(MessageDeliveryTask.java:56)
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:662)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13650944" author="jbellis" created="Tue, 7 May 2013 15:09:24 +0000"  >&lt;p&gt;I don&apos;t suppose you can turn that into a failing unit test?  It&apos;s not obvious to me what could be different about what you&apos;re doing, and what we&apos;re already doing in the &lt;span class=&quot;error&quot;&gt;&amp;#91;passing&amp;#93;&lt;/span&gt; tests.&lt;/p&gt;</comment>
                            <comment id="13650954" author="tjake" created="Tue, 7 May 2013 15:19:25 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=carlyeks&quot; class=&quot;user-hover&quot; rel=&quot;carlyeks&quot;&gt;carlyeks&lt;/a&gt; is on the case... &lt;/p&gt;</comment>
                            <comment id="13650972" author="tjake" created="Tue, 7 May 2013 15:38:18 +0000"  >&lt;p&gt;Looking at the code this line looks suspect....&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/da93a1cfe483a1522b2c149d287279a74e43a8a9/src/java/org/apache/cassandra/utils/ObjectSizes.java#L65&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/da93a1cfe483a1522b2c149d287279a74e43a8a9/src/java/org/apache/cassandra/utils/ObjectSizes.java#L65&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;If you pass in a mmapped bytebuffer I don&apos;t think capacity is the right thing to use...&lt;/p&gt;</comment>
                            <comment id="13650982" author="jbellis" created="Tue, 7 May 2013 15:50:00 +0000"  >&lt;p&gt;Agreed, the way we use BB it should be .remaining&lt;/p&gt;</comment>
                            <comment id="13651002" author="tjake" created="Tue, 7 May 2013 16:13:33 +0000"  >&lt;p&gt;Also do we even care about direct byte buffers? it&apos;s not on heap so we should just skip those?&lt;/p&gt;</comment>
                            <comment id="13651008" author="jbellis" created="Tue, 7 May 2013 16:16:28 +0000"  >&lt;p&gt;Don&apos;t we make a copy for the row cache entry?  If we don&apos;t we probably should.&lt;/p&gt;</comment>
                            <comment id="13651030" author="carlyeks" created="Tue, 7 May 2013 16:38:19 +0000"  >&lt;p&gt;Providing a couple of tests which show the broken byte buffer. Don&apos;t think that we should be comparing against the meter for these, but since it appears to be compared against that in the other parts, I followed the same specification.&lt;/p&gt;</comment>
                            <comment id="13651088" author="vijay2win@yahoo.com" created="Tue, 7 May 2013 17:27:05 +0000"  >&lt;p&gt;We should probably check BB isDirect and skip adding the BB overhead, honestly it was an oversight. &lt;br/&gt;
We should probably just switch to remaining() for the rest to be safe.&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Don&apos;t we make a copy for the row cache entry? If we don&apos;t we probably should.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Do you want to open a separate ticket on this? Since this happens on CLHM (in-heap cache) i am not sure if it will benefit from bytes copying.&lt;/p&gt;</comment>
                            <comment id="13651105" author="jbellis" created="Tue, 7 May 2013 17:50:56 +0000"  >&lt;p&gt;I&apos;m more worried about safety issues after a mapped buffer like Jake&apos;s gets unmapped.&lt;/p&gt;

&lt;p&gt;Edit: but if he&apos;s using 1.2.4 safely then I guess the &quot;clean out row cache after compaction&quot; code is working pretty well.&lt;/p&gt;</comment>
                            <comment id="13651127" author="tjake" created="Tue, 7 May 2013 18:08:51 +0000"  >&lt;p&gt;I&apos;m not using 1.2.4. We went from 1.2.3 -&amp;gt; 1.2.5&lt;/p&gt;

&lt;p&gt;Our workaround is to disable the keycache&lt;/p&gt;</comment>
                            <comment id="13651239" author="jbellis" created="Tue, 7 May 2013 19:55:54 +0000"  >&lt;p&gt;I did some code diving but just got more confused.  Here&apos;s the KeyKacheKey relevant parts:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;byte&lt;/span&gt;[] key;

    &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; KeyCacheKey(Descriptor desc, ByteBuffer key)
    {
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.desc = desc;
        &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.key = ByteBufferUtil.getArray(key);
        &lt;span class=&quot;code-keyword&quot;&gt;assert&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;.key != &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;;
    }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ol&gt;
	&lt;li&gt;we are indeed making a defensive copy&lt;/li&gt;
	&lt;li&gt;we don&apos;t even have a ByteBuffer involved here, so while &lt;tt&gt;.capacity&lt;/tt&gt; could sometimes not be what we want, it&apos;s not causing the problem here.  (Other times, &lt;tt&gt;capacity&lt;/tt&gt; &lt;b&gt;could&lt;/b&gt; be what we want; I don&apos;t think there&apos;s a one-size-fits-all answer here.  JAMM has an &lt;tt&gt;omitSharedBufferOverhead&lt;/tt&gt; setting to configure this behavior.)&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;I think we need to look elsewhere for our smoking gun.&lt;/p&gt;</comment>
                            <comment id="13651344" author="tjake" created="Tue, 7 May 2013 21:43:13 +0000"  >&lt;p&gt;I think the issue is the RowIndexEntry size. If you look at IndexInfo.memorySize() those bytebuffers would have the wrong capacity since we mmap them...&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; memorySize()
        {
            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; fields = ObjectSizes.getSize(firstName) + ObjectSizes.getSize(lastName) + 8 + 8; 
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ObjectSizes.getFieldSize(fields);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13651347" author="vijay2win@yahoo.com" created="Tue, 7 May 2013 21:44:22 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Providing a couple of tests which show the broken byte buffer. &lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;No it is not broken, MeasureDeep was omitting the shared buffer size... which is kind of wrong... try the following.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        ByteBuffer bb = ByteBuffer.allocate(1000);
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; objectSize = ObjectSizes.getSize(bb);
        MemoryMeter meter2 = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; MemoryMeter();
        &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; meterSize = meter2.measureDeep(bb);
        Assert.assertEquals(meterSize, objectSize);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
&lt;p&gt;Here&apos;s the KeyKacheKey relevant parts&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Agreed! Looks like error is from CLHC, i am still not sure where its broken MappedFileDataInput.readBytes copies anyways.... &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;?&lt;/p&gt;</comment>
                            <comment id="13651365" author="jbellis" created="Tue, 7 May 2013 22:03:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;i am still not sure where its broken MappedFileDataInput.readBytes copies anyways&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Also a good point.  For reference:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-comment&quot;&gt;// we have to copy the data in &lt;span class=&quot;code-keyword&quot;&gt;case&lt;/span&gt; we unreference the underlying sstable.  See CASSANDRA-3179
&lt;/span&gt;        ByteBuffer clone = ByteBuffer.allocate(bytes.remaining());
        clone.put(bytes);
        clone.flip();
        &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; clone;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13656276" author="carlyeks" created="Mon, 13 May 2013 19:37:19 +0000"  >&lt;p&gt;The issue is in the following code from RowIndexEntry:208&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; internal = 0;
            &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (IndexHelper.IndexInfo idx : columnsIndex)
                internal += idx.memorySize();
            &lt;span class=&quot;code-object&quot;&gt;long&lt;/span&gt; listSize = ObjectSizes.getFieldSize(ObjectSizes.getArraySize(columnsIndex.size(), internal) + 4);
            &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt; ObjectSizes.getFieldSize(deletionTime.memorySize() + listSize);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The list size is &lt;b&gt;not&lt;/b&gt; getArraySize(columnsIndex.size(), internal). That multiplies the number of elements by the size that was just calculated.&lt;/p&gt;

&lt;p&gt;It should instead be:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ObjectSizes.getFieldSize(internal + 4)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are no other suspicious usages of getArraySize, the only other ones are from the ObjectSizes file for byte array sizes (those make sense).&lt;/p&gt;</comment>
                            <comment id="13656296" author="jbellis" created="Mon, 13 May 2013 20:04:48 +0000"  >&lt;p&gt;Moved to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5564&quot; title=&quot;fix memorySize bugs&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5564&quot;&gt;&lt;del&gt;CASSANDRA-5564&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12575941" name="0001-4860-v2.patch" size="16799" author="vijay2win@yahoo.com" created="Thu, 28 Mar 2013 19:51:10 +0000"/>
                            <attachment id="12576219" name="0001-4860-v3.patch" size="22528" author="vijay2win@yahoo.com" created="Sat, 30 Mar 2013 03:55:05 +0000"/>
                            <attachment id="12553261" name="0001-CASSANDRA-4860-for-11.patch" size="1081" author="vijay2win@yahoo.com" created="Tue, 13 Nov 2012 04:00:31 +0000"/>
                            <attachment id="12553262" name="0001-CASSANDRA-4860.patch" size="1151" author="vijay2win@yahoo.com" created="Tue, 13 Nov 2012 04:00:31 +0000"/>
                            <attachment id="12582969" name="4860-fix-row-index-entry.patch" size="767" author="carlyeks" created="Mon, 13 May 2013 19:37:19 +0000"/>
                            <attachment id="12576601" name="4860-perf-test.zip" size="6955" author="vijay2win@yahoo.com" created="Tue, 2 Apr 2013 16:50:12 +0000"/>
                            <attachment id="12582117" name="4860-tests.patch" size="1382" author="carlyeks" created="Tue, 7 May 2013 16:38:19 +0000"/>
                            <attachment id="12575829" name="trunk-4860-revert.patch" size="1204" author="enigmacurry" created="Thu, 28 Mar 2013 04:54:17 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[vijay2win@yahoo.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>250881</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 28 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0b27z:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>62472</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>enigmacurry</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>