<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:21:47 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-2317] Column family deletion time is not always reseted after gc_grace</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-2317</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Follow up of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2305&quot; title=&quot;Tombstoned rows not purged from cache after gcgraceseconds&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2305&quot;&gt;&lt;del&gt;CASSANDRA-2305&lt;/del&gt;&lt;/a&gt;.&lt;br/&gt;
Reproducible (thanks to Jeffrey Wang) by: &lt;/p&gt;

&lt;p&gt;Create a CF with gc_grace_seconds = 0 and no row cache.&lt;br/&gt;
Insert row X, col A with timestamp 0.&lt;br/&gt;
Insert row X, col B with timestamp 2.&lt;br/&gt;
Remove row X with timestamp 1 (expect col A to disappear, col B to stay).&lt;br/&gt;
Wait 1 second.&lt;br/&gt;
Force flush and compaction.&lt;br/&gt;
Insert row X, col A with timestamp 0.&lt;br/&gt;
Read row X, col A (see nothing).&lt;/p&gt;</description>
                <environment></environment>
        <key id="12501241">CASSANDRA-2317</key>
            <summary>Column family deletion time is not always reseted after gc_grace</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Sat, 12 Mar 2011 11:19:34 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:04 +0000</updated>
                            <resolved>Mon, 4 Jul 2011 14:36:22 +0000</resolved>
                                        <fixVersion>1.0.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                    <workratio workratioPercent="0"/>
                                    <progress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="0">
                                    <originalProgress>
                                                    <row percentage="100" backgroundColor="#89afd7"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="0" backgroundColor="#51a825"/>
                                                    <row percentage="100" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                    <timeoriginalestimate seconds="3600">1h</timeoriginalestimate>
                            <timeestimate seconds="3600">1h</timeestimate>
                                        <comments>
                            <comment id="13006029" author="slebresne" created="Sat, 12 Mar 2011 11:20:35 +0000"  >&lt;p&gt;Adding patch against 0.7.&lt;/p&gt;

&lt;p&gt;First patch is a unit test to reproduce the failure, patch 2 is the fix.&lt;/p&gt;</comment>
                            <comment id="13006038" author="slebresne" created="Sat, 12 Mar 2011 11:54:48 +0000"  >&lt;p&gt;I realize this fix don&apos;t take the cache into account. I&apos;ll attach an updated patch asap.&lt;/p&gt;</comment>
                            <comment id="13006044" author="jbellis" created="Sat, 12 Mar 2011 13:12:22 +0000"  >&lt;p&gt;How do you have CF objects around at all post-purge?&lt;/p&gt;</comment>
                            <comment id="13006409" author="slebresne" created="Mon, 14 Mar 2011 13:47:38 +0000"  >&lt;blockquote&gt;&lt;p&gt;How do you have CF objects around at all post-purge?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The problem is actually with cf objects that don&apos;t get fully purged. Those still retain their markedForDeleteAt and localDeletionTime after compaction even though it could be way past gc_grace. That is, a deletion can easily live way past gc_grace + compaction.&lt;/p&gt;

&lt;p&gt;As it turns out, super columns also suffers for the same problem.&lt;/p&gt;

&lt;p&gt;Because it felt a bit annoying to have to fix the problem in 2 places, and because that&apos;s not the first time that happens, the first attached is a refactoring one, that introduces an AbstractColumnContainer class that factor common code to ColumnFamily and SuperColumn.&lt;/p&gt;

&lt;p&gt;The second patch introduces unit tests for column family and super columns and third patch is the fix. It introduces a new structure to hold both markedDeletedAt and localDeletionTime so that we are able to set both of those together atomically. This is necessary for the second part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2305&quot; title=&quot;Tombstoned rows not purged from cache after gcgraceseconds&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2305&quot;&gt;&lt;del&gt;CASSANDRA-2305&lt;/del&gt;&lt;/a&gt;.  I think that anyhow it was not fully correct to update them non atomically.&lt;/p&gt;

&lt;p&gt;Note that the third patch depends on the patch for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2279&quot; title=&quot;Tombstones not collected post-repair&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2279&quot;&gt;&lt;del&gt;CASSANDRA-2279&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;All patches are against 0.7.&lt;/p&gt;</comment>
                            <comment id="13006426" author="jbellis" created="Mon, 14 Mar 2011 14:27:29 +0000"  >&lt;p&gt;Oh, so the problem is that we&apos;re not actually losing information (when a CF contains non-deleted data) that we may lose otherwise?&lt;/p&gt;

&lt;p&gt;Is that really worth adding a bunch of complexity to &quot;fix?&quot;&lt;/p&gt;</comment>
                            <comment id="13006449" author="slebresne" created="Mon, 14 Mar 2011 15:01:35 +0000"  >&lt;p&gt;This is clearly not of big importance.&lt;/p&gt;

&lt;p&gt;I however think that we should fix this for coherence sake. Tombstones have side effects on client queries and tombstone collection too (it&apos;s not just an internal detail). As such, we should make the behavior as coherent as possible. That a deletion always has effect until the first compaction after gc_grace would be more coherent that the current status quo. The fact that Jeffrey was surprised and that we assume right away that it was a bug proves that, I think.&lt;/p&gt;

&lt;p&gt;And the fix is actually fairly simple, even though my patch doesn&apos;t do it justice. The first patch is really just a refactoring that I think should have been done a long time ago. I&apos;m happy to create a ticket for this specifically if we prefer, but I just think it is stupid to not factor that code.&lt;/p&gt;

&lt;p&gt;The second part of the patch is to put markedDeletedAt and localDeletionTime in a common structure that we CAS for changes. Again, this is because right now I think we have a race condition when updating those two values. That is, we could end up with the markedDeleteAt of a given operation but the localDeletionTime of another one. This could also be put on another ticket (I just tend to be lazy so I&apos;ve put everything here, sorry).&lt;/p&gt;

&lt;p&gt;Once those are done, the fix for this specific ticket is really just the maybeResetDeletionTime() function.&lt;/p&gt;</comment>
                            <comment id="13048725" author="jbellis" created="Mon, 13 Jun 2011 19:16:18 +0000"  >&lt;p&gt;doesn&apos;t this mean that for a CF w/ no tombstone, we create a new deletioninfo every call to maybeReset?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;if (current.localDeletionTime &amp;gt; gcBefore || deletionInfo.compareAndSet(current, new DeletionInfo()))&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;otherwise, +1 for trunk.&lt;/p&gt;</comment>
                            <comment id="13053510" author="paladin8" created="Wed, 22 Jun 2011 22:33:05 +0000"  >&lt;p&gt;Does anyone know whether this is fixed in 0.8? We are thinking of upgrading soon, but I don&apos;t want to try to apply the 0.7 patch to 0.8...&lt;/p&gt;</comment>
                            <comment id="13053534" author="jbellis" created="Wed, 22 Jun 2011 23:19:30 +0000"  >&lt;p&gt;&quot;Unresolved&quot; means not fixed anywhere yet.&lt;/p&gt;</comment>
                            <comment id="13059460" author="slebresne" created="Mon, 4 Jul 2011 14:37:42 +0000"  >&lt;p&gt;Committed to trunk (as I agree this should really go there).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;doesn&apos;t this mean that for a CF w/ no tombstone, we create a new deletioninfo every call to maybeReset?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You&apos;re right, I&apos;ve included a current.localDeletionTime == Integer.MIN_VALUE in the condition to escape early in that case.&lt;/p&gt;</comment>
                            <comment id="13059477" author="hudson" created="Mon, 4 Jul 2011 15:20:32 +0000"  >&lt;p&gt;Integrated in Cassandra #948 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra/948/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra/948/&lt;/a&gt;)&lt;br/&gt;
    Reset CF and SC deletion time after gc_grace&lt;br/&gt;
patch by slebresne; reviewed by jbellis for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-2317&quot; title=&quot;Column family deletion time is not always reseted after gc_grace&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-2317&quot;&gt;&lt;del&gt;CASSANDRA-2317&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;slebresne : &lt;a href=&quot;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1142690&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://svn.apache.org/viewcvs.cgi/?root=Apache-SVN&amp;amp;view=rev&amp;amp;rev=1142690&lt;/a&gt;&lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/ColumnFamily.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/filter/QueryFilter.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/RowMutation.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/SuperColumn.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/CHANGES.txt&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/test/unit/org/apache/cassandra/service/RowResolverTest.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/test/unit/org/apache/cassandra/db/RowTest.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/IColumnContainer.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/test/unit/org/apache/cassandra/db/compaction/CompactionsPurgeTest.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/AbstractColumnContainer.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/ColumnFamilyStore.java&lt;/li&gt;
	&lt;li&gt;/cassandra/trunk/src/java/org/apache/cassandra/db/ColumnFamilySerializer.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                    </comments>
                    <attachments>
                            <attachment id="12473561" name="0001-Add-AbstractColumnContainer-to-factor-common-parts-o.patch" size="27680" author="slebresne" created="Mon, 14 Mar 2011 13:47:38 +0000"/>
                            <attachment id="12473562" name="0002-Add-unit-test.patch" size="5009" author="slebresne" created="Mon, 14 Mar 2011 13:47:38 +0000"/>
                            <attachment id="12473563" name="0003-Reset-CF-and-SC-deletion-time-after-compaction.patch" size="11598" author="slebresne" created="Mon, 14 Mar 2011 13:47:38 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>20558</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            14 years, 21 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0ganz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>93158</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>