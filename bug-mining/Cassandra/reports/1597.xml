<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:32:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3741] OOMs because delete operations are not accounted</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3741</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Currently we are moving to new data format where new format is written into new CFs and old one is deleted key-by-key. &lt;br/&gt;
I have started getting OOMs and found out that delete operations are not accounted and so, column families are not flushed (changed == 0 with delete only operations) by storage manager.&lt;/p&gt;

&lt;p&gt;This is pull request that fixed this problem for me: &lt;a href=&quot;https://github.com/apache/cassandra/pull/5&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/5&lt;/a&gt;&lt;/p&gt;</description>
                <environment>&lt;p&gt;FreeBSD&lt;/p&gt;</environment>
        <key id="12538312">CASSANDRA-3741</key>
            <summary>OOMs because delete operations are not accounted</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="akolyadenko">Andriy Kolyadenko</assignee>
                                    <reporter username="tivv">Vitalii Tymchyshyn</reporter>
                        <labels>
                    </labels>
                <created>Fri, 13 Jan 2012 12:33:52 +0000</created>
                <updated>Tue, 14 Oct 2025 12:13:56 +0000</updated>
                            <resolved>Thu, 3 May 2012 15:46:27 +0000</resolved>
                                        <fixVersion>1.1.1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>4</watches>
                                                                                                                <comments>
                            <comment id="13185742" author="jbellis" created="Fri, 13 Jan 2012 18:46:30 +0000"  >&lt;p&gt;Thanks, Vitalii!&lt;/p&gt;

&lt;p&gt;Unfortunately we can&apos;t use that patch as is because adding ops * 20 in there is going to throw off the size calculation for other workloads.&lt;/p&gt;

&lt;p&gt;Note that the &quot;throughput&quot; size for a deletion is NOT zero (see Column.size implementation).  It sounds like you abruptly changed your workload from doing a bunch of larger inserts, then hit it with a ton of deletes all at once and OOMed before it was able to update its liveRatio estimate.&lt;/p&gt;

&lt;p&gt;So the real problem is that if you change workloads dramatically enough, Cassandra&apos;s estimates can be off.&lt;/p&gt;</comment>
                            <comment id="13185836" author="hsn" created="Fri, 13 Jan 2012 20:43:05 +0000"  >&lt;p&gt;How can you OOM if you replace large inserts with small deletes?&lt;/p&gt;</comment>
                            <comment id="13186448" author="tivv" created="Sun, 15 Jan 2012 08:54:12 +0000"  >&lt;p&gt;Throughput size for deletion IS 0 for me. I am not deleting for some columns, but all columns in a key and operation has 0 columns in this case, this means 0 throughput so I did introduce an overhead for memory operation storage that looks good for me (20 bytes is ~ConcurrentMap size).&lt;/p&gt;

&lt;p&gt;To note: I was getting OOM on startup/log replay. &lt;/p&gt;

&lt;p&gt;The problem is that I have started delete-only workload from some Column Families and this won&apos;t change as all inserts go into another column families: we are moving. And for full-key delete-only throughput is 0&lt;/p&gt;</comment>
                            <comment id="13267238" author="akolyadenko" created="Thu, 3 May 2012 06:20:24 +0000"  >&lt;p&gt;Another attempt to fix this: &lt;a href=&quot;https://github.com/apache/cassandra/pull/10&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/10&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Please consider my patch. It&apos;s very annoying to have Cassandra dying in such situations.&lt;/p&gt;</comment>
                            <comment id="13267506" author="jbellis" created="Thu, 3 May 2012 15:36:32 +0000"  >&lt;p&gt;Thanks, Andriy.  You (and Vitalii) are right; whole-row deletions did indeed have zero throughput because of that behavior.&lt;/p&gt;

&lt;p&gt;Committed with a change to 12 bytes (long + int from deletion info) to match what we do with Column sizes.  (We measure the serialized size in Memtable.currentThroughput, then multiply by liveRatio to get a better estimate of the in-memory size.  Mixing internal overhead as in CSLM would actually double count that.  I&apos;ve also introduced &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4215&quot; title=&quot;clarify distinction between in-memory size() method and on-disk serializedSize() for CF, Column classes&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4215&quot;&gt;&lt;del&gt;CASSANDRA-4215&lt;/del&gt;&lt;/a&gt; to clean this up more for 1.2.&lt;/p&gt;</comment>
                            <comment id="13267510" author="jbellis" created="Thu, 3 May 2012 15:39:11 +0000"  >&lt;p&gt;(That said, truncate is still the right solution for mass deletes.)&lt;/p&gt;</comment>
                            <comment id="13267781" author="JIRAUSER308715" created="Thu, 3 May 2012 20:33:30 +0000"  >&lt;p&gt;Procedural question, for git stuff should we still be attaching patches to JIRA?  Or is a link to the github diff enough?&lt;/p&gt;</comment>
                            <comment id="13267783" author="jbellis" created="Thu, 3 May 2012 20:38:56 +0000"  >&lt;p&gt;Intent to contribute in public is enough.  github pull requests (and patches sent to the mailing list for that matter) are fine.&lt;/p&gt;

&lt;p&gt;For the purposes of record-keeping though, we like to associate these with Jira tickets.&lt;/p&gt;</comment>
                            <comment id="13458849" author="hsn" created="Wed, 19 Sep 2012 16:56:07 +0000"  >&lt;p&gt;was this backported to cassandra 1.0?&lt;/p&gt;</comment>
                            <comment id="13458860" author="jbellis" created="Wed, 19 Sep 2012 17:08:32 +0000"  >&lt;p&gt;No, this is a sensitive area of the code and we don&apos;t want to risk destabilizing it.&lt;/p&gt;</comment>
                            <comment id="13458932" author="hsn" created="Wed, 19 Sep 2012 18:32:00 +0000"  >&lt;p&gt;1.0 is already destabilized by this bug. If you want to have minimal effect, then add just 1 byte to live bytes count for every delete. In non delete only workload, it will have minimal effect.&lt;/p&gt;

&lt;p&gt;Its important to have non zero count otherwise it will not be flushed to disk on memory pressure.&lt;/p&gt;</comment>
                            <comment id="13461662" author="hsn" created="Mon, 24 Sep 2012 08:20:01 +0000"  >&lt;p&gt;If you do not want to get fixed, then it should be documented as known bug in NEWS.TXT&lt;/p&gt;</comment>
                            <comment id="13653606" author="akolyadenko" created="Fri, 10 May 2013 07:17:04 +0000"  >&lt;p&gt;Just would like to report that I have the same behavior with 1.2.4.&lt;/p&gt;</comment>
                            <comment id="13663802" author="hsn" created="Wed, 22 May 2013 05:43:18 +0000"  >&lt;p&gt;i retested it. bug from 1.0 do not exists in 1.1 and 1.2. But its still not optimal and can lead to OOM because it do not adds enough bytes count for tombstone to live data count.&lt;/p&gt;

&lt;p&gt;If i remember some hardcoded constant was used, it needs to be raised.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[akolyadenko]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>223818</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 26 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gno7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95265</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>