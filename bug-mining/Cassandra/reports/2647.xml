<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:43:15 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6797] compaction and scrub data directories race on startup</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6797</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>
&lt;p&gt;Hi,  &lt;/p&gt;

&lt;p&gt;On doing a rolling restarting of a 2.0.5 cluster in several environments I&apos;m seeing the following error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
 INFO [CompactionExecutor:1] 2014-03-03 17:11:07,549 CompactionTask.java (line 115) Compacting [SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/Users/Matthew/.ccm/compaction_race/node1/data/system/local/system-local-jb-13-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&apos;/Users/Matthew/.ccm/compactio
n_race/node1/data/system/local/system-local-jb-15-Data.db&lt;span class=&quot;code-quote&quot;&gt;&apos;), SSTableReader(path=&apos;&lt;/span&gt;/Users/Matthew/.ccm/compaction_race/node1/data/system/local/system-local-jb-16-Data.db&lt;span class=&quot;code-quote&quot;&gt;&apos;), SSTableReader(path=&apos;&lt;/span&gt;/Users/Matthew/.ccm/compaction_race/node1/data/system/local/syst
em-local-jb-14-Data.db&apos;)]
 INFO [CompactionExecutor:1] 2014-03-03 17:11:07,557 ColumnFamilyStore.java (line 254) Initializing system_traces.sessions
 INFO [CompactionExecutor:1] 2014-03-03 17:11:07,560 ColumnFamilyStore.java (line 254) Initializing system_traces.events
 WARN [main] 2014-03-03 17:11:07,608 ColumnFamilyStore.java (line 473) Removing orphans &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; /Users/Matthew/.ccm/compaction_race/node1/data/system/local/system-local-jb-13: [CompressionInfo.db, Filter.db, Index.db, TOC.txt, Summary.db, Data.db, Statistics.
db]
ERROR [main] 2014-03-03 17:11:07,609 CassandraDaemon.java (line 479) Exception encountered during startup
java.lang.AssertionError: attempted to delete non-existing file system-local-jb-13-CompressionInfo.db
        at org.apache.cassandra.io.util.FileUtils.deleteWithConfirm(FileUtils.java:111)
        at org.apache.cassandra.io.util.FileUtils.deleteWithConfirm(FileUtils.java:106)
        at org.apache.cassandra.db.ColumnFamilyStore.scrubDataDirectories(ColumnFamilyStore.java:476)
        at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:264)
        at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:462)
        at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:552)
 INFO [CompactionExecutor:1] 2014-03-03 17:11:07,612 CompactionTask.java (line 275) Compacted 4 sstables to [/Users/Matthew/.ccm/compaction_race/node1/data/system/local/system-local-jb-17,].  10,963 bytes to 5,572 (~50% of original) in 57ms = 0.093226MB/s.  4 total partitions merged to 1.  Partition merge counts were {4:1, }

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Seems like a potential race, since compactions are occurring whilst the existing data directories are being scrubbed.&lt;br/&gt;
Probably an in progress compaction looks like an incomplete one and results in it being attempted to be scrubbed whilst in progress. &lt;br/&gt;
On the attempt to delete in the scrubDataDirectories we discover that it no longer exists, presumably because it has now been compacted away. &lt;br/&gt;
This then causes an assertion error and the node fails to start up. &lt;/p&gt;

&lt;p&gt;Here is a ccm script which just stops and starts a 3 node 2.0.5 cluster repeatedly. &lt;br/&gt;
It seems to fairly reliably reproduce the problem, in less than ten iterations: &lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;#!/bin/bash

ccm create compaction_race -v 2.0.5
ccm populate -n 3
ccm start

&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in $(seq 0 1000); &lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt; 
    echo $i;
    ccm stop
    ccm start
    grep ERR ~/.ccm/compaction_race/*/logs/system.log;
done

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Someone else should probably confirm that this is what is going wrong,  &lt;br/&gt;
however if it is, the solution might be as simple as to disable autocompactions slightly earlier in CassandraDaemon.setup. &lt;/p&gt;

&lt;p&gt;Or alternatively if there isn&apos;t a good reason why we are first scrubbing the system tables and then scrubbing all keyspaces (including the system keyspace), you could perhaps just scrub solely the non system keyspaces on the second scrub.&lt;/p&gt;

&lt;p&gt;Please let me know if there is anything else I can provide.&lt;br/&gt;
Thanks,&lt;br/&gt;
Matt&lt;/p&gt;</description>
                <environment>&lt;p&gt;macos (and linux)&lt;/p&gt;</environment>
        <key id="12698552">CASSANDRA-6797</key>
            <summary>compaction and scrub data directories race on startup</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jmckenzie">Josh McKenzie</assignee>
                                    <reporter username="mbyrd">Matt Byrd</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>concurrency</label>
                            <label>starting</label>
                    </labels>
                <created>Tue, 4 Mar 2014 02:02:52 +0000</created>
                <updated>Wed, 15 Oct 2025 09:49:06 +0000</updated>
                            <resolved>Tue, 4 Mar 2014 23:11:22 +0000</resolved>
                                        <fixVersion>2.0.6</fixVersion>
                    <fixVersion>2.1 beta2</fixVersion>
                                    <component>Local/Compaction</component>
                    <component>Local/Startup and Shutdown</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13918938" author="mbyrd" created="Tue, 4 Mar 2014 02:10:11 +0000"  >&lt;p&gt;I think &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6795&quot; title=&quot;Forceful restart of C* during compaction on windows leads to exceptions on startup in scrubDataDirectories&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6795&quot;&gt;&lt;del&gt;CASSANDRA-6795&lt;/del&gt;&lt;/a&gt; may be the same or a similar issue, but since the reproduction is more complicated and the environment is windows, I thought I&apos;d file this ticket also.&lt;/p&gt;</comment>
                            <comment id="13920090" author="jmckenzie" created="Tue, 4 Mar 2014 21:58:52 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-6795&quot; title=&quot;Forceful restart of C* during compaction on windows leads to exceptions on startup in scrubDataDirectories&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-6795&quot;&gt;&lt;del&gt;CASSANDRA-6795&lt;/del&gt;&lt;/a&gt; is similar but should only show up on Windows as it&apos;s a file-handle race and *nix is far more tolerant of deleting open handles.  For 6797: attaching a simple patch against trunk to skip cleaning system keyspace on 2nd scrub as it&apos;s unnecessary and racing.&lt;/p&gt;</comment>
                            <comment id="13920182" author="jbellis" created="Tue, 4 Mar 2014 23:11:23 +0000"  >&lt;p&gt;LGTM, committed (with .equals instead of ==)&lt;/p&gt;</comment>
                            <comment id="13920185" author="jmckenzie" created="Tue, 4 Mar 2014 23:14:59 +0000"  >&lt;p&gt;I keep trying to beat the C++ out of me - those habits run deep.  Thanks for fixing that.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12698449">CASSANDRA-6795</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12632677" name="trunk-6797.patch" size="785" author="joshuamckenzie" created="Tue, 4 Mar 2014 22:00:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jmckenzie]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>376910</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 37 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1sy5b:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>377205</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325761">2.0.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>