<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:14:20 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13938] Default repair is broken, crashes other nodes participating in repair (in trunk)</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13938</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Running through a simple scenario to test some of the new repair features, I was not able to make a repair command work. Further, the exception seemed to trigger a nasty failure state that basically shuts down the netty connections for messaging &lt;b&gt;and&lt;/b&gt; CQL on the nodes transferring back data to the node being repaired. The following steps reproduce this issue consistently.&lt;/p&gt;

&lt;p&gt;Cassandra stress profile (probably not necessary, but this one provides a really simple schema and consistent data shape):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;keyspace: standard_long

keyspace_definition: |
  CREATE KEYSPACE standard_long WITH replication = {&apos;class&apos;:&apos;SimpleStrategy&apos;, &apos;replication_factor&apos;:3};
table: test_data

table_definition: |
  CREATE TABLE test_data (
  key text,
  ts bigint,
  val text,
  PRIMARY KEY (key, ts)
  ) WITH COMPACT STORAGE AND
  CLUSTERING ORDER BY (ts DESC) AND
  bloom_filter_fp_chance=0.010000 AND
  caching={&apos;keys&apos;:&apos;ALL&apos;, &apos;rows_per_partition&apos;:&apos;NONE&apos;} AND
  comment=&apos;&apos; AND
  dclocal_read_repair_chance=0.000000 AND
  gc_grace_seconds=864000 AND
  read_repair_chance=0.000000 AND
  compaction={&apos;class&apos;: &apos;SizeTieredCompactionStrategy&apos;} AND
  compression={&apos;sstable_compression&apos;: &apos;LZ4Compressor&apos;};

columnspec:
  - name: key
    population: uniform(1..50000000) # 50 million records available

  - name: ts
    cluster: gaussian(1..50) # Up to 50 inserts per record

  - name: val
    population: gaussian(128..1024) # varrying size of value data


insert:
  partitions: fixed(1) # only one insert per batch for individual partitions
  select: fixed(1)/1 # each insert comes in one at a time
  batchtype: UNLOGGED

queries:

  single:
    cql: select * from test_data where key = ? and ts = ? limit 1;

  series:
    cql: select key,ts,val from test_data where key = ? limit 10;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The commands to build and run:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;ccm create 4_0_test -v git:trunk -n 3 -s
ccm stress user profile=./histo-test-schema.yml ops\(insert=20,single=1,series=1\) duration=15s -rate threads=4
# flush the memtable just to get everything on disk
ccm node1 nodetool flush
ccm node2 nodetool flush
ccm node3 nodetool flush
# disable hints for nodes 2 and 3
ccm node2 nodetool disablehandoff
ccm node3 nodetool disablehandoff
# stop node1
ccm node1 stop
ccm stress user profile=./histo-test-schema.yml ops\(insert=20,single=1,series=1\) duration=45s -rate threads=4
# wait 10 seconds
ccm node1 start
# Note that we are local to ccm&apos;s nodetool install &apos;cause repair preview is not reported yet
node1/bin/nodetool repair --preview
node1/bin/nodetool repair standard_long test_data
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt; 

&lt;p&gt;The error outputs from the last repair command follow. First, this is stdout from node1:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ node1/bin/nodetool repair standard_long test_data
objc[47876]: Class JavaLaunchHelper is implemented in both /Library/Java/JavaVirtualMachines/jdk1.8.0_101.jdk/Contents/Home/bin/java (0x10274d4c0) and /Library/Java/JavaVirtualMachines/jdk1.8.0_101.jdk/Contents/Home/jre/lib/libinstrument.dylib (0x1047b64e0). One of the two will be used. Which one is undefined.
[2017-10-05 14:31:52,425] Starting repair command #4 (7e1a9150-a98e-11e7-ad86-cbd2801b8de2), repairing keyspace standard_long with repair options (parallelism: parallel, primary range: false, incremental: true, job threads: 1, ColumnFamilies: [test_data], dataCenters: [], hosts: [], previewKind: NONE, # of ranges: 3, pull repair: false, force repair: false)
[2017-10-05 14:32:07,045] Repair session 7e2e8e80-a98e-11e7-ad86-cbd2801b8de2 for range [(3074457345618258602,-9223372036854775808], (-9223372036854775808,-3074457345618258603], (-3074457345618258603,3074457345618258602]] failed with error Stream failed
[2017-10-05 14:32:07,048] null
[2017-10-05 14:32:07,050] Repair command #4 finished in 14 seconds
error: Repair job has failed with the error message: [2017-10-05 14:32:07,048] null
-- StackTrace --
java.lang.RuntimeException: Repair job has failed with the error message: [2017-10-05 14:32:07,048] null
    at org.apache.cassandra.tools.RepairRunner.progress(RepairRunner.java:122)
    at org.apache.cassandra.utils.progress.jmx.JMXNotificationProgressListener.handleNotification(JMXNotificationProgressListener.java:77)
    at com.sun.jmx.remote.internal.ClientNotifForwarder$NotifFetcher.dispatchNotification(ClientNotifForwarder.java:583)
    at com.sun.jmx.remote.internal.ClientNotifForwarder$NotifFetcher.doRun(ClientNotifForwarder.java:533)
    at com.sun.jmx.remote.internal.ClientNotifForwarder$NotifFetcher.run(ClientNotifForwarder.java:452)
    at com.sun.jmx.remote.internal.ClientNotifForwarder$LinearExecutor$1.run(ClientNotifForwarder.java:108)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;node1&apos;s &lt;tt&gt;system.log&lt;/tt&gt;:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [Stream-Deserializer-/127.0.0.2:63069-e0af297f] 2017-10-05 14:32:07,037 StreamResultFuture.java:193 - [Stream #85d4b790-a98e-11e7-ad86-cbd2801b8de2] Session with /127.0.0.2 is complete
INFO  [Stream-Deserializer-/127.0.0.3:63068-eb8f23bc] 2017-10-05 14:32:07,037 StreamResultFuture.java:193 - [Stream #85d3f440-a98e-11e7-ad86-cbd2801b8de2] Session with /127.0.0.3 is complete
ERROR [Streaming-Netty-Thread-5-5] 2017-10-05 14:32:07,037 StreamSession.java:617 - [Stream #85d3f440-a98e-11e7-ad86-cbd2801b8de2] Streaming error occurred on session with peer 127.0.0.3
java.nio.channels.ClosedChannelException: null
        at io.netty.channel.AbstractChannel$AbstractUnsafe.write(...)(Unknown Source) ~[netty-all-4.1.14.Final.jar:4.1.14.Final]
ERROR [Streaming-Netty-Thread-5-7] 2017-10-05 14:32:07,038 StreamSession.java:617 - [Stream #85d4b790-a98e-11e7-ad86-cbd2801b8de2] Streaming error occurred on session with peer 127.0.0.2
java.nio.channels.ClosedChannelException: null
        at io.netty.channel.AbstractChannel$AbstractUnsafe.write(...)(Unknown Source) ~[netty-all-4.1.14.Final.jar:4.1.14.Final]
WARN  [Stream-Deserializer-/127.0.0.2:63069-e0af297f] 2017-10-05 14:32:07,038 StreamResultFuture.java:220 - [Stream #85d4b790-a98e-11e7-ad86-cbd2801b8de2] Stream failed
WARN  [Stream-Deserializer-/127.0.0.3:63068-eb8f23bc] 2017-10-05 14:32:07,038 StreamResultFuture.java:220 - [Stream #85d3f440-a98e-11e7-ad86-cbd2801b8de2] Stream failed
WARN  [RepairJobTask:1] 2017-10-05 14:32:07,038 RepairJob.java:176 - [repair #7e2e8e80-a98e-11e7-ad86-cbd2801b8de2] test_data sync failed
ERROR [Stream-Deserializer-/127.0.0.3:7000-48246b87] 2017-10-05 14:32:07,041 StreamSession.java:757 - [Stream #85d3f440-a98e-11e7-ad86-cbd2801b8de2] Remote peer 127.0.0.3 failed stream session.
ERROR [RepairJobTask:1] 2017-10-05 14:32:07,042 RepairSession.java:326 - [repair #7e2e8e80-a98e-11e7-ad86-cbd2801b8de2] Session completed with the following error
org.apache.cassandra.streaming.StreamException: Stream failed
        at org.apache.cassandra.streaming.management.StreamEventJMXNotifier.onFailure(StreamEventJMXNotifier.java:88) ~[main/:na]
        at com.google.common.util.concurrent.Futures$6.run(Futures.java:1310) ~[guava-18.0.jar:na]
        at com.google.common.util.concurrent.MoreExecutors$DirectExecutor.execute(MoreExecutors.java:457) ~[guava-18.0.jar:na]
        at com.google.common.util.concurrent.ExecutionList.executeListener(ExecutionList.java:156) ~[guava-18.0.jar:na]
        at com.google.common.util.concurrent.ExecutionList.execute(ExecutionList.java:145) ~[guava-18.0.jar:na]
        at com.google.common.util.concurrent.AbstractFuture.setException(AbstractFuture.java:202) ~[guava-18.0.jar:na]
        at org.apache.cassandra.streaming.StreamResultFuture.maybeComplete(StreamResultFuture.java:221) ~[main/:na]
        at org.apache.cassandra.streaming.StreamResultFuture.handleSessionComplete(StreamResultFuture.java:197) ~[main/:na]
        at org.apache.cassandra.streaming.StreamSession.closeSession(StreamSession.java:488) ~[main/:na]
        at org.apache.cassandra.streaming.StreamSession.onError(StreamSession.java:601) ~[main/:na]
        at org.apache.cassandra.streaming.async.StreamingInboundHandler$StreamDeserializingTask.run(StreamingInboundHandler.java:207) ~[main/:na]
        at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_101]
ERROR [RepairJobTask:1] 2017-10-05 14:32:07,043 RepairRunnable.java:564 - Repair session 7e2e8e80-a98e-11e7-ad86-cbd2801b8de2 for range [(3074457345618258602,-9223372036854775808], (-9223372036854775808,-3074457345618258603], (-3074457345618258603,3074457345618258602]] failed with error Stream failed
org.apache.cassandra.streaming.StreamException: Stream failed
        at org.apache.cassandra.streaming.management.StreamEventJMXNotifier.onFailure(StreamEventJMXNotifier.java:88) ~[main/:na]
        at com.google.common.util.concurrent.Futures$6.run(Futures.java:1310) ~[guava-18.0.jar:na]
        at com.google.common.util.concurrent.MoreExecutors$DirectExecutor.execute(MoreExecutors.java:457) ~[guava-18.0.jar:na]
        at com.google.common.util.concurrent.ExecutionList.executeListener(ExecutionList.java:156) ~[guava-18.0.jar:na]
        at com.google.common.util.concurrent.ExecutionList.execute(ExecutionList.java:145) ~[guava-18.0.jar:na]
        at com.google.common.util.concurrent.AbstractFuture.setException(AbstractFuture.java:202) ~[guava-18.0.jar:na]
        at org.apache.cassandra.streaming.StreamResultFuture.maybeComplete(StreamResultFuture.java:221) ~[main/:na]
        at org.apache.cassandra.streaming.StreamResultFuture.handleSessionComplete(StreamResultFuture.java:197) ~[main/:na]
        at org.apache.cassandra.streaming.StreamSession.closeSession(StreamSession.java:488) ~[main/:na]
        at org.apache.cassandra.streaming.StreamSession.onError(StreamSession.java:601) ~[main/:na]
        at org.apache.cassandra.streaming.async.StreamingInboundHandler$StreamDeserializingTask.run(StreamingInboundHandler.java:207) ~[main/:na]
        at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_101]
INFO  [RepairJobTask:1] 2017-10-05 14:32:07,045 CoordinatorSession.java:233 - Incremental repair session 7e1a9150-a98e-11e7-ad86-cbd2801b8de2 failed
ERROR [Stream-Deserializer-/127.0.0.2:7000-4b83e3cb] 2017-10-05 14:32:07,045 StreamSession.java:757 - [Stream #85d4b790-a98e-11e7-ad86-cbd2801b8de2] Remote peer 127.0.0.2 failed stream session.
INFO  [AntiEntropyStage:1] 2017-10-05 14:32:07,048 CoordinatorSession.java:233 - Incremental repair session 7e1a9150-a98e-11e7-ad86-cbd2801b8de2 failed
INFO  [AntiEntropyStage:1] 2017-10-05 14:32:07,049 LocalSessions.java:501 - Failing local repair session 7e1a9150-a98e-11e7-ad86-cbd2801b8de2
INFO  [RepairJobTask:1] 2017-10-05 14:32:07,049 RepairRunnable.java:647 - Repair command #4 finished in 14 seconds
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;node2&apos;s &lt;tt&gt;system.log&lt;/tt&gt; (note the transport shutdowns at the end):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [AntiEntropyStage:1] 2017-10-05 18:31:52,521 LocalSessions.java:560 - Beginning local incremental repair session LocalSession{sessionID=7e1a9150-a98e-11e7-ad86-cbd2801b8de2, state=PREPARING, coordinator=/127.0.0.1, tableIds=[99d53860-a98d-11e7-9807-39cb3e573e5c], repairedAt=1507181512483, ranges=[(3074457345618258602,-9223372036854775808], (-9223372036854775808,-3074457345618258603], (-3074457345618258603,3074457345618258602]], participants=[/127.0.0.1, /127.0.0.2, /127.0.0.3], startedAt=1507181512, lastUpdate=1507181512}
INFO  [CompactionExecutor:224] 2017-10-05 18:31:52,539 CompactionManager.java:642 - [repair #7e1a9150-a98e-11e7-ad86-cbd2801b8de2] Starting anticompaction for standard_long.test_data on 2/2 sstables
INFO  [CompactionExecutor:224] 2017-10-05 18:31:52,539 CompactionManager.java:664 - [repair #7e1a9150-a98e-11e7-ad86-cbd2801b8de2] SSTable BigTableReader(path=&apos;/Users/zznate/.ccm/4_0_test/node2/data0/standard_long/test_data-99d53860a98d11e7980739cb3e573e5c/na-27-big-Data.db&apos;) fully contained in range (-9223372036854775808,-9223372036854775808], mutating repairedAt instead of anticompacting
INFO  [CompactionExecutor:224] 2017-10-05 18:31:52,539 CompactionManager.java:664 - [repair #7e1a9150-a98e-11e7-ad86-cbd2801b8de2] SSTable BigTableReader(path=&apos;/Users/zznate/.ccm/4_0_test/node2/data0/standard_long/test_data-99d53860a98d11e7980739cb3e573e5c/na-26-big-Data.db&apos;) fully contained in range (-9223372036854775808,-9223372036854775808], mutating repairedAt instead of anticompacting
INFO  [CompactionExecutor:224] 2017-10-05 18:31:52,547 CompactionManager.java:699 - [repair #7e1a9150-a98e-11e7-ad86-cbd2801b8de2] Completed anticompaction successfully
INFO  [AntiEntropyStage:1] 2017-10-05 18:31:57,500 Validator.java:292 - [repair #7e2e8e80-a98e-11e7-ad86-cbd2801b8de2] Sending completed merkle tree to /127.0.0.1 for standard_long.test_data
INFO  [Stream-Deserializer-/127.0.0.1:63064-3a39d969] 2017-10-05 18:32:05,417 StreamResultFuture.java:115 - [Stream #85d4b790-a98e-11e7-ad86-cbd2801b8de2 ID#0] Creating new streaming plan for Repair
INFO  [Stream-Deserializer-/127.0.0.1:63064-3a39d969] 2017-10-05 18:32:05,418 StreamResultFuture.java:122 - [Stream #85d4b790-a98e-11e7-ad86-cbd2801b8de2, ID#0] Received streaming plan for Repair
INFO  [NonPeriodicTasks:1] 2017-10-05 18:32:05,856 StreamResultFuture.java:179 - [Stream #85d4b790-a98e-11e7-ad86-cbd2801b8de2 ID#0] Prepare completed. Receiving 1 files(8.136MiB), sending 2 files(42.689MiB)
INFO  [Stream-Deserializer-/127.0.0.1:63064-3a39d969] 2017-10-05 18:32:06,625 StreamResultFuture.java:179 - [Stream #85d4b790-a98e-11e7-ad86-cbd2801b8de2 ID#0] Prepare completed. Receiving 1 files(8.136MiB), sending 2 files(42.689MiB)
WARN  [Stream-Deserializer-/127.0.0.1:63066-c7002e89] 2017-10-05 18:32:06,747 CompressedStreamReader.java:112 - [Stream 85d4b790-a98e-11e7-ad86-cbd2801b8de2] Error while reading partition DecoratedKey(-9060243433852736644, 5f1c6c5d747c) from stream on ks=&apos;standard_long&apos; and table=&apos;test_data&apos;.
ERROR [Stream-Deserializer-/127.0.0.1:63066-c7002e89] 2017-10-05 18:32:06,759 StreamSession.java:617 - [Stream #85d4b790-a98e-11e7-ad86-cbd2801b8de2] Streaming error occurred on session with peer 127.0.0.1
org.apache.cassandra.streaming.StreamReceiveException: java.lang.AssertionError: stream can only read forward.
        at org.apache.cassandra.streaming.messages.IncomingFileMessage$1.deserialize(IncomingFileMessage.java:63) ~[main/:na]
        at org.apache.cassandra.streaming.messages.IncomingFileMessage$1.deserialize(IncomingFileMessage.java:41) ~[main/:na]
        at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:55) ~[main/:na]
        at org.apache.cassandra.streaming.async.StreamingInboundHandler$StreamDeserializingTask.run(StreamingInboundHandler.java:178) ~[main/:na]
        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_101]
Caused by: java.lang.AssertionError: stream can only read forward.
        at org.apache.cassandra.streaming.compress.CompressedInputStream.position(CompressedInputStream.java:108) ~[main/:na]
        at org.apache.cassandra.streaming.compress.CompressedStreamReader.read(CompressedStreamReader.java:96) ~[main/:na]
        at org.apache.cassandra.streaming.messages.IncomingFileMessage$1.deserialize(IncomingFileMessage.java:58) ~[main/:na]
        ... 4 common frames omitted
INFO  [Stream-Deserializer-/127.0.0.1:63066-c7002e89] 2017-10-05 18:32:06,761 StreamResultFuture.java:193 - [Stream #85d4b790-a98e-11e7-ad86-cbd2801b8de2] Session with /127.0.0.1 is complete
WARN  [Stream-Deserializer-/127.0.0.1:63066-c7002e89] 2017-10-05 18:32:06,762 StreamResultFuture.java:220 - [Stream #85d4b790-a98e-11e7-ad86-cbd2801b8de2] Stream failed
ERROR [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:06,765 CassandraDaemon.java:211 - Exception in thread Thread[NettyStreaming-Outbound-/127.0.0.1:1,5,main]
org.apache.cassandra.io.FSReadError: java.nio.channels.ClosedByInterruptException
        at org.apache.cassandra.io.util.ChannelProxy.read(ChannelProxy.java:133) ~[main/:na]
        at org.apache.cassandra.streaming.compress.CompressedStreamWriter.write(CompressedStreamWriter.java:94) ~[main/:na]
        at org.apache.cassandra.streaming.messages.OutgoingFileMessage.serialize(OutgoingFileMessage.java:111) ~[main/:na]
        at org.apache.cassandra.streaming.messages.OutgoingFileMessage$1.serialize(OutgoingFileMessage.java:53) ~[main/:na]
        at org.apache.cassandra.streaming.messages.OutgoingFileMessage$1.serialize(OutgoingFileMessage.java:42) ~[main/:na]
        at org.apache.cassandra.streaming.messages.StreamMessage.serialize(StreamMessage.java:41) ~[main/:na]
        at org.apache.cassandra.streaming.async.NettyStreamingMessageSender$FileStreamTask.run(NettyStreamingMessageSender.java:324) ~[main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_101]
        at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_101]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_101]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_101]
        at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:81) [main/:na]
        at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_101]
Caused by: java.nio.channels.ClosedByInterruptException: null
        at java.nio.channels.spi.AbstractInterruptibleChannel.end(AbstractInterruptibleChannel.java:202) ~[na:1.8.0_101]
        at sun.nio.ch.FileChannelImpl.readInternal(FileChannelImpl.java:746) ~[na:1.8.0_101]
        at sun.nio.ch.FileChannelImpl.read(FileChannelImpl.java:727) ~[na:1.8.0_101]
        at org.apache.cassandra.io.util.ChannelProxy.read(ChannelProxy.java:129) ~[main/:na]
        ... 12 common frames omitted
ERROR [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:06,769 StorageService.java:393 - Stopping gossiper
WARN  [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:06,769 StorageService.java:315 - Stopping gossip by operator request
INFO  [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:06,769 Gossiper.java:1527 - Announcing shutdown
INFO  [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:06,770 StorageService.java:2202 - Node /127.0.0.2 state jump to shutdown
INFO  [AntiEntropyStage:1] 2017-10-05 18:32:07,049 LocalSessions.java:501 - Failing local repair session 7e1a9150-a98e-11e7-ad86-cbd2801b8de2
ERROR [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:08,771 StorageService.java:398 - Stopping native transport
INFO  [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:08,774 Server.java:180 - Stop listening for CQL clients
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;And node3 &lt;tt&gt;system.log&lt;/tt&gt; (similar to node2):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO  [AntiEntropyStage:1] 2017-10-05 18:31:52,521 LocalSessions.java:560 - Beginning local incremental repair session LocalSession{sessionID=7e1a9150-a98e-11e7-ad86-cbd2801b8de2, state=PREPARING, coordinator=/127.0.0.1, tableIds=[99d53860-a98d-11e7-9807-39cb3e573e5c], repairedAt=1507181512483, ranges=[(3074457345618258602,-9223372036854775808], (-9223372036854775808,-3074457345618258603], (-3074457345618258603,3074457345618258602]], participants=[/127.0.0.1, /127.0.0.2, /127.0.0.3], startedAt=1507181512, lastUpdate=1507181512}
INFO  [CompactionExecutor:249] 2017-10-05 18:31:52,542 CompactionManager.java:642 - [repair #7e1a9150-a98e-11e7-ad86-cbd2801b8de2] Starting anticompaction for standard_long.test_data on 2/2 sstables
INFO  [CompactionExecutor:249] 2017-10-05 18:31:52,543 CompactionManager.java:664 - [repair #7e1a9150-a98e-11e7-ad86-cbd2801b8de2] SSTable BigTableReader(path=&apos;/Users/zznate/.ccm/4_0_test/node3/data0/standard_long/test_data-99d53860a98d11e7980739cb3e573e5c/na-27-big-Data.db&apos;) fully contained in range (-9223372036854775808,-9223372036854775808], mutating repairedAt instead of anticompacting
INFO  [CompactionExecutor:249] 2017-10-05 18:31:52,543 CompactionManager.java:664 - [repair #7e1a9150-a98e-11e7-ad86-cbd2801b8de2] SSTable BigTableReader(path=&apos;/Users/zznate/.ccm/4_0_test/node3/data0/standard_long/test_data-99d53860a98d11e7980739cb3e573e5c/na-26-big-Data.db&apos;) fully contained in range (-9223372036854775808,-9223372036854775808], mutating repairedAt instead of anticompacting
INFO  [CompactionExecutor:249] 2017-10-05 18:31:52,550 CompactionManager.java:699 - [repair #7e1a9150-a98e-11e7-ad86-cbd2801b8de2] Completed anticompaction successfully
INFO  [AntiEntropyStage:1] 2017-10-05 18:31:57,918 Validator.java:292 - [repair #7e2e8e80-a98e-11e7-ad86-cbd2801b8de2] Sending completed merkle tree to /127.0.0.1 for standard_long.test_data
INFO  [Stream-Deserializer-/127.0.0.1:63063-d6987513] 2017-10-05 18:32:05,817 StreamResultFuture.java:115 - [Stream #85d3f440-a98e-11e7-ad86-cbd2801b8de2 ID#0] Creating new streaming plan for Repair
INFO  [Stream-Deserializer-/127.0.0.1:63063-d6987513] 2017-10-05 18:32:05,818 StreamResultFuture.java:122 - [Stream #85d3f440-a98e-11e7-ad86-cbd2801b8de2, ID#0] Received streaming plan for Repair
INFO  [NonPeriodicTasks:1] 2017-10-05 18:32:05,866 StreamResultFuture.java:179 - [Stream #85d3f440-a98e-11e7-ad86-cbd2801b8de2 ID#0] Prepare completed. Receiving 1 files(8.136MiB), sending 2 files(42.679MiB)
INFO  [Stream-Deserializer-/127.0.0.1:63063-d6987513] 2017-10-05 18:32:06,622 StreamResultFuture.java:179 - [Stream #85d3f440-a98e-11e7-ad86-cbd2801b8de2 ID#0] Prepare completed. Receiving 1 files(8.136MiB), sending 2 files(42.679MiB)
WARN  [Stream-Deserializer-/127.0.0.1:63067-6347c9a8] 2017-10-05 18:32:06,759 CompressedStreamReader.java:112 - [Stream 85d3f440-a98e-11e7-ad86-cbd2801b8de2] Error while reading partition DecoratedKey(-9060243433852736644, 5f1c6c5d747c) from stream on ks=&apos;standard_long&apos; and table=&apos;test_data&apos;.
ERROR [Stream-Deserializer-/127.0.0.1:63067-6347c9a8] 2017-10-05 18:32:06,773 StreamSession.java:617 - [Stream #85d3f440-a98e-11e7-ad86-cbd2801b8de2] Streaming error occurred on session with peer 127.0.0.1
org.apache.cassandra.streaming.StreamReceiveException: java.lang.AssertionError: stream can only read forward.
        at org.apache.cassandra.streaming.messages.IncomingFileMessage$1.deserialize(IncomingFileMessage.java:63) ~[main/:na]
        at org.apache.cassandra.streaming.messages.IncomingFileMessage$1.deserialize(IncomingFileMessage.java:41) ~[main/:na]
        at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:55) ~[main/:na]
        at org.apache.cassandra.streaming.async.StreamingInboundHandler$StreamDeserializingTask.run(StreamingInboundHandler.java:178) ~[main/:na]
        at java.lang.Thread.run(Thread.java:745) [na:1.8.0_101]
Caused by: java.lang.AssertionError: stream can only read forward.
        at org.apache.cassandra.streaming.compress.CompressedInputStream.position(CompressedInputStream.java:108) ~[main/:na]
        at org.apache.cassandra.streaming.compress.CompressedStreamReader.read(CompressedStreamReader.java:96) ~[main/:na]
        at org.apache.cassandra.streaming.messages.IncomingFileMessage$1.deserialize(IncomingFileMessage.java:58) ~[main/:na]
        ... 4 common frames omitted
INFO  [GossipStage:1] 2017-10-05 18:32:06,774 Gossiper.java:1040 - InetAddress /127.0.0.2 is now DOWN
INFO  [Stream-Deserializer-/127.0.0.1:63067-6347c9a8] 2017-10-05 18:32:06,775 StreamResultFuture.java:193 - [Stream #85d3f440-a98e-11e7-ad86-cbd2801b8de2] Session with /127.0.0.1 is complete
WARN  [Stream-Deserializer-/127.0.0.1:63067-6347c9a8] 2017-10-05 18:32:06,775 StreamResultFuture.java:220 - [Stream #85d3f440-a98e-11e7-ad86-cbd2801b8de2] Stream failed
ERROR [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:06,778 CassandraDaemon.java:211 - Exception in thread Thread[NettyStreaming-Outbound-/127.0.0.1:1,5,main]
org.apache.cassandra.io.FSReadError: java.nio.channels.ClosedByInterruptException
        at org.apache.cassandra.io.util.ChannelProxy.read(ChannelProxy.java:133) ~[main/:na]
        at org.apache.cassandra.streaming.compress.CompressedStreamWriter.write(CompressedStreamWriter.java:94) ~[main/:na]
        at org.apache.cassandra.streaming.messages.OutgoingFileMessage.serialize(OutgoingFileMessage.java:111) ~[main/:na]
        at org.apache.cassandra.streaming.messages.OutgoingFileMessage$1.serialize(OutgoingFileMessage.java:53) ~[main/:na]
        at org.apache.cassandra.streaming.messages.OutgoingFileMessage$1.serialize(OutgoingFileMessage.java:42) ~[main/:na]
        at org.apache.cassandra.streaming.messages.StreamMessage.serialize(StreamMessage.java:41) ~[main/:na]
        at org.apache.cassandra.streaming.async.NettyStreamingMessageSender$FileStreamTask.run(NettyStreamingMessageSender.java:324) ~[main/:na]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511) ~[na:1.8.0_101]
        at java.util.concurrent.FutureTask.run(FutureTask.java:266) ~[na:1.8.0_101]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_101]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_101]
        at org.apache.cassandra.concurrent.NamedThreadFactory.lambda$threadLocalDeallocator$0(NamedThreadFactory.java:81) [main/:na]
        at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_101]
Caused by: java.nio.channels.ClosedByInterruptException: null
        at java.nio.channels.spi.AbstractInterruptibleChannel.end(AbstractInterruptibleChannel.java:202) ~[na:1.8.0_101]
        at sun.nio.ch.FileChannelImpl.readInternal(FileChannelImpl.java:746) ~[na:1.8.0_101]
        at sun.nio.ch.FileChannelImpl.read(FileChannelImpl.java:727) ~[na:1.8.0_101]
        at org.apache.cassandra.io.util.ChannelProxy.read(ChannelProxy.java:129) ~[main/:na]
        ... 12 common frames omitted
ERROR [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:06,781 StorageService.java:393 - Stopping gossiper
WARN  [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:06,781 StorageService.java:315 - Stopping gossip by operator request
INFO  [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:06,781 Gossiper.java:1527 - Announcing shutdown
INFO  [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:06,782 StorageService.java:2202 - Node /127.0.0.3 state jump to shutdown
INFO  [AntiEntropyStage:1] 2017-10-05 18:32:07,049 LocalSessions.java:501 - Failing local repair session 7e1a9150-a98e-11e7-ad86-cbd2801b8de2
ERROR [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:08,782 StorageService.java:398 - Stopping native transport
INFO  [NettyStreaming-Outbound-/127.0.0.1:1] 2017-10-05 18:32:08,785 Server.java:180 - Stop listening for CQL clients
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The final state of the cluster after running this repair command:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;$ ccm node1 nodetool status

Datacenter: datacenter1
=======================
Status=Up/Down
|/ State=Normal/Leaving/Joining/Moving
--  Address    Load       Tokens       Owns (effective)  Host ID                               Rack
UN  127.0.0.1  8.62 MiB   1            100.0%            ffe7466b-2937-4322-a388-cca1819f6513  rack1
DN  127.0.0.2  44.54 MiB  1            100.0%            e374f662-1da5-477d-b1fb-173b8311c4a9  rack1
DN  127.0.0.3  44.53 MiB  1            100.0%            d8d99bd6-4b9f-4510-a4c3-62951be1b4d2  rack1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13107143">CASSANDRA-13938</key>
            <summary>Default repair is broken, crashes other nodes participating in repair (in trunk)</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="zznate">Nate McCall</reporter>
                        <labels>
                    </labels>
                <created>Thu, 5 Oct 2017 06:06:43 +0000</created>
                <updated>Mon, 21 Dec 2020 08:08:12 +0000</updated>
                            <resolved>Thu, 16 Jan 2020 18:34:42 +0000</resolved>
                                        <fixVersion>4.0-alpha3</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Consistency/Repair</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>21</watches>
                                                                                                                <comments>
                            <comment id="16193127" author="jasobrown" created="Thu, 5 Oct 2017 16:24:09 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zznate&quot; class=&quot;user-hover&quot; rel=&quot;zznate&quot;&gt;zznate&lt;/a&gt; thanks for detailed steps to create the error. I am able to reproduce, and am digging in now.&lt;/p&gt;</comment>
                            <comment id="16338082" author="aweisberg" created="Wed, 24 Jan 2018 19:10:57 +0000"  >&lt;p&gt;This reproduced in CircleCI. &lt;a href=&quot;https://circleci.com/gh/aweisberg/cassandra/781#tests/containers/70&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://circleci.com/gh/aweisberg/cassandra/781#tests/containers/70&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Calling position is fine as long as it never goes backwards. It&apos;s going backwards because the list of file locations to read is overlapping or out of order (not clear). I traced this back and things seem to be correct and order preserving up until potentially &lt;a href=&quot;https://github.com/aweisberg/cassandra/blob/da3e0e091bc2e1819b8839784cc8156533f3cb88/src/java/org/apache/cassandra/streaming/StreamSession.java#L325&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/aweisberg/cassandra/blob/da3e0e091bc2e1819b8839784cc8156533f3cb88/src/java/org/apache/cassandra/streaming/StreamSession.java#L325&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;At that point &lt;tt&gt;Ranges.normalize()&lt;/tt&gt; is called and that should fix this issue because it should merge overlapping ranges and sort them. It&apos;s possible the bug is in that method. One easy way to check this might be log the ranges, run it in CircleCI until it reproduces, take the logged ranges and run them through &lt;tt&gt;Ranges.normalize()&lt;/tt&gt; and see what happens.&lt;/p&gt;

&lt;p&gt;I think I&apos;ll do that before getting to the issue of this error breaking messaging.&lt;/p&gt;</comment>
                            <comment id="16339235" author="jasobrown" created="Thu, 25 Jan 2018 13:51:15 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; thanks for looking at this, I haven&apos;t had a chance to yet. I do, however, have a script to repro based on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zznate&quot; class=&quot;user-hover&quot; rel=&quot;zznate&quot;&gt;zznate&lt;/a&gt;&apos;s description and will attach.&lt;/p&gt;</comment>
                            <comment id="16339535" author="aweisberg" created="Thu, 25 Jan 2018 17:34:46 +0000"  >&lt;p&gt;That&apos;s not it. It&apos;s deserializing a row and blowing past where it expects to go and then trying to rewind deserialization for the next range.&lt;/p&gt;</comment>
                            <comment id="16499721" author="lerh low" created="Mon, 4 Jun 2018 04:07:22 +0000"  >&lt;p&gt;Here&apos;s another stacktrace that may help - I&apos;ve also been getting these while testing trunk in EC2. The steps I use are the same:&#160;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;Disable hintedhandoff&lt;/li&gt;
	&lt;li&gt;Take out 1 node&lt;/li&gt;
	&lt;li&gt;Run stress for 10 mins, then run repair&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;It will error out and the nodes also end up in a bizarre situation with gossip that I will have to stop the entire cluster and then start them up one at a time (in a rolling restart they still won&apos;t be able to sort themselves out). Sometimes it errors with &lt;tt&gt;stream can only read forward&lt;/tt&gt;&#160;(as above and in the JIRA), but here&apos;s another stacktrace that has also showed up several times in&#160;some of the failed nodes:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: ERROR [Stream-Deserializer-35.155.140.194:39371-28daf76d] 2018-05-31 02:07:24,445 StreamingInboundHandler.java:210 - [Stream channel: 28daf76d] stream operation from 35.155.140.194:39371 failed
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: java.lang.ArrayIndexOutOfBoundsException: Array index out of range: 1711542017
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at net.jpountz.util.ByteBufferUtils.checkRange(ByteBufferUtils.java:20)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at net.jpountz.util.ByteBufferUtils.checkRange(ByteBufferUtils.java:14)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at net.jpountz.lz4.LZ4JNIFastDecompressor.decompress(LZ4JNIFastDecompressor.java:48)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.io.compress.LZ4Compressor.uncompress(LZ4Compressor.java:162)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.db.streaming.CompressedInputStream.decompress(CompressedInputStream.java:163)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.db.streaming.CompressedInputStream.reBuffer(CompressedInputStream.java:144)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.db.streaming.CompressedInputStream.reBuffer(CompressedInputStream.java:119)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.io.util.RebufferingInputStream.readByte(RebufferingInputStream.java:144)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.io.util.RebufferingInputStream.readPrimitiveSlowly(RebufferingInputStream.java:108)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.io.util.RebufferingInputStream.readShort(RebufferingInputStream.java:164)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.io.util.RebufferingInputStream.readUnsignedShort(RebufferingInputStream.java:170)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.io.util.TrackedDataInputPlus.readUnsignedShort(TrackedDataInputPlus.java:139)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.utils.ByteBufferUtil.readShortLength(ByteBufferUtil.java:367)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.utils.ByteBufferUtil.readWithShortLength(ByteBufferUtil.java:377)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.db.streaming.CassandraStreamReader$StreamDeserializer.newPartition(CassandraStreamReader.java:199)
May 31 02:07:24 ip-10-0-18-230 cassandra[6034]: at org.apache.cassandra.db.streaming.CassandraStreamReader.writePartition(CassandraStreamReader.java:172)&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I get the feeling they may be related but I&apos;m not sure...I can open a different Jira for this if you like, but otherwise hope it may point out more clues as to what is going on :/&#160;&lt;/p&gt;</comment>
                            <comment id="16507383" author="jasobrown" created="Sun, 10 Jun 2018 13:00:05 +0000"  >&lt;p&gt;I think I&apos;ve figured out why the &lt;tt&gt;stream can only read forward&lt;/tt&gt; assert fails. I think it&apos;s mishandling of &lt;tt&gt;CompressedInputStream#current&lt;/tt&gt; &lt;a href=&quot;https://github.com/apache/cassandra/blob/trunk/src/java/org/apache/cassandra/db/streaming/CompressedInputStream.java#L133&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. All the other read lengths seem fine so I think it&apos;s just a miscalculation of &lt;tt&gt;current&lt;/tt&gt;. Fortunately, &lt;tt&gt;current&lt;/tt&gt; doesn&apos;t have too much value, expect when figuring out the base offset when &lt;tt&gt;reBuffer&lt;/tt&gt; is called from the parent class. If you naively comment out the assert that fails, the stream can be deserialized successfully, and data can be read. Thus, I think it&apos;s something simple and I should have a fix shortly.&lt;/p&gt;

&lt;p&gt;wrt &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lerh+Low&quot; class=&quot;user-hover&quot; rel=&quot;Lerh Low&quot;&gt;Lerh Low&lt;/a&gt;&apos;s report, that&apos;s a bit different. I don&apos;t know how a failure in streaming could cause &quot;a bizarre situation with gossip&quot;, which really isn&apos;t explained. Either way, there&apos;s an &lt;tt&gt;ArrayIndexOutOfBoundsException&lt;/tt&gt; problem somewhere. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Lerh+Low&quot; class=&quot;user-hover&quot; rel=&quot;Lerh Low&quot;&gt;Lerh Low&lt;/a&gt;: can you open a separate ticket, and include as many steps to repro as possible, including schema? &lt;/p&gt;</comment>
                            <comment id="16508237" author="jasobrown" created="Mon, 11 Jun 2018 15:42:32 +0000"  >&lt;p&gt;The problem is that when &lt;tt&gt;CompressedInputStream#position()&lt;/tt&gt; is called, the new position might be in the middle of a buffer. We need to remember that offset, and subtract that value when updating &lt;tt&gt;current&lt;/tt&gt; in &lt;tt&gt;#reBuffer(boolean)&lt;/tt&gt;. The resaon why is that those offset bytes get double counted on the first call to &lt;tt&gt;#reBuffer()&lt;/tt&gt; after &lt;tt&gt;#position()&lt;/tt&gt; as we add the &lt;tt&gt;buffer.position()&lt;/tt&gt; to &lt;tt&gt;current&lt;/tt&gt;. &lt;tt&gt;current&lt;/tt&gt; already accounts for those offset bytes when &lt;tt&gt;#position()&lt;/tt&gt; was called.&lt;/p&gt;

&lt;p&gt;Patch below fixes the problem:&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;13938&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/13938&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jasobrown/workflows/cassandra/tree/13938&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests &amp;amp; dtests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;Also, since I was in this code, I&apos;ve cleaned it up a bit:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;renamed &lt;tt&gt;currentOffset&lt;/tt&gt; to &lt;tt&gt;streamOffset&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;reorganized static and member fields at top of class, and added more comments.&lt;/li&gt;
	&lt;li&gt;capture a reference to the background thread that will execute &lt;tt&gt;CompressedInputStream#Reader&lt;/tt&gt;, so we can close it properly.&lt;/li&gt;
	&lt;li&gt;made &lt;tt&gt;close()&lt;/tt&gt; more responsible for shutting down/cleaning up resources&lt;/li&gt;
	&lt;li&gt;cleaned up &lt;tt&gt;decompress()&lt;/tt&gt; by moving the CRC validation into a sub-method (got rid of a needless local boolean)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;I also have a dtest based on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zznate&quot; class=&quot;user-hover&quot; rel=&quot;zznate&quot;&gt;zznate&lt;/a&gt;&apos;s repro steps and schema (slightly modified as we no longer support COMPACT_STORAGE), and it produced the error every time (before the patch). I also tried &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt; &apos;s dtest from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14394&quot; title=&quot;Streaming fails with AssertionError&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14394&quot;&gt;&lt;del&gt;CASSANDRA-14394&lt;/del&gt;&lt;/a&gt;, but it did not repro for me. I&apos;m happy with either dtest (or both), but would definitely like to include one of them.&lt;/p&gt;
&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;13938-dtest&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra-dtest/tree/13938&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;jasobrown dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/pauloricardomg/cassandra-dtest/tree/CASSANDRA-14394&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;paulo dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;
</comment>
                            <comment id="16542961" author="dimitarndimitrov" created="Fri, 13 Jul 2018 12:11:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;The problem is that when &lt;tt&gt;CompressedInputStream#position()&lt;/tt&gt; is called, the new position might be in the middle of a buffer. We need to remember that offset, and subtract that value when updating &lt;tt&gt;current&lt;/tt&gt; in &lt;tt&gt;#reBuffer(boolean)&lt;/tt&gt;. The resaon why is that those offset bytes get double counted on the first call to &lt;tt&gt;#reBuffer()&lt;/tt&gt; after &lt;tt&gt;#position()&lt;/tt&gt; as we add the &lt;tt&gt;buffer.position()&lt;/tt&gt; to &lt;tt&gt;current&lt;/tt&gt;. &lt;tt&gt;current&lt;/tt&gt; already accounts for those offset bytes when &lt;tt&gt;#position()&lt;/tt&gt; was called.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt;, isn&apos;t that&#160;equivalent (although a bit more complex)&#160;to just setting&#160;&lt;tt&gt;current&lt;/tt&gt; to the last reached/read position in the stream when rebuffering?&#160;(i.e.&#160;&lt;tt&gt;current = streamOffset + buffer.position()&lt;/tt&gt;).&lt;/p&gt;

&lt;p&gt;I might be missing something, but the role of&#160;&lt;tt&gt;currentBufferOffset&lt;/tt&gt;&#160;seems to be solely to &quot;align&quot; &lt;tt&gt;current&lt;/tt&gt; and &lt;tt&gt;streamOffset&lt;/tt&gt; the first time after a new section is started. Then&#160;&lt;tt&gt;current += buffer.position() - currentBufferOffset&lt;/tt&gt;&#160;expands to &lt;tt&gt;current = &lt;del&gt;current&lt;/del&gt; + buffer.position() + streamOffset - &lt;del&gt;current&lt;/del&gt;&#160;&lt;/tt&gt; which is the same as&#160;&lt;tt&gt;current = streamOffset + buffer.position()&lt;/tt&gt;. After that first time, &lt;tt&gt;current&lt;/tt&gt; naturally follows&#160;&lt;tt&gt;streamOffset&lt;/tt&gt;&#160;without the need of any adjustment, but it seems more natural to express this as &lt;tt&gt;streamOffset + buffer.position()&lt;/tt&gt; instead of the new expression or the old &lt;tt&gt;current + buffer.position()&lt;/tt&gt;.&#160;To me, it&apos;s also a bit more intuitive and easier to understand (hopefully it&apos;s also right in addition to intuitive &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;).&lt;/p&gt;

&lt;p&gt;The equivalence above would hold true if &lt;tt&gt;current&lt;/tt&gt; and &lt;tt&gt;streamOffset&lt;/tt&gt;&#160;don&apos;t change their value in the meantime, but I think this is ensured by the well-ordered sequential fashion in which the decompressing and the offset bookkeeping functionality of &lt;tt&gt;CompressedInputStream&lt;/tt&gt;&#160;happen in the&#160;thread running the corresponding &lt;tt&gt;StreamDeserializingTask&lt;/tt&gt;.&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;The aforementioned well-ordered sequential fashion seems to be POSITION followed by 0-N times REBUFFER + DECOMPRESS, where the first REBUFFER might not update &lt;tt&gt;current&lt;/tt&gt;&#160;with the above calculation in case &lt;tt&gt;current&lt;/tt&gt; is already too far ahead (i.e. the new section is not starting within the current buffer).&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="16610105" author="jasobrown" created="Tue, 11 Sep 2018 05:01:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dimitarndimitrov&quot; class=&quot;user-hover&quot; rel=&quot;dimitarndimitrov&quot;&gt;dimitarndimitrov&lt;/a&gt;, Thanks for your comments, and apologies for the late response.&lt;/p&gt;

&lt;p&gt;While your proposed simplification indeed clarifies the logic, unfortunately it doesn&apos;t resolve the bug (my dtest still fails - this is due to the need to reset a &apos;some&apos; value, like the currentBufferOffset, after rebufferring). However, your observation about simplifying this patch (in particular eliminate &lt;tt&gt;currentBufferOffset&lt;/tt&gt; made me reconsider the needs of this class. Basically, we just need to correctly track the streamOffset for the current buffer, and that&apos;s all. When I ported this clas from 3.11, I over-complicated the offsets and counters into the first version of this class (committed with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12229&quot; title=&quot;Move streaming to non-blocking IO and netty (streaming 2.1)&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12229&quot;&gt;&lt;del&gt;CASSANDRA-12229&lt;/del&gt;&lt;/a&gt;), and then confused it again (while resolving the error) with the first patch.&lt;/p&gt;

&lt;p&gt;In short: as long as I correctly calculate streamOffset, that should satisfy the needs for the class. Thus, I eliminated both &lt;tt&gt;current&lt;/tt&gt; and &lt;tt&gt;currentBufferOffset&lt;/tt&gt;, and the result is clearer and correct.&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed a cleaned up branch (which has been rebased to trunk). Please note that, as with the first patch, the majority of this patch is refactoring to clean up the class in general. I&apos;ve also updated my dtest patch as my version required a stress profile (based on &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=zznate&quot; class=&quot;user-hover&quot; rel=&quot;zznate&quot;&gt;zznate&lt;/a&gt;&apos;s original) to be committed, as well. (Note: my dtest branch also includes &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=pauloricardomg&quot; class=&quot;user-hover&quot; rel=&quot;pauloricardomg&quot;&gt;pauloricardomg&lt;/a&gt;&apos;s patch, but, as before, I&apos;m unable to get that to fail on trunk.)&lt;/p&gt;</comment>
                            <comment id="16658981" author="alourie" created="Mon, 22 Oct 2018 13:29:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasobrown&quot; class=&quot;user-hover&quot; rel=&quot;jasobrown&quot;&gt;jasobrown&lt;/a&gt; I&apos;ve been testing both trunk and your branch in a simple repair scenario and it&apos;s still failing. The scenario I&apos;m working with is:&lt;/p&gt;

&lt;p&gt;1. Start a cluster&lt;br/&gt;
2. Load the cluster for 10 minutes&lt;br/&gt;
3. Stop one node and load it for an additional 30 minutes&lt;br/&gt;
4. Clear the hints&lt;br/&gt;
5. Start the stopped node and let it resync with others for a couple of minutes.&lt;br/&gt;
6. Start the repairs on the previously stopped node.&lt;/p&gt;

&lt;p&gt;Repairs crash on the other nodes (on 2 nodes in my 3-node test cluster) with the following error:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Oct 22 13:10:54 ip-10-0-13-111 cassandra[5927]: INFO  [AntiEntropyStage:1] 2018-10-22 13:10:54,716 Validator.java:417 - [repair #9c38dd00-d5fb-11e8-ac32-316a9d8f8d32] Sending completed merkle tree to 35.162.15.68:7000 &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; alex.test2
Oct 22 13:16:02 ip-10-0-13-111 cassandra[5927]: INFO  [AntiEntropyStage:1] 2018-10-22 13:16:02,594 StreamingRepairTask.java:72 - [streaming task #9c38dd00-d5fb-11e8-ac32-316a9d8f8d32] Performing streaming repair of 7382 ranges with 35.162.15.68:7000
Oct 22 13:16:02 ip-10-0-13-111 cassandra[5927]: INFO  [AntiEntropyStage:1] 2018-10-22 13:16:02,981 StreamResultFuture.java:89 - [Stream #9fe63820-d5fc-11e8-8a2b-3555ba61a619] Executing streaming plan &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; Repair
Oct 22 13:16:02 ip-10-0-13-111 cassandra[5927]: INFO  [AntiEntropyStage:1] 2018-10-22 13:16:02,981 StreamSession.java:287 - [Stream #9fe63820-d5fc-11e8-8a2b-3555ba61a619] Starting streaming to 35.162.15.68:7000
Oct 22 13:16:02 ip-10-0-13-111 cassandra[5927]: INFO  [AntiEntropyStage:1] 2018-10-22 13:16:02,987 StreamCoordinator.java:259 - [Stream #9fe63820-d5fc-11e8-8a2b-3555ba61a619, ID#0] Beginning stream session with 35.162.15.68:7000
Oct 22 13:16:03 ip-10-0-13-111 cassandra[5927]: INFO  [Stream-Deserializer-35.162.15.68:7000-0b32ed63] 2018-10-22 13:16:03,783 StreamResultFuture.java:178 - [Stream #9fe63820-d5fc-11e8-8a2b-3555ba61a619 ID#0] Prepare completed. Receiving 6 files(215.878MiB), sending 17 files(720.317MiB)
Oct 22 13:16:04 ip-10-0-13-111 cassandra[5927]: WARN  [Stream-Deserializer-35.162.15.68:60292-be7cb6ee] 2018-10-22 13:16:04,355 CassandraCompressedStreamReader.java:110 - [Stream 9fe63820-d5fc-11e8-8a2b-3555ba61a619] Error &lt;span class=&quot;code-keyword&quot;&gt;while&lt;/span&gt; reading partition DecoratedKey(-9088115514873584734, 646572706865616435393632373436) from stream on ks=&lt;span class=&quot;code-quote&quot;&gt;&apos;alex&apos;&lt;/span&gt; and table=&lt;span class=&quot;code-quote&quot;&gt;&apos;test2&apos;&lt;/span&gt;.
Oct 22 13:16:04 ip-10-0-13-111 cassandra[5927]: ERROR [Stream-Deserializer-35.162.15.68:60292-be7cb6ee] 2018-10-22 13:16:04,362 StreamingInboundHandler.java:213 - [Stream channel: be7cb6ee] stream operation from 35.162.15.68:60292 failed
Oct 22 13:16:04 ip-10-0-13-111 cassandra[5927]: java.lang.AssertionError: stream can only read forward.
Oct 22 13:16:04 ip-10-0-13-111 cassandra[5927]:         at org.apache.cassandra.db.streaming.CompressedInputStream.position(CompressedInputStream.java:108)
Oct 22 13:16:04 ip-10-0-13-111 cassandra[5927]:         at org.apache.cassandra.db.streaming.CassandraCompressedStreamReader.read(CassandraCompressedStreamReader.java:93)
Oct 22 13:16:04 ip-10-0-13-111 cassandra[5927]:         at org.apache.cassandra.db.streaming.CassandraIncomingFile.read(CassandraIncomingFile.java:74)
Oct 22 13:16:04 ip-10-0-13-111 cassandra[5927]:         at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:49)
Oct 22 13:16:04 ip-10-0-13-111 cassandra[5927]:         at org.apache.cassandra.streaming.messages.IncomingStreamMessage$1.deserialize(IncomingStreamMessage.java:36)
Oct 22 13:16:04 ip-10-0-13-111 cassandra[5927]:         at org.apache.cassandra.streaming.messages.StreamMessage.deserialize(StreamMessage.java:55)
Oct 22 13:16:04 ip-10-0-13-111 cassandra[5927]:         at org.apache.cassandra.streaming.async.StreamingInboundHandler$StreamDeserializingTask.run(StreamingInboundHandler.java:177)
Oct 22 13:16:04 ip-10-0-13-111 cassandra[5927]:         at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
Oct 22 13:16:04 ip-10-0-13-111 cassandra[5927]:         at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:748)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;


&lt;p&gt;The data is created as follows:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-sql&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; KEYSPACE &lt;span class=&quot;code-keyword&quot;&gt;IF&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;EXISTS&lt;/span&gt; alex &lt;span class=&quot;code-keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;replication&lt;/span&gt; = { &lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&apos;NetworkTopologyStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;alourie&apos;&lt;/span&gt;: 3 };
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;TABLE&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;IF&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;EXISTS&lt;/span&gt; alex.test2 (                                                                                                                                                                                       
    part &lt;span class=&quot;code-keyword&quot;&gt;text&lt;/span&gt;,                                                                                                                                                                                                                          
    clus &lt;span class=&quot;code-keyword&quot;&gt;int&lt;/span&gt;,                                                                                                                                                                                                                           
    &lt;span class=&quot;code-keyword&quot;&gt;data&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;text&lt;/span&gt;,                                                                                                                                                                                                                          
    &lt;span class=&quot;code-keyword&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;KEY&lt;/span&gt; (part, clus)                                                                                                                                                                                                            
); 
&lt;span class=&quot;code-keyword&quot;&gt;CREATE&lt;/span&gt; MATERIALIZED &lt;span class=&quot;code-keyword&quot;&gt;VIEW&lt;/span&gt; alex.mv &lt;span class=&quot;code-keyword&quot;&gt;AS&lt;/span&gt;                                                                                                                                                                                           
    &lt;span class=&quot;code-keyword&quot;&gt;SELECT&lt;/span&gt; *                                                                                                                                                                                                                            
    &lt;span class=&quot;code-keyword&quot;&gt;FROM&lt;/span&gt; alex.test2                                                                                                                                                                                                                     
    &lt;span class=&quot;code-keyword&quot;&gt;WHERE&lt;/span&gt; part &lt;span class=&quot;code-keyword&quot;&gt;IS&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;NULL&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;AND&lt;/span&gt; clus &lt;span class=&quot;code-keyword&quot;&gt;IS&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;NOT&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;NULL&lt;/span&gt;                                                                                                                                                                                         
    &lt;span class=&quot;code-keyword&quot;&gt;PRIMARY&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;KEY&lt;/span&gt; (clus, part)                                                                                                                                                                                                            
    &lt;span class=&quot;code-keyword&quot;&gt;WITH&lt;/span&gt; CLUSTERING &lt;span class=&quot;code-keyword&quot;&gt;ORDER&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;BY&lt;/span&gt; (part &lt;span class=&quot;code-keyword&quot;&gt;ASC&lt;/span&gt;);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, basically speaking, the repairs don&apos;t work in trunk. &lt;/p&gt;</comment>
                            <comment id="16918975" author="jolynch" created="Thu, 29 Aug 2019 21:51:31 +0000"  >&lt;p&gt;I might have cycles to tackle this shortly, if someone else has cycles first please take it.&lt;/p&gt;</comment>
                            <comment id="16919020" author="djoshi3" created="Thu, 29 Aug 2019 22:48:44 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jolynch&quot; class=&quot;user-hover&quot; rel=&quot;jolynch&quot;&gt;jolynch&lt;/a&gt; I have assigned this to you. Thanks for volunteering &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="16931790" author="jjirsa" created="Tue, 17 Sep 2019 20:21:34 +0000"  >&lt;p&gt;Is this still broken? &lt;/p&gt;</comment>
                            <comment id="16931791" author="djoshi3" created="Tue, 17 Sep 2019 20:23:07 +0000"  >&lt;p&gt;Yes&lt;/p&gt;</comment>
                            <comment id="17000203" author="iamaleksey" created="Thu, 19 Dec 2019 17:00:11 +0000"  >&lt;p&gt;As multiple folks have noticed, &lt;tt&gt;current&lt;/tt&gt; tracking is indeed busted. And, also, as noticed, we don&#8217;t really need to track &lt;tt&gt;current&lt;/tt&gt; - it can always be inferred from the current chunk offset into the partition position, plus position in the current buffer. So what we need to track is only that offset of the actual buffer itself.&lt;/p&gt;

&lt;p&gt;Tracking it is actually rather trivial, since there are two distinct cases when we move to the next chunk:&lt;/p&gt;

&lt;p&gt;1. A &lt;tt&gt;reBuffer()&lt;/tt&gt; call upon exhaustion of the previous buffer, while still not done with the current partition position range. In this case we are moving to the adjacent compressed chunk, and we should bump offset by uncompressed chunk length, which is a fixed value for a given session;&lt;br/&gt;
2. We are skipping to the next partition position range, via &lt;tt&gt;position(long position)&lt;/tt&gt; call; it might be in the current chunk, or it might skip 1..n compressed chunks. In either case, the new offset and buffer position are derived from the new &lt;tt&gt;position&lt;/tt&gt; argument only&lt;/p&gt;

&lt;p&gt;There is another bug in the current implementation: if the compressed buffer exceeds length of &lt;tt&gt;info.parameters.chunkLength()&lt;/tt&gt; (if data was poorly compressible, for example, and upon compression blowed up in size instead of shrinking), then read code in &lt;tt&gt;Reader#runMayThrow()&lt;/tt&gt; wouldn&#8217;t be able to read that chunk fully into the temporary byte array.&lt;/p&gt;

&lt;p&gt;Speaking of that array: the slow-path copy happens to be the one we use, and it involves a redundant copy into this temporary array, followed by a copy of that array into the destination &lt;tt&gt;ByteBuffer&lt;/tt&gt;. That can be trivially eliminated by adding a &lt;tt&gt;readFully(ByteBuffer)&lt;/tt&gt; method to &lt;tt&gt;RebufferingInputStream&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;I&#8217;ve also realised that for no good reason we have an extra thread whose only job is to read the chunks off input into chunk-size byte buffers and put the on a queue for &lt;tt&gt;CompressedInputStream&lt;/tt&gt; to later consume. There is absolutely no reason for that and the complexity it introduces. It&#8217;s not the place to handle prefetching, nor does it make the input stream non-blocking, nor is it an issue if it were, given that streaming utilises a separate event loop group from messaging.&lt;/p&gt;

&lt;p&gt;It&#8217;s also very much unnecessary to allocate a whole new direct &lt;tt&gt;ByteBuffer&lt;/tt&gt; for every chunk. A single &lt;tt&gt;ByteBuffer&lt;/tt&gt; for the compressed chunk, reused, is all we need.&lt;/p&gt;

&lt;p&gt;Also, we&#8217;ve had no test coverage for &lt;tt&gt;min_compress_ratio&lt;/tt&gt;, introduced by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-10520&quot; title=&quot;Compressed writer and reader should support non-compressed data.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-10520&quot;&gt;&lt;del&gt;CASSANDRA-10520&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;And, one last thing/nit: while looking at the write side, I spotted some unnecessary garbage creation in &lt;tt&gt;CassandraCompressedStreamWriter#getTransferSections()&lt;/tt&gt; when extending current section, that can and should be easily avoided. Also the use of &lt;tt&gt;SSTableReader.PartitionPositionBounds&lt;/tt&gt; class in place of &lt;tt&gt;Pair&lt;/tt&gt;, when we did that refactor recently, is semantically incorrect: &lt;tt&gt;PartitionPositionBounds&lt;/tt&gt; as a class represents partition bound in the uncompressed stream, and not chunk bounds in the compressed one.&lt;/p&gt;

&lt;p&gt;I&#8217;ve addressed all these points and a bit more in &lt;a href=&quot;https://github.com/iamaleksey/cassandra/commits/13938-4.0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this branch&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17016527" author="djoshi3" created="Thu, 16 Jan 2020 03:56:09 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt;, Overall the code looks good. Minor nits only. Feel free to make changes on commit.&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;CompressedInputStream&lt;/tt&gt; - could you pull the resizing multiplier (1.5) out as a constant? I think its used in multiple locations.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;CompressedInputStream::chunkBytesRead&lt;/tt&gt; can be package private.&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;RebufferingInputStream&lt;/tt&gt; - Line 106, the word &apos;length&apos; has a typo in comment.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17017397" author="iamaleksey" created="Thu, 16 Jan 2020 18:33:51 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi&quot; class=&quot;user-hover&quot; rel=&quot;djoshi&quot;&gt;djoshi&lt;/a&gt;!&lt;/p&gt;

&lt;p&gt;Addressed the nits and committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/602a5eef177ac65020470cb0fcf8d88d820ab888&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;602a5eef177ac65020470cb0fcf8d88d820ab888&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;CI results &lt;a href=&quot;https://circleci.com/workflow-run/43acfc46-861a-478f-adf7-f2d145d43446&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; and &lt;a href=&quot;https://circleci.com/workflow-run/99a21fd3-cfc8-49bb-99a8-0b904a20669a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;. The existing failures are unrelated and known. One that was suspiciously close is &lt;tt&gt;org.apache.cassandra.distributed.test.FailingRepairTest&lt;/tt&gt; in both 8 and 11 in-JVM tests, but, again, it&apos;s not related, and also reliably passes locally. I will be looking into it, though.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13153101">CASSANDRA-14394</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13245153">CASSANDRA-15212</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12907692" name="13938.yaml" size="1257" author="jasobrown" created="Thu, 25 Jan 2018 13:51:30 +0000"/>
                            <attachment id="12907693" name="test.sh" size="918" author="jasobrown" created="Thu, 25 Jan 2018 13:51:30 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12983" cascade-level=""><![CDATA[Availability]]></customfieldvalue>
                                <customfieldvalue key="12992" cascade-level="1"><![CDATA[Process Crash]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3kwgf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12336842">4.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>djoshi</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[djoshi]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12346093">4.0-alpha</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314136" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/602a5eef177ac65020470cb0fcf8d88d820ab888&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;602a5eef177ac65020470cb0fcf8d88d820ab888&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>