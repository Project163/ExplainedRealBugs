<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:32:17 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4202] CQL 3.0 prepare_cql_query fails on &quot;BEGIN BATCH&quot;</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4202</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Preparing the following (contrived) statement with the C++ Thrift bindings &lt;br/&gt;
throws a TTransportException (&quot;No more data to read.&quot; from TTransport.h:41)&lt;/p&gt;

&lt;p&gt;q = &quot;begin batch insert into crashtest (id, val) values (?, ?); apply batch&quot;;&lt;br/&gt;
client.prepare_cql_query(pr, q, Compression::NONE);&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;crashtest.cpp&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;#include &amp;lt;protocol/TBinaryProtocol.h&amp;gt;
#include &amp;lt;thrift/transport/TSocket.h&amp;gt;
#include &amp;lt;thrift/transport/TTransportUtils.h&amp;gt;
#include &lt;span class=&quot;code-quote&quot;&gt;&quot;Cassandra.h&quot;&lt;/span&gt;

using namespace std;
using namespace apache::thrift;
using namespace apache::thrift::protocol;
using namespace apache::thrift::transport;
using namespace org::apache::cassandra;
using namespace boost;

&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; main(&lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; argc, &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt; **argv) {
    shared_ptr&amp;lt;TTransport&amp;gt; socket(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TSocket(&lt;span class=&quot;code-quote&quot;&gt;&quot;127.0.0.1&quot;&lt;/span&gt;, 9160));
    shared_ptr&amp;lt;TTransport&amp;gt; transport(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TFramedTransport(socket));
    shared_ptr&amp;lt;TProtocol&amp;gt; protocol(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; TBinaryProtocol(transport));

    CassandraClient client(protocol);

    &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; {
        transport-&amp;gt;open();
        client.set_keyspace(&lt;span class=&quot;code-quote&quot;&gt;&quot;test1&quot;&lt;/span&gt;);
        client.set_cql_version(&lt;span class=&quot;code-quote&quot;&gt;&quot;3.0.0&quot;&lt;/span&gt;);

        CqlResult cr;
        CqlPreparedResult pr;

        &lt;span class=&quot;code-comment&quot;&gt;// In cqlsh: create table crashtest (id &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; primary key, val text);
&lt;/span&gt;        &lt;span class=&quot;code-keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;code-object&quot;&gt;char&lt;/span&gt; *q;
        &lt;span class=&quot;code-comment&quot;&gt;// q = &lt;span class=&quot;code-quote&quot;&gt;&quot;insert into crashtest (id, val) values (?, ?)&quot;&lt;/span&gt;; // This works fine
&lt;/span&gt;        q = &lt;span class=&quot;code-quote&quot;&gt;&quot;begin batch insert into crashtest (id, val) values (?, ?); apply batch&quot;&lt;/span&gt;;

        client.prepare_cql_query(pr,  q, Compression::NONE);

        vector&amp;lt;string&amp;gt; vtypes = pr.variable_types;
        vector&amp;lt;string&amp;gt;::iterator it;

        &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; (it = vtypes.begin(); it != vtypes.end(); it++) {
            cout &amp;lt;&amp;lt; *it &amp;lt;&amp;lt; endl;
        }
    } &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (TException &amp;amp;tx) {
        cerr &amp;lt;&amp;lt; &lt;span class=&quot;code-quote&quot;&gt;&quot;TException ERROR: &quot;&lt;/span&gt; &amp;lt;&amp;lt; tx.what() &amp;lt;&amp;lt; endl;
    }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;backtrace&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;#0  0x00007fff901800e9 in __cxa_throw ()
#1  0x0000000100009ab9 in apache::thrift::transport::readAll&amp;lt;apache::thrift::transport::TBufferBase&amp;gt; (trans=@0x100401100, buf=0x7fff5fbfefc0 &lt;span class=&quot;code-quote&quot;&gt;&quot;??_\001&quot;&lt;/span&gt;, len=4) at TTransport.h:41
#2  0x0000000100009c1d in apache::thrift::transport::TBufferBase::readAll (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;=0x100401100, buf=0x7fff5fbfefc0 &lt;span class=&quot;code-quote&quot;&gt;&quot;??_\001&quot;&lt;/span&gt;, len=4) at TBufferTransports.h:82
#3  0x0000000100009c5b in apache::thrift::transport::TFramedTransport::readAll (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;=0x100401100, buf=0x7fff5fbfefc0 &lt;span class=&quot;code-quote&quot;&gt;&quot;??_\001&quot;&lt;/span&gt;, len=4) at TBufferTransports.h:390
#4  0x0000000100004b45 in apache::thrift::transport::TVirtualTransport&amp;lt;apache::thrift::transport::TFramedTransport, apache::thrift::transport::TBufferBase&amp;gt;::readAll_virt (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;=0x100401100, buf=0x7fff5fbfefc0 &lt;span class=&quot;code-quote&quot;&gt;&quot;??_\001&quot;&lt;/span&gt;, len=4) at TVirtualTransport.h:99
#5  0x00000001000034c1 in apache::thrift::transport::TTransport::readAll (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;=0x100401100, buf=0x7fff5fbfefc0 &lt;span class=&quot;code-quote&quot;&gt;&quot;??_\001&quot;&lt;/span&gt;, len=4) at TTransport.h:126
#6  0x0000000100009f4c in apache::thrift::protocol::TBinaryProtocolT&amp;lt;apache::thrift::transport::TTransport&amp;gt;::readI32 (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;=0x100401370, i32=@0x7fff5fbff020) at TBinaryProtocol.h:372
#7  0x000000010000b5bf in apache::thrift::protocol::TBinaryProtocolT&amp;lt;apache::thrift::transport::TTransport&amp;gt;::readMessageBegin (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;=0x100401370, name=@0x7fff5fbff228, messageType=@0x7fff5fbff224, seqid=@0x7fff5fbff234) at TBinaryProtocol.h:203
#8  0x0000000100006b07 in apache::thrift::protocol::TVirtualProtocol&amp;lt;apache::thrift::protocol::TBinaryProtocolT&amp;lt;apache::thrift::transport::TTransport&amp;gt;, apache::thrift::protocol::TProtocolDefaults&amp;gt;::readMessageBegin_virt (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;=0x100401370, name=@0x7fff5fbff228, messageType=@0x7fff5fbff224, seqid=@0x7fff5fbff234) at TVirtualProtocol.h:432
#9  0x00000001000abe78 in apache::thrift::protocol::TProtocol::readMessageBegin (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;=0x100401370, name=@0x7fff5fbff228, messageType=@0x7fff5fbff224, seqid=@0x7fff5fbff234) at TProtocol.h:518
#10 0x0000000100069a98 in org::apache::cassandra::CassandraClient::recv_prepare_cql_query (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;=0x7fff5fbff5b0, _return=@0x7fff5fbff4c0) at Cassandra.cpp:10231
#11 0x000000010003bf3f in org::apache::cassandra::CassandraClient::prepare_cql_query (&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;=0x7fff5fbff5b0, _return=@0x7fff5fbff4c0, query=@0x7fff5fbff6b0, compression=org::apache::cassandra::Compression::NONE) at Cassandra.cpp:10206
#12 0x00000001000020ea in main (argc=1, argv=0x7fff5fbff8c8) at crashtest.cpp:36
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeHeader panelHeader&quot; style=&quot;border-bottom-width: 1px;&quot;&gt;&lt;b&gt;server error message&lt;/b&gt;&lt;/div&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
ERROR 17:13:55,089 Error occurred during processing of message.
java.lang.ArrayIndexOutOfBoundsException: 0
	at org.apache.cassandra.cql3.statements.UpdateStatement.prepare(UpdateStatement.java:278)
	at org.apache.cassandra.cql3.statements.BatchStatement.prepare(BatchStatement.java:157)
	at org.apache.cassandra.cql3.QueryProcessor.getStatement(QueryProcessor.java:207)
	at org.apache.cassandra.cql3.QueryProcessor.prepare(QueryProcessor.java:158)
	at org.apache.cassandra.thrift.CassandraServer.prepare_cql_query(CassandraServer.java:1260)
	at org.apache.cassandra.thrift.Cassandra$Processor$prepare_cql_query.getResult(Cassandra.java:3484)
	at org.apache.cassandra.thrift.Cassandra$Processor$prepare_cql_query.getResult(Cassandra.java:3472)
	at org.apache.thrift.ProcessFunction.process(ProcessFunction.java:32)
	at org.apache.thrift.TBaseProcessor.process(TBaseProcessor.java:34)
	at org.apache.cassandra.thrift.CustomTThreadPoolServer$WorkerProcess.run(CustomTThreadPoolServer.java:186)
	at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
	at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:680)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment>&lt;p&gt;OSX 10.7.2, Cassandra 1.1.0, Thrift 0.7&lt;/p&gt;</environment>
        <key id="12553427">CASSANDRA-4202</key>
            <summary>CQL 3.0 prepare_cql_query fails on &quot;BEGIN BATCH&quot;</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="sbillig">Sean Billig</reporter>
                        <labels>
                            <label>c++</label>
                            <label>cql3</label>
                            <label>thrift</label>
                    </labels>
                <created>Mon, 30 Apr 2012 22:03:16 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:34 +0000</updated>
                            <resolved>Thu, 3 May 2012 07:30:58 +0000</resolved>
                                        <fixVersion>1.1.1</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13265433" author="jbellis" created="Mon, 30 Apr 2012 22:06:53 +0000"  >&lt;p&gt;Does the server log any errors?&lt;/p&gt;</comment>
                            <comment id="13265446" author="sbillig" created="Mon, 30 Apr 2012 22:16:04 +0000"  >&lt;p&gt;Oops, forgot the most important part.  Added it to the description.&lt;/p&gt;</comment>
                            <comment id="13266493" author="slebresne" created="Wed, 2 May 2012 11:36:57 +0000"  >&lt;p&gt;Patch attached to fix (we need the statements inside the batch to use the bounded variables from the batch itself).&lt;/p&gt;</comment>
                            <comment id="13266562" author="jbellis" created="Wed, 2 May 2012 13:45:42 +0000"  >&lt;p&gt;Is this an artifact of &quot;everything is a prepared statement?&quot;  Does that really make sense for batches?&lt;/p&gt;</comment>
                            <comment id="13266572" author="slebresne" created="Wed, 2 May 2012 13:58:11 +0000"  >&lt;p&gt;Depends what you mean by that &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;. To some extent it&apos;s an artifact of how we index bound variables in the parser. What happened is that the parser computes the index of the prepared variables (incrementing the index while parsing each time it sees a bound variable) and only the top-level statement knows how many variables there is at the end. For a batch, it means that individual inserts/deletes inside a batch needs to refer to the batch to know how many variables there is in total, which is what was not done. I don&apos;t know how clear that is and if I have answered your question though.  &lt;/p&gt;</comment>
                            <comment id="13266875" author="xedin" created="Wed, 2 May 2012 20:16:44 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13267276" author="slebresne" created="Thu, 3 May 2012 07:30:59 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12525277" name="4202.txt" size="6955" author="slebresne" created="Wed, 2 May 2012 11:36:56 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>237587</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 29 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gt6v:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>96159</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>xedin</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[xedin]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>