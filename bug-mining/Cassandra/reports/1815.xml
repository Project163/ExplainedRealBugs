<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:35:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4698] Keyspace disappears when upgrading node from cassandra-1.1.1 to cassandra-1.1.5</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4698</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Here is how I got the problem to happen:&lt;/p&gt;

&lt;p&gt;1. Get this zipped data directory (about 33Mb):&lt;br/&gt;
  scp cass@50.57.69.32:/home/cass/cassandra.zip ./ (password cass)&lt;br/&gt;
2. Unzip it in /var/lib/&lt;br/&gt;
3. clone the cassandra git repo&lt;br/&gt;
4. git checkout cassandra-1.1.1; ant jar;&lt;br/&gt;
5. bin/cassandra &lt;br/&gt;
6. Run cqlsh -3, then DESC COLUMNFAMILIES; Note the presence of Keyspace performance_tests&lt;br/&gt;
7. pkill -f cassandra; git checkout cassandra-1.1.5; ant realclean; ant jar;&lt;br/&gt;
8. bin/cassandra&lt;br/&gt;
9. Run cqlsh -3, then DESC COLUMNFAMILIES; Note that there is no performance_tests keyspace&lt;/p&gt;</description>
                <environment>&lt;p&gt;ubuntu. JNA not installed.&lt;/p&gt;</environment>
        <key id="12608662">CASSANDRA-4698</key>
            <summary>Keyspace disappears when upgrading node from cassandra-1.1.1 to cassandra-1.1.5</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="xedin">Pavel Yaskevich</assignee>
                                    <reporter username="tpatterson">Tyler Patterson</reporter>
                        <labels>
                    </labels>
                <created>Fri, 21 Sep 2012 16:21:03 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:27 +0000</updated>
                            <resolved>Thu, 27 Sep 2012 14:18:55 +0000</resolved>
                                        <fixVersion>1.1.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="13460594" author="tpatterson" created="Fri, 21 Sep 2012 16:24:08 +0000"  >&lt;p&gt;These are the log files after starting 1.1.1 and 1.1.5 respectively&lt;/p&gt;</comment>
                            <comment id="13462180" author="cdaw" created="Mon, 24 Sep 2012 22:03:45 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tpatterson&quot; class=&quot;user-hover&quot; rel=&quot;tpatterson&quot;&gt;tpatterson&lt;/a&gt;&lt;br/&gt;
Can you try this test out and let me know if the keyspace reappears?&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;In 1.1.1, show keyspaces to get schema definitions&lt;/li&gt;
	&lt;li&gt;Upgrade to 1.1.5&lt;/li&gt;
	&lt;li&gt;Recreate table definitions:
	&lt;ul&gt;
		&lt;li&gt;rm data/system/system_schema*&lt;/li&gt;
		&lt;li&gt;restart&lt;/li&gt;
		&lt;li&gt;CREATE KEYSPACE + CREATE TABLE as necessary&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13462183" author="jbellis" created="Mon, 24 Sep 2012 22:05:27 +0000"  >&lt;p&gt;It sounds like this reproduces on a single node?  No schema disagreement should be necessary/possible.&lt;/p&gt;</comment>
                            <comment id="13462187" author="tpatterson" created="Mon, 24 Sep 2012 22:13:03 +0000"  >&lt;blockquote&gt;&lt;p&gt;It sounds like this reproduces on a single node? No schema disagreement should be necessary/possible.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;yes, this happened on a single node.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt; Can you try this test out and let me know if the keyspace reappears? ...&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Yes. I did those steps on one of the columnfamilies in the keyspace and the data did indeed come back.&lt;/p&gt;</comment>
                            <comment id="13462276" author="xedin" created="Tue, 25 Sep 2012 00:00:25 +0000"  >&lt;p&gt;Attaching the patch to fix the problem which was related to fixing timestmaps in ColumnSerializer, instead of doing that patch does fixing only schema RowMutation timestamps from remote nodes.&lt;/p&gt;

&lt;p&gt;Tyler, can you please test the scenario when local correct schema data are getting overriden by incorrect remote (as seen at &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4561&quot; title=&quot;update column family fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4561&quot;&gt;&lt;del&gt;CASSANDRA-4561&lt;/del&gt;&lt;/a&gt;)?&lt;/p&gt;</comment>
                            <comment id="13462425" author="jbellis" created="Tue, 25 Sep 2012 04:03:21 +0000"  >&lt;p&gt;ISTM that only fixing remote timestamps is the wrong solution in general &amp;#8211; it fixes this particular scenario, but re-introduces &quot;unmodifiable&quot; keyspaces, since the &lt;span class=&quot;error&quot;&gt;&amp;#91;local&amp;#93;&lt;/span&gt; timestamp is now permanently left unnaturally high.&lt;/p&gt;

&lt;p&gt;I think that we need to fix it at a higher level than serialization: once the rows &lt;span class=&quot;error&quot;&gt;&amp;#91;from different sstables&amp;#93;&lt;/span&gt; have all been deserialized and merged, THEN fix the timestamp.  Then we won&apos;t have the problem of an adjusted tombstone clobbering a value that it didn&apos;t, pre-adjustment.&lt;/p&gt;</comment>
                            <comment id="13462611" author="xedin" created="Tue, 25 Sep 2012 09:43:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;ISTM that only fixing remote timestamps is the wrong solution in general &#8211; it fixes this particular scenario, but re-introduces &quot;unmodifiable&quot; keyspaces, since the &lt;span class=&quot;error&quot;&gt;&amp;#91;local&amp;#93;&lt;/span&gt; timestamp is now permanently left unnaturally high.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The local timestamp fixing didn&apos;t go anywhere and still fixed &lt;em&gt;before&lt;/em&gt; we accept remote schema mutations that it why it&apos;s useful to fix only schema mutation without touching anything else...&lt;/p&gt;</comment>
                            <comment id="13463483" author="tpatterson" created="Wed, 26 Sep 2012 03:00:15 +0000"  >&lt;blockquote&gt;&lt;p&gt;Tyler, can you please test the scenario when local correct schema data are getting overriden by incorrect remote (as seen at &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4561&quot; title=&quot;update column family fails&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4561&quot;&gt;&lt;del&gt;CASSANDRA-4561&lt;/del&gt;&lt;/a&gt;)?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt; Could you explain what you mean by local and remote schemas, and how I can go about testing this? Thanks&lt;/p&gt;</comment>
                            <comment id="13463674" author="xedin" created="Wed, 26 Sep 2012 10:00:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tpatterson&quot; class=&quot;user-hover&quot; rel=&quot;tpatterson&quot;&gt;tpatterson&lt;/a&gt; By local I mean - definitions from system.schema_*, by remote - mutations that could be sent (pushed) to the node from others or could be requested if local schema version is different from remote ones.&lt;/p&gt;</comment>
                            <comment id="13464000" author="tpatterson" created="Wed, 26 Sep 2012 18:06:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=xedin&quot; class=&quot;user-hover&quot; rel=&quot;xedin&quot;&gt;xedin&lt;/a&gt; I ran this test:&lt;/p&gt;

&lt;p&gt;I set up a 1-node 1.1.1 cluster with that broken keyspace mentioned at the beginning of this test, then I bootstrapped another 1.1.1 node and verified that the keyspace was visible to the second node. The timestamps were 16 digits long on both nodes. &lt;/p&gt;

&lt;p&gt;Then I took down node 2, upgraded it to 1.1.5, and started it back up. The keyspace was not visible. In cassandra-cli I did was not able to see the timestamps on node 2, here is what the output looked like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;[&lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt;@system] list schema_columns;
Using &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; limit of 100
Using &lt;span class=&quot;code-keyword&quot;&gt;default&lt;/span&gt; column limit of 100
-------------------
RowKey: performance_tests

1 Row Returned.
Elapsed time: 2 msec(s).
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;I got the same results for list schema_keyspaces and list schema_columnfamilies.&lt;/p&gt;

&lt;p&gt;On node1 (which was still on 1.1.1) the timestamps were still 16-digits long. I don&apos;t know how to get the now-incorrect remote schema (on node2) to overwrite the local correct schema (on node1).&lt;/p&gt;</comment>
                            <comment id="13464013" author="xedin" created="Wed, 26 Sep 2012 18:14:37 +0000"  >&lt;p&gt;Did you apply patch attached to this issue on top of 1.1.5?&lt;/p&gt;</comment>
                            <comment id="13464021" author="jbellis" created="Wed, 26 Sep 2012 18:23:53 +0000"  >&lt;p&gt;Patch LGTM.&lt;/p&gt;</comment>
                            <comment id="13464105" author="tpatterson" created="Wed, 26 Sep 2012 19:50:11 +0000"  >&lt;p&gt;I hadn&apos;t applied the patch, but I just tried it again with the patch. With the patch the keyspace disappearing bug didn&apos;t happen. The timestamps all were 16-digits long on both nodes after upgrading one node.&lt;/p&gt;</comment>
                            <comment id="13464136" author="xedin" created="Wed, 26 Sep 2012 20:20:31 +0000"  >&lt;p&gt;Great! Tyler will be running the last test to confirm that new node correctly handles timestamps from old nodes and we are good to go.&lt;/p&gt;</comment>
                            <comment id="13464252" author="tpatterson" created="Wed, 26 Sep 2012 22:31:18 +0000"  >&lt;p&gt;I re-ran the test like the one described earlier today, but after node2 was upgraded to 1.1.5 (with the patch), I followed Pavel&apos;s instructions:&lt;br/&gt;
start first and second, stop second, run resetschema on first, stop first, start second, start first&lt;/p&gt;

&lt;p&gt;Both nodes then showed 16-digit timestamps with 3 zeros at the end. &lt;/p&gt;</comment>
                            <comment id="13464301" author="tpatterson" created="Thu, 27 Sep 2012 00:02:02 +0000"  >&lt;p&gt;Per Pavel&apos;s request I ran the test again. Everything checked out, here are the steps followed:&lt;/p&gt;

&lt;p&gt;1: get that data onto both nodes in a 1.1.1 cluster&lt;br/&gt;
2: upgrade and start node2 on 1.1.5+patch&lt;br/&gt;
3: stop both nodes&lt;br/&gt;
4: start node1 (1.1.1) and verify that timestamps are fixed (zero last 3 digits) &lt;br/&gt;
5: stop node1 &lt;br/&gt;
6: start node2 (1.1.5+patch), verify that timestamps are fixed (3 zeros)&lt;br/&gt;
7: nodetool resetlocalschema on node2&lt;br/&gt;
8: Verify that the troublesome keyspace is &lt;b&gt;not&lt;/b&gt; present on node2&lt;br/&gt;
9: stop node2&lt;br/&gt;
10: start node1&lt;br/&gt;
11: start node2 &lt;br/&gt;
12: verify that the troublesome keyspace appears on node2 and timestamps are fixed (3 zeros)&lt;/p&gt;</comment>
                            <comment id="13464763" author="xedin" created="Thu, 27 Sep 2012 14:18:55 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="13464801" author="hudson" created="Thu, 27 Sep 2012 15:06:42 +0000"  >&lt;p&gt;Integrated in Cassandra #2190 (See &lt;a href=&quot;https://builds.apache.org/job/Cassandra/2190/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://builds.apache.org/job/Cassandra/2190/&lt;/a&gt;)&lt;br/&gt;
    adopt RM code of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-4698&quot; title=&quot;Keyspace disappears when upgrading node from cassandra-1.1.1 to cassandra-1.1.5&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-4698&quot;&gt;&lt;del&gt;CASSANDRA-4698&lt;/del&gt;&lt;/a&gt; to trunk (Revision a0d7d9713d776506ce6c2eea577eea3b7c5099bd)&lt;/p&gt;

&lt;p&gt;     Result = ABORTED&lt;br/&gt;
xedin : &lt;br/&gt;
Files : &lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;src/java/org/apache/cassandra/db/RowMutation.java&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13474440" author="tpatterson" created="Thu, 11 Oct 2012 19:06:53 +0000"  >&lt;p&gt;Verified that the issue is fixed for 1.1.6-tentative&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12546412" name="CASSANDRA-4698.patch" size="4280" author="xedin" created="Tue, 25 Sep 2012 00:00:25 +0000"/>
                            <attachment id="12546056" name="start_1.1.1_system.log" size="11308" author="tpatterson" created="Fri, 21 Sep 2012 16:24:08 +0000"/>
                            <attachment id="12546057" name="start_1.1.5_system.log" size="8772" author="tpatterson" created="Fri, 21 Sep 2012 16:24:08 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[xedin]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>241134</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 6 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i019iv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>5312</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>