<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:52:42 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9240] Performance issue after a restart</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9240</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I have noticed a performance issue while I was working on compaction perf tests for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7409&quot; title=&quot;Allow multiple overlapping sstables in L1&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7409&quot;&gt;CASSANDRA-7409&lt;/a&gt;. The performance for my use case is very bad after a restart. It is mostly a read performance issue but not strictly. I have attached my use case (see run_issue.sh and issue.yaml) and all test logs for 2.1.4, 2.1.5 and trunk:&lt;/p&gt;

&lt;ul&gt;
	&lt;li&gt;2.1.* are OK (although 2.1.4 seems to be better than 2.1.5?): ~6-7k ops/second and ~2-2.5k of read latency.&lt;/li&gt;
	&lt;li&gt;trunk is NOT OK: ~1.5-2k ops/second and 25-30k of read latency.&lt;/li&gt;
	&lt;li&gt;trunk is OK without a restart: ~ same perf than 2.1.4 and 2.1.5.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;EDIT: branch cassandra-2.1 is OK.&lt;/p&gt;

&lt;p&gt;I can help to bisect and/or profile on Monday if needed.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12823903">CASSANDRA-9240</key>
            <summary>Performance issue after a restart</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10003" iconUrl="https://issues.apache.org/jira/images/icons/priorities/trivial.svg">Low</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="benedict">Benedict Elliott Smith</assignee>
                                    <reporter username="aboudreault">Alan Boudreault</reporter>
                        <labels>
                    </labels>
                <created>Fri, 24 Apr 2015 21:43:07 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:13 +0000</updated>
                            <resolved>Thu, 7 May 2015 10:31:50 +0000</resolved>
                                        <fixVersion>2.2.0 rc2</fixVersion>
                    <fixVersion>3.0 alpha 1</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="14514115" author="aboudreault" created="Mon, 27 Apr 2015 13:24:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; Let me know if you can take a look at this and if you need anything else.&lt;/p&gt;</comment>
                            <comment id="14514169" author="benedict" created="Mon, 27 Apr 2015 14:02:48 +0000"  >&lt;p&gt;If you could grab a profile (sampled time in each method) of each situation, it could help. I would guess the problem is triggered by the creation of an sstable after commit log replay, but exactly where the increased costs are being incurred (on merge, on sstable read, whatever) is tough to say.&lt;/p&gt;</comment>
                            <comment id="14514174" author="aboudreault" created="Mon, 27 Apr 2015 14:08:07 +0000"  >&lt;p&gt;Yes, I can do that. I am going to profile the executions. &lt;/p&gt;</comment>
                            <comment id="14514936" author="aboudreault" created="Mon, 27 Apr 2015 20:38:01 +0000"  >&lt;p&gt;Here&apos;s the snapshots of cassandra 2.1.5 and trunk:  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12728504/12728504_Cassandra.snapshots.zip&quot; title=&quot;Cassandra.snapshots.zip attached to CASSANDRA-9240&quot;&gt;Cassandra.snapshots.zip&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;In trunk, the commit 93b36d4b8293d76e70c75df5d2674cb2 is OK. Then things are broken after a merge... will continue to investigate the exact commit later.&lt;/p&gt;</comment>
                            <comment id="14516001" author="benedict" created="Tue, 28 Apr 2015 00:15:34 +0000"  >&lt;p&gt;This appears to be a performance regression caused by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8464&quot; title=&quot;Support direct buffer decompression for reads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8464&quot;&gt;&lt;del&gt;CASSANDRA-8464&lt;/del&gt;&lt;/a&gt;. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=blambov&quot; class=&quot;user-hover&quot; rel=&quot;blambov&quot;&gt;blambov&lt;/a&gt;: from the yourkit profiles attached by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aboudreault&quot; class=&quot;user-hover&quot; rel=&quot;aboudreault&quot;&gt;aboudreault&lt;/a&gt; it looks like it may be the native ByteBuffer method is somehow significantly slower. Since this is based on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-7039&quot; title=&quot;DirectByteBuffer compatible LZ4 methods&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-7039&quot;&gt;&lt;del&gt;CASSANDRA-7039&lt;/del&gt;&lt;/a&gt;, could you take a look? &lt;/p&gt;</comment>
                            <comment id="14516769" author="blambov" created="Tue, 28 Apr 2015 10:22:02 +0000"  >&lt;p&gt;Before 8464 reads from disk were explicit, after 8464 the data is memory-mapped hence their time share is accounted for in whatever happens to be using the data. In this case that&apos;s LZ4Compressor.uncompress.&lt;/p&gt;

&lt;p&gt;More time spent in it now means data being read more slowly. Could it be that the OS is evicting memory-mapped pages from cache when the application that owns them closes?&lt;/p&gt;</comment>
                            <comment id="14516958" author="benedict" created="Tue, 28 Apr 2015 12:30:36 +0000"  >&lt;blockquote&gt;&lt;p&gt;Could it be that the OS is evicting memory-mapped pages&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, definitely not. But you&apos;re on the right track. I&apos;m pretty sure the problem is that we explicitly &quot;clean&quot; the buffers on &quot;deallocating&quot; the RARs. If the reader is memory-mapped this likely results in the OS evicting at least those pages (perhaps more?)&lt;/p&gt;

&lt;p&gt;Reassigning to &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; since this is a problem from &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8464&quot; title=&quot;Support direct buffer decompression for reads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8464&quot;&gt;&lt;del&gt;CASSANDRA-8464&lt;/del&gt;&lt;/a&gt; itself, and not the new lz4 methods.&lt;/p&gt;</comment>
                            <comment id="14517052" author="tjake" created="Tue, 28 Apr 2015 14:00:23 +0000"  >&lt;p&gt;I just tried reproducing with the following:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;./tools/bin/cassandra-stress user profile=/home/jake/Downloads/issue.yaml ops\(insert=1\) n=2000000 -rate threads=50

./tools/bin/cassandra-stress user profile=/home/jake/Downloads/issue.yaml ops\(read=1\) n=50000 -rate threads=50 

#restart cassandra

./tools/bin/cassandra-stress user profile=/home/jake/Downloads/issue.yaml ops\(read=1\) n=50000 -rate threads=50 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Both read runs yielded 6-7k ops/sec. &lt;br/&gt;
&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aboudreault&quot; class=&quot;user-hover&quot; rel=&quot;aboudreault&quot;&gt;aboudreault&lt;/a&gt; Are you on a mac maybe?&lt;/p&gt;

</comment>
                            <comment id="14517053" author="aboudreault" created="Tue, 28 Apr 2015 14:02:59 +0000"  >&lt;p&gt;no, on a Ubuntu trusty. I reproduced that issue on my laptop and a ctool instance (ubuntu precise).&lt;/p&gt;</comment>
                            <comment id="14517065" author="tjake" created="Tue, 28 Apr 2015 14:09:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aboudreault&quot; class=&quot;user-hover&quot; rel=&quot;aboudreault&quot;&gt;aboudreault&lt;/a&gt; does the issue happen consistently run after run? or just right after a restart?&lt;/p&gt;</comment>
                            <comment id="14517098" author="aboudreault" created="Tue, 28 Apr 2015 14:29:33 +0000"  >&lt;p&gt;run after run. Did two subsequent runs of n=500000, both was bad perf.&lt;/p&gt;</comment>
                            <comment id="14517129" author="aboudreault" created="Tue, 28 Apr 2015 14:53:20 +0000"  >&lt;p&gt;Here is the log of 3 subsequent runs. Things seem to get worst each run: &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12728810/12728810_runs.log&quot; title=&quot;runs.log attached to CASSANDRA-9240&quot;&gt;runs.log&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="14517315" author="tjake" created="Tue, 28 Apr 2015 16:16:38 +0000"  >&lt;p&gt;So looks like its happening only with the following low heap settings: -Xms500M -Xmx500M -Xmn50M&lt;/p&gt;</comment>
                            <comment id="14517321" author="benedict" created="Tue, 28 Apr 2015 16:19:25 +0000"  >&lt;p&gt;Maybe because a larger heap lets it avoid flushing (or flushing as often)? Or do you mean after a restart with a larger heap it is still fine?&lt;/p&gt;</comment>
                            <comment id="14517462" author="tjake" created="Tue, 28 Apr 2015 17:21:56 +0000"  >&lt;p&gt;It&apos;s worse with small heap. No issue with large heap. &lt;br/&gt;
Also with no mmap access it&apos;s still getting progressively slower with a small heap which is strange. &lt;/p&gt;</comment>
                            <comment id="14523287" author="aboudreault" created="Fri, 1 May 2015 15:02:52 +0000"  >&lt;p&gt;Is there a way to by-pass this direct buffer slowdown? So I could restart my compaction tests. &lt;/p&gt;</comment>
                            <comment id="14523288" author="tjake" created="Fri, 1 May 2015 15:04:16 +0000"  >&lt;p&gt;Use a larger heap?&lt;/p&gt;</comment>
                            <comment id="14523310" author="aboudreault" created="Fri, 1 May 2015 15:16:33 +0000"  >&lt;p&gt;oh right. Sorry, I had forgotten I tested that a few days ago.&lt;/p&gt;</comment>
                            <comment id="14523367" author="tjake" created="Fri, 1 May 2015 16:00:44 +0000"  >&lt;p&gt;I&apos;ve gone back to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8464&quot; title=&quot;Support direct buffer decompression for reads&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8464&quot;&gt;&lt;del&gt;CASSANDRA-8464&lt;/del&gt;&lt;/a&gt; and I don&apos;t see this issue. Going to start bisecting.&lt;/p&gt;</comment>
                            <comment id="14523690" author="tjake" created="Fri, 1 May 2015 18:57:53 +0000"  >&lt;p&gt;I bisected the issue to &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9112&quot; title=&quot;Remove ternary construction of SegmentedFile.Builder in readers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-9112&quot;&gt;&lt;del&gt;CASSANDRA-9112&lt;/del&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Not sure what could cause the issue there? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="14523777" author="benedict" created="Fri, 1 May 2015 19:41:12 +0000"  >&lt;p&gt;CompressedPoolingSegmentedFile != CompressedSegmentedFile&lt;/p&gt;

&lt;p&gt;Doh.&lt;/p&gt;

&lt;p&gt;But it&apos;s interesting, and has demonstrated some unexpected behaviour, since this seems to suggest there could be serious (atypical) performance degradation from an insufficiently sized cache. It &lt;em&gt;seems&lt;/em&gt; from the profile that we&apos;re incurring costs on reading from the buffer more than anywhere else. Which seems to suggest it may result in the OS actually dropping the pages from its cache. At the very least some cost incurred after remapping is high, in which case calling the cleaner isn&apos;t probably a good idea. &lt;/p&gt;

&lt;p&gt;It seems like the safest thing is to introduce a specialized SegmentedFile for mmapped compressed files, that retains all of the mapped sections to pass into the CompressedRandomAccessReader on construction, so that these costs are guaranteed only ever to occur once per sstable, and not once per reader. This is possible thanks to the recent work of &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefania_alborghetti&quot; class=&quot;user-hover&quot; rel=&quot;stefania_alborghetti&quot;&gt;stefania_alborghetti&lt;/a&gt;, and I think we should exploit it here to ensure this isn&apos;t a problem even after my boo-boo is fixed.&lt;/p&gt;</comment>
                            <comment id="14523829" author="tjake" created="Fri, 1 May 2015 20:15:15 +0000"  >&lt;p&gt;I also set disk_access_mode: standard (so not mmap) and it was also 50% slower&lt;/p&gt;</comment>
                            <comment id="14523875" author="benedict" created="Fri, 1 May 2015 20:39:58 +0000"  >&lt;p&gt;Well now that really doesn&apos;t make sense, since it should do nothing without mmap. It won&apos;t open/close the channel, since that&apos;s wrapped by the SegmentedFile, and it uses a heap buffer, so it cannot waste time cleaning it....&lt;/p&gt;</comment>
                            <comment id="14523880" author="tjake" created="Fri, 1 May 2015 20:42:16 +0000"  >&lt;p&gt;It&apos;s something about the pooling itself...&lt;/p&gt;</comment>
                            <comment id="14523942" author="benedict" created="Fri, 1 May 2015 21:04:02 +0000"  >&lt;p&gt;But the pooling is (or should be) effectively a no-op with mmap off.&lt;/p&gt;</comment>
                            <comment id="14524374" author="benedict" created="Sat, 2 May 2015 00:27:04 +0000"  >&lt;p&gt;OK, so I&apos;ve pushed a fix for this &lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/9240&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;This both reintroduces the pooling, and shares the mapped segments between all readers, for both pooled and regular compressed files. This could be tidied up, but since we&apos;re eliminating a lot of the functionality in these classes in the near future time is probably better spent cleaning them up as that happens.&lt;/p&gt;

&lt;p&gt;FTR, I managed to reproduce the problem with a regular heap with mmap enabled on trunk, and could eliminate the problem without reintroducing pooling, at least with those heap settings. So the cleaning of the buffers was likely the main culprit. I could strangely reproduce some reduced throughput on trunk with standard mode without pooling vs with, but not on my branch. That&apos;s a little odd, but probably a rabbit hole not worth diving into.&lt;/p&gt;</comment>
                            <comment id="14524485" author="jbellis" created="Sat, 2 May 2015 02:33:07 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt; to review&lt;/p&gt;</comment>
                            <comment id="14525911" author="aboudreault" created="Sun, 3 May 2015 17:32:27 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;. I tested your branch and it works great. (also tried disk_access_mode: standard).&lt;/p&gt;</comment>
                            <comment id="14526647" author="tjake" created="Mon, 4 May 2015 13:56:49 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; you have a bug in the CRAR constructor. allocateBuffer() is being called before segments are mapped so it is always creating an on heap buffer.&lt;/p&gt;


&lt;p&gt;Minor nit in your Cleanup method. For multiple levels of conditionals and loops please add {} &lt;/p&gt;


&lt;p&gt;Finally, I know &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8897&quot; title=&quot;Remove FileCacheService, instead pooling the buffers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8897&quot;&gt;&lt;del&gt;CASSANDRA-8897&lt;/del&gt;&lt;/a&gt; is going to remove pooling, but how will we avoid the cost of un-mapping the files if we don&apos;t pool?&lt;/p&gt;</comment>
                            <comment id="14526659" author="benedict" created="Mon, 4 May 2015 14:15:05 +0000"  >&lt;blockquote&gt;&lt;p&gt;Benedict you have a bug in the CRAR constructor. allocateBuffer() is being called before segments are mapped so it is always creating an on heap buffer.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Good catch. I was planning on removing the constraint to only use direct when using mmapped files in a follow up commit. Any opposition to doing that here (since it also fixes that)?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Minor nit in your Cleanup method. For multiple levels of conditionals and loops please add {}&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think we should clarify our code style policy on this, since I do this kind of thing a lot, certainly at the very least for multi-nested loops or conditionals, and for conditionals inside of loops, but a loop nested inside a conditional is its own unique case. Would be good to have an official policy. Could you and the other PMCs (or whoever decides this stuff) come up with an official position on when we can and cannot omit braces?&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Finally, I know &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8897&quot; title=&quot;Remove FileCacheService, instead pooling the buffers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8897&quot;&gt;&lt;del&gt;CASSANDRA-8897&lt;/del&gt;&lt;/a&gt; is going to remove pooling, but how will we avoid the cost of un-mapping the files if we don&apos;t pool?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This patch has already avoided the cost of un-mapping the files, whether or not pooling is used&lt;/p&gt;</comment>
                            <comment id="14526663" author="tjake" created="Mon, 4 May 2015 14:19:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;I was planning on removing the constraint to only use direct when using mmapped files in a follow up commit.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;The original code did this &quot;if (useMmap &amp;amp;&amp;amp; useDirect...)&quot;  But the compressors need to specify which kind of buffer they accept, example DeflateCompressors can&apos;t use Direct...&lt;/p&gt;

</comment>
                            <comment id="14526669" author="benedict" created="Mon, 4 May 2015 14:21:58 +0000"  >&lt;blockquote&gt;&lt;p&gt;But the compressors need to specify which kind of buffer they accept, example DeflateCompressors can&apos;t use Direct...&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That&apos;s the &lt;tt&gt;useDirect&lt;/tt&gt; condition - the &lt;tt&gt;useMmap&lt;/tt&gt; (which has been replaced by &lt;tt&gt;chunkSegments != null&lt;/tt&gt;) isn&apos;t necessary for that I don&apos;t think?&lt;/p&gt;</comment>
                            <comment id="14526681" author="tjake" created="Mon, 4 May 2015 14:32:21 +0000"  >&lt;p&gt;It is still needed because only mmap codepath uses the ByteBuffer ICompressor api the standard mode uses byte[] which won&apos;t work with direct&lt;/p&gt;</comment>
                            <comment id="14526859" author="benedict" created="Mon, 4 May 2015 17:05:10 +0000"  >&lt;p&gt;Well, that&apos;s easily fixed &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;I&apos;ve pushed an updated version with that changed&lt;/p&gt;</comment>
                            <comment id="14530630" author="tjake" created="Wed, 6 May 2015 14:31:22 +0000"  >&lt;blockquote&gt;&lt;p&gt;I&apos;ve pushed an updated version with that changed&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1,   You can switch LZ4 to use direct buffers on commit if you want&lt;/p&gt;</comment>
                            <comment id="14533736" author="stefania" created="Fri, 8 May 2015 01:39:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=tjake&quot; class=&quot;user-hover&quot; rel=&quot;tjake&quot;&gt;tjake&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aboudreault&quot; class=&quot;user-hover&quot; rel=&quot;aboudreault&quot;&gt;aboudreault&lt;/a&gt;, this fix conflicted with &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8897&quot; title=&quot;Remove FileCacheService, instead pooling the buffers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8897&quot;&gt;&lt;del&gt;CASSANDRA-8897&lt;/del&gt;&lt;/a&gt; (no more CompressedPoolingSegmentedFile in favor or a buffer pool). &lt;/p&gt;

&lt;p&gt;Could you sum-up the easiest way to reproduce this issue so I can do some tests on the 8897 branch?&lt;/p&gt;</comment>
                            <comment id="14533746" author="aboudreault" created="Fri, 8 May 2015 01:46:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; Use a low heap cassandra (ccm default in example: -Xms500M -Xmx500M -Xmn50M) and do some write, restart cassandra and do some read like:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;./tools/bin/cassandra-stress user profile=/home/jake/Downloads/issue.yaml ops\(insert=1\) n=2000000 -rate threads=50

./tools/bin/cassandra-stress user profile=/home/jake/Downloads/issue.yaml ops\(read=1\) n=50000 -rate threads=50 

#restart cassandra

./tools/bin/cassandra-stress user profile=/home/jake/Downloads/issue.yaml ops\(read=1\) n=500000 -rate threads=50 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Check my &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/12728051/12728051_run_issue.sh&quot; title=&quot;run_issue.sh attached to CASSANDRA-9240&quot;&gt;run_issue.sh&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; script to see the complete test.&lt;/p&gt;</comment>
                            <comment id="14533781" author="stefania" created="Fri, 8 May 2015 03:02:35 +0000"  >&lt;p&gt;Thanks for this. I see the mean latency on read doubles after restart on trunk, is this expected? &lt;/p&gt;

&lt;p&gt;On the 8897 branch it&apos;s even worse, it&apos;s already double that of trunk on the first read and it degrades further after a restart so I definitely did something wrong which I&apos;ll have to work out but I&apos;ll carry on the discussion on that ticket.&lt;/p&gt;

&lt;p&gt;Here are the results in case anyone is interested.&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;Mean latency (one none running in foreground with -Xms500M -Xmx500M -Xmn50M, inserting 200k and reading back 50k):

TRUNK insert 7.2
TRUNK read 8.7
TRUNK read after restart 16.4

8897 insert 6.8
8897 read 16.6
8897 read after restart 22.3
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14554228" author="aboudreault" created="Thu, 21 May 2015 12:51:22 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Stefania&quot; class=&quot;user-hover&quot; rel=&quot;stefania&quot;&gt;Stefania&lt;/a&gt; Is everything Ok now?&lt;/p&gt;</comment>
                            <comment id="14555277" author="stefania" created="Thu, 21 May 2015 23:32:03 +0000"  >&lt;p&gt;Yes it is thank you. I did find the problem on my branch and it was something unrelated, see &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8897?focusedCommentId=14543355&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14543355&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;this comment&lt;/a&gt; on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-8897&quot; title=&quot;Remove FileCacheService, instead pooling the buffers&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-8897&quot;&gt;&lt;del&gt;CASSANDRA-8897&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Sorry for not posting here as well.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310050">
                    <name>Regression</name>
                                            <outwardlinks description="breaks">
                                        <issuelink>
            <issuekey id="12836851">CASSANDRA-9573</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="12946606">CASSANDRA-11301</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12728504" name="Cassandra.snapshots.zip" size="10166432" author="aboudreault" created="Mon, 27 Apr 2015 20:38:01 +0000"/>
                            <attachment id="12728039" name="cassandra_2.1.4-clientrequest-read.log" size="4704" author="aboudreault" created="Fri, 24 Apr 2015 21:43:07 +0000"/>
                            <attachment id="12728040" name="cassandra_2.1.4.log" size="89983" author="aboudreault" created="Fri, 24 Apr 2015 21:43:07 +0000"/>
                            <attachment id="12728041" name="cassandra_2.1.5-clientrequest-read.log" size="1194" author="aboudreault" created="Fri, 24 Apr 2015 21:43:07 +0000"/>
                            <attachment id="12728042" name="cassandra_2.1.5.log" size="95143" author="aboudreault" created="Fri, 24 Apr 2015 21:43:07 +0000"/>
                            <attachment id="12728047" name="cassandra_trunk-clientrequest-read.log" size="2340" author="aboudreault" created="Fri, 24 Apr 2015 21:43:07 +0000"/>
                            <attachment id="12728046" name="cassandra_trunk.log" size="116179" author="aboudreault" created="Fri, 24 Apr 2015 21:43:07 +0000"/>
                            <attachment id="12728050" name="cassandra_trunk_no_restart-clientrequest-read.log" size="880" author="aboudreault" created="Fri, 24 Apr 2015 21:43:07 +0000"/>
                            <attachment id="12728049" name="cassandra_trunk_no_restart.log" size="88011" author="aboudreault" created="Fri, 24 Apr 2015 21:43:07 +0000"/>
                            <attachment id="12728045" name="issue.yaml" size="752" author="aboudreault" created="Fri, 24 Apr 2015 21:43:07 +0000"/>
                            <attachment id="12728051" name="run_issue.sh" size="603" author="aboudreault" created="Fri, 24 Apr 2015 21:43:07 +0000"/>
                            <attachment id="12728810" name="runs.log" size="219609" author="aboudreault" created="Tue, 28 Apr 2015 14:53:20 +0000"/>
                            <attachment id="12728048" name="trace_query.cql" size="177" author="aboudreault" created="Fri, 24 Apr 2015 21:43:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>13.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 26 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2dqrb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324945">2.2.0 beta 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>tjake</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[tjake]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12961"><![CDATA[Low]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12311124" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Tester</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aboudreault</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                        </customfields>
    </item>
</channel>
</rss>