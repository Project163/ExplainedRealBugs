<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:40:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5926] The native protocol server can deadlock</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5926</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Until &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5239&quot; title=&quot;Asynchronous (non-blocking) StorageProxy&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5239&quot;&gt;&lt;del&gt;CASSANDRA-5239&lt;/del&gt;&lt;/a&gt; (i.e. since StorageProxy is blocking), the native protocol server needs to use a thread per request being processed. For that, it currently use a DebuggableThreadPoolExecutor, but with a limited queue. The rational being that we don&apos;t want to OOM if a client overwhelm the server. Rather, we prefer blocking (which DTPE gives us) on the submission of new request by the netty worker threads when all threads are busy.&lt;/p&gt;

&lt;p&gt;However, as it happens, when netty sends back a response to a query, there is cases where some events (technically, InterestChanged and WriteComplete events) are send up the pipeline. And those event are submitted on the request executor as other requests. Long story short, a request thread can end blocking on the submission to its own executor, hence deadlocking.&lt;/p&gt;

&lt;p&gt;The simplest solution is probably to reuse MemoryAwareThreadPoolExecutor from netty rather that our own DTPE as it also allow to block task submission when all threads are busy but knows not to block it&apos;s own internal events.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12665214">CASSANDRA-5926</key>
            <summary>The native protocol server can deadlock</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="slebresne">Sylvain Lebresne</assignee>
                                    <reporter username="slebresne">Sylvain Lebresne</reporter>
                        <labels>
                    </labels>
                <created>Fri, 23 Aug 2013 11:57:08 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:07 +0000</updated>
                            <resolved>Fri, 30 Aug 2013 11:32:34 +0000</resolved>
                                        <fixVersion>1.2.9</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="13748490" author="slebresne" created="Fri, 23 Aug 2013 11:58:32 +0000"  >&lt;p&gt;Attaching patch that switches to MemoryAwareThreadPoolExecutor. One interesting detail is that MATPE always forces corePoolSize == maxPoolSize, so doing that pretty much deprecates the native_transport_min_threads in the yaml. I&apos;d say this is probably fine in practice though.&lt;/p&gt;</comment>
                            <comment id="13748561" author="jbellis" created="Fri, 23 Aug 2013 14:09:05 +0000"  >&lt;p&gt;&quot;serie&quot; typo, otherwise +1&lt;/p&gt;</comment>
                            <comment id="13750156" author="slebresne" created="Mon, 26 Aug 2013 15:43:37 +0000"  >&lt;p&gt;Committed, thanks&lt;/p&gt;</comment>
                            <comment id="13752710" author="mkjellman" created="Wed, 28 Aug 2013 18:45:38 +0000"  >&lt;p&gt;Ironically, I hit this deadlock after the proposed change. Thread dump attached.&lt;/p&gt;

&lt;p&gt;IO Worker #11 is most interesting.&lt;/p&gt;</comment>
                            <comment id="13753152" author="mkjellman" created="Thu, 29 Aug 2013 01:12:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/netty/netty/issues/1310&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/netty/netty/issues/1310&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13753874" author="slebresne" created="Thu, 29 Aug 2013 17:55:03 +0000"  >&lt;p&gt;Yep, pretty sure that&apos;s what you&apos;ve run into. We&apos;ll have to update your netty dependency.&lt;/p&gt;</comment>
                            <comment id="13754608" author="slebresne" created="Fri, 30 Aug 2013 11:32:34 +0000"  >&lt;p&gt;Let me re-close this since the committed did fix the original deadlock. It&apos;s obviously now unfortunate that we&apos;re running into a netty bug, but since 1.2.9 has shipped, I&apos;ve opened a separate issue (&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5955&quot; title=&quot;The native protocol server can trigger a Netty bug&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5955&quot;&gt;&lt;del&gt;CASSANDRA-5955&lt;/del&gt;&lt;/a&gt;) to upgrade our dependency.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12599611" name="5926.txt" size="3995" author="slebresne" created="Fri, 23 Aug 2013 11:58:32 +0000"/>
                            <attachment id="12600437" name="stack" size="1378071" author="mkjellman" created="Wed, 28 Aug 2013 18:45:50 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>345155</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 12 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1nirb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>345456</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12324803">1.2.9</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>