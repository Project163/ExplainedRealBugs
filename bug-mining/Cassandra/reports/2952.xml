<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:46:28 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-7543] Assertion error when compacting large row with map//list field or range tombstone</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-7543</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Hi,&lt;br/&gt;
So in a couple of clusters we&apos;re hitting this problem when compacting large rows with a schema which contains the map data-type.&lt;br/&gt;
Here is an example of the error:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;java.lang.AssertionError: incorrect row data size 87776427 written to /cassandra/X/Y/X-Y-tmp-ic-2381-Data.db; correct is 87845952
org.apache.cassandra.io.sstable.SSTableWriter.append(SSTableWriter.java:162)
org.apache.cassandra.db.compaction.CompactionTask.runWith(CompactionTask.java:163)
org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48)
org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28)
org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:58) 
org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:60) 
org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:208)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;I have a python script which reproduces the problem, by just writing lots of data to a single partition key with a schema that contains the map data-type.&lt;/p&gt;

&lt;p&gt;I added some debug logging and found that the difference in bytes seen in the reproduction (255) was due to the following pieces of data being written:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;DEBUG [CompactionExecutor:3] 2014-07-13 00:38:42,891 ColumnIndex.java (line 168) DATASIZE writeOpenedMarker columnIndex: org.apache.cassandra.db.ColumnIndex$Builder@6678a9d0 firstColumn: [java.nio.HeapByteBuffer[pos=0 lim=34 cap=34], java.nio.HeapByteBuffer[pos=0 lim=34 cap=34]](deletedAt=1405237116014999, localDeletion=1405237116) startPosition: 262476 endPosition: 262561 diff: 85 
DEBUG [CompactionExecutor:3] 2014-07-13 00:38:43,007 ColumnIndex.java (line 168) DATASIZE writeOpenedMarker columnIndex: org.apache.cassandra.db.ColumnIndex$Builder@6678a9d0 firstColumn: org.apache.cassandra.db.Column@3e5b5939 startPosition: 328157 endPosition: 328242 diff: 85 
DEBUG [CompactionExecutor:3] 2014-07-13 00:38:44,159 ColumnIndex.java (line 168) DATASIZE writeOpenedMarker columnIndex: org.apache.cassandra.db.ColumnIndex$Builder@6678a9d0 firstColumn: org.apache.cassandra.db.Column@fc3299b startPosition: 984105 endPosition: 984190 diff: 85
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So looking at the code you can see that there are extra range tombstones written on the column index border (in ColumnIndex where tombstoneTracker.writeOpenedMarker is called) which aren&apos;t accounted for in LazilyCompactedRow.columnSerializedSize.&lt;/p&gt;

&lt;p&gt;This is where the difference comes from in the assertion error, so the solution is just to account for this data.&lt;br/&gt;
I have a patch which does just this, by keeping track of the extra data written out via tombstoneTracker.writeOpenedMarker in ColumnIndex and adding it back to the dataSize in LazilyCompactedRow.java, where it serialises out the row size.&lt;br/&gt;
After applying the patch the reproduction stops producing the AssertionError.&lt;/p&gt;

&lt;p&gt;I know this is not a problem in 2.0 + because of singe pass compaction, however there are lots of 1.2 clusters out there still which might run into this.&lt;br/&gt;
Please let me know if you&apos;ve any questions.&lt;/p&gt;

&lt;p&gt;Thanks,&lt;br/&gt;
Matt&lt;/p&gt;</description>
                <environment>&lt;p&gt;linux&lt;/p&gt;</environment>
        <key id="12727203">CASSANDRA-7543</key>
            <summary>Assertion error when compacting large row with map//list field or range tombstone</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="mbyrd">Matt Byrd</reporter>
                        <labels>
                            <label>compaction</label>
                            <label>map</label>
                    </labels>
                <created>Tue, 15 Jul 2014 00:09:55 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:40 +0000</updated>
                            <resolved>Wed, 16 Jul 2014 21:02:50 +0000</resolved>
                                        <fixVersion>1.2.19</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                                                                                <comments>
                            <comment id="14061463" author="mbyrd" created="Tue, 15 Jul 2014 00:11:28 +0000"  >&lt;p&gt;I believe this is the same issue, which wasn&apos;t fixed in 1.2.x, the recommendation being to move to 2.0 where the error was unlikely to occur.&lt;/p&gt;</comment>
                            <comment id="14062954" author="yukim" created="Wed, 16 Jul 2014 00:58:09 +0000"  >&lt;p&gt;Thanks for your finding.&lt;br/&gt;
Let me write simple Unit test case to verify.&lt;/p&gt;</comment>
                            <comment id="14064025" author="yukim" created="Wed, 16 Jul 2014 20:16:44 +0000"  >&lt;p&gt;(patches are against 1.2 brance)&lt;/p&gt;

&lt;p&gt;So I added test to LazilyCompactedRowTest to check size with RangeTombstone. Indeed, reported size is different from actual written size.&lt;/p&gt;

&lt;p&gt;Also attaching patch to fix.&lt;/p&gt;</comment>
                            <comment id="14064045" author="jbellis" created="Wed, 16 Jul 2014 20:35:06 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14064087" author="yukim" created="Wed, 16 Jul 2014 21:02:50 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                            <comment id="14064110" author="mbyrd" created="Wed, 16 Jul 2014 21:16:14 +0000"  >&lt;p&gt;Thanks for looking at this.&lt;br/&gt;
With the attached patch my repro script no longer reproduces the problem.&lt;br/&gt;
 It might also be nice to include the value of openedMarkerSize in the debug log line for the dataSize, if only to avoid confusion when debugging, however it&apos;s not strictly necessary.&lt;/p&gt;</comment>
                            <comment id="14127649" author="peter-librato" created="Tue, 9 Sep 2014 22:11:44 +0000"  >&lt;p&gt;This is listed in the 2.0 CHANGES.txt as present in 2.0.10 but &quot;Fix Versions&quot; shows only 1.2.19.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12703286">CASSANDRA-6918</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12656126" name="0001-add-rangetombstone-test.patch" size="5278" author="yukim" created="Wed, 16 Jul 2014 20:16:44 +0000"/>
                            <attachment id="12656127" name="0002-fix-rangetomebstone-not-included-in-LCR-size-calc.patch" size="3100" author="yukim" created="Wed, 16 Jul 2014 20:16:44 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>2.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405310</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 11 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1xr1r:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>405337</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12326174">1.2.16</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>