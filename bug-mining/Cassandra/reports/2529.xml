<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:42:02 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-6527] Random tombstones after adding a CF with sstableloader</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-6527</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;ve marked this bug as critical since it results in a data loss without any warnings.&lt;/p&gt;

&lt;p&gt;Here&apos;s the scenario:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;create a fresh one-node cluster with cassandra 1.2.11&lt;/li&gt;
	&lt;li&gt;add a sample row:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;CREATE KEYSPACE keyspace1 WITH replication = {&lt;span class=&quot;code-quote&quot;&gt;&apos;class&apos;&lt;/span&gt;:&lt;span class=&quot;code-quote&quot;&gt;&apos;SimpleStrategy&apos;&lt;/span&gt;, &lt;span class=&quot;code-quote&quot;&gt;&apos;replication_factor&apos;&lt;/span&gt;:1};
use keyspace1;
create table table1 (key text primary key, value1 text);
update table1 set value1 = &lt;span class=&quot;code-quote&quot;&gt;&apos;some-value&apos;&lt;/span&gt; where key = &lt;span class=&quot;code-quote&quot;&gt;&apos;some-key&apos;&lt;/span&gt;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;flush, drain, shutdown the cluster - you should have a single sstable:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;root@l1:~# ls /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/keyspace1/table1/
keyspace1-table1-ic-1-CompressionInfo.db  
keyspace1-table1-ic-1-Filter.db  
keyspace1-table1-ic-1-Statistics.db  
keyspace1-table1-ic-1-TOC.txt
keyspace1-table1-ic-1-Data.db             
keyspace1-table1-ic-1-Index.db   
keyspace1-table1-ic-1-Summary.db
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;with a perfectly correct content:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;root@l1:~# sstable2json /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/keyspace1/table1/keyspace1-table1-ic-1-Data.db
[
{&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;736f6d652d6b6579&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;columns&quot;&lt;/span&gt;: [[&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;,1387822268786000], [&quot;&lt;/span&gt;value1&lt;span class=&quot;code-quote&quot;&gt;&quot;,&quot;&lt;/span&gt;some-value&quot;,1387822268786000]]}
]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;create a new cluster with 2.0.3 (we&apos;ve used 3 nodes with replication=2, but I guess it doesn&apos;t matter)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;copy sstable from the machine in the old cluster to one of the machines in the new cluster (we do not want to use old sstableloader)&lt;/li&gt;
&lt;/ul&gt;


&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;load sstables with sstableloader:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;sstableloader -d 172.16.9.12 keyspace1/table1
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;analyze the content of newly loaded sstable:&lt;/li&gt;
&lt;/ul&gt;


&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;root@l13:~# sstable2json /&lt;span class=&quot;code-keyword&quot;&gt;var&lt;/span&gt;/lib/cassandra/data/keyspace1/table1/keyspace1-table1-jb-1-Data.db
[
{&lt;span class=&quot;code-quote&quot;&gt;&quot;key&quot;&lt;/span&gt;: &lt;span class=&quot;code-quote&quot;&gt;&quot;736f6d652d6b6579&quot;&lt;/span&gt;,&lt;span class=&quot;code-quote&quot;&gt;&quot;metadata&quot;&lt;/span&gt;: {&lt;span class=&quot;code-quote&quot;&gt;&quot;deletionInfo&quot;&lt;/span&gt;: {&lt;span class=&quot;code-quote&quot;&gt;&quot;markedForDeleteAt&quot;&lt;/span&gt;:294205259775,&lt;span class=&quot;code-quote&quot;&gt;&quot;localDeletionTime&quot;&lt;/span&gt;:0}},&lt;span class=&quot;code-quote&quot;&gt;&quot;columns&quot;&lt;/span&gt;: [[&lt;span class=&quot;code-quote&quot;&gt;&quot;&quot;,&quot;&lt;/span&gt;&lt;span class=&quot;code-quote&quot;&gt;&quot;,1387824835597000], [&quot;&lt;/span&gt;value1&lt;span class=&quot;code-quote&quot;&gt;&quot;,&quot;&lt;/span&gt;some-value&quot;,1387824835597000]]}
]
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There&apos;s a random tombstone inserted!&lt;/p&gt;

&lt;p&gt;We&apos;ve hit this bug in production. We never use delete for this column family, but the tombstones appeared for each row. The timestamp looks random. In our case it was mostly in past, but sometimes (about 3% rows) it was in the future. That&apos;s even worse than missing a row. In that case you cannot simply add it again - tombstone from the future will hide it.&lt;/p&gt;

&lt;p&gt;Fortunately, we have noticed that quickly and canceled the migration. However, we were quite lucky. There are no warnings or errors during the whole process. Losing less than 3% of data may be hard to noticed at first sight for many kind of apps.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12686418">CASSANDRA-6527</key>
            <summary>Random tombstones after adding a CF with sstableloader</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10000" iconUrl="https://issues.apache.org/jira/images/icons/priorities/critical.svg">Urgent</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="yukim">Yuki Morishita</assignee>
                                    <reporter username="br1985">Bart&#322;omiej Roma&#324;ski</reporter>
                        <labels>
                    </labels>
                <created>Thu, 26 Dec 2013 13:58:15 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:57 +0000</updated>
                            <resolved>Thu, 26 Dec 2013 22:01:34 +0000</resolved>
                                        <fixVersion>2.0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="13857014" author="yukim" created="Thu, 26 Dec 2013 19:17:58 +0000"  >&lt;p&gt;Confirmed.&lt;/p&gt;

&lt;p&gt;SSTable version &apos;ic&apos; has the following in partition header.&lt;/p&gt;

&lt;p&gt;Partition size: 8 bytes&lt;br/&gt;
Partition deletion time: 4 bytes + 8 bytes&lt;br/&gt;
Cell count: 4 bytes&lt;/p&gt;

&lt;p&gt;When streaming &apos;ic&apos; to 2.0, it is reading 4 bytes + 8 bytes for deletion time. Then, partition size and cell count are not needed above 2.0, so it skips those 8 bytes and 4 bytes.&lt;br/&gt;
It should be 1) skip partition size (8 bytes), 2) read deletion time, then 3) skip cell count (4 bytes).&lt;/p&gt;</comment>
                            <comment id="13857080" author="yukim" created="Thu, 26 Dec 2013 21:16:59 +0000"  >&lt;p&gt;(also: &lt;a href=&quot;https://github.com/yukim/cassandra/commits/6527&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/yukim/cassandra/commits/6527&lt;/a&gt;)&lt;/p&gt;

&lt;p&gt;Patch as well as test case attached.&lt;/p&gt;</comment>
                            <comment id="13857082" author="yukim" created="Thu, 26 Dec 2013 21:18:20 +0000"  >&lt;p&gt;Note that this only happens when streaming &quot;ic&quot; version of SSTable.&lt;/p&gt;</comment>
                            <comment id="13857088" author="jbellis" created="Thu, 26 Dec 2013 21:25:44 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13857115" author="yukim" created="Thu, 26 Dec 2013 22:01:34 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12620552" name="6527-2.0.txt" size="4530" author="yukim" created="Thu, 26 Dec 2013 21:16:59 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[yukim]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>365407</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            11 years, 47 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1qzef:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>365709</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12325322">2.0.3</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12963"><![CDATA[Critical]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12322954">2.0 beta 1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>