<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:10:53 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-182] CommitLog.add doesn&apos;t really force to disk</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-182</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;CommitLog.add does&apos;t really force writes to disk. This could result in acked writes being lost.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12425601">CASSANDRA-182</key>
            <summary>CommitLog.add doesn&apos;t really force to disk</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="sandeep_tata">Sandeep Tata</reporter>
                        <labels>
                    </labels>
                <created>Fri, 15 May 2009 16:17:12 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:37 +0000</updated>
                            <resolved>Tue, 28 Jul 2009 02:45:40 +0000</resolved>
                                        <fixVersion>0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12709902" author="sandeep_tata" created="Fri, 15 May 2009 16:41:07 +0000"  >&lt;p&gt;1. Added a class in SequenceFile called SyncWriter&lt;br/&gt;
2. New configuration option CommitLogForceLogs if you want &quot;safe&quot; writes. Not turning this on leaves everything else the same as before. All this does is use SyncWriter for the logger.&lt;/p&gt;

&lt;p&gt;For trunk and 0.4 we should revisit the options we want to allow on the logs, especially once we re-architect the logger to use batched forces.&lt;/p&gt;</comment>
                            <comment id="12709914" author="jbellis" created="Fri, 15 May 2009 17:22:30 +0000"  >&lt;p&gt;The more I look at the commitlog code the more I&apos;m inclined to go with my initial reaction, that we shouldn&apos;t mess with this for 0.3... :-|&lt;/p&gt;

&lt;p&gt;The FastSync option looks like A&amp;amp;P&apos;s attempt to deal with this.  It does call force() on close, for instance.  (Is that really all we need for durability?)  Having two options for syncing, one of which is commented to have issues and the other is virtually entirely untested, doesn&apos;t really seem like an improvement to me.&lt;/p&gt;

&lt;p&gt;If we did go with &quot;let&apos;s add a third option&quot; then IMO we should be doing the force in CommitLog not the writer.  updateHeader for instance does a looping write w/ a single writer; i assume only one sync for the entire method is needed, not one sync per write.&lt;/p&gt;

&lt;p&gt;For 0.3 I suggest emailing A&amp;amp;P off-list and see if they can clarify why fastsync has problems purging log files.  If it is something simple to fix great.  Otherwise let&apos;s note to &quot;use fastsync for durable writes, but this has the drawback of not purging log files.  fixing this is a priority for 0.4&quot;&lt;/p&gt;</comment>
                            <comment id="12709929" author="sandeep_tata" created="Fri, 15 May 2009 18:38:08 +0000"  >&lt;p&gt;FastSync (inappropriately named, IMHO) option tells the CommitLog to use a FastConcurrentWriter. This certainly doesn&apos;t force to disk, and therefore is not an option for durable writes.&lt;/p&gt;

&lt;p&gt;If we don&apos;t add a third option for 0.3 which forces to disk, we simply have &lt;b&gt;no&lt;/b&gt; durable writes. Even on blocking writes, it is possible that the data has not hit disk in any of the replica&apos;s logs.&lt;/p&gt;

&lt;p&gt;We have two options:&lt;br/&gt;
1. Release as is, and say &quot;we don&apos;t offer durable writes yet&quot;&lt;br/&gt;
2. Add an option to force the logs and say &quot;this is currently a low-performing option and will be improved for 0.4&quot;&lt;/p&gt;

&lt;p&gt;We can do the forces in CommitLog (probably a cleaner approach in terms of eliminating unnecessary forces, but updateHeader writes only for CFs encountered for the first time).  The approach in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-182&quot; title=&quot;CommitLog.add doesn&amp;#39;t really force to disk&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-182&quot;&gt;&lt;del&gt;CASSANDRA-182&lt;/del&gt;&lt;/a&gt;.patch seemed minimally invasive to me &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Building a well-tested high-performance logger will take significantly more time. (Just testing the logger for correctness is non-trivial.)&lt;/p&gt;</comment>
                            <comment id="12709932" author="jbellis" created="Fri, 15 May 2009 19:02:26 +0000"  >&lt;p&gt;FCW does force on close, leading me to believe that for whatever reason A&amp;amp;P felt that was all that was needed to call the option &quot;Sync.&quot;&lt;/p&gt;

&lt;p&gt;Of course I could be reading too much into this.  Always a possibility in &quot;code archaeology.&quot; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="12711775" author="jbellis" created="Thu, 21 May 2009 19:54:03 +0000"  >&lt;p&gt;Assuming we don&apos;t hear back from Avinash &amp;amp; Prashant, I suggest that we include a &quot;known issues&quot; section in the README for 0.3 noting this problem.  I&apos;m not comfortable with basing the CL on brand-new code.&lt;/p&gt;

&lt;p&gt;For 0.4 let&apos;s take a closer look at FastSync and either build on that or rip it out and go with the approach in your patch (either in CL or the writer).  I&apos;d like to see this coupled with a CL executor that force()s less than once per mutation if there is a constant stream of writes, similar to postgresql&apos;s commit_delay setting (&lt;a href=&quot;http://www.postgresql.org/docs/8.3/static/runtime-config-wal.html&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://www.postgresql.org/docs/8.3/static/runtime-config-wal.html&lt;/a&gt;).&lt;/p&gt;</comment>
                            <comment id="12712124" author="sandeep_tata" created="Fri, 22 May 2009 14:53:20 +0000"  >&lt;p&gt;I haven&apos;t heard back from A&amp;amp;P.&lt;br/&gt;
I&apos;m fine with releasing as is and saying logging doesn&apos;t work correctly yet and that it&apos;ll be fixed soon.&lt;/p&gt;</comment>
                            <comment id="12712125" author="sandeep_tata" created="Fri, 22 May 2009 14:54:00 +0000"  >&lt;p&gt;Won&apos;t fix in 0.3&lt;/p&gt;</comment>
                            <comment id="12733871" author="jbellis" created="Tue, 21 Jul 2009 22:39:06 +0000"  >&lt;p&gt;Are you working on this, Sandeep?  If not I will take it.&lt;/p&gt;</comment>
                            <comment id="12733886" author="sandeep_tata" created="Tue, 21 Jul 2009 23:16:47 +0000"  >&lt;p&gt;Nope, I&apos;m not looking at this right now. &lt;/p&gt;</comment>
                            <comment id="12733935" author="jbellis" created="Wed, 22 Jul 2009 01:15:29 +0000"  >&lt;p&gt;confirmed that naive fsync-per-write kills performance &amp;#8211; i&apos;m seeing 1/10 the throughput.&lt;/p&gt;

&lt;p&gt;will try the executor approach I mentioned above.&lt;/p&gt;</comment>
                            <comment id="12733998" author="sandeep_tata" created="Wed, 22 Jul 2009 06:01:56 +0000"  >&lt;p&gt;I did figure how to avoid using force(true) to flush the metadata in addition to the data (2 disk forces instead of one). If you preallocate the pages for the log file, you need to force(true) only when you have to grab more pages for the log. This would of course require some extra work in the logger code so the end of the log can be tracked without depending on file size/end of file.&lt;/p&gt;</comment>
                            <comment id="12734137" author="jbellis" created="Wed, 22 Jul 2009 14:49:07 +0000"  >&lt;p&gt;the executor approach is looking really good, but that&apos;s worth keeping in mind down the road.&lt;/p&gt;</comment>
                            <comment id="12735243" author="jbellis" created="Sat, 25 Jul 2009 05:35:09 +0000"  >&lt;p&gt;07&lt;br/&gt;
    switch to arrayblockingqueue; it&apos;s a little cleaner and performance seems unaffected&lt;/p&gt;

&lt;p&gt;06&lt;br/&gt;
    config options.  increasing write threads to 32 (was 4) allows performance to be mostly decent again, especially if you crank the delay up to 10ms&lt;/p&gt;

&lt;p&gt;05&lt;br/&gt;
    custom CommitLogExecutorService that can fsync per multiple CL additions&lt;/p&gt;

&lt;p&gt;04&lt;br/&gt;
    threadpoolexecutor, just using an out-of-the-box executor as a first step&lt;/p&gt;

&lt;p&gt;03&lt;br/&gt;
    naive fsync-after-each-log-entry.  performance &lt;em&gt;sucks.&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;02&lt;br/&gt;
    mv AbstractWriter to its own top-level class and remove redundant IFileWriter&lt;/p&gt;

&lt;p&gt;01&lt;br/&gt;
    handle incomplete CL entries on recover (a fairly important bug fix)&lt;/p&gt;</comment>
                            <comment id="12735631" author="jbellis" created="Mon, 27 Jul 2009 15:45:33 +0000"  >&lt;p&gt;removed old patches, attached rebased ones&lt;/p&gt;</comment>
                            <comment id="12735822" author="junrao" created="Mon, 27 Jul 2009 22:41:57 +0000"  >&lt;p&gt;The patch looks good to me. Thanks, Jonathan.&lt;/p&gt;</comment>
                            <comment id="12735895" author="jbellis" created="Tue, 28 Jul 2009 02:45:40 +0000"  >&lt;p&gt;committed&lt;/p&gt;</comment>
                            <comment id="12736065" author="hudson" created="Tue, 28 Jul 2009 13:29:27 +0000"  >&lt;p&gt;Integrated in Cassandra #151 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/151/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/151/&lt;/a&gt;)&lt;br/&gt;
    Use arrayblockingqueue in commitlog executor; this cleans up the code a bit (performance is unaffected since the writes and syncs are far more expensive than any queue ops)&lt;br/&gt;
patch by jbellis; reviewed by Jun Rao for &lt;br/&gt;
add config options for commitlog syncing&lt;br/&gt;
patch by jbellis; reviewed by Jun Rao for &lt;br/&gt;
custom CommitLogExecutorService that can fsync per multiple CL additions&lt;br/&gt;
patch by jbellis; reviewed by Jun Rao for &lt;br/&gt;
move log ops to callables on a threadpoolexecutor instead of synchronizing.  this prepares the way to merge multiple add() calls into a single sync.&lt;br/&gt;
patch by jbellis; reviewed by Jun Rao for &lt;br/&gt;
naive fsync-after-each-log-entry&lt;br/&gt;
patch by jbellis; reviewed by Jun Rao for &lt;br/&gt;
mv AbstractWriter to its own top-level class and remove redundant IFileWriter&lt;br/&gt;
patch by jbellis; reviewed by Jun Rao for &lt;br/&gt;
handle incomplete CL entries on recover&lt;br/&gt;
patch by jbellis; reviewed by Jun Rao for &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12414626" name="ASF.LICENSE.NOT.GRANTED--0001-CASSANDRA-182-handle-incomplete-CL-entries-on-recover.txt" size="1400" author="jbellis" created="Mon, 27 Jul 2009 15:45:17 +0000"/>
                            <attachment id="12414627" name="ASF.LICENSE.NOT.GRANTED--0002-mv-AbstractWriter-to-its-own-top-level-class-and-remov.txt" size="25527" author="jbellis" created="Mon, 27 Jul 2009 15:45:17 +0000"/>
                            <attachment id="12414628" name="ASF.LICENSE.NOT.GRANTED--0003-naive-fsync-after-each-log-entry.txt" size="3291" author="jbellis" created="Mon, 27 Jul 2009 15:45:17 +0000"/>
                            <attachment id="12414629" name="ASF.LICENSE.NOT.GRANTED--0004-threadpoolexecutor.txt" size="7413" author="jbellis" created="Mon, 27 Jul 2009 15:45:17 +0000"/>
                            <attachment id="12414630" name="ASF.LICENSE.NOT.GRANTED--0005-custom-CommitLogExecutorService-that-can-fsync-per-mul.txt" size="8339" author="jbellis" created="Mon, 27 Jul 2009 15:45:17 +0000"/>
                            <attachment id="12414631" name="ASF.LICENSE.NOT.GRANTED--0006-config-options.txt" size="12895" author="jbellis" created="Mon, 27 Jul 2009 15:45:17 +0000"/>
                            <attachment id="12414632" name="ASF.LICENSE.NOT.GRANTED--0007-arrayblockingqueue.txt" size="7477" author="jbellis" created="Mon, 27 Jul 2009 15:45:17 +0000"/>
                            <attachment id="12414633" name="ASF.LICENSE.NOT.GRANTED--0008-updates.txt" size="1896" author="jbellis" created="Mon, 27 Jul 2009 15:45:17 +0000"/>
                            <attachment id="12408264" name="CASSANDRA-182.patch" size="5201" author="sandeep_tata" created="Fri, 15 May 2009 16:41:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19586</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 18 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fxdb:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91004</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>