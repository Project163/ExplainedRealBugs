<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:19:43 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15892] JAVA 8/11: test_resumable_rebuild - rebuild_test.TestRebuild</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15892</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;JAVA 11:&lt;/p&gt;

&lt;p&gt;test_resumable_rebuild - rebuild_test.TestRebuild&lt;/p&gt;

&lt;p&gt;Fails locally and in &#160;&lt;/p&gt;

&lt;p&gt;[CircleCI |&#160;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/222/workflows/11202c7e-6c94-4d4e-bbbf-9e2fa9791ad0/jobs/1338&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/222/workflows/11202c7e-6c94-4d4e-bbbf-9e2fa9791ad0/jobs/1338&lt;/a&gt;]&lt;/p&gt;</description>
                <environment></environment>
        <key id="13312950">CASSANDRA-15892</key>
            <summary>JAVA 8/11: test_resumable_rebuild - rebuild_test.TestRebuild</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="gianluca">Gianluca Righetto</assignee>
                                    <reporter username="edimitrova">Ekaterina Dimitrova</reporter>
                        <labels>
                    </labels>
                <created>Tue, 23 Jun 2020 02:55:58 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:46 +0000</updated>
                            <resolved>Fri, 26 Mar 2021 08:43:52 +0000</resolved>
                                        <fixVersion>4.0-rc1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Test/dtest/python</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>8</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="1800">0.5h</timespent>
                                <comments>
                            <comment id="17146119" author="bereng" created="Fri, 26 Jun 2020 08:17:21 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; This test doesn&apos;t seem to fail on the latest ci-cassandra runs, also I did run it locally both under j8 and j11 and it passes.&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;(dtests) bereng@dxpc:~/work/repos/bdpWS/dtests$ pytest --cassandra-dir=/tmp/test rebuild_test.py::TestRebuild::test_resumable_rebuild
=============================================================================================================================== test session starts ===============================================================================================================================
platform linux -- Python 3.6.9, pytest-3.6.4, py-1.8.1, pluggy-0.7.1
rootdir: /home/bereng/work/repos/bdpWS/dtests, inifile: pytest.ini
plugins: timeout-1.3.4, flaky-3.6.1
timeout: 900.0s
timeout method: signal
timeout func_only: False
collected 1 item                                                                                                                                                                                                                                                                  

rebuild_test.py .                                                                                                                                                                                                                                                           [100%]
===Flaky Test Report===

test_resumable_rebuild passed 1 out of the required 1 times. Success!

===End Flaky Test Report===

============================================================================================================================ 1 passed in 70.18 seconds ============================================================================================================================
(dtests) bereng@dxpc:~/work/repos/bdpWS/dtests$ java -version
openjdk version &quot;11.0.7&quot; 2020-04-14
OpenJDK Runtime Environment (build 11.0.7+10-post-Ubuntu-2ubuntu218.04)
OpenJDK 64-Bit Server VM (build 11.0.7+10-post-Ubuntu-2ubuntu218.04, mixed mode, sharing)

&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Can you confirm this is the case for you as well? maybe sthg got fixed in the last few days&lt;/p&gt;</comment>
                            <comment id="17147662" author="bereng" created="Mon, 29 Jun 2020 09:49:00 +0000"  >&lt;p&gt;Impossible to repro. Suggestion to close until we can.&lt;/p&gt;</comment>
                            <comment id="17149368" author="gianluca" created="Wed, 1 Jul 2020 12:00:54 +0000"  >&lt;p&gt;I can reproduce this locally, assigning to myself for further investigation.&lt;/p&gt;</comment>
                            <comment id="17149399" author="bereng" created="Wed, 1 Jul 2020 12:31:12 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt; did you do anything special to manage to repro?&lt;/p&gt;</comment>
                            <comment id="17149441" author="gianluca" created="Wed, 1 Jul 2020 13:34:32 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;Bereng&lt;/a&gt; No, it fails right away.&lt;/p&gt;</comment>
                            <comment id="17149444" author="edimitrova" created="Wed, 1 Jul 2020 13:37:12 +0000"  >&lt;p&gt;Sometimes some are reproduced on the Mac, sometimes only in the ubuntu vm...&lt;/p&gt;

&lt;p&gt;They do not always fail for everyone &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/sad.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;Happened already to me a couple of times to play around until I manage to reproduce different failures.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt; and &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;Bereng&lt;/a&gt; . I will try to look today the other two, at least to ensure whether they are software defects or test failures.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17149517" author="bereng" created="Wed, 1 Jul 2020 15:30:59 +0000"  >&lt;p&gt;Ah you see... OSS C* should run all tests in my laptop then all things would be great &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17201075" author="maedhroz" created="Wed, 23 Sep 2020 20:27:55 +0000"  >&lt;p&gt;Saw this today in &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/120/workflows/03a81457-1d8a-47a2-a169-779a346053dc/jobs/653&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/maedhroz/cassandra/120/workflows/03a81457-1d8a-47a2-a169-779a346053dc/jobs/653&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17209154" author="dcapwell" created="Tue, 6 Oct 2020 20:41:43 +0000"  >&lt;p&gt;saw this today &lt;a href=&quot;https://app.circleci.com/pipelines/github/dcapwell/cassandra/622/workflows/adcd463c-156a-43c7-a9bc-7f3e4938dbe8/jobs/3514&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/dcapwell/cassandra/622/workflows/adcd463c-156a-43c7-a9bc-7f3e4938dbe8/jobs/3514&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17269698" author="edimitrova" created="Thu, 21 Jan 2021 23:32:08 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt;, I was wondering whether you are still working on this one?&lt;/p&gt;

&lt;p&gt;Also, I haven&apos;t actually seen this one failing lately in CircleCI? &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;Bereng&lt;/a&gt;, have you seen it by chance?&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;Maybe &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt;&#160;will surprise us in a nice way by saying he can&apos;t reproduce it on the latest trunk? &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17269756" author="gianluca" created="Fri, 22 Jan 2021 01:45:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; I did some initial investigation to narrow the problem down, but I got sidetracked with some QA work on k8s and couldn&apos;t come up with a patch for this yet. But I just started looking into it again.&lt;/p&gt;

&lt;p&gt;So, I just rebased with latest trunk and I can still reproduce it locally. I think it just doesn&apos;t fail more often on CI because the test has a @flaky annotation, so it gives another chance for the test to pass.&lt;br/&gt;
The behavior I&apos;m seeing is that one of the nodes keeps waiting for a message that never arrives and it will simply sit idle for as long as I let it (I think in CI it times out and reruns).&lt;/p&gt;</comment>
                            <comment id="17269759" author="edimitrova" created="Fri, 22 Jan 2021 01:54:33 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt;&#160;thank you for the quick response and looking into it!&lt;/p&gt;

&lt;p&gt;That is an important point, I didn&apos;t know it was already marked @flaky. Then I can check tomorrow who and why added this and whether this means we can leave it for now. It&apos;s good to know the history. Thanks again&lt;/p&gt;</comment>
                            <comment id="17269760" author="gianluca" created="Fri, 22 Jan 2021 02:02:58 +0000"  >&lt;p&gt;I believe it was added here &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/49b2dda4e6643d2b18376d504b5fea4c0b3354a7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/commit/49b2dda4e6643d2b18376d504b5fea4c0b3354a7&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17270314" author="edimitrova" created="Fri, 22 Jan 2021 17:36:50 +0000"  >&lt;p&gt;Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt;, I checked that ticket and it looks like the only reason to add @flaky as part of &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14134&quot; title=&quot;Migrate dtests to use pytest and python3&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14134&quot;&gt;&lt;del&gt;CASSANDRA-14134&lt;/del&gt;&lt;/a&gt; was to prevent from distractions while working on the pytest migration. So it looks like the ticket and the issue is legit&lt;/p&gt;

&lt;p&gt;On the other hand, maybe(I haven&apos;t tested it yet) the rest of us might be able to reproduce the problem if the annotation is removed.&#160;&lt;/p&gt;</comment>
                            <comment id="17305935" author="gianluca" created="Mon, 22 Mar 2021 07:09:59 +0000"  >&lt;p&gt;I did some more investigation recently and got to the bottom of this issue and this is actually a runtime problem, not simply a flaky test. I have a patch available, but I&apos;ll try to break it down below in a way that makes it easier to understand what&apos;s going on:&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Dtest&lt;/b&gt;:&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;The dtest is designed to initially write data to only 2 nodes, then a third node is started and &lt;em&gt;nodetool rebuild&lt;/em&gt; is invoked, so the sstables start to be streamed to node 3.&lt;/li&gt;
	&lt;li&gt;The goal of the test is to make sure the rebuild process is able to continue later, in case the first attempt fails for whatever reason.&lt;/li&gt;
	&lt;li&gt;To simulate a failure, byteman is used on node 3 to throw an exception (only once) when it receives a message from node 2.&lt;/li&gt;
	&lt;li&gt;That will make node 2 receive a Stream Failed message back. If that message is processed and the event-loop thread tries to close the network channel while the writer thread is Parked waiting for the stream to complete, there will be a deadlock.&lt;/li&gt;
	&lt;li&gt;The second time &lt;em&gt;nodetool rebuild&lt;/em&gt; command is invoked by the dtest, node 2 will be in deadlock already, so the test will remain on-hold indefinitely (eventually time out on Jenkins).&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;b&gt;Reproduction steps&lt;/b&gt;:&lt;/p&gt;

&lt;p&gt;In your IDE, set a couple of breakpoints at the following lines, then attach the debugger to the process of node 2 and make sure the first method below (&lt;em&gt;StreamSession#closeSession&lt;/em&gt;) is executed before the line of the second breakpoint.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/4d49308a3fbc354850126a5ec128b11a3aca4007/src/java/org/apache/cassandra/streaming/StreamSession.java#L485&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/4d49308a3fbc354850126a5ec128b11a3aca4007/src/java/org/apache/cassandra/streaming/StreamSession.java#L485&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/4d49308a3fbc354850126a5ec128b11a3aca4007/src/java/org/apache/cassandra/net/AsyncStreamingOutputPlus.java#L91&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/4d49308a3fbc354850126a5ec128b11a3aca4007/src/java/org/apache/cassandra/net/AsyncStreamingOutputPlus.java#L91&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Patch&lt;/b&gt;:&lt;/p&gt;

&lt;p&gt;The patch simply handles the channel&apos;s &lt;em&gt;closeFuture&lt;/em&gt; callback asynchronously, that allows for the channel to be fully closed and then the &lt;a href=&quot;https://github.com/apache/cassandra/blob/4d49308a3fbc354850126a5ec128b11a3aca4007/src/java/org/apache/cassandra/net/AsyncChannelOutputPlus.java#L100&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;error handler&lt;/a&gt; in &lt;em&gt;AsyncChannelOutputPlus&lt;/em&gt; is executed to clean things up and Unpark the thread, so no deadlock occurs.&lt;/p&gt;

&lt;p&gt;C* patch: &lt;a href=&quot;https://github.com/grighetto/cassandra/pull/3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grighetto/cassandra/pull/3&lt;/a&gt;&lt;br/&gt;
 Dtest patch: &lt;a href=&quot;https://github.com/apache/cassandra-dtest/pull/130&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/pull/130&lt;/a&gt; (remove @flaky annotation and add ignore-log pattern)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;CircleCI Results&lt;/b&gt;:&lt;/p&gt;

&lt;p&gt;JVM 11 Dtests: &lt;a href=&quot;https://app.circleci.com/pipelines/github/grighetto/cassandra/32/workflows/77ef945f-8cf9-4c8b-84c6-13bc48078275/jobs/198&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/grighetto/cassandra/32/workflows/77ef945f-8cf9-4c8b-84c6-13bc48078275/jobs/198&lt;/a&gt;&lt;br/&gt;
 JVM 8 Dtests: &lt;a href=&quot;https://app.circleci.com/pipelines/github/grighetto/cassandra/32/workflows/dfc132e9-e4c4-4ea5-bc8e-d56e73679bcf/jobs/189&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/grighetto/cassandra/32/workflows/dfc132e9-e4c4-4ea5-bc8e-d56e73679bcf/jobs/189&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17305936" author="gianluca" created="Mon, 22 Mar 2021 07:10:46 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=e.dimitrova&quot; class=&quot;user-hover&quot; rel=&quot;e.dimitrova&quot;&gt;e.dimitrova&lt;/a&gt; Would you be able to try the reproduction steps I shared above and review the patch?&lt;/p&gt;</comment>
                            <comment id="17307353" author="michaelsembwever" created="Tue, 23 Mar 2021 18:52:38 +0000"  >&lt;p&gt;Looks related to Zhao and Benjamin&apos;s &lt;a href=&quot;https://github.com/grighetto/cassandra/commit/9f6fcc340d89eecc000765f6ab93e862f53a02d9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;commit&lt;/a&gt; around closing connections in Apr 2020. &lt;/p&gt;

&lt;p&gt;Failures do exist on ci-cassandra.a.o too, though not many&#8230;&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;a href=&quot;https://nightlies.apache.org/cassandra/ci-cassandra.apache.org/job/Cassandra-trunk/338/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Cassandra-trunk #338&lt;/a&gt; &lt;br class=&quot;atl-forced-newline&quot; /&gt;  &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13022857/13022857_Screenshot+2021-03-23+at+19.37.35.png&quot; width=&quot;300&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://nightlies.apache.org/cassandra/ci-cassandra.apache.org/job/Cassandra-trunk/105/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Cassandra-trunk #105&lt;/a&gt; &lt;br class=&quot;atl-forced-newline&quot; /&gt;  &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13022858/13022858_Screenshot+2021-03-23+at+19.53.51.png&quot; width=&quot;300&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17307645" author="jasonstack" created="Wed, 24 Mar 2021 08:22:51 +0000"  >&lt;blockquote&gt;&lt;p&gt;That will make node 2 receive a Stream Failed message back. If that message is processed and the event-loop thread tries to close the network channel while the writer thread is Parked waiting for the stream to complete, there will be a deadlock.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=gianluca&quot; class=&quot;user-hover&quot; rel=&quot;gianluca&quot;&gt;gianluca&lt;/a&gt; thanks for the fix. can you explain a bit more here? node2 receives &lt;tt&gt;SESSION_FAILED&lt;/tt&gt; and then closes its channels. how does &lt;tt&gt;&quot;writer thread&quot;&lt;/tt&gt; get blocked?  I can&apos;t think of why &lt;tt&gt;messageSender.close()&lt;/tt&gt; causes  blocking..&lt;/p&gt;</comment>
                            <comment id="17308415" author="gianluca" created="Thu, 25 Mar 2021 06:32:29 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt; I attached a thread dump to this ticket which should make things more clear, but this is the sequence of events:&lt;/p&gt;

&lt;p&gt;Node 2 runs &lt;tt&gt;AsyncChannelOutputPlus#flush -&amp;gt; AsyncStreamingOutputPlus#doFlush&lt;/tt&gt; which contains the following&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
        ChannelPromise promise = beginFlush(byteCount, 0, &lt;span class=&quot;code-object&quot;&gt;Integer&lt;/span&gt;.MAX_VALUE);
        channel.writeAndFlush(GlobalBufferPoolAllocator.wrap(flush), promise);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;That promise is responsible for unparking the thread in a later moment (it&apos;s supposed to be called when the flush either completes or fails).&lt;br/&gt;
Still in &lt;tt&gt;AsyncChannelOutputPlus#flush&lt;/tt&gt;, it calls &lt;tt&gt;waitUntilFlushed(0, 0)&lt;/tt&gt; and at this point the thread is parked.&lt;/p&gt;

&lt;p&gt;Now it receives a SESSION_FAILED message, so it will try to close the channel, but the problem is that the channel has a close listener that relies on a synchronized method, &lt;tt&gt;StreamSession#onChannelClose&lt;/tt&gt;, and since that thread is parked, it blocks. In other words, netty can&apos;t properly close the channel and the flush promise above is never called, so the thread is never unparked, hence the deadlock.&lt;/p&gt;</comment>
                            <comment id="17308450" author="jasonstack" created="Thu, 25 Mar 2021 07:34:49 +0000"  >&lt;p&gt;thanks for the explanation. the thread dump really helps. The fix looks good to me. Alternatively, we can remove the &lt;tt&gt;synchronized&lt;/tt&gt; from &lt;tt&gt;StreamSession#onChannelClose&lt;/tt&gt; as it doesn&apos;t have to be synchronized.&lt;/p&gt;</comment>
                            <comment id="17309229" author="gianluca" created="Fri, 26 Mar 2021 07:19:15 +0000"  >&lt;p&gt;Thanks for the review, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jasonstack&quot; class=&quot;user-hover&quot; rel=&quot;jasonstack&quot;&gt;jasonstack&lt;/a&gt;.&lt;br/&gt;
Here&apos;s a new patch simply with the &lt;tt&gt;synchronized&lt;/tt&gt; modifier removed: &lt;a href=&quot;https://github.com/grighetto/cassandra/pull/4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grighetto/cassandra/pull/4&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Patches&lt;/b&gt;&lt;br/&gt;
C* patch: &lt;a href=&quot;https://github.com/grighetto/cassandra/pull/4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grighetto/cassandra/pull/4&lt;/a&gt;&lt;br/&gt;
 Dtest patch: &lt;a href=&quot;https://github.com/apache/cassandra-dtest/pull/130&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/pull/130&lt;/a&gt; (removes @flaky annotation and adds ignore-log pattern)&lt;/p&gt;

&lt;p&gt;&lt;b&gt;Circle CI Results&lt;/b&gt;&lt;br/&gt;
Java 11: &lt;a href=&quot;https://app.circleci.com/pipelines/github/grighetto/cassandra/36/workflows/ae5ab000-e548-4548-a728-bfc525da7b20&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/grighetto/cassandra/36/workflows/ae5ab000-e548-4548-a728-bfc525da7b20&lt;/a&gt;&lt;br/&gt;
Java 8: &lt;a href=&quot;https://app.circleci.com/pipelines/github/grighetto/cassandra/36/workflows/beb0f334-8adf-49a4-b612-51f68e4dc462&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/grighetto/cassandra/36/workflows/beb0f334-8adf-49a4-b612-51f68e4dc462&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17309261" author="michaelsembwever" created="Fri, 26 Mar 2021 08:33:23 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17309265" author="michaelsembwever" created="Fri, 26 Mar 2021 08:40:33 +0000"  >&lt;p&gt;Committed &lt;a href=&quot;https://github.com/apache/cassandra/commit/dc5337bf956ae26447cb8d1ca897512c969f5172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dc5337bf956ae26447cb8d1ca897512c969f5172&lt;/a&gt; and &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/a4186ad83ec1c42c8b0086865f6da80408f9ece4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a4186ad83ec1c42c8b0086865f6da80408f9ece4&lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="13022752" name="CASSANDRA-15892-07babf3c-node2-deadlock-thread-dump.txt" size="90811" author="gianluca" created="Mon, 22 Mar 2021 07:36:28 +0000"/>
                            <attachment id="13022857" name="Screenshot 2021-03-23 at 19.37.35.png" size="596537" author="mck" created="Tue, 23 Mar 2021 18:37:43 +0000"/>
                            <attachment id="13022858" name="Screenshot 2021-03-23 at 19.53.51.png" size="594349" author="mck" created="Tue, 23 Mar 2021 18:53:55 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[gianluca]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            4 years, 33 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0g3wg:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[e.dimitrova]]></customfieldvalue>
        <customfieldvalue><![CDATA[mck]]></customfieldvalue>
        <customfieldvalue><![CDATA[jasonstack]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348284">4.0-alpha4</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/dc5337bf956ae26447cb8d1ca897512c969f5172&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/dc5337bf956ae26447cb8d1ca897512c969f5172&lt;/a&gt; &lt;a href=&quot;https://github.com/apache/cassandra-dtest/commit/a4186ad83ec1c42c8b0086865f6da80408f9ece4&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/commit/a4186ad83ec1c42c8b0086865f6da80408f9ece4&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Reproduction steps added to the comments.&lt;/p&gt;

&lt;p&gt;Patches available: &lt;br/&gt;
&lt;a href=&quot;https://github.com/grighetto/cassandra/pull/3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/grighetto/cassandra/pull/3&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://github.com/apache/cassandra-dtest/pull/130&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra-dtest/pull/130&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>