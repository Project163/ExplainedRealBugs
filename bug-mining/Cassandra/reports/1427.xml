<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:29:05 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-3839] BulkOutputFormat binds to wrong client address when client is Dual-stack and server is IPv6</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-3839</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Trying to run a map/reduce job with BulkOutputFormat, in an environment where the Hadoop nodes have Dual-stack (IPv4+IPv6) and the Cassandra servers are IPv6-only, it seems like the TCP connection setup for streaming is explicitly setting the source address to the IPv4 address of the Hadoop node, even though the destination address is IPv6. &lt;/p&gt;

&lt;p&gt;I&apos;m seeing connection attempts where source address is an IPv4-represented-in-IPv6 address and destination is IPv6 of cassandra node. &lt;/p&gt;

&lt;p&gt;In the log output from the Hadoop M/R job, I see:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;2012-02-01 16:49:19,909 WARN org.apache.cassandra.streaming.FileStreamTask: Failed attempt 1 to connect to /2001:4c28:a030:30:72f3:95ff:fe02:2936 to stream /var/lib/hadoop/mapred/local/taskTracker/forsberg/jobcache/job_201201120812_0204/attempt_201201120812_0204_m_000000_0/test/Histograms/test-Histograms-hc-1-Data.db sections=1 progress=0/749048 - 0%. Retrying in 4000 ms. (java.net.ConnectException: Connection timed out)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;So, digging a bit down the code, I see that org.apache.cassandra.hadoop.BulkRecordWriter successfully creates a Thrift connection to my Cassandra cluster, over IPv6. It successfully retrieves tokenrange information.&lt;/p&gt;

&lt;p&gt;Later on, in org.apache.cassandra.streaming.FileStreamTask, it fails to connect to the destination cassandra node. It seems to me that the problem is that org.apache.cassandra.net.OutboundTcpConnectionPool is asking FBUtilities.getLocalAddress for the address to bind to, and getLocalAddress is returning an IPv4 address when DatabaseDescriptor has not been initialized. And DatabaseDescriptor has not been initialized, becase in BulkOutputFormat we&apos;re not reading cassandra.yaml. &lt;/p&gt;

&lt;p&gt;I actually have a workaround for this which involves not applying patch that removes need to read cassandra.yaml, then point to a cassandra.yaml generated specifically for the purpose on each hadoop node, with listen_address set to the IPv6 address of the node. &lt;/p&gt;

&lt;p&gt;This is with net.ipv6.bindv6only=0 in Linux sysctl - something you must have for Hadoop to run. &lt;/p&gt;

&lt;p&gt;Also tried -D mapred.child.java.opts=&quot;-Djava.net.preferIPv4Stack=false -Djava.net.preferIPv6Addresses=true&quot;, i.e. setting properties to prefer IPv6 stack to M/R job, but didn&apos;t help.&lt;/p&gt;

&lt;p&gt;In this case, we would probably be better of not explicitly binding to any address - the OS would do that for us. I understand binding explicitly makes sense when this code is running inside Cassandra server.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Linux 2.6.32-5-amd64, Java 1.6.0_26-b03&lt;/p&gt;</environment>
        <key id="12540923">CASSANDRA-3839</key>
            <summary>BulkOutputFormat binds to wrong client address when client is Dual-stack and server is IPv6</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="brandon.williams">Brandon Williams</assignee>
                                    <reporter username="forsberg">Erik Forsberg</reporter>
                        <labels>
                            <label>bulkloader</label>
                    </labels>
                <created>Thu, 2 Feb 2012 13:46:14 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:41 +0000</updated>
                            <resolved>Thu, 2 Feb 2012 23:19:08 +0000</resolved>
                                        <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>1</watches>
                                                                                                                <comments>
                            <comment id="13198834" author="brandon.williams" created="Thu, 2 Feb 2012 14:34:42 +0000"  >&lt;blockquote&gt;&lt;p&gt;It seems to me that the problem is that org.apache.cassandra.net.OutboundTcpConnectionPool is asking FBUtilities.getLocalAddress for the address to bind to, and getLocalAddress is returning an IPv4 address when DatabaseDescriptor has not been initialized. And DatabaseDescriptor has not been initialized, becase in BulkOutputFormat we&apos;re not reading cassandra.yaml.&lt;/p&gt;&lt;/blockquote&gt;

&lt;blockquote&gt;&lt;p&gt;I actually have a workaround for this which involves not applying patch that removes need to read cassandra.yaml, then point to a cassandra.yaml generated specifically for the purpose on each hadoop node, with listen_address set to the IPv6 address of the node.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;What&apos;s actually happening here is it&apos;s treating listen_address as being blank, which means we fall back to hostname resolution to determine the interface, so alternative you could modify your /etc/hosts and /etc/hostname to point to the ipv6 address.  However, I don&apos;t think we need to explicitly bind an outgoing address in OTCP either.  If we do, we can add some logic there to allow overriding it though.  Vijay, what do you think?&lt;/p&gt;</comment>
                            <comment id="13199058" author="vijay2win@yahoo.com" created="Thu, 2 Feb 2012 18:21:14 +0000"  >&lt;p&gt;Hi Brandon, allowing override might be better in this case. Because if we change this, cassandra&apos;s stream might get confused in some cases... in the constructor of IncomingStreamReader, as we do socket.getRemoteSocketAddress() to see where the stream comes from. if we dont bind it to the right address there may be some edge cases where it might not work. &lt;/p&gt;</comment>
                            <comment id="13199107" author="brandon.williams" created="Thu, 2 Feb 2012 19:08:52 +0000"  >&lt;p&gt;Patch 0005 on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-3740&quot; title=&quot;While using BulkOutputFormat  unneccessarily look for the cassandra.yaml file.&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-3740&quot;&gt;&lt;del&gt;CASSANDRA-3740&lt;/del&gt;&lt;/a&gt; includes these changes, but I attached it there because it depends on it.&lt;/p&gt;</comment>
                            <comment id="13199252" author="brandon.williams" created="Thu, 2 Feb 2012 21:37:07 +0000"  >&lt;p&gt;Attaching here too for review.&lt;/p&gt;</comment>
                            <comment id="13199338" author="vijay2win@yahoo.com" created="Thu, 2 Feb 2012 23:06:29 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13199355" author="brandon.williams" created="Thu, 2 Feb 2012 23:19:09 +0000"  >&lt;p&gt;Committed.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="12538311">CASSANDRA-3740</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="12310051">
                    <name>Supercedes</name>
                                                                <inwardlinks description="is superceded by">
                                        <issuelink>
            <issuekey id="12538311">CASSANDRA-3740</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="12513038" name="0005-Allow-using-any-interface-for-outgoing-connections.txt" size="4196" author="brandon.williams" created="Thu, 2 Feb 2012 21:37:07 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>1.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[brandon.williams]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>226276</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 42 weeks, 4 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gou7:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95454</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>vijay2win@yahoo.com</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[vijay2win@yahoo.com]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>