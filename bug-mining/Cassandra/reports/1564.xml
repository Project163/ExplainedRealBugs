<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:31:27 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-4032] memtable.updateLiveRatio() is blocking, causing insane latencies for writes</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-4032</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Reproduce by just starting a fresh cassandra with a heap large enough for live ratio calculation (which is &lt;tt&gt;O&lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/thumbs_down.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/tt&gt;) to be insanely slow, and then running &lt;tt&gt;./bin/stress -d host -n100000000 -t10&lt;/tt&gt;. With a large enough heap and default flushing behavior this is bad enough that stress gets timeouts.&lt;/p&gt;

&lt;p&gt;Example (&quot;blocked for&quot; is my debug log added around submit()):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt; INFO [MemoryMeter:1] 2012-03-09 15:07:30,857 Memtable.java (line 198) CFS(Keyspace=&lt;span class=&quot;code-quote&quot;&gt;&apos;Keyspace1&apos;&lt;/span&gt;, ColumnFamily=&lt;span class=&quot;code-quote&quot;&gt;&apos;Standard1&apos;&lt;/span&gt;) liveRatio is 8.89014894083727 (just-counted was 8.89014894083727).  calculation took 28273ms &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; 1320245 columns
 WARN [MutationStage:8] 2012-03-09 15:07:30,857 Memtable.java (line 209) submit() blocked &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt;: 231135
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The calling code was written assuming a RejectedExecutionException is thrown, but it&apos;s not because &lt;tt&gt;DebuggableThreadPoolExecutor&lt;/tt&gt; installs a blocking rejection handler.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12545857">CASSANDRA-4032</key>
            <summary>memtable.updateLiveRatio() is blocking, causing insane latencies for writes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="scode">Peter Schuller</assignee>
                                    <reporter username="scode">Peter Schuller</reporter>
                        <labels>
                    </labels>
                <created>Fri, 9 Mar 2012 15:10:22 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:37 +0000</updated>
                            <resolved>Wed, 11 Apr 2012 18:27:14 +0000</resolved>
                                        <fixVersion>1.1.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="13226138" author="scode" created="Fri, 9 Mar 2012 15:31:03 +0000"  >&lt;p&gt;Attaching patch that allows us to create both blocking and non-blocking &lt;tt&gt;DebuggableThreadPoolExecturor&lt;/tt&gt;:s; use that for this particular case.&lt;/p&gt;</comment>
                            <comment id="13226144" author="jbellis" created="Fri, 9 Mar 2012 15:36:03 +0000"  >&lt;p&gt;The DTPE change looks good, but don&apos;t you need a catch (Rejected) { } block in updateLiveRatio?&lt;/p&gt;</comment>
                            <comment id="13226152" author="scode" created="Fri, 9 Mar 2012 15:44:16 +0000"  >&lt;p&gt;There already is one, it&apos;s just a NOOP because of the blocking nature of the DTPE.&lt;/p&gt;</comment>
                            <comment id="13226153" author="scode" created="Fri, 9 Mar 2012 15:45:26 +0000"  >&lt;p&gt;This is the code:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt;
        {
            meterExecutor.submit(runnable);
        }
        &lt;span class=&quot;code-keyword&quot;&gt;catch&lt;/span&gt; (RejectedExecutionException e)
        {
            logger.debug(&lt;span class=&quot;code-quote&quot;&gt;&quot;Meter thread is busy; skipping liveRatio update &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; {}&quot;&lt;/span&gt;, cfs);
        }
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="13226157" author="slebresne" created="Fri, 9 Mar 2012 15:51:18 +0000"  >&lt;p&gt;Are we sure that what we want is a SynchronousQueue with task rejected? After all, there is only on global memoryMeter, so we could end up failing to updateLiveRatio just based on a race, even if calculations are fast. I&apos;d suggest instead a bounded queue (but maybe not infinite and we could indeed just skip task if that queue gets full).&lt;/p&gt;</comment>
                            <comment id="13226160" author="jbellis" created="Fri, 9 Mar 2012 15:57:06 +0000"  >&lt;blockquote&gt;&lt;p&gt;This is the code:&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Either I&apos;m blind or that&apos;s not in the attached patch.&lt;/p&gt;</comment>
                            <comment id="13226163" author="scode" created="Fri, 9 Mar 2012 16:01:29 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Either I&apos;m blind or that&apos;s not in the attached patch.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s not. It&apos;s &lt;b&gt;already there&lt;/b&gt;, in the branch, committed. The code was written, I presume, without the author realizing that RejectedExecutionException would never be thrown.&lt;/p&gt;</comment>
                            <comment id="13226166" author="scode" created="Fri, 9 Mar 2012 16:05:11 +0000"  >&lt;blockquote&gt;
&lt;p&gt;Are we sure that what we want is a SynchronousQueue with task rejected? After all, there is only on global memoryMeter, so we could end up failing to updateLiveRatio just based on a race, even if calculations are fast. I&apos;d suggest instead a bounded queue (but maybe not infinite and we could indeed just skip task if that queue gets full).&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I agree it&apos;s fishy, though I&apos;d suggest a separate ticket. This patch is intended to make the code behave the way the original commit intended.&lt;/p&gt;

&lt;p&gt;This (from the code, not my patch) seems legit though:&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;    &lt;span class=&quot;code-comment&quot;&gt;// we&apos;re careful to only allow one count to run at a time because counting is slow
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// (can be minutes, &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; a large memtable and a busy server), so we could keep memtables
&lt;/span&gt;    &lt;span class=&quot;code-comment&quot;&gt;// alive after they&lt;span class=&quot;code-quote&quot;&gt;&apos;re flushed and would otherwise be GC&apos;&lt;/span&gt;d.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;We could have one queue per unique CF and have a consumer that iterates over the set of queues, guaranteeing that each CF gets processed once per &quot;cycle&quot;. A simpler solution is probably preferable though if we can think of one.&lt;/p&gt;</comment>
                            <comment id="13226167" author="scode" created="Fri, 9 Mar 2012 16:07:40 +0000"  >&lt;p&gt;How about just having an unbounded queue but having each CF just keep a flag that says whether or not there is a calculation currently pending or executing; it would be reset by the task when executed, and CAS:ed in the write path. This; single queue, same DTPE. We&apos;d just submit a task with a reference to the AtomicBoolean which it will set to false on completion.&lt;/p&gt;</comment>
                            <comment id="13226169" author="scode" created="Fri, 9 Mar 2012 16:09:03 +0000"  >&lt;p&gt;(That seems simple enough to just do right now and not bother with a separate ticket. If you agree I&apos;ll submit a patch.)&lt;/p&gt;</comment>
                            <comment id="13226173" author="slebresne" created="Fri, 9 Mar 2012 16:17:11 +0000"  >&lt;p&gt;Sounds fine to me.&lt;/p&gt;</comment>
                            <comment id="13226271" author="scode" created="Fri, 9 Mar 2012 18:06:40 +0000"  >&lt;p&gt;Attaching &lt;tt&gt;v2&lt;/tt&gt;. Keeps NBHM mapping CFS -&amp;gt; AtomicBoolean. Mappings are never removed (assuming reasonably bound number of unique CFS:s during a lifetime). Queue used for DTPE is unbounded.&lt;/p&gt;</comment>
                            <comment id="13226272" author="scode" created="Fri, 9 Mar 2012 18:07:00 +0000"  >&lt;p&gt;(v2 doesn&apos;t keep the changes to DTPE, which are no longer used.)&lt;/p&gt;</comment>
                            <comment id="13248968" author="jbellis" created="Fri, 6 Apr 2012 22:29:03 +0000"  >&lt;p&gt;v3 attached:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;uses putIfAbsent in the AtomicBoolean creation&lt;/li&gt;
	&lt;li&gt;drops the catch block around executor submission&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13250746" author="slebresne" created="Tue, 10 Apr 2012 15:34:03 +0000"  >&lt;p&gt;Wouldn&apos;t using a ConcurrentSkipListSet simply the code? Feels like a lot of boilerplate to record that there is already a metering running (it&apos;s not like this is a hot path enough to justify the NBHM). &lt;/p&gt;</comment>
                            <comment id="13250771" author="jbellis" created="Tue, 10 Apr 2012 16:00:34 +0000"  >&lt;p&gt;you&apos;re right; v4 attached w/ Set approach.&lt;/p&gt;

&lt;p&gt;(used NBHS instead of CSLS since the latter requires defining a comparator.  I&apos;m not sure the overhead is substantially different.)&lt;/p&gt;</comment>
                            <comment id="13251622" author="slebresne" created="Wed, 11 Apr 2012 14:27:07 +0000"  >&lt;p&gt;+1 with two nits:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;In the comment &quot;to a maximum of one per CFS using this map&quot; could have a s/map/set/&lt;/li&gt;
	&lt;li&gt;Note sure if there was an intent in changing the maximumPoolSize of the meterExecutor to Integer.MAX_VALUE. As it stands, with an unbounded queue the maximumPoolSize is ignored so that doesn&apos;t really matter, but just wanted to mention it.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="13251817" author="jbellis" created="Wed, 11 Apr 2012 18:27:14 +0000"  >&lt;p&gt;Committed, w/ nits amended&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12521777" name="4032-v3.txt" size="7834" author="jbellis" created="Fri, 6 Apr 2012 22:29:43 +0000"/>
                            <attachment id="12522121" name="4032-v4.txt" size="7259" author="jbellis" created="Tue, 10 Apr 2012 16:00:33 +0000"/>
                            <attachment id="12517729" name="CASSANDRA-4032-1.1.0-v1.txt" size="4294" author="scode" created="Fri, 9 Mar 2012 15:31:03 +0000"/>
                            <attachment id="12517754" name="CASSANDRA-4032-1.1.0-v2.txt" size="7908" author="scode" created="Fri, 9 Mar 2012 18:06:40 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>4.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[scode]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>231040</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            13 years, 32 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0gr67:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>95832</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>slebresne</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[slebresne]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>