<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:11:00 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-348] Range scan over two nodes returns wrong data</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-348</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;I&apos;ve got two nodes with tokens 00000000 and 88888888. I add 16 rows in which are spread over them, then do a key range scan.&lt;/p&gt;

&lt;p&gt;I can scan part of the range successfully, but if I try to scan the entire range of keys (0-f) then I get unexpected results&lt;/p&gt;

&lt;p&gt;./Cassandra-remote -h localhost:9160 get_key_range Keyspace1 Standard1 0 31 1000&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;00&amp;#39;, &amp;#39;01&amp;#39;, &amp;#39;10&amp;#39;, &amp;#39;11&amp;#39;, &amp;#39;20&amp;#39;, &amp;#39;21&amp;#39;, &amp;#39;30&amp;#39;, &amp;#39;31&amp;#39;&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;./Cassandra-remote -h localhost:9160 get_key_range Keyspace1 Standard1 3 81 1000&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;30&amp;#39;, &amp;#39;31&amp;#39;, &amp;#39;40&amp;#39;, &amp;#39;41&amp;#39;, &amp;#39;50&amp;#39;, &amp;#39;51&amp;#39;, &amp;#39;60&amp;#39;, &amp;#39;61&amp;#39;, &amp;#39;70&amp;#39;, &amp;#39;71&amp;#39;, &amp;#39;80&amp;#39;, &amp;#39;81&amp;#39;&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt; ./Cassandra-remote -h localhost:9160 get_key_range Keyspace1 Standard1 7 b1 1000&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;70&amp;#39;, &amp;#39;71&amp;#39;, &amp;#39;80&amp;#39;, &amp;#39;81&amp;#39;, &amp;#39;90&amp;#39;, &amp;#39;91&amp;#39;, &amp;#39;a0&amp;#39;, &amp;#39;a1&amp;#39;, &amp;#39;b0&amp;#39;, &amp;#39;b1&amp;#39;&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;./Cassandra-remote -h localhost:9160 get_key_range Keyspace1 Standard1 a g 1000&lt;br/&gt;
&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;#39;a0&amp;#39;, &amp;#39;a1&amp;#39;, &amp;#39;b0&amp;#39;, &amp;#39;b1&amp;#39;, &amp;#39;c0&amp;#39;, &amp;#39;c1&amp;#39;, &amp;#39;d0&amp;#39;, &amp;#39;d1&amp;#39;, &amp;#39;e0&amp;#39;, &amp;#39;e1&amp;#39;, &amp;#39;f0&amp;#39;, &amp;#39;f1&amp;#39;&amp;#93;&lt;/span&gt;&lt;/p&gt;

&lt;p&gt;All of which returned as I expected.&lt;/p&gt;

&lt;p&gt;But when I range scan the whole lot (0-g) then I get:&lt;/p&gt;

&lt;p&gt;./Cassandra-remote -h localhost:9160 get_key_range Keyspace1 Standard1 0 g 1000&lt;br/&gt;
[ &apos;00&apos;,&lt;br/&gt;
  &apos;90&apos;,&lt;br/&gt;
  &apos;91&apos;,&lt;br/&gt;
  &apos;a0&apos;,&lt;br/&gt;
  &apos;a1&apos;,&lt;br/&gt;
  &apos;b0&apos;,&lt;br/&gt;
  &apos;b1&apos;,&lt;br/&gt;
  &apos;c0&apos;,&lt;br/&gt;
  &apos;c1&apos;,&lt;br/&gt;
  &apos;d0&apos;,&lt;br/&gt;
  &apos;d1&apos;,&lt;br/&gt;
  &apos;e0&apos;,&lt;br/&gt;
  &apos;e1&apos;,&lt;br/&gt;
  &apos;f0&apos;,&lt;br/&gt;
  &apos;f1&apos;]&lt;/p&gt;

&lt;p&gt;Where have 01-81 gone?&lt;/p&gt;

&lt;p&gt;I&apos;ll attach the data loading script.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12432373">CASSANDRA-348</key>
            <summary>Range scan over two nodes returns wrong data</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jbellis">Jonathan Ellis</assignee>
                                    <reporter username="markr">Mark Robson</reporter>
                        <labels>
                    </labels>
                <created>Thu, 6 Aug 2009 10:35:57 +0000</created>
                <updated>Tue, 16 Apr 2019 09:33:35 +0000</updated>
                            <resolved>Wed, 12 Aug 2009 21:27:36 +0000</resolved>
                                        <fixVersion>0.4</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>0</watches>
                                                                                                                <comments>
                            <comment id="12739979" author="markr" created="Thu, 6 Aug 2009 10:37:28 +0000"  >&lt;p&gt;This is a cassandra-cli script used to load the test data which gets the results above.&lt;/p&gt;
</comment>
                            <comment id="12739980" author="markr" created="Thu, 6 Aug 2009 10:39:11 +0000"  >&lt;p&gt;Relevant config:&lt;/p&gt;

&lt;p&gt;node1:&lt;/p&gt;

&lt;p&gt;    &amp;lt;Partitioner&amp;gt;org.apache.cassandra.dht.OrderPreservingPartitioner&amp;lt;/Partitioner&amp;gt;&lt;br/&gt;
    &amp;lt;InitialToken&amp;gt;00000000&amp;lt;/InitialToken&amp;gt;&lt;/p&gt;

&lt;p&gt;node2:&lt;/p&gt;

&lt;p&gt;    &amp;lt;Partitioner&amp;gt;org.apache.cassandra.dht.OrderPreservingPartitioner&amp;lt;/Partitioner&amp;gt;&lt;br/&gt;
    &amp;lt;InitialToken&amp;gt;88888888&amp;lt;/InitialToken&amp;gt;&lt;/p&gt;

&lt;p&gt;Most of the rest is as shipped.&lt;/p&gt;</comment>
                            <comment id="12740052" author="jbellis" created="Thu, 6 Aug 2009 13:26:24 +0000"  >&lt;p&gt;this patch fixes a minor bug (probably not the cause of your problems) and adds debug logging.  can you try with this patch and post the debug statements involving RangeCommand and RangeReply?&lt;/p&gt;</comment>
                            <comment id="12740065" author="markr" created="Thu, 6 Aug 2009 13:45:00 +0000"  >&lt;p&gt;I&apos;ve applied the patch and the bug is still there, here is the debug output:&lt;/p&gt;

&lt;p&gt;NODE 1 debug output:&lt;/p&gt;

&lt;p&gt;DEBUG - get_key_range&lt;br/&gt;
DEBUG - reading RangeCommand(table=&apos;Keyspace1&apos;, columnFamily=Standard1, startWith=&apos;0&apos;, stopAt=&apos;g&apos;, maxResults=100) from 58@127.0.0.1:7000&lt;br/&gt;
DEBUG - Sending RangeReply(keys=&lt;span class=&quot;error&quot;&gt;&amp;#91;00, 90, 91, a0, a1, b0, b1, c0, c1, d0, d1, e0, e1, f0, f1&amp;#93;&lt;/span&gt;, completed=false) to 58@127.0.0.1:7000&lt;br/&gt;
DEBUG - Processing response on an async result from 58@127.0.0.1:7000&lt;br/&gt;
DEBUG - reading RangeCommand(table=&apos;Keyspace1&apos;, columnFamily=Standard1, startWith=&apos;f1&apos;, stopAt=&apos;g&apos;, maxResults=85) from 59@127.0.0.2:7000&lt;br/&gt;
DEBUG - Processing response on an async result from 59@127.0.0.2:7000&lt;/p&gt;

&lt;p&gt;NODE 2 debug output:&lt;/p&gt;

&lt;p&gt;DEBUG - Sending RangeReply(keys=[], completed=false) to 59@127.0.0.1:7000&lt;/p&gt;

&lt;p&gt;bin/nodeprobe -host localhost ring&lt;br/&gt;
DEBUG - Loading settings from bin/../conf/storage-conf.xml&lt;br/&gt;
Token(00000000)                                 1 127.0.0.2      |&amp;lt;--|&lt;br/&gt;
Token(88888888)                                 1 127.0.0.1      |--&amp;gt;|&lt;/p&gt;</comment>
                            <comment id="12740077" author="jbellis" created="Thu, 6 Aug 2009 14:09:44 +0000"  >&lt;p&gt;remember these are string keys, not really numeric.  &apos;0&apos; is not part of the [&apos;00000000&apos; , &apos;88888888&apos; ) range.  (neither is the key &apos;00&apos; of course.)&lt;/p&gt;

&lt;p&gt;i bet you get all the keys if you query for &apos;&apos;, &apos;g&apos; instead of &apos;0&apos;, &apos;g&apos;.&lt;/p&gt;</comment>
                            <comment id="12740091" author="markr" created="Thu, 6 Aug 2009 15:00:41 +0000"  >&lt;p&gt;I am aware that the keys are strings &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/smile.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;

&lt;p&gt;Keys should presumably not HAVE to be within the range of two tokens in the ring - keys outside the range will be stored anyway?&lt;/p&gt;

&lt;p&gt;I tried the above, same result:&lt;/p&gt;

&lt;p&gt;cassandra/Cassandra-remote -h localhost:9160 get_key_range Keyspace1 Standard1 &apos;&apos; g 100&lt;br/&gt;
[ &apos;00&apos;,&lt;br/&gt;
  &apos;90&apos;,&lt;br/&gt;
  &apos;91&apos;,&lt;br/&gt;
  &apos;a0&apos;,&lt;br/&gt;
  &apos;a1&apos;,&lt;br/&gt;
  &apos;b0&apos;,&lt;br/&gt;
  &apos;b1&apos;,&lt;br/&gt;
  &apos;c0&apos;,&lt;br/&gt;
  &apos;c1&apos;,&lt;br/&gt;
  &apos;d0&apos;,&lt;br/&gt;
  &apos;d1&apos;,&lt;br/&gt;
  &apos;e0&apos;,&lt;br/&gt;
  &apos;e1&apos;,&lt;br/&gt;
  &apos;f0&apos;,&lt;br/&gt;
  &apos;f1&apos;]&lt;/p&gt;</comment>
                            <comment id="12740098" author="markr" created="Thu, 6 Aug 2009 15:07:43 +0000"  >&lt;p&gt;Even more weird:&lt;/p&gt;

&lt;p&gt; cassandra/Cassandra-remote -h localhost:9160 get_key_range Keyspace1 Standard1 00000000 g 100&lt;br/&gt;
[ &apos;90&apos;,&lt;br/&gt;
  &apos;91&apos;,&lt;br/&gt;
  &apos;a0&apos;,&lt;br/&gt;
  &apos;a1&apos;,&lt;br/&gt;
  &apos;b0&apos;,&lt;br/&gt;
  &apos;b1&apos;,&lt;br/&gt;
  &apos;c0&apos;,&lt;br/&gt;
  &apos;c1&apos;,&lt;br/&gt;
  &apos;d0&apos;,&lt;br/&gt;
  &apos;d1&apos;,&lt;br/&gt;
  &apos;e0&apos;,&lt;br/&gt;
  &apos;e1&apos;,&lt;br/&gt;
  &apos;f0&apos;,&lt;br/&gt;
  &apos;f1&apos;]&lt;/p&gt;

&lt;p&gt;Now it misses everything from 0 to 81&lt;/p&gt;</comment>
                            <comment id="12740100" author="markr" created="Thu, 6 Aug 2009 15:10:58 +0000"  >&lt;p&gt;cassandra/Cassandra-remote -h localhost:9160 get_key_range Keyspace1 Standard1 &apos;&apos; g 100&lt;br/&gt;
[ &apos;00&apos;,&lt;br/&gt;
  &apos;90&apos;,&lt;br/&gt;
..&lt;br/&gt;
  &apos;f1&apos;]&lt;/p&gt;

&lt;p&gt;Debug logs:&lt;/p&gt;

&lt;p&gt;NODE 1:&lt;/p&gt;

&lt;p&gt;DEBUG - get_key_range&lt;br/&gt;
DEBUG - reading RangeCommand(table=&apos;Keyspace1&apos;, columnFamily=Standard1, startWith=&apos;&apos;, stopAt=&apos;g&apos;, maxResults=100) from 2208@127.0.0.1:7000&lt;br/&gt;
DEBUG - Sending RangeReply(keys=&lt;span class=&quot;error&quot;&gt;&amp;#91;00, 90, 91, a0, a1, b0, b1, c0, c1, d0, d1, e0, e1, f0, f1&amp;#93;&lt;/span&gt;, completed=false) to 2208@127.0.0.1:7000&lt;br/&gt;
DEBUG - Processing response on an async result from 2208@127.0.0.1:7000&lt;br/&gt;
DEBUG - reading RangeCommand(table=&apos;Keyspace1&apos;, columnFamily=Standard1, startWith=&apos;f1&apos;, stopAt=&apos;g&apos;, maxResults=85) from 2209@127.0.0.2:7000&lt;br/&gt;
DEBUG - Processing response on an async result from 2209@127.0.0.2:7000&lt;/p&gt;

&lt;p&gt;NODE 2:&lt;br/&gt;
DEBUG - Sending RangeReply(keys=[], completed=false) to 2209@127.0.0.1:7000&lt;/p&gt;</comment>
                            <comment id="12740110" author="jbellis" created="Thu, 6 Aug 2009 15:34:37 +0000"  >&lt;p&gt;looks like a bug in the node selection code.&lt;/p&gt;

&lt;p&gt;i&apos;ll commit the bugfix+logging patch for now.&lt;/p&gt;</comment>
                            <comment id="12740115" author="junrao" created="Thu, 6 Aug 2009 15:41:57 +0000"  >&lt;p&gt;The node selection code seems to be designed only for RackUnaware.&lt;/p&gt;</comment>
                            <comment id="12740142" author="jbellis" created="Thu, 6 Aug 2009 16:34:10 +0000"  >&lt;p&gt;Node selection code is working as designed but it is not quite what getKeyRange expects.&lt;/p&gt;

&lt;p&gt;The node selection is &quot;pick the node whose token is nearest to the decorated key, &lt;em&gt;always rounding up&lt;/em&gt;.&quot;  so what you end up with here is 3 range sections:&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;&amp;quot;&amp;quot;, 000000000&amp;#93;&lt;/span&gt; node A (the one with token 00000000)&lt;br/&gt;
(00000000, 88888888] node B (the one with token 88888888)&lt;br/&gt;
(88888888, infinity) node A again&lt;/p&gt;

&lt;p&gt;so, key 00 goes on node A, but 01-88 go on node B.  then 09-ff go on node A again.&lt;/p&gt;

&lt;p&gt;we could hack around this in getKeyRange but it seems like the Right Fix is to make it so A has [&apos;&apos;, 88888888) and B has [88888888, inf), no?&lt;/p&gt;

&lt;p&gt;what do you think, Jun?  is there any inherent advantage to &quot;round up&quot; instead of &quot;round down&quot; that I have forgotten?&lt;/p&gt;

&lt;p&gt;&lt;span class=&quot;error&quot;&gt;&amp;#91;yeah, we&amp;#39;re ignoring RackAware for now&amp;#93;&lt;/span&gt;&lt;/p&gt;</comment>
                            <comment id="12740159" author="junrao" created="Thu, 6 Aug 2009 17:24:10 +0000"  >&lt;p&gt;Interesting. It seems the problem is that you started with a key that&apos;s in the middle btw 2 adjacent tokens and you need to go back to the very first node to complete the full scan. The current code seems to stop as soon as you hit the first node again. It seems that this will happen whether you roundup or rounddown. So, maybe we should let the first node be scanned twice, one at the beginning and another at the end.&lt;/p&gt;</comment>
                            <comment id="12740216" author="jbellis" created="Thu, 6 Aug 2009 19:27:57 +0000"  >&lt;p&gt;You are right, we&apos;re going to have this problem either way we round the keys to tokens.  Take this example, I was wrong about how the tokens would work, it would be&lt;/p&gt;

&lt;p&gt;[00000000, 88888888) A&lt;br/&gt;
[88888888, inf) and [&apos;&apos;, 00000000) B&lt;/p&gt;

&lt;p&gt;so either way starting from &apos;&apos; you&apos;re going to have to re-scan part of the same range when you wrap.&lt;/p&gt;</comment>
                            <comment id="12740454" author="markr" created="Fri, 7 Aug 2009 09:03:12 +0000"  >&lt;p&gt;I have attached a python script LoadAndScan.py which uses the thrift interface to load a bunch of test data then do lots of range scans to check the results are right.&lt;/p&gt;

&lt;p&gt;This can be made into an automated system test, you are free to use it.&lt;/p&gt;</comment>
                            <comment id="12740455" author="markr" created="Fri, 7 Aug 2009 09:04:20 +0000"  >&lt;p&gt;The LoadAndScan.py script succeeds when there is a single node, and various cases fail when there are more nodes with tokens which overlap the range 0000-ffff &lt;/p&gt;

&lt;p&gt;I have tried it with 1,2 and 4 nodes, the more nodes the more failure cases.&lt;/p&gt;</comment>
                            <comment id="12740531" author="hudson" created="Fri, 7 Aug 2009 12:49:49 +0000"  >&lt;p&gt;Integrated in Cassandra #160 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/160/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/160/&lt;/a&gt;)&lt;br/&gt;
    fix range query buglet; add debug logging&lt;br/&gt;
patch by jbellis; tested by Mark Robson for &lt;/p&gt;</comment>
                            <comment id="12740631" author="jbellis" created="Fri, 7 Aug 2009 16:52:17 +0000"  >&lt;p&gt;This patch fixes the main problem.  There are two things going on in this patch:&lt;/p&gt;

&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;we switch from trying to get the next endpoint by increasing offset to asking tokenMetadata for &quot;the next one.&quot;  this will always be correct where the offset approach will not (usually you want offset to just be 1, but sometimes you have to keep increasing it if no results are found but the range is still not finished)&lt;/li&gt;
	&lt;li&gt;we merge results differently when the endpoint responsible for where the ring wraps is involved, since that endpoint can hold keys from both the beginning and end of the range.&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="12740685" author="markr" created="Fri, 7 Aug 2009 19:37:37 +0000"  >&lt;p&gt;With 348-2.patch I get&lt;/p&gt;

&lt;p&gt;DEBUG - get_key_range&lt;br/&gt;
DEBUG - reading RangeCommand(table=&apos;Keyspace1&apos;, columnFamily=Standard1, startWith=&apos;0&apos;, stopAt=&apos;1&apos;, maxResults=1000) from 593@127.0.0.1:7000&lt;br/&gt;
DEBUG - Sending RangeReply(keys=&lt;span class=&quot;error&quot;&gt;&amp;#91;0000&amp;#93;&lt;/span&gt;, completed=false) to 593@127.0.0.1:7000&lt;br/&gt;
DEBUG - Processing response on an async result from 593@127.0.0.1:7000&lt;br/&gt;
DEBUG - reading RangeCommand(table=&apos;Keyspace1&apos;, columnFamily=Standard1, startWith=&apos;0&apos;, stopAt=&apos;1&apos;, maxResults=999) from 594@127.0.0.2:7000&lt;br/&gt;
DEBUG - Processing response on an async result from 594@127.0.0.2:7000&lt;br/&gt;
ERROR - Internal error processing get_key_range&lt;br/&gt;
java.lang.UnsupportedOperationException&lt;br/&gt;
        at java.util.Collections$UnmodifiableCollection.addAll(Collections.java:1044)&lt;br/&gt;
        at org.apache.cassandra.service.StorageProxy.getKeyRange(StorageProxy.java:673)&lt;br/&gt;
        at org.apache.cassandra.service.CassandraServer.get_key_range(CassandraServer.java:557)&lt;br/&gt;
        at org.apache.cassandra.service.Cassandra$Processor$get_key_range.process(Cassandra.java:1095)&lt;br/&gt;
        at org.apache.cassandra.service.Cassandra$Processor.process(Cassandra.java:758)&lt;br/&gt;
        at org.apache.thrift.server.TThreadPoolServer$WorkerProcess.run(TThreadPoolServer.java:252)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)&lt;br/&gt;
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)&lt;br/&gt;
        at java.lang.Thread.run(Thread.java:636)&lt;/p&gt;

&lt;p&gt;When attempting to do a range scan which crosses over nodes.&lt;/p&gt;

&lt;p&gt;Also get the warning:&lt;/p&gt;

&lt;p&gt;    &lt;span class=&quot;error&quot;&gt;&amp;#91;javac&amp;#93;&lt;/span&gt; Note: /home/mark/cassandra/cassandra-trunk/src/java/org/apache/cassandra/tools/KeyChecker.java uses or overrides a deprecated API.&lt;/p&gt;

&lt;p&gt;At compile-time.&lt;/p&gt;</comment>
                            <comment id="12740703" author="markr" created="Fri, 7 Aug 2009 20:16:59 +0000"  >&lt;p&gt;This patch goes on top of 348-2.patch and fixes the exception I described.&lt;/p&gt;</comment>
                            <comment id="12740707" author="markr" created="Fri, 7 Aug 2009 20:28:57 +0000"  >&lt;p&gt;This patch 348-2-fixup-2.patch supersedes the previous one and fixes another case where it was trying to modify a readonly list.&lt;/p&gt;</comment>
                            <comment id="12740711" author="markr" created="Fri, 7 Aug 2009 20:31:13 +0000"  >&lt;p&gt;With the combined efforts of your patch and my patch, range scans are a lot &lt;b&gt;closer&lt;/b&gt; to working correctly. My system test program runs successfully with two nodes 0 and 8, but still fails a few test cases when there are four nodes 0,4,8,c&lt;/p&gt;

&lt;p&gt;However, the remaining test cases which are failing are ones where a range covers at least three nodes.These are unlikely to happen to anyone in production unless their nodes are very close together or their keys very sparse and they&apos;re doing massive range scans.&lt;/p&gt;

&lt;p&gt;But it would be nice if we covered all cases.&lt;/p&gt;</comment>
                            <comment id="12740723" author="jbellis" created="Fri, 7 Aug 2009 20:48:05 +0000"  >&lt;p&gt;Committed -2 with a simpler fix for the readonly list.&lt;/p&gt;

&lt;p&gt;If you can find a way to reproduce the remaining bug in a 2-node setup that will make it easier to debug.&lt;/p&gt;</comment>
                            <comment id="12740751" author="markr" created="Fri, 7 Aug 2009 21:28:59 +0000"  >&lt;p&gt;Technically this is fixed as I can&apos;t reproduce it in a two-node setup any more. On the other hand, some range scans still return missing results in a three-node setup.&lt;/p&gt;

&lt;p&gt;So either, close this and open a new one for the three-node case, or continue to work on a solution.&lt;/p&gt;

&lt;p&gt;I fired up three nodes with tokens 0,4,8 then used the attached LoadAndScan.py.&lt;/p&gt;

&lt;p&gt;This gives 3 errors out of 120 get_key_range commands. When run on two nodes (0,8) it passes, as on a single node.&lt;/p&gt;</comment>
                            <comment id="12740758" author="jbellis" created="Fri, 7 Aug 2009 21:47:15 +0000"  >&lt;p&gt;can you post the debug logs from a 3-node failure as before?&lt;/p&gt;</comment>
                            <comment id="12740881" author="hudson" created="Sat, 8 Aug 2009 12:35:17 +0000"  >&lt;p&gt;Integrated in Cassandra #161 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/161/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/161/&lt;/a&gt;)&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;switch from trying to get the next endpoint by increasing offset to asking tokenMetadata for &quot;the next&lt;br/&gt;
one.&quot; this will always be correct where the offset approach will not (usually you want offset to just be 1,&lt;br/&gt;
but sometimes you have to keep increasing it if no results are found but the range is still not finished)&lt;/li&gt;
	&lt;li&gt;merge results differently when the endpoint responsible for where the ring wraps is involved, since&lt;br/&gt;
that endpoint can hold keys from both the beginning and end of the range.&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;patch by jbellis; tested by Mark Robson for &lt;/p&gt;</comment>
                            <comment id="12742479" author="jbellis" created="Wed, 12 Aug 2009 17:51:42 +0000"  >&lt;p&gt;with the -3 patch, LoadAndScan.py passes all tests on 3 nodes for me.&lt;/p&gt;</comment>
                            <comment id="12742569" author="markr" created="Wed, 12 Aug 2009 20:54:37 +0000"  >&lt;p&gt;With the -3 patch, LoadAndScan.py now passes with 3 and 4 nodes if ReplicationFactor=1.&lt;/p&gt;

&lt;p&gt;Unfortunately, setting ReplicationFactor=2 now breaks it.&lt;/p&gt;</comment>
                            <comment id="12742571" author="jbellis" created="Wed, 12 Aug 2009 20:59:50 +0000"  >&lt;p&gt;fixes replication &amp;gt; 1 bugs&lt;/p&gt;</comment>
                            <comment id="12742582" author="jbellis" created="Wed, 12 Aug 2009 21:27:36 +0000"  >&lt;p&gt;IRC: &amp;gt; Looks better&lt;/p&gt;

&lt;p&gt;committed.&lt;/p&gt;</comment>
                            <comment id="12742732" author="markr" created="Thu, 13 Aug 2009 06:12:52 +0000"  >&lt;p&gt;Jonathan, &lt;/p&gt;

&lt;p&gt;The latest patch passes every range scan I have thrown at it, including with replication &amp;gt; 1&lt;/p&gt;

&lt;p&gt;So it all looks good to me.&lt;/p&gt;

&lt;p&gt;I will hopefully incorporate my tests into the suite soon.&lt;/p&gt;

&lt;p&gt;Mark&lt;/p&gt;</comment>
                            <comment id="12742820" author="hudson" created="Thu, 13 Aug 2009 13:13:49 +0000"  >&lt;p&gt;Integrated in Cassandra #166 (See &lt;a href=&quot;http://hudson.zones.apache.org/hudson/job/Cassandra/166/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;http://hudson.zones.apache.org/hudson/job/Cassandra/166/&lt;/a&gt;)&lt;br/&gt;
    give up on trying to optimize startWith &amp;#8211; it&apos;s basically impossible when replication factor &amp;gt; 1 b/c of the range wrap point.&lt;br/&gt;
patch by jbellis; tested by Mark Robson for &lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12415886" name="348-2-fixup-2.patch" size="1110" author="markr" created="Fri, 7 Aug 2009 20:28:57 +0000"/>
                            <attachment id="12415885" name="348-2-fixup.patch" size="544" author="markr" created="Fri, 7 Aug 2009 20:16:59 +0000"/>
                            <attachment id="12415866" name="348-2.patch" size="21538" author="jbellis" created="Fri, 7 Aug 2009 16:52:17 +0000"/>
                            <attachment id="12416357" name="348-3-v2.patch" size="3038" author="jbellis" created="Wed, 12 Aug 2009 20:59:50 +0000"/>
                            <attachment id="12416343" name="348-3.patch" size="1783" author="jbellis" created="Wed, 12 Aug 2009 17:51:42 +0000"/>
                            <attachment id="12415744" name="348.diff" size="9747" author="jbellis" created="Thu, 6 Aug 2009 13:26:24 +0000"/>
                            <attachment id="12415832" name="LoadAndScan.py" size="1871" author="markr" created="Fri, 7 Aug 2009 09:03:12 +0000"/>
                            <attachment id="12415723" name="setup.cas" size="1346" author="markr" created="Thu, 6 Aug 2009 10:37:28 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>8.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>19645</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            16 years, 15 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i0fydz:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>91169</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>