<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:54:46 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-9540] Cql IN query wrong on rows with values bigger than 64kb</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-9540</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;We are investigating a weird issue where one of our clients doesn&apos;t get data on his dashboard. It seems Cassandra is not returning data for a particular key (&quot;brokenkey&quot; from now on).&lt;/p&gt;

&lt;p&gt;Some background:&lt;br/&gt;
We have a row where we store a &quot;metadata&quot; column and data in columns &quot;bucket/0&quot;, &quot;bucket/1&quot;, &quot;bucket/2&quot;, etc. Depending on the date selection of the UI, we know that we only need to retrieve bucket/0, bucket/0 and bucket/1 etc. (we always need to retrieve &quot;metadata&quot;).&lt;/p&gt;

&lt;p&gt;A typical query may look like this (using SELECT column1 to just show what is returned, normally we would of course do SELECT value):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:AppBrain&amp;gt; select blobAsText(column1) from &quot;GroupedSeries&quot; where key=textAsBlob(&apos;install/workingkey&apos;);

 blobAsText(column1)
---------------------
            bucket/0
            metadata

(2 rows)
cqlsh:AppBrain&amp;gt; select blobAsText(column1) from &quot;GroupedSeries&quot; where key=textAsBlob(&apos;install/brokenkey&apos;);

 blobAsText(column1)
---------------------
            bucket/0
            metadata

(2 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;These two queries work as expected, and return the information that we actually stored.&lt;br/&gt;
However, when we &quot;filter&quot; for certain columns, the brokenkey starts behaving very weird:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:AppBrain&amp;gt; select blobAsText(column1) from &quot;GroupedSeries&quot; where key=textAsBlob(&apos;install/workingkey&apos;) and column1 IN (textAsBlob(&apos;metadata&apos;),textAsBlob(&apos;bucket/0&apos;),textAsBlob(&apos;bucket/1&apos;),textAsBlob(&apos;bucket/2&apos;));

 blobAsText(column1)
---------------------
            bucket/0
            metadata

(2 rows)
cqlsh:AppBrain&amp;gt; select blobAsText(column1) from &quot;GroupedSeries&quot; where key=textAsBlob(&apos;install/workingkey&apos;) and column1 IN (textAsBlob(&apos;metadata&apos;),textAsBlob(&apos;bucket/0&apos;),textAsBlob(&apos;bucket/1&apos;),textAsBlob(&apos;bucket/2&apos;),textAsBlob(&apos;asdfasdfasdf&apos;));

 blobAsText(column1)
---------------------
            bucket/0
            metadata

(2 rows)
***  As expected, querying for more information doesn&apos;t really matter for the working key ***

cqlsh:AppBrain&amp;gt; select blobAsText(column1) from &quot;GroupedSeries&quot; where key=textAsBlob(&apos;install/brokenkey&apos;) and column1 IN (textAsBlob(&apos;metadata&apos;),textAsBlob(&apos;bucket/0&apos;),textAsBlob(&apos;bucket/1&apos;),textAsBlob(&apos;bucket/2&apos;));

 blobAsText(column1)
---------------------
            bucket/0

(1 rows)
*** Cassandra stops giving us the metadata column when asking for a few more columns! ***
cqlsh:AppBrain&amp;gt; select blobAsText(column1) from &quot;GroupedSeries&quot; where key=textAsBlob(&apos;install/brokenkey&apos;) and column1 IN (textAsBlob(&apos;metadata&apos;),textAsBlob(&apos;bucket/0&apos;),textAsBlob(&apos;bucket/1&apos;),textAsBlob(&apos;bucket/2&apos;),textAsBlob(&apos;asdfasdfasdf&apos;));

 key | column1 | value
-----+---------+-------

(0 rows)
*** Adding the bogus column name even makes it return nothing from this row anymore! ***
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;There are at least two rows that malfunction like this in our table (which is quite old already and has gone through a bunch of Cassandra upgrades). I&apos;ve upgraded our whole cluster to 2.1.5 (we were on 2.1.2 when I discovered this problem) and compacted, repaired and scrubbed this column family, which hasn&apos;t helped.&lt;/p&gt;

&lt;p&gt;Our table structure is:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:AppBrain&amp;gt; describe table &quot;GroupedSeries&quot;;

CREATE TABLE &quot;AppBrain&quot;.&quot;GroupedSeries&quot; (
    key blob,
    column1 blob,
    value blob,
    PRIMARY KEY (key, column1)
) WITH COMPACT STORAGE
    AND CLUSTERING ORDER BY (column1 ASC)
    AND caching = &apos;{&quot;keys&quot;:&quot;ALL&quot;, &quot;rows_per_partition&quot;:&quot;NONE&quot;}&apos;
    AND comment = &apos;&apos;
    AND compaction = {&apos;min_threshold&apos;: &apos;4&apos;, &apos;class&apos;: &apos;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&apos;, &apos;max_threshold&apos;: &apos;32&apos;}
    AND compression = {&apos;sstable_compression&apos;: &apos;org.apache.cassandra.io.compress.LZ4Compressor&apos;}
    AND dclocal_read_repair_chance = 0.1
    AND default_time_to_live = 0
    AND gc_grace_seconds = 864000
    AND max_index_interval = 2048
    AND memtable_flush_period_in_ms = 0
    AND min_index_interval = 128
    AND read_repair_chance = 1.0
    AND speculative_retry = &apos;NONE&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Let me know if I can give more information that may be helpful.&lt;/p&gt;</description>
                <environment>&lt;p&gt;Cassandra 2.1.5&lt;/p&gt;</environment>
        <key id="12835085">CASSANDRA-9540</key>
            <summary>Cql IN query wrong on rows with values bigger than 64kb</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="carlyeks">Carl Yeksigian</assignee>
                                    <reporter username="mathijs">Mathijs Vogelzang</reporter>
                        <labels>
                    </labels>
                <created>Wed, 3 Jun 2015 15:15:06 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:08 +0000</updated>
                            <resolved>Thu, 25 Jun 2015 09:10:13 +0000</resolved>
                                        <fixVersion>2.1.8</fixVersion>
                    <fixVersion>2.2.0 rc2</fixVersion>
                                    <component>Legacy/CQL</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="14572659" author="mathijs" created="Thu, 4 Jun 2015 12:13:11 +0000"  >&lt;p&gt;I was able to make this case reproducible by getting the key from our production database and saving it with sstable2json.&lt;br/&gt;
It seems that the broken keys have one somewhat bigger cell (144 kB in this case).&lt;/p&gt;

&lt;p&gt;A testcase json file is available at &lt;a href=&quot;https://www.dropbox.com/s/kzu2jmqmwz788k8/testcase.json?dl=0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.dropbox.com/s/kzu2jmqmwz788k8/testcase.json?dl=0&lt;/a&gt; (the SSTable that it creates is available at &lt;a href=&quot;https://www.dropbox.com/s/ilwpjka5r70n2os/test-testbug-ka-2-Data.db?dl=0&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://www.dropbox.com/s/ilwpjka5r70n2os/test-testbug-ka-2-Data.db?dl=0&lt;/a&gt; )&lt;/p&gt;

&lt;p&gt;The commands that I executed are in cqlsh:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;create keyspace test with replication={&apos;class&apos;:&apos;SimpleStrategy&apos;,&apos;replication_factor&apos;:1};
use test;
CREATE TABLE test.testbug (     key blob,     column1 blob,     value blob,     PRIMARY KEY (key, column1) ) WITH COMPACT STORAGE     AND CLUSTERING ORDER BY (column1 ASC)     AND bloom_filter_fp_chance = 0.01     AND caching = &apos;{&quot;keys&quot;:&quot;ALL&quot;, &quot;rows_per_partition&quot;:&quot;NONE&quot;}&apos;     AND comment = &apos;&apos;     AND compaction = {&apos;min_threshold&apos;: &apos;4&apos;, &apos;class&apos;: &apos;org.apache.cassandra.db.compaction.SizeTieredCompactionStrategy&apos;, &apos;max_threshold&apos;: &apos;32&apos;}     AND compression = {&apos;sstable_compression&apos;: &apos;org.apache.cassandra.io.compress.LZ4Compressor&apos;}     AND dclocal_read_repair_chance = 0.1     AND default_time_to_live = 0     AND gc_grace_seconds = 864000     AND max_index_interval = 2048     AND memtable_flush_period_in_ms = 0     AND min_index_interval = 128     AND read_repair_chance = 1.0     AND speculative_retry = &apos;NONE&apos;;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then I injected the json as follows on the commandline:&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;json2sstable -K test -c testbug testcase.json DATADIR/test/testbug/test-testbug-ka-1-Data.db
nodetool refresh test testbug
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;The cqlsh then behaves as reported earlier, where querying for row &quot;test&quot; behaves as expected, but for row &quot;broken&quot; we don&apos;t get any data when we ask for columns that don&apos;t exist in that row (depending on the exact set of asked for columns, either &apos;metadata&apos; is dropped, or no data is returned at all):&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;cqlsh:test&amp;gt; select blobAsText(key),blobAsText(column1) from testbug where key=textAsBlob(&apos;test&apos;) and column1 in (textAsBlob(&apos;metadata&apos;),textAsBlob(&apos;bucket/0&apos;));

 blobAsText(key) | blobAsText(column1)
-----------------+---------------------
            test |            bucket/0
            test |            metadata

(2 rows)
cqlsh:test&amp;gt; select blobAsText(key),blobAsText(column1) from testbug where key=textAsBlob(&apos;broken&apos;) and column1 in (textAsBlob(&apos;metadata&apos;),textAsBlob(&apos;bucket/0&apos;));

 blobAsText(key) | blobAsText(column1)
-----------------+---------------------
          broken |            bucket/0
          broken |            metadata

(2 rows)
cqlsh:test&amp;gt; select blobAsText(key),blobAsText(column1) from testbug where key=textAsBlob(&apos;test&apos;) and column1 in (textAsBlob(&apos;metadata&apos;),textAsBlob(&apos;bucket/0&apos;),textAsBlob(&apos;bucket/1&apos;),textAsBlob(&apos;bucket/2&apos;),textAsBlob(&apos;asdfasdf&apos;));

 blobAsText(key) | blobAsText(column1)
-----------------+---------------------
            test |            bucket/0
            test |            metadata

(2 rows)
cqlsh:test&amp;gt; select blobAsText(key),blobAsText(column1) from testbug where key=textAsBlob(&apos;broken&apos;) and column1 in (textAsBlob(&apos;metadata&apos;),textAsBlob(&apos;bucket/0&apos;),textAsBlob(&apos;bucket/1&apos;),textAsBlob(&apos;bucket/2&apos;),textAsBlob(&apos;asdfasdf&apos;));

 key | column1 | value
-----+---------+-------

(0 rows)
cqlsh:test&amp;gt; select blobAsText(key),blobAsText(column1) from testbug where key=textAsBlob(&apos;broken&apos;) and column1 in (textAsBlob(&apos;metadata&apos;),textAsBlob(&apos;bucket/0&apos;),textAsBlob(&apos;bucket/1&apos;));

 blobAsText(key) | blobAsText(column1)
-----------------+---------------------
          broken |            bucket/0

(1 rows)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="14572973" author="mathijs" created="Thu, 4 Jun 2015 15:25:17 +0000"  >&lt;p&gt;Another observation: when testing this bug from our java code with the datastax cql driver, we notice that while the written data is still in the memtable, everything works correctly. Once its flushed to an SSTable on disk, the unpredictable behavior starts. Maybe this bug is another argument for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-9161&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;https://issues.apache.org/jira/browse/CASSANDRA-9161&lt;/a&gt; ?&lt;/p&gt;</comment>
                            <comment id="14573093" author="mathijs" created="Thu, 4 Jun 2015 16:32:58 +0000"  >&lt;p&gt;And one final observation from our testing: it seems the bug happens as soon as a cell value exceeds 64kb in size. (My earlier comment was wrong, there were 144,000 2-byte hex chars in the json file, so the cell size is roughly 70kb instead of 144kb).&lt;/p&gt;

&lt;p&gt;This bug is very difficult for us to work around (we&apos;re using the IN query as a replacement for the former thrift slice query to get specific column values), as we currently can not trust cassandra to return values that we wrote into it earlier, depending on whether our queried columns are present or not. If there&apos;s any workaround how we can query a set of columns using CQL that works, please let me know.&lt;/p&gt;</comment>
                            <comment id="14578961" author="carlyeks" created="Tue, 9 Jun 2015 14:22:50 +0000"  >&lt;p&gt;If the column name isn&apos;t found while searching the index, we advance both on disk and the columns we&apos;re searching for. We should only be advancing the columns we&apos;re searching since that atom may match a later column name.&lt;/p&gt;</comment>
                            <comment id="14580913" author="beobal" created="Wed, 10 Jun 2015 18:22:08 +0000"  >&lt;p&gt;The patch lgtm, is there any chance you could add a unit or dtest?&lt;/p&gt;</comment>
                            <comment id="14599670" author="carlyeks" created="Wed, 24 Jun 2015 16:20:18 +0000"  >&lt;p&gt;I just pushed &lt;a href=&quot;https://github.com/carlyeks/cassandra/commit/47ba6c301dd4fd1043409ff7ef4c604707833f4f&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a test&lt;/a&gt; which fails on the 2.1 branch but succeeds with this patch.&lt;/p&gt;</comment>
                            <comment id="14600910" author="beobal" created="Thu, 25 Jun 2015 09:11:26 +0000"  >&lt;p&gt;thanks, committed to 2.1 in &lt;tt&gt;d6c37bdd18b2632ea9093f2422a0cfa723e36b96&lt;/tt&gt; and merged&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[carlyeks]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 21 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i2fkzr:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311421" key="com.atlassian.jira.plugin.system.customfieldtypes:multiversion">
                        <customfieldname>Reproduced In</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12329874">2.1.5</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>samt</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[samt]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328841">2.1.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>