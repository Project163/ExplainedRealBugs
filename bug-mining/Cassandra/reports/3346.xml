<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:50:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-8580] AssertionErrors after activating unchecked_tombstone_compaction with leveled compaction</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-8580</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;During our upgrade of Cassandra from version 2.0.7 to 2.1.2 we experienced a serious problem regarding the setting unchecked_tombstone_compaction in combination with leveled compaction strategy.&lt;/p&gt;

&lt;p&gt;In order to prevent tombstone-threshold-warnings we activated the setting for a specific table after the upgrade. Some time after that we observed new errors in our log files:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;INFO  [CompactionExecutor:184] 2014-12-11 12:36:06,597 CompactionTask.java:136 - Compacting [SSTableReader(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/data/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-ka-1848-Data.db&apos;&lt;/span&gt;), SSTableReader(path=&apos;/
data/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-ka-1847-Data.db&lt;span class=&quot;code-quote&quot;&gt;&apos;), SSTableReader(path=&apos;&lt;/span&gt;/data/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-ka-1845-Data.db&apos;), SSTableReader
(path=&lt;span class=&quot;code-quote&quot;&gt;&apos;/data/cassandra/data/system/compactions_in_progress/system-compactions_in_progress-ka-1846-Data.db&apos;&lt;/span&gt;)]
ERROR [CompactionExecutor:183] 2014-12-11 12:36:06,613 CassandraDaemon.java:153 - Exception in thread &lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;[CompactionExecutor:183,1,main]
java.lang.AssertionError: /data/cassandra/data/metrigo_prod/new_user_data/metrigo_prod-new_user_data-tmplink-ka-705732-Data.db
        at org.apache.cassandra.io.sstable.SSTableReader.getApproximateKeyCount(SSTableReader.java:243) ~[apache-cassandra-2.1.2.jar:2.1.2]
        at org.apache.cassandra.db.compaction.CompactionTask.runWith(CompactionTask.java:146) ~[apache-cassandra-2.1.2.jar:2.1.2]
        at org.apache.cassandra.io.util.DiskAwareRunnable.runMayThrow(DiskAwareRunnable.java:48) ~[apache-cassandra-2.1.2.jar:2.1.2]
        at org.apache.cassandra.utils.WrappedRunnable.run(WrappedRunnable.java:28) ~[apache-cassandra-2.1.2.jar:2.1.2]
        at org.apache.cassandra.db.compaction.CompactionTask.executeInternal(CompactionTask.java:75) ~[apache-cassandra-2.1.2.jar:2.1.2]
        at org.apache.cassandra.db.compaction.AbstractCompactionTask.execute(AbstractCompactionTask.java:59) ~[apache-cassandra-2.1.2.jar:2.1.2]
        at org.apache.cassandra.db.compaction.CompactionManager$BackgroundCompactionTask.run(CompactionManager.java:232) ~[apache-cassandra-2.1.2.jar:2.1.2]
        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:471) ~[na:1.7.0_45]
        at java.util.concurrent.FutureTask.run(FutureTask.java:262) ~[na:1.7.0_45]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_45]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [na:1.7.0_45]
        at java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:744) [na:1.7.0_45]
        &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Obviously that error aborted the compaction and after some time the number of pending compactions became very high on every node. Of course, this in turn had a negative impact on several other metrics.&lt;/p&gt;

&lt;p&gt;After reverting the setting we had to restart all nodes. After that compactions could finish again and the pending compactions could be worked off.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12765749">CASSANDRA-8580</key>
            <summary>AssertionErrors after activating unchecked_tombstone_compaction with leveled compaction</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="marcuse">Marcus Eriksson</assignee>
                                    <reporter username="Hachmann">Bj&#246;rn Hachmann</reporter>
                        <labels>
                            <label>lcs</label>
                    </labels>
                <created>Thu, 8 Jan 2015 12:03:08 +0000</created>
                <updated>Tue, 16 Apr 2019 09:31:24 +0000</updated>
                            <resolved>Thu, 22 Jan 2015 14:52:31 +0000</resolved>
                                        <fixVersion>2.1.3</fixVersion>
                                    <component>Local/Compaction</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="14269279" author="krummas" created="Thu, 8 Jan 2015 13:06:51 +0000"  >&lt;p&gt;Could you post more of the log leading up to the exception? Want to see a line like &quot;... Compacting &lt;span class=&quot;error&quot;&gt;&amp;#91;SSTableReader(path=&amp;#39;/data/cassandra/data/metrigo_prod/new_user_data/metrigo_prod-new_user_data-tmplink-ka-705732-Data.db&amp;#39;&amp;#93;&lt;/span&gt;&quot;&lt;/p&gt;</comment>
                            <comment id="14273386" author="hachmann" created="Mon, 12 Jan 2015 08:15:10 +0000"  >&lt;p&gt;Please find attached a 12h extract from our log files from the 11.Dec. &lt;/p&gt;

&lt;p&gt;The error suddenly occurs repeatedly (starting from 11:15). After restarting the node (at 14:45) the error disappears, but later on the following day (not shown in the log file) reappears.&lt;/p&gt;</comment>
                            <comment id="14273584" author="krummas" created="Mon, 12 Jan 2015 13:22:13 +0000"  >&lt;p&gt;Are you sure you are only seeing this when enabling the unchecked_tombstone_compaction flag?&lt;/p&gt;</comment>
                            <comment id="14273602" author="hachmann" created="Mon, 12 Jan 2015 13:49:36 +0000"  >&lt;p&gt;Yes, I am quite sure, at least it seemed so. &lt;/p&gt;

&lt;p&gt;The errors started to occur some time after I have enabled the setting. After some futile investigations I disabled again. Then I wondered why the rollback did not seem to have the desired effect, but after restarting every node, the errors disappeared.&lt;/p&gt;

&lt;p&gt;Of course it could have been an unfortunate coincidence.&lt;/p&gt;</comment>
                            <comment id="14273754" author="benedict" created="Mon, 12 Jan 2015 16:41:46 +0000"  >&lt;p&gt;I managed to reproduce this with a slight bug consistently locally todat with ColumnFaimlyStoreTest. Unfortunately it seems to have been a wild goose chase tracking down the cause; testRemoveUnfinishedCompactionLeftovers deletes a stats file, and this file was then consistently missing. Strangely, though, it only occurred if DataTracker.releaseReferences did NOT release the final reference to sstables, but I have stopped looking further after spending quite a bit of time on it, since this was a deliberate corruption of the files for the unit test. I post here only in case it helps understand the cause, given the reference release interplay, although I expect it won&apos;t.&lt;/p&gt;</comment>
                            <comment id="14277033" author="benedict" created="Wed, 14 Jan 2015 15:18:10 +0000"  >&lt;p&gt;I&apos;ve gone a little buzz-eyed looking at this today, so I&apos;ll take another look in a couple of days. There are a number of weird things going on, but the weirdest is that the file we are failing on &lt;em&gt;has already been compacted&lt;/em&gt;. This should really have resulted in an assertion error much earlier on. There are a few things we can do in this area at least to reduce the likelihood of problems here, and to improve logging, but the interleavings of events that causes this seem likely to be convoluted, and may require these steps first in order to help narrow the state space we need to search in the code.&lt;/p&gt;</comment>
                            <comment id="14283609" author="william" created="Tue, 20 Jan 2015 08:56:03 +0000"  >&lt;p&gt;We are seeing this on 3 nodes in a 6 node cluster when adding the property &apos;cold_reads_to_omit&apos;: &apos;0.0&apos; to a table with LeveledCompactionStrategy. There was no load aside from compaction when the change happened.&lt;/p&gt;</comment>
                            <comment id="14283617" author="krummas" created="Tue, 20 Jan 2015 09:00:54 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=william&quot; class=&quot;user-hover&quot; rel=&quot;william&quot;&gt;william&lt;/a&gt; could you post the logs?&lt;/p&gt;</comment>
                            <comment id="14283633" author="william" created="Tue, 20 Jan 2015 09:32:04 +0000"  >&lt;p&gt;Attached log from one of the nodes. The exception starts occurring at about 08.30, shortly after the cold_reads_to_omit property was updated.&lt;/p&gt;

&lt;p&gt;The system started clean and had some load from 9 PM to 1AM. We did the change as some nodes had lots of pending compactions but no compactions running. We ended up with these exceptions and one node without exceptions that had hundreds of SSTables of approx ~380 MB, but no pending compactions.&lt;/p&gt;</comment>
                            <comment id="14283645" author="krummas" created="Tue, 20 Jan 2015 09:48:33 +0000"  >&lt;p&gt;Thanks, and it seems I can repro, an alter table while we are doing compactions (and having a tmplink file on disk) triggers this, I&apos;ll dig some more. Restarting the node should fix the issue for now&lt;/p&gt;</comment>
                            <comment id="14283667" author="krummas" created="Tue, 20 Jan 2015 10:17:23 +0000"  >&lt;p&gt;when refreshing the compaction strategy we blindly added all files in the cfs, and since tmplink files are in cfs, they were wrongly added to the compaction strategy and then included in compactions&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=iamaleksey&quot; class=&quot;user-hover&quot; rel=&quot;iamaleksey&quot;&gt;iamaleksey&lt;/a&gt; to review since you reviewed the WrappingCompactionStrategy stuff&lt;/p&gt;</comment>
                            <comment id="14287454" author="iamaleksey" created="Thu, 22 Jan 2015 14:04:22 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="14287533" author="krummas" created="Thu, 22 Jan 2015 14:52:31 +0000"  >&lt;p&gt;committed, thanks&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                            <attachment id="12693276" name="0001-make-sure-we-don-t-add-tmplink-files-to-the-compacti.patch" size="1432" author="marcuse" created="Tue, 20 Jan 2015 10:17:23 +0000"/>
                            <attachment id="12691609" name="system.log" size="2392465" author="Hachmann" created="Mon, 12 Jan 2015 08:15:10 +0000"/>
                            <attachment id="12693274" name="system_omit_cold_reads_at_approx_0830.log" size="7639566" author="william-saar" created="Tue, 20 Jan 2015 09:32:04 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>3.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[marcuse]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            10 years, 43 weeks, 5 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i242sf:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aleksey</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12328841">2.1.2</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </customfields>
    </item>
</channel>
</rss>