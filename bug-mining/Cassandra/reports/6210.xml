<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:26:57 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-18359] NullPointerException on SnapshotLoader.loadSnapshots</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-18359</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Node startup fail with on 4.1.1:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;INFO [main] 2023-03-23 18:13:13,585 MigrationCoordinator.java:257 - Starting migration coordinator and scheduling pulling schema versions every PT1M
ERROR [main] 2023-03-23 18:13:13,592 CassandraDaemon.java:898 - Exception encountered during startup
java.lang.NullPointerException: null
	at org.apache.cassandra.service.snapshot.SnapshotLoader$Visitor.preVisitDirectory(SnapshotLoader.java:106)
	at org.apache.cassandra.service.snapshot.SnapshotLoader$Visitor.preVisitDirectory(SnapshotLoader.java:77)
	at java.base/java.nio.file.Files.walkFileTree(Files.java:2732)
	at org.apache.cassandra.service.snapshot.SnapshotLoader.loadSnapshots(SnapshotLoader.java:162)
	at org.apache.cassandra.service.snapshot.SnapshotManager.loadSnapshots(SnapshotManager.java:114)
	at org.apache.cassandra.service.snapshot.SnapshotManager.start(SnapshotManager.java:88)
	at org.apache.cassandra.service.StorageService.startSnapshotManager(StorageService.java:1050)
	at org.apache.cassandra.service.StorageService.prepareToJoin(StorageService.java:1043)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:842)
	at org.apache.cassandra.service.StorageService.initServer(StorageService.java:775)
	at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:425)
	at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:752)
	at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:876)
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13529865">CASSANDRA-18359</key>
            <summary>NullPointerException on SnapshotLoader.loadSnapshots</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="smiklosovic">Stefan Miklosovic</assignee>
                                    <reporter username="paulo">Paulo Motta</reporter>
                        <labels>
                    </labels>
                <created>Thu, 23 Mar 2023 21:08:35 +0000</created>
                <updated>Tue, 12 Sep 2023 13:02:57 +0000</updated>
                            <resolved>Sun, 26 Mar 2023 21:37:20 +0000</resolved>
                                        <fixVersion>4.1.2</fixVersion>
                    <fixVersion>5.0-alpha1</fixVersion>
                    <fixVersion>5.0</fixVersion>
                                    <component>Local/Snapshots</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>2</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="2400">40m</timespent>
                                <comments>
                            <comment id="17704372" author="paulo" created="Thu, 23 Mar 2023 21:53:10 +0000"  >&lt;p&gt;Issue seems to be on&#160;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1.1/src/java/org/apache/cassandra/service/snapshot/SnapshotLoader.java#L106&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this check&lt;/a&gt; as pointed out by &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=brandon.williams&quot; class=&quot;user-hover&quot; rel=&quot;brandon.williams&quot;&gt;brandon.williams&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=stefan.miklosovic&quot; class=&quot;user-hover&quot; rel=&quot;stefan.miklosovic&quot;&gt;stefan.miklosovic&lt;/a&gt; I suspect this would only happen when &lt;tt&gt;data_file_directories: /&lt;/tt&gt;, which is an odd choice but still valid. We probably need to add a null check here.&lt;/p&gt;

&lt;p&gt;I wonder if &lt;tt&gt;if (subdir.getParent().getFileName().toString().equals(SNAPSHOT_SUBDIR))&lt;/tt&gt; could run into permissioning issues if the user does not have permissions to access the parent directory of {{&lt;tt&gt;data_file_directories&lt;/tt&gt;{}}}&lt;/p&gt;</comment>
                            <comment id="17704376" author="smiklosovic" created="Thu, 23 Mar 2023 22:17:34 +0000"  >&lt;p&gt;I verified upgrade from 3.11.15 to 4.1.1 works. &lt;/p&gt;

&lt;p&gt;1. start 3.11.15-SNAPSHOT&lt;br/&gt;
2. create table and insert data&lt;br/&gt;
3. create snapshot&lt;br/&gt;
4. copy data dir to empty data dir of 4.1.1&lt;br/&gt;
5. start 4.1.1&lt;/p&gt;

&lt;p&gt;it just starts fine (minus some configuration around num_tokens, irrelevant to this ticket).&lt;/p&gt;

&lt;p&gt;Paulo is right that if subdir is &quot;/&quot;, the getParent() returns null. &lt;/p&gt;

&lt;p&gt;We do not have any feedback from the user yet to confirm this theory but &quot;normal upgrade path with standard data directories&quot; seems to work just ok.&lt;/p&gt;</comment>
                            <comment id="17704546" author="smiklosovic" created="Fri, 24 Mar 2023 09:47:52 +0000"  >&lt;p&gt;PR is here &lt;a href=&quot;https://github.com/apache/cassandra/pull/2243&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2243&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It also throws NPE if dir is e.g &quot;/data&quot; which makes this more serious. The workaround is to set data_file_directories like&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
data_file_directories:
    - /data/data
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;and move all tables data from /data to /data/data.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=paulo&quot; class=&quot;user-hover&quot; rel=&quot;paulo&quot;&gt;paulo&lt;/a&gt; I think that we should make setting one of dirs to &quot;/&quot; illegal. It does not make sense. If we were to scan all dirs in / for snapshots, we would basically have to traverse whole filesystem. That is dangerous, time consuming, error prone on ownership etc etc.&lt;/p&gt;

&lt;p&gt;Similar exception is thrown in case it is set to &quot;/&quot; already here (it has nothing to do with snapshots)&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/service/StartupChecks.java#L573&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/blob/cassandra-4.1/src/java/org/apache/cassandra/service/StartupChecks.java#L573&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
spark_master_1 &#160;| Exception (java.lang.NullPointerException) encountered during startup: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
spark_master_1 &#160;| java.lang.NullPointerException
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.StartupChecks$12$1.preVisitDirectory(StartupChecks.java:573)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.StartupChecks$12$1.preVisitDirectory(StartupChecks.java:548)
spark_master_1 &#160;| &#160; &#160; at java.base/java.nio.file.Files.walkFileTree(Files.java:2732)
spark_master_1 &#160;| &#160; &#160; at java.base/java.nio.file.Files.walkFileTree(Files.java:2797)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.StartupChecks$12.execute(StartupChecks.java:586)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.StartupChecks.verify(StartupChecks.java:174)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.CassandraDaemon.runStartupChecks(CassandraDaemon.java:502)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:256)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:751)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:875)
spark_master_1 &#160;| ERROR [main] 2023-03-24 11:37:56,843 CassandraDaemon.java:897 - Exception encountered during startup
spark_master_1 &#160;| java.lang.NullPointerException: &lt;span class=&quot;code-keyword&quot;&gt;null&lt;/span&gt;
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.StartupChecks$12$1.preVisitDirectory(StartupChecks.java:573)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.StartupChecks$12$1.preVisitDirectory(StartupChecks.java:548)
spark_master_1 &#160;| &#160; &#160; at java.base/java.nio.file.Files.walkFileTree(Files.java:2732)
spark_master_1 &#160;| &#160; &#160; at java.base/java.nio.file.Files.walkFileTree(Files.java:2797)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.StartupChecks$12.execute(StartupChecks.java:586)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.StartupChecks.verify(StartupChecks.java:174)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.CassandraDaemon.runStartupChecks(CassandraDaemon.java:502)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.CassandraDaemon.setup(CassandraDaemon.java:256)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.CassandraDaemon.activate(CassandraDaemon.java:751)
spark_master_1 &#160;| &#160; &#160; at org.apache.cassandra.service.CassandraDaemon.main(CassandraDaemon.java:875)
 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;EDIT: based on slack conversation, we should allow to set other dirs to &quot;/&quot;, but we still need to fix the exception above. Setting it to &quot;/&quot; as of now does not work either.&lt;/p&gt;</comment>
                            <comment id="17704684" author="paulo" created="Fri, 24 Mar 2023 16:09:59 +0000"  >&lt;blockquote&gt;&lt;p&gt;&#160; PR is here&#160;&lt;a href=&quot;https://github.com/apache/cassandra/pull/2243&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/pull/2243&lt;/a&gt;&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;+1&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;&#160; I think that we should make setting one of dirs to &quot;/&quot; illegal. It does not make sense. If we were to scan all dirs in / for snapshots, we would basically have to traverse whole filesystem. That is dangerous, time consuming, error prone on ownership etc etc.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I think settings data dirs to &quot;/&quot; is too esoteric to worry about.&lt;/p&gt;</comment>
                            <comment id="17705125" author="smiklosovic" created="Sun, 26 Mar 2023 20:43:22 +0000"  >&lt;p&gt;4.1 j8 precommit &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2026/workflows/0b58a217-9fc9-4960-a63d-726a9a09c3f2&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2026/workflows/0b58a217-9fc9-4960-a63d-726a9a09c3f2&lt;/a&gt;&lt;br/&gt;
4.1 j11 precommit &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2026/workflows/3cca3b04-afae-4fd7-9157-6f2f774926c1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2026/workflows/3cca3b04-afae-4fd7-9157-6f2f774926c1&lt;/a&gt;&lt;br/&gt;
trunk j8 precommit &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2027/workflows/8089bcf9-7614-444b-b7ac-e890f179ffdd&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2027/workflows/8089bcf9-7614-444b-b7ac-e890f179ffdd&lt;/a&gt;&lt;br/&gt;
trunk j11 &lt;a href=&quot;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2027/workflows/9e27534f-8993-48ca-9e1c-a9e56ace39d9&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/instaclustr/cassandra/2027/workflows/9e27534f-8993-48ca-9e1c-a9e56ace39d9&lt;/a&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[smiklosovic]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12964"><![CDATA[Low Hanging Fruit]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            2 years, 33 weeks, 2 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z1gtcw:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[paulo]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12352579">4.1.1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/4ac89e6451b2ab0e62c04e61c60ba760f6c10223&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/4ac89e6451b2ab0e62c04e61c60ba760f6c10223&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;changes.txt&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>