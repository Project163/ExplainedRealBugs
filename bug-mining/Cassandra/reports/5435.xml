<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:16:32 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15766] NoSpamLogger arguments building objects on hot paths</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15766</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;NoSpamLogger is used in hot logging paths to prevent logs being overrun. &#160;For that to be most effective the arguments to the logger need to be cheap to construct. &#160;During the internode messaging refactor &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15066&quot; title=&quot;Improvements to Internode Messaging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15066&quot;&gt;&lt;del&gt;CASSANDRA-15066&lt;/del&gt;&lt;/a&gt;, performance changes to BufferPool for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-14416&quot; title=&quot;Remove string formatting lines from hot path&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-14416&quot;&gt;&lt;del&gt;CASSANDRA-14416&lt;/del&gt;&lt;/a&gt;&lt;br/&gt;
were accidentally reverted in the merge up from 3.11.&lt;/p&gt;

&lt;p&gt;Reviewing other uses since, it looks like there are a few places where the arguments require some form of String building.&lt;/p&gt;

&lt;p&gt;org.apache.cassandra.net.InboundSink#accept&lt;br/&gt;
org.apache.cassandra.net.InboundMessageHandler#processCorruptFrame&lt;br/&gt;
org.apache.cassandra.net.InboundMessageHandler.LargeMessage#deserialize&lt;br/&gt;
org.apache.cassandra.net.OutboundConnection#onOverloaded&lt;br/&gt;
org.apache.cassandra.utils.memory.BufferPool.GlobalPool#allocateMoreChunks&lt;/p&gt;

&lt;p&gt;Formatting arguments should either be precomputed, or if expensive they should be computed after the decision on whether to noSpamLog has been made.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13301578">CASSANDRA-15766</key>
            <summary>NoSpamLogger arguments building objects on hot paths</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="maedhroz">Caleb Rackliffe</assignee>
                                    <reporter username="jmeredithco">Jon Meredith</reporter>
                        <labels>
                    </labels>
                <created>Tue, 28 Apr 2020 13:54:54 +0000</created>
                <updated>Wed, 16 Mar 2022 14:01:54 +0000</updated>
                            <resolved>Wed, 22 Jul 2020 12:52:42 +0000</resolved>
                                        <fixVersion>4.0-beta2</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Observability/Logging</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>9</watches>
                                                    <progress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </progress>
                                    <aggregateprogress percentage="100">
                                    <originalProgress>
                                                    <row percentage="0" backgroundColor="#89afd7"/>
                                                    <row percentage="100" backgroundColor="transparent"/>
                                            </originalProgress>
                                                    <currentProgress>
                                                    <row percentage="100" backgroundColor="#51a825"/>
                                                    <row percentage="0" backgroundColor="#ec8e00"/>
                                            </currentProgress>
                            </aggregateprogress>
                                            <timeestimate seconds="0">0h</timeestimate>
                            <timespent seconds="6600">1h 50m</timespent>
                                <comments>
                            <comment id="17098818" author="bereng" created="Mon, 4 May 2020 09:53:23 +0000"  >&lt;p&gt;Hi &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmeredithco&quot; class=&quot;user-hover&quot; rel=&quot;jmeredithco&quot;&gt;jmeredithco&lt;/a&gt; I fancy taking this one. Is that ok?&lt;/p&gt;</comment>
                            <comment id="17098933" author="jmeredithco" created="Mon, 4 May 2020 13:36:02 +0000"  >&lt;p&gt;I have a small prototype I was working on when I reported the issue that I should clean up. &#160;I wanted to get some feedback on it before posting the patch, but it probably doesn&apos;t need to wait. &#160;I&apos;ll try and push it up this morning.&lt;/p&gt;

&lt;p&gt;The idea was too check the list of objects passed as arguments to check if they were &lt;tt&gt;Supplier&lt;/tt&gt; s and automatically call get on them if they were. &#160;The downside would be anything that was already a supplier might need to be double-wrapped, but I think that&apos;s worth it. I also wanted to work out what the cost of wrapping things like&#160;&lt;tt&gt;org.apache.cassandra.net.InboundMessageHandler#id()&lt;/tt&gt; in a &lt;tt&gt;Supplier&lt;/tt&gt; versus just the call.&lt;/p&gt;</comment>
                            <comment id="17098960" author="bereng" created="Mon, 4 May 2020 14:06:26 +0000"  >&lt;p&gt;+1. Either a supplier approach or a &apos;shouldLog()&apos; check after getting a &lt;tt&gt;NoSpamLogStatement&lt;/tt&gt; where the 2 options I was playing with. I&apos;ll be happy to help with the review. No hurries.&lt;/p&gt;</comment>
                            <comment id="17099431" author="jmeredithco" created="Tue, 5 May 2020 00:01:21 +0000"  >&lt;p&gt;I&apos;ve pushed up my WIP, &lt;a href=&quot;https://github.com/jonmeredith/cassandra/tree/15766&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; &lt;a href=&quot;https://github.com/apache/cassandra/pull/582&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;and PR&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;Disassembling generated code, it looks like we trade eagerly constructing a new object array for an invoke dynamic call. I haven&apos;t had a chance to dig any more to compare the costs. I&apos;m interested what you think.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void simpleLog();
    Code:
       0: aload_0
       1: getfield      #7                  &lt;span class=&quot;code-comment&quot;&gt;// Field mock:Lorg/slf4j/Logger;
&lt;/span&gt;       4: getstatic     #11                 &lt;span class=&quot;code-comment&quot;&gt;// Field org/apache/cassandra/utils/NoSpamLogger$Level.INFO:Lorg/apache/cassandra/utils/NoSpamLogger$Level;
&lt;/span&gt;       7: lconst_1
       8: getstatic     #23                 &lt;span class=&quot;code-comment&quot;&gt;// Field java/util/concurrent/TimeUnit.NANOSECONDS:Ljava/util/concurrent/TimeUnit;
&lt;/span&gt;      11: ldc           #90                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; {}
&lt;/span&gt;      13: iconst_1
      14: anewarray     #26                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;java/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;
&lt;/span&gt;      17: dup
      18: iconst_0
      19: ldc           #91                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; param
&lt;/span&gt;      21: aastore
      22: invokestatic  #28                 &lt;span class=&quot;code-comment&quot;&gt;// Method org/apache/cassandra/utils/NoSpamLogger.log:(Lorg/slf4j/Logger;Lorg/apache/cassandra/utils/NoSpamLogger$Level;JLjava/util/concurrent/TimeUnit;Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;;[Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;Object&lt;/span&gt;;)Z
&lt;/span&gt;      25: pop
      26: &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;

  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void paramLog();
    Code:
       0: aload_0
       1: getfield      #7                  &lt;span class=&quot;code-comment&quot;&gt;// Field mock:Lorg/slf4j/Logger;
&lt;/span&gt;       4: getstatic     #11                 &lt;span class=&quot;code-comment&quot;&gt;// Field org/apache/cassandra/utils/NoSpamLogger$Level.INFO:Lorg/apache/cassandra/utils/NoSpamLogger$Level;
&lt;/span&gt;       7: lconst_1
       8: getstatic     #23                 &lt;span class=&quot;code-comment&quot;&gt;// Field java/util/concurrent/TimeUnit.NANOSECONDS:Ljava/util/concurrent/TimeUnit;
&lt;/span&gt;      11: ldc           #90                 &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; {}
&lt;/span&gt;      13: invokedynamic #92,  0             &lt;span class=&quot;code-comment&quot;&gt;// InvokeDynamic #1:get:()Ljava/util/function/Supplier;
&lt;/span&gt;      18: invokestatic  #82                 &lt;span class=&quot;code-comment&quot;&gt;// Method org/apache/cassandra/utils/NoSpamLogger.log:(Lorg/slf4j/Logger;Lorg/apache/cassandra/utils/NoSpamLogger$Level;JLjava/util/concurrent/TimeUnit;Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;;Ljava/util/function/Supplier;)Z
&lt;/span&gt;      21: pop
      22: &lt;span class=&quot;code-keyword&quot;&gt;return&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17099605" author="yifanc" created="Tue, 5 May 2020 07:34:08 +0000"  >&lt;p&gt;I have only done a quick glance at the patch.&lt;/p&gt;

&lt;p&gt;Essentially, it wraps any expensive computation within the lambda, so in the case of the log level not permits, no CPU cycles are wasted on computing the log arguments that are not going to be used. The trade-off is the wrapper,&#160;&lt;tt&gt;Supplier&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;Whether it is worthy or not. It depends on how expensive the unnecessary argument computation is. The computation itself may produce multiple intermediate objects.&#160;&lt;/p&gt;

&lt;p&gt;It would be great to have a benchmark to determine the how the lazy logging helps in the scenarios of 1) no computation, 2) light computation, 3) moderate computation and 4) heavy computation. So it serves the purpose of guidance on when to invoke the lazy logging and when to not.&#160;&lt;/p&gt;

&lt;p&gt;This patch only applies to the &lt;tt&gt;NoSpamLogger&lt;/tt&gt;. There are other logging statements that use normal logger in the code base that may have expensive argument computation. If the lazy impl is proven to have performance benefits, how about applying to those if any?&#160;&lt;/p&gt;

&lt;p&gt;The patch does what is wanted in&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15764&quot; title=&quot;Optimize logging with lazy log parameter evaluation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15764&quot;&gt;&lt;del&gt;CASSANDRA-15764&lt;/del&gt;&lt;/a&gt;. I will mark&#160;&lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15764&quot; title=&quot;Optimize logging with lazy log parameter evaluation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15764&quot;&gt;&lt;del&gt;CASSANDRA-15764&lt;/del&gt;&lt;/a&gt;&#160;as a dup and close once this one is completed.&#160;&lt;/p&gt;</comment>
                            <comment id="17099691" author="bereng" created="Tue, 5 May 2020 09:06:02 +0000"  >&lt;p&gt;Great, Jira lost my comment. Here we go again...&lt;/p&gt;

&lt;p&gt;I am a newbie here, so feel free to ignore me:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;I wonder why we don&apos;t defend with a &lt;tt&gt;wrapped.isLevelEnabled()&lt;/tt&gt; at &lt;tt&gt;NoSpamLogger&lt;/tt&gt; top methods. It might pay off given we&apos;d spare the many nested method calls, the &lt;tt&gt;getStatement()&lt;/tt&gt;, &lt;tt&gt;nanoTime()&lt;/tt&gt;, &lt;tt&gt;shouldLog()&lt;/tt&gt;,... calls&lt;/li&gt;
	&lt;li&gt;The &lt;tt&gt;Supplier&lt;/tt&gt; approach is very nice, I like it a lot.
	&lt;ul&gt;
		&lt;li&gt;If the overhead is negligible I would make that the only option. But given my, maybe outdated, experiences with streams, lambdas, etc I am going to bet it will be not :shrug:&lt;/li&gt;
		&lt;li&gt;If it were not I&apos;d rename top level methods as &lt;tt&gt;warnWithLazyParams()&lt;/tt&gt; and &lt;tt&gt;warnWithoutLazyParams()&lt;/tt&gt;. If the dev is educated enough to have opted for &lt;tt&gt;NoSpamLogger&lt;/tt&gt; sure he will make the right choice here. I don&apos;t think we can infer at call time which option is best, only the dev can.&lt;/li&gt;
	&lt;/ul&gt;
	&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;+1 to a general &apos;other logs audit&apos;. I would do it in another ticket as they won&apos;t be in the hot path, they should be &lt;tt&gt;NoSpamLogger&lt;/tt&gt; if they were, so that is not as &apos;urgent&apos; as this one imo.&lt;/p&gt;

&lt;p&gt;Hope it makes sense. My 2cts&lt;/p&gt;</comment>
                            <comment id="17099731" author="benedict" created="Tue, 5 May 2020 09:43:59 +0000"  >&lt;p&gt;Couldn&apos;t this be kept a bit more idiomatic with the provision of an object with a &lt;tt&gt;toString()&lt;/tt&gt;&#160;method that invokes &lt;tt&gt;id()&lt;/tt&gt; ? We could even have such an object instantiated once per &lt;tt&gt;InboundMessageHandler&lt;/tt&gt;&#160;and once per &lt;tt&gt;BufferPool&lt;/tt&gt;&#160;so that this is garbage-free for most cases, and continues to read like a normal logging call?&lt;/p&gt;

&lt;p&gt;I&apos;ve in the past considered introducing a special interface declaring only &lt;tt&gt;toString()&lt;/tt&gt;&#160;for declaring these via lambdas for each parameter, which might be a nice way to do this for &lt;tt&gt;InboundSink&lt;/tt&gt;.&lt;/p&gt;

&lt;p&gt;A secondary API&#160;might be to provide method parameter options that accept pairs of (param, function) so that e.g. &lt;tt&gt;InboundSink&lt;/tt&gt; can provide&#160;(t,&#160;&lt;tt&gt;Throwable::getMessage)&lt;/tt&gt;, and if we wanted &lt;tt&gt;InboundMessageHandler&lt;/tt&gt;&#160;could provide &lt;tt&gt;(this, InboundMessageHandler::id)&lt;/tt&gt;&lt;/p&gt;</comment>
                            <comment id="17100139" author="jmeredithco" created="Tue, 5 May 2020 17:57:10 +0000"  >&lt;p&gt;Thanks for the feedback. I was concerned it wasn&apos;t particularly idiomatic.&#160;&lt;/p&gt;

&lt;p&gt;My original design was to modify the actual log call to check if the statement should be logged, then checked if any of the format parameters were&#160;instances of&#160;&lt;tt&gt;Supplier&amp;lt;Object&amp;gt; and if so rebuild the parameter objects array calling&#160;&lt;/tt&gt;&lt;tt&gt;get()&lt;/tt&gt;&#160;where needed to retrieve the actual object before printing.&lt;/p&gt;

&lt;p&gt;I backed off from that as I thought that would be multiple invocations of lambdas rather than a single invocation for all arguments as well as copying/updating the objects array (although I suppose it would be safe to update in place assuming it was always called as a varargs). If you&apos;re going to pay the cost of the lambda, maybe only worth it once. I need to play with JMH to understand costs better.&lt;/p&gt;

&lt;p&gt;I&apos;ll have a go at something more idiomatic, but for cases like this it seems like a single lambda supplying all of the parameters would be more efficient.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; void onOverloaded(Message&amp;lt;?&amp;gt; message)
{
    overloadedCountUpdater.incrementAndGet(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;);
    &lt;span class=&quot;code-object&quot;&gt;int&lt;/span&gt; serializedSize = canonicalSize(message);
    overloadedBytesUpdater.addAndGet(&lt;span class=&quot;code-keyword&quot;&gt;this&lt;/span&gt;, serializedSize);
    noSpamLogger.warn(&lt;span class=&quot;code-quote&quot;&gt;&quot;{} overloaded; dropping {} message (queue: {} local, {} endpoint, {} global)&quot;&lt;/span&gt;,
                      lazyId,
                      FBUtilities.prettyPrintMemory(serializedSize),
                      FBUtilities.prettyPrintMemory(pendingBytes()),
                      FBUtilities.prettyPrintMemory(reserveCapacityInBytes.endpoint.using()),
                      FBUtilities.prettyPrintMemory(reserveCapacityInBytes.global.using()));
    callbacks.onOverloaded(message, template.to);
} &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17100159" author="yifanc" created="Tue, 5 May 2020 18:14:13 +0000"  >&lt;p&gt;There might not be a big difference between multiple and single lambda. The lambda is compiled into a static method in the bytecode view. If in the hot path and JIT kicked in, the static method could be even inlined.&#160;&lt;/p&gt;

&lt;p&gt;Consider the following code&lt;br/&gt;
&#160;&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;import&lt;/span&gt; java.util.function.Supplier;

&lt;span class=&quot;code-keyword&quot;&gt;class &lt;/span&gt;Foo {
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void foo() {
    comsume(() -&amp;gt; &lt;span class=&quot;code-quote&quot;&gt;&quot;foo&quot;&lt;/span&gt;);
  }  
  &lt;span class=&quot;code-keyword&quot;&gt;public&lt;/span&gt; void comsume(Supplier&amp;lt;&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;&amp;gt; supp) {
    supp.get();
  }
}
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Running &lt;tt&gt;javap -v -p Foo.class&lt;/tt&gt; reveals the below.&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
  &lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;static&lt;/span&gt; java.lang.&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; lambda$foo$0();
    descriptor: ()Ljava/lang/&lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt;;
    flags: ACC_PRIVATE, ACC_STATIC, ACC_SYNTHETIC
    Code:
      stack=1, locals=0, args_size=0
         0: ldc           #5                  &lt;span class=&quot;code-comment&quot;&gt;// &lt;span class=&quot;code-object&quot;&gt;String&lt;/span&gt; foo
&lt;/span&gt;         2: areturn
      LineNumberTable:
        line 5: 0&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17100210" author="benedict" created="Tue, 5 May 2020 19:28:08 +0000"  >&lt;blockquote&gt;&lt;p&gt;The lambda is compiled into a static method in the byte code&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;This is only true of non-capturing lambdas&lt;/p&gt;

&lt;p&gt;edit: actually, I&apos;m not sure what you mean here - the method &lt;em&gt;body&lt;/em&gt; will be compiled to a static method, but the lambda will also behave like a static &lt;em&gt;property&lt;/em&gt; if it captures no variables.&lt;/p&gt;

&lt;p&gt;In many cases, though, even a lambda that must be allocated may be elided entirely if the method you pass it to is inlined, and escape analysis can do its magic - but there are a lot of &apos;ifs&apos; there.&lt;/p&gt;</comment>
                            <comment id="17100214" author="yifanc" created="Tue, 5 May 2020 19:47:27 +0000"  >&lt;p&gt;Agree that there are many &apos;if&apos;s.&#160;&lt;/p&gt;

&lt;p&gt;What a lambda is compiled into depends on the java compiler. For a capturing lambda, it can still be a static method with the expanded param list. (off topic)&lt;/p&gt;

&lt;p&gt;At the end, we need to run benchmark to quantitively measure the difference.&lt;/p&gt;</comment>
                            <comment id="17139911" author="jmckenzie" created="Thu, 18 Jun 2020 18:30:13 +0000"  >&lt;p&gt;Do we know how heavy / prevalent these calls are on a flame graph?&lt;/p&gt;</comment>
                            <comment id="17140005" author="jmeredithco" created="Thu, 18 Jun 2020 21:50:57 +0000"  >&lt;p&gt;We don&apos;t currently. The original regression was spotted by code inspection rather than profiling, as were the other candidates mentioned in the original description. I think it&apos;s a fair observation that we should have a quantitive measure of the improvement.&lt;/p&gt;

&lt;p&gt;I&apos;ve also noticed this was tagged as 4.0-rc and moved this back to the 4.0-beta milestone for now. It may be possible to slip this, though the original changes were made due to operational issues that made the change important.&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;

&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17140024" author="dcapwell" created="Thu, 18 Jun 2020 22:23:53 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmeredithco&quot; class=&quot;user-hover&quot; rel=&quot;jmeredithco&quot;&gt;jmeredithco&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmckenzie&quot; class=&quot;user-hover&quot; rel=&quot;jmckenzie&quot;&gt;jmckenzie&lt;/a&gt;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi&quot; class=&quot;user-hover&quot; rel=&quot;djoshi&quot;&gt;djoshi&lt;/a&gt; found a regression in networking that was fixed by Jeff in 3.x; checking latest trunk I don&apos;t see it fixed... &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=djoshi&quot; class=&quot;user-hover&quot; rel=&quot;djoshi&quot;&gt;djoshi&lt;/a&gt; did you file? prettyPrintMemory gets called in the hot path&lt;/p&gt;</comment>
                            <comment id="17140037" author="jmeredithco" created="Thu, 18 Jun 2020 22:42:16 +0000"  >&lt;p&gt;Oh yeah, forgot that&apos;s how it went down - thanks for the reminder &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=dcapwell&quot; class=&quot;user-hover&quot; rel=&quot;dcapwell&quot;&gt;dcapwell&lt;/a&gt;. &#160;This was the Jira I filed after it was found.&lt;/p&gt;</comment>
                            <comment id="17157149" author="maedhroz" created="Tue, 14 Jul 2020 05:04:03 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=jmeredithco&quot; class=&quot;user-hover&quot; rel=&quot;jmeredithco&quot;&gt;jmeredithco&lt;/a&gt; I&apos;m considering taking this over after taking a quick look at the WIP and history behind the ticket (and dropping a &lt;a href=&quot;https://github.com/apache/cassandra/pull/582/files#r454099460&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;quick question&lt;/a&gt; in the PR). For what it&apos;s worth, I probably wouldn&apos;t expand the scope beyond what&apos;s already been touched...to the extent I might unmark &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15764&quot; title=&quot;Optimize logging with lazy log parameter evaluation&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15764&quot;&gt;&lt;del&gt;CASSANDRA-15764&lt;/del&gt;&lt;/a&gt; as a duplicate.&lt;/p&gt;

&lt;p&gt;Any objections?&lt;/p&gt;</comment>
                            <comment id="17157457" author="jmeredithco" created="Tue, 14 Jul 2020 15:25:39 +0000"  >&lt;p&gt;It&apos;s fairly buried in my task list so if you&apos;re able to take it that would be great &#8211;&#160;I should have just let &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=Bereng&quot; class=&quot;user-hover&quot; rel=&quot;bereng&quot;&gt;Bereng&lt;/a&gt;&#160;take it - apologies.&lt;/p&gt;</comment>
                            <comment id="17157460" author="bereng" created="Tue, 14 Jul 2020 15:32:27 +0000"  >&lt;p&gt;Yeah that one was on my list, no worries. I&apos;ll be busy a while on a 4.0 quality ticket. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=maedhroz&quot; class=&quot;user-hover&quot; rel=&quot;maedhroz&quot;&gt;maedhroz&lt;/a&gt; feel free otherwise I&apos;ll steal it back from you when I finish lol&lt;/p&gt;</comment>
                            <comment id="17160336" author="maedhroz" created="Sat, 18 Jul 2020 05:47:07 +0000"  >&lt;p&gt;Finished a first draft that stays pretty close to the original scope/description. I&apos;ve left inline comments in the PR to clarify the reasoning behind some decisions.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/pull/685&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;patch&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/63/workflows/aea6888d-a6fd-42d0-9efe-81b15420d96a&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java 8 CircleCI&lt;/a&gt;, &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/63/workflows/c820bade-6073-4f36-b2fb-6abac7dd2532&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Java 11 CircleCI&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17160783" author="jasonstack" created="Sun, 19 Jul 2020 18:19:44 +0000"  >&lt;p&gt;LGTM&lt;/p&gt;</comment>
                            <comment id="17160805" author="maedhroz" created="Sun, 19 Jul 2020 19:45:10 +0000"  >&lt;p&gt;The issue w/ &lt;tt&gt;id()&lt;/tt&gt; being called for no reason in &lt;tt&gt;OutboundConnection&lt;/tt&gt; was also identified in &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15700&quot; title=&quot;Performance regression on internode messaging&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15700&quot;&gt;&lt;del&gt;CASSANDRA-15700&lt;/del&gt;&lt;/a&gt;, apparently.&lt;/p&gt;</comment>
                            <comment id="17160897" author="maedhroz" created="Mon, 20 Jul 2020 05:15:33 +0000"  >&lt;p&gt;Just a quick summary of where we are with the tests...&lt;/p&gt;

&lt;p&gt;In the Java 11 tests, it looks like we&apos;ve hit &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15861&quot; title=&quot;Mutating sstable component may race with entire-sstable-streaming(ZCS) causing checksum validation failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15861&quot;&gt;&lt;del&gt;CASSANDRA-15861&lt;/del&gt;&lt;/a&gt; (&lt;tt&gt;TestRepair:: test_dead_sync_initiator&lt;/tt&gt;). The other 2 failures look like timeouts, something we could resolve with &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/63/workflows/69be5c1b-f43e-4632-a146-29d546ab659d&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a quick rerun&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;In the Java 8 tests, the failure in &lt;tt&gt;TestBootstrap&lt;/tt&gt; has been &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15854?focusedCommentId=17142442&amp;amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17142442&quot; class=&quot;external-link&quot; rel=&quot;nofollow&quot;&gt;seen elsewhere&lt;/a&gt;, so is almost certainly unrelated. &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15861&quot; title=&quot;Mutating sstable component may race with entire-sstable-streaming(ZCS) causing checksum validation failure&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15861&quot;&gt;&lt;del&gt;CASSANDRA-15861&lt;/del&gt;&lt;/a&gt; is showing up as well. The interesting failure is &lt;tt&gt;TestDiskBalance::test_disk_balance_after_boundary_change_stcs&lt;/tt&gt;, although I haven&apos;t been able to reproduce a failure locally. Let&apos;s see what &lt;a href=&quot;https://app.circleci.com/pipelines/github/maedhroz/cassandra/63/workflows/99e45f4b-c7ae-4a46-8fc3-2e2466f833ed&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;a rerun&lt;/a&gt; looks like...&lt;/p&gt;</comment>
                            <comment id="17161532" author="maedhroz" created="Mon, 20 Jul 2020 20:53:37 +0000"  >&lt;p&gt;The J11 rerun is hitting &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15892&quot; title=&quot;JAVA 8/11: test_resumable_rebuild - rebuild_test.TestRebuild&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15892&quot;&gt;&lt;del&gt;CASSANDRA-15892&lt;/del&gt;&lt;/a&gt; (&lt;tt&gt;test_resumable_rebuild&lt;/tt&gt;), &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-13805&quot; title=&quot;dtest failure: repair_tests.repair_test.TestRepair.simple_parallel_repair_test&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-13805&quot;&gt;&lt;del&gt;CASSANDRA-13805&lt;/del&gt;&lt;/a&gt; (&lt;tt&gt;test_simple_parallel_repair&lt;/tt&gt;), and maybe even &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-15299&quot; title=&quot;CASSANDRA-13304 follow-up: improve checksumming and compression in protocol v5-beta&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-15299&quot;&gt;&lt;del&gt;CASSANDRA-15299&lt;/del&gt;&lt;/a&gt;. It&apos;s unlikely any of these is being caused by the patch. (The issue w/ &lt;tt&gt;SimpleReadWriteTest&lt;/tt&gt; looks JVM related.)&lt;/p&gt;

&lt;p&gt;The J8 rerun looks clean, modulo the known issues already mentioned above.&lt;/p&gt;</comment>
                            <comment id="17162768" author="iamaleksey" created="Wed, 22 Jul 2020 12:47:52 +0000"  >&lt;p&gt;LGTM as well, will commit shortly.&lt;/p&gt;</comment>
                            <comment id="17162772" author="iamaleksey" created="Wed, 22 Jul 2020 12:52:17 +0000"  >&lt;p&gt;Committed to trunk as &lt;a href=&quot;https://github.com/apache/cassandra/commit/1266fec349e76b964b522d11460f1df4adadcb48&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1266fec349e76b964b522d11460f1df4adadcb48&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17162876" author="maedhroz" created="Wed, 22 Jul 2020 15:05:45 +0000"  >&lt;p&gt;Thanks, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aleksey&quot; class=&quot;user-hover&quot; rel=&quot;aleksey&quot;&gt;aleksey&lt;/a&gt; &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/wink.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/p&gt;</comment>
                            <comment id="17162882" author="jmeredithco" created="Wed, 22 Jul 2020 15:23:19 +0000"  >&lt;p&gt;Thanks for the quick pragmatic solution.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310000">
                    <name>Duplicate</name>
                                                                <inwardlinks description="is duplicated by">
                                        <issuelink>
            <issuekey id="13301362">CASSANDRA-15764</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13296801">CASSANDRA-15700</issuekey>
        </issuelink>
            <issuelink>
            <issuekey id="13155034">CASSANDRA-14416</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[maedhroz]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12997" cascade-level="1"><![CDATA[Performance Bug/Regression]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12977"><![CDATA[Adhoc Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 16 weeks, 6 days ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0e66w:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
        <customfieldvalue><![CDATA[jasonstack]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12348281">4.0-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/1266fec349e76b964b522d11460f1df4adadcb48&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;1266fec349e76b964b522d11460f1df4adadcb48&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;Just passing utests and dtests, assuming reviewed performance improvements are non-controversial. Shouldn&apos;t be any impact on documentation.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>