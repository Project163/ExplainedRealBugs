<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 22:38:33 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-5314] Replaying old batches can &apos;undo&apos; deletes</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-5314</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Batchlog manager does not subtract the time spent in the batchlog from hints&apos; ttls and this may cause undoing deletes. The attached patch fixes it.&lt;/p&gt;</description>
                <environment></environment>
        <key id="12635489">CASSANDRA-5314</key>
            <summary>Replaying old batches can &apos;undo&apos; deletes</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="aleksey">Aleksey Yeschenko</assignee>
                                    <reporter username="aleksey">Aleksey Yeschenko</reporter>
                        <labels>
                    </labels>
                <created>Wed, 6 Mar 2013 04:01:47 +0000</created>
                <updated>Tue, 16 Apr 2019 09:32:17 +0000</updated>
                            <resolved>Tue, 21 May 2013 21:42:36 +0000</resolved>
                                        <fixVersion>1.2.6</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>5</watches>
                                                                                                                <comments>
                            <comment id="13594341" author="iamaleksey" created="Wed, 6 Mar 2013 04:16:31 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/iamaleksey/cassandra/compare/5314&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iamaleksey/cassandra/compare/5314&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="13599372" author="jbellis" created="Mon, 11 Mar 2013 21:56:38 +0000"  >&lt;p&gt;Hmm, this is tricky: as you say, we don&apos;t want to undo more-recent deletes, but we also don&apos;t want to discard other rows in the batch, or even the row with low gcgs, that may be necessary to preserve our Atomic Batch guarantees.  I.e.: replaying the batch may be incorrect, but not replaying it may also be incorrect.&lt;/p&gt;

&lt;p&gt;I think the only solution is to require that gcgs be greater than the batch timeout we use.&lt;/p&gt;</comment>
                            <comment id="13600274" author="slebresne" created="Tue, 12 Mar 2013 18:10:21 +0000"  >&lt;p&gt;Isn&apos;t that a problem we already have with normal hints? After all, if an insert takes a long time to get delivered and you have a short gc_grace, some delete that override an hint could get gced before the hint gets delivered.&lt;/p&gt;

&lt;p&gt;In any case, I agree with Jonathan: saying that you shouldn&apos;t have a gc_grace too short if you do deletes seems fair to me, in the sense that it&apos;s what gc_grace is about: providing some time frame after which you consider everything has been delivered.&lt;/p&gt;</comment>
                            <comment id="13600298" author="jbellis" created="Tue, 12 Mar 2013 18:31:12 +0000"  >&lt;p&gt;We TTL hints with gcgs to prevent this, iirc.&lt;/p&gt;</comment>
                            <comment id="13600936" author="slebresne" created="Wed, 13 Mar 2013 08:03:20 +0000"  >&lt;blockquote&gt;&lt;p&gt;We TTL hints with gcgs to prevent this&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Interesting. There is 2 (somewhat conflicting) things that seems weird to me with that:&lt;/p&gt;
&lt;ol&gt;
	&lt;li&gt;the intent seems broken if gc_grace==0, since a TTL of 0 means no TTL at all.&lt;/li&gt;
	&lt;li&gt;in the (not uncommon) case of using TTL on all columns without doing manual deletion, it makes sense to use a very low gc_grace. In this case, this seems to make hints useless, which I&apos;m not sure is what people expect (I&apos;ll admit I was unaware of that).&lt;/li&gt;
&lt;/ol&gt;
</comment>
                            <comment id="13648490" author="jbellis" created="Fri, 3 May 2013 15:21:24 +0000"  >&lt;p&gt;I don&apos;t think there&apos;s a quick fix here; pushing to 2.0.&lt;/p&gt;</comment>
                            <comment id="13650930" author="iamaleksey" created="Tue, 7 May 2013 14:57:26 +0000"  >&lt;p&gt;So, for now:&lt;br/&gt;
1. Apply the original patch (subtract the time spent in the batchlog from hints&apos; ttls)&lt;br/&gt;
2. If the target nodes are up (of at least FD says so), try writing the mutations directly instead of hinting them&lt;br/&gt;
3. Reduce the batch replay interval to, say, 1 minute&lt;br/&gt;
4. Fix hints to not write the hint at all if it&apos;s computed TTL == 0 (when gc_grace is 0, for example).&lt;/p&gt;

&lt;p&gt;Am I missing anything?&lt;/p&gt;</comment>
                            <comment id="13650933" author="jbellis" created="Tue, 7 May 2013 15:00:26 +0000"  >&lt;p&gt;5. Update hint ttl to be sum(gcgs, cf default ttl)&lt;/p&gt;

&lt;p&gt;(Updating fix-for back to 1.2)&lt;/p&gt;</comment>
                            <comment id="13660954" author="iamaleksey" created="Fri, 17 May 2013 19:00:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://github.com/iamaleksey/cassandra/compare/5314&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/iamaleksey/cassandra/compare/5314&lt;/a&gt;  (&apos;push -f&apos;d)&lt;/p&gt;

&lt;p&gt;Haven&apos;t updated ttl here to be sum (gcgs, def ttl) since 1.2 doesn&apos;t have default ttl.&lt;/p&gt;</comment>
                            <comment id="13663220" author="jbellis" created="Tue, 21 May 2013 18:27:28 +0000"  >&lt;p&gt;Why do we add this?&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;        cf.addColumn(&lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; Column(columnName(&quot;&quot;), ByteBufferUtil.EMPTY_BYTE_BUFFER, timestamp));
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;Nit: CopyOnWriteArraySet is a bit of an odd choice, since we expect to mutate it once for each entry.&lt;/p&gt;</comment>
                            <comment id="13663245" author="iamaleksey" created="Tue, 21 May 2013 18:48:10 +0000"  >&lt;blockquote&gt;&lt;p&gt;Why do we add this?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s the CQL3 row marker. Technically we don&apos;t have to do this, but it&apos;s just the right way to do it and I would sleep better with it in place. Could prevent something like &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-5572&quot; title=&quot;Write row markers when serializing columnfamilies and columns schema&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-5572&quot;&gt;&lt;del&gt;CASSANDRA-5572&lt;/del&gt;&lt;/a&gt; from happening again in the future (although it&apos;s true that we only remove the whole rows in the batchlog so the probability of something like this is low).&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;Nit: CopyOnWriteArraySet is a bit of an odd choice, since we expect to mutate it once for each entry.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;It&apos;s mostly irrelevant here - just used the first thread-safe set that came to mind.&lt;/p&gt;</comment>
                            <comment id="13663255" author="jbellis" created="Tue, 21 May 2013 18:56:57 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="13663435" author="iamaleksey" created="Tue, 21 May 2013 21:42:36 +0000"  >&lt;p&gt;Committed, thanks.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12849921">CASSANDRA-9917</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aleksey]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>315982</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            12 years, 27 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i1iix3:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>316325</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>jbellis</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jbellis]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>