<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:16:25 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-15922] High CAS failures in NativeAllocator.Region.allocate(..) </title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-15922</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;h4&gt;&lt;a name=&quot;Problem&quot;&gt;&lt;/a&gt;Problem&lt;/h4&gt;

&lt;p&gt;The method &lt;tt&gt;NativeAllocator.Region.allocate(..)&lt;/tt&gt; uses an &lt;tt&gt;AtomicInteger&lt;/tt&gt; for the current offset in the region. Allocations depends on a &lt;tt&gt;.compareAndSet(..)&lt;/tt&gt; call.&lt;/p&gt;

&lt;p&gt;In highly contended environments the CAS failures can be high, starving writes in a running Cassandra node.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Example&quot;&gt;&lt;/a&gt;Example&lt;/h4&gt;

&lt;p&gt;It has been witnessed up to 33% of CPU time stuck in the &lt;tt&gt;NativeAllocator.Region.allocate(..)&lt;/tt&gt; loop (due to the CAS failures) during a heavy spark analytics write load.&lt;/p&gt;

&lt;p&gt;These nodes: 40 CPU cores and 256GB ram; have relevant settings&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;&lt;tt&gt;memtable_allocation_type: offheap_objects&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;memtable_offheap_space_in_mb: 5120&lt;/tt&gt;&lt;/li&gt;
	&lt;li&gt;&lt;tt&gt;concurrent_writes: 160&lt;/tt&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;Numerous  flamegraphs demonstrate the problem. See attached &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13007076/13007076_profile_pbdpc23zafsrh_20200702.svg&quot; title=&quot;profile_pbdpc23zafsrh_20200702.svg attached to CASSANDRA-15922&quot;&gt;profile_pbdpc23zafsrh_20200702.svg&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Suggestion%3AThreadLocalRegions&quot;&gt;&lt;/a&gt;Suggestion: ThreadLocal Regions&lt;/h4&gt;

&lt;p&gt;One possible solution is to have separate Regions per thread.  &lt;br/&gt;
Code wise this is relatively easy to do, for example replacing NativeAllocator:59 &lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; AtomicReference&amp;lt;Region&amp;gt; currentRegion = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; AtomicReference&amp;lt;&amp;gt;();&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;with&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;&lt;span class=&quot;code-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;code-keyword&quot;&gt;final&lt;/span&gt; ThreadLocal&amp;lt;AtomicReference&amp;lt;Region&amp;gt;&amp;gt; currentRegion = &lt;span class=&quot;code-keyword&quot;&gt;new&lt;/span&gt; ThreadLocal&amp;lt;&amp;gt;() {...};&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;p&gt;But this approach substantially changes the allocation behaviour, with more than concurrent_writes number of Regions in use at any one time. For example with &lt;tt&gt;concurrent_writes: 160&lt;/tt&gt; that&apos;s 160+ regions, each of 1MB. &lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Suggestion%3ASimpleContentionManagementAlgorithm%28ConstantBackoff%29&quot;&gt;&lt;/a&gt;Suggestion: Simple Contention Management Algorithm (Constant Backoff)&lt;/h4&gt;

&lt;p&gt;Another possible solution is to introduce a contention management algorithm that a) reduces CAS failures in high contention environments, b) doesn&apos;t impact normal environments, and c) keeps the allocation strategy of using one region at a time.&lt;/p&gt;

&lt;p&gt;The research paper &lt;a href=&quot;https://arxiv.org/abs/1305.5800&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;arXiv:1305.5800&lt;/a&gt; describes this contention CAS problem and demonstrates a number of algorithms to apply. The simplest of these algorithms is the Constant Backoff CAS Algorithm.&lt;/p&gt;

&lt;p&gt;Applying the Constant Backoff CAS Algorithm involves adding one line of code to &lt;tt&gt;NativeAllocator.Region.allocate(..)&lt;/tt&gt; to sleep for one (or some constant number) nanoseconds after a CAS failure occurs.&lt;br/&gt;
That is...&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
    &lt;span class=&quot;code-comment&quot;&gt;// we raced and lost alloc, &lt;span class=&quot;code-keyword&quot;&gt;try&lt;/span&gt; again
&lt;/span&gt;    LockSupport.parkNanos(1);
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;

&lt;h4&gt;&lt;a name=&quot;ConstantBackoffCASAlgorithmExperiments&quot;&gt;&lt;/a&gt;Constant Backoff CAS Algorithm Experiments&lt;/h4&gt;

&lt;p&gt;Using the code attached in NativeAllocatorRegionTest.java the concurrency and CAS failures of &lt;tt&gt;NativeAllocator.Region.allocate(..)&lt;/tt&gt; can be demonstrated. &lt;/p&gt;

&lt;p&gt;In the attached &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13007116/13007116_NativeAllocatorRegionTest.java&quot; title=&quot;NativeAllocatorRegionTest.java attached to CASSANDRA-15922&quot;&gt;NativeAllocatorRegionTest.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt; class, which can be run standalone, the &lt;tt&gt;Region&lt;/tt&gt; class: copied from &lt;tt&gt;NativeAllocator.Region&lt;/tt&gt;; has also the &lt;tt&gt;casFailures&lt;/tt&gt; field added. The following two screenshots are from data collected from this class on a 6 CPU (12 core) MBP, running the &lt;tt&gt;NativeAllocatorRegionTest.testRegionCAS&lt;/tt&gt; method.&lt;/p&gt;

&lt;p&gt;This attached screenshot shows the number of CAS failures during the life of a Region (over ~215 million allocations), using different threads and park times. This illustrates the improvement (reduction) of CAS failures from zero park time, through orders of magnitude, up to 10000000ns (10ms). The biggest improvement is from no algorithm to a park time of 1ns where CAS failures are ~two orders of magnitude lower. From a park time 10&#956;s and higher there is a significant drop also at low contention rates.&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13007074/13007074_Screen+Shot+2020-07-05+at+13.16.10.png&quot; width=&quot;500px&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;This attached screenshot shows the time it takes to fill a Region (~215 million allocations), using different threads and park times. The biggest improvement is from no algorithm to a park time of 1ns where performance is one order of magnitude faster. From a park time of 100&#956;s and higher there is a even further significant drop, especially at low contention rates.&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13007073/13007073_Screen+Shot+2020-07-05+at+13.26.17.png&quot; width=&quot;500px&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;p&gt;Repeating the test run show reliably similar results:  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13007071/13007071_Screen+Shot+2020-07-05+at+13.37.01.png&quot; title=&quot;Screen Shot 2020-07-05 at 13.37.01.png attached to CASSANDRA-15922&quot;&gt;Screen Shot 2020-07-05 at 13.37.01.png&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;  and  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13007072/13007072_Screen+Shot+2020-07-05+at+13.35.55.png&quot; title=&quot;Screen Shot 2020-07-05 at 13.35.55.png attached to CASSANDRA-15922&quot;&gt;Screen Shot 2020-07-05 at 13.35.55.png&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;.&lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;RegionPerThreadExperiments&quot;&gt;&lt;/a&gt;Region Per Thread Experiments&lt;/h4&gt;

&lt;p&gt;Implementing Region Per Thread: see the &lt;tt&gt;NativeAllocatorRegionTest.testRegionThreadLocal&lt;/tt&gt; method; we can expect zero CAS failures of the life of a Region. For performance we see two orders of magnitude lower times to fill up the Region (~420ms).&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13007070/13007070_Screen+Shot+2020-07-05+at+13.48.16.png&quot; width=&quot;200px&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;

&lt;h4&gt;&lt;a name=&quot;Costs&quot;&gt;&lt;/a&gt;Costs&lt;/h4&gt;

&lt;p&gt;Region per Thread is an unrealistic solution as it introduces many new issues and problems, from increased memory use to leaking memory and GC issues. It is better tackled as part of a TPC implementation.&lt;/p&gt;

&lt;p&gt;The backoff approach is simple and elegant, and seems to improve throughput in all situations. It does introduce context switches which may impact throughput in some busy throughput scenarios, so this should to be tested further.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13315028">CASSANDRA-15922</key>
            <summary>High CAS failures in NativeAllocator.Region.allocate(..) </summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="mck">Michael Semb Wever</assignee>
                                    <reporter username="mck">Michael Semb Wever</reporter>
                        <labels>
                    </labels>
                <created>Sun, 5 Jul 2020 11:50:49 +0000</created>
                <updated>Sun, 3 Jan 2021 17:02:56 +0000</updated>
                            <resolved>Tue, 7 Jul 2020 10:54:12 +0000</resolved>
                                        <fixVersion>3.0.21</fixVersion>
                    <fixVersion>3.11.7</fixVersion>
                    <fixVersion>4.0-beta1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                    <component>Local/Memtable</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>6</watches>
                                                                                                                <comments>
                            <comment id="17151560" author="michaelsembwever" created="Sun, 5 Jul 2020 12:13:15 +0000"  >&lt;p&gt;Patch for CAS Backoff Contention Management Algorithm at &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...thelastpickle:mck/trunk_15922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...thelastpickle:mck/trunk_15922&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17151832" author="snazy" created="Mon, 6 Jul 2020 07:29:38 +0000"  >&lt;p&gt;Talked to Mick a bit about this offline. The demonstrated effects (in the attached charts and SVG) are IMO &quot;good enough&quot; to justify the change.&lt;/p&gt;

&lt;p&gt;However, there&apos;s a slight issue in the attached &lt;tt&gt;NativeAllocatorRegionTest.java&lt;/tt&gt; &lt;tt&gt;Region.allocate()&lt;/tt&gt; method that adds another CAS (&lt;tt&gt;casFailures&lt;/tt&gt;) to every failed CAS against &lt;tt&gt;nextFreeOffset&lt;/tt&gt;. It&apos;s probably better to count the number of failed CAS&apos;s in a local variable and add it to &lt;tt&gt;this.casFailures&lt;/tt&gt; when the test&apos;s &lt;tt&gt;Region.allocate()&lt;/tt&gt; returns.&lt;/p&gt;

&lt;p&gt;I think, the proposed solution here to add a constant &lt;tt&gt;LockSupport.sleepNanos(1)&lt;/tt&gt; is fine and &quot;non-intrusive enough&quot;. Although the same change probably needs to be applied to &lt;tt&gt;org.apache.cassandra.utils.memory.SlabAllocator.Region#allocate&lt;/tt&gt; as well.&lt;/p&gt;</comment>
                            <comment id="17151869" author="michaelsembwever" created="Mon, 6 Jul 2020 08:24:55 +0000"  >&lt;blockquote&gt;&lt;p&gt;Although the same change probably needs to be applied to org.apache.cassandra.utils.memory.SlabAllocator.Region#allocate as well.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Added to patch.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;there&apos;s a slight issue in the attached NativeAllocatorRegionTest.java Region.allocate() method that adds another CAS (casFailures) to every failed CAS against nextFreeOffset. It&apos;s probably better to count the number of failed CAS&apos;s in a local variable and add it to this.casFailures when the test&apos;s Region.allocate() returns.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Fixed and re-running tests. Thanks &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=snazy&quot; class=&quot;user-hover&quot; rel=&quot;snazy&quot;&gt;snazy&lt;/a&gt;.&lt;br/&gt;
EDIT: new screenshots uploaded. results and conclusions stay the same.&lt;/p&gt;</comment>
                            <comment id="17151940" author="benedict" created="Mon, 6 Jul 2020 10:20:08 +0000"  >&lt;p&gt;There is perhaps a better alternative: use &lt;tt&gt;addAndGet-&amp;gt;if&lt;/tt&gt; instead of &lt;tt&gt;read-&amp;gt;if-&amp;gt;compareAndSet&lt;/tt&gt;, i.e. unconditionally update the pointer, then determine whether or not you successfully allocated in the aftermath.  This is guaranteed to succeed in one step; contention can slow that step down modestly, but there is no wasted competition.&lt;/p&gt;

&lt;p&gt;There is no downside to this approach with the &lt;tt&gt;NativeAllocator&lt;/tt&gt;, either, since if we fail to allocate we always swap the &lt;tt&gt;Region&lt;/tt&gt;, so consuming more than we need when smaller allocations may have been possible is not a problem.  So we should have made this change a long time ago, really.  &lt;/p&gt;

&lt;p&gt;It &lt;em&gt;might&lt;/em&gt; be that this approach still sees some slowdown: I assume in this case one of the problems is that we are allocating huge numbers of small objects, so that a small number of threads are competing over-and-over again to allocate the same data.  We should not be competing for each &lt;tt&gt;Cell&lt;/tt&gt; alloation, and instead try to allocate all the buffers for e.g. at least a &lt;tt&gt;Row&lt;/tt&gt; at once.  But this is more involved.  Ideally we would improve the allocator itself, which is very under-engineered, but with our threading model that&apos;s more challenging than we might like.&lt;/p&gt;

&lt;p&gt;The &lt;em&gt;upside&lt;/em&gt; to this approach is that ordinary workloads should be &lt;em&gt;improved&lt;/em&gt;, and there is no possibility of thread starvation.&lt;/p&gt;

&lt;p&gt;The current proposal by contrast introduces much longer windows for thread starvation, and &lt;em&gt;might&lt;/em&gt; negatively impact tail latencies.  This is a very difficult thing for us to rule out, so the work required to demonstrate it is performance neutral could be prohibitive.&lt;/p&gt;</comment>
                            <comment id="17151952" author="michaelsembwever" created="Mon, 6 Jul 2020 10:52:53 +0000"  >&lt;blockquote&gt;&lt;p&gt;I assume in this case one of the problems is that we are allocating huge numbers of small objects, so that a small number of threads are competing over-and-over again to allocate the same data. We should not be competing for each Cell allocation, and instead try to allocate all the buffers for e.g. at least a Row at once. &lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;This is correct. Rows with ~many hundreds of double cells.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;There is perhaps a better alternative: use addAndGet-&amp;gt;if instead of read-&amp;gt;if-&amp;gt;compareAndSet, i.e. unconditionally update the pointer, then determine whether or not you successfully allocated in the aftermath. This is guaranteed to succeed in one step; contention can slow that step down modestly, but there is no wasted competition.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Sounds good. Will put it together and test.&lt;/p&gt;</comment>
                            <comment id="17151969" author="snazy" created="Mon, 6 Jul 2020 11:58:40 +0000"  >&lt;p&gt;+1 on &lt;tt&gt;addAndGet&lt;/tt&gt; (or &lt;tt&gt;getAndAdd&lt;/tt&gt;, whichever works best).&lt;/p&gt;

&lt;p&gt;And I agree, the allocation-model that we currently have is not great, but as you said, it&apos;s a ton of work to get it right (less (ideally no) fragmentation, no unnecessary tiny allocations, no unnecessary copying, etc etc).&lt;/p&gt;</comment>
                            <comment id="17151970" author="michaelsembwever" created="Mon, 6 Jul 2020 12:00:56 +0000"  >&lt;h4&gt;&lt;a name=&quot;%7B%7BaddAndGet%7D%7DExperiments&quot;&gt;&lt;/a&gt;&lt;tt&gt;addAndGet&lt;/tt&gt; Experiments&lt;/h4&gt;

&lt;p&gt;Code patch at &lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...thelastpickle:mck/trunk_15922_1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...thelastpickle:mck/trunk_15922_1&lt;/a&gt;&lt;br/&gt;
This patch depends on the &lt;tt&gt;addAndGet(..)&lt;/tt&gt; call guaranteeing a (serial) result that returns the value from no overlapping/latter add calls. AFAIK that is how AtomicInteger works.&lt;/p&gt;

&lt;p&gt;I&apos;m also curious if we still need the &lt;tt&gt;allocCount&lt;/tt&gt; AtomicInteger field, it appears to be there only for debug. May I remove it in this patch?&lt;/p&gt;

&lt;p&gt;Benchmark code attached in  &lt;span class=&quot;nobr&quot;&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/attachment/13007126/13007126_NativeAllocatorRegion2Test.java&quot; title=&quot;NativeAllocatorRegion2Test.java attached to CASSANDRA-15922&quot;&gt;NativeAllocatorRegion2Test.java&lt;sup&gt;&lt;img class=&quot;rendericon&quot; src=&quot;https://issues.apache.org/jira/images/icons/link_attachment_7.gif&quot; height=&quot;7&quot; width=&quot;7&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&lt;/sup&gt;&lt;/a&gt;&lt;/span&gt;.&lt;/p&gt;

&lt;p&gt;The following attached screenshot shows the time it takes to fill a Region (~215 million allocations), using different threads, comparing the original code (compareAndSet), the addAndGet, and the constant backoff (parkNano) approaches. &lt;/p&gt;

&lt;p&gt;The biggest improvement is still the constant backoff algorithm where performance is one order of magnitude faster. &lt;/p&gt;

&lt;p&gt;But the addAndGet approach is 2x to 5x faster than the original, and as mentioned above it also comes with the benefit of no-loop (no starvation) and faster performance in all workloads.&lt;/p&gt;

&lt;p&gt; &lt;span class=&quot;image-wrap&quot; style=&quot;&quot;&gt;&lt;img src=&quot;https://issues.apache.org/jira/secure/attachment/13007124/13007124_Screen+Shot+2020-07-06+at+13.26.10.png&quot; width=&quot;600px&quot; style=&quot;border: 0px solid black&quot; /&gt;&lt;/span&gt; &lt;/p&gt;</comment>
                            <comment id="17151993" author="michaelsembwever" created="Mon, 6 Jul 2020 12:38:02 +0000"  >&lt;p&gt;Patch updated to&lt;/p&gt;
&lt;ul class=&quot;alternate&quot; type=&quot;square&quot;&gt;
	&lt;li&gt;use &lt;tt&gt;getAndAdd(..)&lt;/tt&gt; instead of &lt;tt&gt;addAndGet(..)&lt;/tt&gt; for readability&lt;/li&gt;
	&lt;li&gt;remove the &lt;tt&gt;allocCount&lt;/tt&gt; AtomicInteger field&lt;/li&gt;
	&lt;li&gt;don&apos;t print negative waste values in the &lt;tt&gt;toString(..)&lt;/tt&gt; method (when region is full and nextFreeOffset is passed capacity)&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/compare/trunk...thelastpickle:mck/trunk_15922_1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/compare/trunk...thelastpickle:mck/trunk_15922_1&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;CI run at &lt;a href=&quot;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/197/pipeline&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://ci-cassandra.apache.org/blue/organizations/jenkins/Cassandra-devbranch/detail/Cassandra-devbranch/197/pipeline&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17152006" author="snazy" created="Mon, 6 Jul 2020 13:05:22 +0000"  >&lt;p&gt;+1 (assuming CI looks good and 3.11+3.0 back-ports are clean)&lt;/p&gt;</comment>
                            <comment id="17152010" author="benedict" created="Mon, 6 Jul 2020 13:13:16 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="17152654" author="michaelsembwever" created="Tue, 7 Jul 2020 10:54:12 +0000"  >&lt;p&gt;Committed as &lt;a href=&quot;https://github.com/apache/cassandra/commit/5a6d52b26191ab1f5df6e9cf941e0f964dd95a28&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;5a6d52b26191ab1f5df6e9cf941e0f964dd95a28 &lt;/a&gt;.&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="12499791">CASSANDRA-2252</issuekey>
        </issuelink>
                            </outwardlinks>
                                                                <inwardlinks description="is related to">
                                        <issuelink>
            <issuekey id="13324234">CASSANDRA-16072</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                    </issuelinks>
                <attachments>
                            <attachment id="13007126" name="NativeAllocatorRegion2Test.java" size="4509" author="mck" created="Mon, 6 Jul 2020 11:34:44 +0000"/>
                            <attachment id="13007116" name="NativeAllocatorRegionTest.java" size="5556" author="mck" created="Mon, 6 Jul 2020 09:40:05 +0000"/>
                            <attachment id="13007074" name="Screen Shot 2020-07-05 at 13.16.10.png" size="190080" author="mck" created="Sun, 5 Jul 2020 11:16:14 +0000"/>
                            <attachment id="13007073" name="Screen Shot 2020-07-05 at 13.26.17.png" size="181005" author="mck" created="Sun, 5 Jul 2020 11:26:23 +0000"/>
                            <attachment id="13007072" name="Screen Shot 2020-07-05 at 13.35.55.png" size="176951" author="mck" created="Sun, 5 Jul 2020 11:36:00 +0000"/>
                            <attachment id="13007071" name="Screen Shot 2020-07-05 at 13.37.01.png" size="190008" author="mck" created="Sun, 5 Jul 2020 11:37:06 +0000"/>
                            <attachment id="13007070" name="Screen Shot 2020-07-05 at 13.48.16.png" size="174465" author="mck" created="Sun, 5 Jul 2020 11:48:20 +0000"/>
                            <attachment id="13007118" name="Screen Shot 2020-07-06 at 11.35.35.png" size="177622" author="mck" created="Mon, 6 Jul 2020 09:40:25 +0000"/>
                            <attachment id="13007117" name="Screen Shot 2020-07-06 at 11.36.44.png" size="164727" author="mck" created="Mon, 6 Jul 2020 09:40:25 +0000"/>
                            <attachment id="13007124" name="Screen Shot 2020-07-06 at 13.26.10.png" size="158148" author="mck" created="Mon, 6 Jul 2020 11:26:16 +0000"/>
                            <attachment id="13007076" name="profile_pbdpc23zafsrh_20200702.svg" size="404627" author="mck" created="Sun, 5 Jul 2020 10:38:15 +0000"/>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>11.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[mck]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12984" cascade-level=""><![CDATA[Degradation]]></customfieldvalue>
                                <customfieldvalue key="12996" cascade-level="1"><![CDATA[Slow Use Case]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12969"><![CDATA[User Report]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            5 years, 19 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z0ggko:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
        <customfieldvalue><![CDATA[snazy]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12316349">1.0.0</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/5a6d52b26191ab1f5df6e9cf941e0f964dd95a28&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/5a6d52b26191ab1f5df6e9cf941e0f964dd95a28&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;existing CI. &lt;br/&gt;
benchmarking in ticket.&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>