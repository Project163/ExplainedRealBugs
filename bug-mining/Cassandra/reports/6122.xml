<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:25:52 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-17461] Test Failure: org.apache.cassandra.distributed.test.CASTest.testConflictingWritesWithStaleRingInformation</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-17461</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;Intermittent failures on &lt;tt&gt;org.apache.cassandra.distributed.test.CASTest&lt;/tt&gt;&#160;for trunk:&lt;/p&gt;

&lt;p&gt;*&#160;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/1024/testReport/org.apache.cassandra.distributed.test/CASTest/testConflictingWritesWithStaleRingInformation_3/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testConflictingWritesWithStaleRingInformation&lt;/a&gt;&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/1025/testReport/org.apache.cassandra.distributed.test/CASTest/testSuccessfulWriteBeforeRangeMovement/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testSuccessfulWriteBeforeRangeMovement&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/1020/testReport/org.apache.cassandra.distributed.test/CASTest/testSuccessfulWriteDuringRangeMovementFollowedByConflicting/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testSuccessfulWriteDuringRangeMovementFollowedByConflicting&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://ci-cassandra.apache.org/job/Cassandra-trunk/1020/testReport/org.apache.cassandra.distributed.test/CASTest/testSucccessfulWriteDuringRangeMovementFollowedByRead/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testSucccessfulWriteDuringRangeMovementFollowedByRead&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;


&lt;p&gt;All four seem to have the same aspect:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
Failed 2 times in the last 5 runs. Flakiness: 50%, Stability: 60%
Error Message
CAS operation timed out: received 1 of 2 required responses after 0 contention retries
Stacktrace
org.apache.cassandra.exceptions.CasWriteTimeoutException: CAS operation timed out: received 1 of 2 required responses after 0 contention retries
	at org.apache.cassandra.service.paxos.Paxos$MaybeFailure.markAndThrowAsTimeoutOrFailure(Paxos.java:547)
	at org.apache.cassandra.service.paxos.Paxos.begin(Paxos.java:1048)
	at org.apache.cassandra.service.paxos.Paxos.cas(Paxos.java:659)
	at org.apache.cassandra.service.paxos.Paxos.cas(Paxos.java:618)
	at org.apache.cassandra.service.StorageProxy.cas(StorageProxy.java:307)
	at org.apache.cassandra.cql3.statements.ModificationStatement.executeWithCondition(ModificationStatement.java:500)
	at org.apache.cassandra.cql3.statements.ModificationStatement.execute(ModificationStatement.java:467)
	at org.apache.cassandra.distributed.impl.Coordinator.unsafeExecuteInternal(Coordinator.java:122)
	at org.apache.cassandra.distributed.impl.Coordinator.unsafeExecuteInternal(Coordinator.java:103)
	at org.apache.cassandra.distributed.impl.Coordinator.lambda$executeWithResult$0(Coordinator.java:66)
	at org.apache.cassandra.concurrent.FutureTask.call(FutureTask.java:47)
	at org.apache.cassandra.concurrent.FutureTask.run(FutureTask.java:57)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.base/java.lang.&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.run(&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;.java:829)
Standard Output
DEBUG [main] 2022-03-19 16:20:42,868 Reflections.java:198 - going to scan these urls: [jar:file:/home/cassandra/cassandra/build/apache-cassandra-4.1-SNAPSHOT.jar!/, jar:file:/home/cassandra/cassandra/build/test/lib/jars/simulator-bootstrap.jar!/, jar:file:/home/cassandra/cassandra/build/test/lib/jars/dtest-api-0.0.12.jar!/, file:/home/cassandra/cassandra/build/classes/fqltool/, file:/home/cassandra/cassandra/build/test/classes/, file:/home/cassandra/cassandra/build/classes/main/, file:/home/cass
...[truncated 4929659 chars]...
gService.java:519 - Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; messaging service to quiesce

INFO  [node1_isolatedExecutor:10] 2022-03-19 16:21:55,223 SubstituteLogger.java:169 - INFO  [node1_isolatedExecutor:10] node1 2022-03-19 16:21:55,221 MessagingService.java:519 - Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; messaging service to quiesce

INFO  [node2_isolatedExecutor:8] 2022-03-19 16:21:55,223 SubstituteLogger.java:169 - INFO  [node2_isolatedExecutor:8] node2 2022-03-19 16:21:55,222 MessagingService.java:519 - Waiting &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; messaging service to quiesce
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Failures can also be repeatedly hit with CircleCI test multiplexer:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1394/workflows/8d40d44b-7ccb-40fe-82d5-37db0bb228a3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://app.circleci.com/pipelines/github/adelapena/cassandra/1394/workflows/8d40d44b-7ccb-40fe-82d5-37db0bb228a3&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;The same test looks ok in 4.0, as suggested by Butler and &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1395/workflows/5669dd1e-1a4c-4801-b1a1-c3ca04a29e2b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this repeated Circle run&lt;/a&gt;.&lt;/p&gt;</description>
                <environment></environment>
        <key id="13434894">CASSANDRA-17461</key>
            <summary>Test Failure: org.apache.cassandra.distributed.test.CASTest.testConflictingWritesWithStaleRingInformation</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="bdeggleston">Blake Eggleston</assignee>
                                    <reporter username="adelapena">Andres de la Pe&#241;a</reporter>
                        <labels>
                    </labels>
                <created>Mon, 21 Mar 2022 12:27:53 +0000</created>
                <updated>Fri, 10 Oct 2025 08:47:57 +0000</updated>
                            <resolved>Mon, 26 Sep 2022 15:28:31 +0000</resolved>
                                        <fixVersion>4.1-beta1</fixVersion>
                    <fixVersion>4.1</fixVersion>
                                    <component>Test/dtest/java</component>
                        <due></due>
                            <votes>0</votes>
                                    <watches>7</watches>
                                                                                                                <comments>
                            <comment id="17531664" author="bereng" created="Wed, 4 May 2022 11:02:41 +0000"  >&lt;p&gt;Gave it a go hoping increased timeouts would help but only do for some cases, not for the whole class. Need to look further in...&lt;/p&gt;</comment>
                            <comment id="17551578" author="edimitrova" created="Wed, 8 Jun 2022 12:00:06 +0000"  >&lt;p&gt;This one reproduces easily in CircleCI.&#160;&lt;/p&gt;

&lt;p&gt;My bisecting shows it is failing after CEP-14 was committed.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/1709/workflows/0da6056e-bb8d-4865-b24b-601bd28eadb3&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;200 runs no failures&lt;/a&gt; before CEP-14, &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/1707/workflows/d6950287-f00e-428b-976e-1f19dfac0345/jobs/11936&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;200 runs and 5 failures&lt;/a&gt; after. It was changed in CEP-14.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt;&#160;, &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=bdeggleston&quot; class=&quot;user-hover&quot; rel=&quot;bdeggleston&quot;&gt;bdeggleston&lt;/a&gt;&#160;,&#160;can anyone of you take a look, please?&#160;&lt;/p&gt;</comment>
                            <comment id="17551590" author="benedict" created="Wed, 8 Jun 2022 12:23:52 +0000"  >&lt;p&gt;I don&apos;t think the test was materially changed, just refactored to share the cluster and to use the new Verbs. AFAICT it is behaviourally identical. But Paxos was changed, and this perhaps affected timings. I think perhaps we impose request timeouts more accurately now, and this could impact flakiness.&lt;/p&gt;

&lt;p&gt;The relevant timeout to change would not be the test timeout though, but the contention and request timeouts, as these affect how quickly these request timeouts would fire which might be relevant in flaky VM environments.&lt;/p&gt;

&lt;p&gt;Not sure when I&apos;ll get a chance to look more closely myself.&lt;/p&gt;</comment>
                            <comment id="17566920" author="adelapena" created="Thu, 14 Jul 2022 17:10:40 +0000"  >&lt;p&gt;Wasn&apos;t that test ignored before CEP-14? I think it has been marked as &lt;tt&gt;@Ignored&lt;/tt&gt; since its introduction on &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12126&quot; title=&quot;CAS Reads Inconsistencies &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12126&quot;&gt;&lt;del&gt;CASSANDRA-12126&lt;/del&gt;&lt;/a&gt;, which would explain why the pre-CEP-14 run passes so quickly. CEP-14 modified the test and removed the&#160;&lt;tt&gt;@Ignored&lt;/tt&gt; annotation for the very first time, and it has been flaky since then.&lt;/p&gt;</comment>
                            <comment id="17566921" author="brandon.williams" created="Thu, 14 Jul 2022 17:19:59 +0000"  >&lt;p&gt;Indeed, if the ignore is removed in 4.0, it also fails the same way as can be seen &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/547/workflows/3c58bb72-0fa2-4015-9919-6cba2b1b9957/jobs/6518&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt;.  Should we unblock beta from this ticket and move it to rc instead?&lt;/p&gt;</comment>
                            <comment id="17572075" author="jmckenzie" created="Wed, 27 Jul 2022 18:09:01 +0000"  >&lt;p&gt;Noticing that a lot of our 4.1 failures in butler appear to be linked to this ticket. If we were &lt;tt&gt;@Ignored&lt;/tt&gt; since the test was initially introduced, shouldn&apos;t we be skeptical of its correctness, add back the annotation, create a follow up ticket to either fix or remove the test for 4.2, and close this out?&lt;/p&gt;</comment>
                            <comment id="17572120" author="maedhroz" created="Wed, 27 Jul 2022 20:28:23 +0000"  >&lt;blockquote&gt;&lt;p&gt;The relevant timeout to change would not be the test timeout though, but the contention and request timeouts, as these affect how quickly these request timeouts would fire which might be relevant in flaky VM environments.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Would it be worth making a quick pass at these timeouts before ignoring again?&lt;/p&gt;</comment>
                            <comment id="17572128" author="brandon.williams" created="Wed, 27 Jul 2022 20:49:19 +0000"  >&lt;p&gt;Those are actually the timeouts that were changed in Bereng&apos;s PR above.&lt;/p&gt;</comment>
                            <comment id="17572699" author="jmckenzie" created="Fri, 29 Jul 2022 00:10:04 +0000"  >&lt;p&gt;Tried checking out the SHA for &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-12126&quot; title=&quot;CAS Reads Inconsistencies &quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-12126&quot;&gt;&lt;del&gt;CASSANDRA-12126&lt;/del&gt;&lt;/a&gt; to see if the test passed this morning and it wouldn&apos;t build; didn&apos;t feel like investing more cycles than to confirm the test in question was definitely &lt;tt&gt;@Ignored&lt;/tt&gt; on introduction. &lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=slebresne&quot; class=&quot;user-hover&quot; rel=&quot;slebresne&quot;&gt;slebresne&lt;/a&gt; (who&apos;s OOO for a few weeks but leaving here for posterity) - any chance you recall that test and why it was flagged as ignored on addition?&lt;/p&gt;

&lt;p&gt;I&apos;m going to beat the drum again here - I say we add the &lt;tt&gt;@Ignored&lt;/tt&gt; annotation back and create another ticket to get to the bottom of this that&apos;s 4.2 since this isn&apos;t a regression and we can keep making progress towards 4.1. Anyone against? Happy to do the grunt work myself early next week to tidy this up.&lt;/p&gt;</comment>
                            <comment id="17572796" author="benedict" created="Fri, 29 Jul 2022 07:39:49 +0000"  >&lt;p&gt;Sorry for missing this discussion. These tests when added were known to fail because they demonstrated real bugs with Paxos v1, so we marked them &amp;#64;Ignore to avoid polluting everyone&apos;s test results. Paxos v2 fixes these bugs, so these tests are now valuable.&lt;/p&gt;</comment>
                            <comment id="17572914" author="brandon.williams" created="Fri, 29 Jul 2022 10:34:16 +0000"  >&lt;p&gt;So then, would you like to make them pass?&lt;/p&gt;</comment>
                            <comment id="17572915" author="benedict" created="Fri, 29 Jul 2022 10:38:58 +0000"  >&lt;p&gt;If you&apos;re willing to wait for me to get round to it, sure.&lt;/p&gt;

&lt;p&gt;Otherwise try bumping the message timeouts, rather than test timeouts? Presumably the environment has gotten flakier.&lt;/p&gt;</comment>
                            <comment id="17572916" author="brandon.williams" created="Fri, 29 Jul 2022 10:45:41 +0000"  >&lt;p&gt;Are &lt;a href=&quot;https://github.com/apache/cassandra/pull/1603/commits/2be278db2fe51ddf6ef534f9b44835046a898c00&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;these&lt;/a&gt; the correct ones to adjust?&lt;/p&gt;</comment>
                            <comment id="17572923" author="benedict" created="Fri, 29 Jul 2022 11:15:11 +0000"  >&lt;p&gt;Probably. Unfortunately the links to outcomes for each test appear to be broken, but looking at the &lt;a href=&quot;https://circleci.com/api/v1.1/project/github/adelapena/cassandra/14107/output/103/5?file=true&amp;amp;allocation-id=6238ab6a00c61f3c0b452b00-5-build%2F3ED5FD94&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;log file&lt;/a&gt;, I cannot tell what log output is for what test case.&lt;/p&gt;</comment>
                            <comment id="17572956" author="adelapena" created="Fri, 29 Jul 2022 12:43:17 +0000"  >&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1968/workflows/1917904b-8a49-4bf6-9b39-282ac1af7424/jobs/19590&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Here&lt;/a&gt; is a new repeated CI run only for the new &lt;tt&gt;CASTest.testConflictingWritesWithStaleRingInformation&lt;/tt&gt;. It shows a 5% flakiness. The CircleCI config file has been generated with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.circleci/generate.sh -m \
  -e REPEATED_UTEST_TARGET=test-jvm-dtest-some \
  -e REPEATED_UTEST_COUNT=200 \
  -e REPEATED_UTEST_CLASS=org.apache.cassandra.distributed.test.CASTest \
  -e REPEATED_UTEST_METHODS=testConflictingWritesWithStaleRingInformation
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;The standard output, logs, and Junit report for each iteration can be found on &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1968/workflows/1917904b-8a49-4bf6-9b39-282ac1af7424/jobs/19590/artifacts&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the artifacts tab&lt;/a&gt;. The failed runs contain &quot;fails&quot; on the path, while the successful runs contain &quot;passes&quot;. For example, these are the files for the 2nd iteration of the 6th runner:&lt;/p&gt;
&lt;ul&gt;
	&lt;li&gt;&lt;a href=&quot;https://output.circle-artifacts.com/output/job/2fd9786b-db08-4079-909b-8090f30ef78a/artifacts/6/stdout/fails/2/test-jvm-dtest-some-org.apache.cassandra.distributed.test.CASTest.txt&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;stdout/fails/2/test-jvm-dtest-some-org.apache.cassandra.distributed.test.CASTest.txt&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://output.circle-artifacts.com/output/job/2fd9786b-db08-4079-909b-8090f30ef78a/artifacts/6/junitxml/fails/2/TEST-org.apache.cassandra.distributed.test.CASTest-testConflictingWritesWithStaleRingInformation.xml&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;junitxml/fails/2/TEST-org.apache.cassandra.distributed.test.CASTest-testConflictingWritesWithStaleRingInformation.xml&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://output.circle-artifacts.com/output/job/2fd9786b-db08-4079-909b-8090f30ef78a/artifacts/6/logs/fails/2/org.apache.cassandra.distributed.test.CASTest/%3Cmain%3E/%3Cmain%3E/system.log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;logs/fails/2/org.apache.cassandra.distributed.test.CASTest/&amp;lt;main&amp;gt;/&amp;lt;main&amp;gt;/system.log&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://output.circle-artifacts.com/output/job/2fd9786b-db08-4079-909b-8090f30ef78a/artifacts/6/logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-e838e8c8-e117-4520-9396-ab1b145f2a2b/node1/system.log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-e838e8c8-e117-4520-9396-ab1b145f2a2b/node1/system.log&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://output.circle-artifacts.com/output/job/2fd9786b-db08-4079-909b-8090f30ef78a/artifacts/6/logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-e838e8c8-e117-4520-9396-ab1b145f2a2b/node2/system.log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-e838e8c8-e117-4520-9396-ab1b145f2a2b/node2/system.log&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://output.circle-artifacts.com/output/job/2fd9786b-db08-4079-909b-8090f30ef78a/artifacts/6/logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-e838e8c8-e117-4520-9396-ab1b145f2a2b/node3/system.log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-e838e8c8-e117-4520-9396-ab1b145f2a2b/node3/system.log&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://output.circle-artifacts.com/output/job/2fd9786b-db08-4079-909b-8090f30ef78a/artifacts/6/logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-fa769a52-7814-4842-8760-7c158e8282e0/node1/system.log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-fa769a52-7814-4842-8760-7c158e8282e0/node1/system.log&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://output.circle-artifacts.com/output/job/2fd9786b-db08-4079-909b-8090f30ef78a/artifacts/6/logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-fa769a52-7814-4842-8760-7c158e8282e0/node2/system.log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-fa769a52-7814-4842-8760-7c158e8282e0/node2/system.log&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://output.circle-artifacts.com/output/job/2fd9786b-db08-4079-909b-8090f30ef78a/artifacts/6/logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-fa769a52-7814-4842-8760-7c158e8282e0/node3/system.log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-fa769a52-7814-4842-8760-7c158e8282e0/node3/system.log&lt;/a&gt;&lt;/li&gt;
	&lt;li&gt;&lt;a href=&quot;https://output.circle-artifacts.com/output/job/2fd9786b-db08-4079-909b-8090f30ef78a/artifacts/6/logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-fa769a52-7814-4842-8760-7c158e8282e0/node4/system.log&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;logs/fails/2/org.apache.cassandra.distributed.test.CASTest/cluster-fa769a52-7814-4842-8760-7c158e8282e0/node4/system.log&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</comment>
                            <comment id="17572959" author="benedict" created="Fri, 29 Jul 2022 12:49:15 +0000"  >&lt;p&gt;So the first one of these failures is nothing to do with this test:&lt;/p&gt;

&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit-timeout] ------------- ---------------- ---------------
[junit-timeout] Testcase: org.apache.cassandra.distributed.test.CASTest:	Caused an ERROR
[junit-timeout] Uncaught exceptions were thrown during test
[junit-timeout] org.apache.cassandra.distributed.shared.ShutdownException: Uncaught exceptions were thrown during test
[junit-timeout] 	at org.apache.cassandra.distributed.impl.AbstractCluster.checkAndResetUncaughtExceptions(AbstractCluster.java:1058)
[junit-timeout] 	at org.apache.cassandra.distributed.impl.AbstractCluster.close(AbstractCluster.java:1044)
[junit-timeout] 	at org.apache.cassandra.distributed.test.CASTest.afterClass(CASTest.java:93)
[junit-timeout] 	Suppressed: java.lang.RuntimeException: java.lang.IllegalStateException: HintsService is shut down and can&apos;t accept new hints
[junit-timeout] 		at org.apache.cassandra.service.StorageProxy$HintRunnable.run(StorageProxy.java:2585)
[junit-timeout] 		at org.apache.cassandra.concurrent.FutureTask$1.call(FutureTask.java:81)
[junit-timeout] 		at org.apache.cassandra.concurrent.FutureTask.call(FutureTask.java:47)
[junit-timeout] 		at org.apache.cassandra.concurrent.FutureTask.run(FutureTask.java:57)
[junit-timeout] 		at org.apache.cassandra.concurrent.SEPWorker.run(SEPWorker.java:120)
[junit-timeout] 		at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
[junit-timeout] 		at java.lang.Thread.run(Thread.java:748)
[junit-timeout] 	Caused by: java.lang.IllegalStateException: HintsService is shut down and can&apos;t accept new hints
[junit-timeout] 		at org.apache.cassandra.hints.HintsService.write(HintsService.java:165)
[junit-timeout] 		at org.apache.cassandra.service.StorageProxy$7.runMayThrow(StorageProxy.java:2664)
[junit-timeout] 		at org.apache.cassandra.service.StorageProxy$HintRunnable.run(StorageProxy.java:2581)
[junit-timeout] 
[junit-timeout] 
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17572968" author="benedict" created="Fri, 29 Jul 2022 12:57:09 +0000"  >&lt;p&gt;&lt;del&gt;Hmm, is there an issue with gossip? Have the defaults for gossip been changed in in-jvm dtests? There shouldn&apos;t be gossip running, but there seem to be background changes in gossip state for the nodes (that span messages being sent).&lt;/del&gt;&lt;/p&gt;
&lt;div class=&quot;preformatted panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;preformattedContent panelContent&quot;&gt;
&lt;pre&gt;[junit-timeout] INFO  [MutationStage-1] &amp;lt;main&amp;gt; 2022-07-29 12:19:44,849 CASTestBase.java:124 - Dropping PAXOS2_PREPARE_REQ from 1 to 3
[junit-timeout] INFO  [node1_GossipStage:1] node1 2022-07-29 12:19:44,896 Gossiper.java:1409 - Node /127.0.0.4:7012 is now part of the cluster
[junit-timeout] DEBUG [node1_GossipStage:1] node1 2022-07-29 12:19:44,897 StorageService.java:2887 - Node /127.0.0.4:7012 state NORMAL, token [9223372036854775801]
[junit-timeout] DEBUG [node1_GossipStage:1] node1 2022-07-29 12:19:44,901 StorageService.java:2797 - New node /127.0.0.4:7012 at token 9223372036854775801
[junit-timeout] DEBUG [node1_GossipStage:1] node1 2022-07-29 12:19:44,914 Gossiper.java:1353 - removing expire time for endpoint : /127.0.0.4:7012
[junit-timeout] INFO  [node1_GossipStage:1] node1 2022-07-29 12:19:44,914 Gossiper.java:1354 - InetAddress /127.0.0.4:7012 is now UP
[junit-timeout] INFO  [MutationStage-1] &amp;lt;main&amp;gt; 2022-07-29 12:19:44,915 CASTestBase.java:124 - Dropping PAXOS2_PREPARE_REQ from 1 to 3
[junit-timeout] INFO  [ReadStage-1] &amp;lt;main&amp;gt; 2022-07-29 12:19:45,536 CASTestBase.java:124 - Dropping READ_REQ from 1 to 3 &lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Of course, this is &lt;em&gt;probably&lt;/em&gt; the application of the new ring state obtained via PaxosPrepare.&lt;/p&gt;</comment>
                            <comment id="17572980" author="adelapena" created="Fri, 29 Jul 2022 13:25:19 +0000"  >&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1969/workflows/4b9858d8-900c-4aa3-818b-2d430234f9e9/jobs/19592&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Here&lt;/a&gt; is a new repeated run for &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/commit/d2923275e360a1ee9db498e748c269f701bb3a8b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the commit&lt;/a&gt; when the test was introduced, or not ignored anymore, by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17164&quot; title=&quot;CEP-14: Paxos Improvements&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17164&quot;&gt;&lt;del&gt;CASSANDRA-17164&lt;/del&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I&apos;m repeating this run because &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1969/workflows/4b9858d8-900c-4aa3-818b-2d430234f9e9/jobs/19592/artifacts&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;the artifacts&lt;/a&gt; (logs, etc.) are retained for one month, so we have missed the artifacts of &lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra/1707/workflows/d6950287-f00e-428b-976e-1f19dfac0345/jobs/11936/tests&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;Ekaterina&apos;s run on 8th Jun&lt;/a&gt;. This run hits &lt;tt&gt;CasWriteTimeoutException&lt;/tt&gt; four times, and there are no issues with shutdown.&lt;/p&gt;</comment>
                            <comment id="17573785" author="benedict" created="Mon, 1 Aug 2022 14:15:00 +0000"  >&lt;p&gt;Would it be possible to run this with &lt;tt&gt;TRACE&lt;/tt&gt; logging enabled for &lt;tt&gt;org.apache.cassandra.service.paxos&lt;/tt&gt;?&lt;/p&gt;</comment>
                            <comment id="17576897" author="jmckenzie" created="Mon, 8 Aug 2022 16:47:30 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=leesangboo&quot; class=&quot;user-hover&quot; rel=&quot;leesangboo&quot;&gt;leesangboo&lt;/a&gt; I see that you transitioned this ticket to In Progress - are you working on this? Can set you as assignee if so.&lt;/p&gt;</comment>
                            <comment id="17578175" author="edimitrova" created="Wed, 10 Aug 2022 22:55:47 +0000"  >&lt;blockquote&gt;&lt;p&gt;Would it be possible to run this with &lt;tt&gt;TRACE&lt;/tt&gt; logging enabled for &lt;tt&gt;org.apache.cassandra.service.paxos&lt;/tt&gt;?&#160;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Everything is possible as long as there is someone with a bit of time &lt;img class=&quot;emoticon&quot; src=&quot;https://issues.apache.org/jira/images/icons/emoticons/biggrin.png&quot; height=&quot;16&quot; width=&quot;16&quot; align=&quot;absmiddle&quot; alt=&quot;&quot; border=&quot;0&quot;/&gt;&#160;&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/ekaterinadimitrova2/cassandra?branch=17461-repro&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;This&lt;/a&gt;&#160;is a run with TRACE logging enabled for org.apache.cassandra.service.paxos. I ran it for the commit when the test was introduced, or not ignored anymore, by &lt;a href=&quot;https://issues.apache.org/jira/browse/CASSANDRA-17164&quot; title=&quot;CEP-14: Paxos Improvements&quot; class=&quot;issue-link&quot; data-issue-key=&quot;CASSANDRA-17164&quot;&gt;&lt;del&gt;CASSANDRA-17164&lt;/del&gt;&lt;/a&gt;. All logs are under the artifacts tab.&#160;&lt;/p&gt;</comment>
                            <comment id="17578494" author="benedict" created="Thu, 11 Aug 2022 14:06:57 +0000"  >&lt;p&gt;Thanks Ekaterina, that makes clear what the problem is. The issue is that when node1 receives an update to its ring information about node4, it first contacts node4 to confirm it is alive before marking it so, and this is racing with the submission of the second round of Paxos Prepares so that the outgoing message to node4 is being dropped before it hits the wire.&lt;/p&gt;

&lt;p&gt;I have introduced some additional logic to ensure that node4 is marked alive before the second round of prepares is submitted&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/belliottsmith/cassandra/tree/17461-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/belliottsmith/cassandra/tree/17461-4.1&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17578899" author="adelapena" created="Fri, 12 Aug 2022 10:12:27 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=benedict&quot; class=&quot;user-hover&quot; rel=&quot;benedict&quot;&gt;benedict&lt;/a&gt; do you have a CI run for the patch? I have just started some repeated runs for &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1989/workflows/a6c7d6fa-08d0-41be-8ec0-049ab71c9dd7&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt; and &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1989/workflows/994d3066-f24c-460e-b251-8491d24a9890&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt; with the aforementioned CircleCI config file:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.circleci/generate.sh -m \
  -e REPEATED_UTEST_TARGET=test-jvm-dtest-some \
  -e REPEATED_UTEST_COUNT=500 \
  -e REPEATED_UTEST_CLASS=org.apache.cassandra.distributed.test.CASTest \
  -e REPEATED_UTEST_METHODS=testConflictingWritesWithStaleRingInformation
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</comment>
                            <comment id="17578924" author="adelapena" created="Fri, 12 Aug 2022 11:14:23 +0000"  >&lt;p&gt;It seems that the patched test is still failing with both the &lt;tt&gt;CasWriteTimeoutException&lt;/tt&gt; and the &lt;tt&gt;ShutdownException&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="17579074" author="benedict" created="Fri, 12 Aug 2022 18:04:37 +0000"  >&lt;p&gt;The &lt;tt&gt;ShutdownException&lt;/tt&gt; is a problem with node shutdown, so I don&apos;t think it is relevant to this ticket. I have not attempted to address these issues (I actually see at least two distinct shutdown problems)&lt;/p&gt;

&lt;p&gt;These seem to account for most of the failures now, so perhaps there is some progress?&lt;/p&gt;

&lt;p&gt;Unfortunately I have no idea how to run your repeated tests in CircleCI, and cannot reproduce locally, so have been guided so far entirely by log output. Perhaps you can explain to me how to use your tool, so I can run again with TRACE output to see what might be happening in this timeout case, if it is indeed different?&lt;/p&gt;</comment>
                            <comment id="17579160" author="edimitrova" created="Fri, 12 Aug 2022 22:13:39 +0000"  >&lt;blockquote&gt;&lt;p&gt;Unfortunately I have no idea how to run your repeated tests in CircleCI, and cannot reproduce locally, so have been guided so far entirely by log output. Perhaps you can explain to me how to use your tool, so I can run again with TRACE output to see what might be happening in this timeout case, if it is indeed different?&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;In order to run the test in a loop, the job we pushed, you need to cherry-pick &lt;a href=&quot;https://github.com/adelapena/cassandra/commit/b026210655e8759e5f47d8eb072c0ae954ee3f52&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this commit&lt;/a&gt; which was created by running this command:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.circleci/generate.sh -m \
-e REPEATED_UTEST_TARGET=test-jvm-dtest-some \
-e REPEATED_UTEST_COUNT=500 \
-e REPEATED_UTEST_CLASS=org.apache.cassandra.distributed.test.CASTest \
-e REPEATED_UTEST_METHODS=testConflictingWritesWithStaleRingInformation&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;Then when you push your branch and generate the workflows in CircleCI (as every other patch), you go to either&lt;br/&gt;
&#160;&lt;br/&gt;
&lt;em&gt;java_11_separate_tests&lt;/em&gt; or &lt;em&gt;java8_separate_tests&lt;/em&gt;&#160;workflow - depends on which JDK you want to use at this point, and press first either &lt;em&gt;start_j8_build&lt;/em&gt; or respectively &lt;em&gt;start_j11_build&lt;/em&gt;&lt;br/&gt;
Then you press and approve the following job - &lt;em&gt;start_j11_repeated_utest&lt;/em&gt; or again respectively &lt;em&gt;start_j8_repeated_utest&lt;/em&gt;&lt;br/&gt;
&#160;&lt;br/&gt;
This will run the test 500 times&lt;br/&gt;
&#160;&lt;br/&gt;
Also, I would like to mention there is a &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/trunk/.circleci/readme.md&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;readme&lt;/a&gt; in the CircleCI in-tree folder, also more info and examples how to run tests from the different suites in a loop &#160;can be found in &lt;a href=&quot;https://github.com/adelapena/cassandra/blob/trunk/.circleci/config-2_1.yml#L47-L99&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;config-2_1.yml&lt;/a&gt;&lt;br/&gt;
&#160;&lt;br/&gt;
These jobs are really useful and saved us a lot of time with flaky tests. I would strongly recommend anyone to spend 15 minutes to read through things as I am sure those are really super useful. Please let me know if you have any questions or concerns. I will be happy to help&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17579165" author="brandon.williams" created="Fri, 12 Aug 2022 22:26:58 +0000"  >&lt;p&gt;For TRACE, you&apos;ll need to add something like &lt;a href=&quot;https://github.com/ekaterinadimitrova2/cassandra/commit/2a09ac31d2219d427a23e5baa6e6708c954eb875&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;this commit&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17579776" author="adelapena" created="Mon, 15 Aug 2022 15:38:35 +0000"  >&lt;p&gt;I have been able to reproduce the CAS timeout locally too, by just running the test in a shell loop:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
&lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; i in {1..500}
&lt;span class=&quot;code-keyword&quot;&gt;do&lt;/span&gt;
  ant test-jvm-dtest-some -Dtest.name=&lt;span class=&quot;code-quote&quot;&gt;&quot;org.apache.cassandra.distributed.test.CASTest&quot;&lt;/span&gt; -Dtest.methods=&lt;span class=&quot;code-quote&quot;&gt;&quot;testConflictingWritesWithStaleRingInformation&quot;&lt;/span&gt; 
done
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;It can take a while to hit a failure, though. The CircleCI job does basically the same but using multiple parallel runners.&lt;br/&gt;
&#160;&lt;/p&gt;</comment>
                            <comment id="17580094" author="bereng" created="Tue, 16 Aug 2022 07:16:41 +0000"  >&lt;p&gt;^I wasn&apos;t able to repro locally with the &lt;tt&gt;RepeatableRunner&lt;/tt&gt; #justfyi&lt;/p&gt;</comment>
                            <comment id="17580921" author="benedict" created="Wed, 17 Aug 2022 18:04:20 +0000"  >&lt;p&gt;Ok, I was on the right track but I had intercepted the problem at the wrong point. I have pushed a new commit to the same branch, and the latest test run is only failing due to the hints service shutdown problem.&lt;/p&gt;

&lt;p&gt;(Which isn&apos;t really a problem, and might be something we can just choose to ignore, though probably shutdown should avoid a sequence of events that permits a hint to be submitted to a shutdown hint service, I think that&apos;s out of the scope of this ticket)&lt;/p&gt;</comment>
                            <comment id="17581310" author="adelapena" created="Thu, 18 Aug 2022 12:02:05 +0000"  >&lt;p&gt;Indeed that seems to fix the CAS timeouts&#160;in &lt;tt&gt;testConflictingWritesWithStaleRingInformation&lt;/tt&gt;, leaving only the shutdown errors (CI for &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1998/workflows/16da8bc2-ef5a-4ceb-b4fa-6fba61f30bed&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt; and &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1998/workflows/c515b1e9-484f-4d4e-b2fa-a13721c16718&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;).&lt;/p&gt;

&lt;p&gt;If we repeatedly run the entire &lt;tt&gt;CASTest&lt;/tt&gt;&#160;class, other tests still hit CAS timeouts (CI for &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1999/workflows/491c56ef-a6f9-44a5-803f-2ad475279147&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j8&lt;/a&gt; and &lt;a href=&quot;https://app.circleci.com/pipelines/github/adelapena/cassandra/1999/workflows/577321bb-26f9-42ec-ba3a-6dca1f111968&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;j11&lt;/a&gt;).&#160;However, in this case the shutdown errors don&apos;t seem to reproduce anymore.&lt;/p&gt;

&lt;p&gt;The CircleCI config file for running the entire test class has been generated with:&lt;/p&gt;
&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;
.circleci/generate.sh -m \
  -e REPEATED_UTEST_TARGET=test-jvm-dtest-some \
  -e REPEATED_UTEST_COUNT=500 \
  -e REPEATED_UTEST_CLASS=org.apache.cassandra.distributed.test.CASTest
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;&#160;&lt;/p&gt;</comment>
                            <comment id="17581398" author="brandon.williams" created="Thu, 18 Aug 2022 15:25:36 +0000"  >&lt;p&gt;I took a shot a simplifying the logic in waiting for node4 to be marked up &lt;a href=&quot;https://github.com/driftx/cassandra/commit/038e1c0e8e4fab1ef2d3c03c0c8907da08c42f1b&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;here&lt;/a&gt; which also is left with the &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/590/workflows/041b21e3-530c-4a8b-9194-b55bdf37f83e/jobs/6922&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;shutdown errors&lt;/a&gt;.&lt;/p&gt;</comment>
                            <comment id="17581402" author="benedict" created="Thu, 18 Aug 2022 15:40:55 +0000"  >&lt;p&gt;Unfortunately that&apos;s no longer testing anything...&lt;/p&gt;

&lt;p&gt;We sort of need the ownership discrepancy to be discovered by the Paxos operation, not to be applied before it starts.&lt;/p&gt;</comment>
                            <comment id="17581409" author="brandon.williams" created="Thu, 18 Aug 2022 15:52:32 +0000"  >&lt;p&gt;I think the problem is the paxos operation doesn&apos;t cause discovery, if we just wait for node4 without adding it ourselves, it will never come up.  Marking it up yourself during the paxos operation won&apos;t actually happen in practice, I don&apos;t think.&lt;/p&gt;

&lt;p&gt;I&apos;m not sure what the correct solution is but I think there&apos;s a better way to accomplish it than a custom FD and inspecting the stack.&lt;/p&gt;</comment>
                            <comment id="17581410" author="benedict" created="Thu, 18 Aug 2022 15:54:12 +0000"  >&lt;p&gt;It &lt;em&gt;does&lt;/em&gt; cause discovery, but we have a weird behaviour (that is almost certainly wrong in most cases) where we mark a node as &lt;em&gt;down&lt;/em&gt; after any major state change and then ping it via echo before marking it as alive. We are racing with that latter part.&lt;/p&gt;

&lt;p&gt;You can clearly see in the TRACE logs that the Paxos operation detects the divergent ring, propagates this to &lt;tt&gt;Gossiper&lt;/tt&gt;, and correctly waits for pending ranges to be recomputed and gossip state applied. Unfortunately, we don&apos;t have an easy way to make it also wait for &lt;tt&gt;realMarkAlive&lt;/tt&gt;. We could modify the actual behaviour of major state changes, but while I think that might be more correct, I don&apos;t want to touch it just for this test and don&apos;t have the time for the proper duty of care needed for such changes.&lt;/p&gt;</comment>
                            <comment id="17581902" author="brandon.williams" created="Fri, 19 Aug 2022 15:01:45 +0000"  >&lt;blockquote&gt;&lt;p&gt;We sort of need the ownership discrepancy to be discovered by the Paxos operation&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Can you help me understand why this is the case?  At this point in time, in node1&apos;s view, node4 has been decommissioned/assassinated and is in the LEFT state, but node4&apos;s actual state is unchanged from NORMAL so any gossip exchange between node1 and node4 will cause the state change back to the correct state of NORMAL.  This doesn&apos;t have to be from a Paxos operation though (and in the real world, may not get so lucky in timing to be from one) and it looks like the other &apos;stale ring&apos; tests are explicitly adding node4 back, only this one does not.&lt;/p&gt;</comment>
                            <comment id="17581928" author="benedict" created="Fri, 19 Aug 2022 15:45:18 +0000"  >&lt;blockquote&gt;&lt;p&gt;in node1&apos;s view, node4 has been decommissioned/assassinated and is in the LEFT state&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;No, node1&apos;s view has node4 as never having joined the ring, as we invoke &lt;tt&gt;unsafeAnnulEndpoint&lt;/tt&gt; after updating the token information via the LEFT state. This is just a convenient way to simulate node4 joining without node1 receiving the gossip state.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;any gossip exchange between node1 and node4 will cause the state change back to the correct state of NORMAL ... and in the real world, may not get so lucky in timing to be from one&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;You have it backwards. Ordinary operations &lt;em&gt;depend&lt;/em&gt; on gossip disseminating this promptly for correctness. We are simulating this having not happened yet, leading to an inconsistent view of the token ring and permitting operations to reach consensus without overlapping quorums, due to token ownership disagreements. Paxos operations (which must be linearizable) are now able to detect this inconsistency themselves and enforce it, by updating the gossip state directly.&lt;/p&gt;

&lt;p&gt;Note that the &lt;tt&gt;Timeout&lt;/tt&gt; is also a &lt;em&gt;valid outcome&lt;/em&gt; for this test, just a bad one for validating everything else is working correctly. The reason the &lt;tt&gt;Timeout&lt;/tt&gt; occurs is that we explicitly drop messages to one of the &lt;em&gt;correct&lt;/em&gt; owners to ensure we can only succeed by contacting the &lt;em&gt;new&lt;/em&gt; owner, and if this race occurs we drop this message too, leaving only one correct owner that can respond.&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;it looks like the other &apos;stale ring&apos; tests are explicitly adding node4 back, only this one does not.&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Yes, they are testing other things.&lt;/p&gt;
</comment>
                            <comment id="17582186" author="benedict" created="Sat, 20 Aug 2022 10:30:56 +0000"  >&lt;blockquote&gt;&lt;p&gt;other tests still hit CAS timeouts&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;Some of these at least are probably similar situations to this test. I will try to take a look at these, but probably not until the end of the coming week or so.&lt;/p&gt;</comment>
                            <comment id="17584895" author="brandon.williams" created="Thu, 25 Aug 2022 15:18:43 +0000"  >&lt;p&gt;In the remaining timeout failures I noticed that these appeared to also be racing with node4 being marked up, so I created a &lt;a href=&quot;https://github.com/driftx/cassandra/tree/CASSANDRA-17461-4.1&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt; that waits for it after it has been added back to the ring, but now the same tests &lt;a href=&quot;https://app.circleci.com/pipelines/github/driftx/cassandra/605/workflows/006a6d26-0a2d-4c5b-9ed2-ac04c99227b0/jobs/6990&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;fail&lt;/a&gt; in a different way that I haven&apos;t figured out yet, but there&apos;s TRACE logging included on that test run.&lt;/p&gt;</comment>
                            <comment id="17584906" author="benedict" created="Thu, 25 Aug 2022 15:39:30 +0000"  >&lt;p&gt;Thanks. I ran a CASTest loop and found the following tests to fail sometimes:&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/316/workflows/4f40397c-5caf-4eeb-8e7d-608b30796f77/jobs/7110&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testSucccessfulWriteDuringRangeMovementFollowedByRead&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/317/workflows/27c83972-4006-46be-9c78-91adae6b93c8/jobs/7111&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testSuccessfulWriteDuringRangeMovementFollowedByConflicting&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/318/workflows/de219103-e7a2-4767-b28b-b774167afbae/jobs/7109&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testSuccessfulWriteBeforeRangeMovement&lt;/a&gt;&lt;br/&gt;
&lt;a href=&quot;https://app.circleci.com/pipelines/github/belliottsmith/cassandra/319/workflows/9ee97d36-d2f8-4d90-a64f-0f873344239a/jobs/7108&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;testIncompleteWriteFollowedBySuccessfulWriteWithStaleRingDuringRangeMovementFollowedByRead&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;I have run them in a loop with TRACE logging, though they mostly &lt;em&gt;didn&apos;t&lt;/em&gt; fail when being run on their own, even with 500 iterations. Only &lt;tt&gt;testSuccessfulWriteBeforeRangeMovement&lt;/tt&gt; reliably fails, and testSuccessfulWriteDuringRangeMovementFollowedByConflicting failed once. The other two did not fail at all, ignoring the CASTest-level shutdown failures. &lt;/p&gt;

&lt;p&gt;I will find the time at some point to dig further into all of these outputs.&lt;/p&gt;</comment>
                            <comment id="17606732" author="bdeggleston" created="Mon, 19 Sep 2022 19:34:38 +0000"  >&lt;p&gt;Since the race isn&apos;t really a bug, just something that can happen in this situation, I&apos;ve reworked the affected tests to tolerate the race. Instead of requiring the query to succeed, it will retry a few times on timeouts, but also assert the expected ring state before and after the query. The ring change tests no longer fail in circle, even after 600 runs.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/bdeggleston/cassandra/tree/C17461&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/bdeggleston/cassandra/tree/C17461&lt;/a&gt;&lt;/p&gt;</comment>
                            <comment id="17606753" author="benedict" created="Mon, 19 Sep 2022 20:22:32 +0000"  >&lt;p&gt;I feel like this weakens the tests, but I think it &lt;em&gt;should&lt;/em&gt; still catch a regression &lt;em&gt;in principle&lt;/em&gt;. Have we confirmed these new versions fail with v1, as they should?&lt;/p&gt;</comment>
                            <comment id="17606771" author="bdeggleston" created="Mon, 19 Sep 2022 21:17:54 +0000"  >&lt;blockquote&gt;&lt;p&gt;I feel like this weakens the tests&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;How so? We&apos;re interested in whether the paxos operation updates the ring, and doesn&apos;t complete operations with stale topology, which this still tests. The tests all fail with v1, as expected. &lt;/p&gt;</comment>
                            <comment id="17607050" author="benedict" created="Tue, 20 Sep 2022 09:40:42 +0000"  >&lt;p&gt;Well, since it should fix it for the first operation it leaves some room for some consistent breakage to occur that reliably breaks the first operation (rather than infrequently).&lt;/p&gt;

&lt;p&gt;BUT, quite evidently we don&apos;t have the time to agonise over these tests and the alternative is probably annotating them to be ignored, and it&apos;s only a slight weakening. So +1, let&apos;s ship 4.1&lt;/p&gt;</comment>
                            <comment id="17609514" author="brandon.williams" created="Mon, 26 Sep 2022 14:06:13 +0000"  >&lt;p&gt;This is the only ticket blocking the release of 4.1, is there anything left to be done here?&lt;/p&gt;</comment>
                    </comments>
                <issuelinks>
                            <issuelinktype id="12310560">
                    <name>Problem/Incident</name>
                                                                <inwardlinks description="is caused by">
                                        <issuelink>
            <issuekey id="13412583">CASSANDRA-17164</issuekey>
        </issuelink>
                            </inwardlinks>
                                    </issuelinktype>
                            <issuelinktype id="10030">
                    <name>Reference</name>
                                            <outwardlinks description="relates to">
                                        <issuelink>
            <issuekey id="13434901">CASSANDRA-17462</issuekey>
        </issuelink>
                            </outwardlinks>
                                                        </issuelinktype>
                    </issuelinks>
                <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                    <customfield id="customfield_12313825" key="com.atlassian.jira.plugin.system.customfieldtypes:cascadingselect">
                        <customfieldname>Bug Category</customfieldname>
                        <customfieldvalues>
                                                    <customfieldvalue key="12982" cascade-level=""><![CDATA[Correctness]]></customfieldvalue>
                                <customfieldvalue key="12990" cascade-level="1"><![CDATA[Test Failure]]></customfieldvalue>
            
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313821" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Complexity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12965"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313822" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Discovered By</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12970"><![CDATA[Unit Test]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12313922" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Impacts</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13100"><![CDATA[None]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            3 years, 7 weeks, 1 day ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_12313921" key="jira.plugin.projectspecificselectfield.jpssf:multicftype">
                        <customfieldname>Platform</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="13076"><![CDATA[All]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|z10o60:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[benedict]]></customfieldvalue>
        <customfieldvalue><![CDATA[bdeggleston]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12311420" key="com.atlassian.jira.plugin.system.customfieldtypes:version">
                        <customfieldname>Since Version</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue id="12351787">4.1-alpha1</customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313924" key="com.atlassian.jira.plugin.system.customfieldtypes:textfield">
                        <customfieldname>Source Control Link</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;&lt;a href=&quot;https://github.com/apache/cassandra/commit/286d2ee053ac2e6fe50749fa2833533254697662&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;https://github.com/apache/cassandra/commit/286d2ee053ac2e6fe50749fa2833533254697662&lt;/a&gt;&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                        <customfield id="customfield_12313823" key="com.atlassian.jira.plugin.system.customfieldtypes:textarea">
                        <customfieldname>Test and Documentation Plan</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>&lt;p&gt;circle&lt;/p&gt;</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                </customfields>
    </item>
</channel>
</rss>