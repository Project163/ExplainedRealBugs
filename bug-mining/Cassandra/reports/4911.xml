<!-- 
RSS generated by JIRA (8.20.10#820010-sha1:ace47f9899e9ee25d7157d59aa17ab06aee30d3d) at Tue Nov 11 23:09:51 UTC 2025

It is possible to restrict the fields that are returned in this document by specifying the 'field' parameter in your request.
For example, to request only the issue key and summary append 'field=key&field=summary' to the URL of your request.
-->
<rss version="0.92" >
<channel>
    <title>ASF JIRA</title>
    <link>https://issues.apache.org/jira</link>
    <description>This file is an XML representation of an issue</description>
    <language>en-uk</language>    <build-info>
        <version>8.20.10</version>
        <build-number>820010</build-number>
        <build-date>22-06-2022</build-date>
    </build-info>


<item>
            <title>[CASSANDRA-13906] Properly close StreamCompressionInputStream to release any ByteBuf</title>
                <link>https://issues.apache.org/jira/browse/CASSANDRA-13906</link>
                <project id="12310865" key="CASSANDRA">Apache Cassandra</project>
                    <description>&lt;p&gt;When running dtests for trunk (4.x) that perform some streaming, sometimes a &lt;tt&gt;ByteBuf&lt;/tt&gt; is not released properly, and we get this error in the logs (causing the dtest to fail):&lt;/p&gt;

&lt;div class=&quot;code panel&quot; style=&quot;border-width: 1px;&quot;&gt;&lt;div class=&quot;codeContent panelContent&quot;&gt;
&lt;pre class=&quot;code-java&quot;&gt;ERROR [MessagingService-NettyOutbound-&lt;span class=&quot;code-object&quot;&gt;Thread&lt;/span&gt;-4-2] 2017-09-26 13:42:37,940 Slf4JLogger.java:176 - LEAK: ByteBuf.release() was not called before it&lt;span class=&quot;code-quote&quot;&gt;&apos;s garbage-collected. Enable advanced leak reporting to find out where the leak occurred. To enable advanced leak reporting, specify the JVM option &apos;&lt;/span&gt;-Dio.netty.leakDetection.level=advanced&apos; or call ResourceLeakDetector.setLevel() See http:&lt;span class=&quot;code-comment&quot;&gt;//netty.io/wiki/reference-counted-objects.html &lt;span class=&quot;code-keyword&quot;&gt;for&lt;/span&gt; more information.&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;&lt;/div&gt;</description>
                <environment></environment>
        <key id="13105265">CASSANDRA-13906</key>
            <summary>Properly close StreamCompressionInputStream to release any ByteBuf</summary>
                <type id="1" iconUrl="https://issues.apache.org/jira/secure/viewavatar?size=xsmall&amp;avatarId=21133&amp;avatarType=issuetype">Bug</type>
                                            <priority id="10002" iconUrl="https://issues.apache.org/jira/images/icons/priorities/minor.svg">Normal</priority>
                        <status id="5" iconUrl="https://issues.apache.org/jira/images/icons/statuses/resolved.png" description="A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.">Resolved</status>
                    <statusCategory id="3" key="done" colorName="green"/>
                                    <resolution id="1">Fixed</resolution>
                                        <assignee username="jasobrown">Jason Brown</assignee>
                                    <reporter username="jasobrown">Jason Brown</reporter>
                        <labels>
                    </labels>
                <created>Tue, 26 Sep 2017 23:38:14 +0000</created>
                <updated>Fri, 15 May 2020 08:00:39 +0000</updated>
                            <resolved>Tue, 3 Oct 2017 19:24:15 +0000</resolved>
                                        <fixVersion>4.0-alpha1</fixVersion>
                    <fixVersion>4.0</fixVersion>
                                        <due></due>
                            <votes>0</votes>
                                    <watches>3</watches>
                                                                                                                <comments>
                            <comment id="16181752" author="jasobrown" created="Tue, 26 Sep 2017 23:38:58 +0000"  >&lt;p&gt;The cause of the leaked &lt;tt&gt;ByteBuf&lt;/tt&gt; was due to a wrapping class not being closed, and thus never had the chance to call &lt;tt&gt;release()&lt;/tt&gt; on the &lt;tt&gt;ByteBuf&lt;/tt&gt;.&lt;/p&gt;

&lt;div class=&apos;table-wrap&apos;&gt;
&lt;table class=&apos;confluenceTable&apos;&gt;&lt;tbody&gt;
&lt;tr&gt;
&lt;th class=&apos;confluenceTh&apos;&gt;trunk&lt;/th&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://github.com/jasobrown/cassandra/tree/netty-leak&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;branch&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://builds.apache.org/view/A-D/view/Cassandra/job/Cassandra-devbranch-dtest/338/&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;dtest&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td class=&apos;confluenceTd&apos;&gt;&lt;a href=&quot;https://circleci.com/gh/jasobrown/cassandra/tree/netty-leak&quot; class=&quot;external-link&quot; target=&quot;_blank&quot; rel=&quot;nofollow noopener&quot;&gt;utests&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;
&lt;/div&gt;


&lt;p&gt;I ran one of the failing dtests (repair_tests/incremental_repair_test.py:TestIncRepair.multiple_repair_test) on my laptop, and without the patch could reproduce within 2-3 runs. With the patch, I ran it fifty time and could not reproduce.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; Would you mind reviewing?&lt;/p&gt;</comment>
                            <comment id="16186051" author="aweisberg" created="Fri, 29 Sep 2017 16:34:18 +0000"  >&lt;p&gt;So to bikeshed this all to hell. Wouldn&apos;t the most idiomatic way to do this be to have TrackedDataInputPlus implement Closable and use try with resources?&lt;/p&gt;

&lt;p&gt;In fact try with resources will let you declare all the Closeable things in the same try block and clean up if one of the things you are using to wrap throws in it&apos;s constructor preventing the wrapped resource from leaking.&lt;/p&gt;</comment>
                            <comment id="16186066" author="jasobrown" created="Fri, 29 Sep 2017 16:49:49 +0000"  >&lt;blockquote&gt;&lt;p&gt;Wouldn&apos;t the most idiomatic way to do this be to have &lt;tt&gt;TrackedDataInputPlus&lt;/tt&gt; implement &lt;tt&gt;Closable&lt;/tt&gt; and use try with resources&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;I thought about that when I was fixing this, but  &lt;tt&gt;TrackedDataInputPlus&lt;/tt&gt; wraps a &lt;tt&gt;DataInput&lt;/tt&gt;, which does not declare a &lt;tt&gt;#close()&lt;/tt&gt; method. In a &lt;tt&gt;TrackedDataInputPlus#close()&lt;/tt&gt; I could check if the wrapped instance implements &lt;tt&gt;Closeable&lt;/tt&gt; and invoke it if it does. wdyt?&lt;/p&gt;

&lt;p&gt;There are a couple of other uses of  &lt;tt&gt;TrackedDataInputPlus&lt;/tt&gt; (&lt;tt&gt;HintMessage&lt;/tt&gt;, &lt;tt&gt;IndexedEntry&lt;/tt&gt; called on load saved cache path), but they should not be affected by &lt;tt&gt;TrackedDataInputPlus&lt;/tt&gt; implementing &lt;tt&gt;Closeable&lt;/tt&gt; as the are not allocated via try-with-resources. &lt;/p&gt;

&lt;p&gt;Note: if we choose to make this change, which is reasonable, I can also cleanup &lt;tt&gt;CompressedStreamReader&lt;/tt&gt; to also allocate &lt;tt&gt;TrackedDataInputPlus&lt;/tt&gt; in a try-with-resources - it has the same concerns as &lt;tt&gt;StreamReader&lt;/tt&gt; that you raised. Branch coming shortly ...&lt;/p&gt;</comment>
                            <comment id="16186087" author="aweisberg" created="Fri, 29 Sep 2017 17:02:21 +0000"  >&lt;p&gt;If you implement Closable it&apos;s going to cause warnings any place that doesn&apos;t use try with resources. Given the other usages I think what you have done is probably fine although you can still switch to try with resources just for &lt;tt&gt;StreamCompressionInputStream&lt;/tt&gt;.&lt;/p&gt;</comment>
                            <comment id="16186149" author="jasobrown" created="Fri, 29 Sep 2017 18:01:59 +0000"  >&lt;p&gt;OK, I pushed up a fresh branch using try-with-resources for both &lt;tt&gt;StreamReader&lt;/tt&gt; and &lt;tt&gt;CompressedStreamReader&lt;/tt&gt;. utests and dtests have been been kicked off, as well.&lt;/p&gt;</comment>
                            <comment id="16186310" author="aweisberg" created="Fri, 29 Sep 2017 19:55:59 +0000"  >&lt;p&gt;Is releasing references to a buffer using the &lt;tt&gt;refCnt()&lt;/tt&gt; a good idea? Isn&apos;t that kind of abusing the idiom of reference counting by not counting?&lt;/p&gt;

&lt;p&gt;Otherwise looks good.&lt;/p&gt;
</comment>
                            <comment id="16186600" author="jasobrown" created="Fri, 29 Sep 2017 22:24:01 +0000"  >&lt;blockquote&gt;&lt;p&gt;Isn&apos;t that kind of abusing the idiom of reference counting by not counting?&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;That is true to a degree, but I&apos;m never sure if any code would, in some broken way, become executed twice and fail on the refCnt decrement and mask some other problem. I could set the buffer to null after a simple call to &lt;tt&gt;release()&lt;/tt&gt;. wdyt?&lt;/p&gt;</comment>
                            <comment id="16188968" author="aweisberg" created="Mon, 2 Oct 2017 22:27:43 +0000"  >&lt;p&gt;I agree reference counting in Java is fraught due to the lack of Destructors and other plumbing.&lt;/p&gt;

&lt;p&gt;So do we always expect the refcnt to be one or some known number? Then we should assert that at runtime and take an error path if it&apos;s not true (after releasing the resources) or maybe just do rate limited logging.&lt;/p&gt;

&lt;p&gt;If use after free is a concern we might want to make sure the buffer is set to null so we get an NPE instead of a segfault. Then the  code incorrectly using the buffer will signal an error as well.&lt;/p&gt;</comment>
                            <comment id="16190107" author="aweisberg" created="Tue, 3 Oct 2017 18:29:30 +0000"  >&lt;p&gt;+1&lt;/p&gt;</comment>
                            <comment id="16190153" author="jasobrown" created="Tue, 3 Oct 2017 18:58:50 +0000"  >&lt;p&gt;&lt;a href=&quot;https://issues.apache.org/jira/secure/ViewProfile.jspa?name=aweisberg&quot; class=&quot;user-hover&quot; rel=&quot;aweisberg&quot;&gt;aweisberg&lt;/a&gt; and I discussed offline, and I&apos;ll revert the overly cautious (and perhaps incorrect) change around that refCnt.&lt;/p&gt;</comment>
                            <comment id="16190184" author="jasobrown" created="Tue, 3 Oct 2017 19:24:00 +0000"  >&lt;p&gt;committed as sha &lt;tt&gt;982ab93a2f8a0f5c56af9378f65d3e9e430000b9&lt;/tt&gt;&lt;/p&gt;</comment>
                    </comments>
                    <attachments>
                    </attachments>
                <subtasks>
                    </subtasks>
                <customfields>
                                                                            <customfield id="customfield_12310310" key="com.atlassian.jira.toolkit:attachments">
                        <customfieldname>Attachment count</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0.0</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12313920" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Authors</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[jasobrown]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12314020" key="com.atlassian.jira.plugins.jira-development-integration-plugin:devsummary">
                        <customfieldname>Development</customfieldname>
                        <customfieldvalues>
                            
                        </customfieldvalues>
                    </customfield>
                                                                                                                        <customfield id="customfield_12313422" key="com.atlassian.jirafisheyeplugin:jobcheckbox">
                        <customfieldname>Enable Automatic Patch Review</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue><![CDATA[false]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <customfield id="customfield_12310420" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Global Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                    <customfield id="customfield_12312521" key="com.atlassian.jira.toolkit:LastCommentDate">
                        <customfieldname>Last public comment date</customfieldname>
                        <customfieldvalues>
                            8 years, 7 weeks ago
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                            <customfield id="customfield_12311820" key="com.pyxis.greenhopper.jira:gh-lexo-rank">
                        <customfieldname>Rank</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>0|i3kkyv:</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                <customfield id="customfield_12310920" key="com.pyxis.greenhopper.jira:gh-global-rank">
                        <customfieldname>Rank (Obsolete)</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>9223372036854775807</customfieldvalue>
                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                        <customfield id="customfield_10022" key="com.atlassian.jira.plugin.system.customfieldtypes:userpicker">
                        <customfieldname>Reviewer</customfieldname>
                        <customfieldvalues>
                            <customfieldvalue>aweisberg</customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313420" key="com.atlassian.jira.plugin.system.customfieldtypes:multiuserpicker">
                        <customfieldname>Reviewers</customfieldname>
                        <customfieldvalues>
                                    <customfieldvalue><![CDATA[aweisberg]]></customfieldvalue>
    
                        </customfieldvalues>
                    </customfield>
                                                                                            <customfield id="customfield_12313820" key="com.atlassian.jira.plugin.system.customfieldtypes:select">
                        <customfieldname>Severity</customfieldname>
                        <customfieldvalues>
                                <customfieldvalue key="12962"><![CDATA[Normal]]></customfieldvalue>

                        </customfieldvalues>
                    </customfield>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </customfields>
    </item>
</channel>
</rss>